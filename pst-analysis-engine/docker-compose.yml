services:
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    ports: ["9002:9000","9003:9001"]
    volumes: ["./data/minio:/data"]

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: vericase
      POSTGRES_PASSWORD: vericase
      POSTGRES_DB: vericase
    ports: ["55432:5432"]
    volumes: ["./data/postgres:/var/lib/postgresql/data"]

  redis:
    image: redis:7
    ports: ["6379:6379"]

  opensearch:
    image: opensearchproject/opensearch:2.10.0
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65536, hard: 65536 }
    ports: ["9200:9200","9600:9600"]
    volumes: ["./data/opensearch:/usr/share/opensearch/data"]

  tika:
    image: apache/tika:latest
    ports: ["9998:9998"]

  api:
    build: ./api
    env_file: .env
    depends_on: [minio, postgres, redis, opensearch, tika]
    ports: ["8010:8000"]
    volumes: ["./api/app:/code/app","./ui:/code/ui"]

  worker:
    build: ./worker
    env_file: .env
    depends_on: [minio, postgres, redis, opensearch, tika]
    volumes:
      - "./worker/worker_app:/code/worker_app"
      - "./api/app:/code/app"

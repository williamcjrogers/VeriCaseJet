<!doctype html>
<!--suppress HtmlFormInputWithoutLabel -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeriCase - Admin Settings</title>
    <!-- Local Library -->
    <link
      rel="stylesheet"
      href="./assets/fontawesome/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/global.css" />
    <link rel="stylesheet" href="brand-styles.css" />
    <style>
      body {
        background: var(--bg-primary);
        background-image: radial-gradient(
          circle,
          rgba(23, 181, 163, 0.05) 1px,
          transparent 1px
        );
        background-size: 30px 30px;
      }

      .header {
        background: white;
        border-bottom: 2px solid var(--gray-200);
        padding: 1rem 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo {
        height: 32px;
      }

      .container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .page-title {
        color: var(--vericase-navy);
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .page-subtitle {
        color: var(--text-secondary);
        margin-bottom: 2rem;
      }

      .settings-card {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-100);
        overflow: hidden;
      }

      .setting-item {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--gray-100);
      }

      .setting-item:last-child {
        border-bottom: none;
      }

      .setting-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
      }

      .setting-label {
        font-weight: 600;
        color: var(--vericase-navy);
        font-size: 1.1rem;
      }

      .setting-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-top: 0.25rem;
        margin-bottom: 1rem;
      }

      .setting-control {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .setting-input {
        flex: 1;
        padding: 0.75rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-md);
        font-size: 1rem;
        max-width: 200px;
      }

      .setting-input:focus {
        outline: none;
        border-color: var(--vericase-teal);
      }

      .btn-save {
        background: var(--vericase-teal);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-save:hover {
        background: var(--vericase-teal-dark);
        transform: translateY(-1px);
      }

      .btn-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .success-message {
        background: var(--success-light);
        color: var(--success);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        margin-top: 0.5rem;
        display: none;
      }

      .success-message.show {
        display: block;
      }

      .back-link {
        color: var(--vericase-teal);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .status-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
      }

      .status-card .status-text {
        margin-left: auto;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .status-card.configured i {
        color: var(--success);
      }

      .status-card.error i {
        color: var(--error);
      }

      .btn-test:hover {
        background: var(--gray-300) !important;
      }

      .setting-input[type="password"] {
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo-section">
          <img src="/assets/Logo-Vector.png" alt="VeriCase" class="logo" />
          <span style="font-weight: 600; color: var(--vericase-navy)"
            >Admin Settings</span
          >
        </div>
      </div>
    </div>

    <!-- Breadcrumbs for navigation clarity -->
    <nav class="breadcrumbs">
        <div class="container inner" aria-label="Breadcrumb">
            <a href="dashboard.html">Home</a>
            <span class="sep">/</span>
            <span class="current">Admin Settings</span>
        </div>
    </nav>

    <div class="container">
      <a href="dashboard.html" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>

      <h1 class="page-title">Application Settings</h1>
      <p class="page-subtitle">
        Configure system-wide settings for document processing
      </p>

      <div class="settings-card">
        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">Textract Page Threshold</div>
              <div class="setting-description">
                PDFs with more pages than this threshold will use Tika instead
                of AWS Textract. This helps optimize cost and performance for
                large documents (e.g., 1000+ page PDFs). Default: 100 pages
              </div>
            </div>
          </div>
          <div class="setting-control">
            <input
              type="number"
              id="textract-page-threshold"
              class="setting-input"
              min="1"
              max="500"
              value="100"
            />
            <span>pages</span>
            <button
              class="btn-save"
              onclick="
                saveSetting(
                  'textract_page_threshold',
                  'textract-page-threshold',
                )
              "
            >
              Save
            </button>
          </div>
          <div class="success-message" id="success-textract-page-threshold">
            Setting saved successfully!
          </div>
        </div>

        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">Textract Max Pages</div>
              <div class="setting-description">
                Maximum number of pages Textract can process (AWS limit: 500
                pages). Documents exceeding this will automatically use Tika.
              </div>
            </div>
          </div>
          <div class="setting-control">
            <input
              type="number"
              id="textract-max-pages"
              class="setting-input"
              min="1"
              max="500"
              value="500"
            />
            <span>pages</span>
            <button
              class="btn-save"
              onclick="saveSetting('textract_max_pages', 'textract-max-pages')"
            >
              Save
            </button>
          </div>
          <div class="success-message" id="success-textract-max-pages">
            Setting saved successfully!
          </div>
        </div>
      </div>

      <!-- AI Configuration Section -->
      <h2
        style="
          color: var(--vericase-navy);
          margin: 2rem 0 1rem;
          font-size: 1.5rem;
        "
      >
        <i class="fas fa-robot" style="color: var(--vericase-teal)"></i> AI
        Model Configuration
      </h2>
      <p class="page-subtitle">
        Configure AI providers and models for evidence analysis
      </p>

      <div class="settings-card">
        <!-- OpenAI / GPT Configuration -->
        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">
                <i class="fas fa-brain" style="color: #10a37f"></i> OpenAI (GPT)
              </div>
              <div class="setting-description">
                Used for chronology analysis and deep research. Get your API key
                from
                <a href="https://platform.openai.com/api-keys" target="_blank"
                  >platform.openai.com</a
                >
              </div>
            </div>
          </div>
          <div
            class="setting-control"
            style="flex-direction: column; align-items: stretch; gap: 0.75rem"
          >
            <div style="display: flex; gap: 1rem; align-items: center">
              <input
                type="password"
                id="openai-api-key"
                class="setting-input"
                style="max-width: 400px; flex: 1"
                placeholder="sk-..."
              />
              <button
                class="btn-save"
                onclick="saveSetting('openai_api_key', 'openai-api-key')"
              >
                Save Key
              </button>
              <button
                class="btn-test"
                onclick="testAIProvider('openai')"
                style="
                  background: var(--gray-200);
                  color: var(--text-primary);
                  border: none;
                  padding: 0.75rem 1rem;
                  border-radius: var(--radius-md);
                  cursor: pointer;
                "
              >
                <i class="fas fa-vial"></i> Test
              </button>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 80px"
                >Model:</label
              >
              <select
                id="openai-model"
                class="setting-input"
                style="max-width: 300px"
              >
                <!-- Populated dynamically from API -->
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('openai_model', 'openai-model')"
              >
                Save
              </button>
            </div>
          </div>
          <div class="success-message" id="success-openai-api-key">
            Setting saved!
          </div>
          <div class="success-message" id="success-openai-model">
            Model saved!
          </div>
        </div>

        <!-- Anthropic / Claude Configuration -->
        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">
                <i class="fas fa-comment-dots" style="color: #d97706"></i>
                Anthropic (Claude)
              </div>
              <div class="setting-description">
                Used for narrative construction and legal reasoning. Get your
                API key from
                <a
                  href="https://console.anthropic.com/settings/keys"
                  target="_blank"
                  >console.anthropic.com</a
                >
              </div>
            </div>
          </div>
          <div
            class="setting-control"
            style="flex-direction: column; align-items: stretch; gap: 0.75rem"
          >
            <div style="display: flex; gap: 1rem; align-items: center">
              <input
                type="password"
                id="anthropic-api-key"
                class="setting-input"
                style="max-width: 400px; flex: 1"
                placeholder="sk-ant-..."
              />
              <button
                class="btn-save"
                onclick="saveSetting('anthropic_api_key', 'anthropic-api-key')"
              >
                Save Key
              </button>
              <button
                class="btn-test"
                onclick="testAIProvider('anthropic')"
                style="
                  background: var(--gray-200);
                  color: var(--text-primary);
                  border: none;
                  padding: 0.75rem 1rem;
                  border-radius: var(--radius-md);
                  cursor: pointer;
                "
              >
                <i class="fas fa-vial"></i> Test
              </button>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 80px"
                >Model:</label
              >
              <select
                id="anthropic-model"
                class="setting-input"
                style="max-width: 300px"
              >
                <!-- Populated dynamically from API -->
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('anthropic_model', 'anthropic-model')"
              >
                Save
              </button>
            </div>
          </div>
          <div class="success-message" id="success-anthropic-api-key">
            Setting saved!
          </div>
          <div class="success-message" id="success-anthropic-model">
            Model saved!
          </div>
        </div>

        <!-- Google / Gemini Configuration -->
        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">
                <i class="fas fa-gem" style="color: #4285f4"></i> Google
                (Gemini)
              </div>
              <div class="setting-description">
                Used for pattern recognition and quick searches. Get your API
                key from
                <a href="https://aistudio.google.com/app/apikey" target="_blank"
                  >aistudio.google.com</a
                >
              </div>
            </div>
          </div>
          <div
            class="setting-control"
            style="flex-direction: column; align-items: stretch; gap: 0.75rem"
          >
            <div style="display: flex; gap: 1rem; align-items: center">
              <input
                type="password"
                id="gemini-api-key"
                class="setting-input"
                style="max-width: 400px; flex: 1"
                placeholder="AIza..."
              />
              <button
                class="btn-save"
                onclick="saveSetting('gemini_api_key', 'gemini-api-key')"
              >
                Save Key
              </button>
              <button
                class="btn-test"
                onclick="testAIProvider('gemini')"
                style="
                  background: var(--gray-200);
                  color: var(--text-primary);
                  border: none;
                  padding: 0.75rem 1rem;
                  border-radius: var(--radius-md);
                  cursor: pointer;
                "
              >
                <i class="fas fa-vial"></i> Test
              </button>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 80px"
                >Model:</label
              >
              <select
                id="gemini-model"
                class="setting-input"
                style="max-width: 300px"
              >
                <!-- Populated dynamically from API -->
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('gemini_model', 'gemini-model')"
              >
                Save
              </button>
            </div>
          </div>
          <div class="success-message" id="success-gemini-api-key">
            Setting saved!
          </div>
          <div class="success-message" id="success-gemini-model">
            Model saved!
          </div>
        </div>

        <!-- Amazon Bedrock Configuration -->
        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">
                <i class="fas fa-cloud" style="color: #ff9900"></i> Amazon Bedrock
              </div>
              <div class="setting-description">
                Enterprise AI via AWS Bedrock. Uses IAM credentials (no API key needed).
                Supports Claude, Nova, Titan, Llama, and Mistral models.
                <a href="https://aws.amazon.com/bedrock/" target="_blank">Learn more</a>
              </div>
            </div>
          </div>
          <div
            class="setting-control"
            style="flex-direction: column; align-items: stretch; gap: 0.75rem"
          >
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 80px">Enable:</label>
              <select
                id="bedrock-enabled"
                class="setting-input"
                style="max-width: 150px"
              >
                <option value="false">Disabled</option>
                <option value="true">Enabled</option>
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('bedrock_enabled', 'bedrock-enabled')"
              >
                Save
              </button>
              <button
                class="btn-test"
                onclick="testAIProvider('bedrock')"
                style="
                  background: var(--gray-200);
                  color: var(--text-primary);
                  border: none;
                  padding: 0.75rem 1rem;
                  border-radius: var(--radius-md);
                  cursor: pointer;
                "
              >
                <i class="fas fa-vial"></i> Test
              </button>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 80px">Region:</label>
              <select
                id="bedrock-region"
                class="setting-input"
                style="max-width: 200px"
              >
                <option value="us-east-1">US East (N. Virginia)</option>
                <option value="us-west-2">US West (Oregon)</option>
                <option value="eu-west-1">Europe (Ireland)</option>
                <option value="eu-west-2">Europe (London)</option>
                <option value="ap-northeast-1">Asia Pacific (Tokyo)</option>
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('bedrock_region', 'bedrock-region')"
              >
                Save
              </button>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 80px">Model:</label>
              <select
                id="bedrock-model"
                class="setting-input"
                style="max-width: 300px"
              >
                <!-- Populated dynamically from API -->
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('bedrock_model', 'bedrock-model')"
              >
                Save
              </button>
            </div>
          </div>
          <div class="success-message" id="success-bedrock-enabled">
            Setting saved!
          </div>
          <div class="success-message" id="success-bedrock-region">
            Setting saved!
          </div>
          <div class="success-message" id="success-bedrock-model">
            Model saved!
          </div>
        </div>

        <!-- AI Feature Toggles -->
        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">
                <i
                  class="fas fa-sliders-h"
                  style="color: var(--vericase-teal)"
                ></i>
                AI Feature Settings
              </div>
              <div class="setting-description">
                Enable or disable AI features and configure behavior
              </div>
            </div>
          </div>
          <div
            class="setting-control"
            style="flex-direction: column; align-items: stretch; gap: 1rem"
          >
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 200px"
                >Default AI Provider:</label
              >
              <select
                id="ai-default-provider"
                class="setting-input"
                style="max-width: 200px"
              >
                <option value="openai">OpenAI (GPT)</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="gemini">Google (Gemini)</option>
                <option value="bedrock">Amazon Bedrock</option>
              </select>
              <button
                class="btn-save"
                onclick="
                  saveSetting('ai_default_provider', 'ai-default-provider')
                "
              >
                Save
              </button>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 200px"
                >Enable Web Search:</label
              >
              <select
                id="ai-web-search"
                class="setting-input"
                style="max-width: 200px"
              >
                <option value="false">Disabled (Evidence Only)</option>
                <option value="true">Enabled</option>
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('ai_web_search_enabled', 'ai-web-search')"
              >
                Save
              </button>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 200px"
                >Enable Fallback:</label
              >
              <select
                id="ai-fallback-enabled"
                class="setting-input"
                style="max-width: 200px"
              >
                <option value="true">Enabled (Recommended)</option>
                <option value="false">Disabled</option>
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('ai_fallback_enabled', 'ai-fallback-enabled')"
              >
                Save
              </button>
              <span style="color: var(--text-secondary); font-size: 0.85rem">
                <i class="fas fa-info-circle"></i> Auto-retry with other providers on failure
              </span>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 200px"
                >Route Claude via Bedrock:</label
              >
              <select
                id="bedrock-route-claude"
                class="setting-input"
                style="max-width: 200px"
              >
                <option value="false">Disabled (Direct API)</option>
                <option value="true">Enabled (Via Bedrock)</option>
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('bedrock_route_claude', 'bedrock-route-claude')"
              >
                Save
              </button>
              <span style="color: var(--text-secondary); font-size: 0.85rem">
                <i class="fas fa-shield-alt"></i> Recommended for SOC2/HIPAA
              </span>
            </div>
          </div>
          <div class="success-message" id="success-ai-default-provider">
            Setting saved!
          </div>
          <div class="success-message" id="success-ai-web-search">
            Setting saved!
          </div>
          <div class="success-message" id="success-ai-fallback-enabled">
            Setting saved!
          </div>
          <div class="success-message" id="success-bedrock-route-claude">
            Setting saved!
          </div>
        </div>
      </div>

      <!-- AI Status Card -->
      <div class="settings-card" style="margin-top: 1.5rem">
        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">
                <i class="fas fa-heartbeat" style="color: var(--success)"></i>
                AI Provider Status
              </div>
              <div class="setting-description">
                Current status of configured AI providers
              </div>
            </div>
            <button
              onclick="checkAllProviders()"
              style="
                background: var(--vericase-teal);
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: var(--radius-md);
                cursor: pointer;
              "
            >
              <i class="fas fa-sync"></i> Refresh Status
            </button>
          </div>
          <div
            id="ai-status-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 1rem;
              margin-top: 1rem;
            "
          >
            <div class="status-card" id="status-openai">
              <i class="fas fa-circle" style="color: var(--gray-300)"></i>
              <span>OpenAI</span>
              <span class="status-text">Not configured</span>
            </div>
            <div class="status-card" id="status-anthropic">
              <i class="fas fa-circle" style="color: var(--gray-300)"></i>
              <span>Anthropic</span>
              <span class="status-text">Not configured</span>
            </div>
            <div class="status-card" id="status-gemini">
              <i class="fas fa-circle" style="color: var(--gray-300)"></i>
              <span>Google</span>
              <span class="status-text">Not configured</span>
            </div>
            <div class="status-card" id="status-bedrock">
              <i class="fas fa-circle" style="color: var(--gray-300)"></i>
              <span>Bedrock</span>
              <span class="status-text">Not configured</span>
            </div>
          </div>
        </div>
      </div>

      <!-- AG Grid & Data Display Settings -->
      <div class="settings-card" style="margin-top: 1.5rem">
        <div class="setting-item">
          <div class="setting-header">
            <div>
              <div class="setting-label">
                <i class="fas fa-table" style="color: var(--vericase-blue)"></i> Grid & Data Display Configuration
              </div>
              <div class="setting-description">
                Configure default settings for data grids (evidence, correspondence, contentious matters)
              </div>
            </div>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1rem">
            <!-- Row Height -->
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 150px">Default Row Height:</label>
              <input
                type="number"
                id="ag_grid_default_row_height"
                class="setting-input"
                min="50"
                max="500"
                step="10"
                placeholder="220"
                style="max-width: 150px"
              />
              <span style="color: var(--text-muted); font-size: 0.875rem">pixels</span>
              <button
                class="btn-save"
                onclick="saveSetting('ag_grid_default_row_height', 'ag_grid_default_row_height')"
              >
                Save
              </button>
            </div>

            <!-- Grid Theme -->
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 150px">Grid Theme:</label>
              <select
                id="ag_grid_theme"
                class="setting-input"
                style="max-width: 200px"
              >
                <option value="quartz">Quartz (Modern)</option>
                <option value="alpine">Alpine (Clean)</option>
                <option value="balham">Balham (Professional)</option>
                <option value="material">Material (Google)</option>
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('ag_grid_theme', 'ag_grid_theme')"
              >
                Save
              </button>
            </div>

            <!-- Pagination Page Size -->
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 150px">Rows Per Page:</label>
              <select
                id="ag_grid_pagination_page_size"
                class="setting-input"
                style="max-width: 150px"
              >
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
              </select>
              <button
                class="btn-save"
                onclick="saveSetting('ag_grid_pagination_page_size', 'ag_grid_pagination_page_size')"
              >
                Save
              </button>
            </div>

            <!-- Excel Export -->
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 150px">
                <input
                  type="checkbox"
                  id="ag_grid_enable_excel_export"
                  style="margin-right: 0.5rem"
                />
                Enable Excel Export
              </label>
              <button
                class="btn-save"
                onclick="saveGridCheckbox('ag_grid_enable_excel_export')"
              >
                Save
              </button>
            </div>

            <!-- CSV Export -->
            <div style="display: flex; gap: 1rem; align-items: center">
              <label style="color: var(--text-secondary); min-width: 150px">
                <input
                  type="checkbox"
                  id="ag_grid_enable_csv_export"
                  style="margin-right: 0.5rem"
                />
                Enable CSV Export
              </label>
              <button
                class="btn-save"
                onclick="saveGridCheckbox('ag_grid_enable_csv_export')"
              >
                Save
              </button>
            </div>
          </div>

          <div class="success-message" id="success-ag_grid_default_row_height">
            Setting saved!
          </div>
          <div class="success-message" id="success-ag_grid_theme">
            Setting saved!
          </div>
          <div class="success-message" id="success-ag_grid_pagination_page_size">
            Setting saved!
          </div>
          <div class="success-message" id="success-ag_grid_enable_excel_export">
            Setting saved!
          </div>
          <div class="success-message" id="success-ag_grid_enable_csv_export">
            Setting saved!
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "login.html";
      }

      // Setting descriptions for AI keys (4 providers: OpenAI, Anthropic, Gemini, Bedrock)
      const settingDescriptions = {
        textract_page_threshold:
          "PDFs with more pages than this threshold will use Tika instead of AWS Textract",
        textract_max_pages: "Maximum number of pages Textract can process",
        openai_api_key: "OpenAI API key for GPT models",
        openai_model: "OpenAI model to use for analysis",
        anthropic_api_key: "Anthropic API key for Claude models",
        anthropic_model: "Anthropic model to use for narrative construction",
        gemini_api_key: "Google AI API key for Gemini models",
        gemini_model: "Gemini model to use for pattern recognition",
        bedrock_enabled: "Enable Amazon Bedrock for enterprise AI",
        bedrock_region: "AWS region for Bedrock",
        bedrock_model: "Bedrock model to use for analysis",
        ai_default_provider: "Default AI provider for quick searches",
        ai_web_search_enabled: "Enable web search in AI queries",
        ai_fallback_enabled: "Enable automatic fallback to other providers on failure",
        bedrock_route_claude: "Route all Claude requests through AWS Bedrock (SOC2/HIPAA)",
        // AG Grid configuration settings
        ag_grid_default_row_height: "Default row height for AG Grid tables (in pixels)",
        ag_grid_theme: "AG Grid theme for all tables",
        ag_grid_pagination_page_size: "Default number of rows per page",
        ag_grid_enable_excel_export: "Enable Excel export functionality",
        ag_grid_enable_csv_export: "Enable CSV export functionality",
      };

      // Load current settings on page load
      async function loadSettings() {
        try {
          const response = await fetch(`${API_BASE}/api/admin/settings`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.status === 403) {
            alert("Admin access required");
            window.location.href = "dashboard.html";
            return;
          }

          if (!response.ok) {
            console.error("Error loading settings: Failed to load settings");
            return;
          }

          const settings = await response.json();

          // Populate form fields
          settings.forEach((setting) => {
            const key = setting.key;
            const value = setting.value;

            // Map setting keys to input IDs (4 providers: OpenAI, Anthropic, Gemini, Bedrock)
            const inputIdMap = {
              textract_page_threshold: "textract-page-threshold",
              textract_max_pages: "textract-max-pages",
              openai_api_key: "openai-api-key",
              openai_model: "openai-model",
              anthropic_api_key: "anthropic-api-key",
              anthropic_model: "anthropic-model",
              gemini_api_key: "gemini-api-key",
              gemini_model: "gemini-model",
              bedrock_enabled: "bedrock-enabled",
              bedrock_region: "bedrock-region",
              bedrock_model: "bedrock-model",
              ai_default_provider: "ai-default-provider",
              ai_web_search_enabled: "ai-web-search",
              ai_fallback_enabled: "ai-fallback-enabled",
              bedrock_route_claude: "bedrock-route-claude",
              // AG Grid configuration settings
              ag_grid_default_row_height: "ag_grid_default_row_height",
              ag_grid_theme: "ag_grid_theme",
              ag_grid_pagination_page_size: "ag_grid_pagination_page_size",
              ag_grid_enable_excel_export: "ag_grid_enable_excel_export",
              ag_grid_enable_csv_export: "ag_grid_enable_csv_export",
            };

            const inputId = inputIdMap[key];
            if (inputId) {
              const input = document.getElementById(inputId);
              if (input) {
                // For API keys, show masked value if exists
                if (key.includes("api_key") && value) {
                  input.placeholder = "••••••••" + value.slice(-4);
                } else if (input.type === 'checkbox') {
                  // Handle checkboxes
                  input.checked = value === 'true';
                } else {
                  input.value = value;
                }
              }
            }
          });

          // Update status indicators
          checkAllProviders();
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      async function saveSetting(key, inputId) {
        const input = document.getElementById(inputId);
        const value = input.value;

        // Find success message - handle both underscore and hyphen formats
        const successMsgId = `success-${inputId}`;
        let successMsg = document.getElementById(successMsgId);
        if (!successMsg) {
          // Try alternative format
          successMsg = document.getElementById(
            `success-${key.replace(/_/g, "-")}`,
          );
        }

        try {
          const response = await fetch(
            `${API_BASE}/api/admin/settings/${key}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                value: value,
                description: settingDescriptions[key] || key,
              }),
            },
          );

          if (response.status === 403) {
            alert("Admin access required");
            return;
          }

          if (!response.ok) {
            console.error("Error saving setting: Failed to save setting");
            alert("Failed to save setting");
            return;
          }

          // Show success message
          if (successMsg) {
            successMsg.classList.add("show");
            setTimeout(() => {
              successMsg.classList.remove("show");
            }, 3000);
          }

          // For API keys, update placeholder to show it's saved
          if (key.includes("api_key") && value) {
            input.value = "";
            input.placeholder = "••••••••" + value.slice(-4);
          }

          // Refresh status after saving
          if (key.includes("api_key")) {
            setTimeout(checkAllProviders, 500);
          }
        } catch (error) {
          console.error("Error saving setting:", error);
          alert("Failed to save setting. Please try again.");
        }
      }

      async function saveGridCheckbox(key) {
        const input = document.getElementById(key);
        const value = input.checked.toString();

        const successMsg = document.getElementById(`success-${key}`);

        try {
          const response = await fetch(
            `${API_BASE}/api/admin/settings/${key}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                value: value,
                description: settingDescriptions[key] || key,
              }),
            },
          );

          if (response.status === 403) {
            alert("Admin access required");
            return;
          }

          if (!response.ok) {
            console.error("Error saving setting: Failed to save setting");
            alert("Failed to save setting");
            return;
          }

          // Show success message
          if (successMsg) {
            successMsg.classList.add("show");
            setTimeout(() => {
              successMsg.classList.remove("show");
            }, 3000);
          }
        } catch (error) {
          console.error("Error saving setting:", error);
          alert("Failed to save setting. Please try again.");
        }
      }

      async function testAIProvider(provider) {
        const testBtn = event.target.closest("button");
        const originalText = testBtn.innerHTML;
        testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        testBtn.disabled = true;

        try {
          const response = await fetch(
            `${API_BASE}/api/ai-chat/models/test/${provider}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          const result = await response.json();

          if (response.ok && result.success) {
            alert(
              `${provider.toUpperCase()} connection successful!\n\nModel: ${result.model}\nResponse time: ${result.response_time}ms`,
            );
            updateProviderStatus(provider, true, "Connected");
          } else {
            alert(
              `${provider.toUpperCase()} test failed:\n\n${result.error || "Unknown error"}`,
            );
            updateProviderStatus(provider, false, "Error");
          }
        } catch (error) {
          alert(`Failed to test ${provider}: ${error.message}`);
          updateProviderStatus(provider, false, "Error");
        } finally {
          testBtn.innerHTML = originalText;
          testBtn.disabled = false;
        }
      }

      async function checkAllProviders() {
        try {
          const response = await fetch(
            `${API_BASE}/api/ai-chat/models/status`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          if (!response.ok) return;

          const status = await response.json();

          // Update each provider status (4 providers: OpenAI, Anthropic, Gemini, Bedrock)
          if (status.models) {
            updateProviderStatus(
              "openai",
              status.models.openai?.available,
              status.models.openai?.available
                ? "Configured"
                : "Not configured",
            );
            updateProviderStatus(
              "anthropic",
              status.models.anthropic?.available,
              status.models.anthropic?.available
                ? "Configured"
                : "Not configured",
            );
            updateProviderStatus(
              "gemini",
              status.models.gemini?.available,
              status.models.gemini?.available
                ? "Configured"
                : "Not configured",
            );
            updateProviderStatus(
              "bedrock",
              status.models.bedrock?.available,
              status.models.bedrock?.available ? "Enabled" : "Not enabled",
            );
          }
        } catch (error) {
          console.error("Error checking provider status:", error);
        }
      }

      function updateProviderStatus(provider, isConfigured, statusText) {
        const statusCard = document.getElementById(`status-${provider}`);
        if (!statusCard) return;

        const icon = statusCard.querySelector("i");
        const text = statusCard.querySelector(".status-text");

        statusCard.classList.remove("configured", "error");

        if (isConfigured) {
          statusCard.classList.add("configured");
          icon.style.color = "var(--success)";
        } else {
          icon.style.color = "var(--gray-300)";
        }

        if (text) {
          text.textContent = statusText;
        }
      }

      // Load AI models from API and populate dropdowns
      async function loadAIModels() {
        try {
          const response = await fetch(`${API_BASE}/api/admin/ai/models`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            console.error("Failed to load AI models");
            return;
          }

          const data = await response.json();
          const providers = data.providers;

          // Populate each provider's model dropdown
          populateModelDropdown("openai-model", providers.openai?.models || []);
          populateModelDropdown("anthropic-model", providers.anthropic?.models || []);
          populateModelDropdown("gemini-model", providers.gemini?.models || []);
          populateModelDropdown("bedrock-model", providers.bedrock?.models || []);
        } catch (error) {
          console.error("Error loading AI models:", error);
        }
      }

      function populateModelDropdown(selectId, models) {
        const select = document.getElementById(selectId);
        if (!select || !models.length) return;

        // Store current value before clearing
        const currentValue = select.value;

        // Clear existing options
        select.innerHTML = "";

        // Add models from API
        models.forEach((model) => {
          const option = document.createElement("option");
          option.value = model.id;
          option.textContent = model.name || model.id;
          select.appendChild(option);
        });

        // Restore value if it exists in new options
        if (currentValue) {
          const exists = Array.from(select.options).some(opt => opt.value === currentValue);
          if (exists) {
            select.value = currentValue;
          }
        }
      }

      // Load settings on page load
      loadAIModels().then(() => loadSettings());
    </script>
  </body>
</html>

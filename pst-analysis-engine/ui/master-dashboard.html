<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriCase - Command Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="brand-styles.css">
    <link rel="stylesheet" href="design-system.css">
    <style>
        :root {
            --vericase-teal: #17B5A3;
            --vericase-teal-dark: #129B8B;
            --vericase-blue: #2B7FBF;
            --vericase-navy: #1F2937;
            --bg-primary: #F0F4F8;
            --brand-primary: #17B5A3;
            --brand-primary-dark: #129B8B;
            --brand-secondary: #2B7FBF;
            --project-accent: #3B82F6;
            --case-accent: #F59E0B;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--vericase-navy);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* === LAYOUT === */
        .master-dashboard {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--vericase-navy) 0%, #2d3748 100%);
            color: white;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: var(--vericase-teal);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--vericase-teal);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-greeting {
            text-align: right;
        }

        .user-greeting .greeting {
            font-size: 13px;
            opacity: 0.8;
        }

        .user-greeting .name {
            font-size: 15px;
            font-weight: 600;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-avatar:hover {
            background: rgba(255,255,255,0.25);
        }

        /* === STATS BAR === */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            max-width: 700px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        .stat-item:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .stat-icon.projects { background: rgba(59, 130, 246, 0.3); color: #93C5FD; }
        .stat-icon.cases { background: rgba(245, 158, 11, 0.3); color: #FCD34D; }
        .stat-icon.emails { background: rgba(16, 185, 129, 0.3); color: #6EE7B7; }
        .stat-icon.evidence { background: rgba(139, 92, 246, 0.3); color: #C4B5FD; }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            line-height: 1;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* === MAIN CONTENT === */
        .dashboard-main {
            flex: 1;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        /* === TOOLBAR === */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 12px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .filter-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: var(--shadow-sm);
        }

        .filter-tab {
            padding: 8px 16px;
            border: none;
            background: none;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-500);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tab:hover {
            color: var(--gray-700);
        }

        .filter-tab.active {
            background: var(--vericase-teal);
            color: white;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 280px;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--vericase-teal);
            box-shadow: 0 0 0 3px rgba(23, 181, 163, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: var(--vericase-teal);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(23, 181, 163, 0.35);
        }

        .btn-primary:hover {
            background: var(--vericase-teal-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23, 181, 163, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        /* === WORK ITEMS GRID === */
        .work-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
        }

        .work-item-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            transition: all 0.25s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .work-item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--project-accent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .work-item-card.type-case::before {
            background: var(--case-accent);
        }

        .work-item-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
            border-color: var(--gray-200);
        }

        .work-item-card:hover::before {
            transform: scaleX(1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-badge.project {
            background: rgba(59, 130, 246, 0.1);
            color: var(--project-accent);
        }

        .type-badge.case {
            background: rgba(245, 158, 11, 0.1);
            color: var(--case-accent);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .status-badge.inactive {
            background: rgba(107, 114, 128, 0.1);
            color: var(--gray-500);
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .card-code {
            font-size: 12px;
            color: var(--gray-500);
            font-family: 'SF Mono', Monaco, monospace;
            margin-bottom: 10px;
        }

        .card-description {
            font-size: 13px;
            color: var(--gray-600);
            line-height: 1.5;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-stats {
            display: flex;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
        }

        .card-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--gray-500);
        }

        .card-stat i {
            font-size: 14px;
        }

        .card-stat.highlight {
            color: var(--vericase-teal);
            font-weight: 500;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
        }

        .card-date {
            font-size: 12px;
            color: var(--gray-400);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--vericase-teal);
            color: white;
        }

        /* === EMPTY STATE === */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 14px;
            border: 2px dashed var(--gray-200);
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 32px;
            color: var(--gray-400);
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* === SKELETON LOADING === */
        .skeleton-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }

        .skeleton-badge {
            width: 70px;
            height: 22px;
            margin-bottom: 12px;
        }

        .skeleton-title {
            height: 24px;
            width: 80%;
            margin-bottom: 8px;
        }

        .skeleton-text {
            height: 16px;
            width: 60%;
            margin-bottom: 16px;
        }

        .skeleton-stats {
            display: flex;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
        }

        .skeleton-stat {
            height: 18px;
            width: 60px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* === CREATE MODAL === */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-body {
            padding: 24px;
        }

        .type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .type-option {
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .type-option:hover {
            border-color: var(--gray-300);
        }

        .type-option.selected {
            border-color: var(--vericase-teal);
            background: rgba(23, 181, 163, 0.05);
        }

        .type-option i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .type-option.project-type i { color: var(--project-accent); }
        .type-option.case-type i { color: var(--case-accent); }

        .type-option span {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--vericase-teal);
            box-shadow: 0 0 0 3px rgba(23, 181, 163, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-100);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* === QUICK LINKS === */
        .quick-links {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--gray-200);
        }

        .quick-links-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: white;
            border-radius: 10px;
            text-decoration: none;
            color: var(--gray-700);
            transition: all 0.2s;
            border: 1px solid var(--gray-100);
        }

        .quick-link:hover {
            border-color: var(--vericase-teal);
            background: rgba(23, 181, 163, 0.02);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .quick-link i {
            font-size: 18px;
            color: var(--vericase-teal);
        }

        .quick-link span {
            font-size: 14px;
            font-weight: 500;
        }

        /* === ADMIN NOTICE === */
        .admin-notice {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-notice i {
            color: #8B5CF6;
            font-size: 18px;
        }

        .admin-notice span {
            font-size: 13px;
            color: var(--gray-700);
        }

        .admin-notice a {
            color: #8B5CF6;
            font-weight: 600;
            text-decoration: none;
        }

        .admin-notice a:hover {
            text-decoration: underline;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1rem;
            }

            .header-top {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .user-section {
                width: 100%;
                justify-content: flex-end;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-main {
                padding: 1rem;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left,
            .toolbar-right {
                width: 100%;
                flex-direction: column;
            }

            .search-box input {
                width: 100%;
            }

            .work-items-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="master-dashboard">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="logo-text">Veri<span>Case</span></div>
                </div>
                <div class="user-section">
                    <div class="user-greeting">
                        <div class="greeting" id="greetingText">Welcome back</div>
                        <div class="name" id="userName">Loading...</div>
                    </div>
                    <div class="user-avatar" id="userAvatar" title="Profile & Settings">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-bar" id="statsBar">
                <div class="stat-item">
                    <div class="stat-icon projects">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statProjects">-</div>
                        <div class="stat-label">Projects</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon cases">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statCases">-</div>
                        <div class="stat-label">Cases</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon emails">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statEmails">-</div>
                        <div class="stat-label">Emails</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon evidence">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div>
                        <div class="stat-value" id="statEvidence">-</div>
                        <div class="stat-label">Evidence</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Admin Notice (shown for admins only) -->
            <div class="admin-notice" id="adminNotice" style="display: none;">
                <i class="fas fa-shield-alt"></i>
                <span>You have administrator access. <a href="admin-settings.html">Manage settings</a> or <a href="admin-users.html">manage users</a>.</span>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <h1 class="page-title">Your Workspace</h1>
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all">All</button>
                        <button class="filter-tab" data-filter="project">Projects</button>
                        <button class="filter-tab" data-filter="case">Cases</button>
                    </div>
                </div>
                <div class="toolbar-right">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search projects and cases...">
                    </div>
                    <button class="btn btn-primary" id="createNewBtn">
                        <i class="fas fa-plus"></i>
                        Create New
                    </button>
                </div>
            </div>

            <!-- Work Items Grid -->
            <div class="work-items-grid" id="workItemsGrid">
                <!-- Loading skeletons -->
                <div class="skeleton-card">
                    <div class="skeleton skeleton-badge"></div>
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton-stats">
                        <div class="skeleton skeleton-stat"></div>
                        <div class="skeleton skeleton-stat"></div>
                        <div class="skeleton skeleton-stat"></div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton skeleton-badge"></div>
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton-stats">
                        <div class="skeleton skeleton-stat"></div>
                        <div class="skeleton skeleton-stat"></div>
                        <div class="skeleton skeleton-stat"></div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton skeleton-badge"></div>
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton-stats">
                        <div class="skeleton skeleton-stat"></div>
                        <div class="skeleton skeleton-stat"></div>
                        <div class="skeleton skeleton-stat"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <section class="quick-links" id="quickLinksSection">
                <div class="quick-links-title">Quick Actions</div>
                <div class="quick-links-grid">
                    <a href="pst-upload.html" class="quick-link">
                        <i class="fas fa-upload"></i>
                        <span>Upload PST File</span>
                    </a>
                    <a href="wizard.html" class="quick-link">
                        <i class="fas fa-magic"></i>
                        <span>Project Setup Wizard</span>
                    </a>
                    <a href="evidence.html" class="quick-link">
                        <i class="fas fa-folder-open"></i>
                        <span>Evidence Repository</span>
                    </a>
                    <a href="deep-research.html" class="quick-link">
                        <i class="fas fa-microscope"></i>
                        <span>Deep Research</span>
                    </a>
                </div>
            </section>
        </main>
    </div>

    <!-- Create Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Create New</h2>
                <button class="modal-close" id="modalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="type-selector">
                    <div class="type-option project-type selected" data-type="project">
                        <i class="fas fa-project-diagram"></i>
                        <span>Project</span>
                    </div>
                    <div class="type-option case-type" data-type="case">
                        <i class="fas fa-briefcase"></i>
                        <span>Case</span>
                    </div>
                </div>

                <form id="createForm">
                    <div class="form-group">
                        <label for="itemName">Name *</label>
                        <input type="text" id="itemName" required placeholder="Enter name...">
                    </div>
                    
                    <div class="form-group" id="codeGroup">
                        <label for="itemCode">Project Code *</label>
                        <input type="text" id="itemCode" placeholder="e.g., PRJ-2024-001">
                    </div>

                    <div class="form-group">
                        <label for="itemDescription">Description</label>
                        <textarea id="itemDescription" placeholder="Brief description..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="contractType">Contract Type</label>
                        <select id="contractType">
                            <option value="">Select contract type...</option>
                            <option value="JCT">JCT</option>
                            <option value="NEC">NEC</option>
                            <option value="FIDIC">FIDIC</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreate">Cancel</button>
                <button class="btn btn-primary" id="confirmCreate">
                    <i class="fas fa-plus"></i>
                    Create
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // State
        // ============================================================================
        let dashboardData = null;
        let currentFilter = 'all';
        let searchQuery = '';
        let selectedType = 'project';

        // ============================================================================
        // API
        // ============================================================================
        async function fetchDashboardData() {
            try {
                // Try authenticated endpoint first
                const response = await fetch('/api/dashboard/overview');
                if (response.ok) {
                    return await response.json();
                }
                
                // Fall back to public endpoint
                const publicResponse = await fetch('/api/dashboard/overview/public');
                if (publicResponse.ok) {
                    return await publicResponse.json();
                }
                
                throw new Error('Failed to load dashboard data');
            } catch (error) {
                console.error('Dashboard API error:', error);
                return null;
            }
        }

        async function createWorkItem(type, data) {
            try {
                const endpoint = type === 'project' ? '/api/projects' : '/api/cases';
                
                const payload = type === 'project' 
                    ? {
                        project_name: data.name,
                        project_code: data.code,
                        contract_type: data.contractType || null
                    }
                    : {
                        case_name: data.name,
                        case_id: data.code || null,
                        description: data.description,
                        contract_type: data.contractType || null
                    };

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return await response.json();
                }
                
                const error = await response.json();
                throw new Error(error.detail || 'Failed to create');
            } catch (error) {
                console.error('Create error:', error);
                throw error;
            }
        }

        // ============================================================================
        // Rendering
        // ============================================================================
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'No date';
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'short',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        function getTimeGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good morning';
            if (hour < 17) return 'Good afternoon';
            return 'Good evening';
        }

        function renderStats(stats) {
            document.getElementById('statProjects').textContent = formatNumber(stats.total_projects);
            document.getElementById('statCases').textContent = formatNumber(stats.total_cases);
            document.getElementById('statEmails').textContent = formatNumber(stats.total_emails);
            document.getElementById('statEvidence').textContent = formatNumber(stats.total_evidence);
        }

        function renderUserInfo(user, permissions) {
            document.getElementById('greetingText').textContent = getTimeGreeting();
            document.getElementById('userName').textContent = user.display_name || user.email;
            
            // Show admin notice if applicable
            if (permissions.can_access_admin) {
                document.getElementById('adminNotice').style.display = 'flex';
            }
        }

        function renderWorkItems(items) {
            const grid = document.getElementById('workItemsGrid');
            
            // Apply filters
            let filtered = items;
            if (currentFilter !== 'all') {
                filtered = items.filter(item => item.type === currentFilter);
            }
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(query) ||
                    (item.project_code && item.project_code.toLowerCase().includes(query)) ||
                    (item.case_number && item.case_number.toLowerCase().includes(query)) ||
                    (item.description && item.description.toLowerCase().includes(query))
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = renderEmptyState();
                return;
            }

            grid.innerHTML = filtered.map(item => renderWorkItemCard(item)).join('');

            // Add click handlers
            grid.querySelectorAll('.work-item-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.btn-icon')) return; // Don't navigate on action buttons
                    const id = card.dataset.id;
                    const type = card.dataset.type;
                    navigateToItem(type, id);
                });
            });
        }

        function renderWorkItemCard(item) {
            const code = item.type === 'project' ? item.project_code : item.case_number;
            const typeClass = item.type === 'project' ? 'project' : 'case';
            const typeLabel = item.type === 'project' ? 'Project' : 'Case';
            const typeIcon = item.type === 'project' ? 'fa-project-diagram' : 'fa-briefcase';

            return `
                <div class="work-item-card type-${typeClass}" data-id="${item.id}" data-type="${item.type}">
                    <div class="card-header">
                        <span class="type-badge ${typeClass}">
                            <i class="fas ${typeIcon}"></i>
                            ${typeLabel}
                        </span>
                        <span class="status-badge ${item.status === 'active' ? '' : 'inactive'}">
                            ${item.status || 'Active'}
                        </span>
                    </div>
                    <div class="card-title">${escapeHtml(item.name)}</div>
                    ${code ? `<div class="card-code">${escapeHtml(code)}</div>` : ''}
                    ${item.description ? `<div class="card-description">${escapeHtml(item.description)}</div>` : ''}
                    <div class="card-stats">
                        <div class="card-stat ${item.email_count > 0 ? 'highlight' : ''}">
                            <i class="fas fa-envelope"></i>
                            <span>${formatNumber(item.email_count)} emails</span>
                        </div>
                        <div class="card-stat ${item.evidence_count > 0 ? 'highlight' : ''}">
                            <i class="fas fa-file-alt"></i>
                            <span>${formatNumber(item.evidence_count)} docs</span>
                        </div>
                        <div class="card-stat">
                            <i class="fas fa-archive"></i>
                            <span>${item.pst_count} PST</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="card-date">
                            <i class="fas fa-clock"></i>
                            ${formatDate(item.updated_at || item.created_at)}
                        </div>
                        <div class="card-actions">
                            <button class="btn-icon" title="Correspondence" onclick="event.stopPropagation(); navigateToCorrespondence('${item.id}', '${item.type}')">
                                <i class="fas fa-envelope-open-text"></i>
                            </button>
                            <button class="btn-icon" title="Evidence" onclick="event.stopPropagation(); navigateToEvidence('${item.id}', '${item.type}')">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            <button class="btn-icon" title="Settings" onclick="event.stopPropagation(); navigateToSettings('${item.id}', '${item.type}')">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEmptyState() {
            const isFiltered = currentFilter !== 'all' || searchQuery;
            
            if (isFiltered) {
                return `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>No results found</h3>
                        <p>Try adjusting your search or filter criteria to find what you're looking for.</p>
                        <div class="empty-state-actions">
                            <button class="btn btn-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                                Clear filters
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-state-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h3>Welcome to VeriCase</h3>
                    <p>Get started by creating your first project or case. You can upload PST files, manage evidence, and run deep research.</p>
                    <div class="empty-state-actions">
                        <button class="btn btn-primary" onclick="openCreateModal()">
                            <i class="fas fa-plus"></i>
                            Create Project
                        </button>
                        <button class="btn btn-secondary" onclick="window.location.href='pst-upload.html'">
                            <i class="fas fa-upload"></i>
                            Upload PST
                        </button>
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // Navigation
        // ============================================================================
        function navigateToItem(type, id) {
            // Store the current context
            localStorage.setItem('vericase_current_project', id);
            localStorage.setItem('vericase_current_type', type);
            
            // Navigate to the project-specific dashboard
            window.location.href = `dashboard.html?projectId=${id}`;
        }

        function navigateToCorrespondence(id, type) {
            localStorage.setItem('vericase_current_project', id);
            window.location.href = `correspondence-enterprise.html?projectId=${id}`;
        }

        function navigateToEvidence(id, type) {
            localStorage.setItem('vericase_current_project', id);
            window.location.href = `evidence.html?projectId=${id}`;
        }

        function navigateToSettings(id, type) {
            localStorage.setItem('vericase_current_project', id);
            window.location.href = `wizard.html?projectId=${id}&edit=true`;
        }

        // ============================================================================
        // Modal
        // ============================================================================
        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
            document.getElementById('itemName').focus();
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            document.getElementById('createForm').reset();
        }

        function updateFormForType(type) {
            selectedType = type;
            const codeGroup = document.getElementById('codeGroup');
            const codeInput = document.getElementById('itemCode');
            const codeLabel = codeGroup.querySelector('label');
            
            document.querySelectorAll('.type-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.type === type);
            });
            
            if (type === 'project') {
                codeLabel.textContent = 'Project Code *';
                codeInput.placeholder = 'e.g., PRJ-2024-001';
                codeInput.required = true;
            } else {
                codeLabel.textContent = 'Case Number';
                codeInput.placeholder = 'e.g., CASE-2024-001 (optional)';
                codeInput.required = false;
            }
        }

        async function handleCreate() {
            const name = document.getElementById('itemName').value.trim();
            const code = document.getElementById('itemCode').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const contractType = document.getElementById('contractType').value;

            if (!name) {
                alert('Please enter a name');
                return;
            }

            if (selectedType === 'project' && !code) {
                alert('Please enter a project code');
                return;
            }

            const btn = document.getElementById('confirmCreate');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

            try {
                const result = await createWorkItem(selectedType, {
                    name,
                    code,
                    description,
                    contractType
                });

                closeCreateModal();
                
                // Reload dashboard data
                await loadDashboard();
                
                // Show success message
                showToast(`${selectedType === 'project' ? 'Project' : 'Case'} created successfully!`, 'success');

            } catch (error) {
                alert('Error creating: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> Create';
            }
        }

        // ============================================================================
        // Filters
        // ============================================================================
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });
            renderWorkItems(dashboardData?.work_items || []);
        }

        function clearFilters() {
            currentFilter = 'all';
            searchQuery = '';
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === 'all');
            });
            renderWorkItems(dashboardData?.work_items || []);
        }

        // ============================================================================
        // Utilities
        // ============================================================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
                color: white;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================================================
        // Initialize
        // ============================================================================
        async function loadDashboard() {
            dashboardData = await fetchDashboardData();
            
            if (dashboardData) {
                renderStats(dashboardData.stats);
                renderUserInfo(dashboardData.user, dashboardData.permissions);
                renderWorkItems(dashboardData.work_items);
                
                // Update quick links based on permissions
                if (!dashboardData.permissions.can_create_project) {
                    document.getElementById('createNewBtn').style.display = 'none';
                }
            } else {
                // Show error state
                document.getElementById('workItemsGrid').innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Unable to load data</h3>
                        <p>There was a problem connecting to the server. Please try again.</p>
                        <div class="empty-state-actions">
                            <button class="btn btn-primary" onclick="loadDashboard()">
                                <i class="fas fa-redo"></i>
                                Retry
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // === PREFETCH EVIDENCE DATA FOR FASTER TAB SWITCHING ===
        // Only prefetch summary stats, not all items (was causing major slowdown)
        async function prefetchEvidenceData() {
            try {
                // Wait for main dashboard to render first
                await new Promise(resolve => setTimeout(resolve, 1000));

                console.log('[Prefetch] Starting evidence stats prefetch...');
                const startTime = performance.now();

                // Only prefetch stats and collections (lightweight) - NOT all items
                const [collectionsRes, statsRes] = await Promise.all([
                    fetch('/api/evidence/collections?include_system=true'),
                    fetch('/api/evidence/stats')
                ]);

                if (collectionsRes.ok && statsRes.ok) {
                    const [collections, stats] = await Promise.all([
                        collectionsRes.json(),
                        statsRes.json()
                    ]);

                    // Store lightweight data for evidence page
                    const prefetchData = {
                        collections: collections.collections || collections || [],
                        stats: stats,
                        timestamp: Date.now()
                    };

                    sessionStorage.setItem('vericase_evidence_prefetch', JSON.stringify(prefetchData));

                    const duration = (performance.now() - startTime).toFixed(0);
                    console.log(`[Prefetch] Evidence stats cached in ${duration}ms`);
                }
            } catch (err) {
                console.warn('[Prefetch] Evidence prefetch failed (non-critical):', err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load dashboard data
            loadDashboard();
            
            // Prefetch evidence data in background for faster tab switching
            prefetchEvidenceData();

            // Filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => setFilter(tab.dataset.filter));
            });

            // Search
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchQuery = e.target.value.trim();
                    renderWorkItems(dashboardData?.work_items || []);
                }, 300);
            });

            // Create modal
            document.getElementById('createNewBtn').addEventListener('click', openCreateModal);
            document.getElementById('modalClose').addEventListener('click', closeCreateModal);
            document.getElementById('cancelCreate').addEventListener('click', closeCreateModal);
            document.getElementById('confirmCreate').addEventListener('click', handleCreate);
            
            document.getElementById('createModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('createModal')) {
                    closeCreateModal();
                }
            });

            // Type selector
            document.querySelectorAll('.type-option').forEach(opt => {
                opt.addEventListener('click', () => updateFormForType(opt.dataset.type));
            });

            // User avatar menu
            document.getElementById('userAvatar').addEventListener('click', () => {
                window.location.href = 'profile.html';
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeCreateModal();
                }
                if (e.key === 'n' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    openCreateModal();
                }
            });
        });

        // Add CSS for toast animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>


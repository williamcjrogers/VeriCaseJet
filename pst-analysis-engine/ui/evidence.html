<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        /* ============================================
           PAGE-SPECIFIC STYLES
           ============================================ */

        body {
            background: var(--bg-primary);
            overflow: hidden;
        }

        .evidence-layout {
            display: flex;
            height: calc(100vh - 64px);
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-container input {
            width: 100%;
            padding: 10px 16px 10px 42px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            transition: all var(--duration-fast);
            background: var(--gray-50);
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--vericase-teal);
            background: white;
            box-shadow: 0 0 0 3px rgba(23, 181, 163, 0.1);
        }

        .search-container i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            transition: color var(--duration-fast);
        }

        .search-container:focus-within i {
            color: var(--vericase-teal);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-select {
            padding: 10px 32px 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 0.8125rem;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            transition: all var(--duration-fast);
        }

        .filter-select:hover {
            border-color: var(--gray-300);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--vericase-teal);
        }

        .checkbox-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-full);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all var(--duration-fast);
            user-select: none;
            background: white;
        }

        .checkbox-pill:hover {
            border-color: var(--gray-300);
        }

        .checkbox-pill.active {
            background: rgba(23, 181, 163, 0.1);
            border-color: var(--vericase-teal);
            color: var(--vericase-teal-dark);
        }

        .checkbox-pill input {
            display: none;
        }

        .toolbar-spacer {
            flex: 1;
        }

        /* Stats Bar */
        .stats-bar {
            padding: 10px 24px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 32px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 0;
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 24px;
        }

        .category-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all var(--duration-fast);
        }

        .category-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--vericase-teal);
            transform: scaleX(0);
            transition: transform var(--duration-normal) var(--ease-out-expo);
        }

        .category-tab:hover {
            color: var(--text-primary);
        }

        .category-tab.active {
            color: var(--vericase-teal);
        }

        .category-tab.active::after {
            transform: scaleX(1);
        }

        .tab-count {
            background: var(--gray-200);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            transition: all var(--duration-fast);
        }

        .category-tab.active .tab-count {
            background: rgba(23, 181, 163, 0.15);
            color: var(--vericase-teal-dark);
        }

        /* Collections Sidebar */
        .collections-sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-section-title {
            padding: 16px 16px 8px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }

        .collection-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 8px 16px;
        }

        .collection-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all var(--duration-fast);
        }

        .collection-item:hover {
            background: var(--gray-100);
            color: var(--text-primary);
        }

        .collection-item.active {
            background: rgba(23, 181, 163, 0.1);
            color: var(--vericase-teal-dark);
        }

        .collection-item i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
            opacity: 0.7;
        }

        .collection-item.active i {
            opacity: 1;
            color: var(--vericase-teal);
        }

        .collection-count {
            margin-left: auto;
            background: var(--gray-200);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.6875rem;
            font-weight: 600;
        }

        .collection-item.active .collection-count {
            background: rgba(23, 181, 163, 0.2);
            color: var(--vericase-teal-dark);
        }

        /* Grid Container */
        .grid-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--gray-50);
            position: relative;
        }

        .grid-wrapper {
            flex: 1;
            padding: 16px;
            overflow: hidden;
        }

        #evidenceGrid {
            .ag-theme-alpine .ag-root-wrapper {
                border: 1px solid var(--gray-200);
                border-radius: var(--radius-lg);
            }

            .ag-theme-alpine .ag-header {
                border-bottom: 2px solid var(--gray-200);
            }

            .ag-theme-alpine .ag-header-cell {
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.6875rem;
                letter-spacing: 0.05em;
            }

            .ag-theme-alpine .ag-row {
                transition: background-color var(--duration-fast);
            }

            .ag-theme-alpine .ag-row:hover {
                background-color: rgba(23, 181, 163, 0.04) !important;
            }

            .ag-theme-alpine .ag-row-selected {
                background-color: rgba(23, 181, 163, 0.08) !important;
            }

            /* Grid Cell Renderers */
            .grid-thumbnail {
                width: 36px;
                height: 36px;
                object-fit: cover;
                border-radius: var(--radius-sm);
                background: var(--gray-100);
            }

            .grid-file-icon {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--gray-100);
                border-radius: var(--radius-sm);
                font-size: 1rem;
            }

            .grid-file-icon.pdf {
                background: #FEE2E2;
                color: #DC2626;
            }

            .grid-file-icon.word {
                background: #DBEAFE;
                color: #2563EB;
            }

            .grid-file-icon.excel {
                background: #D1FAE5;
                color: #059669;
            }

            .grid-file-icon.image {
                background: #EDE9FE;
                color: #7C3AED;
            }

            .grid-file-icon.email {
                background: #FEF3C7;
                color: #D97706;
            }

            .file-info {
                display: flex;
                flex-direction: column;
                gap: 2px;
                min-width: 0;
            }

            .file-name {
                font-weight: 500;
                color: var(--text-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .file-meta {
                font-size: 0.75rem;
                color: var(--text-muted);
            }

            .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 10px;
                border-radius: var(--radius-full);
                font-size: 0.6875rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.02em;
            }

            .status-processed {
                background: #D1FAE5;
                color: #065F46;
            }

            .status-processing {
                background: #FEF3C7;
                color: #92400E;
            }

            .status-pending {
                background: #E0E7FF;
                color: #3730A3;
            }

            .status-error {
                background: #FEE2E2;
                color: #991B1B;
            }

            .star-btn {
                background: transparent;
                border: none;
                cursor: pointer;
                color: var(--gray-300);
                font-size: 1rem;
                padding: 4px;
                transition: all var(--duration-fast);
            }

            .star-btn:hover {
                color: var(--warning);
                transform: scale(1.15);
            }

            .star-btn.starred {
                color: var(--warning);
            }

            /* Detail Panel */
            .detail-panel {
                width: 420px;
                background: white;
                border-left: 1px solid var(--gray-200);
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
                transform: translateX(100%);
                opacity: 0;
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                z-index: 50;
                box-shadow: -8px 0 30px rgba(0, 0, 0, 0.1);
                transition: transform var(--duration-slow) var(--ease-out-expo),
                    opacity var(--duration-normal);
            }

            .detail-panel.open {
                transform: translateX(0);
                opacity: 1;
            }

            .detail-header {
                padding: 16px 20px;
                border-bottom: 1px solid var(--gray-200);
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: var(--gray-50);
            }

            .detail-header h3 {
                font-size: 0.9375rem;
                font-weight: 600;
            }

            .detail-header-actions {
                display: flex;
                gap: 8px;
            }

            .close-btn {
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: transparent;
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                color: var(--text-muted);
                transition: all var(--duration-fast);
            }

            .close-btn:hover {
                background: var(--gray-200);
                color: var(--text-primary);
            }

            .detail-body {
                flex: 1;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            /* Preview Section */
            .preview-section {
                background: var(--gray-900);
                min-height: 200px;
                max-height: 300px;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }

            .preview-section img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            .preview-section iframe {
                width: 100%;
                height: 280px;
                border: none;
            }

            .preview-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                color: var(--gray-500);
            }

            .preview-placeholder i {
                font-size: 2.5rem;
            }

            .preview-expand-btn {
                position: absolute;
                bottom: 12px;
                right: 12px;
                background: rgba(0, 0, 0, 0.6);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: var(--radius-md);
                font-size: 0.75rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                transition: all var(--duration-fast);
            }

            .preview-expand-btn:hover {
                background: rgba(0, 0, 0, 0.8);
            }

            /* Metadata Content */
            .metadata-content {
                padding: 16px 20px;
            }

            .detail-section {
                margin-bottom: 20px;
                padding-bottom: 20px;
                border-bottom: 1px solid var(--gray-100);
            }

            .detail-section:last-child {
                border-bottom: none;
            }

            .detail-section-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 12px;
            }

            .detail-section-header i {
                color: var(--vericase-teal);
                font-size: 0.875rem;
            }

            .detail-section-header h4 {
                font-size: 0.8125rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-secondary);
            }

            .detail-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .detail-item {
                display: flex;
                flex-direction: column;
                gap: 2px;
            }

            .detail-label {
                font-size: 0.6875rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-muted);
            }

            .detail-value {
                font-size: 0.875rem;
                color: var(--text-primary);
            }

            .tag-list {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }

            .tag {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 10px;
                background: var(--gray-100);
                border-radius: var(--radius-full);
                font-size: 0.75rem;
                color: var(--text-secondary);
            }

            .tag-blue {
                background: #DBEAFE;
                color: #1E40AF;
            }

            .tag-teal {
                background: rgba(23, 181, 163, 0.15);
                color: var(--vericase-teal-dark);
            }

            .tag-purple {
                background: #EDE9FE;
                color: #5B21B6;
            }

            .tag-yellow {
                background: #FEF3C7;
                color: #92400E;
            }

            /* Detail Actions */
            .detail-actions {
                padding: 16px 20px;
                border-top: 1px solid var(--gray-200);
                display: flex;
                gap: 12px;
                background: var(--gray-50);
            }

            .detail-actions .btn {
                flex: 1;
            }

            /* Full-Screen Preview Modal */
            .preview-modal {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.95);
                z-index: var(--z-modal);
                display: flex;
                flex-direction: column;
                opacity: 0;
                visibility: hidden;
                transition: opacity var(--duration-normal), visibility var(--duration-normal);
            }

            .preview-modal.active {
                opacity: 1;
                visibility: visible;
            }

            .preview-modal-header {
                padding: 16px 24px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                color: white;
            }

            .preview-modal-title {
                font-weight: 500;
                max-width: 70%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .preview-modal-actions {
                display: flex;
                gap: 8px;
            }

            .preview-modal-actions .btn {
                background: rgba(255, 255, 255, 0.1);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .preview-modal-actions .btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .preview-modal-body {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 24px;
                overflow: auto;
            }

            .preview-modal-content {
                max-width: 100%;
                max-height: 100%;
            }

            .preview-modal-content img {
                max-width: 100%;
                max-height: calc(100vh - 150px);
                object-fit: contain;
            }

            .preview-modal-content iframe {
                width: 90vw;
                height: calc(100vh - 150px);
                border: none;
                background: white;
                border-radius: var(--radius-lg);
            }

            .preview-modal-content pre {
                background: var(--gray-900);
                color: var(--gray-300);
                padding: 24px;
                border-radius: var(--radius-lg);
                max-width: 90vw;
                max-height: calc(100vh - 150px);
                overflow: auto;
                font-family: var(--font-mono);
                font-size: 0.8125rem;
                white-space: pre-wrap;
                word-break: break-word;
            }

            /* Link Cards */
            .link-card {
                background: var(--gray-50);
                border: 1px solid var(--gray-200);
                border-radius: var(--radius-md);
                padding: 12px;
                margin-bottom: 8px;
                transition: all var(--duration-fast);
            }

            .link-card:hover {
                border-color: var(--vericase-teal);
                background: white;
            }

            .link-card-title {
                font-size: 0.8125rem;
                font-weight: 500;
                color: var(--text-primary);
                margin-bottom: 4px;
            }

            .link-card-meta {
                font-size: 0.75rem;
                color: var(--text-muted);
            }

            /* GPS Link */
            .gps-map-link {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                color: var(--vericase-blue);
                text-decoration: none;
                font-size: 0.8125rem;
            }

            .gps-map-link:hover {
                text-decoration: underline;
            }

            /* Responsive */
            @media (max-width: 1200px) {
                .collections-sidebar {
                    display: none;
                }
            }

            @media (max-width: 768px) {
                .toolbar {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-container {
                    max-width: 100%;
                }

                .filter-group {
                    flex-wrap: wrap;
                }

                .detail-panel {
                    width: 100%;
                }
            }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/dist/ag-grid-community.min.js"></script>
</head>

<body class="preload">
    <!-- Category Tabs -->
    <div class="category-tabs">
        <button class="category-tab active" data-category="documents" id="tabDocuments">
            <i class="fas fa-file-alt"></i> Documents
            <span class="tab-count" id="docCount">0</span>
        </button>
        <button class="category-tab" data-category="images" id="tabImages">
            <i class="fas fa-image"></i> Images & Media
            <span class="tab-count" id="imgCount">0</span>
        </button>
        <button class="category-tab" data-category="all" id="tabAll">
            <i class="fas fa-layer-group"></i> All Files
            <span class="tab-count" id="allCount">0</span>
        </button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search evidence by name, content, or tags...">
        </div>

        <div class="filter-group">
            <select class="filter-select" id="fileTypeFilter">
                <option value="">All File Types</option>
                <option value="pdf">PDF Documents</option>
                <option value="word">Word Documents</option>
                <option value="excel">Spreadsheets</option>
                <option value="powerpoint">Presentations</option>
                <option value="text">Text Files</option>
                <option value="image">Images</option>
                <option value="other">Other</option>
            </select>

            <select class="filter-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="processed">Processed</option>
                <option value="processing">Processing</option>
                <option value="pending">Pending</option>
                <option value="error">Error</option>
            </select>

            <label class="checkbox-pill" id="unassignedPill">
                <input type="checkbox" id="unassignedFilter">
                <i class="fas fa-inbox"></i>
                Unassigned
            </label>

            <label class="checkbox-pill" id="starredPill">
                <input type="checkbox" id="starredFilter">
                <i class="fas fa-star"></i>
                Starred
            </label>
        </div>

        <div class="toolbar-spacer"></div>

        <input type="file" id="fileInput" multiple style="display: none;">
        <button class="btn btn-vericase" id="uploadBtn">
            <i class="fas fa-upload"></i>
            <span class="btn-text">Upload Evidence</span>
        </button>

        <button class="btn btn-ghost" id="refreshBtn" title="Refresh">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <i class="fas fa-archive"></i>
            <span class="stat-value" id="totalCount">—</span>
            <span>Total Items</span>
        </div>
        <div class="stat-item">
            <i class="fas fa-inbox"></i>
            <span class="stat-value" id="unassignedCount">—</span>
            <span>Unassigned</span>
        </div>
        <div class="stat-item">
            <i class="fas fa-link"></i>
            <span class="stat-value" id="linkedCount">—</span>
            <span>With Links</span>
        </div>
        <div class="stat-item">
            <i class="fas fa-clock"></i>
            <span class="stat-value" id="recentCount">—</span>
            <span>Recent (7d)</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="evidence-layout">
        <!-- Collections Sidebar -->
        <div class="collections-sidebar">
            <div class="sidebar-section-title">Collections</div>
            <div class="collection-list" id="collectionList">
                <div class="collection-item active" data-id="">
                    <i class="fas fa-folder"></i>
                    All Evidence
                </div>
            </div>
        </div>

        <!-- Grid Container -->
        <div class="grid-container">
            <div class="grid-wrapper">
                <div id="evidenceGrid" class="ag-theme-alpine ag-theme-vericase"></div>
            </div>

            <!-- Detail Panel -->
            <div class="detail-panel" id="detailPanel">
                <div class="detail-header">
                    <h3>Evidence Details</h3>
                    <div class="detail-header-actions">
                        <button class="btn btn-ghost btn-icon btn-sm" id="extractMetadataBtn" title="Extract Metadata">
                            <i class="fas fa-magic"></i>
                        </button>
                        <button class="close-btn" id="closeDetailBtn" title="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="detail-body" id="detailBody">
                    <div class="preview-section" id="previewSection">
                        <div class="preview-placeholder">
                            <i class="fas fa-file"></i>
                            <span>Select an item to preview</span>
                        </div>
                    </div>
                    <div class="metadata-content" id="metadataContent">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div class="detail-actions">
                    <button class="btn btn-vericase" id="downloadBtn">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button class="btn btn-ghost" id="previewFullBtn">
                        <i class="fas fa-expand"></i> Full Preview
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-Screen Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-modal-header">
            <div class="preview-modal-title" id="previewModalTitle">File Preview</div>
            <div class="preview-modal-actions">
                <button class="btn btn-sm" id="modalDownloadBtn">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="btn btn-sm" id="closePreviewModal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        <div class="preview-modal-body">
            <div class="preview-modal-content" id="previewModalContent">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        const apiUrl = window.VeriCaseConfig ? window.VeriCaseConfig.apiUrl : window.location.origin;

        let gridApi = null;
        let selectedEvidence = null;
        let currentPreviewData = null;
        let projectId = null;
        let caseId = null;
        let currentCategory = 'documents';
        let allEvidenceItems = [];

        // Evidence type configuration
        const typeConfig = {
            contract: { label: 'Contract', icon: 'fa-file-contract', color: '#1e40af' },
            variation: { label: 'Variation', icon: 'fa-exchange-alt', color: '#92400e' },
            drawing: { label: 'Drawing', icon: 'fa-drafting-compass', color: '#3730a3' },
            specification: { label: 'Specification', icon: 'fa-clipboard-list', color: '#166534' },
            programme: { label: 'Programme', icon: 'fa-calendar-alt', color: '#0f766e' },
            invoice: { label: 'Invoice', icon: 'fa-file-invoice-dollar', color: '#166534' },
            payment_certificate: { label: 'Payment Certificate', icon: 'fa-certificate', color: '#0f766e' },
            meeting_minutes: { label: 'Meeting Minutes', icon: 'fa-users', color: '#1e40af' },
            site_instruction: { label: 'Site Instruction', icon: 'fa-hard-hat', color: '#92400e' },
            rfi: { label: 'RFI', icon: 'fa-question-circle', color: '#6b21a8' },
            notice: { label: 'Notice', icon: 'fa-exclamation-triangle', color: '#991b1b' },
            letter: { label: 'Letter', icon: 'fa-envelope', color: '#475569' },
            email_attachment: { label: 'Email Attachment', icon: 'fa-paperclip', color: '#0369a1' },
            photo: { label: 'Photo', icon: 'fa-camera', color: '#6b21a8' },
            expert_report: { label: 'Expert Report', icon: 'fa-user-tie', color: '#1e40af' },
            pdf: { label: 'PDF', icon: 'fa-file-pdf', color: '#dc2626' },
            word_document: { label: 'Word Doc', icon: 'fa-file-word', color: '#2563eb' },
            spreadsheet: { label: 'Spreadsheet', icon: 'fa-file-excel', color: '#16a34a' },
            image: { label: 'Image', icon: 'fa-image', color: '#8b5cf6' },
            other: { label: 'Other', icon: 'fa-file', color: '#64748b' }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function getFileIcon(mimeType, evidenceType) {
            if (evidenceType && typeConfig[evidenceType]) {
                return typeConfig[evidenceType].icon;
            }
            if (mimeType) {
                if (mimeType.startsWith('image/')) return 'fa-image';
                if (mimeType === 'application/pdf') return 'fa-file-pdf';
                if (mimeType.includes('word')) return 'fa-file-word';
                if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'fa-file-excel';
                if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'fa-file-powerpoint';
                if (mimeType.startsWith('text/')) return 'fa-file-alt';
                if (mimeType.startsWith('audio/')) return 'fa-file-audio';
                if (mimeType.startsWith('video/')) return 'fa-file-video';
            }
            return 'fa-file';
        }

        function getFileIconClass(mimeType) {
            if (!mimeType) return '';
            if (mimeType === 'application/pdf') return 'pdf';
            if (mimeType.includes('word')) return 'word';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'excel';
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType.includes('outlook') || mimeType === 'message/rfc822') return 'email';
            return '';
        }

        function formatFileSize(bytes) {
            if (!bytes) return '—';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateStr) {
            if (!dateStr) return '—';
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }

        function isImageFile(mimeType, filename) {
            if (mimeType?.startsWith('image/')) return true;
            const imageExts = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.bmp', '.tiff', '.tif'];
            return imageExts.some(ext => filename?.toLowerCase().endsWith(ext));
        }

        function getFileTypeInfo(mimeType, filename) {
            const ext = filename?.split('.').pop()?.toLowerCase() || '';
            if (mimeType === 'application/pdf' || ext === 'pdf') return { label: 'PDF', class: 'pdf' };
            if (mimeType?.includes('word') || ['doc', 'docx'].includes(ext)) return { label: 'Word', class: 'word' };
            if (mimeType?.includes('excel') || mimeType?.includes('spreadsheet') || ['xls', 'xlsx', 'csv'].includes(ext)) return { label: 'Excel', class: 'excel' };
            if (mimeType?.includes('powerpoint') || mimeType?.includes('presentation') || ['ppt', 'pptx'].includes(ext)) return { label: 'PPT', class: 'ppt' };
            if (mimeType?.startsWith('text/') || ['txt', 'log', 'md'].includes(ext)) return { label: 'Text', class: 'text' };
            if (mimeType?.startsWith('image/')) return { label: 'Image', class: 'image' };
            return { label: ext.toUpperCase() || 'File', class: '' };
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // GRID SETUP
        // ============================================

        function initGrid() {
            const gridOptions = {
                columnDefs: [
                    {
                        field: 'thumbnail',
                        headerName: '',
                        width: 60,
                        sortable: false,
                        filter: false,
                        cellRenderer: params => {
                            const icon = getFileIcon(params.data.mime_type, params.data.evidence_type);
                            const iconClass = getFileIconClass(params.data.mime_type);
                            if (params.data.mime_type?.startsWith('image/') && params.data.download_url) {
                                return `<img src="${params.data.download_url}" class="grid-thumbnail" alt="" loading="lazy">`;
                            }
                            return `<div class="grid-file-icon ${iconClass}"><i class="fas ${icon}"></i></div>`;
                        }
                    },
                    {
                        field: 'filename',
                        headerName: 'Name',
                        flex: 2,
                        minWidth: 200,
                        cellRenderer: params => {
                            const typeInfo = getFileTypeInfo(params.data.mime_type, params.data.filename);
                            return `
                                <div class="file-info">
                                    <span class="file-name">${escapeHtml(params.data.title || params.data.filename)}</span>
                                    <span class="file-meta">${typeInfo.label} • ${formatFileSize(params.data.file_size)}</span>
                                </div>
                            `;
                        }
                    },
                    {
                        field: 'document_date',
                        headerName: 'Date',
                        width: 120,
                        valueFormatter: params => formatDate(params.value)
                    },
                    {
                        field: 'processing_status',
                        headerName: 'Status',
                        width: 120,
                        cellRenderer: params => {
                            const status = params.value || 'pending';
                            return `<span class="status-badge status-${status}">${status}</span>`;
                        }
                    },
                    {
                        field: 'evidence_type',
                        headerName: 'AI Classification',
                        width: 140,
                        cellRenderer: params => {
                            const type = params.value;
                            if (!type || type === 'other') return '<span style="color: var(--text-muted);">—</span>';
                            const config = typeConfig[type] || { label: type, color: '#64748b' };
                            return `<span style="color: ${config.color}; font-weight: 500;"><i class="fas ${config.icon || 'fa-file'}"></i> ${config.label}</span>`;
                        }
                    },
                    {
                        field: 'classification_confidence',
                        headerName: 'AI Confidence',
                        width: 120,
                        cellRenderer: params => {
                            const confidence = params.value;
                            if (!confidence) return '<span style="color: var(--text-muted);">—</span>';
                            const color = confidence >= 80 ? '#16a34a' : confidence >= 60 ? '#d97706' : '#dc2626';
                            return `<span style="color: ${color}; font-weight: 500;">${confidence}%</span>`;
                        }
                    },
                    {
                        field: 'extracted_parties',
                        headerName: 'Extracted Parties',
                        width: 160,
                        cellRenderer: params => {
                            const parties = params.value;
                            if (!parties || parties.length === 0) return '<span style="color: var(--text-muted);">—</span>';
                            const display = parties.slice(0, 2).join(', ');
                            const extra = parties.length > 2 ? ` +${parties.length - 2}` : '';
                            return `<span style="color: var(--vericase-teal); font-size: 0.75rem;">${display}${extra}</span>`;
                        }
                    },
                    {
                        field: 'extracted_amounts',
                        headerName: 'Key Amounts',
                        width: 120,
                        cellRenderer: params => {
                            const amounts = params.value;
                            if (!amounts || amounts.length === 0) return '<span style="color: var(--text-muted);">—</span>';
                            const display = amounts[0];
                            const extra = amounts.length > 1 ? ` +${amounts.length - 1}` : '';
                            return `<span style="color: #16a34a; font-weight: 500; font-size: 0.75rem;">${display}${extra}</span>`;
                        }
                    },
                    {
                        field: 'correspondence_count',
                        headerName: 'Links',
                        width: 80,
                        cellRenderer: params => {
                            const count = params.value || 0;
                            if (count > 0) {
                                return `<span style="color: var(--vericase-teal);"><i class="fas fa-link"></i> ${count}</span>`;
                            }
                            return `<span style="color: var(--text-muted);">—</span>`;
                        }
                    },
                    {
                        field: 'is_starred',
                        headerName: '',
                        width: 50,
                        sortable: false,
                        filter: false,
                        cellRenderer: params => {
                            const starred = params.value;
                            return `<button class="star-btn ${starred ? 'starred' : ''}" onclick="event.stopPropagation(); toggleStar('${params.data.id}')">
                                <i class="fas fa-star"></i>
                            </button>`;
                        }
                    }
                ],
                defaultColDef: {
                    sortable: true,
                    filter: true,
                    resizable: true
                },
                rowSelection: 'single',
                animateRows: true,
                rowHeight: 56,
                headerHeight: 44,
                onRowClicked: params => showDetail(params.data),
                onGridReady: params => {
                    loadAllData();
                }
            };

            const gridDiv = document.getElementById('evidenceGrid');
            // Use createGrid API (v31+) instead of deprecated new Grid()
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
        }

        // ============================================
        // DATA LOADING (with prefetch support)
        // ============================================

        // Check for prefetched data from master dashboard
        function getPrefetchedData() {
            try {
                const cached = sessionStorage.getItem('vericase_evidence_prefetch');
                if (cached) {
                    const data = JSON.parse(cached);
                    // Only use if cached within last 5 minutes
                    const MAX_AGE = 5 * 60 * 1000;
                    if (Date.now() - data.timestamp < MAX_AGE) {
                        console.log('[Evidence] Using prefetched data from dashboard');
                        return data;
                    }
                    // Clear stale cache
                    sessionStorage.removeItem('vericase_evidence_prefetch');
                }
            } catch (e) {
                console.warn('[Evidence] Prefetch cache read failed:', e);
            }
            return null;
        }

        async function loadAllData() {
            const prefetched = getPrefetchedData();

            if (prefetched) {
                // Use prefetched data - instant render!
                console.log('[Evidence] Rendering from prefetched cache...');
                const startTime = performance.now();

                allEvidenceItems = prefetched.items;

                // Render grid immediately
                document.querySelector('.grid-wrapper').innerHTML = '<div id="evidenceGrid" class="ag-theme-alpine ag-theme-vericase" style="height: 100%;"></div>';
                initGrid();
                updateCategoryCounts();
                applyFilters();

                // Render collections and stats
                if (prefetched.collections) {
                    renderCollections(prefetched.collections);
                }
                if (prefetched.stats) {
                    renderStats(prefetched.stats);
                }

                const duration = (performance.now() - startTime).toFixed(0);
                VericaseUI.Toast.success(`Loaded ${allEvidenceItems.length} items instantly (cached) in ${duration}ms`);

                // Clear used cache
                sessionStorage.removeItem('vericase_evidence_prefetch');

                // Background refresh to get fresh data
                setTimeout(() => refreshDataInBackground(), 1000);
            } else {
                // Normal loading with skeletons
                VericaseUI.Loading.showSkeleton('.grid-wrapper');

                await Promise.all([
                    loadEvidence(),
                    loadCollections(),
                    loadStats()
                ]);
            }
        }

        // Silent background refresh
        async function refreshDataInBackground() {
            try {
                console.log('[Evidence] Background refresh starting...');
                const params = new URLSearchParams();
                params.append('page', '1');
                params.append('page_size', '10000');
                params.append('include_email_info', 'true');
                if (projectId) params.append('project_id', projectId);

                const response = await fetch(`${apiUrl}/api/evidence/items?${params.toString()}`);
                if (response.ok) {
                    const data = await response.json();
                    const newItems = data.items || [];

                    // Only update if there's a difference
                    if (newItems.length !== allEvidenceItems.length) {
                        allEvidenceItems = newItems;
                        updateCategoryCounts();
                        applyFilters();
                        console.log('[Evidence] Background refresh complete - data updated');
                    } else {
                        console.log('[Evidence] Background refresh complete - no changes');
                    }
                }
            } catch (e) {
                console.warn('[Evidence] Background refresh failed:', e);
            }
        }

        async function loadEvidence() {
            try {
                const params = new URLSearchParams();
                params.append('page', '1');
                params.append('page_size', '10000');  // Load ALL evidence items
                params.append('include_email_info', 'true');

                // Include project_id if we have one
                if (projectId) params.append('project_id', projectId);

                const activeCollection = document.querySelector('.collection-item.active');
                const collectionId = activeCollection?.dataset.id;
                if (collectionId) params.append('collection_id', collectionId);

                const response = await fetch(`${apiUrl}/api/evidence/items?${params.toString()}`);

                if (response.ok) {
                    const data = await response.json();
                    allEvidenceItems = data.items || [];

                    // Restore grid
                    document.querySelector('.grid-wrapper').innerHTML = '<div id="evidenceGrid" class="ag-theme-alpine ag-theme-vericase" style="height: 100%;"></div>';
                    initGrid();

                    updateCategoryCounts();
                    applyFilters();

                    VericaseUI.Toast.success(`Loaded ${allEvidenceItems.length} evidence items`);
                } else {
                    throw new Error('Failed to load evidence');
                }
            } catch (error) {
                console.error('Error loading evidence:', error);
                VericaseUI.Toast.error('Failed to load evidence');
                allEvidenceItems = [];
                if (gridApi) gridApi.setGridOption('rowData', []);
            }
        }

        function updateCategoryCounts() {
            let docCount = 0;
            let imgCount = 0;

            allEvidenceItems.forEach(item => {
                if (isImageFile(item.mime_type, item.filename)) {
                    imgCount++;
                } else {
                    docCount++;
                }
            });

            document.getElementById('docCount').textContent = docCount.toLocaleString();
            document.getElementById('imgCount').textContent = imgCount.toLocaleString();
            document.getElementById('allCount').textContent = allEvidenceItems.length.toLocaleString();
        }

        function applyFilters() {
            if (!gridApi) return;

            let filtered = [...allEvidenceItems];

            // Category filter
            if (currentCategory === 'documents') {
                filtered = filtered.filter(item => !isImageFile(item.mime_type, item.filename));
            } else if (currentCategory === 'images') {
                filtered = filtered.filter(item => isImageFile(item.mime_type, item.filename));
            }

            // Search filter
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            if (search) {
                filtered = filtered.filter(item => {
                    const filename = (item.filename || '').toLowerCase();
                    const title = (item.title || '').toLowerCase();
                    const subject = (item.source_email_subject || '').toLowerCase();
                    const from = (item.source_email_from || '').toLowerCase();
                    return filename.includes(search) || title.includes(search) ||
                        subject.includes(search) || from.includes(search);
                });
            }

            // File type filter
            const fileType = document.getElementById('fileTypeFilter').value;
            if (fileType) {
                filtered = filtered.filter(item => {
                    const typeInfo = getFileTypeInfo(item.mime_type, item.filename);
                    const label = typeInfo.label.toLowerCase();
                    switch (fileType) {
                        case 'pdf': return label === 'pdf';
                        case 'word': return label === 'word';
                        case 'excel': return label === 'excel' || item.mime_type?.includes('spreadsheet');
                        case 'powerpoint': return label === 'ppt';
                        case 'text': return label === 'text' || item.mime_type?.startsWith('text/');
                        case 'image': return isImageFile(item.mime_type, item.filename);
                        case 'other': return !['pdf', 'word', 'excel', 'ppt', 'text', 'image'].includes(label.toLowerCase());
                        default: return true;
                    }
                });
            }

            // Status filter
            const status = document.getElementById('statusFilter').value;
            if (status) {
                filtered = filtered.filter(item => item.processing_status === status);
            }

            // Unassigned filter
            if (document.getElementById('unassignedFilter').checked) {
                filtered = filtered.filter(item => !item.case_id && !item.project_id);
            }

            // Starred filter
            if (document.getElementById('starredFilter').checked) {
                filtered = filtered.filter(item => item.is_starred);
            }

            gridApi.setGridOption('rowData', filtered);
        }

        // Render collections data (can be called with fetched or prefetched data)
        function renderCollections(collections) {
            const list = document.getElementById('collectionList');
            const collectionArray = Array.isArray(collections) ? collections : (collections.collections || []);

            let html = `
                <div class="collection-item active" data-id="">
                    <i class="fas fa-folder"></i>
                    All Evidence
                </div>
            `;

            collectionArray.forEach(c => {
                const icon = c.is_system ? 'fa-folder-open' : 'fa-folder';
                html += `
                    <div class="collection-item" data-id="${c.id}">
                        <i class="fas ${icon}"></i>
                        ${escapeHtml(c.name)}
                        <span class="collection-count">${c.item_count || 0}</span>
                    </div>
                `;
            });

            list.innerHTML = html;

            // Re-attach click handlers
            list.querySelectorAll('.collection-item').forEach(item => {
                item.addEventListener('click', () => {
                    list.querySelectorAll('.collection-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    loadEvidence();
                });
            });
        }

        async function loadCollections() {
            try {
                const response = await fetch(`${apiUrl}/api/evidence/collections?include_system=true`);
                if (response.ok) {
                    const collections = await response.json();
                    renderCollections(collections);
                }
            } catch (error) {
                console.error('Error loading collections:', error);
            }
        }

        // Render stats data (can be called with fetched or prefetched data)
        function renderStats(stats) {
            document.getElementById('totalCount').textContent = (stats.total || 0).toLocaleString();
            document.getElementById('unassignedCount').textContent = (stats.unassigned || 0).toLocaleString();
            document.getElementById('linkedCount').textContent = (stats.with_correspondence || 0).toLocaleString();
            document.getElementById('recentCount').textContent = (stats.recent_uploads || 0).toLocaleString();
        }

        async function loadStats() {
            try {
                const response = await fetch(`${apiUrl}/api/evidence/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    renderStats(stats);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ============================================
        // DETAIL PANEL
        // ============================================

        async function showDetail(evidence) {
            if (!evidence) return;

            const panel = document.getElementById('detailPanel');
            panel.classList.add('open');

            // Show loading state
            document.getElementById('previewSection').innerHTML = `
                <div class="preview-placeholder">
                    <div class="loading" style="width: 32px; height: 32px; border-width: 3px;"></div>
                    <span>Loading preview...</span>
                </div>
            `;

            try {
                const [detailRes, previewRes, metadataRes] = await Promise.all([
                    fetch(`${apiUrl}/api/evidence/items/${evidence.id}`),
                    fetch(`${apiUrl}/api/evidence/items/${evidence.id}/preview`),
                    fetch(`${apiUrl}/api/evidence/items/${evidence.id}/metadata`)
                ]);

                if (detailRes.ok) {
                    const detail = await detailRes.json();
                    const preview = previewRes.ok ? await previewRes.json() : null;
                    const metadata = metadataRes.ok ? await metadataRes.json() : null;

                    selectedEvidence = detail;
                    currentPreviewData = preview;

                    renderPreview(preview, detail);
                    renderMetadata(detail, metadata?.metadata);
                }
            } catch (error) {
                console.error('Error loading detail:', error);
                VericaseUI.Toast.error('Failed to load evidence details');
            }
        }

        function renderPreview(preview, detail) {
            const section = document.getElementById('previewSection');

            if (!preview) {
                section.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas ${getFileIcon(detail.mime_type, detail.evidence_type)}"></i>
                        <span>Preview not available</span>
                    </div>
                `;
                return;
            }

            let html = '';

            switch (preview.preview_type) {
                case 'image':
                    html = `
                        <img src="${preview.preview_url}" alt="${detail.filename}">
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Expand
                        </button>
                    `;
                    break;

                case 'pdf':
                    html = `
                        <iframe src="${preview.preview_url}#toolbar=0"></iframe>
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Expand
                        </button>
                    `;
                    break;

                case 'text':
                case 'office':
                    const content = preview.preview_content || 'No content available';
                    const contentStr = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
                    const truncated = contentStr.length > 1000 ? contentStr.substring(0, 1000) + '\n...' : contentStr;
                    html = `
                        <pre style="color: var(--gray-400); font-size: 0.75rem; padding: 16px; margin: 0; overflow: auto; max-height: 100%;">${escapeHtml(truncated)}</pre>
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Full Text
                        </button>
                    `;
                    break;

                default:
                    html = `
                        <div class="preview-placeholder">
                            <i class="fas ${getFileIcon(detail.mime_type, detail.evidence_type)}"></i>
                            <span>${detail.filename}</span>
                        </div>
                    `;
            }

            section.innerHTML = html;
        }

        function renderMetadata(detail, extractedMeta) {
            const content = document.getElementById('metadataContent');
            const meta = extractedMeta || detail.extracted_metadata || {};

            let html = '';

            // Basic Info
            html += `
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-info-circle"></i>
                        <h4>Basic Information</h4>
                    </div>
                    <div class="detail-item" style="margin-bottom: 12px;">
                        <div class="detail-label">Filename</div>
                        <div class="detail-value" style="word-break: break-all;">${escapeHtml(detail.filename)}</div>
                    </div>
                    ${detail.title && detail.title !== detail.filename ? `
                        <div class="detail-item" style="margin-bottom: 12px;">
                            <div class="detail-label">Title</div>
                            <div class="detail-value">${escapeHtml(detail.title)}</div>
                        </div>
                    ` : ''}
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Type</div>
                            <div class="detail-value">${typeConfig[detail.evidence_type]?.label || detail.evidence_type || 'Unknown'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Size</div>
                            <div class="detail-value">${formatFileSize(detail.file_size)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge status-${detail.processing_status || 'pending'}">${detail.processing_status || 'pending'}</span>
                            </div>
                        </div>
                        ${detail.document_date ? `
                            <div class="detail-item">
                                <div class="detail-label">Document Date</div>
                                <div class="detail-value">${formatDate(detail.document_date)}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Document Properties
            if (meta.author || meta.created_date || meta.page_count) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-file-alt"></i>
                            <h4>Document Properties</h4>
                        </div>
                        <div class="detail-grid">
                            ${meta.author || detail.author ? `
                                <div class="detail-item">
                                    <div class="detail-label">Author</div>
                                    <div class="detail-value">${escapeHtml(meta.author || detail.author)}</div>
                                </div>
                            ` : ''}
                            ${meta.page_count || detail.page_count ? `
                                <div class="detail-item">
                                    <div class="detail-label">Pages</div>
                                    <div class="detail-value">${meta.page_count || detail.page_count}</div>
                                </div>
                            ` : ''}
                            ${meta.created_date ? `
                                <div class="detail-item">
                                    <div class="detail-label">Created</div>
                                    <div class="detail-value">${formatDate(meta.created_date)}</div>
                                </div>
                            ` : ''}
                            ${meta.modified_date ? `
                                <div class="detail-item">
                                    <div class="detail-label">Modified</div>
                                    <div class="detail-value">${formatDate(meta.modified_date)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Image EXIF
            if (meta.width || meta.camera_make || meta.date_taken) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-camera"></i>
                            <h4>Image Information</h4>
                        </div>
                        <div class="detail-grid">
                            ${meta.width && meta.height ? `
                                <div class="detail-item">
                                    <div class="detail-label">Dimensions</div>
                                    <div class="detail-value">${meta.width} × ${meta.height} px</div>
                                </div>
                            ` : ''}
                            ${meta.camera_make ? `
                                <div class="detail-item">
                                    <div class="detail-label">Camera</div>
                                    <div class="detail-value">${escapeHtml(meta.camera_make)} ${escapeHtml(meta.camera_model || '')}</div>
                                </div>
                            ` : ''}
                            ${meta.date_taken ? `
                                <div class="detail-item">
                                    <div class="detail-label">Date Taken</div>
                                    <div class="detail-value">${formatDate(meta.date_taken)}</div>
                                </div>
                            ` : ''}
                        </div>
                        ${meta.gps_latitude && meta.gps_longitude ? `
                            <div class="detail-item" style="margin-top: 12px;">
                                <div class="detail-label">Location</div>
                                <a href="https://www.google.com/maps?q=${meta.gps_latitude},${meta.gps_longitude}" target="_blank" class="gps-map-link">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${meta.gps_latitude.toFixed(6)}, ${meta.gps_longitude.toFixed(6)}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.6rem;"></i>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Tags
            if ((detail.auto_tags?.length > 0 || detail.manual_tags?.length > 0)) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-tags"></i>
                            <h4>Tags</h4>
                        </div>
                        <div class="tag-list">
                            ${(detail.manual_tags || []).map(t => `<span class="tag tag-teal">${escapeHtml(t)}</span>`).join('')}
                            ${(detail.auto_tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Linked Correspondence
            if (detail.correspondence_links?.length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-envelope"></i>
                            <h4>Linked Correspondence (${detail.correspondence_links.length})</h4>
                        </div>
                        ${detail.correspondence_links.map(link => `
                            <div class="link-card">
                                ${link.email ? `
                                    <div class="link-card-title">${escapeHtml(link.email.subject || 'No subject')}</div>
                                    <div class="link-card-meta">${escapeHtml(link.email.sender || '')} • ${formatDate(link.email.date)}</div>
                                ` : ''}
                                <div class="link-card-meta">${link.link_type} • ${link.link_confidence ? link.link_confidence + '% confidence' : 'Manual link'}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Forensic Data
            if (detail.file_hash) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-fingerprint"></i>
                            <h4>Forensic Data</h4>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">SHA-256 Hash</div>
                            <div class="detail-value" style="font-family: var(--font-mono); font-size: 0.625rem; word-break: break-all;">${detail.file_hash}</div>
                        </div>
                        <div class="detail-item" style="margin-top: 8px;">
                            <div class="detail-label">Uploaded</div>
                            <div class="detail-value">${formatDate(detail.created_at)}</div>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
        }

        function hideDetail() {
            document.getElementById('detailPanel').classList.remove('open');
            selectedEvidence = null;
            currentPreviewData = null;
        }

        // ============================================
        // ACTIONS
        // ============================================

        async function toggleStar(evidenceId) {
            try {
                const response = await fetch(`${apiUrl}/api/evidence/items/${evidenceId}/star`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    // Update local data
                    const item = allEvidenceItems.find(i => i.id === evidenceId);
                    if (item) {
                        item.is_starred = result.is_starred;
                        applyFilters();
                    }
                    VericaseUI.Toast.success(result.is_starred ? 'Added to starred' : 'Removed from starred');
                }
            } catch (error) {
                console.error('Error toggling star:', error);
                VericaseUI.Toast.error('Failed to update star status');
            }
        }

        function downloadCurrentFile() {
            if (currentPreviewData?.download_url) {
                window.open(currentPreviewData.download_url, '_blank');
            } else if (selectedEvidence?.download_url) {
                window.open(selectedEvidence.download_url, '_blank');
            }
        }

        async function openFullPreview() {
            if (!selectedEvidence || !currentPreviewData) return;

            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewModalContent');
            const title = document.getElementById('previewModalTitle');

            title.textContent = selectedEvidence.filename;

            let html = '';

            switch (currentPreviewData.preview_type) {
                case 'image':
                    html = `<img src="${currentPreviewData.preview_url}" alt="${selectedEvidence.filename}">`;
                    break;

                case 'pdf':
                    html = `<iframe src="${currentPreviewData.preview_url}"></iframe>`;
                    break;

                case 'text':
                case 'office':
                    try {
                        const response = await fetch(`${apiUrl}/api/evidence/items/${selectedEvidence.id}/text-content?max_length=100000`);
                        if (response.ok) {
                            const data = await response.json();
                            html = `<pre>${escapeHtml(data.text)}</pre>`;
                        } else {
                            html = `<pre>${escapeHtml(currentPreviewData.preview_content || 'Could not load text content')}</pre>`;
                        }
                    } catch {
                        html = `<pre>${escapeHtml(currentPreviewData.preview_content || 'Could not load text content')}</pre>`;
                    }
                    break;

                default:
                    html = `
                        <div style="text-align: center; color: var(--gray-400);">
                            <i class="fas ${getFileIcon(selectedEvidence.mime_type, selectedEvidence.evidence_type)}" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                            <p>Preview not available for this file type</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">${escapeHtml(selectedEvidence.filename)}</p>
                            <button class="btn btn-vericase" style="margin-top: 1rem;" onclick="downloadCurrentFile()">
                                <i class="fas fa-download"></i> Download File
                            </button>
                        </div>
                    `;
            }

            content.innerHTML = html;
            modal.classList.add('active');
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('active');
        }

        async function extractMetadata() {
            if (!selectedEvidence) return;

            const btn = document.getElementById('extractMetadataBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`${apiUrl}/api/evidence/items/${selectedEvidence.id}/extract-metadata`, {
                    method: 'POST'
                });

                if (response.ok) {
                    await showDetail(selectedEvidence);
                    VericaseUI.Toast.success('Metadata extracted successfully');
                } else {
                    VericaseUI.Toast.error('Failed to extract metadata');
                }
            } catch (error) {
                console.error('Error extracting metadata:', error);
                VericaseUI.Toast.error('Failed to extract metadata');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i>';
            }
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.classList.add('loading');

            const toast = VericaseUI.Toast.info(`Uploading ${files.length} file(s)...`, { duration: 0 });

            try {
                let successCount = 0;
                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    if (projectId) formData.append('project_id', projectId);
                    if (caseId) formData.append('case_id', caseId);

                    const response = await fetch(`${apiUrl}/api/evidence/upload/direct`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) successCount++;
                }

                VericaseUI.Toast.dismiss(toast);
                VericaseUI.Toast.success(`Successfully uploaded ${successCount} file(s)`);

                loadEvidence();
                loadStats();
            } catch (error) {
                console.error('Upload error:', error);
                VericaseUI.Toast.dismiss(toast);
                VericaseUI.Toast.error('Upload failed. Please try again.');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.classList.remove('loading');
                document.getElementById('fileInput').value = '';
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            // Inject navigation shell
            VericaseShell.inject({
                title: 'Evidence Repository',
                headerActions: ''
            });

            // Get project context
            projectId = VericaseShell.getProjectId();

            // Initialize grid
            initGrid();

            // Category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    applyFilters();
                });
            });

            // Search with debounce
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFilters, 300);
            });

            // Filters
            document.getElementById('fileTypeFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);

            // Checkbox pills
            document.getElementById('unassignedFilter').addEventListener('change', (e) => {
                document.getElementById('unassignedPill').classList.toggle('active', e.target.checked);
                applyFilters();
            });

            document.getElementById('starredFilter').addEventListener('change', (e) => {
                document.getElementById('starredPill').classList.toggle('active', e.target.checked);
                applyFilters();
            });

            // Upload
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);

            // Refresh
            document.getElementById('refreshBtn').addEventListener('click', () => {
                VericaseUI.Toast.info('Refreshing...');
                loadAllData();
            });
            if (!selectedEvidence) return;

            const btn = document.getElementById('extractMetadataBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`${apiUrl}/api/evidence/items/${selectedEvidence.id}/extract-metadata`, {
                    method: 'POST'
                });

                if (response.ok) {
                    await showDetail(selectedEvidence);
                    VericaseUI.Toast.success('Metadata extracted successfully');
                } else {
                    VericaseUI.Toast.error('Failed to extract metadata');
                }
            } catch (error) {
                console.error('Error extracting metadata:', error);
                VericaseUI.Toast.error('Failed to extract metadata');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i>';
            }
        }

        async function handleFileUpload(event) {
                const files = event.target.files;
                if (!files || files.length === 0) return;

                const uploadBtn = document.getElementById('uploadBtn');
                uploadBtn.disabled = true;
                uploadBtn.classList.add('loading');

                const toast = VericaseUI.Toast.info(`Uploading ${files.length} file(s)...`, { duration: 0 });

                try {
                    let successCount = 0;
                    for (const file of files) {
                        const formData = new FormData();
                        formData.append('file', file);
                        if (projectId) formData.append('project_id', projectId);
                        if (caseId) formData.append('case_id', caseId);

                        const response = await fetch(`${apiUrl}/api/evidence/upload/direct`, {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) successCount++;
                    }

                    VericaseUI.Toast.dismiss(toast);
                    VericaseUI.Toast.success(`Successfully uploaded ${successCount} file(s)`);

                    loadEvidence();
                    loadStats();
                } catch (error) {
                    console.error('Upload error:', error);
                    VericaseUI.Toast.dismiss(toast);
                    VericaseUI.Toast.error('Upload failed. Please try again.');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.classList.remove('loading');
                    document.getElementById('fileInput').value = '';
                }
            }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
                // Inject navigation shell
                VericaseShell.inject({
                    title: 'Evidence Repository',
                    headerActions: ''
                });

                // Get project context
                projectId = VericaseShell.getProjectId();

                // Initialize grid
                initGrid();

                // Category tabs
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        currentCategory = tab.dataset.category;
                        applyFilters();
                    });
                });

                // Search with debounce
                let searchTimeout;
                document.getElementById('searchInput').addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyFilters, 300);
                });

                // Filters
                document.getElementById('fileTypeFilter').addEventListener('change', applyFilters);
                document.getElementById('statusFilter').addEventListener('change', applyFilters);

                // Checkbox pills
                document.getElementById('unassignedFilter').addEventListener('change', (e) => {
                    document.getElementById('unassignedPill').classList.toggle('active', e.target.checked);
                    applyFilters();
                });

                document.getElementById('starredFilter').addEventListener('change', (e) => {
                    document.getElementById('starredPill').classList.toggle('active', e.target.checked);
                    applyFilters();
                });

                // Upload
                document.getElementById('uploadBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
                document.getElementById('fileInput').addEventListener('change', handleFileUpload);

                // Refresh
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    VericaseUI.Toast.info('Refreshing...');
                    loadAllData();
                });

                // Detail panel
                document.getElementById('closeDetailBtn').addEventListener('click', hideDetail);
                document.getElementById('downloadBtn').addEventListener('click', downloadCurrentFile);
                document.getElementById('previewFullBtn').addEventListener('click', openFullPreview);
                document.getElementById('extractMetadataBtn').addEventListener('click', extractMetadata);

                // Preview modal
                document.getElementById('closePreviewModal').addEventListener('click', closePreviewModal);
                document.getElementById('modalDownloadBtn').addEventListener('click', downloadCurrentFile);
                document.getElementById('previewModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('previewModal')) {
                        closePreviewModal();
                    }
                });

                // Escape key to close panels
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        hideDetail();
                        closePreviewModal();
                    }
                });

                // Remove preload class after initial render
                requestAnimationFrame(() => {
                    document.body.classList.remove('preload');
                });
            });
    </script>
</body>

</html>
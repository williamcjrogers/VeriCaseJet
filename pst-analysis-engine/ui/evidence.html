<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriCase - Evidence Repository</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/styles/ag-theme-alpine.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="config.js"></script>
    <script src="app-state.js"></script>
    <style>
        :root {
            --vericase-teal: #17B5A3;
            --vericase-teal-dark: #129B8B;
            --vericase-navy: #1F2937;
            --bg-primary: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--vericase-navy);
            -webkit-font-smoothing: antialiased;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            color: var(--vericase-teal);
            font-weight: 700;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--vericase-teal);
            color: white;
        }

        .btn-primary:hover {
            background: var(--vericase-teal-dark);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-ghost {
            background: transparent;
            color: #64748b;
        }

        .btn-ghost:hover {
            background: #f1f5f9;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .toolbar {
            padding: 0.75rem 1.5rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            width: 300px;
            font-size: 0.875rem;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--vericase-teal);
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: #475569;
        }

        .spacer {
            flex: 1;
        }

        .stats-bar {
            padding: 0.5rem 1.5rem;
            background: #f1f5f9;
            display: flex;
            gap: 2rem;
            font-size: 0.75rem;
            color: #64748b;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-value {
            font-weight: 600;
            color: #1e293b;
        }

        .main-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: #1e293b;
            border-bottom: 1px solid #e2e8f0;
        }

        .collection-list {
            flex: 1;
            overflow: auto;
            padding: 0.5rem;
        }

        .collection-item {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #475569;
            transition: all 0.15s;
        }

        .collection-item:hover {
            background: #f1f5f9;
        }

        .collection-item.active {
            background: #e0f2fe;
            color: #0369a1;
        }

        .collection-count {
            margin-left: auto;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .grid-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Enhanced Detail Panel */
        .detail-panel {
            width: 480px;
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .detail-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .detail-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .detail-header-actions {
            display: flex;
            gap: 0.25rem;
        }

        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            color: #64748b;
            padding: 0.25rem;
        }

        .close-btn:hover {
            color: #1e293b;
        }

        .detail-body {
            flex: 1;
            overflow: auto;
            padding: 0;
        }

        /* Preview Section */
        .preview-section {
            background: #1e293b;
            padding: 1rem;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: #94a3b8;
        }

        .preview-placeholder i {
            font-size: 3rem;
            opacity: 0.5;
        }

        .preview-placeholder span {
            font-size: 0.75rem;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 0.25rem;
        }

        .preview-pdf {
            width: 100%;
            height: 300px;
            border: none;
            border-radius: 0.25rem;
            background: white;
        }

        .preview-text {
            background: #0f172a;
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 280px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
            width: 100%;
        }

        .preview-expand-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .preview-expand-btn:hover {
            background: rgba(0,0,0,0.7);
        }

        /* Metadata Sections */
        .metadata-content {
            padding: 1rem;
        }

        .detail-section {
            margin-bottom: 1.25rem;
        }

        .detail-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .detail-section-header i {
            color: var(--vericase-teal);
        }

        .detail-section-header h4 {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #374151;
        }

        .detail-label {
            font-size: 0.6875rem;
            color: #64748b;
            margin-bottom: 0.125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            font-size: 0.8125rem;
            color: #1e293b;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .detail-item {
            margin-bottom: 0.5rem;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
        }

        .tag {
            padding: 0.125rem 0.5rem;
            background: #e2e8f0;
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            color: #475569;
        }

        .tag-blue {
            background: #dbeafe;
            color: #1e40af;
        }

        .tag-teal {
            background: #ccfbf1;
            color: #0f766e;
        }

        .tag-yellow {
            background: #fef3c7;
            color: #92400e;
        }

        .tag-purple {
            background: #f3e8ff;
            color: #6b21a8;
        }

        /* Metadata Pills */
        .metadata-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #f1f5f9;
            border-radius: 1rem;
            font-size: 0.75rem;
            color: #475569;
        }

        .metadata-pill i {
            font-size: 0.625rem;
        }

        /* Link Cards */
        .link-card {
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 0.8125rem;
            border: 1px solid #e2e8f0;
        }

        .link-card:hover {
            background: #f1f5f9;
        }

        .link-card-title {
            font-weight: 500;
            color: #0f172a;
        }

        .link-card-meta {
            color: #64748b;
            font-size: 0.75rem;
        }

        /* Action Buttons in Detail */
        .detail-actions {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.5rem;
        }

        .detail-actions .btn {
            flex: 1;
            justify-content: center;
        }

        /* Full-Screen Preview Modal */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }

        .preview-modal.active {
            display: flex;
        }

        .preview-modal-header {
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
        }

        .preview-modal-title {
            font-weight: 500;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-modal-actions {
            display: flex;
            gap: 0.5rem;
        }

        .preview-modal-actions .btn {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .preview-modal-actions .btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .preview-modal-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow: auto;
        }

        .preview-modal-content {
            max-width: 100%;
            max-height: 100%;
        }

        .preview-modal-content img {
            max-width: 100%;
            max-height: calc(100vh - 150px);
            object-fit: contain;
        }

        .preview-modal-content iframe {
            width: 90vw;
            height: calc(100vh - 150px);
            border: none;
            background: white;
            border-radius: 0.5rem;
        }

        .preview-modal-content pre {
            background: #0f172a;
            color: #e2e8f0;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90vw;
            max-height: calc(100vh - 150px);
            overflow: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Loading States */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* AG Grid theme customization */
        .ag-theme-alpine {
            --ag-header-background-color: #f8fafc;
            --ag-odd-row-background-color: #ffffff;
            --ag-row-hover-color: #f0fdfa;
            --ag-selected-row-background-color: #e0f2fe;
        }

        /* Thumbnail in grid */
        .grid-thumbnail {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 0.25rem;
            background: #f1f5f9;
        }

        .grid-thumbnail-placeholder {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border-radius: 0.25rem;
            color: #64748b;
            font-size: 0.875rem;
        }

        /* EXIF/GPS Section */
        .gps-map-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            color: #0369a1;
            text-decoration: none;
            font-size: 0.75rem;
        }

        .gps-map-link:hover {
            text-decoration: underline;
        }

        /* Status badges */
        .status-badge {
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            font-weight: 500;
        }

        .status-ready {
            background: #dcfce7;
            color: #166534;
        }

        .status-processing {
            background: #fef3c7;
            color: #92400e;
        }

        .status-pending {
            background: #e0e7ff;
            color: #3730a3;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 0;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 1.5rem;
        }

        .category-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .category-tab:hover {
            color: #1e293b;
            background: #f8fafc;
        }

        .category-tab.active {
            color: var(--vericase-teal);
            border-bottom-color: var(--vericase-teal);
            background: #f0fdfa;
        }

        .category-tab i {
            font-size: 1rem;
        }

        .tab-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.5rem;
            height: 1.25rem;
            padding: 0 0.375rem;
            background: #e2e8f0;
            border-radius: 0.625rem;
            font-size: 0.6875rem;
            font-weight: 600;
        }

        .category-tab.active .tab-count {
            background: var(--vericase-teal);
            color: white;
        }

        /* File type icon colors */
        .file-icon-pdf { color: #dc2626; }
        .file-icon-word { color: #2563eb; }
        .file-icon-excel { color: #16a34a; }
        .file-icon-powerpoint { color: #ea580c; }
        .file-icon-image { color: #8b5cf6; }
        .file-icon-text { color: #64748b; }
        .file-icon-archive { color: #78716c; }
        .file-icon-audio { color: #ec4899; }
        .file-icon-video { color: #f43f5e; }
        .file-icon-other { color: #94a3b8; }

        /* Source email cell */
        .source-email {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
            line-height: 1.2;
        }

        .source-email-subject {
            font-size: 0.75rem;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .source-email-from {
            font-size: 0.6875rem;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        /* File type badge */
        .file-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.5rem;
            background: #f1f5f9;
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/dist/ag-grid-community.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <span>üìÅ</span> VeriCase Evidence Repository
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='contentious-matters.html'">
                    ‚öñÔ∏è Claims
                </button>
                <button class="btn btn-secondary" onclick="VeriCaseApp.gotoCorrespondence()">
                    üì® Correspondence
                </button>
                <button class="btn btn-secondary" onclick="VeriCaseApp.gotoDashboard()">
                    üè† Dashboard
                </button>
            </div>
        </div>

        <!-- Category Tabs -->
        <div class="category-tabs">
            <button class="category-tab active" data-category="documents" id="tabDocuments">
                <i class="fas fa-file-alt"></i> Documents
                <span class="tab-count" id="docCount">0</span>
            </button>
            <button class="category-tab" data-category="images" id="tabImages">
                <i class="fas fa-image"></i> Images & Media
                <span class="tab-count" id="imgCount">0</span>
            </button>
            <button class="category-tab" data-category="all" id="tabAll">
                <i class="fas fa-layer-group"></i> All Files
                <span class="tab-count" id="allCount">0</span>
            </button>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <input 
                type="text" 
                class="search-input" 
                id="searchInput"
                placeholder="Search evidence..."
            >
            
            <select class="filter-select" id="fileTypeFilter">
                <option value="">All File Types</option>
                <option value="pdf">PDF Documents</option>
                <option value="word">Word Documents</option>
                <option value="excel">Spreadsheets</option>
                <option value="powerpoint">Presentations</option>
                <option value="text">Text Files</option>
                <option value="image">Images</option>
                <option value="other">Other</option>
            </select>

            <select class="filter-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="processed">Processed</option>
                <option value="processing">Processing</option>
                <option value="pending">Pending</option>
                <option value="error">Error</option>
            </select>

            <label class="checkbox-label">
                <input type="checkbox" id="unassignedFilter">
                Unassigned only
            </label>

            <label class="checkbox-label">
                <input type="checkbox" id="starredFilter">
                Starred only
            </label>

            <div class="spacer"></div>

            <input type="file" id="fileInput" multiple style="display: none;">
            <button class="btn btn-primary" id="uploadBtn">
                <i class="fas fa-upload"></i> Upload Evidence
            </button>

            <button class="btn btn-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-value" id="totalCount">0</span> Total Items
            </div>
            <div class="stat-item">
                <span class="stat-value" id="unassignedCount">0</span> Unassigned
            </div>
            <div class="stat-item">
                <span class="stat-value" id="linkedCount">0</span> With Links
            </div>
            <div class="stat-item">
                <span class="stat-value" id="recentCount">0</span> Recent (7d)
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Collections Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">Collections</div>
                <div class="collection-list" id="collectionList">
                    <div class="collection-item active" data-id="">
                        üìÅ All Evidence
                    </div>
                </div>
            </div>

            <!-- Grid -->
            <div class="grid-container">
                <div id="evidenceGrid" class="ag-theme-alpine" style="flex: 1; width: 100%;"></div>
            </div>

            <!-- Enhanced Detail Panel -->
            <div class="detail-panel" id="detailPanel" style="display: none;">
                <div class="detail-header">
                    <h3>Evidence Details</h3>
                    <div class="detail-header-actions">
                        <button class="btn btn-ghost btn-sm" id="extractMetadataBtn" title="Extract Metadata">
                            <i class="fas fa-magic"></i>
                        </button>
                        <button class="close-btn" id="closeDetailBtn">‚úï</button>
                    </div>
                </div>
                <div class="detail-body" id="detailBody">
                    <!-- Preview Section -->
                    <div class="preview-section" id="previewSection">
                        <div class="preview-placeholder">
                            <i class="fas fa-file"></i>
                            <span>Select an item to preview</span>
                        </div>
                    </div>
                    
                    <!-- Metadata Content -->
                    <div class="metadata-content" id="metadataContent">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="detail-actions">
                    <button class="btn btn-primary" id="downloadBtn">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button class="btn btn-secondary" id="previewFullBtn">
                        <i class="fas fa-expand"></i> Full Preview
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-Screen Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-modal-header">
            <div class="preview-modal-title" id="previewModalTitle">File Preview</div>
            <div class="preview-modal-actions">
                <button class="btn btn-sm" id="modalDownloadBtn">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="btn btn-sm" id="closePreviewModal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
        <div class="preview-modal-body">
            <div class="preview-modal-content" id="previewModalContent">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const apiUrl = window.VeriCaseConfig ? window.VeriCaseConfig.apiUrl : window.location.origin;
        
        // Grid instance
        let gridApi = null;
        let selectedEvidence = null;
        let currentPreviewData = null;
        
        // Project/Case IDs - will be set by VeriCaseApp
        let projectId = null;
        let caseId = null;
        
        // Current category filter: 'documents', 'images', or 'all'
        let currentCategory = 'documents';
        
        // Cache for all evidence items (for client-side filtering)
        let allEvidenceItems = [];

        // Evidence type labels and icons
        const typeConfig = {
            contract: { label: 'Contract', icon: 'fa-file-contract', color: '#1e40af' },
            variation: { label: 'Variation', icon: 'fa-exchange-alt', color: '#92400e' },
            drawing: { label: 'Drawing', icon: 'fa-drafting-compass', color: '#3730a3' },
            specification: { label: 'Specification', icon: 'fa-clipboard-list', color: '#166534' },
            programme: { label: 'Programme', icon: 'fa-calendar-alt', color: '#0f766e' },
            invoice: { label: 'Invoice', icon: 'fa-file-invoice-dollar', color: '#166534' },
            payment_certificate: { label: 'Payment Certificate', icon: 'fa-certificate', color: '#0f766e' },
            meeting_minutes: { label: 'Meeting Minutes', icon: 'fa-users', color: '#1e40af' },
            site_instruction: { label: 'Site Instruction', icon: 'fa-hard-hat', color: '#92400e' },
            rfi: { label: 'RFI', icon: 'fa-question-circle', color: '#6b21a8' },
            notice: { label: 'Notice', icon: 'fa-exclamation-triangle', color: '#991b1b' },
            letter: { label: 'Letter', icon: 'fa-envelope', color: '#475569' },
            email_attachment: { label: 'Email Attachment', icon: 'fa-paperclip', color: '#0369a1' },
            photo: { label: 'Photo', icon: 'fa-camera', color: '#6b21a8' },
            expert_report: { label: 'Expert Report', icon: 'fa-user-tie', color: '#1e40af' },
            pdf: { label: 'PDF', icon: 'fa-file-pdf', color: '#dc2626' },
            word_document: { label: 'Word Doc', icon: 'fa-file-word', color: '#2563eb' },
            spreadsheet: { label: 'Spreadsheet', icon: 'fa-file-excel', color: '#16a34a' },
            image: { label: 'Image', icon: 'fa-image', color: '#8b5cf6' },
            other: { label: 'Other', icon: 'fa-file', color: '#64748b' }
        };

        // MIME type to preview type mapping
        const mimePreviewMap = {
            'application/pdf': 'pdf',
            'image/jpeg': 'image',
            'image/png': 'image',
            'image/gif': 'image',
            'image/webp': 'image',
            'image/svg+xml': 'image',
            'text/plain': 'text',
            'text/csv': 'text',
            'text/html': 'text',
            'application/json': 'text',
            'application/xml': 'text',
            'text/xml': 'text'
        };

        // Get file icon
        function getFileIcon(mimeType, evidenceType) {
            if (evidenceType && typeConfig[evidenceType]) {
                return typeConfig[evidenceType].icon;
            }
            if (mimeType) {
                if (mimeType.startsWith('image/')) return 'fa-image';
                if (mimeType === 'application/pdf') return 'fa-file-pdf';
                if (mimeType.includes('word')) return 'fa-file-word';
                if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'fa-file-excel';
                if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'fa-file-powerpoint';
                if (mimeType.startsWith('text/')) return 'fa-file-alt';
                if (mimeType.startsWith('audio/')) return 'fa-file-audio';
                if (mimeType.startsWith('video/')) return 'fa-file-video';
            }
            return 'fa-file';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return '';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        // Get file type info based on MIME type and extension
        function getFileTypeInfo(mimeType, filename) {
            const ext = (filename || '').split('.').pop()?.toLowerCase() || '';
            
            // PDF
            if (mimeType === 'application/pdf' || ext === 'pdf') {
                return { icon: 'fa-file-pdf', label: 'PDF', colorClass: 'file-icon-pdf' };
            }
            // Word
            if (mimeType?.includes('word') || ['doc', 'docx', 'rtf'].includes(ext)) {
                return { icon: 'fa-file-word', label: 'Word', colorClass: 'file-icon-word' };
            }
            // Excel
            if (mimeType?.includes('excel') || mimeType?.includes('spreadsheet') || ['xls', 'xlsx', 'csv'].includes(ext)) {
                return { icon: 'fa-file-excel', label: 'Excel', colorClass: 'file-icon-excel' };
            }
            // PowerPoint
            if (mimeType?.includes('powerpoint') || mimeType?.includes('presentation') || ['ppt', 'pptx'].includes(ext)) {
                return { icon: 'fa-file-powerpoint', label: 'PPT', colorClass: 'file-icon-powerpoint' };
            }
            // Images
            if (mimeType?.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'tiff'].includes(ext)) {
                return { icon: 'fa-image', label: 'Image', colorClass: 'file-icon-image' };
            }
            // Text
            if (mimeType?.startsWith('text/') || ['txt', 'md', 'log', 'json', 'xml', 'html'].includes(ext)) {
                return { icon: 'fa-file-alt', label: 'Text', colorClass: 'file-icon-text' };
            }
            // Archive
            if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) {
                return { icon: 'fa-file-archive', label: 'Archive', colorClass: 'file-icon-archive' };
            }
            // Audio
            if (mimeType?.startsWith('audio/') || ['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) {
                return { icon: 'fa-file-audio', label: 'Audio', colorClass: 'file-icon-audio' };
            }
            // Video
            if (mimeType?.startsWith('video/') || ['mp4', 'avi', 'mov', 'wmv', 'mkv'].includes(ext)) {
                return { icon: 'fa-file-video', label: 'Video', colorClass: 'file-icon-video' };
            }
            // Default
            return { icon: 'fa-file', label: ext.toUpperCase() || 'File', colorClass: 'file-icon-other' };
        }

        // Check if file is an image (for filtering)
        function isImageFile(mimeType, filename) {
            const ext = (filename || '').split('.').pop()?.toLowerCase() || '';
            return mimeType?.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'tiff', 'ico'].includes(ext);
        }

        // Grid column definitions
        const columnDefs = [
            {
                field: 'is_starred',
                headerName: '',
                width: 40,
                cellRenderer: params => {
                    const starred = params.value;
                    return `<span style="cursor: pointer; color: ${starred ? '#f59e0b' : '#cbd5e1'}; font-size: 1.1rem;">‚òÖ</span>`;
                },
                onCellClicked: params => toggleStar(params.data.id)
            },
            {
                field: 'file_type_icon',
                headerName: 'Type',
                width: 70,
                cellRenderer: params => {
                    const data = params.data;
                    const typeInfo = getFileTypeInfo(data.mime_type, data.filename);
                    return `<div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                        <i class="fas ${typeInfo.icon} ${typeInfo.colorClass}" style="font-size: 1.25rem;"></i>
                        <span style="font-size: 0.5625rem; color: #64748b; text-transform: uppercase;">${typeInfo.label}</span>
                    </div>`;
                }
            },
            {
                field: 'filename',
                headerName: 'Filename',
                flex: 2,
                minWidth: 200,
                cellRenderer: params => {
                    const data = params.data;
                    const title = data.title || data.filename;
                    const truncated = title.length > 50 ? title.substring(0, 47) + '...' : title;
                    return `<span title="${title}">${truncated}</span>`;
                }
            },
            {
                field: 'source_email',
                headerName: 'Source',
                flex: 1.5,
                minWidth: 180,
                cellRenderer: params => {
                    const data = params.data;
                    // Try to get email info from the data
                    const subject = data.source_email_subject || data.email_subject || '';
                    const from = data.source_email_from || data.email_from || '';
                    
                    if (!subject && !from) {
                        if (data.source_type === 'pst_extraction') {
                            return '<span style="color: #64748b; font-size: 0.75rem;"><i class="fas fa-envelope" style="margin-right: 0.25rem;"></i>Email attachment</span>';
                        }
                        return '<span style="color: #94a3b8; font-size: 0.75rem;">‚Äî</span>';
                    }
                    
                    return `<div class="source-email">
                        <div class="source-email-subject" title="${escapeHtml(subject)}">
                            <i class="fas fa-envelope" style="margin-right: 0.25rem; color: #0369a1; font-size: 0.625rem;"></i>
                            ${escapeHtml(subject) || 'No subject'}
                        </div>
                        <div class="source-email-from" title="${escapeHtml(from)}">${escapeHtml(from)}</div>
                    </div>`;
                }
            },
            {
                field: 'file_size',
                headerName: 'Size',
                width: 80,
                valueFormatter: params => formatFileSize(params.value)
            },
            {
                field: 'document_date',
                headerName: 'Date',
                width: 100,
                valueFormatter: params => formatDate(params.value)
            },
            {
                field: 'page_count',
                headerName: 'Pages',
                width: 65,
                cellRenderer: params => {
                    const count = params.value;
                    if (!count) return '<span style="color: #cbd5e1;">‚Äî</span>';
                    return `<span>${count}</span>`;
                }
            },
            {
                field: 'processing_status',
                headerName: 'Status',
                width: 85,
                cellRenderer: params => {
                    const status = params.value || 'pending';
                    const statusClass = `status-${status}`;
                    return `<span class="status-badge ${statusClass}">${status}</span>`;
                }
            },
            {
                field: 'created_at',
                headerName: 'Uploaded',
                width: 95,
                sortable: true,
                valueFormatter: params => formatDate(params.value)
            },
            {
                field: 'claim_status',
                headerName: 'Claim Status',
                width: 110,
                cellRenderer: params => {
                    const status = params.data.claim_status || 'none';
                    const statusConfig = {
                        'none': { bg: '#f3f4f6', color: '#6b7280', label: 'None' },
                        'contentious_matter': { bg: '#fef3c7', color: '#92400e', label: 'Matter' },
                        'head_of_claim': { bg: '#fee2e2', color: '#991b1b', label: 'Claim' }
                    };
                    const cfg = statusConfig[status] || statusConfig['none'];
                    return `<span style="padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; 
                                       font-weight: 600; background: ${cfg.bg}; color: ${cfg.color};">
                                ${cfg.label}
                            </span>`;
                }
            },
            {
                field: 'linked_to',
                headerName: 'Linked To',
                width: 140,
                cellRenderer: params => {
                    const linkedTo = params.data.linked_matter_name || params.data.linked_claim_name;
                    if (!linkedTo) return '<span style="color: #cbd5e1;">‚Äî</span>';
                    const isMatter = params.data.linked_matter_name;
                    const icon = isMatter ? 'fa-exclamation-triangle' : 'fa-gavel';
                    const iconColor = isMatter ? '#f59e0b' : '#ef4444';
                    return `<div style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.75rem;"
                                 onclick="openLinkedItem('${params.data.id}')">
                                <i class="fas ${icon}" style="color: ${iconColor};"></i>
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${linkedTo}</span>
                            </div>`;
                }
            },
            {
                field: 'claim_notes',
                headerName: 'Notes',
                width: 150,
                cellRenderer: params => {
                    const notes = params.data.claim_notes || '';
                    if (!notes) {
                        return `<span style="color: #cbd5e1; font-style: italic; font-size: 0.75rem;">+ Add notes</span>`;
                    }
                    return `<div style="font-size: 0.75rem; max-width: 140px; overflow: hidden; 
                                       text-overflow: ellipsis; white-space: nowrap;" 
                                 title="${notes.replace(/"/g, '&quot;')}">${notes}</div>`;
                }
            }
        ];

        // Grid options
        const gridOptions = {
            columnDefs: columnDefs,
            defaultColDef: {
                resizable: true,
                sortable: true
            },
            rowData: [],
            rowSelection: 'single',
            animateRows: true,
            enableCellTextSelection: true,
            suppressCellFocus: true,
            onRowClicked: event => showDetail(event.data),
            onGridReady: params => {
                console.log('[Evidence] Grid ready');
                gridApi = params.api;
                params.api.sizeColumnsToFit();
            }
        };

        // Main initialization - runs when script loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Evidence] DOM ready, starting initialization...');
            
            try {
                // Initialize VeriCaseApp
                await VeriCaseApp.init();
                projectId = VeriCaseApp.projectId;
                caseId = VeriCaseApp.caseId;
                console.log('[Evidence] VeriCaseApp ready, projectId:', projectId);
            } catch (e) {
                console.warn('[Evidence] VeriCaseApp init issue:', e);
            }
            
            // Create the grid
            const gridDiv = document.getElementById('evidenceGrid');
            agGrid.createGrid(gridDiv, gridOptions);
            console.log('[Evidence] Grid created');
            
            // Load data with small delay to ensure grid is ready
            setTimeout(async () => {
                try {
                    await loadEvidence();
                    console.log('[Evidence] Data loaded:', allEvidenceItems.length, 'items');
                    loadCollections();
                    loadStats();
                } catch (err) {
                    console.error('[Evidence] Load error:', err);
                }
            }, 100);
        });
        
        // Fallback: Check after 2 seconds if data loaded, if not, trigger load
        setTimeout(() => {
            if (typeof allEvidenceItems !== 'undefined' && allEvidenceItems.length === 0 && typeof gridApi !== 'undefined' && gridApi) {
                console.log('[Evidence] Fallback: triggering data load');
                loadEvidence().then(() => {
                    loadCollections();
                    loadStats();
                }).catch(e => console.error('[Evidence] Fallback load error:', e));
            }
        }, 2000);
        
        // Set up event listeners (run immediately, they'll work once DOM is ready)
        function setupEventListeners() {
            // Event listeners
            document.getElementById('searchInput')?.addEventListener('input', debounce(applyFilters, 300));
            document.getElementById('fileTypeFilter')?.addEventListener('change', applyFilters);
            document.getElementById('statusFilter')?.addEventListener('change', applyFilters);
            document.getElementById('unassignedFilter')?.addEventListener('change', applyFilters);
            document.getElementById('starredFilter')?.addEventListener('change', applyFilters);
            document.getElementById('refreshBtn')?.addEventListener('click', () => { loadEvidence(); loadStats(); });
            document.getElementById('uploadBtn')?.addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput')?.addEventListener('change', handleFileUpload);
            
            // Category tab handlers
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentCategory = tab.dataset.category;
                    applyFilters();
                });
            });
            document.getElementById('closeDetailBtn')?.addEventListener('click', hideDetail);
            document.getElementById('downloadBtn')?.addEventListener('click', downloadCurrentFile);
            document.getElementById('previewFullBtn')?.addEventListener('click', openFullPreview);
            document.getElementById('extractMetadataBtn')?.addEventListener('click', extractMetadata);
            document.getElementById('closePreviewModal')?.addEventListener('click', closePreviewModal);
            document.getElementById('modalDownloadBtn')?.addEventListener('click', downloadCurrentFile);
            
            // Close modal on escape
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') closePreviewModal();
            });
            
            // Collection click (reload from server since collections are server-filtered)
            document.getElementById('collectionList')?.addEventListener('click', e => {
                const item = e.target.closest('.collection-item');
                if (item) {
                    document.querySelectorAll('.collection-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    loadEvidence(); // Reload from server for collection filtering
                }
            });

            // Drag and drop
            const gridDiv2 = document.getElementById('evidenceGrid');
            if (gridDiv2) {
                gridDiv2.addEventListener('dragover', e => { e.preventDefault(); gridDiv2.classList.add('dragover'); });
                gridDiv2.addEventListener('dragleave', () => gridDiv2.classList.remove('dragover'));
                gridDiv2.addEventListener('drop', e => { e.preventDefault(); gridDiv2.classList.remove('dragover'); handleFileUpload({ target: { files: e.dataTransfer.files } }); });
            }
        }
        
        // Set up listeners after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupEventListeners);
        } else {
            setupEventListeners();
        }

        // Debounce helper
        function debounce(fn, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        // Load evidence from server
        async function loadEvidence() {
            try {
                const params = new URLSearchParams();
                params.append('page', '1');
                params.append('page_size', '500'); // API max is 500
                params.append('include_email_info', 'true'); // Get source email info
                
                const activeCollection = document.querySelector('.collection-item.active');
                const collectionId = activeCollection?.dataset.id;
                if (collectionId) params.append('collection_id', collectionId);
                
                // NOTE: Don't filter by project_id for evidence repository
                // Evidence should be visible across all projects for review
                // Project filtering happens via collections if needed
                
                const response = await fetch(`${apiUrl}/api/evidence/items?${params.toString()}`);
                
                if (response.ok) {
                    const data = await response.json();
                    allEvidenceItems = data.items || [];
                    updateCategoryCounts();
                    applyFilters();
                } else {
                    console.error('Failed to load evidence');
                    allEvidenceItems = [];
                    gridApi.setGridOption('rowData', []);
                }
            } catch (error) {
                console.error('Error loading evidence:', error);
                allEvidenceItems = [];
                gridApi.setGridOption('rowData', []);
            }
        }

        // Update category tab counts
        function updateCategoryCounts() {
            let docCount = 0;
            let imgCount = 0;
            
            allEvidenceItems.forEach(item => {
                if (isImageFile(item.mime_type, item.filename)) {
                    imgCount++;
                } else {
                    docCount++;
                }
            });
            
            document.getElementById('docCount').textContent = docCount;
            document.getElementById('imgCount').textContent = imgCount;
            document.getElementById('allCount').textContent = allEvidenceItems.length;
        }

        // Apply filters to cached evidence items
        function applyFilters() {
            let filtered = [...allEvidenceItems];
            
            // Category filter (documents vs images)
            if (currentCategory === 'documents') {
                filtered = filtered.filter(item => !isImageFile(item.mime_type, item.filename));
            } else if (currentCategory === 'images') {
                filtered = filtered.filter(item => isImageFile(item.mime_type, item.filename));
            }
            // 'all' shows everything
            
            // Search filter
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            if (search) {
                filtered = filtered.filter(item => {
                    const filename = (item.filename || '').toLowerCase();
                    const title = (item.title || '').toLowerCase();
                    const subject = (item.source_email_subject || '').toLowerCase();
                    const from = (item.source_email_from || '').toLowerCase();
                    return filename.includes(search) || title.includes(search) || 
                           subject.includes(search) || from.includes(search);
                });
            }
            
            // File type filter
            const fileType = document.getElementById('fileTypeFilter').value;
            if (fileType) {
                filtered = filtered.filter(item => {
                    const typeInfo = getFileTypeInfo(item.mime_type, item.filename);
                    const label = typeInfo.label.toLowerCase();
                    switch (fileType) {
                        case 'pdf': return label === 'pdf';
                        case 'word': return label === 'word';
                        case 'excel': return label === 'excel' || item.mime_type?.includes('spreadsheet');
                        case 'powerpoint': return label === 'ppt';
                        case 'text': return label === 'text' || item.mime_type?.startsWith('text/');
                        case 'image': return isImageFile(item.mime_type, item.filename);
                        case 'other': return !['pdf', 'word', 'excel', 'ppt', 'text', 'image'].includes(label.toLowerCase());
                        default: return true;
                    }
                });
            }
            
            // Status filter
            const status = document.getElementById('statusFilter').value;
            if (status) {
                filtered = filtered.filter(item => item.processing_status === status);
            }
            
            // Unassigned filter
            if (document.getElementById('unassignedFilter').checked) {
                filtered = filtered.filter(item => !item.case_id && !item.project_id);
            }
            
            // Starred filter
            if (document.getElementById('starredFilter').checked) {
                filtered = filtered.filter(item => item.is_starred);
            }
            
            gridApi.setGridOption('rowData', filtered);
            
            // Force grid to render (fixes virtual scroll rendering issue)
            setTimeout(() => {
                gridApi.sizeColumnsToFit();
            }, 100);
        }

        // Load collections
        async function loadCollections() {
            try {
                // Load all collections - don't filter by project
                let url = `${apiUrl}/api/evidence/collections?include_system=true`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const collections = await response.json();
                    const list = document.getElementById('collectionList');
                    
                    let html = '<div class="collection-item active" data-id="">üìÅ All Evidence</div>';
                    
                    collections.forEach(c => {
                        const icon = c.is_system ? 'üìÇ' : 'üìÅ';
                        html += `
                            <div class="collection-item" data-id="${c.id}">
                                ${icon} ${c.name}
                                <span class="collection-count">${c.item_count || 0}</span>
                            </div>
                        `;
                    });
                    
                    list.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading collections:', error);
            }
        }

        // Load stats
        async function loadStats() {
            try {
                // Don't filter stats by project - show all evidence stats
                let url = `${apiUrl}/api/evidence/stats`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalCount').textContent = stats.total || 0;
                    document.getElementById('unassignedCount').textContent = stats.unassigned || 0;
                    document.getElementById('linkedCount').textContent = stats.with_correspondence || 0;
                    document.getElementById('recentCount').textContent = stats.recent_uploads || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Open linked matter/claim
        function openLinkedItem(evidenceId) {
            window.open('contentious-matters.html', '_blank');
        }

        // Show detail panel with preview and metadata
        async function showDetail(evidence) {
            if (!evidence) return;
            
            try {
                // Get full details and preview data
                const [detailRes, previewRes, metadataRes] = await Promise.all([
                    fetch(`${apiUrl}/api/evidence/items/${evidence.id}`),
                    fetch(`${apiUrl}/api/evidence/items/${evidence.id}/preview`),
                    fetch(`${apiUrl}/api/evidence/items/${evidence.id}/metadata`)
                ]);
                
                if (detailRes.ok) {
                    const detail = await detailRes.json();
                    const preview = previewRes.ok ? await previewRes.json() : null;
                    const metadata = metadataRes.ok ? await metadataRes.json() : null;
                    
                    selectedEvidence = detail;
                    currentPreviewData = preview;
                    
                    // Render preview section
                    renderPreview(preview, detail);
                    
                    // Render metadata section
                    renderMetadata(detail, metadata?.metadata);
                    
                    document.getElementById('detailPanel').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading detail:', error);
            }
        }

        // Render preview section
        function renderPreview(preview, detail) {
            const section = document.getElementById('previewSection');
            
            if (!preview) {
                section.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas ${getFileIcon(detail.mime_type, detail.evidence_type)}"></i>
                        <span>Preview not available</span>
                    </div>
                `;
                return;
            }

            let previewHtml = '';
            
            switch (preview.preview_type) {
                case 'image':
                    previewHtml = `
                        <img src="${preview.preview_url}" class="preview-image" alt="${detail.filename}">
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Expand
                        </button>
                    `;
                    break;
                    
                case 'pdf':
                    previewHtml = `
                        <iframe src="${preview.preview_url}#toolbar=0" class="preview-pdf"></iframe>
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Expand
                        </button>
                    `;
                    break;
                    
                case 'text':
                    const content = preview.preview_content || 'No content available';
                    const truncated = content.length > 2000 ? content.substring(0, 2000) + '\n\n... (truncated)' : content;
                    previewHtml = `
                        <pre class="preview-text">${escapeHtml(truncated)}</pre>
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Full Text
                        </button>
                    `;
                    break;
                    
                case 'office':
                    const officeContent = preview.preview_content || 'Text extraction available in full preview';
                    const officeText = typeof officeContent === 'string' ? officeContent : JSON.stringify(officeContent, null, 2);
                    const truncatedOffice = officeText.length > 1500 ? officeText.substring(0, 1500) + '\n\n... (truncated)' : officeText;
                    previewHtml = `
                        <pre class="preview-text">${escapeHtml(truncatedOffice)}</pre>
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Full Text
                        </button>
                    `;
                    break;
                    
                case 'email':
                    const email = preview.preview_content || {};
                    previewHtml = `
                        <div class="preview-text" style="padding: 1rem;">
                            <div style="margin-bottom: 0.5rem;"><strong>From:</strong> ${email.from || '‚Äî'}</div>
                            <div style="margin-bottom: 0.5rem;"><strong>To:</strong> ${email.to?.join(', ') || '‚Äî'}</div>
                            ${email.cc?.length ? `<div style="margin-bottom: 0.5rem;"><strong>CC:</strong> ${email.cc.join(', ')}</div>` : ''}
                            <div style="margin-bottom: 0.5rem;"><strong>Subject:</strong> ${email.subject || '‚Äî'}</div>
                            <div style="margin-bottom: 0.5rem;"><strong>Date:</strong> ${formatDate(email.date)}</div>
                            <hr style="margin: 0.5rem 0; border-color: #334155;">
                            <div style="white-space: pre-wrap;">${escapeHtml(email.body_preview || '')}</div>
                        </div>
                    `;
                    break;
                    
                default:
                    previewHtml = `
                        <div class="preview-placeholder">
                            <i class="fas ${getFileIcon(detail.mime_type, detail.evidence_type)}"></i>
                            <span>${detail.filename}</span>
                            <span style="font-size: 0.625rem; margin-top: 0.5rem;">Click "Full Preview" to download</span>
                        </div>
                    `;
            }
            
            section.innerHTML = previewHtml;
        }

        // Render metadata section
        function renderMetadata(detail, extractedMeta) {
            const content = document.getElementById('metadataContent');
            const meta = extractedMeta || detail.extracted_metadata || {};
            
            let html = '';
            
            // Basic Info Section
            html += `
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-info-circle"></i>
                        <h4>Basic Information</h4>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Filename</div>
                        <div class="detail-value">${detail.filename}</div>
                    </div>
                    ${detail.title && detail.title !== detail.filename ? `
                        <div class="detail-item">
                            <div class="detail-label">Title</div>
                            <div class="detail-value">${detail.title}</div>
                        </div>
                    ` : ''}
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Type</div>
                            <div class="detail-value">${typeConfig[detail.evidence_type]?.label || detail.evidence_type || 'Unknown'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Size</div>
                            <div class="detail-value">${formatFileSize(detail.file_size)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">MIME Type</div>
                            <div class="detail-value" style="font-size: 0.75rem;">${detail.mime_type || '‚Äî'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge status-${detail.processing_status || 'pending'}">${detail.processing_status || 'pending'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Document Properties Section (if available)
            if (meta.author || meta.title || meta.created_date || meta.page_count || detail.document_date) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-file-alt"></i>
                            <h4>Document Properties</h4>
                        </div>
                        <div class="detail-grid">
                            ${meta.author || detail.author ? `
                                <div class="detail-item">
                                    <div class="detail-label">Author</div>
                                    <div class="detail-value">${meta.author || detail.author}</div>
                                </div>
                            ` : ''}
                            ${meta.creator ? `
                                <div class="detail-item">
                                    <div class="detail-label">Creator</div>
                                    <div class="detail-value">${meta.creator}</div>
                                </div>
                            ` : ''}
                            ${detail.document_date || meta.created_date ? `
                                <div class="detail-item">
                                    <div class="detail-label">Document Date</div>
                                    <div class="detail-value">${formatDate(detail.document_date || meta.created_date)}</div>
                                </div>
                            ` : ''}
                            ${meta.modified_date ? `
                                <div class="detail-item">
                                    <div class="detail-label">Modified</div>
                                    <div class="detail-value">${formatDate(meta.modified_date)}</div>
                                </div>
                            ` : ''}
                            ${meta.page_count || detail.page_count ? `
                                <div class="detail-item">
                                    <div class="detail-label">Pages</div>
                                    <div class="detail-value">${meta.page_count || detail.page_count}</div>
                                </div>
                            ` : ''}
                            ${meta.word_count ? `
                                <div class="detail-item">
                                    <div class="detail-label">Word Count</div>
                                    <div class="detail-value">${meta.word_count.toLocaleString()}</div>
                                </div>
                            ` : ''}
                            ${meta.company ? `
                                <div class="detail-item">
                                    <div class="detail-label">Company</div>
                                    <div class="detail-value">${meta.company}</div>
                                </div>
                            ` : ''}
                            ${meta.producer ? `
                                <div class="detail-item">
                                    <div class="detail-label">Producer</div>
                                    <div class="detail-value" style="font-size: 0.75rem;">${meta.producer}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Image EXIF Section
            if (meta.width || meta.camera_make || meta.date_taken) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-camera"></i>
                            <h4>Image Information</h4>
                        </div>
                        <div class="detail-grid">
                            ${meta.width && meta.height ? `
                                <div class="detail-item">
                                    <div class="detail-label">Dimensions</div>
                                    <div class="detail-value">${meta.width} √ó ${meta.height} px</div>
                                </div>
                            ` : ''}
                            ${meta.color_mode ? `
                                <div class="detail-item">
                                    <div class="detail-label">Color Mode</div>
                                    <div class="detail-value">${meta.color_mode}</div>
                                </div>
                            ` : ''}
                            ${meta.camera_make ? `
                                <div class="detail-item">
                                    <div class="detail-label">Camera</div>
                                    <div class="detail-value">${meta.camera_make} ${meta.camera_model || ''}</div>
                                </div>
                            ` : ''}
                            ${meta.date_taken ? `
                                <div class="detail-item">
                                    <div class="detail-label">Date Taken</div>
                                    <div class="detail-value">${formatDate(meta.date_taken)}</div>
                                </div>
                            ` : ''}
                            ${meta.focal_length ? `
                                <div class="detail-item">
                                    <div class="detail-label">Focal Length</div>
                                    <div class="detail-value">${meta.focal_length}mm</div>
                                </div>
                            ` : ''}
                            ${meta.f_number ? `
                                <div class="detail-item">
                                    <div class="detail-label">Aperture</div>
                                    <div class="detail-value">f/${meta.f_number}</div>
                                </div>
                            ` : ''}
                            ${meta.exposure_time ? `
                                <div class="detail-item">
                                    <div class="detail-label">Exposure</div>
                                    <div class="detail-value">${meta.exposure_time}s</div>
                                </div>
                            ` : ''}
                            ${meta.iso_speed ? `
                                <div class="detail-item">
                                    <div class="detail-label">ISO</div>
                                    <div class="detail-value">${meta.iso_speed}</div>
                                </div>
                            ` : ''}
                        </div>
                        ${meta.gps_latitude && meta.gps_longitude ? `
                            <div class="detail-item" style="margin-top: 0.5rem;">
                                <div class="detail-label">Location</div>
                                <a href="https://www.google.com/maps?q=${meta.gps_latitude},${meta.gps_longitude}" target="_blank" class="gps-map-link">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${meta.gps_latitude.toFixed(6)}, ${meta.gps_longitude.toFixed(6)}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.5rem;"></i>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Construction References Section
            if (meta.drawing_number || meta.project_reference || meta.document_reference || meta.revision_number) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-building"></i>
                            <h4>Construction References</h4>
                        </div>
                        <div class="tag-list">
                            ${meta.drawing_number ? `<span class="tag tag-purple"><i class="fas fa-drafting-compass"></i> ${meta.drawing_number}</span>` : ''}
                            ${meta.project_reference ? `<span class="tag tag-teal"><i class="fas fa-folder"></i> ${meta.project_reference}</span>` : ''}
                            ${meta.document_reference ? `<span class="tag tag-blue"><i class="fas fa-hashtag"></i> ${meta.document_reference}</span>` : ''}
                            ${meta.revision_number ? `<span class="tag tag-yellow"><i class="fas fa-code-branch"></i> Rev ${meta.revision_number}</span>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Tags Section
            if ((detail.auto_tags?.length > 0 || detail.manual_tags?.length > 0)) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-tags"></i>
                            <h4>Tags</h4>
                        </div>
                        <div class="tag-list">
                            ${(detail.manual_tags || []).map(t => `<span class="tag tag-blue">${t}</span>`).join('')}
                            ${(detail.auto_tags || []).map(t => `<span class="tag">${t}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Extracted References
            if (detail.extracted_references?.length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-link"></i>
                            <h4>Extracted References</h4>
                        </div>
                        <div class="tag-list">
                            ${detail.extracted_references.map(r => `<span class="tag tag-yellow">${r.reference || r}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Linked Correspondence
            if (detail.correspondence_links?.length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-envelope"></i>
                            <h4>Linked Correspondence (${detail.correspondence_links.length})</h4>
                        </div>
                        ${detail.correspondence_links.map(link => `
                            <div class="link-card">
                                ${link.email ? `
                                    <div class="link-card-title">${link.email.subject || 'No subject'}</div>
                                    <div class="link-card-meta">${link.email.sender_email || ''} ‚Ä¢ ${formatDate(link.email.date_sent)}</div>
                                ` : link.external_correspondence ? `
                                    <div class="link-card-title">${link.external_correspondence.subject || link.external_correspondence.reference || 'External'}</div>
                                    <div class="link-card-meta">${link.external_correspondence.type || ''} ‚Ä¢ ${link.external_correspondence.date || ''}</div>
                                ` : ''}
                                <div class="link-card-meta">${link.link_type} ‚Ä¢ ${link.link_confidence ? link.link_confidence + '% confidence' : 'Manual link'}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // File Hash (for forensic purposes)
            if (meta.sha256 || detail.file_hash) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-fingerprint"></i>
                            <h4>Forensic Data</h4>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">SHA-256 Hash</div>
                            <div class="detail-value" style="font-family: monospace; font-size: 0.6875rem; word-break: break-all;">${meta.sha256 || detail.file_hash}</div>
                        </div>
                        ${meta.md5 ? `
                            <div class="detail-item">
                                <div class="detail-label">MD5 Hash</div>
                                <div class="detail-value" style="font-family: monospace; font-size: 0.6875rem;">${meta.md5}</div>
                            </div>
                        ` : ''}
                        <div class="detail-item">
                            <div class="detail-label">Uploaded</div>
                            <div class="detail-value">${formatDate(detail.created_at)}</div>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }

        // Hide detail panel
        function hideDetail() {
            document.getElementById('detailPanel').style.display = 'none';
            selectedEvidence = null;
            currentPreviewData = null;
        }

        // Toggle star
        async function toggleStar(evidenceId) {
            try {
                const response = await fetch(`${apiUrl}/api/evidence/items/${evidenceId}/star`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadEvidence();
                }
            } catch (error) {
                console.error('Error toggling star:', error);
            }
        }

        // Download current file
        function downloadCurrentFile() {
            if (currentPreviewData?.download_url) {
                window.open(currentPreviewData.download_url, '_blank');
            } else if (selectedEvidence?.download_url) {
                window.open(selectedEvidence.download_url, '_blank');
            }
        }

        // Open full preview modal
        async function openFullPreview() {
            if (!selectedEvidence || !currentPreviewData) return;
            
            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewModalContent');
            const title = document.getElementById('previewModalTitle');
            
            title.textContent = selectedEvidence.filename;
            
            let html = '';
            
            switch (currentPreviewData.preview_type) {
                case 'image':
                    html = `<img src="${currentPreviewData.preview_url}" alt="${selectedEvidence.filename}">`;
                    break;
                    
                case 'pdf':
                    html = `<iframe src="${currentPreviewData.preview_url}"></iframe>`;
                    break;
                    
                case 'text':
                case 'office':
                    // Get full text content
                    try {
                        const response = await fetch(`${apiUrl}/api/evidence/items/${selectedEvidence.id}/text-content?max_length=100000`);
                        if (response.ok) {
                            const data = await response.json();
                            html = `<pre>${escapeHtml(data.text)}</pre>`;
                        } else {
                            html = `<pre>${escapeHtml(currentPreviewData.preview_content || 'Could not load text content')}</pre>`;
                        }
                    } catch (e) {
                        html = `<pre>${escapeHtml(currentPreviewData.preview_content || 'Could not load text content')}</pre>`;
                    }
                    break;
                    
                case 'email':
                    const email = currentPreviewData.preview_content || {};
                    html = `<pre style="max-width: 800px;">
From: ${email.from || '‚Äî'}
To: ${email.to?.join(', ') || '‚Äî'}
${email.cc?.length ? 'CC: ' + email.cc.join(', ') + '\n' : ''}Subject: ${email.subject || '‚Äî'}
Date: ${formatDate(email.date)}
${'‚îÄ'.repeat(60)}

${email.body_preview || '(No content)'}</pre>`;
                    break;
                    
                default:
                    html = `
                        <div style="text-align: center; color: #94a3b8;">
                            <i class="fas ${getFileIcon(selectedEvidence.mime_type, selectedEvidence.evidence_type)}" style="font-size: 5rem; margin-bottom: 1rem;"></i>
                            <p>Preview not available for this file type</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">${selectedEvidence.filename}</p>
                            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="downloadCurrentFile()">
                                <i class="fas fa-download"></i> Download File
                            </button>
                        </div>
                    `;
            }
            
            content.innerHTML = html;
            modal.classList.add('active');
        }

        // Close preview modal
        function closePreviewModal() {
            document.getElementById('previewModal').classList.remove('active');
        }

        // Extract metadata
        async function extractMetadata() {
            if (!selectedEvidence) return;
            
            const btn = document.getElementById('extractMetadataBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`${apiUrl}/api/evidence/items/${selectedEvidence.id}/extract-metadata`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Refresh the detail view
                    await showDetail(selectedEvidence);
                } else {
                    console.error('Metadata extraction failed');
                }
            } catch (error) {
                console.error('Error extracting metadata:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i>';
            }
        }

        // Handle file upload
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            try {
                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    if (projectId) formData.append('project_id', projectId);
                    if (caseId) formData.append('case_id', caseId);
                    
                    await fetch(`${apiUrl}/api/evidence/upload/direct`, {
                        method: 'POST',
                        body: formData
                    });
                }
                
                loadEvidence();
                loadStats();
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Evidence';
                document.getElementById('fileInput').value = '';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

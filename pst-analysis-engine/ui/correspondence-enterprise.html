<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriCase - Correspondence</title>

    <!-- AG-Grid Enterprise CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/styles/ag-theme-quartz.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- VeriCase Design System -->
    <link rel="stylesheet" href="brand-styles.css">
    <link rel="stylesheet" href="design-system.css">
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>

    <!-- DOMPurify -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
        /* === PAGE SPECIFIC STYLES === */
        
        body {
            background: var(--bg-primary);
            overflow: hidden;
        }

        .correspondence-layout {
            display: flex;
            height: calc(100vh - 64px); /* Subtract header height */
            overflow: hidden;
        }

        /* Thread List (Left Pane) */
        .thread-list-container {
            flex: 4;
            min-width: 400px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--gray-200);
            background: white;
        }

        .thread-toolbar {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            background: var(--bg-primary);
        }

        /* Reading Pane (Right Pane) */
        .reading-pane {
            flex: 6;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            box-shadow: -4px 0 24px rgba(0,0,0,0.05);
        }

        .reading-header {
            padding: 20px 32px;
            border-bottom: 1px solid var(--gray-200);
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .thread-title {
            font-family: var(--font-serif); /* Cormorant Garamond */
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .thread-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            gap: 16px;
            align-items: center;
        }

        /* AI Summary Box */
        .ai-summary-box {
            margin: 24px 32px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(250, 249, 246, 1) 0%, rgba(255, 255, 255, 1) 100%);
            border: 1px solid rgba(139, 115, 85, 0.2); /* Gold accent */
            border-radius: 8px;
            position: relative;
            display: none; /* Hidden by default */
        }

        .ai-summary-box.visible {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .ai-label {
            font-family: var(--font-serif);
            font-style: italic;
            color: var(--vericase-gold);
            font-size: 1.1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-content {
            font-size: 0.9375rem;
            line-height: 1.6;
            color: var(--vericase-navy);
        }

        .ai-content ul {
            padding-left: 20px;
            margin: 0;
        }

        .ai-content li {
            margin-bottom: 6px;
        }

        /* Email Thread View */
        .email-stream {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            background: var(--bg-primary); /* Cream background for reading */
        }

        .email-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .email-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--vericase-teal-light);
        }

        .email-header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
            padding-bottom: 16px;
        }

        .sender-name {
            font-weight: 700;
            color: var(--vericase-navy);
            font-size: 1rem;
        }

        .sender-email {
            color: var(--text-muted);
            font-weight: 400;
            font-size: 0.875rem;
        }

        .email-date {
            font-family: var(--font-mono);
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .email-body {
            font-size: 0.9375rem;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap; /* Preserve formatting */
        }

        /* Entity Highlighting */
        .entity-highlight {
            border-bottom: 2px solid rgba(15, 157, 154, 0.3);
            cursor: help;
            transition: all 0.2s;
        }

        .entity-highlight:hover {
            background: rgba(15, 157, 154, 0.1);
            color: var(--vericase-teal-dark);
        }

        /* Empty State */
        .empty-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 3rem;
            color: var(--gray-300);
            margin-bottom: 16px;
        }

        /* AG Grid Customization */
        .ag-theme-quartz {
            --ag-header-background-color: var(--bg-primary);
            --ag-header-foreground-color: var(--text-secondary);
            --ag-row-hover-color: rgba(15, 157, 154, 0.05);
            --ag-selected-row-background-color: rgba(15, 157, 154, 0.1);
            --ag-font-family: var(--font-sans);
        }

        /* Sentiment Indicators */
        .sentiment-bar {
            width: 4px;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            border-radius: 4px 0 0 4px;
        }
        .sentiment-positive { background: var(--success); }
        .sentiment-negative { background: var(--error); }
        .sentiment-neutral { background: var(--gray-300); }

    </style>
</head>

<body>
    
    <div class="correspondence-layout">
        <!-- LEFT: Thread List -->
        <div class="thread-list-container">
            <div class="thread-toolbar">
                <div class="search-container w-full">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="input" placeholder="Search emails...">
                </div>
                <button class="btn btn-outline" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div id="myGrid" class="ag-theme-quartz" style="flex: 1; width: 100%;"></div>
            
            <div class="toolbar" style="border-top: 1px solid var(--gray-200); font-size: 0.75rem; color: var(--text-muted); justify-content: space-between;">
                <span id="totalCount">0 threads</span>
                <span>Last synced: <span id="lastSync">Just now</span></span>
            </div>
        </div>

        <!-- RIGHT: Reading Pane -->
        <div class="reading-pane" id="readingPane">
            <!-- Empty State -->
            <div class="empty-selection" id="emptyState">
                <div class="empty-icon"><i class="fas fa-envelope-open-text"></i></div>
                <h3>Select a thread to view</h3>
                <p>AI analysis will appear here.</p>
            </div>

            <!-- Content (Hidden by default) -->
            <div id="threadContent" style="display: none; height: 100%; flex-direction: column;">
                
                <div class="reading-header">
                    <div>
                        <h2 class="thread-title" id="threadSubject">Subject Line</h2>
                        <div class="thread-meta">
                            <span id="threadParticipants">Participants...</span>
                            <span class="badge badge-teal" id="threadCount">0 emails</span>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-vericase" onclick="generateSummary()" id="btnCatchUp">
                            <i class="fas fa-magic"></i> Catch Up
                        </button>
                    </div>
                </div>

                <!-- AI Summary Section -->
                <div id="aiSummaryBox" class="ai-summary-box">
                    <div class="ai-label">
                        <i class="fas fa-robot"></i> Thread Summary
                    </div>
                    <div class="ai-content" id="summaryText">
                        <!-- AI content goes here -->
                    </div>
                </div>

                <div class="email-stream" id="emailStream">
                    <!-- Emails injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- AG Grid JS -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/dist/ag-grid-enterprise.min.js"></script>

    <script>
        // Init Shell
        document.addEventListener('DOMContentLoaded', () => {
            VericaseShell.inject({
                title: 'Correspondence',
                projectId: VericaseShell.getProjectId()
            });
            
            initGrid();
        });

        // --- Logic ---
        let gridApi;
        let currentThreadId = null;

        // Mock Data
        const mockEmails = [
            {
                id: '1',
                thread_id: 't1',
                subject: 'RE: Extension of Time Claim - Weather Events',
                from_name: 'John Smith',
                from_email: 'john.smith@contractor.com',
                date: '2023-10-15T14:30:00',
                preview: 'Regarding the rainfall data submitted last week...',
                sentiment: 'NEGATIVE',
                attachment_count: 2
            },
            {
                id: '2',
                thread_id: 't2',
                subject: 'Site Inspection Report #45',
                from_name: 'Sarah Jones',
                from_email: 's.jones@architects.co.uk',
                date: '2023-10-14T09:15:00',
                preview: 'Please find attached the report from yesterday\'s visit.',
                sentiment: 'NEUTRAL',
                attachment_count: 1
            },
            {
                id: '3',
                thread_id: 't3',
                subject: 'Variation Order 023 - Approvals',
                from_name: 'Mike Ross',
                from_email: 'mike.ross@client.com',
                date: '2023-10-12T16:45:00',
                preview: 'We have reviewed the costs and they seem excessive.',
                sentiment: 'NEGATIVE',
                attachment_count: 0
            }
        ];

        const gridOptions = {
            rowData: mockEmails,
            columnDefs: [
                { 
                    field: 'subject', 
                    headerName: 'Subject', 
                    flex: 2,
                    cellRenderer: params => {
                        const sentimentColor = params.data.sentiment === 'NEGATIVE' ? '#EF4444' : '#10B981';
                        return `
                            <div style="display:flex; align-items:center; height:100%;">
                                <div style="width:3px; height:100%; background:${sentimentColor}; margin-right:12px;"></div>
                                <div style="display:flex; flex-direction:column; justify-content:center;">
                                    <div style="font-weight:600; line-height:1.2;">${params.value}</div>
                                    <div style="font-size:0.75rem; color:var(--text-muted);">${params.data.preview}</div>
                                </div>
                            </div>
                        `;
                    }
                },
                { 
                    field: 'from_name', 
                    headerName: 'From', 
                    width: 150 
                },
                { 
                    field: 'date', 
                    headerName: 'Date', 
                    width: 120,
                    valueFormatter: p => new Date(p.value).toLocaleDateString() 
                }
            ],
            rowHeight: 70,
            headerHeight: 40,
            onRowClicked: onRowClicked,
            getRowId: params => params.data.id
        };

        function initGrid() {
            const gridDiv = document.querySelector('#myGrid');
            gridApi = agGrid.createGrid(gridDiv, gridOptions);
            document.getElementById('totalCount').textContent = `${mockEmails.length} threads`;
        }

        function onRowClicked(event) {
            loadThread(event.data);
        }

        function loadThread(data) {
            currentThreadId = data.thread_id;
            
            // Hide empty state
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('threadContent').style.display = 'flex';
            document.getElementById('aiSummaryBox').classList.remove('visible'); // Reset AI
            
            // Populate Header
            document.getElementById('threadSubject').textContent = data.subject;
            document.getElementById('threadParticipants').textContent = `${data.from_name} and others`;
            document.getElementById('threadCount').textContent = "3 emails"; // Mock

            // Render Emails (Mock Stream)
            const stream = document.getElementById('emailStream');
            stream.innerHTML = '';
            
            // Mock conversation generation
            const mockMessages = [
                {
                    sender: data.from_name,
                    email: data.from_email,
                    date: data.date,
                    body: `Dear Team,\n\nRegarding the rainfall data submitted last week, we believe this constitutes a Compensation Event under Clause 60.1(13).\n\nThe recorded precipitation exceeded the 1-in-10 year average by 40%.\n\nRegards,\n${data.from_name}`
                },
                {
                    sender: "Project Manager",
                    email: "pm@client.com",
                    date: "2023-10-15T15:00:00",
                    body: `Hi ${data.from_name.split(' ')[0]},\n\nWe are reviewing the Met Office data. Initial assessment suggests the impact on the critical path is minimal.\n\nPlease provide the updated programme.\n\nThanks,\nPM`
                }
            ];

            mockMessages.forEach(msg => {
                const card = document.createElement('div');
                card.className = 'email-card';
                card.innerHTML = `
                    <div class="email-header-row">
                        <div>
                            <div class="sender-name">${msg.sender}</div>
                            <div class="sender-email">${msg.email}</div>
                        </div>
                        <div class="email-date">${new Date(msg.date).toLocaleString()}</div>
                    </div>
                    <div class="email-body">${highlightEntities(msg.body)}</div>
                `;
                stream.appendChild(card);
            });
        }

        // --- AI FEATURES ---

        function generateSummary() {
            const btn = document.getElementById('btnCatchUp');
            const summaryBox = document.getElementById('aiSummaryBox');
            const summaryText = document.getElementById('summaryText');

            // Loading State
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            btn.disabled = true;

            // Simulate API Call
            setTimeout(() => {
                summaryText.innerHTML = `
                    <ul>
                        <li><strong>Dispute:</strong> Contractor is claiming a Compensation Event due to exceptional weather (Clause 60.1(13)).</li>
                        <li><strong>Counter-Argument:</strong> Project Manager argues impact on critical path is unproven.</li>
                        <li><strong>Action:</strong> Updated programme requested from Contractor.</li>
                    </ul>
                `;
                summaryBox.classList.add('visible');
                
                // Reset Button
                btn.innerHTML = '<i class="fas fa-check"></i> Done';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-magic"></i> Catch Up';
                    btn.disabled = false;
                }, 2000);
            }, 1500);
        }

        function highlightEntities(text) {
            // Simple regex mock for entity highlighting
            // In production, this comes from backend metadata
            const entities = ['Clause 60.1', 'Compensation Event', 'Met Office', 'Contractor'];
            let highlighted = text;
            
            entities.forEach(entity => {
                const regex = new RegExp(entity, 'g');
                highlighted = highlighted.replace(regex, `<span class="entity-highlight" title="Legal Term / Entity">${entity}</span>`);
            });
            
            return highlighted;
        }

        function refreshData() {
            if(gridApi) gridApi.showLoadingOverlay();
            setTimeout(() => {
                if(gridApi) gridApi.hideOverlay();
            }, 1000);
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            gridApi.setQuickFilter(e.target.value);
        });

    </script>
</body>
</html>
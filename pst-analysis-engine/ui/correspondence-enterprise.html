<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>VeriCase - Email Correspondence Manager (Enterprise)</title>

  <!-- AG-Grid Enterprise CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/styles/ag-grid.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/styles/ag-theme-quartz.css" />
  <link rel="stylesheet" href="ag-theme-vericase.css?v=2" />

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- VeriCase Design System -->
  <link rel="stylesheet" href="brand-styles.css?v=3" />
  <link rel="stylesheet" href="design-system.css?v=3" />
  <script src="vericase-ui.js"></script>
  <script src="nav-shell.js"></script>

  <!-- DOMPurify for HTML sanitization -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

  <style>
    /* ============================================
           Correspondence Enterprise - Deep Research Aesthetic
           ============================================ */

    :root {
      /* Map local variables to brand styles */
      --primary: var(--vericase-teal);
      --primary-dark: var(--vericase-teal-dark);
      --secondary: var(--text-secondary);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-white: #ffffff;
      --surface: var(--bg-white);
      --background: var(--bg-primary);
      --text: var(--text-primary);
      --text-muted: var(--text-muted);
      --border: var(--gray-200);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      background: var(--background);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    /* ----------------------------------------
           Header - Deep Research Branding
           ---------------------------------------- */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.875rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-sm);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      text-decoration: none;
    }

    .logo .logo-veri {
      color: var(--vericase-teal);
    }

    .logo .logo-case {
      color: var(--vericase-navy);
    }

    .logo i {
      color: var(--vericase-teal);
    }

    .case-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding-left: 2rem;
      border-left: 1px solid var(--border);
    }

    .case-badge {
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Toolbar */
    .toolbar {
      background: var(--surface);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 1rem;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex: 1;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      min-width: 300px;
      flex: 1;
      max-width: 500px;
    }

    .search-box i {
      color: var(--text-muted);
      margin-right: 0.5rem;
    }

    .search-box input {
      border: none;
      background: none;
      outline: none;
      width: 100%;
      font-size: 0.875rem;
    }

    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: var(--background);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-group {
      display: flex;
      border-radius: 0.5rem;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .btn-group .btn {
      border-radius: 0;
      border: none;
      border-right: 1px solid var(--border);
    }

    .btn-group .btn:last-child {
      border-right: none;
    }

    .btn-group .btn.active {
      background: var(--primary);
      color: white;
    }

    /* Statistics Bar - VeriCase Branding */
    .stats-bar {
      background: linear-gradient(135deg,
          var(--vericase-teal) 0%,
          var(--vericase-navy) 100%);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 3rem;
      overflow-x: auto;
      box-shadow: 0 4px 12px rgba(23, 181, 163, 0.2);
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      min-width: max-content;
    }

    .stat-label {
      font-size: 0.75rem;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Grid Container */
    .grid-container {
      flex: 1;
      background: var(--surface);
      position: relative;
    }

    #emailGrid {
      height: 100%;
    }

    /* Detail Panel */
    .detail-panel {
      width: 500px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    .detail-panel.hidden {
      transform: translateX(100%);
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
    }

    .detail-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--background);
    }

    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .email-header {
      margin-bottom: 1.5rem;
    }

    .email-subject {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .email-meta {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .email-meta-item {
      display: flex;
      gap: 0.5rem;
    }

    .email-meta-label {
      font-weight: 500;
      min-width: 60px;
    }

    .email-body {
      background: var(--background);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1rem;
    }

    .email-attachments {
      margin-top: 1.5rem;
    }

    .attachments-header {
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .attachment-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--background);
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .attachment-item:hover {
      background: var(--border);
    }

    .attachment-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
      border-radius: 0.375rem;
    }

    .attachment-info {
      flex: 1;
    }

    .attachment-name {
      font-weight: 500;
      font-size: 0.875rem;
    }

    .attachment-size {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Loading Overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Custom AG-Grid Styles - Moved to ag-theme-vericase.css */

    .ag-cell {
      display: flex;
      align-items: flex-start;
      padding-top: 8px !important;
    }

    /* Make email rows more readable */
    .ag-row {
      border-bottom: 1px solid #f3f4f6;
    }

    /* HTML email content styling in grid */
    .email-html-content {
      font-family:
        -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .email-html-content p {
      margin: 0 0 0.5em 0;
    }

    .email-html-content br {
      line-height: 1.2;
    }

    .email-html-content ul,
    .email-html-content ol {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }

    .email-html-content table {
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .email-html-content td,
    .email-html-content th {
      padding: 2px 4px;
      border: 1px solid #e5e7eb;
    }

    .email-html-content a {
      color: var(--vericase-teal);
      text-decoration: none;
    }

    .email-html-content a:hover {
      text-decoration: underline;
    }

    .ag-row:hover {
      background: var(--ag-row-hover-color) !important;
    }

    .email-thread-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary);
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .attachment-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .priority-high {
      color: var(--danger);
      font-weight: 600;
    }

    .priority-normal {
      color: var(--text-muted);
    }

    /* Context Panel Styles */
    .context-panel {
      width: 380px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition:
        width 0.3s ease,
        opacity 0.3s ease;
      overflow: hidden;
    }

    .context-panel.collapsed {
      width: 48px;
    }

    .context-panel.collapsed .context-panel-content {
      opacity: 0;
      pointer-events: none;
    }

    .context-panel.collapsed .context-toggle-label {
      display: none;
    }

    .context-panel-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg,
          var(--vericase-teal) 0%,
          var(--vericase-teal-dark) 100%);
      color: white;
      min-height: 56px;
    }

    .context-panel-header h3 {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .context-toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .context-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .context-panel-content {
      flex: 1;
      overflow-y: auto;
      transition: opacity 0.2s ease;
    }

    .context-section {
      border-bottom: 1px solid var(--border);
    }

    .context-section-header {
      padding: 0.75rem 1rem;
      background: var(--background);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .context-section-header:hover {
      background: #e2e8f0;
    }

    .context-section-header i {
      transition: transform 0.2s;
    }

    .context-section-header.collapsed i {
      transform: rotate(-90deg);
    }

    .context-section-body {
      padding: 1rem;
    }

    .context-section-body.collapsed {
      display: none;
    }

    /* Quick Link Section */
    .quick-link-dropdown {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
      margin-bottom: 0.5rem;
    }

    .quick-link-dropdown:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(23, 181, 163, 0.1);
    }

    .link-btn {
      width: 100%;
      padding: 0.5rem 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: background 0.2s;
    }

    .link-btn:hover {
      background: var(--primary-dark);
    }

    .link-btn:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    /* Keywords Section */
    .keyword-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .keyword-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .keyword-tag .remove-keyword {
      cursor: pointer;
      opacity: 0.6;
      margin-left: 0.25rem;
    }

    .keyword-tag .remove-keyword:hover {
      opacity: 1;
    }

    .add-keyword-input {
      display: flex;
      gap: 0.5rem;
    }

    .add-keyword-input input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .add-keyword-input input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .add-keyword-input button {
      padding: 0.5rem 0.75rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    /* AI Suggestions Section */
    .suggestion-card {
      background: var(--background);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-left: 3px solid var(--primary);
    }

    .suggestion-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .suggestion-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .suggestion-value {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text);
    }

    .suggestion-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .suggestion-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }

    .suggestion-btn.accept {
      background: var(--success);
      color: white;
    }

    .suggestion-btn.dismiss {
      background: var(--background);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    /* Selected Email Preview */
    .selected-preview {
      background: var(--background);
      border-radius: 8px;
      padding: 0.75rem;
    }

    .selected-preview-subject {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .selected-preview-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .selected-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      margin-left: 0.5rem;
    }

    /* Stakeholder Tags */
    .stakeholder-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: #fef3c7;
      color: #92400e;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    /* Empty State */
    .context-empty-state {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-muted);
    }

    .context-empty-state i {
      font-size: 2rem;
      opacity: 0.5;
      margin-bottom: 0.5rem;
    }

    .context-empty-state p {
      font-size: 0.875rem;
    }
  </style>
  <script src="config.js"></script>
  <script src="app-state.js"></script>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <img src="assets/LOGOTOBEUSED.png" alt="VeriCase"
          style="height: 32px; margin-right: 12px; vertical-align: middle" />
        <i class="fas fa-envelope-open-text"></i>
        <span>VeriCase Correspondence</span>
      </div>
      <div class="case-info">
        <span class="case-badge" id="caseNumber">Loading...</span>
        <span id="caseName">Loading case details...</span>
      </div>
    </div>
    <div class="header-right">
      <button class="btn" onclick="goToDashboard()">
        <i class="fas fa-home"></i> Dashboard
      </button>
      <button class="btn" onclick="window.location.href = 'deep-research.html'" style="
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            color: white;
            border: none;
          ">
        <i class="fas fa-atom"></i> Deep Research
      </button>
      <button class="btn" onclick="exportToExcel()">
        <i class="fas fa-file-excel"></i> Export Excel
      </button>
      <button class="btn" onclick="printEmails()">
        <i class="fas fa-print"></i> Print
      </button>
      <button class="btn btn-primary" onclick="refreshData()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  </div>

  <!-- AI Chat Interface -->
  <div id="aiChatContainer" style="
        background: white;
        border-bottom: 2px solid var(--vericase-teal);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 1.5rem 2rem;
        display: none;
      ">
    <div style="max-width: 1400px; margin: 0 auto">
      <div style="
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
          ">
        <div style="
              width: 48px;
              height: 48px;
              background: linear-gradient(
                135deg,
                var(--vericase-teal),
                var(--vericase-teal-dark)
              );
              border-radius: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              box-shadow: 0 4px 14px rgba(23, 181, 163, 0.39);
            ">
          <i class="fas fa-brain" style="color: white; font-size: 24px"></i>
        </div>
        <div style="flex: 1">
          <h3 style="
                color: var(--vericase-navy);
                font-size: 1.25rem;
                margin-bottom: 0.25rem;
              ">
            AI Research Assistant
          </h3>
          <p style="color: var(--text-muted); font-size: 0.875rem">
            Ask questions about your evidence. Choose Quick Search or Deep
            Research mode.
          </p>
        </div>
        <button onclick="toggleAIChat()" style="
              background: transparent;
              border: none;
              color: var(--text-muted);
              cursor: pointer;
              font-size: 1.5rem;
              padding: 0.5rem;
            ">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="display: flex; gap: 1rem; margin-bottom: 1rem">
        <div style="flex: 1; position: relative">
          <label for="aiQuery"></label><textarea id="aiQuery"
            placeholder="Ask a question about your evidence... e.g., 'What are the key delay events?' or 'Summarize the dispute timeline'"
            style="
                width: 100%;
                min-height: 80px;
                padding: 1rem;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                font-size: 0.9375rem;
                font-family: inherit;
                resize: vertical;
              " onkeydown="
                if (event.key === 'Enter' && event.ctrlKey) aiQuickSearch();
              "></textarea>
          <div style="
                position: absolute;
                bottom: 0.75rem;
                right: 0.75rem;
                font-size: 0.75rem;
                color: var(--text-muted);
              ">
            Ctrl+Enter for Quick Search
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 1rem; align-items: center">
        <button id="quickSearchBtn" onclick="aiQuickSearch()" class="btn" style="
              background: var(--vericase-teal);
              color: white;
              padding: 0.75rem 1.5rem;
              border: none;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              box-shadow: 0 4px 14px rgba(23, 181, 163, 0.39);
            ">
          <i class="fas fa-bolt"></i> Quick Search (3s)
        </button>
        <button id="deepResearchBtn" onclick="aiDeepResearch()" class="btn" style="
              background: var(--vericase-navy);
              color: white;
              padding: 0.75rem 1.5rem;
              border: none;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            ">
          <i class="fas fa-microscope"></i> Deep Research (60s)
        </button>
        <div id="aiModelsStatus" style="
              margin-left: auto;
              font-size: 0.75rem;
              color: var(--text-muted);
            "></div>
      </div>

      <!-- Research Progress -->
      <div id="researchProgress" style="
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
          ">
        <div style="
              display: flex;
              align-items: center;
              gap: 1rem;
              margin-bottom: 1rem;
            ">
          <div class="loading-spinner"></div>
          <div>
            <div style="
                  font-weight: 600;
                  color: var(--vericase-navy);
                  margin-bottom: 0.25rem;
                " id="progressTitle">
              Analyzing...
            </div>
            <div style="font-size: 0.875rem; color: var(--text-muted)" id="progressStatus">
              Preparing research plan...
            </div>
          </div>
        </div>
        <div id="researchPlan" style="
              display: none;
              margin-top: 1rem;
              padding: 1rem;
              background: white;
              border-radius: 8px;
              border-left: 4px solid var(--vericase-teal);
            "></div>
        <div id="modelProgress" style="display: none; margin-top: 1rem"></div>
      </div>

      <!-- AI Response -->
      <div id="aiResponse" style="
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            border: 2px solid var(--vericase-teal);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
          "></div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="btn btn-primary" onclick="toggleAIChat()" style="background: var(--vericase-teal); border: none">
        <i class="fas fa-brain"></i> AI Assistant
      </button>
      <div class="search-box">
        <i class="fas fa-search"></i>
        <label for="quickFilter"></label><input type="text" id="quickFilter" placeholder="Quick search emails..."
          onkeyup="onQuickFilterChanged()" />
      </div>
      <button class="btn" onclick="toggleAdvancedFilter()">
        <i class="fas fa-filter"></i> Advanced Filter
      </button>
      <button class="btn" onclick="showStakeholderFilter()">
        <i class="fas fa-users"></i> Stakeholders
      </button>
      <button class="btn" onclick="showKeywordFilter()">
        <i class="fas fa-tags"></i> Keywords
      </button>
      <button class="btn btn-primary" onclick="openRefinementWizard()">
        <i class="fas fa-wand-magic-sparkles"></i> AI Refinement Wizard
      </button>
      <button class="btn" id="toggleExcludedBtn" onclick="toggleExcludedEmails()" title="Show/hide emails excluded by refinement">
        <i class="fas fa-eye-slash" id="excludedIcon"></i> <span id="excludedLabel">Excluded Hidden</span>
      </button>
      <button class="btn" id="toggleViewBtn" onclick="toggleAllEmails()">
        <i class="fas fa-compress"></i> Preview Mode
      </button>
      <button class="btn" onclick="openProgrammeModal()">
        <i class="fas fa-project-diagram"></i> Programmes
      </button>
    </div>
    <div class="toolbar-right">
      <div class="btn-group">
        <button class="btn active" onclick="setViewMode('all')">
          <i class="fas fa-inbox"></i> All
        </button>
        <button class="btn" onclick="setViewMode('threads')">
          <i class="fas fa-comments"></i> Threads
        </button>
        <button class="btn" onclick="setViewMode('attachments')">
          <i class="fas fa-paperclip"></i> With Attachments
        </button>
      </div>
      <button class="btn" onclick="toggleDetailPanel()">
        <i class="fas fa-sidebar"></i> Details
      </button>
    </div>
  </div>

  <!-- Statistics Bar -->
  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-label">Total Emails</span>
      <span class="stat-value" id="totalEmails">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Unique Threads</span>
      <span class="stat-value" id="uniqueThreads">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">With Attachments</span>
      <span class="stat-value" id="withAttachments">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Date Range</span>
      <span class="stat-value" id="dateRange">-</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Selected</span>
      <span class="stat-value" id="selectedCount">0</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- AG-Grid Container -->
    <div class="grid-container">
      <div id="emailGrid" class="ag-theme-quartz ag-theme-vericase"></div>
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- Attachment Preview Modal -->
    <div id="attachmentPreviewModal" style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 10000;
          justify-content: center;
          align-items: center;
        ">
      <div style="
            background: white;
            width: 90%;
            height: 90%;
            max-width: 1200px;
            border-radius: 10px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
          ">
        <div style="
              padding: 15px 20px;
              border-bottom: 1px solid #e5e7eb;
              display: flex;
              justify-content: space-between;
              align-items: center;
            ">
          <h3 id="previewTitle" style="margin: 0; color: #1f2937; font-size: 1.1rem">
            Attachment Preview
          </h3>
          <button onclick="closeAttachmentPreview()" style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
              ">
            ‚úï Close
          </button>
        </div>
        <div id="previewContent" style="flex: 1; overflow: auto; padding: 20px; position: relative">
          <!-- Preview content will be loaded here -->
        </div>
        <div style="
              padding: 10px 20px;
              border-top: 1px solid #e5e7eb;
              display: flex;
              justify-content: flex-end;
              gap: 10px;
            ">
          <button id="downloadBtn" onclick="downloadCurrentAttachment()" style="
                background: #3b82f6;
                color: white;
                border: none;
                padding: 8px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 500;
              ">
            ‚¨á Download
          </button>
        </div>
      </div>
    </div>

    <!-- Programme Upload Modal -->
    <div id="programmeModal" class="modal" style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 2000;
          align-items: center;
          justify-content: center;
        ">
      <div style="
            background: white;
            width: 500px;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          ">
        <h2 style="margin-bottom: 1.5rem">Manage Programmes</h2>

        <div style="margin-bottom: 1.5rem">
          <label for="programmeFileInput" style="display: block; margin-bottom: 0.5rem; font-weight: 500">Upload Programme (Asta XML or
            Excel)</label>
          <input type="file" id="programmeFileInput" accept=".xml,.xlsx,.xls" style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
              " />
          <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280">
            Supported formats: Asta Powerproject (.xml), Excel (.xlsx, .xls)
          </div>
        </div>

        <div style="margin-bottom: 1.5rem">
          <label for="programmeTypeInput" style="display: block; margin-bottom: 0.5rem; font-weight: 500">Programme Type</label>
          <select id="programmeTypeInput" style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
              ">
            <option value="baseline">Baseline / As-Planned</option>
            <option value="as_built">As-Built / Actual</option>
          </select>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 1rem">
          <button class="btn" onclick="closeProgrammeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="uploadProgramme()">
            Upload
          </button>
        </div>

        <div id="programmeUploadStatus" style="margin-top: 1rem; font-size: 0.875rem"></div>
      </div>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel hidden" id="detailPanel">
      <div class="detail-header">
        <h3>Email Details</h3>
        <button class="btn" onclick="toggleDetailPanel()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="detail-content" id="detailContent">
        <p style="
              color: var(--text-muted);
              text-align: center;
              margin-top: 2rem;
            ">
          Select an email to view details
        </p>
      </div>
    </div>

    <!-- Context Panel (Right Sidebar) -->
    <div class="context-panel" id="contextPanel">
      <div class="context-panel-header">
        <h3>
          <i class="fas fa-layer-group"></i>
          <span class="context-toggle-label">Actions & Context</span>
        </h3>
        <button class="context-toggle-btn" onclick="toggleContextPanel()" title="Toggle panel">
          <i class="fas fa-chevron-right" id="contextToggleIcon"></i>
        </button>
      </div>
      <div class="context-panel-content">
        <!-- Selection Info -->
        <div class="context-section" id="selectionSection">
          <div class="context-section-header" onclick="toggleContextSection('selection')">
            <span><i class="fas fa-check-square"></i> Selected Emails
              <span class="selected-count-badge" id="contextSelectedCount">0</span></span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="context-section-body" id="selectionBody">
            <div id="selectedEmailsPreview">
              <div class="context-empty-state">
                <i class="fas fa-mouse-pointer"></i>
                <p>Select emails to see preview and take actions</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Link Section -->
        <div class="context-section" id="quickLinkSection">
          <div class="context-section-header" onclick="toggleContextSection('quickLink')">
            <span><i class="fas fa-link"></i> Quick Link</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="context-section-body" id="quickLinkBody">
            <label for="linkTypeSelect"></label><select class="quick-link-dropdown" id="linkTypeSelect"
              onchange="onLinkTypeChange()">
              <option value="">Select link type...</option>
              <option value="matter">Link to Contentious Matter</option>
              <option value="claim">Link to Head of Claim</option>
            </select>
            <label for="linkTargetSelect"></label><select class="quick-link-dropdown" id="linkTargetSelect"
              style="display: none">
              <option value="">Select target...</option>
            </select>
            <button class="link-btn" id="linkSelectedBtn" onclick="linkSelectedEmails()" disabled>
              <i class="fas fa-link"></i> Link Selected Emails
            </button>
            <div style="margin-top: 0.75rem; text-align: center">
              <button class="btn" style="font-size: 0.75rem; padding: 0.375rem 0.75rem"
                onclick="openCreateMatterModal()">
                <i class="fas fa-plus"></i> Create New Matter
              </button>
            </div>
          </div>
        </div>

        <!-- Keywords Section -->
        <div class="context-section" id="keywordsSection">
          <div class="context-section-header" onclick="toggleContextSection('keywords')">
            <span><i class="fas fa-tags"></i> Project Keywords</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="context-section-body" id="keywordsBody">
            <div class="keyword-list" id="contextKeywordList">
              <!-- Keywords will be loaded here -->
            </div>
            <div class="add-keyword-input">
              <label for="newKeywordInput"></label><input type="text" id="newKeywordInput" placeholder="Add keyword..."
                onkeypress="
                    if (event.key === 'Enter') addKeywordFromContext();
                  " />
              <button onclick="addKeywordFromContext()">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div style="margin-top: 0.75rem">
              <button class="btn" style="width: 100%; font-size: 0.75rem" onclick="suggestKeywordsFromSelection()">
                <i class="fas fa-wand-magic-sparkles"></i> Suggest from
                Selection
              </button>
            </div>
          </div>
        </div>

        <!-- Stakeholders Section -->
        <div class="context-section" id="stakeholdersSection">
          <div class="context-section-header" onclick="toggleContextSection('stakeholders')">
            <span><i class="fas fa-users"></i> Stakeholders</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="context-section-body" id="stakeholdersBody">
            <div id="contextStakeholderList" style="display: flex; flex-wrap: wrap; gap: 0.5rem">
              <!-- Stakeholders will be loaded here -->
            </div>
            <div style="margin-top: 0.75rem">
              <button class="btn" style="width: 100%; font-size: 0.75rem" onclick="openRefinementWizard()">
                <i class="fas fa-cog"></i> Manage Stakeholders
              </button>
            </div>
          </div>
        </div>

        <!-- AI Suggestions Section -->
        <div class="context-section" id="suggestionsSection">
          <div class="context-section-header" onclick="toggleContextSection('suggestions')">
            <span><i class="fas fa-lightbulb"></i> AI Suggestions</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="context-section-body" id="suggestionsBody">
            <div id="aiSuggestionsList">
              <div class="context-empty-state">
                <i class="fas fa-robot"></i>
                <p>
                  Select emails to get AI suggestions for category and linking
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Actions Section -->
        <div class="context-section" id="bulkActionsSection">
          <div class="context-section-header" onclick="toggleContextSection('bulkActions')">
            <span><i class="fas fa-tasks"></i> Bulk Actions</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="context-section-body" id="bulkActionsBody">
            <div style="display: flex; flex-direction: column; gap: 0.5rem">
              <button class="btn" onclick="bulkSetCategory()" style="justify-content: flex-start">
                <i class="fas fa-folder"></i> Set Category
              </button>
              <button class="btn" onclick="bulkAddKeywords()" style="justify-content: flex-start">
                <i class="fas fa-tag"></i> Add Keywords
              </button>
              <button class="btn" onclick="bulkExportSelected()" style="justify-content: flex-start">
                <i class="fas fa-file-export"></i> Export Selected
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AG-Grid Enterprise Script -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/dist/ag-grid-enterprise.min.js"></script>

  <script>
    // Use centralized configuration
    const API_BASE = window.VeriCaseConfig
      ? window.VeriCaseConfig.apiUrl
      : window.location.origin;
    console.log("Correspondence using API URL:", API_BASE);

    // Initialize VeriCaseApp - it will handle URL params and default project
    let caseId = null;
    let projectId = null;
    const isAdmin = true; // Open access mode

    // Promise-based grid ready mechanism (no polling)
    let gridApi;
    let resolveGridReady;
    const gridReadyPromise = new Promise((resolve) => {
      resolveGridReady = resolve;
    });

    // Initialize state immediately
    (async function initState() {
      await VeriCaseApp.init();
      caseId = VeriCaseApp.caseId;
      projectId = VeriCaseApp.projectId;
      window.caseId = caseId; // Make it globally available for other functions
      console.log(
        "VeriCaseApp initialized - projectId:",
        projectId,
        "caseId:",
        caseId,
      );

      // Update URL if needed (so bookmarks work)
      VeriCaseApp.updateUrl();

      // Wait for grid to be ready using promise (no polling)
      await gridReadyPromise;
      console.log(
        "[Correspondence] Grid ready, refreshing with project:",
        projectId,
      );
      gridApi.refreshServerSide({ purge: true });
    })();
    let columnApi;
    let allEmails = [];
    let currentViewMode = "all";
    let showFullContent = true; // Default to showing full content
    let hideExcludedEmails = true; // Default to hiding excluded emails

    // Column Definitions with Enterprise Features
    let columnDefs = [
      {
        headerName: "",
        field: "selection",
        width: 50,
        checkboxSelection: true,
        headerCheckboxSelection: true,
        pinned: "left",
      },
      {
        headerName: "Date/Time",
        field: "email_date",
        width: 180,
        sort: "desc",
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "vertical-align": "top",
          "text-align": "center",
          "padding-top": "8px",
          "padding-bottom": "8px",
        },
        cellRenderer: (params) => {
          if (!params.value) return "-";
          const date = new Date(params.value);
          return `
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <span style="font-weight: 500;">${date.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted);">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    `;
        },
        filter: "agDateColumnFilter",
        filterParams: {
          comparator: (filterDate, cellValue) => {
            const cellDate = new Date(cellValue);
            if (cellDate < filterDate) return -1;
            if (cellDate > filterDate) return 1;
            return 0;
          },
        },
      },
      {
        headerName: "From",
        field: "email_from",
        width: 200,
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "white-space": "normal",
          "line-height": "1.4",
          "padding-top": "8px",
          "padding-bottom": "8px",
        },
        filter: "agSetColumnFilter",
        filterParams: {
          buttons: ["apply", "clear", "reset"],
        },
      },
      {
        headerName: "To",
        field: "email_to",
        width: 220,
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "white-space": "normal",
          "line-height": "1.4",
          "padding-top": "8px",
          "padding-bottom": "8px",
        },
        valueGetter: (params) => {
          // Use recipients_to (includes email) if available, fallback to email_to
          const to = params.data.recipients_to || params.data.email_to;
          if (!to || to === "-") return "-";
          if (Array.isArray(to)) return to.join(", ");
          return to;
        },
        filter: "agSetColumnFilter",
        filterParams: {
          buttons: ["apply", "clear", "reset"],
        },
      },
      {
        headerName: "CC",
        field: "email_cc",
        width: 200,
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "white-space": "normal",
          "line-height": "1.4",
          "padding-top": "8px",
          "padding-bottom": "8px",
        },
        valueGetter: (params) => {
          // Use recipients_cc (includes email) if available, fallback to email_cc
          const cc = params.data.recipients_cc || params.data.email_cc;
          if (!cc || cc === "-") return "-";
          if (Array.isArray(cc)) return cc.join(", ");
          return cc;
        },
        filter: "agSetColumnFilter",
        filterParams: {
          buttons: ["apply", "clear", "reset"],
        },
      },
      {
        headerName: "Attachments",
        field: "attachments",
        width: 250,
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "white-space": "normal",
          "line-height": "1.4",
          "padding-top": "8px",
          "padding-bottom": "8px",
        },
        valueGetter: (params) => {
          // Get attachments from both direct field and meta field
          const attachments =
            params.data.attachments || params.data.meta?.attachments || [];
          // Filter out embedded images (logos, signatures, tracking pixels)
          const realAttachments = attachments.filter(
            (att) => !isEmbeddedImage(att),
          );
          if (realAttachments.length === 0) return "None";
          // Show count and first few names
          const names = realAttachments
            .map((att) => att.filename || att.name || "File")
            .slice(0, 3);
          const suffix =
            realAttachments.length > 3
              ? ` (+${realAttachments.length - 3} more)`
              : "";
          return `üìé ${names.join(", ")}${suffix}`;
        },
        cellRenderer: (params) => {
          // Get attachments from both direct field and meta field
          const attachments =
            params.data.attachments || params.data.meta?.attachments || [];
          // Filter out embedded images (logos, signatures, tracking pixels)
          const realAttachments = attachments.filter(
            (att) => !isEmbeddedImage(att),
          );

          if (realAttachments.length === 0)
            return '<span style="color:#9ca3af;">None</span>';

          const rowId = params.node.id;
          const evidenceId = params.data.id;

          // Create clickable attachment links
          const attachmentLinks = realAttachments
            .map((att, index) => {
              const fileName = att.filename || att.name || "Unnamed";
              const fileExt = fileName.split(".").pop().toLowerCase();
              const attachmentId = att.id || index;

              // Determine if file can be previewed
              const previewableTypes = [
                "pdf",
                "jpg",
                "jpeg",
                "png",
                "gif",
                "txt",
                "csv",
                "doc",
                "docx",
                "xls",
                "xlsx",
              ];
              const canPreview = previewableTypes.includes(fileExt);

              // Choose icon based on file type
              let icon = "üìé"; // Default paperclip
              if (["pdf"].includes(fileExt)) icon = "üìÑ";
              else if (["jpg", "jpeg", "png", "gif"].includes(fileExt))
                icon = "üñºÔ∏è";
              else if (["doc", "docx"].includes(fileExt)) icon = "üìù";
              else if (["xls", "xlsx", "csv"].includes(fileExt)) icon = "üìä";
              else if (["txt"].includes(fileExt)) icon = "üìÉ";

              return `
                            <div style="display: inline-flex; align-items: center; gap: 4px; margin: 2px 4px 2px 0;">
                                <span style="font-size: 0.9em;">${icon}</span>
                                <span style="color: #2563eb; text-decoration: underline; cursor: pointer; font-size: 0.875rem;"
                                      onclick="${canPreview ? `previewAttachment('${evidenceId}', '${attachmentId}', '${fileName}')` : `downloadAttachment('${evidenceId}', '${attachmentId}', '${fileName}')`}"
                                      title="${canPreview ? "Click to preview" : "Click to download"}">
                                    ${fileName}
                                </span>
                            </div>
                        `;
            })
            .join("");

          return `<div style="display: flex; flex-wrap: wrap; align-items: center;">${attachmentLinks}</div>`;
        },
        filter: "agTextColumnFilter",
      },
      {
        headerName: "Refinement",
        field: "refinement_status",
        width: 140,
        valueGetter: (params) => {
          const meta = params.data.meta || {};
          if (meta.ai_excluded) {
            const reason = meta.ai_exclude_reason || "excluded";
            if (reason.startsWith("spam:")) return "Spam";
            if (reason.startsWith("other_project:")) return "Other Project";
            if (reason === "duplicate") return "Duplicate";
            if (reason.startsWith("excluded_person:")) return "Excluded Person";
            return "Excluded";
          }
          return "";
        },
        cellRenderer: (params) => {
          if (!params.value) return "";
          const colorMap = {
            "Spam": "#ef4444",
            "Other Project": "#f59e0b",
            "Duplicate": "#8b5cf6",
            "Excluded Person": "#ec4899",
            "Excluded": "#6b7280"
          };
          const color = colorMap[params.value] || "#6b7280";
          return `<span style="background:${color}; color:white; padding:2px 8px; border-radius:4px; font-size:0.75rem;">${params.value}</span>`;
        },
        filter: "agSetColumnFilter",
        filterParams: {
          buttons: ["apply", "clear", "reset"],
        },
      },
      {
        headerName: "Baseline Activity",
        field: "baseline_activity",
        width: 200,
        filter: "agTextColumnFilter",
        editable: true,
        cellEditor: "agLargeTextCellEditor",
        cellRenderer: (params) => {
          if (!params.value)
            return '<span style="color: #9ca3af; font-style: italic;">Click to assign</span>';
          return params.value;
        },
      },
      {
        headerName: "As-Built Activity",
        field: "as_built_activity",
        width: 200,
        filter: "agTextColumnFilter",
        editable: true,
        cellEditor: "agLargeTextCellEditor",
        cellRenderer: (params) => {
          if (!params.value)
            return '<span style="color: #9ca3af; font-style: italic;">Click to assign</span>';
          return params.value;
        },
      },
      {
        headerName: "Slippage",
        field: "delay_days",
        width: 120,
        filter: "agNumberColumnFilter",
        cellRenderer: (params) => {
          if (params.value === null || params.value === undefined) return "-";
          const days = parseInt(params.value);
          if (days > 0)
            return `<span style="color: #ef4444; font-weight: 600;">+${days} days</span>`;
          if (days < 0)
            return `<span style="color: #10b981; font-weight: 600;">${days} days</span>`;
          return `<span style="color: #6b7280;">On Time</span>`;
        },
      },
      {
        headerName: "Subject",
        field: "email_subject",
        flex: 1,
        minWidth: 300,
        cellRenderer: (params) => {
          const thread = params.data.thread_id
            ? `<span class="email-thread-indicator"><i class="fas fa-reply"></i> Thread</span>`
            : "";

          return `
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="flex: 1;">${params.value || "(No Subject)"}</span>
                            ${thread}
                        </div>
                    `;
        },
        filter: "agTextColumnFilter",
        filterParams: {
          filterOptions: [
            "contains",
            "notContains",
            "equals",
            "startsWith",
            "endsWith",
          ],
          defaultOption: "contains",
        },
      },
      {
        headerName: "Message",
        field: "email_body",
        flex: 4,
        minWidth: 600,
        autoHeight: true,
        wrapText: true,
        valueGetter: (params) => {
          // Return HTML content if available, otherwise fall back to text
          return {
            html: params.data.body_html || null,
            text: params.data.body_text_clean || params.data.body_text || "",
          };
        },
        cellRenderer: (params) => {
          const emailData = params.value || { html: null, text: "" };
          const htmlContent = emailData.html;
          const textContent = emailData.text;

          // Clean and prepare content for display
          const prepareForDisplay = (html, text) => {
            // If we have HTML content, sanitize and use it
            if (html && typeof DOMPurify !== "undefined") {
              // Remove EXTERNAL EMAIL warnings first (before sanitizing)
              let cleanedHtml = html;

              // Remove EXTERNAL EMAIL warning tables/divs
              cleanedHtml = cleanedHtml.replace(
                /<table[^>]*>[\s\S]*?EXTERNAL[\s\S]*?EMAIL[\s\S]*?<\/table>/gi,
                "",
              );
              cleanedHtml = cleanedHtml.replace(
                /<div[^>]*(?:background|border|style)[^>]*>[\s\S]*?EXTERNAL[\s\S]*?EMAIL[\s\S]*?<\/div>/gi,
                "",
              );
              cleanedHtml = cleanedHtml.replace(
                /<div[^>]*>[\s\S]*?EXTERNAL EMAIL[\s\S]*?<\/div>/gi,
                "",
              );
              cleanedHtml = cleanedHtml.replace(
                /<p[^>]*>[\s\S]*?EXTERNAL EMAIL[\s\S]*?<\/p>/gi,
                "",
              );
              cleanedHtml = cleanedHtml.replace(
                /EXTERNAL EMAIL:?\s*&nbsp;?\s*Don't click links or open attachments[^<]*/gi,
                "",
              );
              cleanedHtml = cleanedHtml.replace(
                /Don't click links or open attachments unless the content is expected and known to be safe\.?/gi,
                "",
              );
              cleanedHtml = cleanedHtml.replace(
                /EXTERNAL EMAIL:?[^<]*/gi,
                "",
              );
              cleanedHtml = cleanedHtml.replace(
                /Aconex Email Notification[^<]*/gi,
                "",
              );

              // Remove common signature delimiters and everything after
              const signaturePatterns = [
                /<div[^>]*class="[^"]*signature[^"]*"[^>]*>[\s\S]*$/i,
                /<table[^>]*class="[^"]*signature[^"]*"[^>]*>[\s\S]*$/i,
                /\n--\s*<br[\s\S]*$/i,
                /<br[^>]*>--<br[\s\S]*$/i,
                /<div[^>]*>_{10,}[\s\S]*$/,
                /<p[^>]*>Regards,?<\/p>[\s\S]*$/i,
                /<p[^>]*>Kind regards,?<\/p>[\s\S]*$/i,
                /<div[^>]*>Sent from my iPhone[\s\S]*$/i,
                /<div[^>]*>Get Outlook for[\s\S]*$/i,
              ];

              for (const pattern of signaturePatterns) {
                cleanedHtml = cleanedHtml.replace(pattern, "");
              }

              // Remove empty elements
              cleanedHtml = cleanedHtml.replace(
                /<(p|div|span)[^>]*>\s*(&nbsp;|\s)*<\/\1>/gi,
                "",
              );
              cleanedHtml = cleanedHtml.replace(/^(\s*<br\s*\/?>\s*)+/gi, "");

              // Sanitize the HTML
              const sanitized = DOMPurify.sanitize(cleanedHtml, {
                ALLOWED_TAGS: [
                  "p",
                  "br",
                  "b",
                  "strong",
                  "i",
                  "em",
                  "u",
                  "span",
                  "div",
                  "ul",
                  "ol",
                  "li",
                  "a",
                  "table",
                  "tr",
                  "td",
                  "th",
                  "tbody",
                  "thead",
                ],
                ALLOWED_ATTR: ["href", "style", "class"],
                FORBID_TAGS: ["script", "iframe", "object", "embed", "img"],
                FORBID_ATTR: ["onclick", "onerror", "onload"],
              });

              return { isHtml: true, content: sanitized.trim() };
            }

            // Fall back to text content
            if (!text)
              return { isHtml: false, content: "No content available" };

            let cleaned = text;
            cleaned = cleaned.replace(/<[^>]*>/g, " ");

            // Remove EXTERNAL EMAIL warnings from text
            cleaned = cleaned.replace(
              /EXTERNAL EMAIL:?\s*Don't click links or open attachments[^.]*\./gi,
              "",
            );
            cleaned = cleaned.replace(
              /Don't click links or open attachments unless the content is expected and known to be safe\.?/gi,
              "",
            );
            cleaned = cleaned.replace(/EXTERNAL EMAIL:?[^.]*\./gi, "");
            cleaned = cleaned.replace(/Aconex Email Notification\s*/gi, "");

            // Remove signature markers
            const textSignatureMarkers = [
              /\n--\s*\n[\s\S]*/,
              /\nRegards,?\s*\n[\s\S]*/i,
              /\nKind regards,?\s*\n[\s\S]*/i,
              /\nBest regards,?\s*\n[\s\S]*/i,
            ];

            for (const marker of textSignatureMarkers) {
              cleaned = cleaned.replace(marker, "");
            }

            cleaned = cleaned.replace(/\s+/g, " ").trim();
            cleaned = cleaned.replace(/&nbsp;/g, " ");
            cleaned = cleaned.replace(/\[cid:[^\]]+\]/g, "");

            return { isHtml: false, content: cleaned };
          };

          const { isHtml, content } = prepareForDisplay(
            htmlContent,
            textContent,
          );

          if (isHtml) {
            // Render sanitized HTML content
            return `
                            <div class="email-html-content" style="padding: 8px; font-size: 0.85rem; line-height: 1.5; color: #374151; 
                                        max-height: 130px; overflow-y: auto;">
                                ${content}
                            </div>
                        `;
          } else {
            // Show more text content (up to 800 chars) with scroll
            const maxLength = 800;
            const displayText =
              content.length > maxLength
                ? content.substring(0, maxLength) + "..."
                : content;

            return `
                            <div style="padding: 8px; font-size: 0.85rem; line-height: 1.5; color: #374151; 
                                        max-height: 130px; overflow-y: auto; white-space: pre-wrap;">
                                ${displayText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
                            </div>
                        `;
          }
        },
        filter: "agTextColumnFilter",
      },

      {
        headerName: "Programme Activity",
        field: "programme_activity",
        width: 250,
        editable: true,
        cellRenderer: (params) => {
          const activity = params.value || params.data.linked_activity;
          if (!activity) {
            return `<div style="color: #9ca3af; font-style: italic; cursor: pointer;" 
                                    onclick="linkActivityToEmail('${params.data.id}')">
                                    + Link to programme activity
                                </div>`;
          }

          return `<div style="display: flex; align-items: center; gap: 8px; cursor: pointer;"
                                 onclick="viewProgrammeAnalysis('${params.data.id}', '${activity}')">
                        <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; 
                                   border-radius: 6px; font-size: 0.875rem; font-weight: 500;">
                            ${activity}
                        </span>
                        <i class="fas fa-chart-gantt" style="color: #3b82f6;"></i>
                    </div>`;
        },
        filter: "agTextColumnFilter",
        filterParams: {
          filterOptions: ["contains", "equals"],
          defaultOption: "contains",
        },
      },

      {
        headerName: "Baseline vs Actual",
        field: "programme_variance",
        width: 180,
        cellRenderer: (params) => {
          // This will be calculated from uploaded Asta programmes
          const emailDate = params.data.email_date
            ? new Date(params.data.email_date)
            : null;
          const activity =
            params.data.programme_activity || params.data.linked_activity;

          if (!emailDate || !activity) {
            return '<span style="color: #9ca3af;">-</span>';
          }

          // Get programme data from API (to be implemented)
          const baselineData = params.data.baseline_programme;
          const asBuiltData = params.data.asbuilt_programme;

          if (!baselineData || !asBuiltData) {
            return `<div style="color: #9ca3af; font-size: 0.875rem;">
                            <i class="fas fa-upload"></i> Upload programmes
                        </div>`;
          }

          // Calculate variance (positive = ahead, negative = behind)
          const variance = asBuiltData.days_variance || 0;
          const isDelayed = variance < 0;
          const isAhead = variance > 0;

          if (variance === 0) {
            return `<div style="display: flex; align-items: center; gap: 6px; color: #059669;">
                            <i class="fas fa-check-circle"></i>
                            <span style="font-weight: 500;">On Track</span>
                        </div>`;
          }

          const color = isDelayed ? "#dc2626" : "#059669";
          const icon = isDelayed ? "fa-exclamation-triangle" : "fa-arrow-up";
          const absVariance = Math.abs(variance);

          return `<div style="display: flex; align-items: center; gap: 6px; color: ${color};">
                        <i class="fas ${icon}"></i>
                        <span style="font-weight: 600;">${isDelayed ? "-" : "+"}${absVariance} days</span>
                    </div>`;
        },
        filter: "agNumberColumnFilter",
        filterParams: {
          filterOptions: ["equals", "lessThan", "greaterThan"],
          defaultOption: "lessThan",
        },
      },

      {
        headerName: "Critical Path",
        field: "is_critical_path",
        width: 120,
        cellRenderer: (params) => {
          const isCritical = params.value || params.data.on_critical_path;
          if (!isCritical) return "-";

          return `<div style="display: flex; align-items: center; justify-content: center; gap: 6px; 
                                 background: #fee2e2; color: #991b1b; padding: 4px 12px; 
                                 border-radius: 12px; font-weight: 600; font-size: 0.875rem;">
                        <i class="fas fa-fire"></i>
                        <span>CRITICAL</span>
                    </div>`;
        },
        filter: "agSetColumnFilter",
        filterParams: {
          values: ["Yes", "No"],
          buttons: ["apply", "clear"],
        },
      },

      {
        headerName: "Programme Status",
        field: "programme_status",
        width: 150,
        cellRenderer: (params) => {
          const emailDate = params.data.email_date
            ? new Date(params.data.email_date)
            : null;
          const activity =
            params.data.programme_activity || params.data.linked_activity;

          if (!emailDate || !activity) return "-";

          // Get activity status at email date from Asta data
          const status = params.data.activity_status_at_date || "Unknown";

          const statusConfig = {
            "Not Started": { icon: "‚è∏Ô∏è", bg: "#f3f4f6", text: "#374151" },
            "In Progress": { icon: "üîÑ", bg: "#dbeafe", text: "#1e40af" },
            Complete: { icon: "‚úÖ", bg: "#d1fae5", text: "#065f46" },
            Delayed: { icon: "‚ö†Ô∏è", bg: "#fee2e2", text: "#991b1b" },
            Unknown: { icon: "‚ùì", bg: "#f3f4f6", text: "#6b7280" },
          };

          const config = statusConfig[status] || statusConfig["Unknown"];

          return `<div style="display: inline-flex; align-items: center; gap: 6px; 
                                 background: ${config.bg}; color: ${config.text}; 
                                 padding: 4px 12px; border-radius: 12px; font-weight: 500; font-size: 0.875rem;">
                        <span>${config.icon}</span>
                        <span>${status}</span>
                    </div>`;
        },
        filter: "agSetColumnFilter",
        filterParams: {
          values: ["Not Started", "In Progress", "Complete", "Delayed"],
          buttons: ["apply", "clear"],
        },
      },

      {
        headerName: "Planned % Complete",
        field: "planned_progress",
        width: 140,
        cellRenderer: (params) => {
          const progress =
            params.value || params.data.baseline_progress_at_date;
          if (progress === undefined || progress === null) return "-";

          const progressNum = Math.round(progress);
          const color =
            progressNum >= 75
              ? "#059669"
              : progressNum >= 50
                ? "#f59e0b"
                : "#dc2626";

          return `<div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; background: #e5e7eb; border-radius: 8px; height: 20px; overflow: hidden;">
                            <div style="width: ${progressNum}%; height: 100%; background: ${color}; 
                                      transition: width 0.3s ease;"></div>
                        </div>
                        <span style="font-weight: 600; color: ${color}; min-width: 40px; text-align: right;">
                            ${progressNum}%
                        </span>
                    </div>`;
        },
        filter: "agNumberColumnFilter",
      },

      {
        headerName: "Actual % Complete",
        field: "actual_progress",
        width: 140,
        cellRenderer: (params) => {
          const progress =
            params.value || params.data.asbuilt_progress_at_date;
          if (progress === undefined || progress === null) return "-";

          const progressNum = Math.round(progress);
          const color =
            progressNum >= 75
              ? "#059669"
              : progressNum >= 50
                ? "#f59e0b"
                : "#dc2626";

          return `<div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; background: #e5e7eb; border-radius: 8px; height: 20px; overflow: hidden;">
                            <div style="width: ${progressNum}%; height: 100%; background: ${color}; 
                                      transition: width 0.3s ease;"></div>
                        </div>
                        <span style="font-weight: 600; color: ${color}; min-width: 40px; text-align: right;">
                            ${progressNum}%
                        </span>
                    </div>`;
        },
        filter: "agNumberColumnFilter",
      },

      {
        headerName: "Category",
        field: "category",
        width: 200,
        editable: true,
        cellEditor: "agSelectCellEditor",
        cellEditorParams: {
          values: [
            "", // Blank/Custom option
            "Site Instruction",
            "Variation",
            "Delay Notice",
            "Compensation Event",
            "Early Warning",
            "Payment",
            "Meeting Minutes",
            "Technical Query",
            "Progress Update",
            "Contract Document",
            "Safety/H&S",
            "Quality Issue",
            "General",
          ],
        },
        cellRenderer: (params) => {
          const icons = {
            "Site Instruction": "üìã",
            Variation: "üîÑ",
            "Delay Notice": "‚è±Ô∏è",
            "Compensation Event": "üí∞",
            "Early Warning": "‚ö†Ô∏è",
            Payment: "üí≥",
            "Meeting Minutes": "üìù",
            "Technical Query": "‚ùì",
            "Progress Update": "üìä",
            "Contract Document": "üìÑ",
            "Safety/H&S": "ü¶∫",
            "Quality Issue": "üîç",
            General: "üìß",
          };

          const category = params.value;
          const suggestedCategory = params.data.suggested_category;
          const rowId = params.data.id;

          // If category is set, show it
          if (category) {
            return `<div style="display: flex; align-items: center; gap: 6px;">
                            <span style="font-size: 1.1em;">${icons[category] || "üìß"}</span>
                            <span>${category}</span>
                        </div>`;
          }

          // If no category but there's a suggestion, show suggestion with accept button
          if (suggestedCategory) {
            return `<div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                            <span style="display: inline-flex; align-items: center; gap: 4px; 
                                        padding: 2px 8px; background: #fef3c7; color: #92400e; 
                                        border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                <i class="fas fa-wand-magic-sparkles" style="font-size: 0.65rem;"></i>
                                ${suggestedCategory}
                            </span>
                            <button onclick="acceptCategorySuggestion('${rowId}', '${suggestedCategory}'); event.stopPropagation();"
                                    style="background: #10b981; color: white; border: none; 
                                           padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; 
                                           cursor: pointer; font-weight: 600;"
                                    title="Accept suggestion">
                                ‚úì
                            </button>
                        </div>`;
          }

          // No category and no suggestion
          return '<span style="color: var(--text-muted);">‚Äî</span>';
        },
        filter: "agSetColumnFilter",
        filterParams: {
          buttons: ["apply", "clear", "reset"],
        },
      },

      {
        headerName: "Keywords",
        field: "keywords",
        width: 200,
        wrapText: true,
        autoHeight: true,
        editable: true,
        cellStyle: {
          "white-space": "normal",
          "line-height": "1.4",
          "padding-top": "8px",
          "padding-bottom": "8px",
        },
        cellRenderer: (params) => {
          if (!params.value) return "-";
          const keywords = params.value
            .split(",")
            .map((k) => k.trim())
            .filter((k) => k);
          if (keywords.length === 0) return "-";

          return `<div style="display: flex; flex-wrap: wrap; gap: 4px;">
                        ${keywords
              .map(
                (keyword) => `
                            <span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; 
                                       border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                                ${keyword}
                            </span>
                        `,
              )
              .join("")}
                    </div>`;
        },
        valueGetter: (params) => {
          // Get keywords from matched_keywords field
          const matchedKeywords = params.data.matched_keywords || [];
          if (Array.isArray(matchedKeywords) && matchedKeywords.length > 0) {
            return matchedKeywords.join(", ");
          }

          // Fallback to existing keywords field
          const existingKeywords = params.data.keywords || "";
          if (existingKeywords) return existingKeywords;

          return "";
        },
        filter: "agTextColumnFilter",
      },

      {
        headerName: "Stakeholder",
        field: "stakeholder",
        width: 180,
        editable: true,
        cellEditor: "agSelectCellEditor",
        cellEditorParams: {
          values: [
            "Main Contractor",
            "Council",
            "Employers Agent",
            "Project Manager",
            "Client",
            "Building Control",
            "Subcontractor",
            "Client Management Team",
            "Other",
          ],
        },
        valueGetter: (params) => {
          // Get stakeholders from matched_stakeholders field
          const matchedStakeholders = params.data.matched_stakeholders || [];
          if (
            Array.isArray(matchedStakeholders) &&
            matchedStakeholders.length > 0
          ) {
            return matchedStakeholders.join(", ");
          }

          // Fallback to existing stakeholder field
          const existingStakeholder = params.data.stakeholder || "";
          if (existingStakeholder) return existingStakeholder;

          return "";
        },
        filter: "agSetColumnFilter",
        filterParams: {
          buttons: ["apply", "clear", "reset"],
        },
      },

      {
        headerName: "Priority",
        field: "priority",
        width: 120,
        editable: true,
        cellEditor: "agSelectCellEditor",
        cellEditorParams: {
          values: ["High", "Medium", "Low"],
        },
        cellStyle: (params) => {
          const colors = {
            High: { bg: "#fee2e2", text: "#991b1b" },
            Medium: { bg: "#fef3c7", text: "#92400e" },
            Low: { bg: "#d1fae5", text: "#065f46" },
          };
          const color = colors[params.value] || {
            bg: "transparent",
            text: "#6b7280",
          };
          return {
            backgroundColor: color.bg,
            color: color.text,
            fontWeight: "600",
            padding: "4px 8px",
            borderRadius: "6px",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
          };
        },
        filter: "agSetColumnFilter",
        filterParams: {
          buttons: ["apply", "clear", "reset"],
        },
      },

      {
        headerName: "Status",
        field: "status",
        width: 150,
        editable: true,
        cellEditor: "agSelectCellEditor",
        cellEditorParams: {
          values: [
            "New",
            "Review",
            "Action Required",
            "Responded",
            "Closed",
            "Archived",
          ],
        },
        cellRenderer: (params) => {
          if (!params.value) return "-";
          const icons = {
            New: "üÜï",
            Review: "üëÄ",
            "Action Required": "‚ö°",
            Responded: "‚úÖ",
            Closed: "üîí",
            Archived: "üì¶",
          };
          const colors = {
            New: { bg: "#dbeafe", text: "#1e40af" },
            Review: { bg: "#fef3c7", text: "#92400e" },
            "Action Required": { bg: "#fee2e2", text: "#991b1b" },
            Responded: { bg: "#d1fae5", text: "#065f46" },
            Closed: { bg: "#f3f4f6", text: "#374151" },
            Archived: { bg: "#e5e7eb", text: "#6b7280" },
          };
          const color = colors[params.value] || colors["New"];
          return `<div style="display: inline-flex; align-items: center; gap: 6px; 
                                 background: ${color.bg}; color: ${color.text}; 
                                 padding: 4px 12px; border-radius: 12px; font-weight: 500; font-size: 0.875rem;">
                        <span>${icons[params.value] || "üìß"}</span>
                        <span>${params.value}</span>
                    </div>`;
        },
        filter: "agSetColumnFilter",
        filterParams: {
          buttons: ["apply", "clear", "reset"],
        },
      },

      {
        headerName: "Notes",
        field: "notes",
        width: 250,
        editable: true,
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "white-space": "normal",
          "line-height": "1.4",
          "padding-top": "8px",
          "padding-bottom": "8px",
          "font-style": "italic",
          color: "#6b7280",
        },
        filter: "agTextColumnFilter",
      },

      {
        headerName: "Thread ID",
        field: "thread_id",
        width: 120,
        hide: true,
        filter: "agTextColumnFilter",
      },
    ];

    // Grid Options with Enterprise Features
    // Override with streamlined columns
    columnDefs = [
      {
        headerName: "",
        field: "selection",
        width: 50,
        checkboxSelection: true,
        headerCheckboxSelection: true,
        pinned: "left",
      },
      {
        headerName: "Date/Time",
        field: "email_date",
        width: 120,
        sort: "desc",
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "vertical-align": "top",
          "text-align": "center",
          "padding-top": "8px",
          "padding-bottom": "8px",
        },
        cellRenderer: (params) => {
          if (!params.value) return "-";
          const date = new Date(params.value);
          return `
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <span style="font-weight: 600;">${date.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted);">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    `;
        },
        filter: "agDateColumnFilter",
      },
      {
        headerName: "From",
        field: "email_from",
        width: 140,
        wrapText: true,
        cellStyle: {
          "white-space": "normal",
          "word-wrap": "break-word",
        },
        cellRenderer: (params) =>
          params.value
            ? `<span style="font-weight: 500;">${params.value}</span>`
            : "-",
        filter: "agSetColumnFilter",
      },
      {
        headerName: "To",
        field: "email_to",
        width: 140,
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "white-space": "normal",
          "word-wrap": "break-word",
        },
        valueGetter: (params) => {
          if (!params.data) return "-";
          // Use recipients_to (includes email) if available, fallback to email_to
          const val = params.data.recipients_to || params.data.email_to;
          if (Array.isArray(val)) return val.join(", ") || "-";
          return val || "-";
        },
        cellRenderer: (params) => {
          if (!params.value || params.value === "-") return "-";
          return `<span style="font-weight: 500;">${String(params.value)}</span>`;
        },
        filter: "agSetColumnFilter",
      },
      {
        headerName: "CC",
        field: "email_cc",
        width: 140,
        hide: true, // Hidden by default - show via column chooser
        wrapText: true,
        autoHeight: true,
        cellStyle: {
          "white-space": "normal",
          "word-wrap": "break-word",
        },
        valueGetter: (params) => {
          if (!params.data) return "-";
          // Use recipients_cc (includes email) if available, fallback to email_cc
          const val = params.data.recipients_cc || params.data.email_cc;
          if (Array.isArray(val)) return val.join(", ") || "-";
          return val || "-";
        },
        cellRenderer: (params) => {
          if (!params.value || params.value === "-") return "-";
          return `<span style="font-weight: 500;">${String(params.value)}</span>`;
        },
        filter: "agSetColumnFilter",
      },
      {
        headerName: "Thread",
        field: "thread_id",
        width: 90,
        cellRenderer: (params) => {
          if (!params.value) {
            return `<span style="color: var(--text-muted); font-size: 0.85rem;">Single</span>`;
          }
          return `<div style="display: flex; align-items: center; gap: 4px; color: var(--vericase-blue);">
            <i class="fas fa-comments" style="font-size: 0.85rem;"></i>
            <span style="font-weight: 600; font-size: 0.85rem;">Thread</span>
          </div>`;
        },
        filter: "agSetColumnFilter",
        filterParams: {
          values: ['Thread', 'Single'],
          valueFormatter: (params) => params.value || 'Single'
        },
      },
      {
        headerName: "Subject",
        field: "email_subject",
        width: 200,
        wrapText: true,
        cellStyle: {
          "white-space": "normal",
          "word-wrap": "break-word",
        },
        cellRenderer: (params) => {
          if (!params.value) return "-";
          return `<span style="font-weight:600;color:var(--vericase-navy);">${String(params.value)}</span>`;
        },
        filter: "agTextColumnFilter",
      },
      {
        headerName: "Message",
        field: "email_body",
        flex: 3,
        minWidth: 400,
        wrapText: true,
        cellStyle: { "white-space": "normal", "line-height": "1.4", "overflow": "hidden" },
        valueGetter: (params) => {
          // Return both clean text (for preview) and HTML (for full view)
          const htmlBody = params.data.body_html;
          const textBody =
            params.data.body_text_clean ||
            params.data.body_text ||
            params.data.email_body ||
            "";
          return { html: htmlBody, text: textBody };
        },
        cellRenderer: (params) => {
          const contentObj = params.value || {
            text: "No content",
            html: null,
          };
          const htmlContent = contentObj.html;
          const textContent = contentObj.text || "No content";
          const rowId = params.node.id;
          const quotedRowId = `'${rowId}'`;
          const isExpanded = showFullContent || params.data.expanded === true;

          // Clean text for preview - remove signatures, external email warnings
          const getCleanPreview = (text) => {
            if (!text) return "No readable content";

            // AGGRESSIVE VML GARBAGE DETECTION - check raw text first
            // Catches patterns like: v," [BehaviourName]... AND {behavior:url(#default#VML);}
            if (
              /Behaviour|dataPull|leftPull|VMLI|v,\s*"|behavior:url|#default#VML|v\\;|o\\;|w\\;|\.shape\s*\{/i.test(
                text,
              )
            ) {
              return "No readable content";
            }

            let cleaned = text;

            // Remove external email warning containers (including HTML) BEFORE removing tags
            cleaned = cleaned.replace(/<div[^>]*external[^>]*>.*?<\/div>/gi, '');
            cleaned = cleaned.replace(/<p[^>]*external[^>]*>.*?<\/p>/gi, '');
            cleaned = cleaned.replace(/<table[^>]*external[^>]*>.*?<\/table>/gi, '');
            cleaned = cleaned.replace(/<span[^>]*external[^>]*>.*?<\/span>/gi, '');

            // Remove HTML/XML tags
            cleaned = cleaned.replace(/<[^>]*>/g, " ");

            // Remove EXTERNAL EMAIL text warnings - be specific, not greedy
            cleaned = cleaned.replace(/EXTERNAL EMAIL:?\s*/gi, "");
            cleaned = cleaned.replace(
              /EXTERNAL EMAIL:?\s*&nbsp;?\s*Don't click links or open attachments[^.]*\.\s*/gi,
              "",
            );
            cleaned = cleaned.replace(
              /Don't click links or open attachments unless the content is expected and known to be safe\.?\s*/gi,
              "",
            );
            cleaned = cleaned.replace(/Aconex Email Notification\s*/gi, "");
            cleaned = cleaned.replace(
              /This message originated from outside[^.]*\.\s*/gi,
              "",
            );
            cleaned = cleaned.replace(
              /CAUTION:?\s*This email originated[^.]*\.\s*/gi,
              "",
            );
            cleaned = cleaned.replace(/\[EXTERNAL\]:?\s*/gi, "");

            // Remove common email footer patterns
            // Legal disclaimers - typically start at bottom of email
            cleaned = cleaned.replace(/The information contained in this (?:message|email|communication)[^]*?(?=\n\n[A-Z]|$)/gi, '');
            cleaned = cleaned.replace(/This (?:message|email|communication) (?:is|contains)[^]*?confidential[^]*?(?=\n\n[A-Z]|$)/gi, '');
            cleaned = cleaned.replace(/CONFIDENTIALITY NOTICE[:\s][^]*?(?=\n\n[A-Z]|$)/gi, '');
            cleaned = cleaned.replace(/DISCLAIMER[:\s][^]*?(?=\n\n[A-Z]|$)/gi, '');

            // Company registration and legal entity info
            cleaned = cleaned.replace(/(?:Ltd|Limited|LLC|Inc|Pty)\.?\s+is\s+a\s+company\s+registered[^]*?(?=\n\n[A-Z]|$)/gi, '');
            cleaned = cleaned.replace(/Company\s+(?:Registration\s+)?(?:No|Number)\.?\s*:?\s*\d+[^]*?(?=\n\n[A-Z]|$)/gi, '');
            cleaned = cleaned.replace(/Registered\s+(?:Office|Address)[:\s][^]*?(?=\n\n[A-Z]|$)/gi, '');

            // Social media and web links
            cleaned = cleaned.replace(/(?:Follow|Find|Connect with)\s+us\s+on[:\s][^]*?(?:Instagram|LinkedIn|Twitter|Facebook)[^]*?(?=\n\n[A-Z]|$)/gi, '');
            cleaned = cleaned.replace(/(?:Instagram|LinkedIn|Twitter|Facebook|Web)[:\s]*(?:www\.)?\S+/gi, '');
            cleaned = cleaned.replace(/(?:^|\s)www\.\S+\.(?:com|co\.uk|org|net)(?:\s|$)/gi, ' ');

            // Contact information footers
            cleaned = cleaned.replace(/(?:Tel|Telephone|Phone|Mobile|Fax)[:\s]*[\d\s\+\(\)\-]+/gi, '');
            cleaned = cleaned.replace(/(?:E-?mail|Email)[:\s]*\S+@\S+/gi, '');

            // Unsubscribe and email client links
            cleaned = cleaned.replace(/(?:Click here to|To)\s+unsubscribe[^]*?(?=\n\n[A-Z]|$)/gi, '');
            cleaned = cleaned.replace(/View this email in (?:your )?browser[^]*?(?=\n\n|$)/gi, '');

            // Office addresses - match UK postcodes and common patterns
            cleaned = cleaned.replace(/(?:Office|Address)[:\s][^]*?(?:UK|United Kingdom|England|Wales|Scotland)[^]*?[A-Z]{1,2}\d{1,2}\s*\d[A-Z]{2}[^]*?(?=\n\n[A-Z]|$)/gi, '');

            // Common signature block separators
            cleaned = cleaned.replace(/_{3,}/g, ''); // Underscores
            cleaned = cleaned.replace(/-{3,}/g, ''); // Dashes
            cleaned = cleaned.replace(/={3,}/g, ''); // Equal signs

            // Remove signature blocks - everything after common sign-offs
            cleaned = cleaned.replace(/\n--\s*\n[\s\S]*$/i, ''); // Double-dash delimiter
            cleaned = cleaned.replace(/\nRegards,?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nKind [Rr]egards,?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nBest [Rr]egards,?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nMany [Tt]hanks,?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nThanks,?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nBest,?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nCheers,?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nYours (?:sincerely|faithfully),?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nWarm regards,?\s*\n[\s\S]*/i, '');
            cleaned = cleaned.replace(/\nWith (?:kind )?regards,?\s*\n[\s\S]*/i, '');

            // Remove mobile/app signatures
            cleaned = cleaned.replace(/Sent from my (?:iPhone|iPad|Android|mobile)[^\n]*(?:\n[\s\S]*)?$/i, '');
            cleaned = cleaned.replace(/Get Outlook for (?:iOS|Android|Mac|Windows)[^\n]*(?:\n[\s\S]*)?$/i, '');
            cleaned = cleaned.replace(/Sent from Mail for Windows[^\n]*(?:\n[\s\S]*)?$/i, '');

            // Remove HTML entities
            cleaned = cleaned.replace(/&nbsp;/g, " ");
            cleaned = cleaned.replace(/&[a-z]+;/gi, " ");

            // Remove cid references
            cleaned = cleaned.replace(/\[cid:[^\]]+\]/g, "");

            // Clean up whitespace while preserving paragraph structure
            // First normalize line endings
            cleaned = cleaned.replace(/\r\n/g, "\n");
            cleaned = cleaned.replace(/\r/g, "\n");

            // Remove leading whitespace/indent from each line (fixes massive indent issue)
            cleaned = cleaned.replace(/^[ \t]+/gm, "");

            // Collapse multiple spaces to single space (within lines)
            cleaned = cleaned.replace(/ +/g, " ");

            // Preserve paragraph breaks: collapse 3+ newlines to 2 (paragraph break)
            cleaned = cleaned.replace(/\n{3,}/g, "\n\n");

            // Trim whitespace from start/end
            cleaned = cleaned.trim();

            // If empty after cleaning, show placeholder
            if (!cleaned || cleaned.length < 3) {
              return "No content";
            }
            return cleaned;
          };

          // Clean HTML for full view - remove dangerous content and external email warnings
          const cleanHtmlForFullView = (html) => {
            if (!html) return null;
            let cleaned = html;

            // Remove external email warning containers (BEFORE removing dangerous content)
            cleaned = cleaned.replace(/<div[^>]*external[^>]*>.*?<\/div>/gi, '');
            cleaned = cleaned.replace(/<p[^>]*external[^>]*>.*?<\/p>/gi, '');
            cleaned = cleaned.replace(/<table[^>]*external[^>]*>.*?<\/table>/gi, '');
            cleaned = cleaned.replace(/<span[^>]*external[^>]*>.*?<\/span>/gi, '');

            // Remove dangerous content
            cleaned = cleaned.replace(
              /<script[^>]*>[\s\S]*?<\/script>/gi,
              "",
            );
            cleaned = cleaned.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, "");
            // Strip inline cid images that browsers can't render
            cleaned = cleaned.replace(/<img[^>]+src=["']cid:[^"']+["'][^>]*>/gi, "");

            // Remove EXTERNAL EMAIL warning text patterns
            cleaned = cleaned.replace(/EXTERNAL EMAIL:?\s*/gi, "");
            cleaned = cleaned.replace(
              /EXTERNAL EMAIL:?\s*&nbsp;?\s*Don't click links or open attachments[^<]*/gi,
              "",
            );
            cleaned = cleaned.replace(
              /Don't click links or open attachments unless the content is expected and known to be safe\.?/gi,
              "",
            );
            cleaned = cleaned.replace(/Aconex Email Notification[^<]*/gi, "");
            cleaned = cleaned.replace(
              /This message originated from outside[^<]*/gi,
              "",
            );

            // Remove common email footer patterns (HTML context)
            // Legal disclaimers
            cleaned = cleaned.replace(/The information contained in this (?:message|email|communication)[^]*?(?=<\/(?:p|div)|$)/gi, '');
            cleaned = cleaned.replace(/This (?:message|email|communication) (?:is|contains)[^]*?confidential[^]*?(?=<\/(?:p|div)|$)/gi, '');
            cleaned = cleaned.replace(/CONFIDENTIALITY NOTICE[:\s][^]*?(?=<\/(?:p|div)|$)/gi, '');
            cleaned = cleaned.replace(/DISCLAIMER[:\s][^]*?(?=<\/(?:p|div)|$)/gi, '');

            // Company registration and legal entity info
            cleaned = cleaned.replace(/(?:Ltd|Limited|LLC|Inc|Pty)\.?\s+is\s+a\s+company\s+registered[^]*?(?=<\/(?:p|div)|$)/gi, '');
            cleaned = cleaned.replace(/Company\s+(?:Registration\s+)?(?:No|Number)\.?\s*:?\s*\d+[^]*?(?=<\/(?:p|div)|$)/gi, '');
            cleaned = cleaned.replace(/Registered\s+(?:Office|Address)[:\s][^]*?(?=<\/(?:p|div)|$)/gi, '');

            // Social media and web links
            cleaned = cleaned.replace(/(?:Follow|Find|Connect with)\s+us\s+on[:\s][^]*?(?:Instagram|LinkedIn|Twitter|Facebook)[^]*?(?=<\/(?:p|div)|$)/gi, '');
            cleaned = cleaned.replace(/(?:Instagram|LinkedIn|Twitter|Facebook|Web)[:\s]*(?:www\.)?\S+/gi, '');
            cleaned = cleaned.replace(/(?:^|\s)www\.\S+\.(?:com|co\.uk|org|net)(?:\s|$)/gi, ' ');

            // Contact information footers
            cleaned = cleaned.replace(/(?:Tel|Telephone|Phone|Mobile|Fax)[:\s]*[\d\s\+\(\)\-]+/gi, '');
            cleaned = cleaned.replace(/(?:E-?mail|Email)[:\s]*\S+@\S+/gi, '');

            // Unsubscribe and email client links
            cleaned = cleaned.replace(/(?:Click here to|To)\s+unsubscribe[^]*?(?=<\/(?:p|div)|$)/gi, '');
            cleaned = cleaned.replace(/View this email in (?:your )?browser[^]*?(?=<|$)/gi, '');

            // Office addresses - match UK postcodes
            cleaned = cleaned.replace(/(?:Office|Address)[:\s][^]*?(?:UK|United Kingdom|England|Wales|Scotland)[^]*?[A-Z]{1,2}\d{1,2}\s*\d[A-Z]{2}[^]*?(?=<\/(?:p|div)|$)/gi, '');

            // Common signature block separators
            cleaned = cleaned.replace(/_{3,}/g, '');
            cleaned = cleaned.replace(/-{3,}/g, '');
            cleaned = cleaned.replace(/={3,}/g, '');

            // Remove reply headers
            cleaned = cleaned.replace(
              /-----\s*Original Message\s*-----[\s\S]*/i,
              "",
            );

            // Remove Office/Outlook formatting artifacts
            cleaned = cleaned.replace(/<o:p>&nbsp;<\/o:p>/gi, "");
            cleaned = cleaned.replace(/<o:p><\/o:p>/gi, "");
            cleaned = cleaned.replace(/<o:[^>]*>[\s\S]*?<\/o:[^>]*>/gi, "");

            // Remove empty paragraphs and excessive whitespace at start
            cleaned = cleaned.replace(
              /^(\s*<(p|div|br)[^>]*>\s*(&nbsp;)?\s*<\/(p|div)>\s*)+/gi,
              "",
            );
            cleaned = cleaned.replace(/^(\s*<br\s*\/?>\s*)+/gi, "");

            // Remove empty tables that might remain after warning removal
            cleaned = cleaned.replace(
              /<table[^>]*>\s*(<tbody[^>]*>\s*)?(<tr[^>]*>\s*(<td[^>]*>\s*(&nbsp;)?\s*<\/td>\s*)*<\/tr>\s*)*(<\/tbody>\s*)?<\/table>/gi,
              "",
            );

            // Remove empty divs/paragraphs anywhere
            cleaned = cleaned.replace(
              /<(p|div|span)[^>]*>\s*(&nbsp;|\s)*<\/\1>/gi,
              "",
            );

            // Remove multiple consecutive <br> tags (more than 2)
            cleaned = cleaned.replace(/(<br\s*\/?>\s*){3,}/gi, "<br><br>");

            // Fix images
            cleaned = cleaned.replace(
              /<img([^>]*)>/gi,
              '<img$1 style="max-width: 100%; height: auto;">',
            );

            // Final cleanup - trim leading/trailing whitespace and empty elements
            cleaned = cleaned.replace(/^\s+/, "").replace(/\s+$/, "");
            return cleaned;
          };

          // Helper to safely escape HTML
          const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };

          // Get clean plain text
          const cleanText = getCleanPreview(textContent);

          if (!isExpanded) {
            // PREVIEW MODE: Show first 300 chars of plain text
            const preview = cleanText.substring(0, 300);
            const needsExpand = cleanText.length > 300;

            return `
              <div style="white-space: pre-wrap; font-size: 0.9rem; line-height: 1.6; color: #374151;">
                ${escapeHtml(preview)}${needsExpand ? '...' : ''}
              </div>
              ${needsExpand ? `<button onclick="expandRow('${rowId}')"
                 style="margin-top: 8px; padding: 4px 12px; background: var(--vericase-blue);
                 color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                 View Full Message
              </button>` : ''}
            `;
          } else {
            // EXPANDED MODE: Show full plain text message with paragraph breaks
            return `
              <div style="white-space: pre-wrap; font-size: 0.9rem; line-height: 1.6;
                          max-height: 600px; overflow-y: auto; color: #374151;">
                ${escapeHtml(cleanText)}
              </div>
              <button onclick="collapseRow('${rowId}')"
                 style="margin-top: 8px; padding: 4px 12px; background: var(--text-muted);
                 color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                 Collapse
              </button>
            `;
          }
        },
        filter: "agTextColumnFilter",
      },
      {
        headerName: "Attachments",
        field: "attachments",
        width: 200,
        wrapText: false,
        autoHeight: false,
        valueGetter: (params) => {
          const attachments =
            params.data.attachments || params.data.meta?.attachments || [];
          // Filter to only show documents (not images, not embedded)
          const filtered = attachments.filter((att) =>
            isDocumentAttachment(att),
          );
          if (!filtered.length) return "-";
          return `${filtered.length} doc(s)`;
        },
        cellRenderer: (params) => {
          const attachments =
            params.data.attachments || params.data.meta?.attachments || [];
          // Filter to only show documents (not images, not embedded)
          const filtered = attachments.filter((att) =>
            isDocumentAttachment(att),
          );
          if (!filtered.length)
            return '<span style="color: var(--text-muted);">‚Äî</span>';
          // Show count with file icon and first few names
          const fileNames = filtered
            .slice(0, 2)
            .map((att) => att.filename || att.name || "File");
          const suffix =
            filtered.length > 2 ? ` (+${filtered.length - 2})` : "";
          return `<span style="display:flex;gap:4px;align-items:center;overflow:hidden;white-space:nowrap;">
                        <i class="fas fa-file-alt" style="color:var(--vericase-teal);"></i>
                        ${fileNames.join(", ")}${suffix}
                    </span>`;
        },
        cellStyle: {
          overflow: "hidden",
          "white-space": "nowrap",
          "text-overflow": "ellipsis",
        },
      },
      {
        headerName: "Images",
        field: "attachments",
        width: 180,
        wrapText: false,
        autoHeight: false,
        valueGetter: (params) => {
          const attachments =
            params.data.attachments || params.data.meta?.attachments || [];
          // Filter to only show image attachments (not embedded)
          const filtered = attachments.filter((att) =>
            isImageAttachment(att),
          );
          if (!filtered.length) return "-";
          return `${filtered.length} image(s)`;
        },
        cellRenderer: (params) => {
          const attachments =
            params.data.attachments || params.data.meta?.attachments || [];
          // Filter to only show image attachments (not embedded)
          const filtered = attachments.filter((att) =>
            isImageAttachment(att),
          );
          if (!filtered.length)
            return '<span style="color: var(--text-muted);">‚Äî</span>';
          // Show count with image icon and first few names
          const fileNames = filtered
            .slice(0, 2)
            .map((att) => att.filename || att.name || "Image");
          const suffix =
            filtered.length > 2 ? ` (+${filtered.length - 2})` : "";
          return `<span style="display:flex;gap:4px;align-items:center;overflow:hidden;white-space:nowrap;">
                        <i class="fas fa-image" style="color:#10b981;"></i>
                        ${fileNames.join(", ")}${suffix}
                    </span>`;
        },
        cellStyle: {
          overflow: "hidden",
          "white-space": "nowrap",
          "text-overflow": "ellipsis",
        },
      },
      {
        headerName: "Keywords",
        field: "keywords",
        width: 180,
        valueGetter: (params) => {
          // Check all possible keyword sources
          const matched = params.data.matched_keywords || [];
          const keywordsField = params.data.keywords || "";
          const metaKeywords = params.data.meta?.keywords || [];

          // Combine all sources, remove duplicates
          const allKeywords = [
            ...(Array.isArray(matched) ? matched : []),
            ...(typeof keywordsField === "string"
              ? keywordsField.split(",").filter((k) => k.trim())
              : []),
            ...(Array.isArray(metaKeywords) ? metaKeywords : []),
          ];
          return [
            ...new Set(allKeywords.map((k) => k.trim()).filter(Boolean)),
          ];
        },
        cellRenderer: (params) => {
          const keywords = params.value || [];
          if (!keywords.length)
            return '<span style="color: var(--text-muted);">‚Äî</span>';
          return keywords
            .map(
              (k) =>
                `<span style="display: inline-block; background: #ECFDF3; color: #166534; padding: 4px 8px; border-radius: 999px; margin: 2px; font-weight: 600;">${k}</span>`,
            )
            .join("");
        },
        filter: "agSetColumnFilter",
      },
      {
        headerName: "Party Role",
        field: "party_role",
        width: 160,
        valueGetter: (params) => {
          // Get stakeholder role from matched stakeholders details or fallback
          const stakeholders = params.data.matched_stakeholders_details || [];
          if (stakeholders.length > 0) {
            return stakeholders
              .map((s) => s.role || s.organization)
              .filter(Boolean)
              .join(", ");
          }
          // Fallback to stakeholder_role or stakeholder field
          return (
            params.data.stakeholder_role || params.data.stakeholder || ""
          );
        },
        cellRenderer: (params) => {
          if (!params.value)
            return '<span style="color: var(--text-muted);">‚Äî</span>';
          const roleColors = {
            "Main Contractor": { bg: "#dbeafe", color: "#1e40af" },
            Client: { bg: "#fef3c7", color: "#92400e" },
            Subcontractor: { bg: "#dcfce7", color: "#166534" },
            Consultant: { bg: "#f3e8ff", color: "#7c3aed" },
            Architect: { bg: "#ffe4e6", color: "#be123c" },
            Engineer: { bg: "#e0e7ff", color: "#3730a3" },
            Supplier: { bg: "#fef9c3", color: "#854d0e" },
            "Project Manager": { bg: "#cffafe", color: "#0e7490" },
          };
          const cfg = roleColors[params.value] || {
            bg: "#f3f4f6",
            color: "#374151",
          };
          return `<span style="padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; 
                                       font-weight: 600; background: ${cfg.bg}; color: ${cfg.color};">
                                ${params.value}
                            </span>`;
        },
        filter: "agSetColumnFilter",
      },
      {
        headerName: "Claim Status",
        field: "claim_status",
        width: 140,
        cellRenderer: (params) => {
          const status = params.data.claim_status || "none";
          const statusConfig = {
            none: { bg: "#f3f4f6", color: "#6b7280", label: "None" },
            contentious_matter: {
              bg: "#fef3c7",
              color: "#92400e",
              label: "Matter",
            },
            head_of_claim: {
              bg: "#fee2e2",
              color: "#991b1b",
              label: "Claim",
            },
          };
          const cfg = statusConfig[status] || statusConfig["none"];
          return `<span style="padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; 
                                       font-weight: 600; background: ${cfg.bg}; color: ${cfg.color};">
                                ${cfg.label}
                            </span>`;
        },
        cellEditor: "agSelectCellEditor",
        cellEditorParams: {
          values: ["none", "contentious_matter", "head_of_claim"],
        },
        editable: true,
        filter: "agSetColumnFilter",
      },
      {
        headerName: "Linked To",
        field: "linked_to",
        width: 200,
        valueGetter: (params) => {
          // This would need to be populated by API with linked matter/claim names
          return (
            params.data.linked_matter_name ||
            params.data.linked_claim_name ||
            ""
          );
        },
        cellRenderer: (params) => {
          const emailId = params.data.id;
          const linkedValue = params.value;

          if (!linkedValue) {
            // No link - show "Link" button
            return `<div style="display: flex; align-items: center; gap: 6px;">
                            <button onclick="openQuickLinkDropdown('${emailId}', event); event.stopPropagation();"
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb;
                                           padding: 4px 10px; border-radius: 6px; font-size: 0.75rem;
                                           cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-link"></i> Link
                            </button>
                        </div>`;
          }

          // Has link - show link with view/unlink options
          const isMatter = params.data.linked_matter_name;
          const icon = isMatter ? "fa-exclamation-triangle" : "fa-gavel";
          const iconColor = isMatter ? "#f59e0b" : "#ef4444";
          const bgColor = isMatter ? "#fef3c7" : "#fee2e2";

          return `<div style="display: flex; align-items: center; gap: 4px;">
                        <span style="display: inline-flex; align-items: center; gap: 4px;
                                    padding: 3px 8px; background: ${bgColor}; border-radius: 6px;
                                    font-size: 0.75rem; cursor: pointer; max-width: 140px;"
                              onclick="openLinkedItem('${emailId}')"
                              title="Click to view in Contentious Matters">
                            <i class="fas ${icon}" style="color: ${iconColor}; font-size: 0.65rem;"></i>
                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${linkedValue}</span>
                        </span>
                        <button onclick="unlinkEmail('${emailId}'); event.stopPropagation();"
                                style="background: none; border: none; color: #9ca3af; cursor: pointer; padding: 2px;"
                                title="Remove link">
                            <i class="fas fa-times" style="font-size: 0.7rem;"></i>
                        </button>
                    </div>`;
        },
      },
      {
        headerName: "Notes",
        field: "claim_notes",
        width: 200,
        editable: true,
        cellRenderer: (params) => {
          const notes = params.data.claim_notes || "";
          if (!notes) {
            return `<span style="color: var(--text-muted); font-style: italic; cursor: pointer;"
                                      onclick="editClaimNotes('${params.data.id}')">+ Add notes</span>`;
          }
          return `<div style="font-size: 0.8rem; max-width: 180px; overflow: hidden; 
                                       text-overflow: ellipsis; white-space: nowrap;" 
                                 title="${notes.replace(/"/g, "&quot;")}">${notes}</div>`;
        },
        cellEditor: "agLargeTextCellEditor",
        cellEditorParams: {
          maxLength: 1000,
          rows: 3,
          cols: 30,
        },
      },
      {
        headerName: "Priority",
        field: "priority",
        width: 110,
        cellRenderer: (params) => {
          const priority = params.value || "Normal";
          const colors = {
            High: "#FEE2E2",
            Normal: "#EFF6FF",
            Low: "#ECFDF3",
          };
          const textColors = {
            High: "#B91C1C",
            Normal: "#1D4ED8",
            Low: "#166534",
          };
          return `<span style="display:inline-block;padding:6px 12px;border-radius:999px;background:${colors[priority] || "#E5E7EB"};color:${textColors[priority] || "#374151"};font-weight:700;">${priority}</span>`;
        },
        filter: "agSetColumnFilter",
      },
      {
        headerName: "Status",
        field: "status",
        width: 120,
        cellRenderer: (params) => {
          const status = params.value || "Open";
          const colors = {
            Open: "#EFF6FF",
            "In Progress": "#FEF3C7",
            Closed: "#ECFDF3",
          };
          const textColors = {
            Open: "#1D4ED8",
            "In Progress": "#B45309",
            Closed: "#166534",
          };
          return `<span style="display:inline-block;padding:6px 12px;border-radius:999px;background:${colors[status] || "#E5E7EB"};color:${textColors[status] || "#374151"};font-weight:700;">${status}</span>`;
        },
        filter: "agSetColumnFilter",
      },
      {
        headerName: "Notes",
        field: "notes",
        width: 200,
        wrapText: false,
        autoHeight: false,
        cellStyle: { overflow: "hidden", "text-overflow": "ellipsis" },
        cellRenderer: (params) =>
          params.value
            ? params.value
            : '<span style="color: var(--text-muted);">No notes</span>',
        filter: "agTextColumnFilter",
      },
    ];

    // Server-Side Datasource for AG Grid - handles 100k+ emails efficiently
    const createServerSideDatasource = () => {
      return {
        getRows: async (params) => {
          console.log(
            "[Grid] Server-side request:",
            params.request.startRow,
            "-",
            params.request.endRow,
          );
          showLoading(true);

          try {
            const token =
              localStorage.getItem("token") ||
              localStorage.getItem("jwt") ||
              "";
            let apiUrl = `${API_BASE}/api/correspondence/emails/server-side`;

            // Add project/case filter
            const queryParams = new URLSearchParams();
            if (projectId) queryParams.append("project_id", projectId);
            if (caseId) queryParams.append("case_id", caseId);
            if (queryParams.toString())
              apiUrl += "?" + queryParams.toString();

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                ...(token ? { Authorization: `Bearer ${token}` } : {}),
              },
              body: JSON.stringify({
                startRow: params.request.startRow,
                endRow: params.request.endRow,
                sortModel: params.request.sortModel || [],
                filterModel: params.request.filterModel || {},
                groupKeys: params.request.groupKeys || [],
                rowGroupCols: params.request.rowGroupCols || [],
              }),
            });

            if (!response.ok) {
              throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            console.log(
              "[Grid] Loaded",
              data.rows.length,
              "rows, lastRow:",
              data.lastRow,
              "stats:",
              data.stats,
            );

            // Update statistics on first load
            if (params.request.startRow === 0 && data.stats) {
              console.log("[Grid] Updating stats:", data.stats);
              document.getElementById("totalEmails").textContent = (
                data.stats.total || 0
              ).toLocaleString();
              document.getElementById("uniqueThreads").textContent = (
                data.stats.uniqueThreads || 0
              ).toLocaleString();
              document.getElementById("withAttachments").textContent = (
                data.stats.withAttachments || 0
              ).toLocaleString();
              document.getElementById("dateRange").textContent =
                data.stats.dateRange || "-";
            }

            params.success({
              rowData: data.rows,
              rowCount: data.lastRow,
            });
          } catch (error) {
            console.error("[Grid] Server-side error:", error);
            params.fail();
          } finally {
            showLoading(false);
          }
        },
      };
    };

    const gridOptions = {
      columnDefs: columnDefs,
      // Increased row height for better email readability
      rowHeight: 220,
      headerHeight: 48,
      floatingFiltersHeight: 38,
      defaultColDef: {
        sortable: true,
        filter: true,
        resizable: true,
        floatingFilter: true,
        menuTabs: ["filterMenuTab", "generalMenuTab", "columnsMenuTab"],
        // Flexible cell rendering - handle any data type gracefully
        valueFormatter: (params) => {
          if (params.value === null || params.value === undefined) return "-";
          if (typeof params.value === "object") {
            try {
              return JSON.stringify(params.value);
            } catch {
              return String(params.value);
            }
          }
          return String(params.value);
        },
        // Auto-size to content
        flex: 1,
        minWidth: 100,
        // Enable text wrapping (but not autoHeight - not compatible with server-side model)
        wrapText: true,
        cellStyle: {
          "white-space": "pre-wrap",
          "line-height": "1.6",
          "padding-top": "8px",
          "padding-bottom": "8px",
          "overflow": "auto",
          "word-wrap": "break-word"
        },
      },

      // Auto-generate columns for any unknown fields in the data
      autoGroupColumnDef: {
        minWidth: 200,
      },

      // Suppress errors for missing fields - be flexible
      suppressFieldDotNotation: false,

      // === SERVER-SIDE ROW MODEL (handles 100k+ rows) ===
      rowModelType: "serverSide",
      serverSideDatasource: createServerSideDatasource(),

      // Server-side configuration
      cacheBlockSize: 100, // Load 100 rows at a time
      maxBlocksInCache: 20, // Keep 20 blocks (2000 rows) in memory
      blockLoadDebounceMillis: 100, // Debounce rapid scroll

      // Enterprise features
      sideBar: {
        toolPanels: [
          {
            id: "columns",
            labelDefault: "Columns",
            labelKey: "columns",
            iconKey: "columns",
            toolPanel: "agColumnsToolPanel",
            toolPanelParams: {
              suppressRowGroups: false,
              suppressValues: false,
              suppressPivots: false,
              suppressPivotMode: false,
              suppressColumnFilter: false,
              suppressColumnSelectAll: false,
              suppressColumnExpandAll: false,
            },
          },
          {
            id: "filters",
            labelDefault: "Filters",
            labelKey: "filters",
            iconKey: "filter",
            toolPanel: "agFiltersToolPanel",
          },
        ],
        defaultToolPanel: "",
      },

      // Status bar - using only server-side compatible components
      statusBar: {
        statusPanels: [
          { statusPanel: "agSelectedRowCountComponent", align: "left" },
          { statusPanel: "agAggregationComponent", align: "right" },
        ],
      },

      // Row ID is required for server-side row model selection
      getRowId: (params) => params.data?.id || params.data?.correspondence_id,

      // Row selection
      rowSelection: "multiple",
      rowMultiSelectWithClick: true,

      // Pagination (works with server-side)
      pagination: true,
      paginationPageSize: 100,
      paginationPageSizeSelector: [50, 100, 200, 500],

      // Row grouping - note: groupDefaultExpanded not supported with server-side row model
      groupDisplayType: "multipleColumns",

      // Performance
      animateRows: false, // Disable for smoother server-side scrolling
      rowBuffer: 20, // Buffer for smooth scroll

      // Events
      onSelectionChanged: onSelectionChanged,
      onRowClicked: onRowClicked,
      onGridReady: onGridReady,
      onFirstDataRendered: onFirstDataRendered,
      onCellValueChanged: onCellValueChanged,
    };

    // Load AG Grid configuration from admin settings
    async function loadGridConfig() {
      try {
        const token = localStorage.getItem("token");
        if (!token) return {}; // Return empty config if not logged in

        const response = await fetch(`${API_BASE}/api/admin/settings`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return {}; // Return empty config if fetch fails

        const settings = await response.json();
        const config = {};

        settings.forEach(s => {
          if (s.key.startsWith('ag_grid_')) {
            const settingKey = s.key.replace('ag_grid_', '');
            config[settingKey] = s.value;
          }
        });

        console.log('[Grid Config] Loaded admin settings:', config);
        return config;
      } catch (error) {
        console.error('[Grid Config] Error loading settings:', error);
        return {}; // Return empty config on error
      }
    }

    // Initialize Grid
    document.addEventListener("DOMContentLoaded", async function () {
      // Check if ag-Grid is loaded
      if (typeof agGrid === "undefined") {
        console.error("ag-Grid library failed to load");
        alert("Failed to load email grid. Please refresh the page.");
        return;
      }

      const gridDiv = document.querySelector("#emailGrid");
      if (!gridDiv) {
        console.error("Grid container not found");
        return;
      }

      try {
        // Load grid configuration from admin settings
        const adminConfig = await loadGridConfig();

        // Apply row height from admin settings if available
        if (adminConfig.default_row_height) {
          gridOptions.rowHeight = parseInt(adminConfig.default_row_height);
          console.log('[Grid Config] Applied row height:', gridOptions.rowHeight);
        }

        // Apply pagination page size from admin settings if available
        if (adminConfig.pagination_page_size) {
          gridOptions.paginationPageSize = parseInt(adminConfig.pagination_page_size);
          console.log('[Grid Config] Applied page size:', gridOptions.paginationPageSize);
        }

        // Apply theme from admin settings if available
        const theme = adminConfig.theme || 'quartz';
        gridDiv.className = `ag-theme-${theme} ag-theme-vericase`;
        console.log('[Grid Config] Applied theme:', theme);

        gridApi = agGrid.createGrid(gridDiv, gridOptions);
        console.log("[Grid] AG Grid initialized with server-side row model");
        // Note: Server-side datasource automatically loads data on grid ready
      } catch (error) {
        console.error("Error initializing grid:", error);
        alert("Failed to initialize email grid. Please refresh the page.");
      }
    });

    // ===========================
    // Global Configuration
    // ===========================

    async function onCellValueChanged(params) {
      const colId = params.column.getColId();
      const newValue = params.newValue;
      const emailId = params.data.id;

      // Map column IDs to API fields
      const fieldMap = {
        baseline_activity: "baseline_activity",
        as_built_activity: "as_built_activity",
        delay_days: "delay_days",
        is_critical_path: "is_critical_path",
        category: "category",
        priority: "priority",
        status: "status",
        notes: "notes",
        claim_notes: "notes",
      };

      const apiField = fieldMap[colId];
      if (!apiField) return;

      try {
        const payload = {};
        payload[apiField] = newValue;

        const response = await fetch(
          `${API_BASE}/api/correspondence/emails/${emailId}`,
          {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          },
        );

        if (!response.ok) throw new Error("Update failed");

        if (window.VericaseUI)
          VericaseUI.Toast.success("Updated successfully");
      } catch (error) {
        console.error("Update error:", error);
        if (window.VericaseUI) VericaseUI.Toast.error("Failed to update");
      }
    }

    function onGridReady(params) {
      gridApi = params.api;
      columnApi = params.columnApi;
      // Signal that grid is ready (resolves the gridReadyPromise)
      if (resolveGridReady) resolveGridReady();
    }

    function onFirstDataRendered(params) {
      try {
        // Auto-size all columns based on content
        const allColumnIds = params.api
          .getColumns()
          .map((col) => col.getColId());
        params.api.autoSizeColumns(allColumnIds, false);

        // After autosizing, ensure columns fill the viewport if there's extra space
        const gridEl = document.getElementById("correspondenceGrid");
        if (gridEl) {
          const gridWidth = gridEl.offsetWidth;
          let totalColumnWidth = 0;
          params.api.getColumns().forEach((col) => {
            totalColumnWidth += col.getActualWidth();
          });

          // If columns don't fill the grid, stretch them proportionally
          if (totalColumnWidth < gridWidth - 50) {
            params.api.sizeColumnsToFit();
          }
        }
      } catch (e) {
        console.warn("Auto-size columns error:", e);
      }

      // Fetch stats directly for server-side mode
      fetchAndUpdateStats();

      // Apply default filter to hide excluded emails
      setTimeout(() => applyExcludedFilter(), 100);
    }

    // Legacy function - now using server-side row model
    // This function is kept for backward compatibility with any code that calls it
    async function loadEmails() {
      console.log(
        "[Correspondence] loadEmails called - redirecting to server-side refresh",
      );
      refreshData();
      loadCaseInfo();
    }

    // Toggle between full content and preview
    function toggleEmailContent(rowId) {
      const rowNode = gridApi.getRowNode(rowId);
      if (rowNode && rowNode.data) {
        rowNode.data.expanded = !rowNode.data.expanded;
        // Refresh the specific cell
        const columnDef = gridApi.getColumnDef("email_body");
        gridApi.refreshCells({
          rowNodes: [rowNode],
          columns: ["email_body"],
          force: true,
        });
      }
    }

    // Toggle all emails between full and preview
    function toggleAllEmails() {
      showFullContent = !showFullContent;
      gridApi.forEachNode((node) => {
        node.data.expanded = showFullContent;
      });
      
      // Reset row heights to recalculate based on new mode
      gridApi.resetRowHeights();
      
      gridApi.refreshCells({
        columns: ["email_body"],
        force: true,
      });

      // Update button text
      const btn = document.getElementById("toggleViewBtn");
      if (btn) {
        btn.innerHTML = showFullContent
          ? '<i class="fas fa-compress"></i> Preview Mode'
          : '<i class="fas fa-expand"></i> Full Content';
      }
    }

    // Toggle visibility of excluded emails
    function toggleExcludedEmails() {
      hideExcludedEmails = !hideExcludedEmails;
      applyExcludedFilter();

      // Update button appearance
      const btn = document.getElementById("toggleExcludedBtn");
      const icon = document.getElementById("excludedIcon");
      const label = document.getElementById("excludedLabel");

      if (hideExcludedEmails) {
        if (icon) icon.className = "fas fa-eye-slash";
        if (label) label.textContent = "Excluded Hidden";
        if (btn) btn.classList.remove("active");
      } else {
        if (icon) icon.className = "fas fa-eye";
        if (label) label.textContent = "Showing All";
        if (btn) btn.classList.add("active");
      }
    }

    // Apply filter to hide/show excluded emails
    function applyExcludedFilter() {
      if (!gridApi) return;

      if (hideExcludedEmails) {
        // Filter to only show non-excluded emails
        const filterInstance = gridApi.getFilterInstance("refinement_status");
        if (filterInstance) {
          filterInstance.setModel({ values: [""] });
          gridApi.onFilterChanged();
        }
      } else {
        // Clear the refinement filter to show all
        const filterInstance = gridApi.getFilterInstance("refinement_status");
        if (filterInstance) {
          filterInstance.setModel(null);
          gridApi.onFilterChanged();
        }
      }
    }

    function resolveEntityId() {
      const urlParams = new URLSearchParams(window.location.search);
      const caseIdParam = urlParams.get("caseId");
      const projectIdParam = urlParams.get("projectId");
      const storedCase = localStorage.getItem("currentCaseId");
      const storedProject = localStorage.getItem("currentProjectId");
      // Prefer an explicit case id, fall back to project id if present
      return (
        caseIdParam || storedCase || projectIdParam || storedProject || null
      );
    }

    async function loadCaseInfo() {
      try {
        const entityId = resolveEntityId();
        if (!entityId || entityId === "null") {
          console.warn(
            "No case/project id found for unified info; skipping loadCaseInfo",
          );
          return;
        }
        const response = await fetch(`${API_BASE}/api/unified/${entityId}`);
        if (response.ok) {
          const entityData = await response.json();
          if (entityData.type === "case") {
            document.getElementById("caseNumber").textContent =
              entityData.case_number;
            document.getElementById("caseName").textContent = entityData.name;
          } else {
            // It's a project
            document.getElementById("caseNumber").textContent =
              entityData.project_code;
            document.getElementById("caseName").textContent = entityData.name;
          }
        }
      } catch (error) {
        console.error("Error loading case info:", error);
      }
    }

    function updateStatistics() {
      if (!gridApi) return;

      const totalEmails = allEmails.length;
      const uniqueThreads = new Set(
        allEmails.map((e) => e.thread_id).filter(Boolean),
      ).size;
      const withAttachments = allEmails.filter(
        (e) => e.meta?.attachments?.length > 0,
      ).length;

      // Calculate date range
      const dates = allEmails
        .map((e) => e.email_date)
        .filter(Boolean)
        .map((d) => new Date(d));

      let dateRange = "-";
      if (dates.length > 0) {
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        dateRange = `${minDate.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })} - ${maxDate.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}`;
      }

      document.getElementById("totalEmails").textContent =
        totalEmails.toLocaleString();
      document.getElementById("uniqueThreads").textContent =
        uniqueThreads.toLocaleString();
      document.getElementById("withAttachments").textContent =
        withAttachments.toLocaleString();
      document.getElementById("dateRange").textContent = dateRange;
    }

    // Fetch stats directly from server (for server-side row model)
    async function fetchAndUpdateStats() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const pid = projectId || urlParams.get("project_id");
        const cid = caseId || urlParams.get("case_id");

        let url = `${API_BASE}/api/correspondence/emails/server-side`;
        const params = new URLSearchParams();
        if (pid) params.append("project_id", pid);
        if (cid) params.append("case_id", cid);
        if (params.toString()) url += "?" + params.toString();

        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            startRow: 0,
            endRow: 1,
            sortModel: [],
            filterModel: {},
          }),
        });

        if (response.ok) {
          const data = await response.json();
          if (data.stats) {
            console.log("[Stats] Updating from server:", data.stats);
            document.getElementById("totalEmails").textContent = (
              data.stats.total || 0
            ).toLocaleString();
            document.getElementById("uniqueThreads").textContent = (
              data.stats.uniqueThreads || 0
            ).toLocaleString();
            document.getElementById("withAttachments").textContent = (
              data.stats.withAttachments || 0
            ).toLocaleString();
            document.getElementById("dateRange").textContent =
              data.stats.dateRange || "-";
          }
        }
      } catch (error) {
        console.error("[Stats] Error fetching stats:", error);
      }
    }

    function onSelectionChanged() {
      const selectedRows = gridApi.getSelectedRows();
      document.getElementById("selectedCount").textContent =
        selectedRows.length.toLocaleString();

      // Update context panel
      if (typeof updateContextPanelSelection === "function") {
        updateContextPanelSelection();
      }
    }

    function onRowClicked(event) {
      showEmailDetails(event.data);
    }

    async function showEmailDetails(emailRow) {
      const detailContent = document.getElementById("detailContent");

      // Show loading state
      detailContent.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #64748b;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-right: 12px;"></i>
                    <span>Loading email details...</span>
                </div>
            `;

      // Show detail panel if hidden
      const panel = document.getElementById("detailPanel");
      if (panel.classList.contains("hidden")) {
        toggleDetailPanel();
      }

      // Fetch full email details including attachments
      let email = emailRow;
      if (emailRow.id && !emailRow.attachments) {
        try {
          console.log("[Email] Fetching full details for:", emailRow.id);
          const response = await fetch(
            `${API_BASE}/api/correspondence/emails/${emailRow.id}`,
          );
          if (response.ok) {
            email = await response.json();
            console.log(
              "[Email] Loaded full details with",
              email.attachments?.length || 0,
              "attachments",
            );
          } else {
            console.warn(
              "[Email] Failed to fetch full details, using row data",
            );
          }
        } catch (err) {
          console.warn("[Email] Error fetching full details:", err);
        }
      }

      // Debug: Log email data to check attachments
      console.log(
        "showEmailDetails called with email:",
        email.id,
        email.subject || email.email_subject,
      );
      console.log("  - email.attachments:", email.attachments);
      console.log("  - email.meta?.attachments:", email.meta?.attachments);
      console.log("  - email.has_attachments:", email.has_attachments);

      // Use body_text_clean first (properly cleaned by backend), then fallback
      let content =
        email.body_text_clean ||
        email.body_text ||
        email.meta?.content ||
        email.content ||
        "";
      let htmlContent = email.body_html || null;

      // Prioritize direct attachments field over meta.attachments
      const attachments = email.attachments || email.meta?.attachments || [];

      // Resolve CID URLs in HTML content to actual signed URLs
      if (htmlContent && attachments.length > 0) {
        try {
          htmlContent = await resolveCidUrls(htmlContent, attachments);
        } catch (err) {
          console.warn("[CID] Error resolving CID URLs:", err);
        }
      }

      // Clean up escaped characters if still present
      if (typeof content === "string" && content) {
        // Remove Python bytes prefix if present
        if (content.startsWith("b'") || content.startsWith('b"')) {
          content = content.slice(2, -1);
        }

        // Clean up escape sequences
        content = content
          .replace(/\\r\\n/g, "\n")
          .replace(/\\n/g, "\n")
          .replace(/\\t/g, "    ")
          .replace(/\\'/g, "'")
          .replace(/\\"/g, '"')
          .replace(/\\\\/g, "\\")
          .replace(/\\x([0-9a-fA-F]{2})/g, (match, hex) =>
            String.fromCharCode(parseInt(hex, 16)),
          );

        // Remove zero-width characters
        content = content.replace(/[\u200b\u200c\u200d\ufeff\u00ad]/g, "");

        // Decode HTML entities
        const textarea = document.createElement("textarea");
        textarea.innerHTML = content;
        content = textarea.value;
      }

      if (!content && !htmlContent) {
        content = "No content available";
      }

      // Handle both full detail response (subject, sender_email) and row data (email_subject, email_from)
      const emailSubject =
        email.subject || email.email_subject || "(No Subject)";
      const emailFrom = email.sender_email || email.email_from || "-";
      const emailTo = email.recipients_to || email.email_to || "-";
      const emailCc = email.recipients_cc || email.email_cc || email.meta?.cc;
      const emailDate = email.date_sent || email.email_date;

      detailContent.innerHTML = `
                <div class="email-header">
                    <h2 class="email-subject">${emailSubject}</h2>
                    <div class="email-meta">
                        <div class="email-meta-item">
                            <span class="email-meta-label">From:</span>
                            <span>${emailFrom}</span>
                        </div>
                        <div class="email-meta-item">
                            <span class="email-meta-label">To:</span>
                            <span>${Array.isArray(emailTo) ? emailTo.join(", ") : emailTo}</span>
                        </div>
                        ${emailCc
          ? `
                        <div class="email-meta-item">
                            <span class="email-meta-label">CC:</span>
                            <span>${Array.isArray(emailCc) ? emailCc.join(", ") : emailCc}</span>
                        </div>`
          : ""
        }
                        <div class="email-meta-item">
                            <span class="email-meta-label">Date:</span>
                            <span>${emailDate ? new Date(emailDate).toLocaleString() : "-"}</span>
                        </div>
                    </div>
                </div>
                
                <div class="email-body">
                    ${(() => {
          // Check if we have HTML content
          const hasHtmlContent =
            htmlContent &&
            (htmlContent.includes("<html") ||
              htmlContent.includes("<body") ||
              htmlContent.includes("<div") ||
              htmlContent.includes("<p>"));

          if (hasHtmlContent) {
            // For HTML emails, render in iframe with sanitized content
            const safeHtml = htmlContent
              .replace(/"/g, "&quot;")
              .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, "") // Remove scripts
              .replace(/on\w+\s*=/gi, "data-disabled-"); // Disable event handlers
            return `<iframe srcdoc="${safeHtml}" 
                                    style="width: 100%; min-height: 400px; height: auto; border: 1px solid #e5e7eb; 
                                           background: white; border-radius: 0.5rem;"
                                    sandbox="allow-same-origin"
                                    onload="this.style.height = this.contentWindow.document.body.scrollHeight + 'px'"></iframe>`;
          } else {
            // For plain text emails - properly formatted
            const escapedContent = (
              content || "No content available"
            )
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;");
            return `<div style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                                    margin: 0; line-height: 1.6; background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem;
                                    color: #1e293b; font-size: 0.95rem;">${escapedContent}</div>`;
          }
        })()}
                </div>
                
                ${(() => {
          // Filter out embedded images using the same logic as backend
          const realAttachments = attachments.filter(
            (att) => !isEmbeddedImage(att),
          );
          if (realAttachments.length === 0) return "";

          return `
                <div class="email-attachments">
                    <div class="attachments-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">
                        <i class="fas fa-paperclip" style="color: #3b82f6;"></i>
                        <span style="font-weight: 600; color: #1e293b;">Attachments (${realAttachments.length})</span>
                    </div>
                    
                    <!-- Inline Preview Area -->
                    <div id="inlinePreviewArea" style="display: none; margin-bottom: 16px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f1f5f9; border-bottom: 1px solid #e5e7eb;">
                            <span id="inlinePreviewTitle" style="font-weight: 500; color: #475569; font-size: 0.9rem;"></span>
                            <button onclick="closeInlinePreview()" style="background: none; border: none; cursor: pointer; color: #64748b; font-size: 1.2rem;">&times;</button>
                        </div>
                        <div id="inlinePreviewContent" style="min-height: 200px; max-height: 400px; overflow: auto; background: #fafafa;"></div>
                    </div>
                    
                    <div class="attachment-list">
                        ${realAttachments
              .map((att) => {
                const filename =
                  att.filename || att.name || "Attachment";
                const size = att.size || att.file_size || 0;
                const contentType =
                  att.content_type || "application/octet-stream";
                const docId =
                  att.document_id || att.attachment_id || att.id;
                const icon = getFileIcon(contentType, filename);
                const ext =
                  filename.split(".").pop()?.toLowerCase() || "";
                const isPreviewable =
                  [
                    "jpg",
                    "jpeg",
                    "png",
                    "gif",
                    "webp",
                    "bmp",
                    "pdf",
                    "txt",
                    "html",
                    "htm",
                    "xml",
                    "json",
                    "csv",
                  ].includes(ext) ||
                  contentType.startsWith("image/") ||
                  contentType === "application/pdf" ||
                  contentType.startsWith("text/");
                return `
                            <div class="attachment-item" style="display: flex; align-items: center; gap: 12px; padding: 10px; 
                                        background: #f8fafc; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                                <div class="attachment-icon" style="font-size: 1.5rem; color: #64748b;">
                                    ${icon}
                                </div>
                                <div class="attachment-info" style="flex: 1; min-width: 0;">
                                    <div class="attachment-name" style="font-weight: 500; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${filename}">${filename}</div>
                                    <div class="attachment-size" style="font-size: 0.85rem; color: #64748b;">${formatFileSize(size)}</div>
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    ${isPreviewable
                    ? `
                                    <button onclick="showInlinePreview('${docId}', '${filename.replace(/'/g, "\\'")}', '${contentType}')" 
                                            style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                                            title="Preview">
                                        <i class="fas fa-eye"></i>
                                    </button>`
                    : ""
                  }
                                    <button onclick="downloadAttachment('${docId}', '${filename.replace(/'/g, "\\'")}')" 
                                            style="background: #10b981; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"
                                            title="Download">
                                <i class="fas fa-download"></i>
                                    </button>
                            </div>
                            </div>`;
              })
              .join("")}
                    </div>
                </div>`;
        })()}
            `;
    }

    function onQuickFilterChanged() {
      const filterText = document.getElementById("quickFilter").value;
      gridApi.setQuickFilter(filterText);
    }

    function toggleAdvancedFilter() {
      const sideBar = gridApi.getSideBar();
      const filtersToolPanel = sideBar ? !sideBar : true;

      gridApi.setSideBarVisible(filtersToolPanel);
      if (filtersToolPanel) {
        gridApi.openToolPanel("filters");
      }
    }

    // Stakeholder role options
    const STAKEHOLDER_ROLES = [
      "Client",
      "Main Contractor",
      "Subcontractor", 
      "Architect",
      "Structural Engineer",
      "M&E Consultant",
      "Quantity Surveyor",
      "Project Manager",
      "Building Control",
      "Council / Local Authority",
      "Legal / Solicitor",
      "Insurance",
      "Supplier",
      "Internal",
      "Other"
    ];

    async function showStakeholderFilter() {
      try {
        const projectId = resolveEntityId();
        if (!projectId || projectId === "null") {
          showNotification("No project selected", "error");
          return;
        }
        
        // Fetch unique domains from correspondence
        const response = await fetch(
          `${API_BASE}/api/wizard/projects/${projectId}/domains`,
        );
        
        if (!response.ok) {
          throw new Error("Failed to fetch domains");
        }
        
        const data = await response.json();
        const domains = data.domains || [];

        if (domains.length === 0) {
          showNotification("No email domains found. Upload some PST files first.", "info");
          return;
        }

        // Create stakeholder manager modal
        const modal = document.createElement("div");
        modal.className = "stakeholder-manager-modal";
        modal.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: var(--bg-white, #ffffff); padding: 24px; border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.2); z-index: 1000;
          min-width: 700px; max-width: 900px; max-height: 85vh;
          display: flex; flex-direction: column;
          font-family: var(--font-primary, 'Instrument Sans', sans-serif);
        `;

        modal.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--gray-200, #e5e7eb);">
            <div>
              <h2 style="margin: 0; color: var(--vericase-navy, #1a365d); font-size: 20px;">
                <i class="fas fa-users" style="margin-right: 10px; color: var(--vericase-teal, #0d9488);"></i>
                Stakeholder Manager
              </h2>
              <p style="margin: 4px 0 0 0; color: var(--text-muted, #6b7280); font-size: 13px;">
                Assign roles to email domains found in your correspondence (${domains.length} domains found)
              </p>
            </div>
            <button onclick="closeStakeholderModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted, #6b7280); padding: 4px;">&times;</button>
          </div>
          
          <div style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead style="position: sticky; top: 0; background: var(--bg-white, #ffffff); z-index: 1;">
                <tr style="border-bottom: 2px solid var(--vericase-teal, #0d9488);">
                  <th style="text-align: left; padding: 12px 8px; color: var(--vericase-navy, #1a365d); font-weight: 600;">Domain</th>
                  <th style="text-align: center; padding: 12px 8px; color: var(--vericase-navy, #1a365d); font-weight: 600; width: 80px;">Emails</th>
                  <th style="text-align: center; padding: 12px 8px; color: var(--vericase-navy, #1a365d); font-weight: 600; width: 80px;">Sent</th>
                  <th style="text-align: center; padding: 12px 8px; color: var(--vericase-navy, #1a365d); font-weight: 600; width: 80px;">Received</th>
                  <th style="text-align: left; padding: 12px 8px; color: var(--vericase-navy, #1a365d); font-weight: 600; width: 200px;">Role</th>
                  <th style="text-align: left; padding: 12px 8px; color: var(--vericase-navy, #1a365d); font-weight: 600;">Organization Name</th>
                </tr>
              </thead>
              <tbody id="stakeholderTableBody">
                ${domains.map((d, idx) => `
                  <tr data-domain="${d.domain}" style="border-bottom: 1px solid var(--gray-100, #f3f4f6); ${idx % 2 === 0 ? 'background: var(--bg-primary, #faf9f7);' : ''}">
                    <td style="padding: 10px 8px;">
                      <span style="font-family: monospace; background: var(--gray-100, #f3f4f6); padding: 2px 6px; border-radius: 4px;">
                        ${d.domain}
                      </span>
                    </td>
                    <td style="text-align: center; padding: 10px 8px; font-weight: 500;">${d.total_emails}</td>
                    <td style="text-align: center; padding: 10px 8px; color: var(--vericase-teal, #0d9488);">${d.as_sender}</td>
                    <td style="text-align: center; padding: 10px 8px; color: var(--text-muted, #6b7280);">${d.as_recipient}</td>
                    <td style="padding: 10px 8px;">
                      <select 
                        class="stakeholder-role-select"
                        data-domain="${d.domain}"
                        style="width: 100%; padding: 6px 8px; border: 1px solid var(--gray-200, #e5e7eb); border-radius: 6px; font-size: 13px; background: white; cursor: pointer;"
                      >
                        <option value="">-- Select Role --</option>
                        ${STAKEHOLDER_ROLES.map(role => `
                          <option value="${role}" ${d.role === role ? 'selected' : ''}>${role}</option>
                        `).join('')}
                      </select>
                    </td>
                    <td style="padding: 10px 8px;">
                      <input 
                        type="text" 
                        class="stakeholder-org-input"
                        data-domain="${d.domain}"
                        value="${d.organization || ''}"
                        placeholder="Organization name..."
                        style="width: 100%; padding: 6px 8px; border: 1px solid var(--gray-200, #e5e7eb); border-radius: 6px; font-size: 13px;"
                      >
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--gray-200, #e5e7eb);">
            <div style="color: var(--text-muted, #6b7280); font-size: 12px;">
              <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
              Roles are used to tag emails and filter correspondence
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="closeStakeholderModal()" style="padding: 10px 20px; background: var(--gray-100, #e5e7eb); color: var(--text-primary, #374151); border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                Cancel
              </button>
              <button onclick="saveStakeholderMappings()" style="padding: 10px 24px; background: var(--vericase-teal, #0d9488); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                <i class="fas fa-save" style="margin-right: 6px;"></i>
                Save Changes
              </button>
            </div>
          </div>
        `;

        // Add backdrop
        const backdrop = document.createElement("div");
        backdrop.id = "stakeholderBackdrop";
        backdrop.style.cssText =
          "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;";
        backdrop.onclick = () => closeStakeholderModal();

        document.body.appendChild(backdrop);
        document.body.appendChild(modal);

        // Store modal reference
        window.stakeholderModal = modal;
        window.stakeholderBackdrop = backdrop;
        
      } catch (error) {
        console.error("Error loading stakeholders:", error);
        showNotification("Failed to load stakeholder data", "error");
      }
    }

    function closeStakeholderModal() {
      if (window.stakeholderModal) {
        window.stakeholderModal.remove();
        window.stakeholderModal = null;
      }
      if (window.stakeholderBackdrop) {
        window.stakeholderBackdrop.remove();
        window.stakeholderBackdrop = null;
      }
    }

    async function saveStakeholderMappings() {
      try {
        const projectId = resolveEntityId();
        if (!projectId || projectId === "null") {
          showNotification("No project selected", "error");
          return;
        }

        // Collect all mappings with a role selected
        const mappings = [];
        const rows = document.querySelectorAll('#stakeholderTableBody tr[data-domain]');
        
        rows.forEach(row => {
          const domain = row.dataset.domain;
          const roleSelect = row.querySelector('.stakeholder-role-select');
          const orgInput = row.querySelector('.stakeholder-org-input');
          
          const role = roleSelect?.value;
          const organization = orgInput?.value?.trim();
          
          if (role) {
            mappings.push({
              domain: domain,
              role: role,
              organization: organization || null
            });
          }
        });

        if (mappings.length === 0) {
          showNotification("No roles assigned. Select at least one role to save.", "warning");
          return;
        }

        // Save to API
        const response = await fetch(
          `${API_BASE}/api/wizard/projects/${projectId}/stakeholders/bulk`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mappings })
          }
        );

        if (!response.ok) {
          throw new Error("Failed to save stakeholder mappings");
        }

        const result = await response.json();
        showNotification(
          `Saved ${result.created} new and updated ${result.updated} stakeholder mappings`,
          "success"
        );
        
        closeStakeholderModal();
        
        // Refresh grid to show updated stakeholder tags
        if (gridApi) {
          gridApi.refreshInfiniteCache();
        }
        
      } catch (error) {
        console.error("Error saving stakeholder mappings:", error);
        showNotification("Failed to save stakeholder mappings", "error");
      }
    }

    async function showKeywordFilter() {
      try {
        let keywords = [];

        // Try to fetch keywords from API
        const entityId = resolveEntityId();
        if (entityId && entityId !== "null") {
          try {
            const response = await fetch(
              `${API_BASE}/api/unified/${entityId}/keywords`,
            );
            if (response.ok) {
              keywords = await response.json();
            }
          } catch (apiErr) {
            console.warn("Failed to fetch keywords from API:", apiErr);
          }
        }

        // Also collect keywords from current grid data
        const gridKeywords = new Set();
        gridApi.forEachNode((node) => {
          const matched = node.data.matched_keywords || [];
          if (Array.isArray(matched)) {
            matched.forEach((k) => gridKeywords.add(k));
          }
        });

        // Merge API keywords with grid keywords
        const allKeywords = [...keywords];
        gridKeywords.forEach((gk) => {
          if (!allKeywords.find((k) => k.name === gk)) {
            allKeywords.push({ name: gk, variations: "" });
          }
        });

        // Add fallback keywords if none found
        if (allKeywords.length === 0) {
          allKeywords.push(
            { name: "Relevant Event", variations: "" },
            { name: "Relevant Matter", variations: "" },
            {
              name: "Section 278",
              variations: "Highways Agreement, Section 106",
            },
            { name: "Delay", variations: "delays, delayed, postpone" },
            { name: "Risk", variations: "risks, risky" },
            { name: "Change", variations: "changes, changed, modification" },
            { name: "Extension of Time", variations: "EOT" },
            { name: "Variation", variations: "VO, variation order" },
          );
        }

        // Create filter modal
        const modal = document.createElement("div");
        modal.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: white; padding: 20px; border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 1000;
                    min-width: 350px; max-width: 450px;
                `;

        modal.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: var(--vericase-navy);">
                            <i class="fas fa-tags" style="color: var(--vericase-teal); margin-right: 8px;"></i>
                            Filter by Keyword
                        </h3>
                        <button onclick="closeFilterModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="keywordSearchInput" placeholder="Search keywords..." 
                               style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem;"
                               oninput="filterKeywordList(this.value)">
                    </div>
                    <div id="keywordList" style="max-height: 300px; overflow-y: auto; margin-bottom: 16px; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px;">
                        ${allKeywords
            .map(
              (k) => `
                            <label class="keyword-item" style="display: flex; align-items: center; padding: 8px; margin-bottom: 4px; cursor: pointer; border-radius: 4px; transition: background 0.2s;"
                                   onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" value="${k.name}" style="margin-right: 10px; width: 18px; height: 18px;">
                                <div>
                                    <span style="font-weight: 500; color: #374151;">${k.name}</span>
                                    ${k.variations ? `<small style="display: block; color: #9ca3af; font-size: 0.75rem;">${k.variations}</small>` : ""}
                                </div>
                            </label>
                        `,
            )
            .join("")}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="applyKeywordFilter()" style="flex: 1; padding: 10px 16px; background: var(--vericase-teal); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-filter" style="margin-right: 6px;"></i> Apply Filter
                        </button>
                        <button onclick="clearKeywordFilter()" style="flex: 1; padding: 10px 16px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-times" style="margin-right: 6px;"></i> Clear
                        </button>
                    </div>
                `;

        // Add backdrop
        const backdrop = document.createElement("div");
        backdrop.style.cssText =
          "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;";
        backdrop.onclick = () => closeFilterModal();

        document.body.appendChild(backdrop);
        document.body.appendChild(modal);

        // Store modal references globally
        window.keywordModal = modal;
        window.keywordBackdrop = backdrop;
      } catch (error) {
        console.error("Error loading keywords:", error);
        showNotification(
          "Failed to load keywords: " + error.message,
          "error",
        );
      }
    }

    function filterKeywordList(searchTerm) {
      const items = document.querySelectorAll(".keyword-item");
      const term = searchTerm.toLowerCase();
      items.forEach((item) => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(term) ? "flex" : "none";
      });
    }

    function applyStakeholderFilter() {
      const modal = window.stakeholderModal;
      const checked = Array.from(
        modal.querySelectorAll('input[type="checkbox"]:checked'),
      ).map((cb) => cb.value);

      if (checked.length > 0) {
        // Apply filter to stakeholder column
        const filterInstance = gridApi.getFilterInstance("stakeholder");
        filterInstance.setModel({
          filterType: "set",
          values: checked,
        });
        gridApi.onFilterChanged();
      }

      closeFilterModal();
      showNotification(
        `Filtering by ${checked.length} stakeholder(s)`,
        "success",
      );
    }

    // Store active keyword filters globally
    window.activeKeywordFilters = [];

    function applyKeywordFilter() {
      const modal = window.keywordModal;
      const checked = Array.from(
        modal.querySelectorAll('input[type="checkbox"]:checked'),
      ).map((cb) => cb.value);

      // Store the selected keywords for external filter
      window.activeKeywordFilters = checked;

      if (checked.length > 0) {
        // Use external filter for more flexible matching
        gridApi.setGridOption(
          "isExternalFilterPresent",
          () => window.activeKeywordFilters.length > 0,
        );
        gridApi.setGridOption("doesExternalFilterPass", (node) => {
          if (window.activeKeywordFilters.length === 0) return true;

          const matchedKeywords = node.data.matched_keywords || [];
          const keywordsStr = node.data.keywords || "";
          const bodyText = (node.data.body_text || "").toLowerCase();
          const subject = (
            node.data.subject ||
            node.data.email_subject ||
            ""
          ).toLowerCase();

          // Check if any selected keyword matches
          return window.activeKeywordFilters.some((keyword) => {
            const kw = keyword.toLowerCase();
            // Check matched_keywords array
            if (
              Array.isArray(matchedKeywords) &&
              matchedKeywords.some((mk) => mk.toLowerCase().includes(kw))
            ) {
              return true;
            }
            // Check keywords string
            if (keywordsStr.toLowerCase().includes(kw)) {
              return true;
            }
            // Check body text and subject
            if (bodyText.includes(kw) || subject.includes(kw)) {
              return true;
            }
            return false;
          });
        });
        gridApi.onFilterChanged();
      }

      closeFilterModal();
      showNotification(
        `Filtering by ${checked.length} keyword(s): ${checked.join(", ")}`,
        "success",
      );
    }

    function clearStakeholderFilter() {
      const filterInstance = gridApi.getFilterInstance("stakeholder");
      filterInstance.setModel(null);
      gridApi.onFilterChanged();
      closeFilterModal();
      showNotification("Stakeholder filter cleared", "info");
    }

    function clearKeywordFilter() {
      // Clear external keyword filter
      window.activeKeywordFilters = [];
      gridApi.setGridOption("isExternalFilterPresent", () => false);
      gridApi.onFilterChanged();

      // Also clear the AG-Grid column filter if it exists
      try {
        const filterInstance = gridApi.getFilterInstance("keywords");
        if (filterInstance) {
          filterInstance.setModel(null);
        }
      } catch (e) {
        // Ignore if filter doesn't exist
      }

      closeFilterModal();
      showNotification("Keyword filter cleared", "info");
    }

    function closeFilterModal() {
      if (window.stakeholderModal) {
        window.stakeholderModal.remove();
        window.stakeholderModal = null;
      }
      if (window.stakeholderBackdrop) {
        window.stakeholderBackdrop.remove();
        window.stakeholderBackdrop = null;
      }
      if (window.keywordModal) {
        window.keywordModal.remove();
        window.keywordModal = null;
      }
      if (window.keywordBackdrop) {
        window.keywordBackdrop.remove();
        window.keywordBackdrop = null;
      }
    }

    function setViewMode(mode) {
      currentViewMode = mode;

      // Update button states
      document.querySelectorAll(".btn-group .btn").forEach((btn) => {
        btn.classList.remove("active");
      });
      event.target.classList.add("active");

      // Apply filters based on mode
      switch (mode) {
        case "all":
          gridApi.setFilterModel(null);
          break;
        case "threads":
          gridApi.setFilterModel({
            thread_id: {
              type: "notBlank",
            },
          });
          break;
        case "attachments":
          // Custom filter for attachments
          gridApi.onFilterChanged();
          break;
      }
    }

    function toggleDetailPanel() {
      const panel = document.getElementById("detailPanel");
      panel.classList.toggle("hidden");
    }

    function openRefinementWizard() {
      // Get current project/case ID from URL params
      const urlParams = new URLSearchParams(window.location.search);
      const projectId =
        urlParams.get("profileId") || urlParams.get("projectId");

      // Open the new AI-powered refinement wizard
      const wizardUrl = `ai-refinement-wizard.html?projectId=${projectId}`;
      window.location.href = wizardUrl; // Navigate to the wizard
    }

    function exportToExcel() {
      gridApi.exportDataAsExcel({
        fileName: `case_${caseId}_emails_${new Date().toISOString().split("T")[0]}.xlsx`,
        sheetName: "Emails",
        processCellCallback: (params) => {
          // Clean up HTML content for Excel
          if (params.column.colId === "email_subject") {
            return params.value || "(No Subject)";
          }
          return params.value;
        },
      });
    }

    function printEmails() {
      const selectedRows = gridApi.getSelectedRows();
      const emailsToPrint =
        selectedRows.length > 0 ? selectedRows : allEmails;

      const printWindow = window.open("", "_blank");
      printWindow.document.write(`
                <html>
                <head>
                    <title>Email Correspondence - Case ${caseId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        .email { border-bottom: 2px solid #ccc; padding: 20px 0; page-break-inside: avoid; }
                        .email-header { margin-bottom: 10px; }
                        .email-subject { font-size: 18px; font-weight: bold; }
                        .email-meta { color: #666; font-size: 14px; margin: 5px 0; }
                        .email-body { margin-top: 15px; white-space: pre-wrap; }
                    </style>
                </head>
                <body>
                    <h1>Email Correspondence - Case ${caseId}</h1>
                    ${emailsToPrint
          .map(
            (email) => `
                        <div class="email">
                            <div class="email-header">
                                <div class="email-subject">${email.email_subject || "(No Subject)"}</div>
                                <div class="email-meta">From: ${email.email_from || "-"}</div>
                                <div class="email-meta">To: ${email.email_to || "-"}</div>
                                <div class="email-meta">Date: ${email.email_date ? new Date(email.email_date).toLocaleString() : "-"}</div>
                            </div>
                            <div class="email-body">${email.meta?.content || email.content || "No content"}</div>
                        </div>
                    `,
          )
          .join("")}
                </body>
                </html>
            `);
      printWindow.document.close();
      printWindow.print();
    }

    function refreshData() {
      // For server-side row model, refresh via purge and reload
      if (gridApi) {
        gridApi.refreshServerSide({ purge: true });
        console.log("[Grid] Server-side data refreshed");
      }
    }

    function goToDashboard() {
      const token = localStorage.getItem("token");
      const caseId = localStorage.getItem("currentCaseId");
      if (token && caseId) {
        window.location.href = `dashboard.html?token=${token}&caseId=${caseId}`;
      } else if (token) {
        window.location.href = `dashboard.html?token=${token}`;
      } else {
        window.location.href = "dashboard.html";
      }
    }

    function showLoading(show) {
      document.getElementById("loadingOverlay").style.display = show
        ? "flex"
        : "none";
    }

    function formatFileSize(bytes) {
      if (!bytes) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return (
        Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
      );
    }

    function getFileIcon(contentType, filename) {
      const ext = (filename || "").split(".").pop()?.toLowerCase() || "";
      const type = (contentType || "").toLowerCase();

      if (
        type.startsWith("image/") ||
        ["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)
      ) {
        return '<i class="fas fa-file-image" style="color: #10b981;"></i>';
      }
      if (type === "application/pdf" || ext === "pdf") {
        return '<i class="fas fa-file-pdf" style="color: #ef4444;"></i>';
      }
      if (type.includes("word") || ["doc", "docx"].includes(ext)) {
        return '<i class="fas fa-file-word" style="color: #2563eb;"></i>';
      }
      if (
        type.includes("excel") ||
        type.includes("spreadsheet") ||
        ["xls", "xlsx", "csv"].includes(ext)
      ) {
        return '<i class="fas fa-file-excel" style="color: #22c55e;"></i>';
      }
      if (
        type.includes("powerpoint") ||
        type.includes("presentation") ||
        ["ppt", "pptx"].includes(ext)
      ) {
        return '<i class="fas fa-file-powerpoint" style="color: #f97316;"></i>';
      }
      if (
        type.includes("zip") ||
        type.includes("compressed") ||
        ["zip", "rar", "7z", "tar", "gz"].includes(ext)
      ) {
        return '<i class="fas fa-file-archive" style="color: #f59e0b;"></i>';
      }
      if (type.startsWith("text/") || ["txt", "log", "md"].includes(ext)) {
        return '<i class="fas fa-file-alt" style="color: #6b7280;"></i>';
      }
      if (["dwg", "dxf", "dgn"].includes(ext)) {
        return '<i class="fas fa-drafting-compass" style="color: #8b5cf6;"></i>';
      }
      return '<i class="fas fa-file" style="color: #64748b;"></i>';
    }

    /**
     * Check if an attachment is an embedded/inline image that should be hidden from attachment lists.
     * Mirrors the backend _is_embedded_image() logic.
     *
     * @param {Object} att - Attachment object
     * @returns {boolean} - True if this is an embedded image to hide
     */
    function isEmbeddedImage(att) {
      // Trust the is_inline flag set by the PST processor
      if (att.is_inline === true) return true;

      // Has content_id - it's inline

      const filename = (att.filename || att.name || "").toLowerCase();
      const contentType = (att.content_type || "").toLowerCase();
      const fileSize = att.file_size || att.size || 0;

      // Exclude common embedded image patterns
      if (/^image\d{3}\.(png|jpg|jpeg|gif|bmp)$/.test(filename)) return true; // image001.png
      if (/^img_?\d+\.(png|jpg|jpeg|gif|bmp)$/.test(filename)) return true; // img_001.png
      if (filename.startsWith("cid:") || filename.startsWith("cid_"))
        return true;

      // Exclude signature/logo images
      const excludedKeywords = [
        "signature",
        "logo",
        "banner",
        "header",
        "footer",
        "badge",
        "icon",
      ];
      for (const keyword of excludedKeywords) {
        if (filename.includes(keyword) && contentType.includes("image")) {
          return true;
        }
      }

      // Exclude tracking pixels and spacers
      const trackingFiles = [
        "blank.gif",
        "spacer.gif",
        "pixel.gif",
        "1x1.gif",
        "oledata.mso",
      ];
      if (trackingFiles.includes(filename)) return true;

      // Very small images (< 20KB) with image content type are likely embedded icons/logos
      if (contentType.includes("image") && fileSize > 0 && fileSize < 20000) {
        return true;
      }

      return false;
    }

    /**
     * Check if attachment is an IMAGE file (not embedded)
     * @param {Object} att - Attachment object
     * @returns {boolean} - True if this is a visible image attachment
     */
    function isImageAttachment(att) {
      // If it's embedded, it's not a "real" image attachment the user cares about
      if (isEmbeddedImage(att)) return false;

      const filename = (att.filename || att.name || "").toLowerCase();
      const contentType = (att.content_type || "").toLowerCase();

      // Check for image extensions
      const imageExtensions = [
        ".png",
        ".jpg",
        ".jpeg",
        ".gif",
        ".bmp",
        ".webp",
        ".tiff",
        ".tif",
        ".svg",
      ];
      const hasImageExt = imageExtensions.some((ext) =>
        filename.endsWith(ext),
      );

      // Check content type
      const isImageType = contentType.startsWith("image/");

      return hasImageExt || isImageType;
    }

    /**
     * Check if attachment is a DOCUMENT (not an image, not embedded)
     * @param {Object} att - Attachment object
     * @returns {boolean} - True if this is a document attachment
     */
    function isDocumentAttachment(att) {
      // If it's embedded, skip it
      if (isEmbeddedImage(att)) return false;
      // If it's an image, it goes in the Images column
      if (isImageAttachment(att)) return false;
      return true;
    }

    /**
     * Resolve CID (Content-ID) references in HTML email content to actual URLs.
     * CID references like "cid:image123.png@ABC123.DEF456" reference inline attachments.
     * This function replaces them with signed S3 URLs.
     *
     * @param {string} htmlContent - The HTML content with potential CID references
     * @param {Array} attachments - Array of attachment objects (may include inline images)
     * @returns {Promise<string>} - HTML content with CID URLs replaced
     */
    async function resolveCidUrls(htmlContent, attachments) {
      if (!htmlContent || !attachments || attachments.length === 0) {
        return htmlContent;
      }

      // Find all CID references in the HTML
      // Format: cid:filename@contentid or just cid:contentid
      const cidPattern = /cid:([^"'\s>]+)/gi;
      const cidMatches = [...htmlContent.matchAll(cidPattern)];

      if (cidMatches.length === 0) {
        return htmlContent;
      }

      console.log(
        "[CID] Found",
        cidMatches.length,
        "CID references to resolve",
      );

      // Build a map of content_id to attachment
      // Also map by filename since some CID refs use filename
      const cidMap = new Map();
      const inlineAttachments = attachments.filter(
        (att) => att.is_inline || att.content_id,
      );

      for (const att of inlineAttachments) {
        const attId = att.document_id || att.attachment_id || att.id;
        if (att.content_id) {
          // Normalize content_id (remove angle brackets if present)
          const normalizedCid = att.content_id.replace(/^<|>$/g, "");
          cidMap.set(normalizedCid.toLowerCase(), { att, attId });
          // Also store without any @ suffix
          const baseCid = normalizedCid.split("@")[0];
          if (baseCid) cidMap.set(baseCid.toLowerCase(), { att, attId });
        }
        // Also map by filename
        if (att.filename) {
          cidMap.set(att.filename.toLowerCase(), { att, attId });
        }
      }

      // Fetch signed URLs for matched CIDs
      const urlCache = new Map();
      let resolvedHtml = htmlContent;

      for (const match of cidMatches) {
        const fullCid = match[1]; // The captured CID reference
        const normalizedCid = fullCid.toLowerCase();

        // Try to find matching attachment
        let mappedAtt = cidMap.get(normalizedCid);

        // If not found, try matching just the filename part (before @)
        if (!mappedAtt) {
          const filenamePart = fullCid.split("@")[0];
          if (filenamePart) {
            mappedAtt = cidMap.get(filenamePart.toLowerCase());
          }
        }

        // Try partial match on filename
        if (!mappedAtt) {
          for (const [key, value] of cidMap.entries()) {
            if (
              normalizedCid.includes(key) ||
              key.includes(normalizedCid.split("@")[0])
            ) {
              mappedAtt = value;
              break;
            }
          }
        }

        if (mappedAtt) {
          const { attId } = mappedAtt;

          // Check cache first
          if (!urlCache.has(attId)) {
            try {
              const resp = await fetch(
                `${API_BASE}/api/correspondence/attachments/${attId}/signed-url`,
              );
              if (resp.ok) {
                const data = await resp.json();
                urlCache.set(attId, data.url);
              } else {
                console.warn(
                  "[CID] Failed to get signed URL for attachment:",
                  attId,
                );
                urlCache.set(attId, null);
              }
            } catch (err) {
              console.warn("[CID] Error fetching signed URL:", err);
              urlCache.set(attId, null);
            }
          }

          const signedUrl = urlCache.get(attId);
          if (signedUrl) {
            // Replace the CID reference with the actual URL
            const cidRef = `cid:${fullCid}`;
            resolvedHtml = resolvedHtml.split(cidRef).join(signedUrl);
            console.log(
              "[CID] Resolved:",
              fullCid,
              "‚Üí",
              signedUrl.substring(0, 50) + "...",
            );
          }
        } else {
          console.log("[CID] No matching attachment found for:", fullCid);
        }
      }

      return resolvedHtml;
    }

    // Inline preview functions for attachment panel
    async function showInlinePreview(docId, filename, contentType) {
      const previewArea = document.getElementById("inlinePreviewArea");
      const previewTitle = document.getElementById("inlinePreviewTitle");
      const previewContent = document.getElementById("inlinePreviewContent");

      if (!previewArea || !previewContent) {
        console.error("Inline preview elements not found");
        // Fall back to modal preview
        await previewAttachment(null, docId, filename);
        return;
      }

      previewArea.style.display = "block";
      previewTitle.textContent = filename;
      previewContent.innerHTML =
        '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="margin-top: 16px; color: #64748b;">Loading preview...</p></div>';

      try {
        const fileData = await getSignedUrlForDocument(docId);
        const { url, content_type } = fileData;
        const ext = (filename || "").split(".").pop()?.toLowerCase() || "";
        const type = (content_type || contentType || "").toLowerCase();

        const isImage =
          type.startsWith("image/") ||
          ["jpg", "jpeg", "png", "gif", "webp", "bmp", "svg"].includes(ext);
        const isPdf = type === "application/pdf" || ext === "pdf";
        const isText =
          type.startsWith("text/") ||
          ["txt", "html", "htm", "xml", "json", "csv", "log", "md"].includes(
            ext,
          );

        if (isImage) {
          previewContent.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; padding: 20px; background: #f8fafc;">
                            <img src="${url}" style="max-width: 100%; max-height: 350px; object-fit: contain; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" 
                                 onerror="this.parentElement.innerHTML='<p style=\\'color: #ef4444;\\'>Failed to load image</p>'" />
                        </div>
                        <div style="padding: 8px 12px; background: #f1f5f9; border-top: 1px solid #e5e7eb; text-align: center;">
                            <a href="${url}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 0.85rem;">
                                <i class="fas fa-external-link-alt"></i> Open in new tab
                            </a>
                        </div>`;
        } else if (isPdf) {
          previewContent.innerHTML = `
                        <iframe src="${url}#toolbar=1&navpanes=0" style="width: 100%; height: 350px; border: none;"></iframe>
                        <div style="padding: 8px 12px; background: #f1f5f9; border-top: 1px solid #e5e7eb; text-align: center;">
                            <a href="${url}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 0.85rem;">
                                <i class="fas fa-external-link-alt"></i> Open PDF in new tab
                            </a>
                        </div>`;
        } else if (isText) {
          // Fetch and display text content
          try {
            const textResp = await fetch(url);
            const text = await textResp.text();
            const escapedText = text
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;");
            previewContent.innerHTML = `
                            <pre style="margin: 0; padding: 16px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; 
                                        white-space: pre-wrap; word-wrap: break-word; background: #1e293b; color: #e2e8f0; 
                                        max-height: 350px; overflow: auto;">${escapedText}</pre>
                            <div style="padding: 8px 12px; background: #f1f5f9; border-top: 1px solid #e5e7eb; text-align: center;">
                                <a href="${url}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 0.85rem;">
                                    <i class="fas fa-external-link-alt"></i> Open in new tab
                                </a>
                            </div>`;
          } catch (e) {
            previewContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #ef4444;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 12px;"></i>
                                <p>Failed to load text content</p>
                            </div>`;
          }
        } else {
          // Non-previewable file type - show info and download option
          previewContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #f8fafc;">
                            <div style="font-size: 3rem; margin-bottom: 16px; color: #64748b;">
                                ${getFileIcon(type, filename)}
                            </div>
                            <p style="color: #475569; margin-bottom: 8px; font-weight: 500;">${filename}</p>
                            <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 20px;">Preview not available for this file type</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <a href="${url}" target="_blank" 
                                   style="background: #3b82f6; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500;">
                                    <i class="fas fa-external-link-alt"></i> Open
                                </a>
                                <a href="${url}" download="${filename}"
                                   style="background: #10b981; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500;">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>`;
        }
      } catch (error) {
        console.error("Preview error:", error);
        previewContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 12px;"></i>
                        <p style="font-weight: 500;">Failed to load preview</p>
                        <p style="font-size: 0.85rem; color: #64748b; margin-top: 8px;">${error.message || "Unknown error"}</p>
                    </div>`;
      }
    }

    function closeInlinePreview() {
      const previewArea = document.getElementById("inlinePreviewArea");
      if (previewArea) {
        previewArea.style.display = "none";
      }
    }

    async function previewOrDownloadAttachment(docId, filename, contentType) {
      const ext = (filename || "").split(".").pop()?.toLowerCase() || "";
      const type = (contentType || "").toLowerCase();

      // Previewable types
      const previewable =
        type.startsWith("image/") ||
        type === "application/pdf" ||
        ["jpg", "jpeg", "png", "gif", "bmp", "webp", "pdf"].includes(ext);

      if (previewable) {
        await previewAttachment(null, docId, filename);
      } else {
        await downloadAttachment(docId, filename);
      }
    }

    // Store current attachment info for download
    let currentAttachment = null;

    // Helpers for signed URL previews/downloads
    async function getSignedUrlForDocument(documentId) {
      // Try the email attachments endpoint first (for PST-extracted attachments)
      let resp = await fetch(
        `${API_BASE}/api/correspondence/attachments/${documentId}/signed-url`,
      );
      if (resp.ok) {
        return resp.json(); // { url, filename, content_type }
      }

      // Fall back to documents endpoint (for uploaded documents)
      resp = await fetch(`${API_BASE}/documents/${documentId}/signed_url`);
      if (!resp.ok) throw new Error("Failed to get signed URL");
      return resp.json(); // { url, filename, content_type }
    }
    function looksLikeUuid(v) {
      return typeof v === "string" && /^[0-9a-fA-F-]{32,36}$/.test(v);
    }

    // Function to copy OCR text to clipboard
    window.copyOCRText = async function () {
      const ocrTextElement = document.getElementById("ocrTextContent");
      if (!ocrTextElement) return;

      // Get text without HTML tags
      const text = ocrTextElement.innerText || ocrTextElement.textContent;

      try {
        await navigator.clipboard.writeText(text);
        // Show success feedback
        const button = event.target.closest("button");
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.style.background = "#10b981";
        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.style.background = "#10b981";
        }, 2000);
      } catch (err) {
        console.error("Failed to copy text:", err);
        alert("Failed to copy text. Please select and copy manually.");
      }
    };

    // Function to preview attachment (accepts legacy args but uses document signed URL)
    window.previewAttachment = async function (
      evidenceId,
      attachmentId,
      fileName,
    ) {
      const modal = document.getElementById("attachmentPreviewModal");
      const previewContent = document.getElementById("previewContent");
      const previewTitle = document.getElementById("previewTitle");

      // Derive a documentId from legacy args (most data passes document_id as attachmentId)
      const documentId = looksLikeUuid(attachmentId)
        ? attachmentId
        : evidenceId;

      // Store current info
      currentAttachment = {
        evidenceId: documentId,
        attachmentId: documentId,
        fileName,
      };

      // Show modal
      modal.style.display = "flex";
      previewTitle.textContent = `Preview: ${fileName}`;
      previewContent.innerHTML =
        '<div style="text-align: center; padding: 50px;"><div class="spinner"></div><p style="margin-top: 20px; color: #6b7280;">Loading preview and OCR text...</p></div>';

      try {
        // Load both the file URL and OCR text in parallel
        const [fileData, ocrData] = await Promise.all([
          getSignedUrlForDocument(documentId),
          fetch(
            `${API_BASE}/api/correspondence/attachments/${documentId}/ocr-text`,
          )
            .then((r) => (r.ok ? r.json() : null))
            .catch(() => null),
        ]);

        const { url, content_type } = fileData;
        const lowerName = (fileName || "").toLowerCase();
        const isImage =
          /\.(png|jpg|jpeg|gif|webp|bmp|svg)$/.test(lowerName) ||
          (content_type || "").startsWith("image/");
        const isPdf =
          /\.pdf$/.test(lowerName) || content_type === "application/pdf";

        // Build preview HTML with OCR panel
        let previewHTML =
          '<div style="display: flex; height: 100%; gap: 20px;">';

        // Left panel: Document preview (2/3 width)
        previewHTML +=
          '<div style="flex: 2; display: flex; flex-direction: column; min-width: 0;">';

        if (isImage) {
          previewHTML += `
                        <div style="flex: 1; display: flex; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 8px; overflow: hidden;">
                            <img src="${url}" style="max-width: 100%; max-height: 100%; object-fit: contain;"/>
                        </div>`;
        } else if (isPdf) {
          previewHTML += `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f9fafb; border-radius: 8px; padding: 40px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">üìÑ</div>
                            <h3 style="color: #1f2937; margin-bottom: 10px; text-align: center;">${fileName || "Document"}</h3>
                            <p style="color: #6b7280; margin-bottom: 20px; text-align: center;">PDF viewer opens in new tab</p>
                            <button onclick="window.open('${url}', '_blank')"
                                    style="background: #3b82f6; color: white; border: none; padding: 12px 24px; 
                                           border-radius: 6px; cursor: pointer; font-weight: 500; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
                                <i class="fas fa-external-link-alt"></i> Open PDF
                            </button>
                        </div>`;
        } else {
          previewHTML += `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f9fafb; border-radius: 8px; padding: 40px;">
                            <div style="font-size: 3rem; margin-bottom: 20px;">üìé</div>
                            <p style="color: #6b7280; margin-bottom: 20px; text-align: center;">Preview not available for this file type</p>
                            <button onclick="window.open('${url}', '_blank')" 
                                    style="background: #10b981; color: white; border: none; padding: 12px 24px;
                                           border-radius: 6px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-download"></i> Download File
                            </button>
                        </div>`;
        }

        previewHTML += "</div>";

        // Right panel: OCR Text (1/3 width, if available)
        if (
          ocrData &&
          (ocrData.extracted_text || ocrData.ocr_status === "processing")
        ) {
          previewHTML +=
            '<div style="flex: 1; display: flex; flex-direction: column; border-left: 2px solid #e5e7eb; padding-left: 20px; min-width: 0;">';
          previewHTML +=
            '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 10px;">';
          previewHTML +=
            '<h4 style="margin: 0; color: #1f2937; font-size: 0.95rem; flex: 1;"><i class="fas fa-scroll" style="color: #17B5A3;"></i> OCR Extracted Text</h4>';

          if (ocrData.extracted_text) {
            previewHTML += `
                            <button onclick="copyOCRText()" title="Copy text to clipboard"
                                    style="background: #10b981; color: white; border: none; padding: 6px 12px;
                                           border-radius: 6px; cursor: pointer; font-size: 0.813rem; font-weight: 500; white-space: nowrap;">
                                <i class="fas fa-copy"></i> Copy
                            </button>`;
          }
          previewHTML += "</div>";

          if (ocrData.ocr_status === "processing") {
            previewHTML += `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fef3c7; border-radius: 8px; padding: 20px;">
                                <div class="spinner" style="width: 32px; height: 32px; border-width: 3px;"></div>
                                <p style="margin-top: 16px; color: #92400e; font-weight: 500; text-align: center;">Processing OCR...</p>
                                <p style="margin-top: 8px; color: #78350f; font-size: 0.875rem; text-align: center;">Text extraction in progress.<br>Refresh preview in a moment.</p>
                            </div>`;
          } else if (ocrData.extracted_text) {
            // Highlight keywords in OCR text
            let highlightedText = ocrData.extracted_text;

            // Get keywords from current case/project (if available)
            try {
              const entityId = resolveEntityId();
              if (entityId && entityId !== "null") {
                const keywordsResponse = await fetch(
                  `${API_BASE}/api/unified/${entityId}/keywords`,
                  {
                    headers: {
                      Authorization: `Bearer ${localStorage.getItem("token") || localStorage.getItem("jwt") || ""}`,
                    },
                  },
                );
                if (keywordsResponse.ok) {
                  const keywords = await keywordsResponse.json();
                  keywords.forEach((k) => {
                    const keyword = k.name || k.keyword_name;
                    if (keyword && keyword.length > 2) {
                      // Only highlight keywords with 3+ chars
                      // Escape special regex characters
                      const escapedKeyword = keyword.replace(
                        /[.*+?^${}()|[\]\\]/g,
                        "\\$&",
                      );
                      const regex = new RegExp(
                        `(\\b${escapedKeyword}\\b)`,
                        "gi",
                      );
                      highlightedText = highlightedText.replace(
                        regex,
                        '<mark style="background: #fef08a; padding: 2px 4px; border-radius: 2px; font-weight: 600;">$1</mark>',
                      );
                    }
                  });
                }
              }
            } catch (e) {
              console.warn("Could not load keywords for highlighting:", e);
            }

            // Escape HTML but preserve our <mark> tags
            const textToDisplay = highlightedText
              .replace(/<mark/g, "__MARK_OPEN__")
              .replace(/<\/mark>/g, "__MARK_CLOSE__")
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/__MARK_OPEN__/g, "<mark")
              .replace(/__MARK_CLOSE__/g, "</mark>");

            previewHTML += `
                            <div id="ocrTextContent" style="flex: 1; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; overflow-y: auto; font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 0.875rem; line-height: 1.7; color: #374151; white-space: pre-wrap; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                                ${textToDisplay}
                            </div>
                            <div style="margin-top: 12px; padding: 10px 12px; background: #dcfce7; border-radius: 6px; border: 1px solid #86efac;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.8125rem; color: #166534;">
                                    <i class="fas fa-check-circle"></i>
                                    <span><mark style="background: #fef08a; padding: 1px 4px; border-radius: 2px; font-weight: 600;">Keywords</mark> highlighted ‚Ä¢ Extracted by AWS Textract</span>
                                </div>
                            </div>`;
          }

          previewHTML += "</div>";
        }

        previewHTML += "</div>";
        previewContent.innerHTML = previewHTML;
      } catch (error) {
        console.error("Error loading preview:", error);
        previewContent.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p style="font-size: 1.125rem; font-weight: 600; margin-bottom: 10px;">Error loading preview</p>
                        <p style="color: #6b7280; margin-bottom: 20px;">${error.message}</p>
                        <button onclick="downloadCurrentAttachment()" 
                                style="background: #3b82f6; color: white; border: none; padding: 10px 24px;
                                       border-radius: 6px; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-download"></i> Try Downloading Instead
                        </button>
                    </div>
                `;
      }
    };

    // Function to close attachment preview
    window.closeAttachmentPreview = function () {
      const modal = document.getElementById("attachmentPreviewModal");
      modal.style.display = "none";
      currentAttachment = null;
    };

    // Function to download attachment using a signed URL
    window.downloadAttachment = async function (
      evidenceId,
      attachmentId,
      fileName,
    ) {
      const documentId = looksLikeUuid(attachmentId)
        ? attachmentId
        : evidenceId;
      try {
        const { url } = await getSignedUrlForDocument(documentId);
        const link = document.createElement("a");
        link.href = url;
        link.download = fileName || "download";
        link.target = "_blank";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        console.error("Download failed", e);
        alert("Download failed. Please try again.");
      }
    };

    // Function to download current attachment from preview
    window.downloadCurrentAttachment = function () {
      if (currentAttachment) {
        downloadAttachment(
          currentAttachment.evidenceId,
          currentAttachment.attachmentId,
          currentAttachment.fileName,
        );
      }
    };

    // Close modal on Escape key
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        closeAttachmentPreview();
      }
    });

    // Legacy download function (if needed for other parts of the app)
    function downloadDocumentLegacy(documentId, filename) {
      window.open(
        `${API_BASE}/documents/${documentId}/download?filename=${encodeURIComponent(filename)}`,
        "_blank",
      );
    }

    // ==================== PROGRAMME ANALYSIS FUNCTIONS ====================

    /**
     * Link an email to a programme activity
     * Opens a modal to select from uploaded Asta programme activities
     */
    window.linkActivityToEmail = async function (emailId) {
      try {
        // Fetch available programme activities from uploaded Asta programme files
        const response = await fetch(
          `${API_BASE}/api/cases/${caseId}/programme/activities`,
        );

        if (!response.ok) {
          throw new Error("Failed to load programme activities");
        }

        const activities = await response.json();

        // Create modal with activity selector
        const modal = document.createElement("div");
        modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center;
                    justify-content: center; z-index: 10000;
                `;

        modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 30px; 
                              max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h2 style="margin: 0 0 20px 0; color: #1e293b;">
                            <i class="fas fa-link"></i> Link to Programme Activity
                        </h2>
                        
                        <div style="margin-bottom: 20px;">
                            <input type="text" id="activitySearchInput" 
                                   placeholder="Search activities..." 
                                   style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; 
                                        border-radius: 8px; font-size: 14px;"
                                   oninput="filterActivitiesList(this.value)">
                        </div>
                        
                        <div id="activitiesList" style="max-height: 400px; overflow-y: auto;">
                            ${activities.length === 0
            ? `
                                <div style="text-align: center; padding: 40px; color: #64748b;">
                                    <i class="fas fa-upload" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <p style="font-size: 16px; margin: 0;">No programme uploaded yet</p>
                                    <button onclick="window.location.href='/ui/programme.html?case=${caseId}'"
                                            style="margin-top: 20px; background: #3b82f6; color: white; 
                                                 border: none; padding: 12px 24px; border-radius: 8px; 
                                                 cursor: pointer; font-weight: 500;">
                                        <i class="fas fa-upload"></i> Upload Programme
                                    </button>
                                </div>
                            `
            : activities
              .map(
                (activity) => `
                                <div class="activity-item" data-activity-id="${activity.id}" 
                                     data-activity-name="${activity.name}"
                                     style="padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; 
                                          margin-bottom: 12px; cursor: pointer; transition: all 0.2s;"
                                     onmouseover="this.style.background='#f8fafc'; this.style.borderColor='#3b82f6'"
                                     onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'"
                                     onclick="selectActivity('${emailId}', '${activity.id}', '${activity.name}')">
                                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                        ${activity.name}
                                    </div>
                                    <div style="font-size: 12px; color: #64748b;">
                                        ID: ${activity.id} | Duration: ${activity.duration} days
                                        ${activity.is_critical ? ' | <span style="color: #dc2626; font-weight: 600;">CRITICAL PATH</span>' : ""}
                                    </div>
                                </div>
                            `,
              )
              .join("")
          }
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="this.closest('div[style*=fixed]').remove()"
                                    style="background: #e2e8f0; color: #475569; border: none; 
                                         padding: 10px 20px; border-radius: 8px; cursor: pointer; 
                                         font-weight: 500;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;

        document.body.appendChild(modal);
      } catch (error) {
        console.error("Error loading activities:", error);
        alert(
          "Failed to load programme activities. Make sure you have uploaded a baseline programme.",
        );
      }
    };

    /**
     * Filter activities list based on search input
     */
    window.filterActivitiesList = function (searchTerm) {
      const items = document.querySelectorAll(".activity-item");
      const lowerSearch = searchTerm.toLowerCase();

      items.forEach((item) => {
        const name = item.dataset.activityName.toLowerCase();
        const id = item.dataset.activityId.toLowerCase();

        if (name.includes(lowerSearch) || id.includes(lowerSearch)) {
          item.style.display = "block";
        } else {
          item.style.display = "none";
        }
      });
    };

    /**
     * Select an activity and link it to the email
     */
    window.selectActivity = async function (
      emailId,
      activityId,
      activityName,
    ) {
      try {
        // Save the link in the database
        await fetch(
          `${API_BASE}/api/cases/${caseId}/evidence/${emailId}/link-activity`,
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              activity_id: activityId,
              activity_name: activityName,
            }),
          },
        );

        // Close modal
        document.querySelector('div[style*="position: fixed"]').remove();

        // Refresh the grid to show the linked activity
        refreshData();

        // Show success message
        showNotification(
          `Email linked to activity: ${activityName}`,
          "success",
        );
      } catch (error) {
        console.error("Error linking activity:", error);
        alert("Failed to link activity to email");
      }
    };

    /**
     * View detailed programme analysis for an email
     * Shows baseline vs actual progress at the email's date
     */
    window.viewProgrammeAnalysis = async function (emailId, activityId) {
      try {
        showLoading(true, "Loading programme analysis...");

        // Fetch programme analysis data
        const response = await fetch(
          `${API_BASE}/api/cases/${caseId}/evidence/${emailId}/programme-analysis?activity=${activityId}`,
          {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          },
        );

        if (!response.ok) {
          throw new Error("Failed to load programme analysis");
        }

        const analysis = await response.json();

        // Create modal with detailed programme analysis
        const modal = document.createElement("div");
        modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center;
                    justify-content: center; z-index: 10000; overflow-y: auto; padding: 20px;
                `;

        const emailDate = new Date(analysis.email_date);
        const variance = analysis.variance_days || 0;
        const isDelayed = variance < 0;

        modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; padding: 40px; 
                              max-width: 1000px; width: 100%; max-height: 90vh; overflow-y: auto;">
                        
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 30px;">
                            <div>
                                <h2 style="margin: 0 0 8px 0; color: #1e293b; font-size: 24px;">
                                    <i class="fas fa-chart-gantt"></i> Programme Analysis
                                </h2>
                                <p style="margin: 0; color: #64748b;">
                                    Activity: <strong>${analysis.activity_name}</strong> | 
                                    Email Date: <strong>${emailDate.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}</strong>
                                </p>
                            </div>
                            <button onclick="this.closest('div[style*=fixed]').remove()"
                                    style="background: #e2e8f0; border: none; width: 36px; height: 36px; 
                                         border-radius: 8px; cursor: pointer; font-size: 18px; color: #475569;">
                                √ó
                            </button>
                        </div>
                        
                        <!-- Variance Alert -->
                        ${variance !== 0
            ? `
                            <div style="background: ${isDelayed ? "#fee2e2" : "#d1fae5"}; 
                                      border-left: 4px solid ${isDelayed ? "#dc2626" : "#059669"}; 
                                      padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas ${isDelayed ? "fa-exclamation-triangle" : "fa-check-circle"}" 
                                       style="font-size: 32px; color: ${isDelayed ? "#dc2626" : "#059669"};"></i>
                                    <div>
                                        <h3 style="margin: 0 0 4px 0; color: ${isDelayed ? "#991b1b" : "#065f46"};">
                                            ${isDelayed ? "Programme Delay Detected" : "Programme Ahead of Schedule"}
                                        </h3>
                                        <p style="margin: 0; font-size: 18px; font-weight: 600; 
                                                color: ${isDelayed ? "#dc2626" : "#059669"};">
                                            ${isDelayed ? "" : "+"}${variance} days ${isDelayed ? "behind" : "ahead of"} baseline
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `
            : ""
          }
                        
                        <!-- Progress Comparison -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 30px;">
                            <div style="background: #f8fafc; padding: 24px; border-radius: 12px;">
                                <h4 style="margin: 0 0 16px 0; color: #475569; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Baseline Programme
                                </h4>
                                <div style="font-size: 48px; font-weight: 700; color: #3b82f6; margin-bottom: 12px;">
                                    ${Math.round(analysis.baseline_progress || 0)}%
                                </div>
                                <div style="background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div style="width: ${analysis.baseline_progress || 0}%; height: 100%; 
                                              background: linear-gradient(90deg, #3b82f6, #2563eb);"></div>
                                </div>
                                <p style="margin: 12px 0 0 0; color: #64748b; font-size: 14px;">
                                    Planned progress at ${emailDate.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}
                                </p>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 24px; border-radius: 12px;">
                                <h4 style="margin: 0 0 16px 0; color: #475569; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">
                                    As-Built Programme
                                </h4>
                                <div style="font-size: 48px; font-weight: 700; 
                                          color: ${isDelayed ? "#dc2626" : "#059669"}; margin-bottom: 12px;">
                                    ${Math.round(analysis.actual_progress || 0)}%
                                </div>
                                <div style="background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden;">
                                    <div style="width: ${analysis.actual_progress || 0}%; height: 100%; 
                                              background: linear-gradient(90deg, ${isDelayed ? "#dc2626, #991b1b" : "#059669, #047857"});"></div>
                                </div>
                                <p style="margin: 12px 0 0 0; color: #64748b; font-size: 14px;">
                                    Actual progress at ${emailDate.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Timeline Visualization -->
                        <div style="background: #f8fafc; padding: 24px; border-radius: 12px; margin-bottom: 30px;">
                            <h4 style="margin: 0 0 20px 0; color: #1e293b;">Timeline Comparison</h4>
                            
                            <!-- Baseline Timeline -->
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #64748b;">Baseline</span>
                                    <span style="font-size: 12px; color: #64748b;">
                                        ${new Date(analysis.baseline_start).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })} -
                                        ${new Date(analysis.baseline_end).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}
                                    </span>
                                </div>
                                <div style="background: #dbeafe; height: 24px; border-radius: 6px; position: relative;">
                                    <div style="position: absolute; left: ${((emailDate - new Date(analysis.baseline_start)) / (new Date(analysis.baseline_end) - new Date(analysis.baseline_start))) * 100}%;
                                              width: 3px; height: 100%; background: #1e40af; z-index: 1;"></div>
                                </div>
                            </div>
                            
                            <!-- Actual Timeline -->
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #64748b;">As-Built</span>
                                    <span style="font-size: 12px; color: #64748b;">
                                        ${new Date(analysis.actual_start).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })} -
                                        ${new Date(analysis.actual_end).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}
                                    </span>
                                </div>
                                <div style="background: ${isDelayed ? "#fee2e2" : "#d1fae5"}; height: 24px; border-radius: 6px; position: relative;">
                                    <div style="position: absolute; left: ${((emailDate - new Date(analysis.actual_start)) / (new Date(analysis.actual_end) - new Date(analysis.actual_start))) * 100}%;
                                              width: 3px; height: 100%; background: ${isDelayed ? "#dc2626" : "#059669"}; z-index: 1;"></div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 12px; padding: 12px; 
                                      background: white; border-radius: 6px;">
                                <i class="fas fa-map-marker-alt" style="color: #3b82f6;"></i>
                                <span style="margin-left: 8px; font-size: 14px; color: #64748b;">
                                    Email sent at this point in time
                                </span>
                            </div>
                        </div>
                        
                        <!-- Critical Path Status -->
                        ${analysis.is_critical_path
            ? `
                            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; 
                                      padding: 16px; border-radius: 8px; margin-bottom: 30px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-fire" style="font-size: 24px; color: #f59e0b;"></i>
                                    <div>
                                        <strong style="color: #92400e;">Critical Path Activity</strong>
                                        <p style="margin: 4px 0 0 0; color: #78350f; font-size: 14px;">
                                            This activity is on the critical path. Any delays will impact the project completion date.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `
            : ""
          }
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="exportProgrammeAnalysis('${emailId}', '${activityId}')"
                                    style="background: white; border: 1px solid #e2e8f0; color: #475569; 
                                         padding: 12px 24px; border-radius: 8px; cursor: pointer; 
                                         font-weight: 500; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-download"></i> Export Report
                            </button>
                            <button onclick="this.closest('div[style*=fixed]').remove()"
                                    style="background: #3b82f6; color: white; border: none; 
                                         padding: 12px 24px; border-radius: 8px; cursor: pointer; 
                                         font-weight: 500;">
                                Close
                            </button>
                        </div>
                    </div>
                `;

        document.body.appendChild(modal);
      } catch (error) {
        console.error("Error loading programme analysis:", error);
        alert(
          "Failed to load programme analysis. Make sure you have uploaded both baseline and as-built programmes.",
        );
      } finally {
        showLoading(false);
      }
    };

    /**
     * Export programme analysis as PDF report
     */
    window.exportProgrammeAnalysis = async function (emailId, activityId) {
      try {
        showLoading(true, "Generating report...");

        const response = await fetch(
          `${API_BASE}/api/cases/${caseId}/evidence/${emailId}/programme-report?activity=${activityId}&format=pdf`,
          {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          },
        );

        if (!response.ok) {
          throw new Error("Failed to generate report");
        }

        // Download the PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `programme-analysis-${activityId}-${new Date().toISOString().split("T")[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showNotification("Report downloaded successfully", "success");
      } catch (error) {
        console.error("Error exporting report:", error);
        alert("Failed to export report");
      } finally {
        showLoading(false);
      }
    };

    /**
     * Open linked matter/claim detail
     */
    function openLinkedItem(emailId) {
      // Navigate to contentious matters page with the item selected
      const params = new URLSearchParams(window.location.search);
      window.open(`contentious-matters.html?${params.toString()}`, "_blank");
    }

    /**
     * Edit claim notes for an email
     */
    function editClaimNotes(emailId) {
      const row = gridApi.getRowNode(emailId);
      if (row) {
        gridApi.startEditingCell({
          rowIndex: row.rowIndex,
          colKey: "claim_notes",
        });
      }
    }

    /**
     * Show link to matter/claim modal
     */
    async function showLinkToClaimModal(emailId) {
      try {
        // Fetch available matters and claims
        const entityId = resolveEntityId();
        const params = new URLSearchParams();
        if (entityId) params.set("project_id", entityId);

        const [mattersRes, claimsRes] = await Promise.all([
          fetch(`${API_BASE}/api/claims/matters?${params.toString()}`),
          fetch(`${API_BASE}/api/claims/heads-of-claim?${params.toString()}`),
        ]);

        const matters = (await mattersRes.json()).items || [];
        const claims = (await claimsRes.json()).items || [];

        const modal = document.createElement("div");
        modal.id = "linkClaimModal";
        modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.5); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                `;

        modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; width: 500px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                        <div style="padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--vericase-navy);">
                                <i class="fas fa-link" style="color: var(--vericase-teal); margin-right: 0.5rem;"></i>
                                Link to Matter/Claim
                            </h3>
                            <button onclick="document.getElementById('linkClaimModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
                        </div>
                        <div style="padding: 1.5rem; max-height: 400px; overflow-y: auto;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.5rem;">Link Type</label>
                                <select id="linkType" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                                    <option value="supporting">Supporting Evidence</option>
                                    <option value="contradicting">Contradicting Evidence</option>
                                    <option value="neutral">Neutral</option>
                                    <option value="key">Key Evidence</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.5rem;">
                                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Contentious Matters
                                </label>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.5rem;">
                                    ${matters.length === 0
            ? '<p style="color: #6b7280; font-size: 0.875rem;">No matters available</p>'
            : matters
              .map(
                (m) => `
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; border-radius: 4px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                            <input type="radio" name="linkTarget" value="matter:${m.id}">
                                            <span>${m.name}</span>
                                        </label>
                                      `,
              )
              .join("")
          }
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.5rem;">
                                    <i class="fas fa-gavel" style="color: #ef4444;"></i> Heads of Claim
                                </label>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.5rem;">
                                    ${claims.length === 0
            ? '<p style="color: #6b7280; font-size: 0.875rem;">No claims available</p>'
            : claims
              .map(
                (c) => `
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; border-radius: 4px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                            <input type="radio" name="linkTarget" value="claim:${c.id}">
                                            <span>${c.reference_number ? c.reference_number + " - " : ""}${c.name}</span>
                                        </label>
                                      `,
              )
              .join("")
          }
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.5rem;">Notes</label>
                                <textarea id="linkNotes" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; min-height: 60px;" placeholder="Optional notes about this link..."></textarea>
                            </div>
                        </div>
                        <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                            <button onclick="document.getElementById('linkClaimModal').remove()" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer;">Cancel</button>
                            <button onclick="submitLinkToClaim('${emailId}')" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; background: var(--vericase-teal); color: white; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-link"></i> Create Link
                            </button>
                        </div>
                    </div>
                `;

        document.body.appendChild(modal);
      } catch (error) {
        console.error("Error loading matters/claims:", error);
        showNotification("Failed to load matters and claims", "error");
      }
    }

    /**
     * Submit link to matter/claim
     */
    async function submitLinkToClaim(emailId) {
      const selected = document.querySelector(
        'input[name="linkTarget"]:checked',
      );
      if (!selected) {
        showNotification("Please select a matter or claim", "error");
        return;
      }

      const [type, targetId] = selected.value.split(":");
      const linkType = document.getElementById("linkType").value;
      const notes = document.getElementById("linkNotes").value.trim();

      try {
        const response = await fetch(`${API_BASE}/api/claims/links`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            item_type: "correspondence",
            item_id: emailId,
            contentious_matter_id: type === "matter" ? targetId : null,
            head_of_claim_id: type === "claim" ? targetId : null,
            link_type: linkType,
            notes: notes || null,
          }),
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || "Failed to create link");
        }

        document.getElementById("linkClaimModal").remove();
        showNotification("Email linked successfully", "success");

        // Refresh grid to show updated links
        refreshData();
      } catch (error) {
        console.error("Error creating link:", error);
        showNotification(error.message, "error");
      }
    }

    /**
     * Show notification message
     */
    function showNotification(message, type = "info") {
      const notification = document.createElement("div");
      const colors = {
        success: { bg: "#d1fae5", border: "#059669", text: "#065f46" },
        error: { bg: "#fee2e2", border: "#dc2626", text: "#991b1b" },
        info: { bg: "#dbeafe", border: "#3b82f6", text: "#1e40af" },
      };
      const color = colors[type] || colors.info;

      notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10001;
                background: ${color.bg}; border-left: 4px solid ${color.border};
                color: ${color.text}; padding: 16px 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500;
                animation: slideIn 0.3s ease-out;
            `;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = "slideOut 0.3s ease-in";
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ==================== END PROGRAMME ANALYSIS FUNCTIONS ====================

    // ==================== AI CHAT FUNCTIONS ====================

    // Note: projectId and caseId are already declared at the top of the script

    /**
     * Toggle AI Chat Interface
     */
    window.toggleAIChat = function () {
      const container = document.getElementById("aiChatContainer");
      if (container.style.display === "none") {
        container.style.display = "block";
        loadAIModelsStatus();
      } else {
        container.style.display = "none";
      }
    };

    /**
     * Load AI models status
     */
    async function loadAIModelsStatus() {
      try {
        const response = await fetch(
          `${API_BASE}/api/ai-chat/models/status`,
          {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          },
        );

        if (response.ok) {
          const data = await response.json();
          const statusDiv = document.getElementById("aiModelsStatus");

          const available = Object.values(data.models).filter(
            (m) => m.available,
          ).length;
          const total = Object.keys(data.models).length;

          statusDiv.innerHTML = `<i class="fas fa-circle" style="color: ${available > 0 ? "#10B981" : "#EF4444"};"></i> ${available}/${total} AI models ready`;
        }
      } catch (error) {
        console.error("Error loading AI models status:", error);
      }
    }

    /**
     * Quick AI Search (3-5 seconds)
     */
    window.aiQuickSearch = async function () {
      const query = document.getElementById("aiQuery").value.trim();
      if (!query) {
        showNotification("Please enter a question", "error");
        return;
      }

      const quickBtn = document.getElementById("quickSearchBtn");
      const deepBtn = document.getElementById("deepResearchBtn");
      const progressDiv = document.getElementById("researchProgress");
      const responseDiv = document.getElementById("aiResponse");

      // Ensure we have a project ID
      const effectiveProjectId = projectId || resolveEntityId();
      if (!effectiveProjectId) {
        showNotification(
          "No project selected. Please select a project first.",
          "error",
        );
        return;
      }

      console.log("[AI] Quick search for project:", effectiveProjectId);

      // Show progress
      quickBtn.disabled = true;
      deepBtn.disabled = true;
      quickBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Searching...';
      progressDiv.style.display = "block";
      responseDiv.style.display = "none";
      document.getElementById("progressTitle").textContent =
        "Quick Search...";
      document.getElementById("progressStatus").textContent =
        "Analyzing evidence with AI...";

      try {
        console.log(
          "[AI] Sending request to:",
          `${API_BASE}/api/ai-chat/query`,
        );

        const response = await fetch(`${API_BASE}/api/ai-chat/query`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
            Accept: "application/json",
          },
          body: JSON.stringify({
            query: query,
            mode: "quick",
            project_id: effectiveProjectId,
            case_id: caseId || null,
          }),
        });

        console.log("[AI] Response status:", response.status);

        if (!response.ok) {
          const errorText = await response.text();
          let errorMsg = "Search failed";
          try {
            const error = JSON.parse(errorText);
            errorMsg = error.detail || error.message || errorText;
          } catch {
            errorMsg = errorText;
          }
          throw new Error(errorMsg);
        }

        const data = await response.json();
        console.log("[AI] Response data:", data);
        displayAIResponse(data);
      } catch (error) {
        console.error("[AI] Quick search error:", error);

        // Show error in the response area
        responseDiv.style.display = "block";
        responseDiv.innerHTML = `
                    <div style="color: #dc2626;">
                        <h3 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-circle"></i> Quick Search Failed
                        </h3>
                        <p style="margin-bottom: 1rem;">${error.message}</p>
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            <p><strong>Possible causes:</strong></p>
                            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                <li>AI models may not be configured (check API keys)</li>
                                <li>No emails found for this project</li>
                                <li>Network or server error</li>
                            </ul>
                        </div>
                    </div>
                `;
      } finally {
        quickBtn.disabled = false;
        deepBtn.disabled = false;
        quickBtn.innerHTML = '<i class="fas fa-bolt"></i> Quick Search (3s)';
        progressDiv.style.display = "none";
      }
    };

    /**
     * Deep AI Research (30-60 seconds)
     */
    window.aiDeepResearch = async function () {
      const query = document.getElementById("aiQuery").value.trim();
      if (!query) {
        showNotification("Please enter a question", "error");
        return;
      }

      const quickBtn = document.getElementById("quickSearchBtn");
      const deepBtn = document.getElementById("deepResearchBtn");
      const progressDiv = document.getElementById("researchProgress");
      const responseDiv = document.getElementById("aiResponse");
      const planDiv = document.getElementById("researchPlan");
      const modelProgressDiv = document.getElementById("modelProgress");

      // Ensure we have a project ID
      const effectiveProjectId = projectId || resolveEntityId();
      if (!effectiveProjectId) {
        showNotification(
          "No project selected. Please select a project first.",
          "error",
        );
        return;
      }

      console.log("[AI] Deep research for project:", effectiveProjectId);

      // Show progress
      quickBtn.disabled = true;
      deepBtn.disabled = true;
      deepBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Researching...';
      progressDiv.style.display = "block";
      responseDiv.style.display = "none";
      document.getElementById("progressTitle").textContent =
        "Deep Research Mode";
      document.getElementById("progressStatus").textContent =
        "Creating research plan with multiple AI models...";
      planDiv.style.display = "none";
      modelProgressDiv.style.display = "none";

      try {
        console.log("[AI] Sending deep research request");

        const response = await fetch(`${API_BASE}/api/ai-chat/query`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token") || ""}`,
            Accept: "application/json",
          },
          body: JSON.stringify({
            query: query,
            mode: "deep",
            project_id: effectiveProjectId,
            case_id: caseId || null,
          }),
        });

        console.log("[AI] Deep research response status:", response.status);

        if (!response.ok) {
          const errorText = await response.text();
          let errorMsg = "Research failed";
          try {
            const error = JSON.parse(errorText);
            errorMsg = error.detail || error.message || errorText;
          } catch {
            errorMsg = errorText;
          }
          throw new Error(errorMsg);
        }

        const data = await response.json();
        console.log("[AI] Deep research data:", data);

        // Show plan
        if (data.plan) {
          planDiv.style.display = "block";
          planDiv.innerHTML = `
                        <div style="font-weight: 600; color: var(--vericase-navy); margin-bottom: 0.5rem;">
                            <i class="fas fa-list-check"></i> Research Plan
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                            ${data.plan.analysis_steps.map((step) => `‚Ä¢ ${step}`).join("<br>")}
                        </div>
                    `;
        }

        // Show model progress
        document.getElementById("progressStatus").textContent =
          "Analyzing with multiple AI models...";
        modelProgressDiv.style.display = "block";
        modelProgressDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                        ${data.model_responses
            .map(
              (m) => `
                            <div style="padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #E5E7EB;">
                                <div style="font-size: 0.75rem; font-weight: 600; color: var(--vericase-navy); margin-bottom: 0.25rem;">
                                    ${m.model}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">
                                    ${m.processing_time.toFixed(1)}s | ${(m.confidence * 100).toFixed(0)}% confidence
                                </div>
                            </div>
                        `,
            )
            .join("")}
                    </div>
                `;

        // Display response
        displayAIResponse(data);
      } catch (error) {
        console.error("[AI] Deep research error:", error);

        // Show error in the response area
        responseDiv.style.display = "block";
        responseDiv.innerHTML = `
                    <div style="color: #dc2626;">
                        <h3 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-circle"></i> Deep Research Failed
                        </h3>
                        <p style="margin-bottom: 1rem;">${error.message}</p>
                        <div style="font-size: 0.875rem; color: #6b7280;">
                            <p><strong>Possible causes:</strong></p>
                            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                <li>AI models may not be configured (check API keys in settings)</li>
                                <li>No emails found for this project</li>
                                <li>Network timeout (deep research can take 30-60 seconds)</li>
                                <li>Server error - check logs</li>
                            </ul>
                        </div>
                    </div>
                `;
      } finally {
        quickBtn.disabled = false;
        deepBtn.disabled = false;
        deepBtn.innerHTML =
          '<i class="fas fa-microscope"></i> Deep Research (60s)';
        progressDiv.style.display = "none";
      }
    };

    /**
     * Display AI response
     */
    function displayAIResponse(data) {
      const responseDiv = document.getElementById("aiResponse");
      responseDiv.style.display = "block";

      let html = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--vericase-teal), var(--vericase-teal-dark)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-sparkles" style="color: white; font-size: 16px;"></i>
                        </div>
                        <div>
                            <div style="font-weight: 700; color: var(--vericase-navy); font-size: 1.125rem;">AI Analysis</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                ${data.mode === "quick" ? "Quick Search" : "Deep Research"} ‚Ä¢ ${data.processing_time.toFixed(1)}s
                            </div>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.9375rem; line-height: 1.7; color: var(--text-primary); white-space: pre-wrap;">
                        ${formatMarkdown(data.answer)}
                    </div>
                </div>
            `;

      // Add key findings
      if (data.key_findings && data.key_findings.length > 0) {
        html += `
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #F0FDF4; border-radius: 8px; border-left: 4px solid #10B981;">
                        <div style="font-weight: 600; color: #065F46; margin-bottom: 0.5rem;">
                            <i class="fas fa-lightbulb"></i> Key Findings
                        </div>
                        <ul style="margin-left: 1.25rem; color: #047857;">
                            ${data.key_findings.map((f) => `<li style="margin-bottom: 0.25rem;">${f}</li>`).join("")}
                        </ul>
                    </div>
                `;
      }

      // Add sources
      if (data.sources && data.sources.length > 0) {
        html += `
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #F9FAFB; border-radius: 8px;">
                        <div style="font-weight: 600; color: var(--vericase-navy); margin-bottom: 0.75rem; font-size: 0.875rem;">
                            <i class="fas fa-file-lines"></i> Evidence Sources (${data.sources.length})
                        </div>
                        <div style="display: grid; gap: 0.5rem; font-size: 0.8125rem;">
                            ${data.sources
            .slice(0, 5)
            .map(
              (s) => `
                                <div style="padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #E5E7EB;">
                                    <div style="font-weight: 600; color: var(--vericase-navy);">${s.subject}</div>
                                    <div style="color: var(--text-muted); font-size: 0.75rem;">
                                        ${s.sender} ‚Ä¢ ${new Date(s.date).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}
                                    </div>
                                </div>
                            `,
            )
            .join("")}
                        </div>
                    </div>
                `;
      }

      responseDiv.innerHTML = html;
      responseDiv.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    /**
     * Format markdown-style text
     */
    function formatMarkdown(text) {
      if (!text) return "";

      // Convert markdown to HTML
      return text
        .replace(
          /### (.*?)$/gm,
          '<h4 style="font-size: 1.125rem; font-weight: 700; color: var(--vericase-navy); margin: 1.5rem 0 0.75rem 0;">$1</h4>',
        )
        .replace(
          /## (.*?)$/gm,
          '<h3 style="font-size: 1.25rem; font-weight: 700; color: var(--vericase-navy); margin: 1.5rem 0 0.75rem 0;">$1</h3>',
        )
        .replace(
          /# (.*?)$/gm,
          '<h2 style="font-size: 1.5rem; font-weight: 700; color: var(--vericase-navy); margin: 1.5rem 0 1rem 0;">$1</h2>',
        )
        .replace(
          /\*\*(.*?)\*\*/g,
          '<strong style="font-weight: 700; color: var(--vericase-navy);">$1</strong>',
        )
        .replace(/\*(.*?)\*/g, "<em>$1</em>")
        .replace(
          /^- (.*?)$/gm,
          '<div style="margin-left: 1.25rem; margin-bottom: 0.25rem;">‚Ä¢ $1</div>',
        )
        .replace(
          /^(\d+)\. (.*?)$/gm,
          '<div style="margin-left: 1.25rem; margin-bottom: 0.25rem;">$1. $2</div>',
        );
    }

    // Initialize AI chat on page load
    document.addEventListener("DOMContentLoaded", () => {
      // Check if AI keys are configured
      loadAIModelsStatus();
    });

    // ==================== END AI CHAT FUNCTIONS ====================

    // ==================== CONTEXT PANEL FUNCTIONS ====================

    let contextPanelCollapsed = false;
    let cachedMatters = [];
    let cachedClaims = [];
    let cachedKeywords = [];
    let cachedStakeholders = [];

    /**
     * Toggle context panel collapsed state
     */
    function toggleContextPanel() {
      const panel = document.getElementById("contextPanel");
      const icon = document.getElementById("contextToggleIcon");
      contextPanelCollapsed = !contextPanelCollapsed;

      if (contextPanelCollapsed) {
        panel.classList.add("collapsed");
        icon.classList.remove("fa-chevron-right");
        icon.classList.add("fa-chevron-left");
      } else {
        panel.classList.remove("collapsed");
        icon.classList.remove("fa-chevron-left");
        icon.classList.add("fa-chevron-right");
      }
    }

    /**
     * Toggle context section expand/collapse
     */
    function toggleContextSection(sectionId) {
      const header = document.querySelector(
        `#${sectionId}Section .context-section-header`,
      );
      const body = document.getElementById(`${sectionId}Body`);

      if (body.classList.contains("collapsed")) {
        body.classList.remove("collapsed");
        header.classList.remove("collapsed");
      } else {
        body.classList.add("collapsed");
        header.classList.add("collapsed");
      }
    }

    /**
     * Update context panel when selection changes
     */
    function updateContextPanelSelection() {
      const selectedRows = gridApi.getSelectedRows();
      const count = selectedRows.length;

      // Update count badge
      document.getElementById("contextSelectedCount").textContent = count;

      // Update selected emails preview
      const previewDiv = document.getElementById("selectedEmailsPreview");

      if (count === 0) {
        previewDiv.innerHTML = `
                    <div class="context-empty-state">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>Select emails to see preview and take actions</p>
                    </div>
                `;
      } else if (count === 1) {
        const email = selectedRows[0];
        previewDiv.innerHTML = `
                    <div class="selected-preview">
                        <div class="selected-preview-subject">${email.subject || "No subject"}</div>
                        <div class="selected-preview-meta">
                            <span><strong>From:</strong> ${email.sender_email || email.email_from || "Unknown"}</span>
                            <span><strong>Date:</strong> ${email.date_sent ? new Date(email.date_sent).toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' }) : "Unknown"}</span>
                            ${email.has_attachments ? '<span><i class="fas fa-paperclip"></i> Has attachments</span>' : ""}
                        </div>
                    </div>
                `;
      } else {
        // Multiple selected
        const dateRange = getDateRangeFromEmails(selectedRows);
        previewDiv.innerHTML = `
                    <div class="selected-preview">
                        <div class="selected-preview-subject">${count} emails selected</div>
                        <div class="selected-preview-meta">
                            <span><strong>Date range:</strong> ${dateRange}</span>
                            <span><strong>With attachments:</strong> ${selectedRows.filter((e) => e.has_attachments).length}</span>
                        </div>
                    </div>
                `;
      }

      // Update link button state
      const linkBtn = document.getElementById("linkSelectedBtn");
      const targetSelect = document.getElementById("linkTargetSelect");
      linkBtn.disabled = count === 0 || !targetSelect.value;

      // Update AI suggestions if emails selected
      if (count > 0) {
        updateAISuggestions(selectedRows);
      } else {
        document.getElementById("aiSuggestionsList").innerHTML = `
                    <div class="context-empty-state">
                        <i class="fas fa-robot"></i>
                        <p>Select emails to get AI suggestions for category and linking</p>
                    </div>
                `;
      }
    }

    /**
     * Get date range string from emails
     */
    function getDateRangeFromEmails(emails) {
      const dates = emails
        .filter((e) => e.date_sent)
        .map((e) => new Date(e.date_sent))
        .sort((a, b) => a - b);

      if (dates.length === 0) return "Unknown";
      if (dates.length === 1) return dates[0].toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });

      return `${dates[0].toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })} - ${dates[dates.length - 1].toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' })}`;
    }

    /**
     * Load matters and claims for quick linking
     */
    async function loadMattersAndClaims() {
      try {
        const params = new URLSearchParams();
        if (projectId) params.set("project_id", projectId);

        const [mattersRes, claimsRes] = await Promise.all([
          fetch(`${API_BASE}/api/claims/matters?${params.toString()}`),
          fetch(`${API_BASE}/api/claims/heads-of-claim?${params.toString()}`),
        ]);

        if (mattersRes.ok) {
          const data = await mattersRes.json();
          cachedMatters = data.items || [];
        }

        if (claimsRes.ok) {
          const data = await claimsRes.json();
          cachedClaims = data.items || [];
        }
      } catch (error) {
        console.error("Error loading matters/claims:", error);
      }
    }

    /**
     * Handle link type dropdown change
     */
    function onLinkTypeChange() {
      const typeSelect = document.getElementById("linkTypeSelect");
      const targetSelect = document.getElementById("linkTargetSelect");
      const type = typeSelect.value;

      if (!type) {
        targetSelect.style.display = "none";
        return;
      }

      targetSelect.style.display = "block";
      targetSelect.innerHTML = '<option value="">Select target...</option>';

      const items = type === "matter" ? cachedMatters : cachedClaims;
      items.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.name;
        targetSelect.appendChild(option);
      });

      // Update link button state
      document.getElementById("linkSelectedBtn").disabled = true;

      // Add change listener for target select
      targetSelect.onchange = () => {
        const selectedRows = gridApi.getSelectedRows();
        document.getElementById("linkSelectedBtn").disabled =
          !targetSelect.value || selectedRows.length === 0;
      };
    }

    /**
     * Link selected emails to matter/claim
     */
    async function linkSelectedEmails() {
      const selectedRows = gridApi.getSelectedRows();
      if (selectedRows.length === 0) {
        showNotification("Please select emails to link", "error");
        return;
      }

      const typeSelect = document.getElementById("linkTypeSelect");
      const targetSelect = document.getElementById("linkTargetSelect");
      const type = typeSelect.value;
      const targetId = targetSelect.value;

      if (!type || !targetId) {
        showNotification("Please select a matter or claim", "error");
        return;
      }

      const linkBtn = document.getElementById("linkSelectedBtn");
      linkBtn.disabled = true;
      linkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Linking...';

      try {
        // Create links for all selected emails
        const promises = selectedRows.map((email) =>
          fetch(`${API_BASE}/api/claims/links`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              item_type: "correspondence",
              item_id: email.id,
              contentious_matter_id: type === "matter" ? targetId : null,
              head_of_claim_id: type === "claim" ? targetId : null,
              link_type: "supporting",
            }),
          }),
        );

        await Promise.all(promises);
        showNotification(
          `Linked ${selectedRows.length} email(s) successfully`,
          "success",
        );

        // Reset dropdowns
        typeSelect.value = "";
        targetSelect.style.display = "none";

        // Refresh grid
        refreshData();
      } catch (error) {
        console.error("Error linking emails:", error);
        showNotification("Failed to link some emails", "error");
      } finally {
        linkBtn.disabled = false;
        linkBtn.innerHTML =
          '<i class="fas fa-link"></i> Link Selected Emails';
      }
    }

    /**
     * Open create matter modal
     */
    function openCreateMatterModal() {
      const modal = document.createElement("div");
      modal.id = "createMatterModal";
      modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;

      modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 450px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--vericase-navy);">
                            <i class="fas fa-plus" style="color: var(--vericase-teal); margin-right: 0.5rem;"></i>
                            Create New Matter
                        </h3>
                        <button onclick="document.getElementById('createMatterModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.5rem;">Matter Name *</label>
                            <input type="text" id="newMatterName" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="e.g., Delay to Foundation Works">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.5rem;">Description</label>
                            <textarea id="newMatterDesc" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; min-height: 80px;" placeholder="Brief description of the contentious matter..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.8125rem; font-weight: 500; margin-bottom: 0.5rem;">Priority</label>
                            <select id="newMatterPriority" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                        <button onclick="document.getElementById('createMatterModal').remove()" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer;">Cancel</button>
                        <button onclick="createMatterFromContext()" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; background: var(--vericase-teal); color: white; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-plus"></i> Create Matter
                        </button>
                    </div>
                </div>
            `;

      document.body.appendChild(modal);
    }

    /**
     * Create matter from context panel
     */
    async function createMatterFromContext() {
      const name = document.getElementById("newMatterName").value.trim();
      const description = document
        .getElementById("newMatterDesc")
        .value.trim();
      const priority = document.getElementById("newMatterPriority").value;

      if (!name) {
        showNotification("Please enter a matter name", "error");
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/claims/matters`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name,
            description: description || null,
            priority: priority,
            project_id: projectId,
          }),
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || "Failed to create matter");
        }

        const newMatter = await response.json();

        // Add to cached matters
        cachedMatters.push(newMatter);

        // Close modal
        document.getElementById("createMatterModal").remove();

        // Refresh dropdown if matter type is selected
        const typeSelect = document.getElementById("linkTypeSelect");
        if (typeSelect.value === "matter") {
          onLinkTypeChange();
          document.getElementById("linkTargetSelect").value = newMatter.id;
        }

        showNotification("Matter created successfully", "success");
      } catch (error) {
        console.error("Error creating matter:", error);
        showNotification(error.message, "error");
      }
    }

    /**
     * Load project keywords
     */
    async function loadProjectKeywords() {
      try {
        const response = await fetch(
          `${API_BASE}/api/correspondence/keywords?project_id=${projectId}`,
        );
        if (response.ok) {
          cachedKeywords = await response.json();
          renderKeywordList();
        }
      } catch (error) {
        console.error("Error loading keywords:", error);
      }
    }

    /**
     * Render keyword list in context panel
     */
    function renderKeywordList() {
      const container = document.getElementById("contextKeywordList");

      if (cachedKeywords.length === 0) {
        container.innerHTML =
          '<span style="color: var(--text-muted); font-size: 0.875rem;">No keywords defined</span>';
        return;
      }

      container.innerHTML = cachedKeywords
        .map(
          (kw) => `
                <span class="keyword-tag">
                    ${kw.keyword || kw.name || kw}
                    <span class="remove-keyword" onclick="removeKeyword('${kw.id || kw}')" title="Remove keyword">√ó</span>
                </span>
            `,
        )
        .join("");
    }

    /**
     * Add keyword from context panel
     */
    async function addKeywordFromContext() {
      const input = document.getElementById("newKeywordInput");
      const keyword = input.value.trim();

      if (!keyword) return;

      try {
        const response = await fetch(
          `${API_BASE}/api/correspondence/keywords`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              keyword: keyword,
              project_id: projectId,
            }),
          },
        );

        if (response.ok) {
          const newKeyword = await response.json();
          cachedKeywords.push(newKeyword);
          renderKeywordList();
          input.value = "";
          showNotification("Keyword added", "success");

          // Trigger re-matching in background
          triggerKeywordRematch();
        }
      } catch (error) {
        console.error("Error adding keyword:", error);
        showNotification("Failed to add keyword", "error");
      }
    }

    /**
     * Remove keyword
     */
    async function removeKeyword(keywordId) {
      try {
        const response = await fetch(
          `${API_BASE}/api/correspondence/keywords/${keywordId}`,
          {
            method: "DELETE",
          },
        );

        if (response.ok) {
          cachedKeywords = cachedKeywords.filter(
            (k) => (k.id || k) !== keywordId,
          );
          renderKeywordList();
          showNotification("Keyword removed", "success");
        }
      } catch (error) {
        console.error("Error removing keyword:", error);
      }
    }

    /**
     * Trigger keyword re-matching
     */
    async function triggerKeywordRematch() {
      try {
        await fetch(
          `${API_BASE}/api/correspondence/rematch-keywords?project_id=${projectId}`,
          {
            method: "POST",
          },
        );
        // Silently refresh after a delay
        setTimeout(() => refreshData(), 2000);
      } catch (error) {
        console.error("Error triggering rematch:", error);
      }
    }

    /**
     * Suggest keywords from selected emails
     */
    function suggestKeywordsFromSelection() {
      const selectedRows = gridApi.getSelectedRows();
      if (selectedRows.length === 0) {
        showNotification("Please select emails first", "error");
        return;
      }

      // Extract common words from subjects and bodies
      const text = selectedRows
        .map(
          (e) =>
            `${e.subject || ""} ${e.body_text_clean || e.body_text || ""}`,
        )
        .join(" ")
        .toLowerCase();

      // Simple keyword extraction (could be enhanced with NLP)
      const words = text.split(/\W+/).filter((w) => w.length > 4);
      const wordCounts = {};
      words.forEach((w) => {
        if (
          ![
            "about",
            "after",
            "before",
            "between",
            "could",
            "would",
            "should",
            "their",
            "there",
            "these",
            "those",
            "which",
            "where",
            "while",
          ].includes(w)
        ) {
          wordCounts[w] = (wordCounts[w] || 0) + 1;
        }
      });

      // Get top suggestions
      const suggestions = Object.entries(wordCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([word]) => word);

      if (suggestions.length === 0) {
        showNotification("No keyword suggestions found", "info");
        return;
      }

      // Show suggestions modal
      const modal = document.createElement("div");
      modal.id = "keywordSuggestionsModal";
      modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;

      modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--vericase-navy);">
                            <i class="fas fa-wand-magic-sparkles" style="color: var(--vericase-teal); margin-right: 0.5rem;"></i>
                            Suggested Keywords
                        </h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">
                            Based on ${selectedRows.length} selected email(s), we suggest these keywords:
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${suggestions
          .map(
            (s) => `
                                <label style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f3f4f6; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" value="${s}" checked>
                                    <span>${s}</span>
                                </label>
                            `,
          )
          .join("")}
                        </div>
                    </div>
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                        <button onclick="document.getElementById('keywordSuggestionsModal').remove()" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer;">Cancel</button>
                        <button onclick="addSuggestedKeywords()" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; background: var(--vericase-teal); color: white; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-plus"></i> Add Selected
                        </button>
                    </div>
                </div>
            `;

      document.body.appendChild(modal);
    }

    /**
     * Add suggested keywords
     */
    async function addSuggestedKeywords() {
      const modal = document.getElementById("keywordSuggestionsModal");
      const checkboxes = modal.querySelectorAll(
        'input[type="checkbox"]:checked',
      );
      const keywords = Array.from(checkboxes).map((cb) => cb.value);

      modal.remove();

      for (const keyword of keywords) {
        try {
          const response = await fetch(
            `${API_BASE}/api/correspondence/keywords`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                keyword: keyword,
                project_id: projectId,
              }),
            },
          );

          if (response.ok) {
            const newKeyword = await response.json();
            cachedKeywords.push(newKeyword);
          }
        } catch (error) {
          console.error("Error adding keyword:", keyword, error);
        }
      }

      renderKeywordList();
      showNotification(`Added ${keywords.length} keyword(s)`, "success");
      triggerKeywordRematch();
    }

    /**
     * Load stakeholders
     */
    async function loadProjectStakeholders() {
      try {
        const response = await fetch(
          `${API_BASE}/api/correspondence/stakeholders?project_id=${projectId}`,
        );
        if (response.ok) {
          cachedStakeholders = await response.json();
          renderStakeholderList();
        }
      } catch (error) {
        console.error("Error loading stakeholders:", error);
      }
    }

    /**
     * Render stakeholder list
     */
    function renderStakeholderList() {
      const container = document.getElementById("contextStakeholderList");

      if (cachedStakeholders.length === 0) {
        container.innerHTML =
          '<span style="color: var(--text-muted); font-size: 0.875rem;">No stakeholders defined</span>';
        return;
      }

      container.innerHTML =
        cachedStakeholders
          .slice(0, 8)
          .map(
            (s) => `
                <span class="stakeholder-tag" title="${s.email || ""}">
                    <i class="fas fa-user"></i> ${s.name}
                </span>
            `,
          )
          .join("") +
        (cachedStakeholders.length > 8
          ? `<span style="color: var(--text-muted); font-size: 0.75rem;">+${cachedStakeholders.length - 8} more</span>`
          : "");
    }

    /**
     * Update AI suggestions based on selection
     */
    function updateAISuggestions(selectedRows) {
      const container = document.getElementById("aiSuggestionsList");

      if (selectedRows.length === 0) {
        container.innerHTML = `
                    <div class="context-empty-state">
                        <i class="fas fa-robot"></i>
                        <p>Select emails to get AI suggestions</p>
                    </div>
                `;
        return;
      }

      // Analyze selected emails for category suggestion
      const suggestedCategory = suggestCategoryForEmails(selectedRows);

      // Find potential claim matches
      const potentialMatches = findPotentialClaimMatches(selectedRows);

      let html = "";

      if (suggestedCategory) {
        html += `
                    <div class="suggestion-card">
                        <div class="suggestion-card-header">
                            <span class="suggestion-label">Suggested Category</span>
                        </div>
                        <div class="suggestion-value">${suggestedCategory}</div>
                        <div class="suggestion-actions">
                            <button class="suggestion-btn accept" onclick="applyCategoryToSelection('${suggestedCategory}')">
                                <i class="fas fa-check"></i> Apply
                            </button>
                            <button class="suggestion-btn dismiss" onclick="this.closest('.suggestion-card').remove()">
                                Dismiss
                            </button>
                        </div>
                    </div>
                `;
      }

      if (potentialMatches.length > 0) {
        html += `
                    <div class="suggestion-card" style="border-left-color: #f59e0b;">
                        <div class="suggestion-card-header">
                            <span class="suggestion-label">Related Matters</span>
                        </div>
                        ${potentialMatches
            .slice(0, 2)
            .map(
              (m) => `
                            <div style="margin-bottom: 0.5rem;">
                                <div class="suggestion-value" style="font-size: 0.8125rem;">${m.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Match score: ${m.score}%</div>
                            </div>
                        `,
            )
            .join("")}
                        <div class="suggestion-actions">
                            <button class="suggestion-btn accept" onclick="linkToMatter('${potentialMatches[0].id}')">
                                <i class="fas fa-link"></i> Link to Top Match
                            </button>
                        </div>
                    </div>
                `;
      }

      if (!html) {
        html = `
                    <div class="context-empty-state">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        <p>No suggestions at this time</p>
                    </div>
                `;
      }

      container.innerHTML = html;
    }

    /**
     * Suggest category based on email content
     */
    function suggestCategoryForEmails(emails) {
      const text = emails
        .map(
          (e) =>
            `${e.subject || ""} ${e.body_text_clean || e.body_text || ""}`,
        )
        .join(" ")
        .toLowerCase();

      const categoryPatterns = {
        Variation: [
          "variation",
          "vo ",
          "change order",
          "additional work",
          "omission",
        ],
        "Delay Notice": [
          "delay",
          "extension",
          "eot",
          "time extension",
          "programme delay",
          "delayed",
        ],
        Payment: [
          "payment",
          "invoice",
          "valuation",
          "interim",
          "final account",
          "certified",
        ],
        "Meeting Minutes": [
          "minutes",
          "meeting",
          "attendees",
          "action items",
          "agenda",
        ],
        "Site Instruction": [
          "site instruction",
          "si ",
          "instruction",
          "directed",
        ],
        "Compensation Event": ["compensation event", "ce ", "event notice"],
        "Early Warning": ["early warning", "ew ", "risk", "potential issue"],
        "Technical Query": [
          "technical query",
          "tq ",
          "rfi",
          "clarification",
          "query",
        ],
        "Progress Update": [
          "progress",
          "update",
          "status",
          "weekly report",
          "monthly report",
        ],
        "Quality Issue": [
          "quality",
          "defect",
          "snag",
          "ncr",
          "non-conformance",
        ],
        "Safety/H&S": [
          "safety",
          "health",
          "accident",
          "incident",
          "hazard",
          "ppe",
        ],
      };

      let bestMatch = null;
      let bestScore = 0;

      for (const [category, keywords] of Object.entries(categoryPatterns)) {
        const score = keywords.filter((kw) => text.includes(kw)).length;
        if (score > bestScore) {
          bestScore = score;
          bestMatch = category;
        }
      }

      return bestScore > 0 ? bestMatch : null;
    }

    /**
     * Find potential claim matches based on email content
     */
    function findPotentialClaimMatches(emails) {
      if (cachedMatters.length === 0) return [];

      const text = emails
        .map(
          (e) =>
            `${e.subject || ""} ${e.body_text_clean || e.body_text || ""}`,
        )
        .join(" ")
        .toLowerCase();

      return cachedMatters
        .map((matter) => {
          const matterWords = matter.name
            .toLowerCase()
            .split(/\W+/)
            .filter((w) => w.length > 3);
          const matchCount = matterWords.filter((w) =>
            text.includes(w),
          ).length;
          const score = Math.round(
            (matchCount / Math.max(matterWords.length, 1)) * 100,
          );
          return { ...matter, score };
        })
        .filter((m) => m.score > 20)
        .sort((a, b) => b.score - a.score);
    }

    /**
     * Apply category to selected emails
     */
    function applyCategoryToSelection(category) {
      const selectedRows = gridApi.getSelectedRows();
      selectedRows.forEach((row) => {
        row.category = category;
      });
      gridApi.refreshCells({ force: true });
      showNotification(
        `Applied "${category}" to ${selectedRows.length} email(s)`,
        "success",
      );
    }

    /**
     * Accept AI category suggestion for a single email
     */
    window.acceptCategorySuggestion = function (emailId, category) {
      // Find the row by ID
      let rowNode = null;
      gridApi.forEachNode((node) => {
        if (node.data.id === emailId) {
          rowNode = node;
        }
      });

      if (rowNode) {
        rowNode.data.category = category;
        gridApi.refreshCells({ rowNodes: [rowNode], force: true });
        showNotification(`Category set to "${category}"`, "success");
      }
    };

    /**
     * Link selected emails to a matter
     */
    async function linkToMatter(matterId) {
      document.getElementById("linkTypeSelect").value = "matter";
      onLinkTypeChange();
      document.getElementById("linkTargetSelect").value = matterId;
      document.getElementById("linkSelectedBtn").disabled = false;
      await linkSelectedEmails();
    }

    /**
     * Open quick link dropdown for a single email
     */
    window.openQuickLinkDropdown = async function (emailId, event) {
      // Remove any existing dropdown
      const existing = document.getElementById("quickLinkDropdownMenu");
      if (existing) existing.remove();

      // Load matters and claims if not cached
      if (cachedMatters.length === 0 && cachedClaims.length === 0) {
        await loadMattersAndClaims();
      }

      // Create dropdown menu
      const dropdown = document.createElement("div");
      dropdown.id = "quickLinkDropdownMenu";
      dropdown.style.cssText = `
                position: fixed;
                background: white;
                border-radius: 8px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                z-index: 10000;
                min-width: 280px;
                max-height: 400px;
                overflow-y: auto;
            `;

      // Position near click
      const rect = event.target.getBoundingClientRect();
      dropdown.style.left = `${rect.left}px`;
      dropdown.style.top = `${rect.bottom + 5}px`;

      let html = `
                <div style="padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--vericase-navy);">
                    <i class="fas fa-link" style="color: var(--vericase-teal);"></i> Link to Matter/Claim
                </div>
            `;

      if (cachedMatters.length > 0) {
        html += `
                    <div style="padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase;">
                        <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Contentious Matters
                    </div>
                `;
        cachedMatters.forEach((m) => {
          html += `
                        <div onclick="quickLinkToTarget('${emailId}', 'matter', '${m.id}')"
                             style="padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem;"
                             onmouseover="this.style.background='#f3f4f6'"
                             onmouseout="this.style.background='transparent'">
                            ${m.name}
                        </div>
                    `;
        });
      }

      if (cachedClaims.length > 0) {
        html += `
                    <div style="padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; border-top: 1px solid #e5e7eb; margin-top: 0.25rem;">
                        <i class="fas fa-gavel" style="color: #ef4444;"></i> Heads of Claim
                    </div>
                `;
        cachedClaims.forEach((c) => {
          html += `
                        <div onclick="quickLinkToTarget('${emailId}', 'claim', '${c.id}')"
                             style="padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem;"
                             onmouseover="this.style.background='#f3f4f6'"
                             onmouseout="this.style.background='transparent'">
                            ${c.reference_number ? c.reference_number + " - " : ""}${c.name}
                        </div>
                    `;
        });
      }

      if (cachedMatters.length === 0 && cachedClaims.length === 0) {
        html += `
                    <div style="padding: 1.5rem; text-align: center; color: #6b7280;">
                        <i class="fas fa-info-circle" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                        No matters or claims created yet.
                        <button onclick="document.getElementById('quickLinkDropdownMenu').remove(); openCreateMatterModal();"
                                style="display: block; margin: 0.75rem auto 0; background: var(--vericase-teal); color: white;
                                       border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-plus"></i> Create Matter
                        </button>
                    </div>
                `;
      } else {
        html += `
                    <div style="padding: 0.75rem 1rem; border-top: 1px solid #e5e7eb; text-align: center;">
                        <button onclick="document.getElementById('quickLinkDropdownMenu').remove(); openCreateMatterModal();"
                                style="background: none; border: 1px dashed #d1d5db; color: #6b7280;
                                       padding: 0.375rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">
                            <i class="fas fa-plus"></i> Create New Matter
                        </button>
                    </div>
                `;
      }

      dropdown.innerHTML = html;
      document.body.appendChild(dropdown);

      // Close on outside click
      setTimeout(() => {
        document.addEventListener("click", function closeDropdown(e) {
          if (!dropdown.contains(e.target)) {
            dropdown.remove();
            document.removeEventListener("click", closeDropdown);
          }
        });
      }, 100);
    };

    /**
     * Quick link email to a target
     */
    window.quickLinkToTarget = async function (emailId, type, targetId) {
      const dropdown = document.getElementById("quickLinkDropdownMenu");
      if (dropdown) dropdown.remove();

      try {
        const response = await fetch(`${API_BASE}/api/claims/links`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            item_type: "correspondence",
            item_id: emailId,
            contentious_matter_id: type === "matter" ? targetId : null,
            head_of_claim_id: type === "claim" ? targetId : null,
            link_type: "supporting",
          }),
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || "Failed to create link");
        }

        showNotification("Email linked successfully", "success");
        refreshData();
      } catch (error) {
        console.error("Error linking email:", error);
        showNotification(error.message, "error");
      }
    };

    /**
     * Unlink an email from its matter/claim
     */
    window.unlinkEmail = async function (emailId) {
      if (!confirm("Remove this link?")) return;

      try {
        // Find and delete the link
        const response = await fetch(
          `${API_BASE}/api/claims/links/by-item/correspondence/${emailId}`,
          {
            method: "DELETE",
          },
        );

        if (response.ok || response.status === 404) {
          showNotification("Link removed", "success");
          refreshData();
        } else {
          throw new Error("Failed to remove link");
        }
      } catch (error) {
        console.error("Error unlinking email:", error);
        showNotification("Failed to remove link", "error");
      }
    };

    /**
     * Bulk set category
     */
    function bulkSetCategory() {
      const selectedRows = gridApi.getSelectedRows();
      if (selectedRows.length === 0) {
        showNotification("Please select emails first", "error");
        return;
      }

      const categories = [
        "",
        "Site Instruction",
        "Variation",
        "Delay Notice",
        "Compensation Event",
        "Early Warning",
        "Payment",
        "Meeting Minutes",
        "Technical Query",
        "Progress Update",
        "Contract Document",
        "Safety/H&S",
        "Quality Issue",
        "General",
      ];

      const modal = document.createElement("div");
      modal.id = "bulkCategoryModal";
      modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;

      modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 350px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="font-size: 1rem; font-weight: 600;">Set Category for ${selectedRows.length} Email(s)</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <select id="bulkCategorySelect" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                            ${categories.map((c) => `<option value="${c}">${c || "(Clear category)"}</option>`).join("")}
                        </select>
                    </div>
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                        <button onclick="document.getElementById('bulkCategoryModal').remove()" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer;">Cancel</button>
                        <button onclick="applyBulkCategory()" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; background: var(--vericase-teal); color: white; cursor: pointer; font-weight: 500;">Apply</button>
                    </div>
                </div>
            `;

      document.body.appendChild(modal);
    }

    /**
     * Apply bulk category
     */
    function applyBulkCategory() {
      const category = document.getElementById("bulkCategorySelect").value;
      const selectedRows = gridApi.getSelectedRows();

      selectedRows.forEach((row) => {
        row.category = category;
      });

      gridApi.refreshCells({ force: true });
      document.getElementById("bulkCategoryModal").remove();
      showNotification(
        `Applied category to ${selectedRows.length} email(s)`,
        "success",
      );
    }

    /**
     * Bulk add keywords
     */
    function bulkAddKeywords() {
      const selectedRows = gridApi.getSelectedRows();
      if (selectedRows.length === 0) {
        showNotification("Please select emails first", "error");
        return;
      }

      const modal = document.createElement("div");
      modal.id = "bulkKeywordsModal";
      modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;

      modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div style="padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="font-size: 1rem; font-weight: 600;">Add Keywords to ${selectedRows.length} Email(s)</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <input type="text" id="bulkKeywordsInput" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="Enter keywords, comma separated">
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Example: delay, foundation, contractor
                        </p>
                    </div>
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                        <button onclick="document.getElementById('bulkKeywordsModal').remove()" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer;">Cancel</button>
                        <button onclick="applyBulkKeywords()" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; background: var(--vericase-teal); color: white; cursor: pointer; font-weight: 500;">Add Keywords</button>
                    </div>
                </div>
            `;

      document.body.appendChild(modal);
    }

    /**
     * Apply bulk keywords
     */
    function applyBulkKeywords() {
      const input = document.getElementById("bulkKeywordsInput").value;
      const keywords = input
        .split(",")
        .map((k) => k.trim())
        .filter((k) => k);
      const selectedRows = gridApi.getSelectedRows();

      if (keywords.length === 0) {
        showNotification("Please enter at least one keyword", "error");
        return;
      }

      selectedRows.forEach((row) => {
        const existing = (row.keywords || "")
          .split(",")
          .map((k) => k.trim())
          .filter((k) => k);
        const combined = [...new Set([...existing, ...keywords])];
        row.keywords = combined.join(", ");
      });

      gridApi.refreshCells({ force: true });
      document.getElementById("bulkKeywordsModal").remove();
      showNotification(
        `Added ${keywords.length} keyword(s) to ${selectedRows.length} email(s)`,
        "success",
      );
    }

    /**
     * Bulk export selected
     */
    function bulkExportSelected() {
      const selectedRows = gridApi.getSelectedRows();
      if (selectedRows.length === 0) {
        showNotification("Please select emails to export", "error");
        return;
      }

      // Create CSV
      const headers = [
        "Date",
        "From",
        "To",
        "Subject",
        "Category",
        "Keywords",
        "Has Attachments",
      ];
      const rows = selectedRows.map((e) => [
        e.date_sent ? new Date(e.date_sent).toISOString() : "",
        e.sender_email || e.email_from || "",
        e.email_to || "",
        (e.subject || "").replace(/"/g, '""'),
        e.category || "",
        e.keywords || "",
        e.has_attachments ? "Yes" : "No",
      ]);

      const csv = [
        headers.join(","),
        ...rows.map((r) => r.map((c) => `"${c}"`).join(",")),
      ].join("\n");

      // Download
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `correspondence_export_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification(`Exported ${selectedRows.length} email(s)`, "success");
    }

    /**
     * Initialize context panel on page load
     */
    function initContextPanel() {
      loadMattersAndClaims();
      loadProjectKeywords();
      loadProjectStakeholders();
    }

    // Initialize context panel when data is first loaded (server-side)
    // We hook into onFirstDataRendered which is called by the grid
    const originalOnFirstDataRendered = onFirstDataRendered;
    function onFirstDataRenderedWithContext(params) {
      if (typeof originalOnFirstDataRendered === "function") {
        originalOnFirstDataRendered(params);
      }
      initContextPanel();
    }
    // Update gridOptions if already created
    if (gridApi && gridApi.setGridOption) {
      gridApi.setGridOption(
        "onFirstDataRendered",
        onFirstDataRenderedWithContext,
      );
    }

    // ==================== END CONTEXT PANEL FUNCTIONS ====================

    // ============================================
    // ATTACHMENT PREVIEW & DOWNLOAD
    // ============================================

    async function previewAttachment(evidenceId, attachmentId, filename) {
      try {
        // Show loading
        let modal = document.getElementById("previewModal");

        if (!modal) {
          createPreviewModal();
          modal = document.getElementById("previewModal");
        }

        const content = document.getElementById("previewModalContent");
        const title = document.getElementById("previewModalTitle");

        if (!modal || !content) {
          console.error("Preview modal elements not found");
          return;
        }

        modal.classList.add("active");
        if (title) title.textContent = filename || "Preview";
        content.innerHTML =
          '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;"><div class="spinner"></div><p style="margin-top:1rem; color:#64748b;">Loading preview...</p></div>';

        // Fetch signed URL
        const response = await fetch(
          `${apiUrl}/api/evidence/items/${evidenceId}/attachments/${attachmentId}/url`,
        );
        if (!response.ok) throw new Error("Failed to get preview URL");

        const data = await response.json();
        const url = data.url;
        const type = data.content_type || "";
        const ext = (filename || "").split(".").pop().toLowerCase();

        // Determine preview type
        let html = "";
        if (
          type.startsWith("image/") ||
          ["jpg", "jpeg", "png", "gif", "webp", "bmp", "svg"].includes(ext)
        ) {
          html = `<div style="display:flex; align-items:center; justify-content:center; height:100%; background:#f1f5f9;">
                                <img src="${url}" style="max-width:100%; max-height:100%; object-fit:contain; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                            </div>`;
        } else if (type === "application/pdf" || ext === "pdf") {
          html = `<iframe src="${url}#toolbar=0" style="width:100%; height:100%; border:none;"></iframe>`;
        } else if (
          type.startsWith("text/") ||
          [
            "txt",
            "log",
            "csv",
            "json",
            "xml",
            "md",
            "py",
            "js",
            "html",
            "css",
          ].includes(ext)
        ) {
          // For text, fetch content
          try {
            const textResp = await fetch(url);
            const text = await textResp.text();
            html = `<pre style="background:#1e293b; color:#f8fafc; padding:1.5rem; overflow:auto; height:100%; margin:0; font-family:'Consolas', monospace; font-size:0.9rem; white-space:pre-wrap;">${escapeHtml(text)}</pre>`;
          } catch (e) {
            html = `<div style="text-align:center; padding:3rem;">
                                    <i class="fas fa-exclamation-triangle" style="font-size:3rem; color:#f59e0b; margin-bottom:1rem;"></i>
                                    <p style="font-size:1.1rem; margin-bottom:1.5rem;">Could not load text content directly.</p>
                                    <a href="${url}" class="btn btn-primary" target="_blank" style="display:inline-flex; align-items:center; gap:0.5rem; padding:0.75rem 1.5rem;">
                                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                                    </a>
                                 </div>`;
          }
        } else {
          // Fallback
          let icon = "fa-file";
          if (["doc", "docx"].includes(ext)) icon = "fa-file-word";
          if (["xls", "xlsx"].includes(ext)) icon = "fa-file-excel";
          if (["ppt", "pptx"].includes(ext)) icon = "fa-file-powerpoint";
          if (["zip", "rar", "7z"].includes(ext)) icon = "fa-file-archive";

          html = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:2rem;">
                                <div style="width:80px; height:80px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:1.5rem;">
                                    <i class="fas ${icon}" style="font-size:3rem; color:#64748b;"></i>
                                </div>
                                <h3 style="margin:0 0 0.5rem 0; color:#1e293b;">${escapeHtml(filename)}</h3>
                                <p style="color:#64748b; margin:0 0 2rem 0;">Preview not available for this file type.</p>
                                <a href="${url}" class="btn btn-primary" target="_blank" style="display:inline-flex; align-items:center; gap:0.5rem; padding:0.75rem 1.5rem;">
                                    <i class="fas fa-download"></i> Download File
                                </a>
                            </div>`;
        }

        content.innerHTML = html;
      } catch (e) {
        console.error("Preview failed:", e);
        const content = document.getElementById("previewModalContent");
        if (content) {
          content.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#ef4444;">
                        <i class="fas fa-times-circle" style="font-size:3rem; margin-bottom:1rem;"></i>
                        <p>Failed to load preview.</p>
                        <p style="font-size:0.875rem; color:#64748b;">${e.message}</p>
                    </div>`;
        }
        if (window.VericaseUI)
          VericaseUI.Toast.error("Error previewing attachment");
      }
    }

    async function downloadAttachment(evidenceId, attachmentId, filename) {
      try {
        const response = await fetch(
          `${apiUrl}/api/evidence/items/${evidenceId}/attachments/${attachmentId}/url`,
        );
        if (!response.ok) throw new Error("Failed to get download URL");

        const data = await response.json();
        const link = document.createElement("a");
        link.href = data.url;
        link.download = filename || "download";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        console.error("Download failed:", e);
        if (window.VericaseUI)
          VericaseUI.Toast.error("Error downloading attachment");
      }
    }

    function createPreviewModal() {
      if (document.getElementById("previewModal")) return;

      const div = document.createElement("div");
      div.id = "previewModal";
      div.className = "preview-modal";
      div.innerHTML = `
                <div class="preview-modal-header">
                    <div class="preview-modal-title" id="previewModalTitle">File Preview</div>
                    <div class="preview-modal-actions">
                        <button class="btn btn-icon btn-ghost preview-modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="preview-modal-body">
                    <div class="preview-modal-content" id="previewModalContent"></div>
                </div>
            `;
      document.body.appendChild(div);

      // Add close handler
      div
        .querySelector(".preview-modal-close")
        .addEventListener("click", () => {
          div.classList.remove("active");
        });
      div.addEventListener("click", (e) => {
        if (e.target === div) div.classList.remove("active");
      });
    }

    // Set AG-Grid Enterprise license key (Trial - Valid until 21 December 2025)
    agGrid.LicenseManager.setLicenseKey(
      "Using_this_{AG_Charts_and_AG_Grid}_Enterprise_key_{AG-113929}_in_excess_of_the_licence_granted_is_not_permitted___Please_report_misuse_to_legal@ag-grid.com___For_help_with_changing_this_key_please_contact_info@ag-grid.com___{Quantum_Commercial_Solutions}_is_granted_a_{Single_Application}_Developer_License_for_the_application_{VeriCase}_only_for_{1}_Front-End_JavaScript_developer___All_Front-End_JavaScript_developers_working_on_{VeriCase}_need_to_be_licensed___{VeriCase}_has_been_granted_a_Deployment_License_Add-on_for_{1}_Production_Environment___This_key_works_with_{AG_Charts_and_AG_Grid}_Enterprise_versions_released_before_{2_December_2026}____[v3]_[0102]_MTc5NjE2OTYwMDAwMA==3028fd492276b13c54c2a50715493e19"
    );

    // Programme Management
    function openProgrammeModal() {
      const modal = document.getElementById("programmeModal");
      if (modal) {
        modal.style.display = "flex";
        // Reset status
        const status = document.getElementById("programmeUploadStatus");
        if (status) status.innerHTML = "";
      }
    }

    function closeProgrammeModal() {
      const modal = document.getElementById("programmeModal");
      if (modal) modal.style.display = "none";
    }

    async function uploadProgramme() {
      const fileInput = document.getElementById("programmeFileInput");
      const typeInput = document.getElementById("programmeTypeInput");
      const statusDiv = document.getElementById("programmeUploadStatus");

      if (!fileInput.files || fileInput.files.length === 0) {
        statusDiv.innerHTML =
          '<span style="color: red;">Please select a file.</span>';
        return;
      }

      const file = fileInput.files[0];
      const type = typeInput.value;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("programme_type", type);
      // Assuming we have caseId or projectId from global state
      if (window.caseId) formData.append("case_id", window.caseId);
      if (window.projectId) formData.append("project_id", window.projectId);

      statusDiv.innerHTML = '<span style="color: blue;">Uploading...</span>';

      try {
        const response = await fetch(`${API_BASE}/api/programmes/upload`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) throw new Error("Upload failed");

        const result = await response.json();
        statusDiv.innerHTML = `<span style="color: green;">Success! Programme uploaded. ID: ${result.id}</span>`;

        // Refresh grid to show new data if any linking happened
        setTimeout(() => {
          closeProgrammeModal();
          if (gridApi) gridApi.refreshServerSide({ purge: true });
        }, 1500);
      } catch (error) {
        console.error("Upload error:", error);
        statusDiv.innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
      }
    }
  </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriCase - Intelligent Configuration</title>
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="stylesheet" href="assets/global.css">
    <link rel="stylesheet" href="brand-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'SF Pro Display', 'Roboto', sans-serif;
            background: var(--bg-primary);
            background-image: radial-gradient(circle, rgba(23, 181, 163, 0.08) 1px, transparent 1px);
            background-size: 30px 30px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wizard-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .wizard-header {
            background: linear-gradient(135deg, var(--vericase-navy) 0%, var(--vericase-navy) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .wizard-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .wizard-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--vericase-teal) 0%, var(--vericase-teal-dark) 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: var(--vericase-navy);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
        }

        .message.bot .message-content {
            background: #f3f4f6;
            color: var(--vericase-navy);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--vericase-teal) 0%, var(--vericase-teal-dark) 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .quick-action-btn {
            background: white;
            border: 2px solid var(--vericase-teal);
            color: var(--vericase-teal);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: var(--vericase-teal);
            color: white;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--vericase-teal);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .chat-input-container {
            border-top: 2px solid #e5e7eb;
            padding: 1.5rem;
            background: white;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            padding: 12px 20px;
            font-size: 15px;
            resize: none;
            max-height: 120px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--vericase-teal);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--vericase-teal) 0%, var(--vericase-teal-dark) 100%);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(23, 181, 163, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--vericase-teal) 0%, var(--vericase-teal-dark) 100%);
            transition: width 0.3s ease;
            width: 0%;
        }

        .suggestion-chip {
            display: inline-block;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            margin: 4px 4px 4px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background: var(--vericase-teal);
            color: white;
            border-color: var(--vericase-teal);
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <div class="wizard-header">
            <button class="close-btn" onclick="window.location.href='dashboard.html'">
                <i class="fas fa-times"></i>
            </button>
            <h1><i class="fas fa-robot"></i> Intelligent Configuration</h1>
            <p>Let AI help you configure your system correctly</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Breadcrumbs for navigation clarity -->
        <nav class="breadcrumbs">
            <div class="container inner" aria-label="Breadcrumb">
                <a href="dashboard.html">Home</a>
                <span class="sep">/</span>
                <span class="current">Intelligent Setup</span>
            </div>
        </nav>

        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here -->
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="Type your message..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const token = localStorage.getItem('token');
        let conversationHistory = [];
        let configurationData = {};
        let currentStep = 'introduction';
        let finalConfiguration = null;
        let aiAvailable = false;

        if (!token) {
            window.location.href = 'login.html';
        }

        // Initialize chat
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAIAvailability();
            if (aiAvailable) {
                startConversation();
            } else {
                showAIUnavailableMessage();
            }
            setupAutoResize();
        });

        async function checkAIAvailability() {
            try {
                const response = await fetch(`${API_BASE}/api/ai/status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const status = await response.json();
                    aiAvailable = status.any_available;
                    
                    if (!aiAvailable) {
                        console.warn('No AI services available. API keys need to be configured.');
                    }
                } else {
                    console.error('Failed to check AI availability');
                    aiAvailable = false;
                }
            } catch (error) {
                console.error('Error checking AI availability:', error);
                aiAvailable = false;
            }
        }

        function showAIUnavailableMessage() {
            addBotMessage("⚠️ **AI Services Not Configured**\n\nThe intelligent configuration wizard uses AI to guide you through setup, but no AI API keys are currently configured.\n\n**To enable AI features:**\n1. Go to Dashboard → Settings → AI Configuration\n2. Add at least one API key (OpenAI, Anthropic, or Google)\n3. Save and return here\n\n**Alternative:** You can use the manual configuration wizard which doesn't require AI.", [
                "Go to manual wizard",
                "Go to dashboard",
                "Open settings"
            ]);
            
            // Don't fully disable - let them try anyway and get server error with instructions
            document.getElementById('chatInput').placeholder = 'AI not configured - configure in settings first...';
        }

        function setupAutoResize() {
            const textarea = document.getElementById('chatInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function startConversation() {
            addBotMessage("Hello! I'm your intelligent configuration assistant. I'll help you set up your VeriCase system quickly and correctly.");
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            addBotMessage("Let's start with the basics - just the essential information needed to get you up and running. Once we have the basics configured, your system will be ready to use even before you upload any evidence or PST files.");
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            addBotMessage("After you upload files, the **Refinement Wizard** will intelligently prompt you with more direct and specific questions based on the actual data it sees. The two wizards work together - I handle the initial setup, and the Refinement Wizard fine-tunes everything once it analyzes your evidence.");
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            addBotMessage("Don't worry - you can always come back to this configuration wizard at any time to add more details. But the more we configure upfront, the better your initial analysis will be when you upload files.");
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            addBotMessage("First, let's build your team. Who are the key people involved? You can tell me their names and roles, or I can guide you through it.", [
                "I'll add team members",
                "Show me how",
                "I have a team list ready"
            ]);
        }

        function addBotMessage(text, quickActions = []) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    ${formatMessage(text)}
                    ${quickActions.length > 0 ? `
                        <div class="quick-actions">
                            ${quickActions.map(action => `
                                <button class="quick-action-btn" onclick="handleQuickAction('${action}')">${action}</button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-content">${escapeHtml(text)}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTyping() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            messagesDiv.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Warn if AI is not available but let them try
            if (!aiAvailable) {
                addBotMessage("⚠️ AI services are not configured. Please add API keys in Dashboard → Settings → AI Configuration first.");
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                return;
            }
            
            // Disable input while processing
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            // Add user message
            addUserMessage(message);
            conversationHistory.push({ role: 'user', content: message });
            input.value = '';
            input.style.height = 'auto';
            
            // Show typing indicator
            showTyping();
            
            try {
                // Send to AI configuration endpoint
                const response = await fetch(`${API_BASE}/api/ai/intelligent-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conversationHistory,
                        current_step: currentStep,
                        configuration_data: configurationData
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get AI response');
                }

                const data = await response.json();
                
                hideTyping();
                
                // Update configuration data
                if (data.configuration_data) {
                    configurationData = { ...configurationData, ...data.configuration_data };
                }
                
                // Update current step
                if (data.next_step) {
                    currentStep = data.next_step;
                }
                
                // Update progress
                if (data.progress !== undefined) {
                    updateProgress(data.progress);
                }
                
                // Add bot response
                addBotMessage(data.response, data.quick_actions || []);
                
                // If configuration is complete, capture final IDs and show summary
                if (data.configuration_complete) {
                    finalConfiguration = data.final_configuration || null;
                    storeProfileContext(finalConfiguration);
                    await showConfigurationSummary(data.final_configuration);
                }
                
            } catch (error) {
                hideTyping();
                console.error('Error:', error);
                addBotMessage("I'm sorry, I encountered an error. Could you please try rephrasing your message?");
            } finally {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            }
        }

        function handleQuickAction(action) {
            // Handle AI unavailable actions
            if (action === "Go to manual wizard") {
                window.location.href = 'wizard.html';
                return;
            }
            
            if (action === "Open settings") {
                window.location.href = 'dashboard.html?openSettings=ai';
                return;
            }
            
            // Handle special post-completion actions
            if (action === "Go to dashboard") {
                storeProfileContext(finalConfiguration);
                let navigateUrl = 'dashboard.html';
                if (finalConfiguration) {
                    if (finalConfiguration.project_id) {
                        navigateUrl = `dashboard.html?projectId=${finalConfiguration.project_id}`;
                        localStorage.setItem('profileType', 'project');
                    } else if (finalConfiguration.case_id) {
                        navigateUrl = `dashboard.html?caseId=${finalConfiguration.case_id}`;
                        localStorage.setItem('profileType', 'case');
                    }
                }
                window.location.href = navigateUrl;
                return;
            }
            
            if (action === "Upload evidence") {
                storeProfileContext(finalConfiguration);
                let navigateUrl = 'pst-upload.html';
                if (finalConfiguration) {
                    if (finalConfiguration.project_id) {
                        navigateUrl = `pst-upload.html?projectId=${finalConfiguration.project_id}`;
                        localStorage.setItem('profileType', 'project');
                    } else if (finalConfiguration.case_id) {
                        navigateUrl = `pst-upload.html?caseId=${finalConfiguration.case_id}`;
                        localStorage.setItem('profileType', 'case');
                    }
                }
                window.location.href = navigateUrl;
                return;
            }
            
            if (action === "Review setup") {
                // Show detailed review of configuration
                let review = "**Current Configuration Summary:**\n\n";
                if (configurationData.team_members && configurationData.team_members.length > 0) {
                    review += `**Team Members (${configurationData.team_members.length}):**\n`;
                    configurationData.team_members.forEach((member, idx) => {
                        review += `${idx + 1}. ${member.name || 'Unknown'}`;
                        if (member.role) review += ` - ${member.role}`;
                        if (member.email) review += ` (${member.email})`;
                        review += "\n";
                    });
                    review += "\n";
                }
                if (configurationData.project_name || configurationData.case_name) {
                    review += `**Project/Case:** ${configurationData.project_name || configurationData.case_name}\n`;
                }
                if (configurationData.project_code) {
                    review += `**Project Code:** ${configurationData.project_code}\n`;
                }
                if (configurationData.case_number) {
                    review += `**Case Number:** ${configurationData.case_number}\n`;
                }
                review += "\n";
                if (configurationData.keywords && configurationData.keywords.length > 0) {
                    review += `**Keywords:** ${configurationData.keywords.join(', ')}\n\n`;
                }
                review += "Would you like to continue configuring, or go to the dashboard?";
                addBotMessage(review, [
                    "Continue configuration",
                    "Go to dashboard"
                ]);
                return;
            }
            
            // Default: send as message
            document.getElementById('chatInput').value = action;
            sendMessage();
        }

        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
        }
        
        function storeProfileContext(config) {
            if (!config) return;
            
            if (config.project_id) {
                localStorage.setItem('profileType', 'project');
                localStorage.setItem('currentProjectId', config.project_id);
                try {
                    localStorage.setItem('projectId', config.project_id);
                } catch (e) {}
            } else if (config.case_id) {
                localStorage.setItem('profileType', 'case');
                localStorage.setItem('currentCaseId', config.case_id);
                try {
                    localStorage.setItem('caseId', config.case_id);
                } catch (e) {}
            }
        }

        async function showConfigurationSummary(config) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            let summary = "Perfect! I've configured the basics for your system:\n\n";
            
            if (config.team_members && config.team_members.length > 0) {
                summary += `✓ **Team Members:** ${config.team_members.length} members added\n`;
            }
            
            if (config.project_name || config.case_name) {
                summary += `✓ **Project/Case:** ${config.project_name || config.case_name}\n`;
            }
            
            if (config.project_code) {
                summary += `✓ **Project Code:** ${config.project_code}\n`;
            }
            
            if (config.case_number) {
                summary += `✓ **Case Number:** ${config.case_number}\n`;
            }
            
            if (config.keywords && config.keywords.length > 0) {
                summary += `✓ **Keywords:** ${config.keywords.join(', ')}\n`;
            }
            
            summary += "\n**Your system is ready to use!**\n\n";
            summary += "You can start uploading evidence (PST files, documents) right away. Your configuration will work immediately with the basics we've set up.\n\n";
            summary += "**What happens next:**\n";
            summary += "• After you upload files, the **Refinement Wizard** will analyze your actual evidence\n";
            summary += "• It will intelligently prompt you with direct, specific questions based on what it finds\n";
            summary += "• For example: \"I found emails mentioning 'variation order #123' - is this a key document?\"\n";
            summary += "• The two wizards work together - I handle initial setup, Refinement Wizard fine-tunes with real data\n\n";
            summary += "**Benefits of configuring more now:**\n";
            summary += "• Better initial analysis and categorization from the first upload\n";
            summary += "• More accurate keyword matching and email threading from the start\n";
            summary += "• Improved relationship mapping between team members\n";
            summary += "• Faster evidence processing with fewer corrections needed\n";
            summary += "• Example: If we configure contract types (FIDIC, JCT) now, emails will be categorized correctly immediately\n\n";
            summary += "**Remember:** You can always come back to this configuration wizard at any time to add more details.\n\n";
            summary += "**What would you like to do?**\n";
            summary += "1. Continue with more configuration now (recommended for best initial results)\n";
            summary += "2. Go to the project dashboard\n";
            summary += "3. Upload evidence directly (PST files, documents)\n";
            summary += "4. Review what we've set up";
            
            addBotMessage(summary, [
                "Continue configuration",
                "Go to dashboard",
                "Upload evidence",
                "Review setup"
            ]);
        }

        function formatMessage(text) {
            // Convert markdown-style formatting to HTML
            return escapeHtml(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>


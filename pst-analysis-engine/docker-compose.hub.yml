# Docker Compose using pre-built images from Docker Hub
# Usage: docker-compose -f docker-compose.hub.yml up -d
#
# This pulls your latest images from Docker Hub instead of building locally
# Much faster for quick testing!

name: pst-analysis-engine

services:
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-admin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-changeme123}
    ports: ["9002:9000","9003:9001"]
    volumes: ["minio_data:/data"]

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-vericase}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-vericase}
      POSTGRES_DB: ${POSTGRES_DB:-vericase}
    ports: ["54321:5432"]
    volumes: ["pg_data:/var/lib/postgresql/data"]

  redis:
    image: redis:7
    ports: ["6379:6379"]

  opensearch:
    image: opensearchproject/opensearch:2.10.0
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65536, hard: 65536 }
    ports: ["9200:9200","9600:9600"]
    volumes: ["os_data:/usr/share/opensearch/data"]

  tika:
    image: apache/tika:latest
    ports: ["9998:9998"]

  api:
    # Pull latest from Docker Hub instead of building
    image: wcjrogers/vericase-api:latest
    env_file: .env
    environment:
      - DATABASE_URL=postgresql+psycopg2://vericase:vericase@postgres:5432/vericase
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - OPENSEARCH_HOST=opensearch
      - OPENSEARCH_PORT=9200
      - TIKA_URL=http://tika:9998
    depends_on: [minio, postgres, redis, opensearch, tika]
    ports: ["8010:8000"]
    # OPTIONAL: Mount local code to override image code (for hot reload)
    # Uncomment these lines if you want to test local changes:
    # volumes:
    #   - "./api/app:/code/app"
    #   - "./ui:/code/ui"

  worker:
    # Pull latest from Docker Hub instead of building
    image: wcjrogers/vericase-api:latest
    # Worker uses the same image but different command
    command: celery -A worker_app.worker worker -Q celery --loglevel=info --concurrency=2
    env_file: .env
    environment:
      - DATABASE_URL=postgresql+psycopg2://vericase:vericase@postgres:5432/vericase
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - OPENSEARCH_HOST=opensearch
      - OPENSEARCH_PORT=9200
      - TIKA_URL=http://tika:9998
    depends_on: [minio, postgres, redis, opensearch, tika]
    # OPTIONAL: Mount local code to override image code
    # Uncomment these lines if you want to test local changes:
    # volumes:
    #   - "./worker_app:/code/worker_app"
    #   - "./api/app:/code/app"

  frontend:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ../frontend:/app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://api:8000
    command: sh -c "npm install && npm run dev -- --host"
    depends_on:
      - api

volumes:
  pg_data:
  os_data:
  minio_data:

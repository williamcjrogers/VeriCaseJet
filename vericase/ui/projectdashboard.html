<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VeriCase - Overview</title>
  <meta name="robots" content="noindex" />
  <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="brand-styles.css?v=9" />
  <script src="context-manager.js"></script>
  <script src="nav-shell.js"></script>
  <style>
    :root {
      color-scheme: light;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-primary);
      color: #0f172a;
      min-height: 100vh;
      display: grid;
      place-items: center;
    }

    .loader {
      width: min(520px, 92vw);
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
      padding: 24px;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin: 0 0 8px;
    }

    .title small {
      font-weight: 600;
      color: rgba(15, 23, 42, 0.65);
    }

    .bar {
      height: 8px;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.08);
      overflow: hidden;
      margin-top: 16px;
    }

    .bar > div {
      height: 100%;
      width: 40%;
      border-radius: var(--radius-md);
      background: linear-gradient(90deg, rgba(var(--vericase-teal-rgb), 0.25), rgba(var(--vericase-teal-rgb), 0.9), rgba(184, 134, 11, 0.85));
      animation: shimmer 1.1s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-30%);
      }

      100% {
        transform: translateX(170%);
      }
    }

    .msg {
      margin: 0;
      color: rgba(15, 23, 42, 0.7);
      line-height: 1.5;
    }

    .error {
      display: none;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(220, 38, 38, 0.06);
      border: 1px solid rgba(220, 38, 38, 0.18);
      color: #7f1d1d;
      font-size: 14px;
    }

    .error a {
      color: inherit;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <div class="loader" role="status" aria-live="polite">
    <h1 class="title">
      VeriCase <small>Loading Overview…</small>
    </h1>
    <p class="msg" id="loader-msg">Preparing your workspace...</p>
    <div class="bar"><div></div></div>
    <div class="error" id="loadError">
      Unable to load the overview UI. You can try opening
      <a id="fallbackLink" href="dashboard.html">dashboard.html</a> directly.
    </div>
  </div>

  <script>
    (async function () {
      const target = new URL("dashboard.html", window.location.href);
      target.search = window.location.search;
      target.hash = window.location.hash;

      // Context guard: this overview should only load with an explicit projectId/caseId
      // (or a previously selected context in storage). This prevents silently
      // defaulting to a different profile type.
      try {
      const params = new URLSearchParams(target.search);
      const urlCaseId = params.get("caseId");
      const urlProjectId = params.get("projectId");

      const loaderMsg = document.getElementById("loader-msg");
      if (loaderMsg) {
        loaderMsg.textContent = urlCaseId
          ? "Preparing your workspace and syncing your current case context."
          : "Preparing your workspace and syncing your current project context.";
      }

        let contextType = urlCaseId ? "case" : urlProjectId ? "project" : null;
        let contextId = urlCaseId || urlProjectId;

        const cleanId = (v) => {
          const s = (v || "").trim();
          if (!s || s === "null" || s === "undefined") return null;
          return s;
        };

      if (urlCaseId) {
        VericaseContext.set("profileType", "case");
        VericaseContext.set("caseId", urlCaseId);
        VericaseContext.remove("projectId");
      } else if (urlProjectId) {
        VericaseContext.set("profileType", "project");
        VericaseContext.set("projectId", urlProjectId);
        VericaseContext.remove("caseId");
      }

      if (!contextId) {
        const storedProfileType = (VericaseContext.get("profileType") || "").trim();
        const storedProjectId = cleanId(VericaseContext.get("projectId"));
        const storedCaseId = cleanId(VericaseContext.get("caseId"));

          if (storedProfileType === "case" && storedCaseId) {
            contextType = "case";
            contextId = storedCaseId;
          } else if (storedProfileType === "project" && storedProjectId) {
            contextType = "project";
            contextId = storedProjectId;
          } else if (storedProjectId) {
            contextType = "project";
            contextId = storedProjectId;
          } else if (storedCaseId) {
            contextType = "case";
            contextId = storedCaseId;
          }

          if (contextType && contextId) {
            // Preserve any other query params (token, firstTime, etc.), just add context.
            if (contextType === "case") {
              params.set("caseId", contextId);
              params.delete("projectId");
            } else {
              params.set("projectId", contextId);
              params.delete("caseId");
            }
            target.search = params.toString();
          } else {
            // No context to restore — send user to the chooser.
            window.location.replace("workspace-hub.html");
            return;
          }
        }
      } catch (e) {
        console.warn("[Overview] Context guard error:", e);
      }

      // Update fallback link to preserve params
      const fallback = document.getElementById("fallbackLink");
      if (fallback) fallback.href = target.toString();

      try {
        const res = await fetch(target.toString(), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const html = await res.text();

        // Replace this document with the real dashboard HTML while
        // keeping the address bar as projectdashboard.html.
        document.open();
        document.write(html);
        document.close();
      } catch (e) {
        const err = document.getElementById("loadError");
        if (err) err.style.display = "block";
        console.error("[Overview] Failed to load dashboard.html:", e);
      }
    })();
  </script>
</body>

</html>

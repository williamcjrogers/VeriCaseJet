<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeriCase - Control Centre</title>
    <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="brand-styles.css?v=8" />
    <link rel="stylesheet" href="design-system.css?v=8" />
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>
    <style>
        /* === CONTROL CENTRE - CLEAN REDESIGN === */

        .app-content {
            background-color: var(--vericase-cream);
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 24px 24px;
            border: none;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
            padding: 48px;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* === WATERMARKS - Professional touch === */
        .watermark {
            position: absolute;
            font-size: 280px;
            color: var(--vericase-navy);
            opacity: 0.025;
            pointer-events: none;
            z-index: 0;
        }

        .watermark-scales {
            right: -40px;
            top: 80px;
            transform: rotate(-12deg);
        }

        .watermark-gavel {
            left: -60px;
            bottom: -20px;
            transform: rotate(15deg);
        }

        /* === HEADER === */
        .cc-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 48px;
            position: relative;
            z-index: 1;
        }

        .cc-title {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0;
        }

        .cc-header-actions {
            display: flex;
            gap: 12px;
        }

        /* === EMPTY STATE === */
        .cc-empty-state {
            text-align: center;
            padding: 80px 40px;
            max-width: 480px;
            margin: 60px auto;
            position: relative;
            z-index: 1;
        }

        .cc-empty-visual {
            width: 120px;
            height: 120px;
            margin: 0 auto 32px;
            background: white;
            border: 1px solid var(--border-default);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.05);
        }

        .cc-empty-visual i {
            font-size: 3rem;
            color: var(--vericase-gold);
            opacity: 0.6;
        }

        .cc-empty-state h2 {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0 0 12px;
        }

        .cc-empty-state p {
            color: var(--text-muted);
            font-size: 0.9375rem;
            line-height: 1.6;
            margin: 0 0 32px;
        }

        .cc-empty-state .btn-vericase {
            padding: 14px 28px;
            font-size: 1rem;
        }

        .cc-empty-guide {
            margin-top: 24px;
        }

        .cc-empty-guide .btn-ghost {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .cc-empty-guide .btn-ghost:hover {
            color: var(--vericase-navy);
        }

        /* === SECTION HEADERS === */
        .cc-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .cc-section-header h2 {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin: 0;
        }

        /* === WORKSPACE GRID === */
        .cc-workspaces {
            margin-bottom: 48px;
            position: relative;
            z-index: 1;
        }

        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .workspace-card {
            background: white;
            border: 1px solid var(--border-default);
            border-top: 4px solid var(--vericase-gold);
            border-radius: 6px;
            padding: 24px;
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: block;
        }

        .workspace-card:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px rgba(15, 23, 42, 0.08);
            border-color: var(--vericase-navy);
            border-top-color: var(--vericase-gold);
        }

        .workspace-card-name {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0 0 4px;
        }

        .workspace-card-code {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            margin-bottom: 16px;
        }

        .workspace-card-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .workspace-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .workspace-stat-value {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--vericase-navy);
        }

        .workspace-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .workspace-card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 16px;
            border-top: 1px solid var(--border-default);
        }

        .workspace-status {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(197, 160, 101, 0.15);
            color: var(--vericase-gold);
        }

        .workspace-status.dormant {
            background: var(--gray-100);
            color: var(--text-muted);
        }

        .workspace-date {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* === DEADLINES === */
        .cc-deadlines {
            margin-bottom: 48px;
            position: relative;
            z-index: 1;
        }

        .deadlines-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .deadline-item {
            background: white;
            border: 1px solid var(--border-default);
            border-left: 4px solid var(--vericase-gold);
            border-radius: 6px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 2px 2px 0px rgba(15, 23, 42, 0.03);
        }

        .deadline-item.urgent {
            border-left-color: #DC2626;
        }

        .deadline-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .deadline-title {
            font-weight: 600;
            color: var(--vericase-navy);
            font-size: 0.9375rem;
        }

        .deadline-date {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .deadline-source {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 10px;
            border-radius: 4px;
            background: var(--gray-100);
            color: var(--text-muted);
        }

        .cc-no-deadlines {
            text-align: center;
            padding: 32px;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* === GUIDE OVERLAY === */
        .guide-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .guide-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .guide-shell {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.2);
            overflow: hidden;
        }

        .guide-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .guide-header h3 {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0;
        }

        .guide-progress {
            display: flex;
            gap: 6px;
        }

        .guide-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-200);
        }

        .guide-dot.active {
            background: var(--vericase-gold);
        }

        .guide-body {
            padding: 32px 24px;
        }

        .guide-step-title {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin-bottom: 12px;
        }

        .guide-step-desc {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .guide-step-tip {
            font-size: 0.875rem;
            color: var(--vericase-gold);
            font-style: italic;
        }

        .guide-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gray-50);
        }

        .guide-step-count {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .guide-footer-actions {
            display: flex;
            gap: 8px;
        }

        /* === UTILITIES === */
        .hidden {
            display: none !important;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .app-content {
                padding: 24px;
            }

            .cc-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .workspace-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <main id="main-content">
        <!-- Watermarks - Professional legal aesthetic -->
        <i class="fas fa-balance-scale watermark watermark-scales"></i>
        <i class="fas fa-gavel watermark watermark-gavel"></i>

        <!-- Header -->
        <header class="cc-header">
            <h1 class="cc-title" id="greetingTitle">Control Centre</h1>
            <div class="cc-header-actions">
                <button class="btn btn-vericase" id="createWorkspaceBtn" data-action="open-setup">
                    <i class="fas fa-plus"></i> New Workspace
                </button>
            </div>
        </header>

        <!-- Empty State (shown when no workspaces) -->
        <section class="cc-empty-state hidden" id="emptyState">
            <div class="cc-empty-visual">
                <i class="fas fa-folder-open"></i>
            </div>
            <h2>Create your first workspace</h2>
            <p>Workspaces organize your projects, cases, evidence and team collaboration. Start by creating one.</p>
            <button class="btn btn-vericase" data-action="open-setup">
                <i class="fas fa-plus"></i> Create Workspace
            </button>
            <div class="cc-empty-guide">
                <button class="btn btn-ghost" id="startGuideBtn">
                    <i class="fas fa-compass"></i> Need help? Start the guide
                </button>
            </div>
        </section>

        <!-- Workspaces (shown when has workspaces) -->
        <section class="cc-workspaces hidden" id="workspacesSection">
            <div class="cc-section-header">
                <h2>Your Workspaces</h2>
            </div>
            <div class="workspace-grid" id="workspaceGrid">
                <!-- Rendered via JS -->
            </div>
        </section>

        <!-- Deadlines -->
        <section class="cc-deadlines hidden" id="deadlinesSection">
            <div class="cc-section-header">
                <h2>Upcoming Deadlines</h2>
            </div>
            <div class="deadlines-list" id="deadlinesList">
                <!-- Rendered via JS -->
            </div>
        </section>
    </main>

    <!-- Guide Overlay -->
    <div class="guide-overlay" id="guideOverlay" aria-hidden="true">
        <div class="guide-shell" role="dialog" aria-modal="true">
            <div class="guide-header">
                <h3>Quick Start Guide</h3>
                <div class="guide-progress" id="guideProgress"></div>
                <button class="btn btn-ghost btn-sm" id="guideCloseBtn" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="guide-body">
                <div class="guide-step-title" id="guideStepTitle"></div>
                <div class="guide-step-desc" id="guideStepDesc"></div>
                <div class="guide-step-tip" id="guideStepTip"></div>
            </div>
            <div class="guide-footer">
                <div class="guide-step-count" id="guideStepCount"></div>
                <div class="guide-footer-actions">
                    <button class="btn btn-ghost btn-sm" id="guidePrevBtn">Back</button>
                    <button class="btn btn-outline btn-sm" id="guideNextBtn">Next</button>
                    <button class="btn btn-vericase btn-sm" id="guideCtaBtn">Open</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let workspacesData = [];
        let currentUserRole = "VIEWER";
        let permissions = {
            can_create_project: false,
            can_create_case: false,
            can_manage_users: false,
            can_access_admin: false,
        };
        let guideIndex = 0;

        const guideSteps = [
            {
                title: "Create your workspace",
                description: "Workspaces hold everything for an engagement: projects, cases, users, deliverables and collaboration.",
                tip: "Use a short, recognisable name (often the project name).",
                ctaLabel: "Create workspace",
                ctaAction: "open-setup",
            },
            {
                title: "Start with a project",
                description: "Projects are early-stage: capture contract context and begin evidence finding. You can create case(s) later.",
                tip: "If you're already in dispute, you can go straight to a case.",
                ctaLabel: "Project setup",
                ctaAction: "setup-project",
            },
            {
                title: "Create case(s) when defined",
                description: "Cases are the refined dispute record. Link to a project where relevant and track issues as they develop.",
                tip: "A workspace can contain multiple cases from a single project.",
                ctaLabel: "Case setup",
                ctaAction: "setup-case",
            },
            {
                title: "Invite your team",
                description: "Admins assign power users. Power users can invite team members and allocate them to projects and cases.",
                tip: "Use Collaboration Hub to coordinate work and deadlines.",
                ctaLabel: "Manage users",
                ctaAction: "open-users",
                requiresPower: true,
            },
        ];

        document.addEventListener("DOMContentLoaded", () => {
            if (window.VericaseShell && window.VericaseShell.inject) {
                VericaseShell.inject({
                    title: "Control Centre",
                    breadcrumbs: null,
                    headerActions: ""
                });
            }
            setupControlCentre();
            loadData();
        });

        function setupControlCentre() {
            const storedUser = getStoredUser();
            currentUserRole = normalizeRole(storedUser.role || currentUserRole);
            permissions = derivePermissionsFromRole(currentUserRole);
            bindActionHandlers();
            setupGuideOverlay();
        }

        function getStoredUser() {
            try {
                return JSON.parse(localStorage.getItem("user") || "{}");
            } catch {
                return {};
            }
        }

        function normalizeRole(role) {
            const normalized = String(role || "VIEWER").trim().toUpperCase();
            return normalized || "VIEWER";
        }

        function derivePermissionsFromRole(role) {
            const admin = role === "ADMIN";
            const power = admin || role === "EDITOR";
            return {
                can_create_project: power,
                can_create_case: power,
                can_manage_users: admin,
                can_access_admin: admin,
            };
        }

        function bindActionHandlers() {
            document.querySelectorAll("[data-action]").forEach((el) => {
                el.addEventListener("click", (e) => {
                    e.preventDefault();
                    handleAction(el.dataset.action);
                });
            });

            const startGuideBtn = document.getElementById("startGuideBtn");
            if (startGuideBtn) {
                startGuideBtn.addEventListener("click", () => openGuide(0));
            }
        }

        function handleAction(action) {
            switch (action) {
                case "open-setup":
                    window.location.href = "workspace-setup.html";
                    break;
                case "setup-project":
                    const wsId = localStorage.getItem("currentWorkspaceId");
                    if (!wsId) {
                        window.location.href = "master-dashboard.html";
                        return;
                    }
                    window.location.href = `project-setup.html?workspaceId=${encodeURIComponent(wsId)}`;
                    break;
                case "setup-case":
                    const wsId2 = localStorage.getItem("currentWorkspaceId");
                    if (!wsId2) {
                        window.location.href = "master-dashboard.html";
                        return;
                    }
                    window.location.href = `case-setup.html?workspaceId=${encodeURIComponent(wsId2)}`;
                    break;
                case "open-users":
                    window.location.href = "admin-users.html";
                    break;
                case "open-master-dashboard":
                    window.location.href = "master-dashboard.html";
                    break;
            }
        }

        async function loadData() {
            try {
                const [overviewResponse, workspacesResponse] = await Promise.all([
                    fetch("/api/dashboard/overview", { headers: getAuthHeaders() }),
                    fetch("/api/workspaces", { headers: getAuthHeaders() })
                ]);

                if (overviewResponse.ok) {
                    const data = await overviewResponse.json();
                    dashboardData = data;

                    if (data.user?.role) {
                        currentUserRole = normalizeRole(data.user.role);
                        permissions = data.permissions || derivePermissionsFromRole(currentUserRole);
                    }

                    if (data.user?.display_name) {
                        document.getElementById("greetingTitle").textContent = `Welcome back, ${data.user.display_name}`;
                    }

                    renderDeadlines(data.upcoming_deadlines || data.deadlines || []);
                }

                if (workspacesResponse.ok) {
                    workspacesData = await workspacesResponse.json();
                    renderWorkspaces(workspacesData);
                }

                updateUIState();
            } catch (e) {
                console.error("Failed to load control centre data", e);
                updateUIState();
            }
        }

        function updateUIState() {
            const hasWorkspaces = workspacesData && workspacesData.length > 0;
            const emptyState = document.getElementById("emptyState");
            const workspacesSection = document.getElementById("workspacesSection");

            if (hasWorkspaces) {
                emptyState?.classList.add("hidden");
                workspacesSection?.classList.remove("hidden");
            } else {
                emptyState?.classList.remove("hidden");
                workspacesSection?.classList.add("hidden");
            }

            // Update create button state based on permissions
            const createBtn = document.getElementById("createWorkspaceBtn");
            if (createBtn) {
                const canCreate = permissions.can_create_project || permissions.can_create_case;
                createBtn.disabled = !canCreate;
                createBtn.title = canCreate ? "" : "Ask your admin to grant create access.";
            }
        }

        function renderWorkspaces(workspaces) {
            const grid = document.getElementById("workspaceGrid");
            if (!grid) return;

            if (!workspaces || workspaces.length === 0) {
                grid.innerHTML = "";
                return;
            }

            grid.innerHTML = workspaces.map(ws => {
                const name = escapeHtml(ws.name || "Unnamed Workspace");
                const code = ws.code ? escapeHtml(ws.code) : "";
                const projectCount = ws.project_count || 0;
                const caseCount = ws.case_count || 0;
                const emailCount = ws.email_count || 0;
                const isActive = (ws.updated_at && daysSince(ws.updated_at) < 30) || emailCount > 0;
                const statusClass = isActive ? "" : "dormant";
                const statusLabel = isActive ? "Active" : "Dormant";
                const dateLabel = ws.updated_at ? formatRelativeDate(ws.updated_at) : "";

                return `
                    <a href="master-dashboard.html?workspaceId=${encodeURIComponent(ws.id)}" class="workspace-card" data-workspace-id="${ws.id}">
                        <h3 class="workspace-card-name">${name}</h3>
                        ${code ? `<div class="workspace-card-code">${code}</div>` : '<div class="workspace-card-code">&nbsp;</div>'}
                        <div class="workspace-card-stats">
                            <div class="workspace-stat">
                                <span class="workspace-stat-value">${formatCount(projectCount)}</span>
                                <span class="workspace-stat-label">Projects</span>
                            </div>
                            <div class="workspace-stat">
                                <span class="workspace-stat-value">${formatCount(caseCount)}</span>
                                <span class="workspace-stat-label">Cases</span>
                            </div>
                            <div class="workspace-stat">
                                <span class="workspace-stat-value">${formatCount(emailCount)}</span>
                                <span class="workspace-stat-label">Emails</span>
                            </div>
                        </div>
                        <div class="workspace-card-meta">
                            <span class="workspace-status ${statusClass}">${statusLabel}</span>
                            ${dateLabel ? `<span class="workspace-date">${dateLabel}</span>` : ""}
                        </div>
                    </a>
                `;
            }).join("");
        }

        function renderDeadlines(items) {
            const section = document.getElementById("deadlinesSection");
            const list = document.getElementById("deadlinesList");
            if (!section || !list) return;

            if (!Array.isArray(items) || items.length === 0) {
                section.classList.add("hidden");
                return;
            }

            section.classList.remove("hidden");
            list.innerHTML = items.map(d => {
                const title = escapeHtml(d.title || d.event || "Deadline");
                const dateText = formatDate(d.date || d.deadline_date || d.due_date);
                const source = d.source_name || d.case_name || d.project_name || "";
                const isUrgent = d.days_remaining !== undefined && d.days_remaining <= 2;

                return `
                    <div class="deadline-item ${isUrgent ? 'urgent' : ''}">
                        <div class="deadline-info">
                            <span class="deadline-title">${title}</span>
                            <span class="deadline-date">${dateText}</span>
                        </div>
                        ${source ? `<span class="deadline-source">${escapeHtml(source)}</span>` : ""}
                    </div>
                `;
            }).join("");
        }

        function formatDate(value) {
            if (!value) return "Date TBD";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return "Date TBD";
            return date.toLocaleDateString();
        }

        function formatRelativeDate(value) {
            if (!value) return "";
            const days = daysSince(value);
            if (days === 0) return "Today";
            if (days === 1) return "Yesterday";
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
            return new Date(value).toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
        }

        function daysSince(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function formatCount(value) {
            if (typeof value === "number") {
                return value.toLocaleString();
            }
            return String(value || "0");
        }

        function getAuthHeaders() {
            const token = localStorage.getItem("vericase_token") ||
                          localStorage.getItem("token") ||
                          localStorage.getItem("jwt");
            return token ? { Authorization: `Bearer ${token}` } : {};
        }

        function escapeHtml(str) {
            if (!str) return "";
            const div = document.createElement("div");
            div.textContent = String(str);
            return div.innerHTML;
        }

        // Guide Overlay
        function setupGuideOverlay() {
            const overlay = document.getElementById("guideOverlay");
            const closeBtn = document.getElementById("guideCloseBtn");
            const prevBtn = document.getElementById("guidePrevBtn");
            const nextBtn = document.getElementById("guideNextBtn");
            const ctaBtn = document.getElementById("guideCtaBtn");

            if (closeBtn) closeBtn.addEventListener("click", closeGuide);
            if (prevBtn) prevBtn.addEventListener("click", () => changeGuideStep(-1));
            if (nextBtn) nextBtn.addEventListener("click", () => changeGuideStep(1));
            if (ctaBtn) ctaBtn.addEventListener("click", handleGuideCta);

            if (overlay) {
                overlay.addEventListener("click", (e) => {
                    if (e.target === overlay) closeGuide();
                });
            }
        }

        function openGuide(startIndex = 0) {
            guideIndex = Math.max(0, Math.min(startIndex, guideSteps.length - 1));
            renderGuide();
            const overlay = document.getElementById("guideOverlay");
            if (overlay) {
                overlay.classList.add("active");
                overlay.setAttribute("aria-hidden", "false");
            }
        }

        function closeGuide() {
            const overlay = document.getElementById("guideOverlay");
            if (overlay) {
                overlay.classList.remove("active");
                overlay.setAttribute("aria-hidden", "true");
            }
        }

        function changeGuideStep(delta) {
            const next = guideIndex + delta;
            if (next < 0) {
                guideIndex = 0;
            } else if (next >= guideSteps.length) {
                closeGuide();
                return;
            } else {
                guideIndex = next;
            }
            renderGuide();
        }

        function renderGuide() {
            const step = guideSteps[guideIndex];
            if (!step) return;

            const progress = document.getElementById("guideProgress");
            if (progress) {
                progress.innerHTML = guideSteps.map((_, idx) =>
                    `<div class="guide-dot ${idx === guideIndex ? 'active' : ''}"></div>`
                ).join("");
            }

            const titleEl = document.getElementById("guideStepTitle");
            const descEl = document.getElementById("guideStepDesc");
            const tipEl = document.getElementById("guideStepTip");
            if (titleEl) titleEl.textContent = step.title;
            if (descEl) descEl.textContent = step.description;
            if (tipEl) tipEl.textContent = step.tip;

            const countEl = document.getElementById("guideStepCount");
            if (countEl) countEl.textContent = `Step ${guideIndex + 1} of ${guideSteps.length}`;

            const prevBtn = document.getElementById("guidePrevBtn");
            if (prevBtn) prevBtn.disabled = guideIndex === 0;

            const nextBtn = document.getElementById("guideNextBtn");
            if (nextBtn) nextBtn.textContent = guideIndex === guideSteps.length - 1 ? "Finish" : "Next";

            const ctaBtn = document.getElementById("guideCtaBtn");
            if (ctaBtn) {
                const isPower = currentUserRole === "ADMIN" || currentUserRole === "EDITOR";
                if (step.requiresPower && !isPower) {
                    ctaBtn.style.display = "none";
                } else {
                    ctaBtn.style.display = "inline-flex";
                    ctaBtn.textContent = step.ctaLabel;
                    ctaBtn.dataset.action = step.ctaAction;
                }
            }
        }

        function handleGuideCta(e) {
            const action = e?.currentTarget?.dataset?.action;
            if (action) handleAction(action);
        }
    </script>
</body>

</html>

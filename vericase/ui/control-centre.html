<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeriCase - Control Centre</title>
    <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="brand-styles.css?v=7" />
    <link rel="stylesheet" href="design-system.css?v=7" />
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>
    <style>
        /* === CONTROL CENTRE - COCKPIT LAYOUT === */
        /* Double-panel "War Room" design with intelligence sidebar */

        .app-content {
            background-color: var(--vericase-cream);
            /* Subtle dot texture - premium paper feel */
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 24px 24px;
            border: none;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }

        /* === COCKPIT TWO-PANEL LAYOUT === */
        .cockpit-stage {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .cockpit-main {
            flex: 1;
            padding: 48px 60px;
            overflow-y: auto;
            border-right: 1px solid var(--border-default);
            max-width: calc(100% - 380px);
        }

        /* === INTELLIGENCE PANEL (Right Sidebar) === */
        .cockpit-intel {
            width: 380px;
            min-width: 380px;
            background: var(--vericase-navy);
            color: white;
            display: flex;
            flex-direction: column;
            border-left: 4px solid var(--vericase-gold);
            box-shadow: -20px 0 40px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .intel-header {
            padding: 40px 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .intel-header-title {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin: 0 0 8px;
        }

        .intel-header-subtitle {
            font-size: 0.8125rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .intel-header-subtitle strong {
            color: var(--vericase-gold);
        }

        .intel-body {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .intel-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .intel-card-title {
            color: var(--vericase-gold);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .intel-card-heading {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .intel-card-text {
            font-size: 0.8125rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.7);
        }

        .intel-card-text strong {
            color: white;
        }

        .btn-gold {
            background: var(--vericase-gold);
            color: var(--vericase-navy);
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8125rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .btn-gold:hover {
            background: var(--vericase-gold-light);
            transform: translateY(-1px);
        }

        /* Responsive: hide intel panel on smaller screens */
        @media (max-width: 1200px) {
            .cockpit-intel {
                display: none;
            }
            .cockpit-main {
                max-width: 100%;
                border-right: none;
            }
        }

        /* === HEADER === */
        .dashboard-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .dashboard-greeting {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .greeting-kicker {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--vericase-gold-muted);
        }

        .greeting-title {
            font-family: var(--font-serif);
            font-size: 2rem;
            font-weight: 600;
            color: var(--vericase-navy);
            line-height: 1.2;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        /* === KPI RIBBON (Connected Stats Band) === */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background: white;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            margin-bottom: 32px;
            overflow: hidden;
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.05);
        }

        .stat-pill {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            padding: 20px 24px;
            background: white;
            border-right: 1px solid var(--border-default);
            border-radius: 0;
            border: none;
            border-right: 1px solid var(--border-default);
            box-shadow: none;
            transition: all 0.2s;
        }

        .stat-pill:last-child {
            border-right: none;
        }

        /* Top accent borders */
        .stat-pill.projects { border-top: 3px solid var(--vericase-navy); }
        .stat-pill.cases { border-top: 3px solid var(--vericase-gold); }
        .stat-pill.emails { border-top: 3px solid var(--vericase-teal); }
        .stat-pill.evidence { border-top: 3px solid #78716C; }

        .stat-pill i {
            display: none;
        }

        .stat-pill strong {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--vericase-navy);
        }

        .stat-pill-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
        }

        /* === SEARCH BAR === */
        .search-section {
            margin-bottom: 32px;
        }

        .search-wrapper {
            position: relative;
            max-width: 720px;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-xl);
            font-size: 0.9375rem;
            background: white;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--vericase-teal);
            box-shadow: 0 0 0 3px rgba(31, 111, 120, 0.1), var(--shadow-md);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        .search-hint {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-hint-text {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .search-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(181, 155, 106, 0.25);
            border-radius: var(--radius-md); /* Professional 6px */
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .search-chip:hover {
            background: white;
            border-color: var(--vericase-teal);
            color: var(--vericase-teal-dark);
        }

        .search-chip i {
            color: var(--vericase-teal);
            font-size: 0.625rem;
        }

        /* === MAIN CONTENT LAYOUT === */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 1100px) {
            .dashboard-layout {
                gap: 20px;
            }
        }

        /* === WORKSPACES SECTION === */
        .workspaces-section {
            min-width: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: var(--font-sans);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, var(--vericase-teal), var(--vericase-navy));
            border-radius: 2px;
        }

        .section-count {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: var(--radius-md); /* Professional 6px */
        }

        /* === WORKSPACE GRID === */
        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .workspace-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .workspace-card:hover {
            border-color: var(--vericase-teal);
            box-shadow: 0 8px 24px rgba(15, 23, 32, 0.1);
            transform: translateY(-2px);
        }

        .workspace-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        .workspace-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .workspace-icon.project {
            background: rgba(47, 134, 200, 0.1);
            color: var(--vericase-blue);
        }

        .workspace-icon.case {
            background: rgba(181, 155, 106, 0.15);
            color: var(--vericase-gold);
        }

        .workspace-meta {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workspace-status {
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 8px;
            border-radius: var(--radius-md); /* Professional 6px */
            background: rgba(5, 150, 105, 0.1);
            color: var(--success);
        }

        .workspace-menu-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            opacity: 0;
        }

        .workspace-card:hover .workspace-menu-btn {
            opacity: 1;
        }

        .workspace-menu-btn:hover {
            background: var(--gray-100);
            color: var(--text-primary);
        }

        .workspace-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            line-height: 1.3;
        }

        .workspace-code {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .workspace-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 14px;
        }

        .workspace-stats {
            display: flex;
            gap: 14px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
        }

        .workspace-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .workspace-stat i {
            color: var(--vericase-teal);
            font-size: 0.6875rem;
        }

        .workspace-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .case-count-badge {
            font-size: 0.5625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 2px 6px;
            border-radius: var(--radius-md); /* Professional 6px */
            background: rgba(var(--vericase-teal-rgb), 0.12);
            color: var(--vericase-teal);
            border: 1px solid rgba(var(--vericase-teal-rgb), 0.2);
        }

        .case-stems {
            margin-left: 16px;
            padding-left: 16px;
            border-left: 2px dashed rgba(var(--vericase-teal-rgb), 0.25);
            display: grid;
            gap: 10px;
        }

        .case-stem {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .case-stem::before {
            content: "";
            position: absolute;
            left: -16px;
            top: 50%;
            width: 12px;
            height: 2px;
            background: rgba(var(--vericase-teal-rgb), 0.35);
        }

        .case-card {
            flex: 1;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
        }

        .case-card:hover {
            border-color: var(--vericase-teal);
            box-shadow: 0 6px 16px rgba(15, 23, 32, 0.08);
            transform: translateY(-1px);
        }

        .case-card-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .case-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .case-code {
            font-family: var(--font-mono);
            font-size: 0.6875rem;
            color: var(--text-muted);
        }

        .case-project-tag {
            font-size: 0.6875rem;
            color: var(--text-muted);
        }

        .case-meta {
            margin-left: auto;
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .case-meta i {
            color: var(--vericase-teal);
            font-size: 0.7rem;
        }

        .case-menu-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            opacity: 0;
        }

        .case-stem:hover .case-menu-btn {
            opacity: 1;
        }

        .case-menu-btn:hover {
            background: var(--gray-100);
            color: var(--text-primary);
        }

        .case-orphans {
            grid-column: 1 / -1;
            padding: 16px;
            border-radius: var(--radius-lg);
            border: 1px dashed rgba(181, 155, 106, 0.35);
            background: rgba(255, 255, 255, 0.7);
        }

        .case-orphans-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--vericase-gold-muted);
            margin: 0 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .case-orphans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
        }

        .case-orphans .case-stem::before {
            display: none;
        }

        /* === EMPTY STATE === */
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 48px 24px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-xl);
            border: 1px dashed rgba(181, 155, 106, 0.3);
        }

        .empty-icon {
            font-size: 2.5rem;
            color: var(--gray-300);
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .empty-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* === SIDEBAR === */
        .dashboard-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* === QUICK START CARD === */
        .quick-start-card {
            background: white;
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-default);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .quick-start-header {
            padding: 16px 20px;
            background: linear-gradient(
                135deg,
                rgba(var(--vericase-sage-mist-rgb), 0.9) 0%,
                rgba(255, 255, 255, 0) 100%
            );
            border-bottom: 1px solid var(--border-default);
        }

        .quick-start-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-start-title i {
            color: var(--vericase-teal);
        }

        .quick-start-actions {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .quick-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s;
            border: none;
            background: transparent;
            cursor: pointer;
            text-align: left;
            width: 100%;
        }

        .quick-action:hover {
            background: var(--gray-50);
        }

        .quick-action-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            background: rgba(31, 111, 120, 0.08);
            color: var(--vericase-teal);
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .quick-action:hover .quick-action-icon {
            background: var(--vericase-teal);
            color: white;
        }

        .quick-action-text {
            flex: 1;
            min-width: 0;
        }

        .quick-action-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .quick-action-desc {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .quick-action.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-action.locked:hover {
            background: transparent;
        }

        .quick-action.locked:hover .quick-action-icon {
            background: rgba(31, 111, 120, 0.08);
            color: var(--vericase-teal);
        }

        .quick-action-badge {
            font-size: 0.5625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--vericase-gold-muted);
            background: rgba(181, 155, 106, 0.15);
            padding: 2px 6px;
            border-radius: var(--radius-md); /* Professional 6px */
        }

        /* === CONTEXT INDICATOR === */
        .context-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(31, 111, 120, 0.06);
            border: 1px solid rgba(31, 111, 120, 0.15);
            border-radius: var(--radius-md);
            margin: 12px 12px 0;
        }

        .context-indicator.no-context {
            background: var(--gray-50);
            border-color: var(--gray-200);
        }

        .context-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--vericase-teal);
            flex-shrink: 0;
        }

        .context-indicator.no-context .context-dot {
            background: var(--gray-400);
        }

        .context-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .context-text strong {
            font-weight: 600;
            color: var(--vericase-teal-dark);
        }

        .context-indicator.no-context .context-text strong {
            color: var(--text-muted);
        }

        .context-indicator.cc-context-standalone {
            margin: 16px 0 0;
        }

        /* === COLLAPSIBLE (DETAILS) === */
        .cc-collapsible-summary {
            cursor: pointer;
            list-style: none;
        }

        .cc-collapsible-summary::-webkit-details-marker {
            display: none;
        }

        .cc-collapsible-meta {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .cc-collapsible-chevron {
            transition: transform 0.2s ease;
        }

        details[open] .cc-collapsible-chevron {
            transform: rotate(180deg);
        }

        .cc-assistant-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        /* === AI ASSISTANT CARD === */
        .ai-card {
            background: white;
            border-radius: var(--radius-xl);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .ai-card-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(31, 111, 120, 0.05) 0%, rgba(26, 43, 60, 0.03) 100%);
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .ai-card-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-card-title i {
            color: var(--vericase-teal);
        }

        .ai-toggle-btn {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--vericase-teal);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .ai-toggle-btn:hover {
            background: rgba(31, 111, 120, 0.08);
        }

        .ai-card-body {
            padding: 16px;
        }

        .ai-prompt-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.8125rem;
            resize: none;
            font-family: inherit;
            transition: all 0.15s;
        }

        .ai-prompt-input:focus {
            outline: none;
            border-color: var(--vericase-teal);
            box-shadow: 0 0 0 3px rgba(31, 111, 120, 0.08);
        }

        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .ai-suggestion {
            font-size: 0.6875rem;
            padding: 5px 10px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md); /* Professional 6px */
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .ai-suggestion:hover {
            background: white;
            border-color: var(--vericase-teal);
            color: var(--vericase-teal-dark);
        }

        .ai-disclaimer {
            margin-top: 10px;
            font-size: 0.6875rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* === AI CHAT PANEL (EXPANDED) === */
        .ai-chat-panel {
            display: none;
        }

        .ai-chat-panel.active {
            display: block;
        }

        .ai-chat-messages {
            max-height: 250px;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        .ai-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
            background: rgba(31, 111, 120, 0.1);
            color: var(--vericase-teal);
        }

        .ai-message.user .ai-avatar {
            background: rgba(26, 43, 60, 0.1);
            color: var(--vericase-navy);
        }

        .ai-bubble {
            background: var(--gray-100);
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.8125rem;
            line-height: 1.5;
            max-width: 85%;
        }

        .ai-message.user .ai-bubble {
            background: var(--vericase-teal);
            color: white;
        }

        .ai-input-row {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .ai-input-row input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.8125rem;
        }

        .ai-input-row input:focus {
            outline: none;
            border-color: var(--vericase-teal);
        }

        .ai-send-btn {
            padding: 10px 14px;
        }

        /* === BINDER CARD (Section Card) === */
        .predictive-card {
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-default);
            overflow: hidden;
            /* Hard Shadow = Physical File */
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.05);
        }

        .predictive-card-header {
            padding: 16px 20px;
            background: #F8FAFC;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .predictive-card-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .predictive-card-title i {
            color: var(--vericase-gold);
            font-size: 14px;
        }

        .predictive-refresh {
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .predictive-refresh:hover {
            background: rgba(181, 155, 106, 0.12);
            color: var(--vericase-gold);
        }

        .predictive-card-body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Deadlines List Styles */
        .deadlines-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .deadline-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            background: var(--gray-50);
        }

        .deadline-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .deadline-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .deadline-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Onboarding Steps */
        .onboarding-steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 10px;
            padding: 10px;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(var(--vericase-teal-rgb), 0.1);
            color: var(--vericase-teal);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .step-content h3 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .step-content p {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* === HERO ACTION CARD (Letterhead Style) === */
        .welcome-card {
            position: relative;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-default);
            /* Gold Top Border = Letterhead */
            border-top: 4px solid var(--vericase-gold);
            padding: 32px;
            overflow: hidden;
            /* Hard Shadow = Physical File */
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.05);
        }

        .welcome-card::before {
            content: "\f0b1"; /* briefcase watermark */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: -20px;
            bottom: -40px;
            font-size: 180px;
            color: var(--vericase-navy);
            opacity: 0.03;
            transform: rotate(-10deg);
            pointer-events: none;
        }

        .welcome-grid {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .welcome-copy {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .welcome-title {
            font-family: var(--font-serif);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0;
        }

        .welcome-lede {
            color: var(--text-muted);
            font-size: 0.9375rem;
            line-height: 1.6;
        }

        .welcome-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .welcome-note {
            background: rgba(255, 255, 255, 0.75);
            border-radius: 14px;
            border: 1px solid rgba(181, 155, 106, 0.18);
            padding: 14px 16px;
        }

        .welcome-note-title {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--vericase-gold-muted);
            margin-bottom: 8px;
        }

        .welcome-note-list {
            margin: 0;
            padding-left: 18px;
            color: var(--text-secondary);
            font-size: 0.8125rem;
            display: grid;
            gap: 6px;
        }

        .role-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-md); /* Professional 6px */
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            background: rgba(31, 111, 120, 0.12);
            color: var(--vericase-teal-dark);
            width: fit-content;
        }

        .role-chip.admin {
            background: rgba(15, 23, 32, 0.08);
            color: var(--vericase-navy);
        }

        .role-chip.viewer {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-muted);
        }

        .welcome-panel {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 18px;
            border: 1px solid rgba(15, 23, 32, 0.08);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .welcome-panel-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .welcome-panel-kicker {
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--vericase-gold-muted);
            margin-bottom: 6px;
        }

        .welcome-panel-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .welcome-panel-tag {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 4px 8px;
            border-radius: var(--radius-md); /* Professional 6px */
            background: rgba(31, 111, 120, 0.12);
            color: var(--vericase-teal-dark);
        }

        .guide-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .guide-list-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 14px;
            border: 1px solid var(--gray-100);
            background: white;
        }

        .guide-list-item.active {
            border-color: rgba(31, 111, 120, 0.5);
            box-shadow: 0 10px 20px rgba(15, 23, 32, 0.08);
        }

        .guide-index {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: rgba(31, 111, 120, 0.12);
            color: var(--vericase-teal-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .guide-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .guide-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 6px 0 10px;
        }

        .guide-content button {
            padding-left: 0;
        }

        /* === SETUP OPTIONS === */
        .setup-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
        }

        .setup-tile {
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 16px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
        }

        .setup-tile:hover {
            transform: translateY(-3px);
            border-color: rgba(31, 111, 120, 0.4);
            box-shadow: 0 12px 24px rgba(15, 23, 32, 0.08);
        }

        .setup-tile.locked {
            opacity: 0.6;
            pointer-events: none;
        }

        .setup-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(31, 111, 120, 0.1);
            color: var(--vericase-teal);
        }

        .setup-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .setup-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .setup-meta {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--vericase-gold-muted);
        }

        .setup-badge {
            align-self: flex-start;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 4px 8px;
            border-radius: var(--radius-md); /* Professional 6px */
            background: rgba(15, 23, 32, 0.08);
            color: var(--vericase-navy);
        }

        /* === ROLES === */
        .role-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
        }

        .role-card {
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 16px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 200px;
        }

        .role-card.active {
            border-color: rgba(31, 111, 120, 0.5);
            box-shadow: 0 12px 24px rgba(15, 23, 32, 0.08);
        }

        .role-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .role-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .role-list {
            margin: 0;
            padding-left: 18px;
            color: var(--text-muted);
            font-size: 0.75rem;
            display: grid;
            gap: 6px;
        }

        .role-note {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* === FEATURES === */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
        }

        .grid-two {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .feature-card {
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 16px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .feature-card.locked {
            opacity: 0.6;
            pointer-events: none;
        }

        .feature-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(31, 111, 120, 0.1);
            color: var(--vericase-teal);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .feature-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .feature-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .feature-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .feature-tag {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 4px 8px;
            border-radius: var(--radius-md); /* Professional 6px */
            background: rgba(31, 111, 120, 0.12);
            color: var(--vericase-teal-dark);
        }

        .feature-tag.admin {
            background: rgba(15, 23, 32, 0.08);
            color: var(--vericase-navy);
        }

        /* === GUIDE OVERLAY === */
        .guide-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 32, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            padding: 24px;
        }

        .guide-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .guide-shell {
            width: 100%;
            max-width: 760px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
            transform: translateY(8px);
            transition: transform 0.2s ease;
        }

        .guide-overlay.active .guide-shell {
            transform: translateY(0);
        }

        .guide-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100);
            background: linear-gradient(135deg, rgba(31, 111, 120, 0.08) 0%, rgba(181, 155, 106, 0.08) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .guide-header h3 {
            margin: 0;
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        .guide-progress {
            display: flex;
            gap: 6px;
        }

        .guide-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-200);
        }

        .guide-dot.active {
            background: var(--vericase-teal);
        }

        .guide-body {
            padding: 24px;
            display: grid;
            gap: 12px;
        }

        .guide-step-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .guide-step-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .guide-step-tip {
            background: rgba(31, 111, 120, 0.08);
            border-radius: 12px;
            padding: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .guide-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .guide-footer-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .guide-step-count {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* === MOTION === */
        .reveal {
            animation: riseIn 0.5s ease-out both;
            animation-delay: var(--delay, 0s);
        }

        @keyframes riseIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .reveal {
                animation: none;
            }
        }

        @media (max-width: 980px) {
            .welcome-grid {
                grid-template-columns: 1fr;
            }

            .setup-grid,
            .role-grid,
            .features-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <main id="main-content">
        <div class="cockpit-stage">
            <!-- Main Content Area -->
            <div class="cockpit-main">
                <!-- Dashboard Header -->
                <header class="dashboard-header">
            <div class="dashboard-greeting">
                <div class="greeting-kicker">
                    <i class="fas fa-compass vericase-tick" aria-hidden="true"></i>
                    VeriCase
                </div>
                <h1 class="greeting-title" id="greetingTitle">Control Centre</h1>
            </div>
            <div class="stats-bar" id="statsBar">
                <div class="stat-pill projects">
                    <i class="fas fa-project-diagram" aria-hidden="true"></i>
                    <strong id="statProjects">-</strong> Projects
                </div>
                <div class="stat-pill cases">
                    <i class="fas fa-briefcase" aria-hidden="true"></i>
                    <strong id="statCases">-</strong> Cases
                </div>
                <div class="stat-pill emails">
                    <i class="fas fa-envelope" aria-hidden="true"></i>
                    <strong id="statEmails">-</strong> Emails
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="window.location.href='master-dashboard.html'" style="background: var(--vericase-navy); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-arrow-right" aria-hidden="true"></i> Go to Master Dashboard
                </button>
                <button class="btn btn-secondary" id="createNewBtn" style="background: white; border: 1px solid var(--gray-300); padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-plus" aria-hidden="true"></i> New Workspace
                </button>
            </div>
        </header>

        <div class="context-indicator no-context cc-context-standalone" id="contextIndicator">
            <div class="context-dot"></div>
            <div class="context-text"><strong>No workspace selected</strong></div>
        </div>

        <!-- Main Layout -->
        <div class="dashboard-layout">

            <!-- Widgets / Content (Left Column) -->
            <section class="workspaces-section">

                <!-- Welcome + Interactive Guide -->
                <div class="welcome-card reveal" id="welcomeCard" style="margin-bottom: 24px; --delay: 0.05s;">
                    <div class="welcome-grid">
                        <div class="welcome-copy">
                            <div class="role-chip" id="roleChip">Team Member</div>
                            <h2 class="welcome-title">Welcome to the Control Centre</h2>
                            <p class="welcome-lede">
                                The Control Centre is the starting point for managing workspaces, projects, cases and teams.
                                Create a workspace (often the project name), start with a project for early-stage investigation, then add case(s) as needed.
                            </p>
                            <div class="welcome-actions">
                                <button class="btn btn-vericase btn-sm" id="startGuideBtn" type="button">
                                    <i class="fas fa-compass" aria-hidden="true"></i> Quick start guide
                                </button>
                                <button class="btn btn-outline btn-sm" id="openSetupBtn" type="button" data-requires-create="workspace"
                                    data-lock-reason="You do not have permission to create workspaces.">
                                    <i class="fas fa-layer-group" aria-hidden="true"></i> Create workspace
                                </button>
                            </div>
                            <div class="welcome-note">
                                <div class="welcome-note-title">How work is organised</div>
                                <ul class="welcome-note-list">
                                    <li>Workspaces hold projects, cases, users, deliverables and collaboration.</li>
                                    <li>Projects are exploratory; cases are the refined dispute record. A workspace can contain multiple cases.</li>
                                    <li>Admins assign power users. Power users can invite team members and allocate access.</li>
                                    <li>Use the assistant for setup and feature navigation only.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Setup Options -->
                <div class="predictive-card reveal" id="setupOptions" style="margin-bottom: 24px; --delay: 0.1s;">
                    <div class="predictive-card-header">
                        <div class="predictive-card-title">
                            <i class="fas fa-magnifying-glass" aria-hidden="true"></i>
                            Setup Options
                        </div>
                    </div>
                    <div class="predictive-card-body">
                        <div class="setup-grid">
                            <div class="setup-tile" data-requires-create="workspace" data-lock-reason="You do not have permission to create workspaces.">
                                <div class="setup-icon"><i class="fas fa-building" aria-hidden="true"></i></div>
                                <div class="setup-title">Create a Workspace</div>
                                <div class="setup-desc">Workspaces hold everything for an engagement: projects, cases, users, deliverables and collaboration.</div>
                                <div class="setup-meta">Recommended first step</div>
                                <button class="btn btn-vericase btn-sm" type="button" data-action="open-setup"
                                    data-requires-create="workspace" data-lock-reason="You do not have permission to create workspaces.">
                                    Create workspace
                                </button>
                            </div>
                            <div class="setup-tile" data-requires-create="project" data-lock-reason="You do not have permission to create projects.">
                                <div class="setup-icon"><i class="fas fa-project-diagram" aria-hidden="true"></i></div>
                                <div class="setup-title">Set up a Project</div>
                                <div class="setup-desc">Use projects for early-stage investigation: capture contract context and begin evidence finding.</div>
                                <div class="setup-meta">Exploratory (early stage)</div>
                                <button class="btn btn-vericase btn-sm" type="button" data-action="setup-project"
                                    data-requires-create="project" data-lock-reason="You do not have permission to create projects.">
                                    Start project setup
                                </button>
                            </div>
                            <div class="setup-tile" data-requires-create="case" data-lock-reason="You do not have permission to create cases.">
                                <div class="setup-icon"><i class="fas fa-briefcase" aria-hidden="true"></i></div>
                                <div class="setup-title">Set up a Case</div>
                                <div class="setup-desc">Create a case when the dispute is defined. Link to a project where relevant and track issues as they develop.</div>
                                <div class="setup-meta">Dispute stage (refined)</div>
                                <button class="btn btn-vericase btn-sm" type="button" data-action="setup-case"
                                    data-requires-create="case" data-lock-reason="You do not have permission to create cases.">
                                    Start case setup
                                </button>
                            </div>
                            <div class="setup-tile" data-power-lock="true" data-lock-reason="Power users or admins can invite team members.">
                                <span class="setup-badge">Power users</span>
                                <div class="setup-icon"><i class="fas fa-id-badge" aria-hidden="true"></i></div>
                                <div class="setup-title">Build your team</div>
                                <div class="setup-desc">Invite members, assign roles, and allocate them to projects and cases inside the workspace.</div>
                                <div class="setup-meta">Admin and power users only</div>
                                <button class="btn btn-outline btn-sm" type="button" data-action="setup-team"
                                    data-power-lock="true" data-lock-reason="Power users or admins can invite team members.">
                                    Invite team members
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Roles & Access -->
                <details class="predictive-card reveal" id="roleOverview" style="margin-bottom: 24px; --delay: 0.15s;">
                    <summary class="predictive-card-header cc-collapsible-summary">
                        <div class="predictive-card-title">
                            <i class="fas fa-shield" aria-hidden="true"></i>
                            Roles and Access
                        </div>
                        <span class="cc-collapsible-meta">
                            <span>Optional</span>
                            <i class="fas fa-chevron-down cc-collapsible-chevron" aria-hidden="true"></i>
                        </span>
                    </summary>
                    <div class="predictive-card-body">
                        <div class="role-grid">
                            <div class="role-card" data-role="ADMIN">
                                <div class="role-chip admin"><i class="fas fa-crown" aria-hidden="true"></i> Admin</div>
                                <div class="role-title">Administrator</div>
                                <div class="role-desc">Full control of users, settings, and access across all cases and projects.</div>
                                <ul class="role-list">
                                    <li>Assign power users and invite teams.</li>
                                    <li>Manage admin settings and case law tools.</li>
                                    <li>Oversee every workspace.</li>
                                </ul>
                            </div>
                            <div class="role-card" data-role="EDITOR">
                                <div class="role-chip"><i class="fas fa-bolt" aria-hidden="true"></i> Power User</div>
                                <div class="role-title">Power User</div>
                                <div class="role-desc">Creates projects and cases, invites team members, and runs daily operations.</div>
                                <ul class="role-list">
                                    <li>Invite and assign team members.</li>
                                    <li>Own multiple cases and projects.</li>
                                    <li>Access collaboration and analysis tools.</li>
                                </ul>
                            </div>
                            <div class="role-card" data-role="VIEWER">
                                <div class="role-chip viewer"><i class="fas fa-user" aria-hidden="true"></i> Team Member</div>
                                <div class="role-title">Team Member</div>
                                <div class="role-desc">Works inside assigned cases and projects with guided access.</div>
                                <ul class="role-list">
                                    <li>View evidence and participate in collaboration.</li>
                                    <li>Update your profile and add notes.</li>
                                    <li>Request access changes from admin.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="role-note">Power users are assigned by the administrator (admin@veri-case.com).</div>
                    </div>
                </details>

                <!-- Account & Users -->
                <div class="predictive-card reveal" id="accountAccess" style="margin-bottom: 24px; --delay: 0.2s;">
                    <div class="predictive-card-header">
                        <div class="predictive-card-title">
                            <i class="fas fa-user-circle" aria-hidden="true"></i>
                            Account and Users
                        </div>
                    </div>
                    <div class="predictive-card-body">
                        <div class="features-grid grid-two">
                            <div class="feature-card">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-id-badge" aria-hidden="true"></i></div>
                                    <div class="feature-title">Profile</div>
                                </div>
                                <div class="feature-desc">Update your display name, password, and profile details.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag">Personal</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-profile">Open profile</button>
                            </div>
                            <div class="feature-card" data-admin-lock="true" data-lock-reason="Admin only">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-user-shield" aria-hidden="true"></i></div>
                                    <div class="feature-title">Users</div>
                                </div>
                                <div class="feature-desc">Invite new users, set roles, and manage access to workspaces.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag admin">Admin only</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-users" data-admin-lock="true"
                                    data-lock-reason="Admin only">
                                    Manage users
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Features Overview -->
                <details class="predictive-card reveal" id="featuresOverview" style="margin-bottom: 24px; --delay: 0.25s;">
                    <summary class="predictive-card-header cc-collapsible-summary">
                        <div class="predictive-card-title">
                            <i class="fas fa-layer-group" aria-hidden="true"></i>
                            Features Overview
                        </div>
                        <span class="cc-collapsible-meta">
                            <span>Feature map</span>
                            <i class="fas fa-chevron-down cc-collapsible-chevron" aria-hidden="true"></i>
                        </span>
                    </summary>
                    <div class="predictive-card-body">
                        <div class="features-grid">
                            <div class="feature-card">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-columns" aria-hidden="true"></i></div>
                                    <div class="feature-title">Master Dashboard</div>
                                </div>
                                <div class="feature-desc">See every project and case, monitor workloads, and jump into active work.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag">Overview</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-master-dashboard">Open dashboard</button>
                            </div>
                            <div class="feature-card">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-folder-tree" aria-hidden="true"></i></div>
                                    <div class="feature-title">Evidence and Files</div>
                                </div>
                                <div class="feature-desc">Upload, tag, and manage evidence once a workspace is created.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag">Workspace</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-evidence">Open evidence</button>
                            </div>
                            <div class="feature-card">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-envelope-open-text" aria-hidden="true"></i></div>
                                    <div class="feature-title">Correspondence</div>
                                </div>
                                <div class="feature-desc">Review ingested email threads and key communications.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag">Workspace</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-correspondence">Open correspondence</button>
                            </div>
                            <div class="feature-card">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-comments" aria-hidden="true"></i></div>
                                    <div class="feature-title">Collaboration Hub</div>
                                </div>
                                <div class="feature-desc">Coordinate with team members, lanes, and activity in one place.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag">Team</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-collaboration">Open hub</button>
                            </div>
                            <div class="feature-card">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-clock-rotate-left" aria-hidden="true"></i></div>
                                    <div class="feature-title">Timeline and Programme</div>
                                </div>
                                <div class="feature-desc">Build chronology and programme views after selecting a case.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag">Case</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-master-dashboard">Choose a case</button>
                            </div>
                            <div class="feature-card" data-admin-only="true">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-microscope" aria-hidden="true"></i></div>
                                    <div class="feature-title">VeriCase Analysis</div>
                                </div>
                                <div class="feature-desc">Deep research, predictive signals, and advanced analysis tools.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag admin">Admin only</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-analysis" data-admin-only="true">Open analysis</button>
                            </div>
                            <div class="feature-card" data-admin-only="true">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-cog" aria-hidden="true"></i></div>
                                    <div class="feature-title">Settings</div>
                                </div>
                                <div class="feature-desc">Configure system-wide preferences and AI settings.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag admin">Admin only</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-settings" data-admin-only="true">Open settings</button>
                            </div>
                            <div class="feature-card" data-admin-only="true">
                                <div class="feature-header">
                                    <div class="feature-icon"><i class="fas fa-balance-scale" aria-hidden="true"></i></div>
                                    <div class="feature-title">Case Law</div>
                                </div>
                                <div class="feature-desc">Manage case law mining, trends, and tagging outputs.</div>
                                <div class="feature-tags">
                                    <span class="feature-tag admin">Admin only</span>
                                </div>
                                <button class="btn btn-ghost btn-sm" type="button" data-action="open-caselaw" data-admin-only="true">Open case law</button>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Deadlines -->
                <details class="predictive-card" style="margin-bottom: 24px;">
                    <summary class="predictive-card-header cc-collapsible-summary">
                        <div class="predictive-card-title">
                            <i class="fas fa-hourglass-half" aria-hidden="true" style="color: #b45309;"></i>
                            Critical Deadlines
                        </div>
                        <span class="cc-collapsible-meta">
                            <span>Upcoming</span>
                            <i class="fas fa-chevron-down cc-collapsible-chevron" aria-hidden="true"></i>
                        </span>
                    </summary>
                    <div class="predictive-card-body">
                        <div id="deadlines-list" class="deadlines-list">
                            <!-- Populated via JS -->
                            <div style="font-size: 0.8rem; color: var(--text-muted); text-align: center;">Loading
                                deadlines...</div>
                        </div>
                    </div>
                </details>

                <!-- VeriCase Assistant (collapsed to keep the page calmer) -->
                <details class="predictive-card reveal" id="assistantCard" style="margin-bottom: 24px; --delay: 0.3s;">
                    <summary class="predictive-card-header cc-collapsible-summary">
                        <div class="predictive-card-title">
                            <i class="fas fa-check vericase-tick" aria-hidden="true"></i>
                            VeriCase Assistant
                        </div>
                        <span class="cc-collapsible-meta">
                            <span>Setup guidance</span>
                            <i class="fas fa-chevron-down cc-collapsible-chevron" aria-hidden="true"></i>
                        </span>
                    </summary>
                    <div class="predictive-card-body">
                        <div class="cc-assistant-actions">
                            <button class="ai-toggle-btn" type="button" onclick="toggleAIChat()">Expand</button>
                        </div>
                        <div class="ai-card-body" id="aiQuickPrompt">
                            <textarea class="ai-prompt-input" id="aiQuickInput" rows="2" placeholder="Ask anything..."></textarea>
                            <div class="ai-suggestions">
                                <button class="ai-suggestion" type="button" data-suggest="How do I create a project?">Create a project</button>
                                <button class="ai-suggestion" type="button" data-suggest="How do I set up a case?">Set up a case</button>
                                <button class="ai-suggestion" type="button" data-suggest="How do I invite my team?">Invite the team</button>
                                <button class="ai-suggestion" type="button" data-suggest="What can I do from here?">What can I do?</button>
                            </div>
                            <div class="ai-disclaimer">Setup guidance only. Ask about onboarding, roles, or where to go next.</div>
                        </div>
                        <div class="ai-chat-panel" id="aiChatPanel">
                            <div class="ai-chat-messages" id="aiChatMessages">
                                <div class="ai-message">
                                    <div class="ai-avatar"><i class="fas fa-robot"></i></div>
                                    <div class="ai-bubble">How can I help you today?</div>
                                </div>
                            </div>
                            <div class="ai-input-row">
                                <input type="text" id="aiChatInput" placeholder="Ask VeriCase..." />
                                <button class="btn btn-vericase btn-sm ai-send-btn" onclick="sendAIMessage()">
                                    <i class="fas fa-paper-plane" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </details>

            </section>
        </div>
            </div><!-- /cockpit-main -->

            <!-- Intelligence Panel (Right Sidebar) -->
            <aside class="cockpit-intel">
                <div class="intel-header">
                    <h2 class="intel-header-title">Active Intelligence</h2>
                    <p class="intel-header-subtitle">Monitoring <strong>Control Centre</strong> activity</p>
                </div>
                <div class="intel-body">
                    <!-- Priority Alert -->
                    <div class="intel-card">
                        <div class="intel-card-title">
                            <i class="fas fa-circle-exclamation"></i> Getting Started
                        </div>
                        <div class="intel-card-heading">Create Your First Workspace</div>
                        <p class="intel-card-text">
                            Start by creating a workspace to organize your projects and cases. Workspaces contain all your evidence, correspondence, and team collaboration.
                        </p>
                        <button class="btn-gold" type="button" data-action="open-setup">
                            <i class="fas fa-plus"></i> Create Workspace
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div class="intel-card">
                        <div class="intel-card-title">
                            <i class="fas fa-bolt"></i> Quick Actions
                        </div>
                        <div class="intel-card-text">
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                                <a href="master-dashboard.html" style="color: var(--vericase-gold); text-decoration: none; display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <i class="fas fa-columns"></i> Master Dashboard
                                </a>
                                <a href="#" style="color: rgba(255,255,255,0.7); text-decoration: none; display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <i class="fas fa-folder-tree"></i> Evidence Vault
                                </a>
                                <a href="#" style="color: rgba(255,255,255,0.7); text-decoration: none; display: flex; align-items: center; gap: 8px; padding: 8px 0;">
                                    <i class="fas fa-envelope-open-text"></i> Correspondence
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Tip -->
                    <div class="intel-card" style="border-left: 3px solid var(--vericase-gold);">
                        <div class="intel-card-title">
                            <i class="fas fa-lightbulb"></i> Tip
                        </div>
                        <p class="intel-card-text">
                            Use the <strong>Quick start guide</strong> button to walk through the setup process step-by-step.
                        </p>
                    </div>
                </div>
            </aside>
        </div><!-- /cockpit-stage -->
    </main>

    <!-- Interactive Guide Overlay -->
    <div class="guide-overlay" id="guideOverlay" aria-hidden="true">
        <div class="guide-shell" role="dialog" aria-modal="true" aria-labelledby="guideStepTitle">
            <div class="guide-header">
                <h3 id="guideHeaderTitle">Quick start guide</h3>
                <div class="guide-progress" id="guideProgress"></div>
                <button class="btn btn-ghost btn-sm" type="button" id="guideCloseBtn" aria-label="Close guide">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            <div class="guide-body">
                <div class="guide-step-title" id="guideStepTitle"></div>
                <div class="guide-step-desc" id="guideStepDesc"></div>
                <div class="guide-step-tip" id="guideStepTip"></div>
            </div>
            <div class="guide-footer">
                <div class="guide-step-count" id="guideStepCount"></div>
                <div class="guide-footer-actions">
                    <button class="btn btn-ghost btn-sm" type="button" id="guidePrevBtn">Back</button>
                    <button class="btn btn-outline btn-sm" type="button" id="guideNextBtn">Next</button>
                    <button class="btn btn-vericase btn-sm" type="button" id="guideCtaBtn">Open</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let currentUserRole = "VIEWER";
        let permissions = {
            can_create_project: false,
            can_create_case: false,
            can_manage_users: false,
            can_access_admin: false,
        };
        let guideIndex = 0;

        const guideSteps = [
            {
                title: "Create your workspace",
                description: "Workspaces hold everything for an engagement: projects, cases, users, deliverables and collaboration.",
                tip: "Use a short, recognisable name (often the project name).",
                ctaLabel: "Create workspace",
                ctaAction: "open-setup",
            },
            {
                title: "Start with a project (exploratory)",
                description: "Projects are early-stage: capture contract context and begin evidence finding. You can create case(s) later.",
                tip: "If you're already in dispute, you can go straight to a case.",
                ctaLabel: "Project setup",
                ctaAction: "setup-project",
                fallbackLabel: "Create workspace",
                fallbackAction: "open-setup",
            },
            {
                title: "Create case(s) when the dispute is defined",
                description: "Cases are the refined dispute record. Link to a project where relevant and track issues as they develop.",
                tip: "A workspace can contain multiple cases from a single project.",
                ctaLabel: "Case setup",
                ctaAction: "setup-case",
                fallbackLabel: "Project setup",
                fallbackAction: "setup-project",
            },
            {
                title: "Invite the team and manage deliverables",
                description: "Admins assign power users. Power users can invite team members and allocate them to projects and cases.",
                tip: "Use Collaboration Hub to coordinate work, updates and deadlines.",
                ctaLabel: "Open Users",
                ctaAction: "open-users",
                requiresPower: true,
                fallbackLabel: "Ask admin about access",
                fallbackAction: "open-users",
            },
        ];

        document.addEventListener("DOMContentLoaded", () => {
            // Inject Navigation Shell
            if (window.VericaseShell && window.VericaseShell.inject) {
                VericaseShell.inject({
                    title: "Control Centre",
                    breadcrumbs: null,
                    headerActions: ""
                });
            }

            setupControlCentre();
            loadData();
        });

        function setupControlCentre() {
            const storedUser = getStoredUser();
            currentUserRole = normalizeRole(storedUser.role || currentUserRole);
            permissions = derivePermissionsFromRole(currentUserRole);

            bindActionHandlers();
            setupAssistant();
            setupGuideOverlay();
            updateContextIndicator();
            updateRoleUI();
            applyAccessVisibility();
            updateCreateLocks();
        }

        function getStoredUser() {
            try {
                return JSON.parse(localStorage.getItem("user") || "{}");
            } catch {
                return {};
            }
        }

        function normalizeRole(role) {
            const normalized = String(role || "VIEWER").trim().toUpperCase();
            return normalized || "VIEWER";
        }

        function derivePermissionsFromRole(role) {
            const admin = role === "ADMIN";
            const power = admin || role === "EDITOR";
            return {
                can_create_project: power,
                can_create_case: power,
                can_manage_users: admin,
                can_access_admin: admin,
            };
        }

        function bindActionHandlers() {
            document.querySelectorAll("[data-action]").forEach((el) => {
                el.addEventListener("click", (event) => {
                    event.preventDefault();
                    if (isLocked(el)) {
                        showLockedMessage(el.dataset.lockReason);
                        return;
                    }
                    handleAction(el.dataset.action);
                });
            });

            const createBtn = document.getElementById("createNewBtn");
            if (createBtn) {
                createBtn.addEventListener("click", () => handleAction("open-setup"));
            }

            const startGuideBtn = document.getElementById("startGuideBtn");
            if (startGuideBtn) {
                startGuideBtn.addEventListener("click", () => openGuide(0));
            }

            const openSetupBtn = document.getElementById("openSetupBtn");
            if (openSetupBtn) {
                openSetupBtn.addEventListener("click", () => handleAction("open-setup"));
            }
        }

        function handleAction(action) {
            switch (action) {
                case "start-guide":
                    openGuide(0);
                    break;
                case "open-setup":
                    openWorkspaceSetup();
                    break;
                case "setup-project":
                    openProjectSetup();
                    break;
                case "setup-case":
                    openCaseSetup();
                    break;
                case "setup-team":
                    window.location.href = "admin-users.html";
                    break;
                case "open-profile":
                    window.location.href = "profile.html";
                    break;
                case "open-users":
                    window.location.href = "admin-users.html";
                    break;
                case "open-master-dashboard":
                    window.location.href = "master-dashboard.html";
                    break;
                case "open-evidence":
                    openWorkspacePage("evidence.html");
                    break;
                case "open-correspondence":
                    openWorkspacePage("correspondence-enterprise.html");
                    break;
                case "open-collaboration":
                    openWorkspacePage("collaboration-workspace.html");
                    break;
                case "open-analysis":
                    openWorkspacePage("vericase-analysis.html");
                    break;
                case "open-settings":
                    window.location.href = "admin-settings.html";
                    break;
                case "open-caselaw":
                    window.location.href = "admin-settings.html#tab-caselaw";
                    break;
                default:
                    break;
            }
        }

        function openWorkspaceSetup() {
            window.location.href = "workspace-setup.html";
        }

        function getSelectedWorkspaceId() {
            return localStorage.getItem("currentWorkspaceId") || "";
        }

        function openProjectSetup() {
            const workspaceId = getSelectedWorkspaceId();
            if (!workspaceId) {
                showLockedMessage("Create or select a workspace first.");
                window.location.href = "master-dashboard.html";
                return;
            }
            window.location.href = `project-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
        }

        function openCaseSetup() {
            const workspaceId = getSelectedWorkspaceId();
            if (!workspaceId) {
                showLockedMessage("Create or select a workspace first.");
                window.location.href = "master-dashboard.html";
                return;
            }
            window.location.href = `case-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
        }

        function openWorkspacePage(page) {
            const ctx = typeof VericaseShell?.getContext === "function"
                ? VericaseShell.getContext()
                : { type: "", id: "" };

            if (!ctx || !ctx.id) {
                showLockedMessage("Select a workspace first from the Master Dashboard.");
                window.location.href = "master-dashboard.html";
                return;
            }

            const url = new URL(page, window.location.href);
            if (ctx.type === "case") {
                url.searchParams.set("caseId", ctx.id);
            } else {
                url.searchParams.set("projectId", ctx.id);
            }
            window.location.href = url.toString();
        }

        function isLocked(el) {
            return el.classList.contains("locked") || el.getAttribute("aria-disabled") === "true";
        }

        function toggleLock(el, locked) {
            if (locked) {
                el.classList.add("locked");
                el.setAttribute("aria-disabled", "true");
                if (el.tagName === "BUTTON") {
                    el.disabled = true;
                }
            } else {
                el.classList.remove("locked");
                el.removeAttribute("aria-disabled");
                if (el.tagName === "BUTTON") {
                    el.disabled = false;
                }
            }
        }

        function showLockedMessage(reason) {
            const message = reason || "This action requires additional permissions.";
            if (window.VericaseUI?.Toast) {
                VericaseUI.Toast.warning(message);
            } else {
                alert(message);
            }
        }

        function updateRoleUI() {
            const chip = document.getElementById("roleChip");
            const label = getRoleLabel(currentUserRole);
            if (chip) {
                chip.textContent = label;
                chip.classList.toggle("admin", currentUserRole === "ADMIN");
                chip.classList.toggle("viewer", currentUserRole === "VIEWER");
            }

            document.querySelectorAll(".role-card").forEach((card) => {
                const role = card.dataset.role;
                card.classList.toggle("active", role === currentUserRole);
            });
        }

        function getRoleLabel(role) {
            if (role === "ADMIN") return "Administrator";
            if (role === "EDITOR") return "Power User";
            return "Team Member";
        }

        function applyAccessVisibility() {
            const isAdmin = currentUserRole === "ADMIN";
            const isPower = isAdmin || currentUserRole === "EDITOR";

            document.querySelectorAll("[data-admin-only='true']").forEach((el) => {
                el.style.display = isAdmin ? "" : "none";
            });
            document.querySelectorAll("[data-admin-lock='true']").forEach((el) => {
                toggleLock(el, !isAdmin);
            });
            document.querySelectorAll("[data-power-lock='true']").forEach((el) => {
                toggleLock(el, !isPower);
            });
        }

        function updateCreateLocks() {
            const canProject = !!permissions.can_create_project;
            const canCase = !!permissions.can_create_case;
            const canWorkspace = canProject || canCase;

            document.querySelectorAll('[data-requires-create="project"]').forEach((el) => {
                toggleLock(el, !canProject);
            });
            document.querySelectorAll('[data-requires-create="case"]').forEach((el) => {
                toggleLock(el, !canCase);
            });
            document.querySelectorAll('[data-requires-create="workspace"]').forEach((el) => {
                toggleLock(el, !canWorkspace);
            });

            const createBtn = document.getElementById("createNewBtn");
            if (createBtn) {
                const allowed = canWorkspace;
                createBtn.disabled = !allowed;
                if (!allowed) {
                    createBtn.title = "Ask your admin to grant create access.";
                } else {
                    createBtn.title = "";
                }
            }
        }

        function updateContextIndicator() {
            const indicator = document.getElementById("contextIndicator");
            if (!indicator) return;

            const ctx = typeof VericaseShell?.getContext === "function"
                ? VericaseShell.getContext()
                : { type: "", id: "" };
            const textEl = indicator.querySelector(".context-text");

            if (ctx && ctx.id) {
                const name = ctx.type === "case"
                    ? (localStorage.getItem("currentCaseName") || localStorage.getItem("vericase_current_case_name") || "Selected case")
                    : (localStorage.getItem("currentProjectName") || localStorage.getItem("vericase_current_project_name") || "Selected project");
                indicator.classList.remove("no-context");
                if (textEl) {
                    textEl.innerHTML = `<strong>${escapeHtml(name)}</strong>`;
                }
            } else {
                indicator.classList.add("no-context");
                if (textEl) {
                    textEl.innerHTML = "<strong>No workspace selected</strong>";
                }
            }
        }

        async function loadData() {
            try {
                // Fetch both dashboard overview (for permissions/user) and workspaces (for accurate stats)
                const [overviewResponse, workspacesResponse] = await Promise.all([
                    fetch("/api/dashboard/overview", { headers: getAuthHeaders() }),
                    fetch("/api/workspaces", { headers: getAuthHeaders() })
                ]);

                if (!overviewResponse.ok) {
                    throw new Error(`Dashboard request failed (${overviewResponse.status})`);
                }

                const data = await overviewResponse.json();
                dashboardData = data;

                if (data.user && data.user.role) {
                    currentUserRole = normalizeRole(data.user.role);
                }
                permissions = data.permissions || derivePermissionsFromRole(currentUserRole);

                // Update Greeting
                if (data.user && data.user.display_name) {
                    document.getElementById("greetingTitle").textContent = `Welcome back, ${data.user.display_name}`;
                }

                // Update Stats - use workspaces data for consistency with Master Dashboard
                let totalProjects = 0;
                let totalCases = 0;
                let totalEmails = 0;

                if (workspacesResponse.ok) {
                    const workspacesData = await workspacesResponse.json();
                    totalProjects = workspacesData.reduce((sum, ws) => sum + (ws.project_count || 0), 0);
                    totalCases = workspacesData.reduce((sum, ws) => sum + (ws.case_count || 0), 0);
                    totalEmails = workspacesData.reduce((sum, ws) => sum + (ws.email_count || 0), 0);
                } else {
                    // Fallback to dashboard overview stats
                    totalProjects = data.stats?.total_projects || 0;
                    totalCases = data.stats?.total_cases || 0;
                    totalEmails = data.stats?.total_emails || 0;
                }

                document.getElementById("statProjects").textContent = formatCount(totalProjects);
                document.getElementById("statCases").textContent = formatCount(totalCases);
                document.getElementById("statEmails").textContent = formatCount(totalEmails);

                renderDeadlines(data.upcoming_deadlines || data.deadlines || []);
            } catch (e) {
                console.error("Failed to load control centre data", e);
                renderDeadlines([]);
            } finally {
                updateRoleUI();
                applyAccessVisibility();
                updateCreateLocks();
                updateContextIndicator();
            }
        }

        function renderDeadlines(items) {
            const deadlinesList = document.getElementById("deadlines-list");
            if (!deadlinesList) return;

            if (!Array.isArray(items) || items.length === 0) {
                deadlinesList.innerHTML = '<div style="font-size: 0.8rem; color: var(--text-muted); text-align: center;">No immediate deadlines.</div>';
                return;
            }

            deadlinesList.innerHTML = items.map((d) => {
                const title = escapeHtml(d.title || d.event || "Deadline");
                const dateText = formatDate(d.date || d.deadline_date || d.due_date);
                const source = d.source_name || d.case_name || d.project_name || "";
                const sourceTag = source
                    ? `<span class="stat-pill" style="font-size: 0.7rem;">${escapeHtml(source)}</span>`
                    : "";
                return `
                    <div class="deadline-item">
                        <div class="deadline-info">
                            <span class="deadline-title">${title}</span>
                            <span class="deadline-date">${dateText}</span>
                        </div>
                        ${sourceTag}
                    </div>
                `;
            }).join("");
        }

        function formatDate(value) {
            if (!value) return "Date TBD";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return "Date TBD";
            return date.toLocaleDateString();
        }

        function formatCount(value) {
            if (typeof value === "number") {
                return value.toLocaleString();
            }
            return String(value || "0");
        }

        function getAuthHeaders() {
            const token =
                localStorage.getItem("vericase_token") ||
                localStorage.getItem("token") ||
                localStorage.getItem("jwt");
            return token ? { Authorization: `Bearer ${token}` } : {};
        }

        function escapeHtml(str) {
            if (!str) return "";
            const div = document.createElement("div");
            div.textContent = String(str);
            return div.innerHTML;
        }

        // AI Assistant Logic (Guidance Only)
        function setupAssistant() {
            const quickInput = document.getElementById("aiQuickInput");
            if (quickInput) {
                quickInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        const prompt = quickInput.value.trim();
                        if (prompt) {
                            quickInput.value = "";
                            openChatAndSend(prompt);
                        }
                    }
                });
            }

            const chatInput = document.getElementById("aiChatInput");
            if (chatInput) {
                chatInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        sendAIMessage();
                    }
                });
            }

            document.querySelectorAll("[data-suggest]").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const message = btn.dataset.suggest || btn.textContent;
                    if (message) {
                        openChatAndSend(message);
                    }
                });
            });
        }

        function toggleAIChat(forceOpen) {
            const panel = document.getElementById("aiChatPanel");
            const quickPrompt = document.getElementById("aiQuickPrompt");
            const toggleBtn = document.querySelector(".ai-toggle-btn");

            if (!panel || !quickPrompt || !toggleBtn) return;

            const shouldOpen = typeof forceOpen === "boolean" ? forceOpen : !panel.classList.contains("active");

            if (shouldOpen) {
                panel.classList.add("active");
                quickPrompt.style.display = "none";
                toggleBtn.textContent = "Collapse";
                document.getElementById("aiChatInput")?.focus();
            } else {
                panel.classList.remove("active");
                quickPrompt.style.display = "block";
                toggleBtn.textContent = "Expand";
            }
        }

        function openChatAndSend(message) {
            toggleAIChat(true);
            const input = document.getElementById("aiChatInput");
            if (input) {
                input.value = message;
            }
            sendAIMessage();
        }

        function sendAIMessage() {
            const input = document.getElementById("aiChatInput");
            if (!input) return;

            const message = input.value.trim();
            if (!message) return;

            appendAIMessage("user", message);
            input.value = "";

            const reply = getAssistantReply(message);
            appendAIMessage("assistant", reply);
        }

        function appendAIMessage(type, message) {
            const container = document.getElementById("aiChatMessages");
            if (!container) return;

            const isUser = type === "user";
            const avatar = isUser ? "fa-user" : "fa-robot";
            const bubble = isUser ? escapeHtml(message) : formatAssistantMessage(message);

            container.innerHTML += `
                <div class="ai-message ${isUser ? "user" : ""}">
                    <div class="ai-avatar"><i class="fas ${avatar}"></i></div>
                    <div class="ai-bubble">${bubble}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        function formatAssistantMessage(text) {
            return escapeHtml(text).replace(/\n/g, "<br>");
        }

        function getAssistantReply(message) {
            const text = message.toLowerCase();
            const isAdmin = currentUserRole === "ADMIN";
            const isPower = isAdmin || currentUserRole === "EDITOR";

            if (text.includes("workspace") && (text.includes("create") || text.includes("setup") || text.includes("new"))) {
                return `Workspaces organise everything for an engagement (projects, cases, users, deliverables).
To create one:
1) Open Workspace Setup.
2) Enter a name (code is optional).
3) Save, then add a project and/or case inside the workspace.`;
            }

            if (text.includes("project") && (text.includes("create") || text.includes("setup") || text.includes("new"))) {
                return `Projects are typically early-stage (exploratory).
To set one up:
1) Create or select a workspace.
2) Open Project Setup from the workspace.
3) Enter the project name (code optional) and save.
You can begin evidence finding under the project and create case(s) later if needed.`;
            }

            if (text.includes("case") && (text.includes("create") || text.includes("setup") || text.includes("new"))) {
                return `Cases are for a defined dispute (refined).
To set one up:
1) Create or select a workspace.
2) Open Case Setup from the workspace.
3) Enter the case name (number optional) and link to a project if relevant.
A workspace can contain multiple cases from a single project.`;
            }

            if (text.includes("team") || text.includes("invite") || text.includes("member")) {
                if (isAdmin) {
                    return "Admins assign power users. Power users can invite team members and allocate them to projects and cases from the Users page.";
                }
                if (isPower) {
                    return "Power users can invite team members from the Users page and allocate them to projects and cases inside a workspace.";
                }
                return "Team invitations are managed by admins and power users. Ask admin@veri-case.com to grant access, then allocate people to the right workspace/project/case.";
            }

            if (text.includes("user") || text.includes("users") || text.includes("access")) {
                if (isAdmin) {
                    return "Open Users to invite new people, assign roles (including power users), and allocate access to workspaces, projects and cases.";
                }
                if (isPower) {
                    return "Open Users to invite team members and allocate access within your workspace. Admins assign power users.";
                }
                return "User management is restricted to admins and power users. Ask admin@veri-case.com if you need changes to access.";
            }

            if (text.includes("profile")) {
                return "Use Profile to update your display name, password, and account details.";
            }

            if (text.includes("settings") || text.includes("case law") || text.includes("caselaw")) {
                if (isAdmin) {
                    return "Settings and Case Law tools are available in Admin Settings. Open Settings from the Features Overview.";
                }
                return "Settings and Case Law tools are admin-only. Ask admin@veri-case.com if you need access.";
            }

            if (text.includes("upload") || text.includes("pst") || text.includes("evidence")) {
                return "Upload evidence under a project/case inside the workspace. Open the Master Dashboard, open the relevant project or case, then use Evidence or PST Upload.";
            }

            if (text.includes("collaboration") || text.includes("hub")) {
                return "The Collaboration Hub lives inside each workspace. Open a project or case, then use Collaboration Hub to coordinate notes, updates and deadlines.";
            }

            if (text.includes("dashboard") || text.includes("overview") || text.includes("features")) {
                return "The Master Dashboard shows all workspaces and what sits inside them. Use it to open projects/cases, then go to Evidence, Correspondence, Collaboration Hub or Analysis.";
            }

            return "I can help with setup steps, roles, and where to go next. Try asking about creating a workspace, setting up a project, creating a case, or inviting your team.";
        }

        // Interactive Guide
        function setupGuideOverlay() {
            const overlay = document.getElementById("guideOverlay");
            const closeBtn = document.getElementById("guideCloseBtn");
            const prevBtn = document.getElementById("guidePrevBtn");
            const nextBtn = document.getElementById("guideNextBtn");
            const ctaBtn = document.getElementById("guideCtaBtn");

            if (closeBtn) closeBtn.addEventListener("click", closeGuide);
            if (prevBtn) prevBtn.addEventListener("click", () => changeGuideStep(-1));
            if (nextBtn) nextBtn.addEventListener("click", () => changeGuideStep(1));
            if (ctaBtn) ctaBtn.addEventListener("click", handleGuideCta);

            if (overlay) {
                overlay.addEventListener("click", (event) => {
                    if (event.target === overlay) {
                        closeGuide();
                    }
                });
            }
        }

        function openGuide(startIndex = 0) {
            guideIndex = Math.max(0, Math.min(startIndex, guideSteps.length - 1));
            renderGuide();
            const overlay = document.getElementById("guideOverlay");
            if (overlay) {
                overlay.classList.add("active");
                overlay.setAttribute("aria-hidden", "false");
            }
        }

        function closeGuide() {
            const overlay = document.getElementById("guideOverlay");
            if (overlay) {
                overlay.classList.remove("active");
                overlay.setAttribute("aria-hidden", "true");
            }
        }

        function changeGuideStep(delta) {
            const next = guideIndex + delta;
            if (next < 0) {
                guideIndex = 0;
            } else if (next >= guideSteps.length) {
                closeGuide();
                return;
            } else {
                guideIndex = next;
            }
            renderGuide();
        }

        function renderGuide() {
            const step = guideSteps[guideIndex];
            if (!step) return;

            const progress = document.getElementById("guideProgress");
            if (progress) {
                progress.innerHTML = guideSteps.map((_, idx) => `
                    <div class="guide-dot ${idx === guideIndex ? "active" : ""}"></div>
                `).join("");
            }

            const titleEl = document.getElementById("guideStepTitle");
            const descEl = document.getElementById("guideStepDesc");
            const tipEl = document.getElementById("guideStepTip");
            if (titleEl) titleEl.textContent = step.title;
            if (descEl) descEl.textContent = step.description;
            if (tipEl) tipEl.textContent = step.tip;

            const countEl = document.getElementById("guideStepCount");
            if (countEl) countEl.textContent = `Step ${guideIndex + 1} of ${guideSteps.length}`;

            const prevBtn = document.getElementById("guidePrevBtn");
            if (prevBtn) prevBtn.disabled = guideIndex === 0;

            const nextBtn = document.getElementById("guideNextBtn");
            if (nextBtn) nextBtn.textContent = guideIndex === guideSteps.length - 1 ? "Finish" : "Next";

            const ctaBtn = document.getElementById("guideCtaBtn");
            if (ctaBtn) {
                const isAdmin = currentUserRole === "ADMIN";
                const isPower = isAdmin || currentUserRole === "EDITOR";
                let action = step.ctaAction || "";
                let label = step.ctaLabel || "";

                if (step.requiresAdmin && !isAdmin) {
                    action = step.fallbackAction || "";
                    label = step.fallbackLabel || "Open workspace setup";
                } else if (step.requiresPower && !isPower) {
                    action = step.fallbackAction || "";
                    label = step.fallbackLabel || "Open workspace setup";
                }

                if (!action) {
                    ctaBtn.style.display = "none";
                } else {
                    ctaBtn.style.display = "inline-flex";
                    ctaBtn.textContent = label;
                    ctaBtn.dataset.action = action;
                }
            }
        }

        function handleGuideCta(event) {
            const action = event?.currentTarget?.dataset?.action;
            if (action) {
                handleAction(action);
            }
        }
    </script>
</body>

</html>

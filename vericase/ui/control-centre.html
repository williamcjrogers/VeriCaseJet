<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeriCase - Control Centre</title>
    <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="brand-styles.css?v=9" />
    <link rel="stylesheet" href="design-system.css?v=9" />
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>
    <style>
        /* === CONTROL CENTRE - REDESIGNED === */

        .app-content {
            background-color: var(--vericase-cream);
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 24px 24px;
            border: none;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
            padding: 32px 48px;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* === WATERMARKS === */
        .watermark {
            position: absolute;
            font-size: 280px;
            color: var(--vericase-navy);
            opacity: 0.025;
            pointer-events: none;
            z-index: 0;
        }

        .watermark-scales {
            right: -40px;
            top: 80px;
            transform: rotate(-12deg);
        }

        .watermark-gavel {
            left: -60px;
            bottom: -20px;
            transform: rotate(15deg);
        }

        /* === HEADER === */
        .cc-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            position: relative;
            z-index: 1;
        }

        .cc-title {
            font-family: var(--font-serif);
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0;
        }

        .cc-header-actions {
            display: flex;
            gap: 12px;
        }

        /* === TOP ROW: PROFILE + STATS === */
        .cc-top-row {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            margin-bottom: 32px;
            position: relative;
            z-index: 1;
        }

        /* === PROFILE CARD === */
        .cc-profile-card {
            background: white;
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 24px;
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.05);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .profile-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--vericase-teal), var(--vericase-navy));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0 0 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-email {
            font-size: 0.8125rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 16px;
            border-top: 1px solid var(--border-default);
        }

        .role-badge {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 10px;
            border-radius: 4px;
        }

        .role-badge.admin {
            background: rgba(31, 111, 120, 0.15);
            color: var(--vericase-teal);
        }

        .role-badge.editor {
            background: rgba(197, 160, 101, 0.15);
            color: var(--vericase-gold);
        }

        .role-badge.viewer {
            background: var(--gray-100);
            color: var(--text-muted);
        }

        .profile-link {
            font-size: 0.8125rem;
            color: var(--vericase-teal);
            text-decoration: none;
        }

        .profile-link:hover {
            text-decoration: underline;
        }

        .last-login {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 12px;
        }

        /* === STATS PANEL === */
        .cc-stats-panel {
            background: white;
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 24px;
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.05);
        }

        .stats-panel-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin: 0 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .stat-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .stat-column-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-default);
        }

        .stat-column-header i {
            font-size: 0.875rem;
            color: var(--vericase-gold);
        }

        .stat-column-header span {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--vericase-navy);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-row-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .stat-row-value {
            font-family: var(--font-mono);
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--vericase-navy);
        }

        /* === SECTION HEADERS === */
        .cc-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .cc-section-header h2 {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin: 0;
        }

        /* === WORKSPACE GRID (READ-ONLY) === */
        .cc-workspaces {
            margin-bottom: 32px;
            position: relative;
            z-index: 1;
        }

        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .workspace-card {
            background: white;
            border: 1px solid var(--border-default);
            border-top: 4px solid var(--vericase-gold);
            border-radius: 6px;
            padding: 20px;
            box-shadow: 2px 2px 0px rgba(15, 23, 42, 0.03);
            /* Non-clickable - removed cursor and hover effects */
            opacity: 0.9;
        }

        .workspace-card-name {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0 0 4px;
        }

        .workspace-card-code {
            font-size: 0.6875rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            margin-bottom: 12px;
        }

        .workspace-card-stats {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .workspace-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .workspace-stat-value {
            font-family: var(--font-serif);
            font-size: 1rem;
            font-weight: 600;
            color: var(--vericase-navy);
        }

        .workspace-stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .workspace-card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border-default);
        }

        .workspace-status {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 3px 6px;
            border-radius: 3px;
            background: rgba(197, 160, 101, 0.15);
            color: var(--vericase-gold);
        }

        .workspace-status.dormant {
            background: var(--gray-100);
            color: var(--text-muted);
        }

        /* === ACTIVITY FEED === */
        .cc-activity {
            margin-bottom: 32px;
            position: relative;
            z-index: 1;
        }

        .activity-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }

        .activity-tab {
            padding: 8px 16px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .activity-tab:hover {
            background: white;
            color: var(--vericase-navy);
        }

        .activity-tab.active {
            background: white;
            border-color: var(--border-default);
            color: var(--vericase-navy);
            box-shadow: 2px 2px 0px rgba(15, 23, 42, 0.03);
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .activity-item {
            background: white;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 2px 2px 0px rgba(15, 23, 42, 0.03);
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon i {
            font-size: 0.75rem;
            color: var(--vericase-teal);
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-description {
            font-size: 0.875rem;
            color: var(--vericase-navy);
            margin: 0 0 2px;
        }

        .activity-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .activity-meta .user-name {
            color: var(--vericase-teal);
        }

        .activity-empty {
            text-align: center;
            padding: 32px;
            color: var(--text-muted);
            font-size: 0.875rem;
            background: white;
            border: 1px solid var(--border-default);
            border-radius: 6px;
        }

        /* === DEADLINES === */
        .cc-deadlines {
            margin-bottom: 32px;
            position: relative;
            z-index: 1;
        }

        .deadlines-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .deadline-item {
            background: white;
            border: 1px solid var(--border-default);
            border-left: 4px solid var(--vericase-gold);
            border-radius: 6px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 2px 2px 0px rgba(15, 23, 42, 0.03);
        }

        .deadline-item.urgent {
            border-left-color: #DC2626;
        }

        .deadline-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .deadline-title {
            font-weight: 600;
            color: var(--vericase-navy);
            font-size: 0.875rem;
        }

        .deadline-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .deadline-source {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 3px 8px;
            border-radius: 3px;
            background: var(--gray-100);
            color: var(--text-muted);
        }

        /* === MASTER DASHBOARD BUTTON === */
        .cc-action-footer {
            position: relative;
            z-index: 1;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(15, 23, 42, 0.1);
            display: flex;
            justify-content: center;
        }

        .btn-enter-dashboard {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 16px 48px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background: var(--vericase-navy);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.15);
        }

        .btn-enter-dashboard:hover {
            background: var(--vericase-navy-dark, #0a1628);
            transform: translateY(-2px);
            box-shadow: 6px 6px 0px rgba(15, 23, 42, 0.2);
        }

        .btn-enter-dashboard i {
            font-size: 1.125rem;
        }

        /* === EMPTY STATE === */
        .cc-empty-state {
            text-align: center;
            padding: 60px 40px;
            max-width: 480px;
            margin: 40px auto;
            position: relative;
            z-index: 1;
        }

        .cc-empty-visual {
            width: 100px;
            height: 100px;
            margin: 0 auto 24px;
            background: white;
            border: 1px solid var(--border-default);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.05);
        }

        .cc-empty-visual i {
            font-size: 2.5rem;
            color: var(--vericase-gold);
            opacity: 0.6;
        }

        .cc-empty-state h2 {
            font-family: var(--font-serif);
            font-size: 1.375rem;
            font-weight: 600;
            color: var(--vericase-navy);
            margin: 0 0 12px;
        }

        .cc-empty-state p {
            color: var(--text-muted);
            font-size: 0.9375rem;
            line-height: 1.6;
            margin: 0 0 24px;
        }

        /* === UTILITIES === */
        .hidden {
            display: none !important;
        }

        /* === RESPONSIVE === */
        @media (max-width: 1024px) {
            .cc-top-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .app-content {
                padding: 24px;
            }

            .cc-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .workspace-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <main id="main-content">
        <!-- Watermarks -->
        <i class="fas fa-balance-scale watermark watermark-scales"></i>
        <i class="fas fa-gavel watermark watermark-gavel"></i>

        <!-- Header -->
        <header class="cc-header">
            <h1 class="cc-title" id="greetingTitle">Control Centre</h1>
            <div class="cc-header-actions">
                <button class="btn btn-vericase" id="createWorkspaceBtn" data-action="open-setup">
                    <i class="fas fa-plus"></i> New Workspace
                </button>
            </div>
        </header>

        <!-- Top Row: Profile + Stats -->
        <div class="cc-top-row" id="topRow">
            <!-- Profile Card -->
            <div class="cc-profile-card" id="profileCard">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">?</div>
                    <div class="profile-info">
                        <h2 class="profile-name" id="profileName">Loading...</h2>
                        <div class="profile-email" id="profileEmail">-</div>
                    </div>
                </div>
                <div class="profile-meta">
                    <span class="role-badge viewer" id="roleBadge">VIEWER</span>
                    <a href="profile.html" class="profile-link">View Profile <i class="fas fa-arrow-right"></i></a>
                </div>
                <div class="last-login" id="lastLogin"></div>
            </div>

            <!-- Stats Panel -->
            <div class="cc-stats-panel" id="statsPanel">
                <h2 class="stats-panel-title">Activity Statistics</h2>
                <div class="stats-grid">
                    <!-- Emails Column -->
                    <div class="stat-column">
                        <div class="stat-column-header">
                            <i class="fas fa-envelope"></i>
                            <span>Emails</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Today</span>
                            <span class="stat-row-value" id="emailsToday">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Last 7 Days</span>
                            <span class="stat-row-value" id="emails7d">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total</span>
                            <span class="stat-row-value" id="emailsTotal">-</span>
                        </div>
                    </div>

                    <!-- Evidence Column -->
                    <div class="stat-column">
                        <div class="stat-column-header">
                            <i class="fas fa-file-alt"></i>
                            <span>Evidence</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Today</span>
                            <span class="stat-row-value" id="evidenceToday">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Last 7 Days</span>
                            <span class="stat-row-value" id="evidence7d">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total</span>
                            <span class="stat-row-value" id="evidenceTotal">-</span>
                        </div>
                    </div>

                    <!-- Documents Column -->
                    <div class="stat-column">
                        <div class="stat-column-header">
                            <i class="fas fa-folder"></i>
                            <span>Documents</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Today</span>
                            <span class="stat-row-value" id="documentsToday">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Last 7 Days</span>
                            <span class="stat-row-value" id="documents7d">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-row-label">Total</span>
                            <span class="stat-row-value" id="documentsTotal">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workspaces (read-only) -->
        <section class="cc-workspaces hidden" id="workspacesSection">
            <div class="cc-section-header">
                <h2>Your Workspaces</h2>
            </div>
            <div class="workspace-grid" id="workspaceGrid">
                <!-- Rendered via JS -->
            </div>
        </section>

        <!-- Activity Feed -->
        <section class="cc-activity" id="activitySection">
            <div class="cc-section-header">
                <h2>Recent Activity</h2>
            </div>
            <div class="activity-tabs">
                <button class="activity-tab active" data-tab="my">My Activity</button>
                <button class="activity-tab" data-tab="team">Team Activity</button>
            </div>
            <div class="activity-list" id="activityList">
                <!-- Rendered via JS -->
            </div>
        </section>

        <!-- Deadlines -->
        <section class="cc-deadlines hidden" id="deadlinesSection">
            <div class="cc-section-header">
                <h2>Upcoming Deadlines</h2>
            </div>
            <div class="deadlines-list" id="deadlinesList">
                <!-- Rendered via JS -->
            </div>
        </section>

        <!-- Empty State -->
        <section class="cc-empty-state hidden" id="emptyState">
            <div class="cc-empty-visual">
                <i class="fas fa-folder-open"></i>
            </div>
            <h2>Create your first workspace</h2>
            <p>Workspaces organize your projects, cases, evidence and team collaboration. Start by creating one.</p>
            <button class="btn btn-vericase" data-action="open-setup">
                <i class="fas fa-plus"></i> Create Workspace
            </button>
        </section>

        <!-- Master Dashboard Button -->
        <div class="cc-action-footer" id="actionFooter">
            <button class="btn-enter-dashboard" id="enterDashboardBtn">
                <i class="fas fa-th-large"></i>
                Enter Master Dashboard
            </button>
        </div>
    </main>

    <script>
        let controlCentreData = null;
        let workspacesData = [];
        let currentActivityTab = "my";
        let myActivity = [];
        let teamActivity = [];

        document.addEventListener("DOMContentLoaded", () => {
            if (window.VericaseShell && window.VericaseShell.inject) {
                VericaseShell.inject({
                    title: "Control Centre",
                    breadcrumbs: null,
                    headerActions: ""
                });
            }
            setupControlCentre();
            loadData();
        });

        function setupControlCentre() {
            bindActionHandlers();
            setupActivityTabs();
            setupDashboardButton();
        }

        function bindActionHandlers() {
            document.querySelectorAll("[data-action]").forEach((el) => {
                el.addEventListener("click", (e) => {
                    e.preventDefault();
                    handleAction(el.dataset.action);
                });
            });
        }

        function setupActivityTabs() {
            const tabs = document.querySelectorAll(".activity-tab");
            tabs.forEach(tab => {
                tab.addEventListener("click", () => {
                    tabs.forEach(t => t.classList.remove("active"));
                    tab.classList.add("active");
                    currentActivityTab = tab.dataset.tab;
                    renderActivityList();
                });
            });
        }

        function setupDashboardButton() {
            const btn = document.getElementById("enterDashboardBtn");
            if (btn) {
                btn.addEventListener("click", () => {
                    window.location.href = "master-dashboard.html";
                });
            }
        }

        function handleAction(action) {
            switch (action) {
                case "open-setup":
                    window.location.href = "workspace-setup.html";
                    break;
            }
        }

        async function loadData() {
            try {
                const [statsResponse, workspacesResponse, overviewResponse] = await Promise.all([
                    fetch("/api/dashboard/control-centre-stats", { headers: getAuthHeaders() }),
                    fetch("/api/workspaces", { headers: getAuthHeaders() }),
                    fetch("/api/dashboard/overview", { headers: getAuthHeaders() })
                ]);

                // Load control centre stats
                if (statsResponse.ok) {
                    controlCentreData = await statsResponse.json();
                    renderProfile(controlCentreData.user);
                    renderStats(controlCentreData.stats);
                    myActivity = controlCentreData.my_activity || [];
                    teamActivity = controlCentreData.team_activity || [];
                    renderActivityList();
                    updatePermissions(controlCentreData.permissions);
                }

                // Load workspaces
                if (workspacesResponse.ok) {
                    workspacesData = await workspacesResponse.json();
                    renderWorkspaces(workspacesData);
                }

                // Load deadlines from overview
                if (overviewResponse.ok) {
                    const overviewData = await overviewResponse.json();
                    renderDeadlines(overviewData.upcoming_deadlines || []);

                    // Fallback for user info if control-centre-stats failed
                    if (!controlCentreData && overviewData.user) {
                        renderProfile(overviewData.user);
                    }
                }

                updateUIState();
            } catch (e) {
                console.error("Failed to load control centre data", e);
                updateUIState();
            }
        }

        function renderProfile(user) {
            if (!user) return;

            const nameEl = document.getElementById("profileName");
            const emailEl = document.getElementById("profileEmail");
            const avatarEl = document.getElementById("profileAvatar");
            const badgeEl = document.getElementById("roleBadge");
            const loginEl = document.getElementById("lastLogin");

            if (nameEl) nameEl.textContent = user.display_name || user.email?.split("@")[0] || "User";
            if (emailEl) emailEl.textContent = user.email || "";
            if (avatarEl) avatarEl.textContent = getInitials(user.display_name || user.email || "?");

            if (badgeEl) {
                const role = (user.role || "VIEWER").toUpperCase();
                badgeEl.textContent = role;
                badgeEl.className = "role-badge " + role.toLowerCase();
            }

            if (loginEl && user.last_login) {
                loginEl.textContent = "Last login: " + formatRelativeDate(user.last_login);
            }

            // Update greeting
            const greetingEl = document.getElementById("greetingTitle");
            if (greetingEl && user.display_name) {
                greetingEl.textContent = `Welcome back, ${user.display_name}`;
            }
        }

        function renderStats(stats) {
            if (!stats) return;

            document.getElementById("emailsToday").textContent = formatCount(stats.emails_today);
            document.getElementById("emails7d").textContent = formatCount(stats.emails_7d);
            document.getElementById("emailsTotal").textContent = formatCount(stats.emails_total);

            document.getElementById("evidenceToday").textContent = formatCount(stats.evidence_today);
            document.getElementById("evidence7d").textContent = formatCount(stats.evidence_7d);
            document.getElementById("evidenceTotal").textContent = formatCount(stats.evidence_total);

            document.getElementById("documentsToday").textContent = formatCount(stats.documents_today);
            document.getElementById("documents7d").textContent = formatCount(stats.documents_7d);
            document.getElementById("documentsTotal").textContent = formatCount(stats.documents_total);
        }

        function renderActivityList() {
            const list = document.getElementById("activityList");
            if (!list) return;

            const items = currentActivityTab === "my" ? myActivity : teamActivity;

            if (!items || items.length === 0) {
                list.innerHTML = `
                    <div class="activity-empty">
                        <i class="fas fa-history"></i>
                        <p>No recent activity${currentActivityTab === "my" ? "" : " from team members"}</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = items.map(item => {
                const icon = getActivityIcon(item.resource_type);
                const timeAgo = formatRelativeDate(item.timestamp);
                const userInfo = currentActivityTab === "team" && item.user_name
                    ? `<span class="user-name">${escapeHtml(item.user_name)}</span> - `
                    : "";
                const workspace = item.workspace ? ` in ${escapeHtml(item.workspace)}` : "";

                return `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="${icon}"></i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-description">${escapeHtml(item.description)}</p>
                            <span class="activity-meta">${userInfo}${timeAgo}${workspace}</span>
                        </div>
                    </div>
                `;
            }).join("");
        }

        function renderWorkspaces(workspaces) {
            const grid = document.getElementById("workspaceGrid");
            const section = document.getElementById("workspacesSection");
            if (!grid || !section) return;

            if (!workspaces || workspaces.length === 0) {
                section.classList.add("hidden");
                return;
            }

            section.classList.remove("hidden");
            grid.innerHTML = workspaces.map(ws => {
                const name = escapeHtml(ws.name || "Unnamed Workspace");
                const code = ws.code ? escapeHtml(ws.code) : "";
                const projectCount = ws.project_count || 0;
                const caseCount = ws.case_count || 0;
                const emailCount = ws.email_count || 0;
                const isActive = (ws.updated_at && daysSince(ws.updated_at) < 30) || emailCount > 0;
                const statusClass = isActive ? "" : "dormant";
                const statusLabel = isActive ? "Active" : "Dormant";

                // NOTE: Changed from <a> to <div> - workspaces are read-only here
                return `
                    <div class="workspace-card" data-workspace-id="${ws.id}">
                        <h3 class="workspace-card-name">${name}</h3>
                        ${code ? `<div class="workspace-card-code">${code}</div>` : '<div class="workspace-card-code">&nbsp;</div>'}
                        <div class="workspace-card-stats">
                            <div class="workspace-stat">
                                <span class="workspace-stat-value">${formatCount(projectCount)}</span>
                                <span class="workspace-stat-label">Projects</span>
                            </div>
                            <div class="workspace-stat">
                                <span class="workspace-stat-value">${formatCount(caseCount)}</span>
                                <span class="workspace-stat-label">Cases</span>
                            </div>
                            <div class="workspace-stat">
                                <span class="workspace-stat-value">${formatCount(emailCount)}</span>
                                <span class="workspace-stat-label">Emails</span>
                            </div>
                        </div>
                        <div class="workspace-card-meta">
                            <span class="workspace-status ${statusClass}">${statusLabel}</span>
                        </div>
                    </div>
                `;
            }).join("");
        }

        function renderDeadlines(items) {
            const section = document.getElementById("deadlinesSection");
            const list = document.getElementById("deadlinesList");
            if (!section || !list) return;

            if (!Array.isArray(items) || items.length === 0) {
                section.classList.add("hidden");
                return;
            }

            section.classList.remove("hidden");
            list.innerHTML = items.map(d => {
                const title = escapeHtml(d.title || d.event || "Deadline");
                const dateText = formatDate(d.date || d.deadline_date || d.due_date);
                const source = d.source_name || d.case_name || d.project_name || "";
                const isUrgent = d.days_remaining !== undefined && d.days_remaining <= 2;

                return `
                    <div class="deadline-item ${isUrgent ? 'urgent' : ''}">
                        <div class="deadline-info">
                            <span class="deadline-title">${title}</span>
                            <span class="deadline-date">${dateText}</span>
                        </div>
                        ${source ? `<span class="deadline-source">${escapeHtml(source)}</span>` : ""}
                    </div>
                `;
            }).join("");
        }

        function updateUIState() {
            const hasWorkspaces = workspacesData && workspacesData.length > 0;
            const emptyState = document.getElementById("emptyState");
            const topRow = document.getElementById("topRow");
            const activitySection = document.getElementById("activitySection");
            const actionFooter = document.getElementById("actionFooter");

            if (hasWorkspaces) {
                emptyState?.classList.add("hidden");
                topRow?.classList.remove("hidden");
                activitySection?.classList.remove("hidden");
                actionFooter?.classList.remove("hidden");
            } else {
                emptyState?.classList.remove("hidden");
                topRow?.classList.add("hidden");
                activitySection?.classList.add("hidden");
                actionFooter?.classList.add("hidden");
            }
        }

        function updatePermissions(permissions) {
            const createBtn = document.getElementById("createWorkspaceBtn");
            if (createBtn && permissions) {
                const canCreate = permissions.can_create_workspace || permissions.can_create_project;
                createBtn.disabled = !canCreate;
                createBtn.title = canCreate ? "" : "Ask your admin to grant create access.";
            }
        }

        // Utility functions
        function getInitials(name) {
            if (!name) return "?";
            const parts = name.trim().split(/\s+/);
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
            return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
        }

        function getActivityIcon(resourceType) {
            const icons = {
                email: "fas fa-envelope",
                evidence: "fas fa-file-alt",
                document: "fas fa-folder",
                comment: "fas fa-comment",
                annotation: "fas fa-highlighter",
                case: "fas fa-briefcase",
                project: "fas fa-project-diagram"
            };
            return icons[resourceType?.toLowerCase()] || "fas fa-circle";
        }

        function formatDate(value) {
            if (!value) return "Date TBD";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return "Date TBD";
            return date.toLocaleDateString();
        }

        function formatRelativeDate(value) {
            if (!value) return "";
            const days = daysSince(value);
            if (days === 0) return "Today";
            if (days === 1) return "Yesterday";
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
            return new Date(value).toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
        }

        function daysSince(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function formatCount(value) {
            if (typeof value === "number") {
                return value.toLocaleString();
            }
            return String(value || "0");
        }

        function getAuthHeaders() {
            const token = localStorage.getItem("vericase_token") ||
                          localStorage.getItem("token") ||
                          localStorage.getItem("jwt");
            return token ? { Authorization: `Bearer ${token}` } : {};
        }

        function escapeHtml(str) {
            if (!str) return "";
            const div = document.createElement("div");
            div.textContent = String(str);
            return div.innerHTML;
        }
    </script>
</body>

</html>

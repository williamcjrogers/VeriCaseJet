<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VeriCase - Overview</title>
  <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="assets/global.css" />
  <link rel="stylesheet" href="brand-styles.css?v=6" />
  <link rel="stylesheet" href="design-system.css?v=6" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet" />
  <script src="vericase-ui.js"></script>
  <script src="nav-shell.js"></script>
  <style>
    :root {
      /* Back-compat aliases used by this page */
      --vc-gold: var(--vericase-gold);
      --vc-gold-light: var(--vericase-gold-light);
      --vc-gold-muted: var(--vericase-gold-muted);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "DM Sans", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--vericase-navy);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Subtle background pattern */
    .bg-pattern {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background:
        linear-gradient(135deg, rgba(var(--vericase-teal-rgb), 0.02) 0%, transparent 50%),
        linear-gradient(225deg, rgba(184, 134, 11, 0.02) 0%, transparent 50%);
      pointer-events: none;
    }

    /* Hide the original top-bar when shell is active */
    .app-shell .top-bar {
      display: none;
    }

    /* Dashboard page: remove duplicate header title in shell */
    .app-shell .app-header-title {
      display: none;
    }

    /* Adjust dashboard container when shell is active */
    .app-shell .dashboard-container {
      width: 100% !important;
      max-width: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .top-bar {
      background: var(--vericase-navy);
      color: white;
      padding: 0.875rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .top-bar .logo-img {
      height: 36px;
      width: auto;
      margin-right: 0.5rem;
    }

    .top-bar h1 {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
    }

    .top-bar-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.625rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--vericase-teal) 0%, var(--vericase-teal-dark) 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(var(--vericase-teal-rgb), 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--vericase-teal-light) 0%, var(--vericase-teal) 100%);
      box-shadow: 0 6px 20px rgba(var(--vericase-teal-rgb), 0.4);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .btn-gold {
      background: linear-gradient(135deg, var(--vc-gold) 0%, var(--vc-gold-muted) 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(184, 134, 11, 0.3);
    }

    .btn-gold:hover {
      background: linear-gradient(135deg, var(--vc-gold-light) 0%, var(--vc-gold) 100%);
      box-shadow: 0 6px 20px rgba(184, 134, 11, 0.4);
      transform: translateY(-1px);
    }

    .btn-success {
      background: #059669;
      color: white;
    }

    .btn-success:hover {
      background: #047857;
    }

    .dashboard-container {
      width: 100%;
      max-width: none;
      margin: 0;
      padding: 2rem;
    }

    /* Welcome Banner - Premium Deep Research Style */
    .welcome-banner {
      background: linear-gradient(135deg,
          var(--vericase-navy) 0%,
          #1e293b 100%);
      color: white;
      padding: 2.5rem 3rem;
      border-radius: 16px;
      margin-bottom: 2rem;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.25);
      position: relative;
      overflow: hidden;
    }

    .welcome-banner::before {
      content: "";
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle,
          rgba(var(--vericase-teal-rgb), 0.15) 0%,
          transparent 60%);
      border-radius: 50%;
      pointer-events: none;
    }

    .welcome-banner::after {
      content: "";
      position: absolute;
      bottom: -30%;
      left: -5%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle,
          rgba(184, 134, 11, 0.1) 0%,
          transparent 60%);
      border-radius: 50%;
      pointer-events: none;
    }

    .welcome-banner h2 {
      font-family: "DM Sans", sans-serif;
      font-size: var(--text-5xl);
      font-weight: 700;
      color: #fff;
      letter-spacing: -0.02em;
      line-height: 1.15;
      margin-bottom: 1rem;
      max-width: none;
      position: relative;
      z-index: 1;
    }

    .welcome-banner h2 .title-accent {
      font-family: "Cormorant Garamond", Georgia, serif;
      font-style: italic;
      font-weight: 500;
      color: var(--vc-gold-light);
    }

    .welcome-banner h2 .title-suffix {
      display: block;
      margin-top: 0.35rem;
      font-size: var(--text-2xl);
      font-weight: 600;
      color: rgba(255, 255, 255, 0.92);
      letter-spacing: -0.01em;
      line-height: 1.25;
    }

    .welcome-banner p {
      font-size: 1rem;
      font-weight: 400;
      color: rgba(255, 255, 255, 0.85);
      line-height: 1.6;
      max-width: none;
      margin: 0.75rem 0 0;
      text-align: justify;
      text-justify: inter-word;
      hyphens: auto;
      position: relative;
      z-index: 1;
    }

    .welcome-banner .meta {
      margin-top: 1.25rem;
      display: flex;
      gap: 1.75rem;
      font-size: 0.8125rem;
      position: relative;
      z-index: 1;
      flex-wrap: wrap;
    }

    .welcome-banner .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: rgba(255, 255, 255, 0.75);
    }

    .welcome-banner .meta-item i {
      color: var(--vericase-teal-light);
    }

    .welcome-banner .meta-item span {
      color: rgba(255, 255, 255, 0.9);
    }

    /* Quick Actions - Modernized Grid */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .action-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06), 0 1px 2px rgba(15, 23, 42, 0.04);
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-muted);
      position: relative;
      overflow: hidden;
    }

    .action-card:focus-visible {
      outline: 3px solid rgba(var(--vericase-teal-rgb), 0.22);
      outline-offset: 2px;
    }

    .action-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--vericase-teal), var(--vericase-teal-dark));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.2s ease;
    }

    .action-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.1), 0 4px 6px -2px rgba(15, 23, 42, 0.05);
      border-color: var(--vericase-teal);
    }

    .action-card:hover::before {
      transform: scaleX(1);
    }

    .action-card .icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--vericase-teal) 0%, var(--vericase-teal-dark) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 14px rgba(31, 111, 120, 0.2);
    }

    .action-card .icon i {
      opacity: 0.95;
    }

    .action-card .icon.icon--navy {
      background: linear-gradient(135deg, var(--vericase-navy) 0%, var(--vericase-navy-light) 100%);
    }

    .action-card .icon.icon--gold {
      background: linear-gradient(135deg, var(--vericase-gold) 0%, var(--vericase-gold-muted) 100%);
    }

    .action-card .icon.icon--error {
      background: linear-gradient(135deg, var(--error) 0%, var(--error-dark) 100%);
    }

    .action-card .icon.icon--purple {
      background: linear-gradient(135deg, #6b5fa1 0%, #534b82 100%);
    }

    .action-card .icon.icon--blue {
      background: linear-gradient(135deg, #4b6b8a 0%, #36506b 100%);
    }

    .action-card .icon.icon--rose {
      background: linear-gradient(135deg, #b45b6b 0%, #9a4556 100%);
    }

    .action-card .icon.icon--emerald {
      background: linear-gradient(135deg, #4f7c63 0%, #3f6450 100%);
    }

    /* Pastel background tints for action cards */
    .action-card.pastel-teal {
      background: linear-gradient(135deg, #f0f4f3 0%, #e3ebe8 100%);
    }

    .action-card.pastel-blue {
      background: linear-gradient(135deg, #f3f5f8 0%, #e7ecf2 100%);
    }

    .action-card.pastel-purple {
      background: linear-gradient(135deg, #f5f4f8 0%, #ebeaf1 100%);
    }

    .action-card.pastel-amber {
      background: linear-gradient(135deg, #f8f4ec 0%, #eee6d8 100%);
    }

    .action-card.pastel-rose {
      background: linear-gradient(135deg, #f6f2f2 0%, #eadfe1 100%);
    }

    .action-card.pastel-emerald {
      background: linear-gradient(135deg, #f3f7f4 0%, #e5ede7 100%);
    }

    .action-card.pastel-gold {
      background: linear-gradient(135deg, #f8f4ec 0%, #eee6d8 100%);
    }

    .action-card.pastel-slate {
      background: linear-gradient(135deg, #f6f7f9 0%, #e8ecef 100%);
    }

    .action-card.pastel-indigo {
      background: linear-gradient(135deg, #f2f4f7 0%, #e4e8f0 100%);
    }

    .action-card h3 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
      color: var(--vericase-navy);
    }

    .action-card p {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Feature Card - Premium gold-accented styling for VeriCase Refine */
    .action-card.feature-card {
      background: linear-gradient(135deg, #fdfcfa 0%, #f5f0e8 100%);
      border: 1.5px solid rgba(139, 115, 85, 0.35);
      box-shadow: 0 4px 20px rgba(139, 115, 85, 0.12);
    }

    .action-card.feature-card::before {
      transform: scaleX(1);
      background: linear-gradient(90deg, var(--vericase-gold), var(--vericase-teal));
      opacity: 0.85;
    }

    .action-card.feature-card h3 {
      color: var(--vericase-navy);
    }

    .action-card.feature-card p {
      color: var(--text-secondary);
    }

    .action-card.feature-card .icon {
      background: linear-gradient(135deg, #8b7355 0%, #a68b5b 100%);
      box-shadow: 0 6px 16px rgba(139, 115, 85, 0.25);
    }

    .action-card.feature-card:hover {
      box-shadow: 0 8px 28px rgba(139, 115, 85, 0.18);
      transform: translateY(-3px);
      border-color: rgba(139, 115, 85, 0.5);
    }

    /* Widgets Grid - Modernized */
    .widgets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }

    .widget {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06), 0 1px 2px rgba(15, 23, 42, 0.04);
      border: 1px solid var(--border-muted);
      transition: all 0.2s ease;
    }

    .widget:hover {
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      border-color: var(--border-default);
    }

    .widget h3 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--vericase-navy);
    }

    .widget h3 i {
      color: var(--vericase-teal);
      font-size: 1rem;
    }

    .stat-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem 1rem;
      background: var(--gray-50);
      border-radius: 8px;
      margin-bottom: 0.625rem;
    }

    .stat-card:last-child {
      margin-bottom: 0;
    }

    .stat-label {
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .stat-value {
      font-size: 1.375rem;
      font-weight: 700;
      color: var(--vericase-navy);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--vericase-teal), var(--vericase-teal-dark));
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .timeline {
      position: relative;
      padding-left: 1.75rem;
    }

    .timeline::before {
      content: "";
      position: absolute;
      left: 5px;
      top: 4px;
      bottom: 4px;
      width: 2px;
      background: var(--gray-200);
      border-radius: 1px;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 1.25rem;
      padding-bottom: 0.25rem;
    }

    .timeline-item:last-child {
      margin-bottom: 0;
    }

    .timeline-item::before {
      content: "";
      position: absolute;
      left: -1.625rem;
      top: 4px;
      width: 10px;
      height: 10px;
      background: var(--vericase-teal);
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 0 2px var(--vericase-teal);
    }

    .timeline-date {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .timeline-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--vericase-navy);
      margin-bottom: 0.125rem;
    }

    .timeline-desc {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .alert {
      padding: 0.875rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.625rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      font-size: 0.8125rem;
      border-left: 3px solid;
    }

    .alert i {
      flex-shrink: 0;
      margin-top: 2px;
    }

    .alert-warning {
      background: var(--warning-light);
      border-color: var(--warning);
      color: var(--warning-dark);
    }

    .alert-info {
      background: var(--vericase-teal-ghost);
      border-color: var(--vericase-teal);
      color: var(--vericase-teal-dark);
    }

    .alert-success {
      background: var(--success-light);
      border-color: var(--success);
      color: var(--success-dark);
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1.5rem;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 0.875rem;
      opacity: 0.4;
    }

    .empty-state p {
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.625rem;
      border-radius: 100px;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .badge-discovery {
      background: var(--info-light);
      color: var(--vericase-teal-dark);
    }

    .badge-progress {
      background: var(--warning-light);
      color: var(--warning-dark);
    }

    .badge-complete {
      background: var(--success-light);
      color: var(--success-dark);
    }

    .list-item {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .list-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .list-item-title {
      font-size: 0.875rem;
      color: var(--vericase-navy);
      font-weight: 500;
    }

    .list-item-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    /* Project Selector Panel */
    .project-selector-panel {
      background: white;
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
      border: 1px solid var(--border-muted);
    }

    .project-selector-panel select {
      padding: 0.625rem 1rem;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .project-selector-panel select:focus {
      outline: none;
      border-color: var(--vericase-teal);
      box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.1);
    }

    /* ============================================
         MOBILE RESPONSIVENESS
         ============================================ */

    @media (max-width: 1400px) {
      .quick-actions {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 1200px) {
      .quick-actions {
        grid-template-columns: repeat(3, 1fr);
      }

      .widgets-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 1024px) {
      .top-bar {
        padding: 0.75rem 1rem;
      }

      .top-bar-actions {
        gap: 0.375rem;
      }

      .top-bar-actions .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
      }

      /* Hide text on some buttons, show only icons */
      .top-bar-actions .btn.hide-text-mobile span {
        display: none;
      }

      .dashboard-container {
        padding: 1.5rem;
      }

      .welcome-banner {
        padding: 2rem;
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
      }

      .top-bar-actions {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }

      .top-bar-actions .btn-text {
        display: none;
      }

      .dashboard-container {
        padding: 1rem;
      }

      .welcome-banner {
        padding: 1.5rem;
        border-radius: 12px;
      }

      .welcome-banner h2 {
        font-size: var(--text-4xl);
      }

      .welcome-banner h2 .title-suffix {
        font-size: var(--text-xl);
      }

      .welcome-banner p {
        font-size: 0.9375rem;
      }

      .welcome-banner .meta {
        gap: 1rem;
        flex-direction: column;
      }

      .quick-actions {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .widgets-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .project-selector-panel {
        padding: 1rem;
      }

      .project-selector-panel>div:first-child {
        flex-direction: column;
        align-items: stretch !important;
      }

      .project-selector-panel select {
        max-width: 100% !important;
      }

      .project-selector-panel>div>div:last-child {
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .dashboard-container {
        padding: 0.75rem;
      }

      .welcome-banner {
        padding: 1.25rem;
      }

      .welcome-banner h2 {
        font-size: var(--text-3xl);
      }

      .welcome-banner h2 .title-suffix {
        font-size: var(--text-lg);
      }

      .action-card {
        padding: 1.25rem;
      }

      .action-card .icon {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }

      .widget {
        padding: 1.25rem;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      animation: modalFadeIn 0.3s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border-default);
    }

    .modal-header h2 {
      margin: 0;
      color: var(--text-primary);
    }

    .close {
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      transition: color 0.2s;
    }

    .close:hover {
      color: var(--text-primary);
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
  <script src="config.js"></script>
  <script src="app-state.js"></script>
</head>

<body>
  <!-- Subtle background pattern -->
  <div class="bg-pattern"></div>

  <div class="top-bar">
    <h1>
      <img src="/ui/assets/LOGOTOBEUSED.png" alt="VeriCase" class="logo-img" />
      <span id="profileName">Overview</span>
    </h1>
    <div class="top-bar-actions">
      <button class="btn btn-secondary" onclick="window.location.href = 'control-centre.html'" title="Control Centre">
        <i class="fas fa-th-large"></i>
        <span class="btn-text">Control Centre</span>
      </button>
      <button class="btn btn-primary" id="uploadBtn" onclick="openPstUpload()">
        <i class="fas fa-cloud-arrow-up"></i>
        <span class="btn-text">Upload</span>
      </button>
      <button class="btn btn-gold" onclick="openAnalysis()"
        title="Deep Research & Analysis">
        <i class="fas fa-microscope"></i>
        <span class="btn-text">Research</span>
      </button>
      <button class="btn btn-secondary" onclick="showSettings()" title="Settings">
        <i class="fas fa-gear"></i>
      </button>
      <button class="btn btn-secondary" id="adminApprovalBtn" onclick="window.location.href = 'admin-approvals.html'"
        style="display: none" title="Pending Approvals">
        <i class="fas fa-user-check"></i>
        <span id="pendingBadge"></span>
      </button>
      <button class="btn btn-secondary" id="adminSettingsBtn" onclick="window.location.href = 'admin-settings.html'"
        style="display: none" title="Admin Settings">
        <i class="fas fa-sliders"></i>
      </button>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Welcome Banner -->
	    <div class="welcome-banner" id="welcomeBanner">
	      <h2 id="welcomeTitle"><span class="title-accent">Overview</span> <span class="title-suffix" id="projectTitleSuffix"></span></h2>
	      <p id="welcomeMessage">
	        Organize, analyze, and extract insights from your evidence.
	      </p>
      <div class="meta">
        <div class="meta-item">
          <i class="fas fa-calendar"></i>
          <span id="createdDate">Created —</span>
        </div>
        <div class="meta-item">
          <i class="fas fa-briefcase"></i>
          <span id="profileType">Project</span>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <div class="action-card pastel-teal" onclick="openPstUpload()">
        <div class="icon">
          <i class="fas fa-cloud-arrow-up"></i>
        </div>
        <h3>Upload Evidence</h3>
        <p>Import PSTs, emails, and documents into the repository</p>
      </div>

      <div class="action-card pastel-amber" onclick="viewEvidenceRepository()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();viewEvidenceRepository();}" tabindex="0" role="button">
        <div class="icon icon--gold">
          <i class="fas fa-folder-tree"></i>
        </div>
        <h3>Evidence &amp; Files</h3>
        <p>Browse, tag, and link documents to correspondence</p>
      </div>

      <div class="action-card pastel-blue" onclick="viewCorrespondence()">
        <div class="icon icon--blue">
          <i class="fas fa-envelope-open-text"></i>
        </div>
        <h3>Correspondence</h3>
        <p>Search and review all project emails</p>
      </div>

      <div class="action-card pastel-purple" onclick="openAnalysis()">
        <div class="icon icon--purple">
          <i class="fas fa-microscope"></i>
        </div>
        <h3>VeriCase Analysis</h3>
        <p>AI-powered deep research &amp; investigation</p>
      </div>

        <div class="action-card pastel-slate" onclick="viewChronology()">
          <div class="icon icon--navy">
            <i class="fas fa-list-check"></i>
          </div>
          <h3>The Chronology Lense&trade;</h3>
          <p>Create detailed event-by-event narratives</p>
        </div>

        <div class="action-card pastel-emerald" onclick="viewProgramme()">
          <div class="icon icon--emerald">
          <i class="fas fa-sitemap"></i>
        </div>
        <h3>Programme</h3>
        <p>Track schedules, milestones & deliverables</p>
      </div>

      <div class="action-card pastel-rose" onclick="viewDelays()">
        <div class="icon icon--rose">
          <i class="fas fa-hourglass-half"></i>
        </div>
        <h3>The Delay Ripple</h3>
        <p>Identify causes and quantify impacts</p>
      </div>

      <div class="action-card feature-card" onclick="openAIRefinement()">
        <div class="icon">
          <i class="fas fa-magnifying-glass"></i>
        </div>
        <h3>VeriCase Refine</h3>
        <p>AI-powered spam filtering & deduplication</p>
      </div>
    </div>

    <!-- Widgets Grid -->
    <div class="widgets-grid">
      <!-- Evidence Status Widget -->
      <div class="widget">
        <h3>
          <i class="fas fa-database"></i> Evidence Status
          <a class="btn btn-secondary widget-link" style="margin-left: auto; padding: 6px 12px; font-size: 12px" data-link="evidence.html" href="evidence.html">
            <i class="fas fa-arrow-up-right-from-square"></i> Open
          </a>
        </h3>
        <div id="evidenceStatus">
          <div class="stat-card">
            <div>
              <div class="stat-label">Documents Uploaded</div>
              <div class="progress-bar">
                <div class="progress-fill" id="documentsUploadedProgress" style="width: 0"></div>
              </div>
            </div>
            <div class="stat-value" id="documentsUploadedCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Emails Processed</div>
            <div class="stat-value" id="emailsProcessedCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Keywords Tagged</div>
            <div class="stat-value" id="keywordCount">0</div>
          </div>
        </div>
      </div>

      <!-- Alerts & Deadlines Widget -->
      <div class="widget">
        <h3>
          <i class="fas fa-bell"></i> Alerts & Deadlines
          <a class="btn btn-secondary widget-link" style="margin-left: auto; padding: 6px 12px; font-size: 12px" data-link-project="project-setup.html" data-link-case="case-setup.html" href="project-setup.html">
            <i class="fas fa-gear"></i> Manage
          </a>
        </h3>
        <div id="alertsContainer">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>
              <strong>Getting Started</strong><br />
              Upload your first evidence source to begin analysis
            </div>
          </div>
        </div>
      </div>

      <!-- Chronology / Recent Activity Widget -->
      <div class="widget">
        <h3>
          <i class="fas fa-clock"></i> Project Chronology
          <a class="btn btn-secondary widget-link" style="margin-left: auto; padding: 6px 12px; font-size: 12px" data-link="chronology-lense.html" href="chronology-lense.html">
            <i class="fas fa-arrow-up-right-from-square"></i> Open
          </a>
          <button class="btn btn-secondary" style="margin-left: 10px; padding: 6px 12px; font-size: 12px"
            onclick="event.stopPropagation(); openChronologyPrompt()">
            <i class="fas fa-timeline"></i> Build
          </button>
        </h3>
        <div id="activityFeed">
          <div class="timeline" id="chronologyTimeline">
            <div class="timeline-item">
              <div class="timeline-date">Just now</div>
              <div class="timeline-title">Profile Created</div>
              <div class="timeline-desc" id="profileCreatedDesc">
                Project setup completed
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Heads of Claim / Project Progress Widget -->
      <div class="widget" id="headsWidget">
        <h3>
          <i class="fas fa-list-check"></i>
          <span id="headsTitle">Heads of Claim</span>
          <a class="btn btn-secondary widget-link" style="margin-left: auto; padding: 6px 12px; font-size: 12px" data-link-project="programme.html" data-link-case="contentious-matters.html" href="programme.html">
            <i class="fas fa-arrow-up-right-from-square"></i> Manage
          </a>
        </h3>
        <div id="headsContent">
          <div class="empty-state">
            <i class="fas fa-clipboard-list"></i>
            <p>No claims defined yet</p>
          </div>
        </div>
      </div>

      <!-- Stakeholders Widget -->
      <div class="widget">
        <h3>
          <i class="fas fa-id-badge"></i> Key Stakeholders
          <a class="btn btn-secondary widget-link" style="margin-left: auto; padding: 6px 12px; font-size: 12px" data-link="stakeholders.html" href="stakeholders.html">
            <i class="fas fa-arrow-up-right-from-square"></i> Manage
          </a>
        </h3>
        <div id="stakeholdersContent">
          <div class="empty-state">
            <i class="fas fa-user-friends"></i>
            <p>Loading stakeholders...</p>
          </div>
        </div>
      </div>

      <!-- Quick Stats Widget -->
      <div class="widget">
        <h3>
          <i class="fas fa-chart-pie"></i> Quick Stats
          <a class="btn btn-secondary widget-link" style="margin-left: auto; padding: 6px 12px; font-size: 12px" data-link="vericase-analysis.html" href="vericase-analysis.html">
            <i class="fas fa-arrow-up-right-from-square"></i> Open Analysis
          </a>
        </h3>
        <div id="quickStats">
          <div class="list-item">
            <div>
              <div class="list-item-title">Evidence Sources</div>
              <div class="list-item-meta">Uploaded files and systems</div>
            </div>
            <div class="stat-value" id="quickEvidenceSourcesCount" style="font-size: 20px">0</div>
          </div>
          <div class="list-item">
            <div>
              <div class="list-item-title">Team Members</div>
              <div class="list-item-meta">Collaborators on this matter</div>
            </div>
            <div class="stat-value" id="quickTeamMembersCount" style="font-size: 20px">0</div>
          </div>
          <div class="list-item">
            <div>
              <div class="list-item-title">Analysis Ready</div>
              <div class="list-item-meta">
                Evidence processed and searchable
              </div>
            </div>
            <div class="stat-value" id="quickAnalysisReadyPercent" style="font-size: 20px">0%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Note: VeriCaseApp is initialized later (DOMContentLoaded) in strict mode.

    // Chronology launcher – always pulls from email correspondence for this project
    async function openChronologyPrompt() {
      const focus = prompt(
        "What do you want to build a chronology on?\n\nFor example: late design approvals, crane delays, prolongation costs.",
      );
      if (!focus || !focus.trim()) {
        return;
      }
      await runChronologyAnalysis(focus.trim());
    }

    async function runChronologyAnalysis(focus) {
      try {
        const contextId = profileId || (window.VeriCaseApp ? window.VeriCaseApp.getContextId() : null);
        const contextType = profileType || (window.VeriCaseApp ? window.VeriCaseApp.getContextType() : "project");

        if (!contextId) {
          alert("No active profile found. Select a case or project first.");
          return;
        }

        const body = {
          query: `Using only the email correspondence for this ${contextType}, build a detailed chronology of: ${focus}`,
          mode: "deep",
          project_id: contextType === "project" ? contextId : null,
          case_id: contextType === "case" ? contextId : null,
        };

        const response = await fetch(`${apiUrl}/api/ai-chat/query`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify(body),
        });

        if (!response.ok) {
          console.error(
            "Chronology request failed",
            response.status,
            await response.text(),
          );
          alert(
            "Sorry, I couldn't build the chronology from the correspondence. Please try again.",
          );
          return;
        }

        const data = await response.json();
        const events = Array.isArray(data.chronology_events)
          ? data.chronology_events
          : [];
        renderChronologyTimeline(events, focus);
      } catch (err) {
        console.error("Chronology error", err);
        alert(
          "Error running chronology analysis. Check the console for details.",
        );
      }
    }

    function renderChronologyTimeline(events, focusLabel) {
      const container = document.getElementById("chronologyTimeline");
      if (!container) {
        return;
      }

      container.innerHTML = "";

      if (!events.length) {
        container.innerHTML = `<div class="timeline-item">
                        <div class="timeline-date">No events found</div>
                        <div class="timeline-title">No chronology available</div>
                        <div class="timeline-desc">Try a different description or upload and process more email correspondence.</div>
                    </div>`;
        return;
      }

      // Normalise and sort by date if possible
      const normalised = events.map((ev) => {
        const dateValue = ev.date || ev.event_date || ev.when || "";
        const titleValue = ev.title || ev.event || ev.summary || "";
        const descValue =
          ev.description || ev.details || ev.explanation || ev.reason || "";

        let parsedDate = null;
        if (dateValue) {
          const d = new Date(dateValue);
          if (!isNaN(d.getTime())) {
            parsedDate = d;
          }
        }

        return {
          raw: ev,
          dateLabel: parsedDate
            ? parsedDate.toLocaleDateString(undefined, {
              year: "numeric",
              month: "short",
              day: "numeric",
            })
            : typeof dateValue === "string"
              ? dateValue
              : "",
          sortKey: parsedDate
            ? parsedDate.getTime()
            : Number.MAX_SAFE_INTEGER,
          title: titleValue || "Untitled event",
          description: descValue || "",
        };
      });

      normalised.sort((a, b) => a.sortKey - b.sortKey);

      normalised.forEach((item) => {
        const el = document.createElement("div");
        el.className = "timeline-item";
        el.innerHTML = `
                    <div class="timeline-date">${item.dateLabel || ""}</div>
                    <div class="timeline-title">${item.title}</div>
                    <div class="timeline-desc">${item.description}</div>
                `;
        container.appendChild(el);
      });
    }

    // Define navigation functions first (before DOMContentLoaded)
    async function openPstUpload() {
      // Guard: require an explicit selected profile before uploading.
      if (!profileId) {
        window.location.href = "master-dashboard.html";
        return;
      }

      // Ensure shared app-state matches the current dashboard context.
      try {
        if (window.VeriCaseApp && typeof window.VeriCaseApp.init === "function") {
          await window.VeriCaseApp.init({
            strict: true,
            createDefaultProject: false,
            allowLegacyProjectIdAsCaseId: false,
            contextType: profileType,
            contextId: String(profileId),
          });
        }
      } catch {
        // ignore
      }

      window.VeriCaseApp.gotoUpload();
    }

    function showQuickProfileDialog() {
      const modal = document.createElement("div");
      modal.style.cssText =
        "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;";

      const content = document.createElement("div");
      content.style.cssText =
        "background: white; border-radius: 16px; padding: 2.5rem; max-width: 550px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);";

      content.innerHTML = `
                <h3 style="color: var(--vericase-navy); margin: 0 0 0.75rem 0; font-size: 1.5rem;">
                    <i class="fas fa-rocket" style="color: var(--vericase-teal);"></i> Quick Start
                </h3>
                <p style="color: var(--text-secondary); margin: 0 0 2rem 0; line-height: 1.6;">
                    Get started immediately! Choose how to set up your profile:
                </p>

                <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                    <div onclick="createQuickProfile()" style="padding: 1.5rem; border: 2px solid var(--vericase-teal); border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, rgba(var(--vericase-teal-rgb), 0.05) 0%, rgba(var(--vericase-teal-rgb), 0.1) 100%); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 20px rgba(var(--vericase-teal-rgb), 0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                        <h4 style="color: var(--vericase-navy); margin: 0 0 0.5rem 0; font-size: 1.1rem;">
                            <i class="fas fa-bolt" style="color: var(--vericase-teal);"></i> Quick Setup (Instant)
                        </h4>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem;">
                            Creates a basic profile instantly so you can start uploading. Refine details later.
                        </p>
                        <div style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: var(--vericase-teal); color: white; border-radius: 8px; display: inline-block; font-size: 0.75rem; font-weight: 600;">
                            ⚡ RECOMMENDED
                        </div>
                    </div>

                    <div onclick="document.getElementById('quickProfileModal').remove(); window.location.href='workspace-setup.html'" style="padding: 1.5rem; border: 2px solid var(--border-default); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--vericase-teal)'; this.style.background='var(--gray-50)'" onmouseout="this.style.borderColor='var(--border-default)'; this.style.background=''">
                        <h4 style="color: var(--vericase-navy); margin: 0 0 0.5rem 0; font-size: 1.1rem;">
                            <i class="fas fa-layer-group"></i> Workspace Setup
                        </h4>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem;">
                            Configure everything in one place: team members, keywords, deadlines, and more.
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button onclick="document.getElementById('quickProfileModal').remove()" class="btn btn-secondary">
                        Cancel
                    </button>
                </div>
            `;

      modal.id = "quickProfileModal";
      modal.appendChild(content);
      document.body.appendChild(modal);

      // Close on background click
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    async function createQuickProfile() {
      const modal = document.getElementById("quickProfileModal");
      const content = modal.querySelector("div > div");

      // Show loading state
      content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--vericase-teal); margin-bottom: 1rem;"></i>
                    <h3 style="color: var(--vericase-navy); margin: 0 0 0.5rem 0;">Creating your profile...</h3>
                    <p style="color: var(--text-secondary); margin: 0;">This will only take a moment</p>
                </div>
            `;

      try {
        const timestamp = Date.now();
        // Set date range from 2010 to current date
        const startDate = "2010-01-01";
        const today = new Date();
        const completionDate = today.toISOString().split("T")[0]; // YYYY-MM-DD format

        const projectData = {
          project_name: `Quick Start Project`,
          project_code: `QUICK-${timestamp}`,
          start_date: startDate,
          completion_date: completionDate,
          contract_type: null,
          stakeholders: [],
          keywords: [],
        };

        const response = await fetch(`${apiUrl}/api/projects`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: JSON.stringify(projectData),
        });

        if (!response.ok) {
          throw new Error("Failed to create profile");
        }

        const result = await response.json();

        // Update VeriCaseApp state
        VeriCaseApp.projectId = result.id;
        VeriCaseApp.projectName = result.project_name;

        // Persist project selection for the shell + state manager
        try {
          localStorage.setItem("profileType", "project");
          localStorage.setItem("currentProjectId", String(result.id));
          localStorage.setItem("vericase_current_project", String(result.id));
          localStorage.setItem("projectId", String(result.id));
          if (result.project_name) {
            localStorage.setItem("currentProjectName", String(result.project_name));
            localStorage.setItem("vericase_current_project_name", String(result.project_name));
          }
        } catch {
          // ignore
        }

        // Show success and redirect
        content.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--vericase-navy); margin: 0 0 0.5rem 0;">Profile created!</h3>
                        <p style="color: var(--text-secondary); margin: 0;">Redirecting to upload...</p>
                    </div>
                `;

        setTimeout(() => {
          modal.remove();
          VeriCaseApp.gotoUpload();
        }, 800);
      } catch (error) {
        console.error("Error creating quick profile:", error);
        content.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: var(--error); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--vericase-navy); margin: 0 0 0.5rem 0;">Unable to create profile</h3>
                        <p style="color: var(--text-secondary); margin: 0 0 1.5rem 0;">Please try using Workspace Setup instead.</p>
                        <button onclick="window.location.href='workspace-setup.html'" class="btn btn-primary">
                            Open Workspace Setup
                        </button>
                    </div>
                `;
      }
    }

    function viewCorrespondence() {
      VeriCaseApp.gotoCorrespondence();
    }

    function viewEvidenceRepository() {
      VeriCaseApp.gotoEvidence();
    }

    function manageStakeholders() {
      const url = new URL("stakeholders.html", window.location.href);
      if (profileId) {
        const key = profileType === "case" ? "caseId" : "projectId";
        url.searchParams.set(key, profileId);
      }
      window.location.href = url.toString();
    }

    function viewTimeline() {
      const url = new URL("project-timeline.html", window.location.href);
      if (profileId) {
        const key = profileType === "case" ? "caseId" : "projectId";
        url.searchParams.set(key, profileId);
      }
      window.location.href = url.toString();
    }

    function viewProgramme() {
      const url = new URL("programme.html", window.location.href);
      if (profileId) {
        const key = profileType === "case" ? "caseId" : "projectId";
        url.searchParams.set(key, profileId);
      }
      window.location.href = url.toString();
    }

    function viewDelays() {
      const url = new URL("delays.html", window.location.href);
      if (profileId) {
        const key = profileType === "case" ? "caseId" : "projectId";
        url.searchParams.set(key, profileId);
      }
      window.location.href = url.toString();
    }

    function viewChronology() {
      const url = new URL("chronology-lense.html", window.location.href);
      if (profileId) {
        const key = profileType === "case" ? "caseId" : "projectId";
        url.searchParams.set(key, profileId);
      }
      window.location.href = url.toString();
    }

    function openProfileSetup() {
      if (profileType === "case") {
        const url = new URL("case-setup.html", window.location.href);
        if (profileId) {
          url.searchParams.set("caseId", profileId);
        }
        window.location.href = url.toString();
        return;
      }
      const url = new URL("project-setup.html", window.location.href);
      if (profileId) {
        url.searchParams.set("projectId", profileId);
      }
      window.location.href = url.toString();
    }

    function openHeadsModule() {
      if (profileType === "case") {
        const url = new URL("contentious-matters.html", window.location.href);
        if (profileId) {
          url.searchParams.set("caseId", profileId);
        }
        window.location.href = url.toString();
        return;
      }
      viewProgramme();
    }

    function openAnalysis() {
      const url = new URL("vericase-analysis.html", window.location.href);
      if (profileId) {
        const key = profileType === "case" ? "caseId" : "projectId";
        url.searchParams.set(key, profileId);
      }
      window.location.href = url.toString();
    }

    function updateWidgetLinks() {
      const links = document.querySelectorAll("a.widget-link");
      if (!links.length) return;

      links.forEach((link) => {
        const caseLink = link.getAttribute("data-link-case");
        const projectLink = link.getAttribute("data-link-project");
        const defaultLink = link.getAttribute("data-link") || link.getAttribute("href");

        let target = defaultLink;
        if (profileType === "case" && caseLink) {
          target = caseLink;
        } else if (profileType !== "case" && projectLink) {
          target = projectLink;
        }

        if (!target) return;
        const url = new URL(target, window.location.href);
        if (profileId) {
          const key = profileType === "case" ? "caseId" : "projectId";
          url.searchParams.set(key, profileId);
        }
        link.href = url.toString();
      });
    }

    // Lazy-loaded settings modal (deferred DOM creation for faster initial page load)
    let settingsModalLoaded = false;

    function showSettings(tab = "general") {
      // Lazy load the settings modal on first open
      if (!settingsModalLoaded) {
        loadSettingsModal();
        settingsModalLoaded = true;
      }
      document.getElementById("settingsModal").style.display = "flex";
      showSettingsTab(tab);
      loadAIStatus();
    }

    function closeSettings() {
      document.getElementById("settingsModal").style.display = "none";
    }

    function loadSettingsModal() {
      // Create settings modal HTML dynamically on first use
      const modalContainer = document.getElementById(
        "settingsModalContainer",
      );
      if (!modalContainer) return;
      modalContainer.innerHTML = window.SETTINGS_MODAL_HTML || "";
    }

    function showSettingsTab(tab) {
      // Hide all tabs
      document
        .querySelectorAll(".settings-tab-content")
        .forEach((t) => (t.style.display = "none"));
      document
        .querySelectorAll(".settings-tab-btn")
        .forEach((b) => b.classList.remove("active"));

      // Show selected tab
      document.getElementById(`${tab}Tab`).style.display = "block";
      document.querySelector(`[data-tab="${tab}"]`).classList.add("active");
    }

    async function loadAIStatus() {
      try {
        const response = await fetch(`${apiUrl}/api/ai/status`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {},
        });

        if (response.ok) {
          const status = await response.json();
          updateAIStatusDisplay(status);
        }
      } catch (error) {
        console.error("Error loading AI status:", error);
      }
    }

    function updateAIStatusDisplay(status) {
      const providers = [
        "openai",
        "anthropic",
        "gemini",
        "perplexity",
      ];
      providers.forEach((provider) => {
        const indicator = document.getElementById(`${provider}Status`);
        if (indicator) {
          indicator.className = `status-indicator ${status[provider] ? "status-active" : "status-inactive"}`;
          indicator.title = status[provider]
            ? "Configured"
            : "Not configured";
        }
      });

      const overallStatus = document.getElementById("aiOverallStatus");
      if (overallStatus) {
        if (status.any_available) {
          overallStatus.innerHTML =
            '<i class="fas fa-check-circle" style="color: var(--success);"></i> AI services are configured and ready';
        } else {
          overallStatus.innerHTML =
            '<i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> No AI services configured - some features will be unavailable';
        }
      }
    }

    async function openAIRefinement() {
      const profileId =
        localStorage.getItem("vericase_current_project") ||
        localStorage.getItem("currentProjectId") ||
        localStorage.getItem("currentCaseId");
      const profileType = localStorage.getItem("profileType") || "project";

      if (!profileId) {
        showContextualError(
          "No Profile Selected",
          "You need to create a profile before using AI refinement. Would you like to create one now?",
          [
            {
              text: "Create Profile (Manual)",
              action: () => (window.location.href = "workspace-setup.html"),
            },
            {
              text: "Open Workspace Setup",
              action: () => (window.location.href = "workspace-setup.html"),
            },
            { text: "Cancel", action: null },
          ],
        );
        return;
      }

      // Check if AI is configured
      try {
        const response = await fetch(`${apiUrl}/api/ai/status`, {
          headers: token ? { Authorization: `Bearer ${token}` } : {},
        });

        if (response.ok) {
          const status = await response.json();
          if (!status.any_available) {
            showContextualError(
              "AI Not Configured",
              "AI refinement requires AI services to be configured. Please configure at least one AI provider in settings.",
              [
                { text: "Open Settings", action: () => showSettings("ai") },
                { text: "Cancel", action: null },
              ],
            );
            return;
          }
        }
      } catch (error) {
        console.error("Error checking AI status:", error);
      }

      const key = profileType === "case" ? "caseId" : "projectId";
      window.location.href = `ai-refinement-wizard.html?${key}=${encodeURIComponent(profileId)}`;
    }

    function showContextualError(title, message, actions) {
      const modal = document.createElement("div");
      modal.style.cssText =
        "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;";

      const content = document.createElement("div");
      content.style.cssText =
        "background: white; border-radius: 12px; padding: 2rem; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);";

      content.innerHTML = `
                <h3 style="color: var(--vericase-navy); margin: 0 0 1rem 0; font-size: 1.25rem;">
                    <i class="fas fa-exclamation-circle" style="color: var(--warning);"></i> ${title}
                </h3>
                <p style="color: var(--text-secondary); margin: 0 0 1.5rem 0;">${message}</p>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    ${actions
          .map(
            (action, idx) => `
                        <button
                            class="btn ${idx === 0 ? "btn-primary" : "btn-secondary"}"
                            onclick="document.getElementById('contextualErrorModal').remove(); ${action.action ? "arguments[0]()" : ""}"
                            ${action.action ? `data-action="${idx}"` : ""}
                        >
                            ${action.text}
                        </button>
                    `,
          )
          .join("")}
                </div>
            `;

      modal.id = "contextualErrorModal";
      modal.appendChild(content);
      document.body.appendChild(modal);

      // Attach action handlers
      actions.forEach((action, idx) => {
        if (action.action) {
          const btn = content.querySelector(`[data-action="${idx}"]`);
          if (btn) {
            btn.onclick = () => {
              modal.remove();
              action.action();
            };
          }
        }
      });

      // Close on background click
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const urlProjectId = urlParams.get("projectId");
    const urlCaseId = urlParams.get("caseId");

    // Determine active profile scope.
    // Priority:
    //  - Explicit URL param (caseId > projectId)
    //  - Stored profileType
    let profileType = urlCaseId
      ? "case"
      : urlProjectId
        ? "project"
        : localStorage.getItem("profileType") || "project";

    let profileId = urlCaseId || urlProjectId;
    const isFirstTime = urlParams.get("firstTime") === "true";

    // Keep localStorage consistent with explicit URL scope (important for nav-shell/app-state).
    try {
      if (urlCaseId) {
        localStorage.setItem("profileType", "case");
        localStorage.setItem("currentCaseId", String(urlCaseId));
        localStorage.setItem("caseId", String(urlCaseId));
      } else if (urlProjectId) {
        localStorage.setItem("profileType", "project");
        localStorage.setItem("vericase_current_project", String(urlProjectId));
        localStorage.setItem("currentProjectId", String(urlProjectId));
        localStorage.setItem("projectId", String(urlProjectId));
      }
    } catch {
      // ignore
    }

    // Fallbacks: grab stored IDs when URL param is missing
    if (!profileId) {
      const storedId =
        profileType === "project"
          ? localStorage.getItem("vericase_current_project") ||
            localStorage.getItem("currentProjectId") ||
            localStorage.getItem("projectId")
          : localStorage.getItem("currentCaseId") ||
            localStorage.getItem("caseId");
      if (storedId) profileId = storedId;
    }

    // Load token (support newer vericase_token key, plus legacy keys)
    const token =
      urlParams.get("token") ||
      localStorage.getItem("vericase_token") ||
      localStorage.getItem("token") ||
      localStorage.getItem("jwt");

    // Use centralized configuration
    const apiUrl = window.VeriCaseConfig
      ? window.VeriCaseConfig.apiUrl
      : window.location.origin;
    console.log("Dashboard using API URL:", apiUrl);

    let evidenceStatsCache = null;
    let emailCountCache = null;
    let stakeholderCountCache = null;

    function updateEvidenceStatusWidget() {
      const docsEl = document.getElementById("documentsUploadedCount");
      const progressEl = document.getElementById("documentsUploadedProgress");
      const emailEl = document.getElementById("emailsProcessedCount");

      if (!docsEl || !progressEl || !emailEl) return;

      const total = evidenceStatsCache?.total ?? 0;
      const linked = evidenceStatsCache?.with_correspondence ?? 0;
      const progress = total > 0 ? Math.round((linked / total) * 100) : 0;

      docsEl.textContent = total.toLocaleString();
      emailEl.textContent = (emailCountCache ?? 0).toLocaleString();
      progressEl.style.width = `${Math.min(100, Math.max(0, progress))}%`;
    }

    function updateQuickStatsWidget() {
      const evidenceEl = document.getElementById("quickEvidenceSourcesCount");
      const teamEl = document.getElementById("quickTeamMembersCount");
      const analysisEl = document.getElementById("quickAnalysisReadyPercent");
      if (!evidenceEl || !teamEl || !analysisEl) return;

      const total = evidenceStatsCache?.total ?? 0;
      const linked = evidenceStatsCache?.with_correspondence ?? 0;
      const analysisPct = total > 0 ? Math.round((linked / total) * 100) : 0;

      evidenceEl.textContent = total.toLocaleString();
      teamEl.textContent = (stakeholderCountCache ?? 0).toLocaleString();
      analysisEl.textContent = `${analysisPct}%`;
    }

    // Upload button is always enabled - quick profile creation handles missing profileId

    // Load all projects for the selector
    async function loadProjects() {
      try {
        const headers = token ? { Authorization: `Bearer ${token}` } : {};
        const response = await fetch(`${apiUrl}/api/projects`, { headers });
        if (!response.ok) throw new Error("Failed to load projects");

        const projects = await response.json();
        const selector = document.getElementById("projectSelector");

        // Prefer last-selected project over auto-selecting the first one.
        if (!profileId) {
          const storedPreferredId =
            localStorage.getItem("vericase_current_project") ||
            localStorage.getItem("currentProjectId") ||
            localStorage.getItem("projectId");
          if (storedPreferredId) profileId = storedPreferredId;
        }

        if (!projects || projects.length === 0) {
          selector.innerHTML =
            '<option value="">No projects found - Create one first</option>';
          return;
        }

        // Build options
        let options = '<option value="">-- Select a Project --</option>';
        projects.forEach((p) => {
          const selected = String(p.id) === String(profileId) ? "selected" : "";
          const name = p.project_name || p.name || "Unnamed Project";
          options += `<option value="${p.id}" ${selected}>${name}</option>`;
        });
        selector.innerHTML = options;

        // If a project is already selected (URL/localStorage), reflect it and load stats.
        if (profileId) {
          const selectedProject = projects.find(
            (p) => String(p.id) === String(profileId),
          );
          if (selectedProject) {
            selector.value = profileId;
            const selectedName =
              selectedProject.project_name ||
              selectedProject.name ||
              "Unnamed Project";
            localStorage.setItem("currentProjectId", profileId);
            localStorage.setItem("vericase_current_project", profileId); // Standardized key for nav-shell
            localStorage.setItem("profileType", "project");
            localStorage.setItem("currentProjectName", selectedName);
            localStorage.setItem("vericase_current_project_name", selectedName);
            document.getElementById("profileName").textContent = selectedName;
          }

          // Load stats for current project
          loadProjectStats(profileId);
        }

        updateWidgetLinks();
      } catch (error) {
        console.error("Error loading projects:", error);
        document.getElementById("projectSelector").innerHTML =
          '<option value="">Error loading projects</option>';
      }
    }

    // Handle project selection
    async function onProjectSelected(projectId) {
      if (!projectId) {
        document.getElementById("projectStats").style.display = "none";
        return;
      }

      // Update localStorage and global variable
      profileId = projectId;
      localStorage.setItem("currentProjectId", projectId);
      localStorage.setItem("vericase_current_project", projectId); // Standardized key for nav-shell
      localStorage.setItem("profileType", "project");

      // Keep URL in sync so the shell doesn't keep using the old projectId
      // (sidebar name + built hrefs prefer URL params).
      try {
        const url = new URL(window.location.href);
        url.searchParams.set("projectId", projectId);
        url.searchParams.delete("caseId");
        window.history.replaceState({}, "", url.toString());
      } catch {
        // ignore
      }

      updateWidgetLinks();

      // Update profile name in header
      const selector = document.getElementById("projectSelector");
      const selectedOption = selector.options[selector.selectedIndex];
      if (selectedOption) {
        const projectName = (selectedOption.text || "").trim();
        document.getElementById("profileName").textContent = projectName;
        localStorage.setItem("currentProjectName", projectName);
        localStorage.setItem("vericase_current_project_name", projectName);

        // Sync the sidebar label + refresh nav hrefs immediately (no reload)
        if (window.VericaseShell && typeof window.VericaseShell.setProjectContext === "function") {
          window.VericaseShell.setProjectContext({ projectId, projectName });
        } else {
          const sidebarNameEl = document.getElementById("currentProjectName");
          if (sidebarNameEl) sidebarNameEl.textContent = projectName;
        }

        // Update banner title immediately (API may be slow/unauthorized)
        const welcomeTitle = document.getElementById("welcomeTitle");
        if (welcomeTitle) {
          welcomeTitle.innerHTML = "";
          const accent = document.createElement("span");
          accent.className = "title-accent";
          accent.textContent = "Project Overview";
          welcomeTitle.appendChild(accent);
          const suffix = document.createElement("span");
          suffix.className = "title-suffix";
          suffix.textContent = projectName;
          welcomeTitle.appendChild(suffix);
        }

        // Default created date to today until we fetch the project's created_at
        const createdDateEl = document.getElementById("createdDate");
        if (createdDateEl) {
          const todayLabel = new Date().toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
          createdDateEl.textContent = `Created ${todayLabel}`;
        }
      }

      // Load project stats
      loadProjectStats(projectId);

      // Load profile data for the widgets
      loadProfileData();
    }

    // Load project statistics (parallel API calls for speed)
    async function loadProjectStats(projectId) {
      try {
        // Fetch email count (using lightweight count endpoint) and project details in parallel
        const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};

        const [emailResponse, projectResponse] = await Promise.all([
          fetch(
            `${apiUrl}/api/correspondence/emails/count?project_id=${projectId}`,
            { headers: authHeaders },
          ),
          fetch(`${apiUrl}/api/projects/${projectId}`, {
            headers: authHeaders,
          }),
        ]);

        if (emailResponse.ok) {
          const emailData = await emailResponse.json();
          emailCountCache = emailData.count || 0;
          document.getElementById("emailCount").textContent =
            emailCountCache;
          updateEvidenceStatusWidget();
          updateQuickStatsWidget();
        } else {
          emailCountCache = 0;
          updateEvidenceStatusWidget();
          updateQuickStatsWidget();
        }

        if (projectResponse.ok) {
          const project = await projectResponse.json();
          document.getElementById("projectCreated").textContent =
            project.created_at
              ? new Date(project.created_at).toLocaleDateString()
              : "-";

          // Banner meta date
          const createdDateEl = document.getElementById("createdDate");
          if (createdDateEl) {
            const createdLabel = project.created_at
              ? new Date(project.created_at).toLocaleDateString(undefined, {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
              : new Date().toLocaleDateString(undefined, {
                year: "numeric",
                month: "short",
                day: "numeric",
              });
            createdDateEl.textContent = `Created ${createdLabel}`;
          }

          // Banner title: "Project Dashboard" with project name below
          const projectName =
            project.project_name ||
            project.name ||
            localStorage.getItem("currentProjectName") ||
            "";
          if (projectName) {
            const projectTitleSuffix = document.getElementById("projectTitleSuffix");
            if (projectTitleSuffix) {
              projectTitleSuffix.textContent = projectName;
            }
          }
        } else {
          // If unauthorized/unavailable, still show best-known project name + today's date.
          const createdDateEl = document.getElementById("createdDate");
          if (createdDateEl && createdDateEl.textContent.trim() === "Created —") {
            const todayLabel = new Date().toLocaleDateString(undefined, {
              year: "numeric",
              month: "short",
              day: "numeric",
            });
            createdDateEl.textContent = `Created ${todayLabel}`;
          }

          const fallbackName =
            localStorage.getItem("currentProjectName") ||
            localStorage.getItem("vericase_current_project_name") ||
            "";
          if (fallbackName) {
            const projectTitleSuffix = document.getElementById("projectTitleSuffix");
            if (projectTitleSuffix) {
              projectTitleSuffix.textContent = fallbackName;
            }
          }
        }

        // Show stats panel
        document.getElementById("projectStats").style.display = "block";
      } catch (error) {
        console.error("Error loading project stats:", error);
      }
    }

    // Initialize dashboard
    document.addEventListener("DOMContentLoaded", () => {
      // Initialize shared app-state strictly (no implicit default project creation on dashboard).
      // This dashboard should reflect an explicit selection from the Command Center.
      if (window.VeriCaseApp && typeof window.VeriCaseApp.init === "function") {
        window.VeriCaseApp.init({
          strict: true,
          createDefaultProject: false,
          allowLegacyProjectIdAsCaseId: false,
          contextType: profileType,
          contextId: profileId ? String(profileId) : "",
          contextName:
            (profileType === "case"
              ? localStorage.getItem("currentCaseName") || localStorage.getItem("vericase_current_case_name")
              : localStorage.getItem("currentProjectName") || localStorage.getItem("vericase_current_project_name")) ||
            null,
        }).catch((e) => console.warn("[Dashboard] VeriCaseApp.init strict failed:", e));
      }

      // Immediately show cached project name if available (before API calls)
      const cachedProfileName =
        profileType === "case"
          ? localStorage.getItem("currentCaseName") ||
            localStorage.getItem("vericase_current_case_name")
          : localStorage.getItem("currentProjectName") ||
            localStorage.getItem("vericase_current_project_name");

      if (cachedProfileName && profileId) {
        const projectTitleSuffix = document.getElementById("projectTitleSuffix");
        if (projectTitleSuffix) {
          projectTitleSuffix.textContent = cachedProfileName;
        }
        const profileNameEl = document.getElementById("profileName");
        if (profileNameEl) {
          profileNameEl.textContent = cachedProfileName;
        }
      }

      // Inject the navigation shell with sidebar
      if (window.VericaseShell && typeof window.VericaseShell.inject === "function") {
        window.VericaseShell.inject({
          title: "",
          breadcrumbs: [
            { label: "Control Centre", url: "control-centre.html", icon: "fa-compass" },
            { label: "Workspaces", url: "workspace-hub.html", icon: "fa-layer-group" },
            { label: profileType === "case" ? "Case Overview" : "Project Overview" },
          ],
        });
      }

      // Only show the project selector for project dashboards.
      if (profileType === "project") {
        loadProjects();
      } else {
        const panel = document.getElementById("projectSelectorPanel");
        if (panel) panel.style.display = "none";
      }

      // Don't force redirect - let users land on dashboard first
      if (profileId) {
        updateWidgetLinks();
        loadProfileData();
        loadEvidenceWidget();
        if (isFirstTime) {
          showFirstTimeOnboarding();
        }
      } else {
        // Show welcome message for users without a profile
        document.getElementById("welcomeTitle").innerHTML =
          `<span class="title-accent">${profileType === "case" ? "Case" : "Project"} Overview</span>`;
        document.getElementById("welcomeMessage").innerHTML =
          profileType === "case"
            ? "Select a case to get started."
            : "Select a project above or create a new one to get started.";
        document.getElementById("profileName").textContent = "Overview";

        const createdDateEl = document.getElementById("createdDate");
        if (createdDateEl) {
          const todayLabel = new Date().toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
          createdDateEl.textContent = `Created ${todayLabel}`;
        }
        // Still load evidence widget to show the repository link
        loadEvidenceWidget();
      }

      // Check if user is admin and show approval button
      checkAdminStatus();
    });

    async function loadEvidenceWidget() {
      const container = document.getElementById("evidenceFilesContent");
      if (!container) return;

      try {
        // Build query params for the evidence stats API
        let statsUrl = `${apiUrl}/api/evidence/stats`;
        if (profileId) {
          const paramType =
            profileType === "project" ? "project_id" : "case_id";
          statsUrl += `?${paramType}=${profileId}`;
        }

        const response = await fetch(statsUrl, {
          headers: token ? { Authorization: `Bearer ${token}` } : {},
        });

        if (response.ok) {
          const stats = await response.json();
          evidenceStatsCache = stats;
          updateEvidenceStatusWidget();
          updateQuickStatsWidget();

          if (stats.total === 0) {
            container.innerHTML = `
                            <div class="empty-state" style="padding: 1.5rem;">
                                <i class="fas fa-folder-plus" style="font-size: 2.5rem; color: var(--vericase-teal); margin-bottom: 0.75rem;"></i>
                                <p style="margin-bottom: 0.5rem; color: var(--vericase-navy); font-weight: 500;">No evidence uploaded yet</p>
                                <p style="font-size: 0.8rem; color: var(--text-tertiary);">Upload files, PSTs, or documents to build your evidence repository</p>
                                <button class="btn btn-primary" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="event.stopPropagation(); openPstUpload();">
                                    <i class="fas fa-upload"></i> Upload Evidence
                                </button>
                            </div>
                        `;
          } else {
            const typeStats = stats.by_type || {};
            const topTypes = Object.entries(typeStats)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 4);

            container.innerHTML = `
                            <div style="padding: 0.5rem 0;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                  <div style="padding: 0.75rem; background: var(--success-light); border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-dark);">${stats.total}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">Total Files</div>
                                    </div>
                                  <div style="padding: 0.75rem; background: var(--info-light); border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--vericase-teal-dark);">${stats.with_correspondence || 0}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-tertiary);">With Links</div>
                                    </div>
                                </div>

                                ${stats.unassigned > 0
                ? `
                                  <div style="padding: 0.5rem 0.75rem; background: var(--warning-light); border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.8rem; color: var(--warning-dark);">
                                        <i class="fas fa-inbox"></i> ${stats.unassigned} unassigned files need review
                                    </div>
                                `
                : ""
              }

                                ${topTypes.length > 0
                ? `
                                  <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.5rem;">Top Evidence Types</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        ${topTypes
                  .map(
                    ([type, count]) => `
                                      <span style="padding: 0.25rem 0.5rem; background: var(--gray-200); border-radius: 4px; font-size: 0.75rem; color: var(--text-secondary);">
                                                ${type || "other"}: ${count}
                                            </span>
                                        `,
                  )
                  .join("")}
                                    </div>
                                `
                : ""
              }

                                <div style="margin-top: 1rem; text-align: center; padding-top: 0.75rem; border-top: 1px solid var(--border-default);">
                                    <span style="color: var(--vericase-teal); font-size: 0.8rem; font-weight: 500;">
                                        <i class="fas fa-external-link-alt"></i> Click to open Evidence Repository
                                    </span>
                                </div>
                            </div>
                        `;
          }
        } else {
          evidenceStatsCache = null;
          updateEvidenceStatusWidget();
          updateQuickStatsWidget();
          // Fallback if evidence API not available
          container.innerHTML = `
                        <div class="empty-state" style="padding: 1.5rem;">
                            <i class="fas fa-folder-open" style="font-size: 2.5rem; color: var(--vericase-teal); margin-bottom: 0.75rem;"></i>
                            <p style="margin-bottom: 0.5rem; color: var(--vericase-navy); font-weight: 500;">Evidence Repository</p>
                            <p style="font-size: 0.8rem; color: var(--text-tertiary);">Click to manage all evidence files, documents, and attachments</p>
                            <div style="margin-top: 1rem; color: var(--vericase-teal); font-size: 0.8rem;">
                                <i class="fas fa-arrow-right"></i> Open Repository
                            </div>
                        </div>
                    `;
        }
      } catch (error) {
        console.error("Error loading evidence widget:", error);
        evidenceStatsCache = null;
        updateEvidenceStatusWidget();
        updateQuickStatsWidget();
        container.innerHTML = `
                    <div class="empty-state" style="padding: 1.5rem;">
                        <i class="fas fa-folder-open" style="font-size: 2.5rem; color: var(--vericase-teal); margin-bottom: 0.75rem;"></i>
                        <p style="margin-bottom: 0.5rem; color: var(--vericase-navy); font-weight: 500;">Evidence Repository</p>
                        <p style="font-size: 0.8rem; color: var(--text-tertiary);">Click to manage all evidence files and documents</p>
                        <div style="margin-top: 1rem; color: var(--vericase-teal); font-size: 0.8rem;">
                            <i class="fas fa-arrow-right"></i> Open Repository
                        </div>
                    </div>
                `;
      }
    }

    async function checkAdminStatus() {
      try {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        if (user.role === "ADMIN") {
          document.getElementById("adminApprovalBtn").style.display =
            "inline-flex";
          document.getElementById("adminSettingsBtn").style.display =
            "inline-flex";

          // Check for pending users
          const response = await fetch(`${apiUrl}/api/admin/users/pending`, {
            headers: token ? { Authorization: `Bearer ${token}` } : {},
          });

          if (response.ok) {
            const pending = await response.json();
            if (pending.length > 0) {
              document.getElementById("pendingBadge").innerHTML =
                `<span style="background: var(--error); color: white; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; margin-left: 0.25rem;">${pending.length}</span>`;
            }
          }
        }
      } catch (error) {
        console.error("Error checking admin status:", error);
      }
    }

    async function loadProfileData() {
      try {
        const endpoint =
          profileType === "project" ? "/api/projects" : "/api/cases";
        const headers = token ? { Authorization: `Bearer ${token}` } : {};
        const response = await fetch(`${apiUrl}${endpoint}/${profileId}`, {
          headers,
        });

        if (response.ok) {
          const data = await response.json();
          populateDashboard(data);
        } else {
          console.error("Failed to load profile data");
          populateDashboard(null);
        }
      } catch (error) {
        console.error("Error loading profile:", error);
        populateDashboard(null);
      }
    }

	    function populateDashboard(data) {
	      if (!data) {
	        // Use defaults for new profiles
	        document.getElementById("profileName").textContent =
	          "New " + (profileType === "project" ? "Project" : "Case");
	        document.getElementById("profileType").textContent =
	          profileType.charAt(0).toUpperCase() + profileType.slice(1);
	        stakeholderCountCache = 0;
	        updateQuickStatsWidget();
	        return;
	      }

      // Update profile info
      const profileName =
        data.project_name ||
        data.name ||
        data.projectName ||
        data.case_name ||
        data.caseName ||
        "Untitled";
      document.getElementById("profileName").textContent = profileName;

      const welcomeTitle = document.getElementById("welcomeTitle");
      if (welcomeTitle) {
        welcomeTitle.innerHTML = "";
        const accent = document.createElement("span");
        accent.className = "title-accent";
        accent.textContent = profileType === "case" ? "Case Overview" : "Project Overview";
        welcomeTitle.appendChild(accent);
        const suffix = document.createElement("span");
        suffix.className = "title-suffix";
        suffix.textContent = profileName;
        welcomeTitle.appendChild(suffix);
      }

      const createdDateEl = document.getElementById("createdDate");
      if (createdDateEl) {
        const createdAt = data.created_at || data.createdAt || null;
        const createdLabel = createdAt
          ? new Date(createdAt).toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric",
          })
          : new Date().toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        createdDateEl.textContent = `Created ${createdLabel}`;
      }

	      // Update type badge
	      document.getElementById("profileType").textContent =
	        profileType.charAt(0).toUpperCase() + profileType.slice(1);

	      const welcomeMessageEl = document.getElementById("welcomeMessage");
	      if (welcomeMessageEl) {
	        welcomeMessageEl.textContent =
	          profileType === "case"
	            ? "Issues, stakeholders, chronology, and evidence for this case."
	            : "Evidence, correspondence, programme, and chronology for this project.";
	      }

      // Populate stakeholders
      const stakeholders =
        data["project-stakeholders"]?.stakeholders ||
        data["case-legal-team"]?.legalTeam || [];
      const stakeholdersContainer = document.getElementById(
        "stakeholdersContent",
      );
      stakeholderCountCache = stakeholders.length;
      updateQuickStatsWidget();

      if (stakeholders.length > 0) {
        stakeholdersContainer.innerHTML = stakeholders
          .map(
            (s) => `
                    <div class="list-item">
                        <div>
                            <div class="list-item-title">${s["stakeholder-role"] || s["team-role"] || "Unknown"}</div>
                            <div class="list-item-meta">${s["stakeholder-name"] || s["team-name"] || "N/A"}</div>
                        </div>
                    </div>
                `,
          )
          .join("");
      }

      // Update keywords count
      const keywords =
        data["project-stakeholders"]?.keywords ||
        data["case-heads-keywords"]?.keywords || [];
      document.getElementById("keywordCount").textContent = keywords.length;

      // Populate heads of claim for cases
      if (
        profileType === "case" &&
        data["case-heads-keywords"]?.headsOfClaim
      ) {
        const heads = data["case-heads-keywords"].headsOfClaim;
        const headsContainer = document.getElementById("headsContent");

        if (heads.length > 0) {
          headsContainer.innerHTML = heads
            .map(
              (h) => `
                        <div class="list-item">
                            <div>
                                <div class="list-item-title">${h["claim-head"]}</div>
                                <div class="list-item-meta">${h["claim-actions"] || "No actions"}</div>
                            </div>
                            <span class="badge badge-${h["claim-status"] === "Complete" ? "complete" : "discovery"}">${h["claim-status"]}</span>
                        </div>
                    `,
            )
            .join("");
        }
      } else if (profileType === "project") {
        document.getElementById("headsTitle").textContent =
          "Project Milestones";
        document.getElementById("headsContent").innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks"></i>
                        <p>Track project progress here</p>
                    </div>
                `;
      }

      // Show deadlines for cases
      if (profileType === "case" && data["case-deadlines"]?.deadlines) {
        const deadlines = data["case-deadlines"].deadlines;
        const alertsContainer = document.getElementById("alertsContainer");

        if (deadlines.length > 0) {
          const upcomingDeadlines = deadlines.slice(0, 3);
          const deadlineHTML = upcomingDeadlines
            .map(
              (d) => `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>${d["deadline-task"]}</strong><br>
                                ${d["deadline-description"]} - ${d["deadline-date"] || "No date set"}
                            </div>
                        </div>
                    `,
            )
            .join("");
          alertsContainer.innerHTML += deadlineHTML;
        }
      }
    }

    function showFirstTimeOnboarding() {
      const welcomeMsg =
        profileType === "project"
          ? "Get started by uploading evidence files, PSTs, or documents."
          : "Your case has been set up! Upload evidence to begin building your case strategy.";

      document.getElementById("welcomeMessage").textContent = welcomeMsg;
    }

    // Check URL for openSettings parameter
    const openSettingsParam = urlParams.get("openSettings");
    if (openSettingsParam) {
      setTimeout(() => showSettings(openSettingsParam), 500);
    }

    // AI Key Management Functions
    function saveLocalAIKey(provider) {
      const inputId = `${provider}KeyInput`;
      const input = document.getElementById(inputId);
      const key = input.value.trim();

      if (!key) {
        showKeyMessage(provider, "Please enter an API key", "error");
        input.style.borderColor = "var(--error)";
        setTimeout(() => (input.style.borderColor = "var(--border-default)"), 1500);
        return;
      }

      // Save to localStorage
      localStorage.setItem(`ai_key_${provider}`, key);

      // Update status indicator
      const statusEl = document.getElementById(`${provider}Status`);
      if (statusEl) {
        statusEl.className = "status-indicator status-active";
        statusEl.title = "Configured (local)";
      }

      // Clear input (for security)
      input.value = "";
      input.placeholder = "•••••••••• (saved)";

      showKeyMessage(provider, "API key saved successfully!", "success");

      // Update overall status
      updateLocalAIStatus();
    }

    function clearLocalAIKey(provider) {
      if (
        !confirm(
          `Remove ${provider.toUpperCase()} API key from local storage?`,
        )
      ) {
        return;
      }

      localStorage.removeItem(`ai_key_${provider}`);

      // Update status indicator
      const statusEl = document.getElementById(`${provider}Status`);
      if (statusEl) {
        statusEl.className = "status-indicator status-inactive";
        statusEl.title = "Not configured";
      }

      // Reset input placeholder
      const inputId = `${provider}KeyInput`;
      const input = document.getElementById(inputId);
      if (input) {
        input.value = "";
        const placeholders = {
          openai: "sk-...",
          anthropic: "sk-ant-...",
          gemini: "AI...",
          perplexity: "pplx-...",
        };
        input.placeholder = placeholders[provider] || "Enter API key";
      }

      showKeyMessage(provider, "API key removed", "info");

      // Update overall status
      updateLocalAIStatus();
    }

    function showKeyMessage(provider, message, type) {
      const banner =
        document.getElementById("wizardBanner") || createBanner();
      banner.textContent = `${provider.toUpperCase()}: ${message}`;
      banner.style.background =
        type === "error"
          ? "var(--error-light)"
          : type === "success"
            ? "var(--success-light)"
            : "var(--info-light)";
      banner.style.color =
        type === "error"
          ? "var(--error-dark)"
          : type === "success"
            ? "var(--success-dark)"
            : "var(--vericase-navy)";
      banner.style.display = "block";
      setTimeout(() => (banner.style.display = "none"), 3000);
    }

    function createBanner() {
      const el = document.createElement("div");
      el.id = "wizardBanner";
      el.style.cssText =
        "position:fixed;top:0;left:0;right:0;z-index:9999;display:none;padding:10px 16px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;border-bottom:1px solid var(--border-default);text-align:center;";
      document.body.appendChild(el);
      return el;
    }

    function updateLocalAIStatus() {
      const providers = [
        "openai",
        "anthropic",
        "gemini",
        "perplexity",
      ];
      let anyConfigured = false;

      providers.forEach((provider) => {
        const key = localStorage.getItem(`ai_key_${provider}`);
        const statusEl = document.getElementById(`${provider}Status`);

        if (statusEl) {
          if (key && key.trim().length > 0) {
            statusEl.className = "status-indicator status-active";
            statusEl.title = "Configured (local)";
            anyConfigured = true;
          } else {
            statusEl.className = "status-indicator status-inactive";
            statusEl.title = "Not configured";
          }
        }

        // Load existing keys into inputs (masked)
        const inputId = `${provider}KeyInput`;
        const input = document.getElementById(inputId);
        if (input && key && key.trim().length > 0) {
          input.placeholder = "•••••••••• (saved)";
        }
      });

      // Update overall status
      const overallStatus = document.getElementById("aiOverallStatus");
      if (overallStatus) {
        if (anyConfigured) {
          overallStatus.innerHTML =
            '<i class="fas fa-check-circle" style="color: var(--success);"></i> <strong>API keys configured locally</strong> - Intelligent features are available in this browser';
          overallStatus.style.background = "var(--success-light)";
          overallStatus.style.borderColor = "var(--success)";
        } else {
          overallStatus.innerHTML =
            '<i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> <strong>No local API keys configured</strong> - Add keys above to enable AI features';
          overallStatus.style.background = "var(--warning-light)";
          overallStatus.style.borderColor = "var(--warning)";
        }
      }
    }

    // Load local AI status on settings open
    const originalShowSettings = showSettings;
    showSettings = function (tab = "general") {
      originalShowSettings(tab);
      if (tab === "ai") {
        setTimeout(() => updateLocalAIStatus(), 100);
      }
    };
  </script>

  <!-- Settings Modal Container (lazy loaded for faster initial page load) -->
  <div id="settingsModalContainer"></div>

  <!-- Settings Modal Template (stored as string, not parsed until needed) -->
  <script>
    window.SETTINGS_MODAL_HTML = `
    <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="padding: 1.5rem 2rem; border-bottom: 2px solid var(--border-default); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 1.5rem; color: var(--vericase-navy); margin: 0;">
                    <i class="fas fa-cog"></i> Settings
                </h2>
                <button onclick="closeSettings()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 0.5rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Tabs -->
            <div style="display: flex; border-bottom: 2px solid var(--border-default);">
                <button class="settings-tab-btn active" data-tab="general" onclick="showSettingsTab('general')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s;">
                    <i class="fas fa-sliders-h"></i> General
                </button>
                <button class="settings-tab-btn" data-tab="ai" onclick="showSettingsTab('ai')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s;">
                    <i class="fas fa-robot"></i> AI Configuration
                </button>
            </div>

            <!-- Content -->
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                <!-- General Tab -->
                <div id="generalTab" class="settings-tab-content">
                    <h3 style="margin-bottom: 1rem; color: var(--vericase-navy);">Profile Settings</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Configure your profile and preferences.</p>

                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-default);">
                        <p style="color: var(--text-secondary); margin: 0;">
                            <i class="fas fa-info-circle"></i> General settings coming soon
                        </p>
                    </div>
                </div>

                <!-- AI Configuration Tab -->
                <div id="aiTab" class="settings-tab-content" style="display: none;">
                    <h3 style="margin-bottom: 1rem; color: var(--vericase-navy);">AI Service Configuration</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Configure API keys for AI-powered features like intelligent configuration, document analysis, and chat assistance.</p>

                    <!-- Overall Status -->
                    <div id="aiOverallStatus" style="padding: 1rem; background: var(--info-light); border: 2px solid var(--border-focus); border-radius: 8px; margin-bottom: 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Checking AI service status...
                    </div>

                    <!-- API Key Entry Forms -->
                    <div style="display: grid; gap: 1.5rem; margin-bottom: 2rem;">
                        <!-- OpenAI -->
                        <div class="ai-provider-card" style="padding: 1.5rem; border: 2px solid var(--border-default); border-radius: 12px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="color: var(--vericase-navy); margin: 0 0 0.25rem 0;"><i class="fas fa-brain"></i> OpenAI (GPT-4)</h4>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">For intelligent configuration and document analysis</p>
                                </div>
                                <span id="openaiStatus" class="status-indicator status-inactive"></span>
                            </div>
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <label for="openaiKeyInput"></label><input type="password" id="openaiKeyInput" placeholder="sk-..." style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-default); border-radius: 8px; font-size: 0.875rem;">
                                <button onclick="saveLocalAIKey('openai')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button onclick="clearLocalAIKey('openai')" class="btn btn-secondary" style="padding: 0.75rem 1rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Anthropic -->
                        <div class="ai-provider-card" style="padding: 1.5rem; border: 2px solid var(--border-default); border-radius: 12px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="color: var(--vericase-navy); margin: 0 0 0.25rem 0;"><i class="fas fa-robot"></i> Anthropic (Claude)</h4>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">For advanced reasoning and analysis</p>
                                </div>
                                <span id="anthropicStatus" class="status-indicator status-inactive"></span>
                            </div>
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <label for="anthropicKeyInput"></label><input type="password" id="anthropicKeyInput" placeholder="sk-ant-..." style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-default); border-radius: 8px; font-size: 0.875rem;">
                                <button onclick="saveLocalAIKey('anthropic')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button onclick="clearLocalAIKey('anthropic')" class="btn btn-secondary" style="padding: 0.75rem 1rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Google Gemini -->
                        <div class="ai-provider-card" style="padding: 1.5rem; border: 2px solid var(--border-default); border-radius: 12px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="color: var(--vericase-navy); margin: 0 0 0.25rem 0;"><i class="fas fa-lightbulb"></i> Google (Gemini)</h4>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">For multimodal analysis and processing</p>
                                </div>
                                <span id="geminiStatus" class="status-indicator status-inactive"></span>
                            </div>
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <label for="geminiKeyInput"></label><input type="password" id="geminiKeyInput" placeholder="AI..." style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-default); border-radius: 8px; font-size: 0.875rem;">
                                <button onclick="saveLocalAIKey('gemini')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button onclick="clearLocalAIKey('gemini')" class="btn btn-secondary" style="padding: 0.75rem 1rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Perplexity -->
                        <div class="ai-provider-card" style="padding: 1.5rem; border: 2px solid var(--border-default); border-radius: 12px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="color: var(--vericase-navy); margin: 0 0 0.25rem 0;"><i class="fas fa-search"></i> Perplexity</h4>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">For evidence-focused queries with citations</p>
                                </div>
                                <span id="perplexityStatus" class="status-indicator status-inactive"></span>
                            </div>
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <label for="perplexityKeyInput"></label><input type="password" id="perplexityKeyInput" placeholder="pplx-..." style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-default); border-radius: 8px; font-size: 0.875rem;">
                                <button onclick="saveLocalAIKey('perplexity')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button onclick="clearLocalAIKey('perplexity')" class="btn btn-secondary" style="padding: 0.75rem 1rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Instructions -->
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--info-light); border: 2px solid var(--border-focus); border-radius: 8px;">
                        <h4 style="color: var(--vericase-navy); margin: 0 0 0.5rem 0;">
                            <i class="fas fa-info-circle"></i> About API Keys
                        </h4>
                        <p style="color: var(--text-secondary); margin: 0 0 1rem 0; font-size: 0.875rem;">
                            <strong>Local Testing (Development):</strong> Use the forms above to store API keys in your browser's localStorage. Keys will persist in this browser only.
                        </p>
                        <p style="color: var(--text-secondary); margin: 0 0 1rem 0; font-size: 0.875rem;">
                            <strong>Production Deployment:</strong> API keys should be configured in AWS Secrets Manager or environment variables. Contact your system administrator.
                        </p>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem;">
                            <i class="fas fa-shield-alt"></i> At least one AI provider is required for intelligent features to work. Keys stored locally are for development/testing only.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 1rem 2rem; border-top: 2px solid var(--border-default); display: flex; justify-content: flex-end; gap: 1rem;">
                <button onclick="closeSettings()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
    `;
  </script>

  <style>
    .settings-tab-btn.active {
      color: var(--vericase-teal);
      border-bottom-color: var(--vericase-teal) !important;
    }

    .settings-tab-btn:hover {
      color: var(--vericase-teal);
      background: rgba(var(--vericase-teal-rgb), 0.05);
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-active {
      background: var(--success);
      box-shadow: 0 0 0 3px var(--success-light);
    }

    .status-inactive {
      background: var(--error);
      box-shadow: 0 0 0 3px var(--error-light);
    }
  </style>
</body>

</html>

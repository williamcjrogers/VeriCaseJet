<!doctype html>
<!--suppress HtmlFormInputWithoutLabel -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeriCase - Admin Settings</title>
    <!-- Local Library -->
    <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/global.css" />
    <link rel="stylesheet" href="brand-styles.css?v=6" />
    <link rel="stylesheet" href="design-system.css?v=6" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>
    <style>
      body {
        font-family: "DM Sans", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-primary);
        -webkit-font-smoothing: antialiased;
      }

      /* Subtle warm background pattern */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background:
          linear-gradient(135deg, rgba(var(--vericase-teal-rgb), 0.03) 0%, transparent 50%),
          linear-gradient(225deg, rgba(139, 115, 85, 0.03) 0%, transparent 50%);
        pointer-events: none;
      }

      .header {
        background: white;
        border-bottom: 2px solid var(--gray-200);
        padding: 1rem 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      /* Hide custom header when shell is active (consistent with dashboard/master-dashboard) */
      .app-shell .header {
        display: none;
      }

      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo {
        height: 32px;
      }

      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .page-title {
        color: var(--vericase-navy);
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .page-subtitle {
        color: var(--text-secondary);
        margin-bottom: 2rem;
      }

      /* Tab Navigation */
      .tabs-nav {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--gray-200);
        margin-bottom: 0;
        background: white;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        overflow: hidden;
      }

      .tab-btn {
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
      }

      .tab-btn:hover {
        color: var(--vericase-teal);
        background: var(--gray-50);
      }

      .tab-btn.active {
        color: var(--vericase-teal);
        border-bottom-color: var(--vericase-teal);
        background: white;
      }

      .tab-btn i {
        font-size: 1rem;
      }

      /* Tab Content */
      .tab-content {
        display: none;
        background: white;
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--gray-100);
        border-top: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Settings Card Styles */
      .settings-section {
        padding: 2rem;
        border-bottom: 1px solid var(--gray-100);
      }

      .settings-section:last-child {
        border-bottom: none;
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--vericase-navy);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .section-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .setting-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 0;
      }

      .setting-row + .setting-row {
        border-top: 1px solid var(--gray-50);
      }

      .setting-label {
        min-width: 200px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .setting-label small {
        display: block;
        font-weight: 400;
        color: var(--text-secondary);
        font-size: 0.8rem;
        margin-top: 0.25rem;
      }

      .setting-input {
        padding: 0.625rem 0.875rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        transition: all 0.2s;
        min-width: 200px;
      }

      .setting-input:focus {
        outline: none;
        border-color: var(--vericase-teal);
        box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.1);
      }

      .setting-input[type="password"] {
        font-family: monospace;
      }

      .setting-input.wide {
        min-width: 350px;
        flex: 1;
        max-width: 400px;
      }

      /* Buttons */
      .btn {
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .btn-primary {
        background: var(--vericase-teal);
        color: white;
      }

      .btn-primary:hover {
        background: var(--vericase-teal-dark);
        transform: translateY(-1px);
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-secondary {
        background: var(--gray-200);
        color: var(--text-primary);
      }

      .btn-secondary:hover {
        background: var(--gray-300);
      }

      .btn-outline {
        background: transparent;
        color: var(--vericase-teal);
        border: 1px solid var(--vericase-teal);
      }

      .btn-outline:hover {
        background: rgba(var(--vericase-teal-rgb), 0.1);
      }

      /* Model status messages */
      .model-status-message {
        margin-top: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .model-status-message.loading {
        background: var(--gray-100);
        color: var(--text-secondary);
      }

      .model-status-message.success {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      .model-status-message.error {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.3);
      }

      .model-status-message.warning {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
        border: 1px solid rgba(245, 158, 11, 0.3);
      }

      .btn-success {
        background: var(--success);
        color: white;
      }

      .btn-danger {
        background: var(--error);
        color: white;
      }

      /* Provider Cards */
      .provider-card {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1rem;
      }

      .provider-card:last-child {
        margin-bottom: 0;
      }

      .provider-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .provider-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--vericase-navy);
      }

      .provider-title i {
        font-size: 1.25rem;
      }

      .provider-description {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }

      .provider-body {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .provider-row {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .provider-row label {
        min-width: 100px;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      /* Status Indicator */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .status-badge.configured {
        background: var(--success-light);
        color: var(--success);
      }

      .status-badge.not-configured {
        background: var(--gray-100);
        color: var(--text-secondary);
      }

      .status-badge.error {
        background: var(--error-light, #fee2e2);
        color: var(--error);
      }

      .status-badge i {
        font-size: 0.6rem;
      }

      /* Status Grid */
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .status-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--gray-200);
      }

      .status-card .provider-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
      }

      .status-card .provider-info {
        flex: 1;
      }

      .status-card .provider-name {
        font-weight: 600;
        color: var(--vericase-navy);
      }

      .status-card .provider-status {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .status-card.configured .status-dot {
        color: var(--success);
      }

      .status-card.not-configured .status-dot {
        color: var(--gray-300);
      }

      /* Function Config Cards */
      .function-card {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1rem;
      }

      .function-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .function-title {
        font-weight: 600;
        color: var(--vericase-navy);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .function-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .function-field {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
      }

      .function-field label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* Toast Messages */
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        background: var(--vericase-navy);
        color: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast.success {
        background: var(--success);
      }

      .toast.error {
        background: var(--error);
      }

      /* Toggle Switch */
      .toggle-switch {
        position: relative;
        width: 48px;
        height: 26px;
        background: var(--gray-300);
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .toggle-switch.active {
        background: var(--vericase-teal);
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .toggle-switch.active::after {
        left: 25px;
      }

      /* Back Link */
      .back-link {
        color: var(--vericase-teal);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-weight: 500;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      /* Info Box */
      .info-box {
        background: var(--info-light, #e0f2fe);
        border: 1px solid var(--info, #0ea5e9);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-top: 1rem;
        display: flex;
        gap: 0.75rem;
        font-size: 0.9rem;
      }

      .info-box i {
        color: var(--info, #0ea5e9);
        flex-shrink: 0;
      }

      /* Loading Spinner */
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--gray-200);
        border-top-color: var(--vericase-teal);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Checkbox styling */
      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
      }

      .checkbox-row input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--vericase-teal);
        cursor: pointer;
      }

      /* Help text */
      .help-text {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 0.375rem;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .tabs-nav {
          flex-wrap: wrap;
        }

        .tab-btn {
          flex: 1;
          justify-content: center;
          padding: 0.75rem;
        }

        .setting-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .setting-label {
          min-width: auto;
        }

        .setting-input.wide {
          min-width: 100%;
          max-width: 100%;
        }

        .provider-row {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body class="preload">
    <!-- Container - nav shell injected by JavaScript -->
    <div class="container">
      <h1 class="page-title">Admin Settings</h1>
      <p class="page-subtitle">
        Configure system-wide settings for VeriCase
      </p>

      <!-- Tab Navigation -->
      <div class="tabs-nav">
        <button class="tab-btn active" data-tab="general">
          <i class="fas fa-cog"></i> General
        </button>
        <button class="tab-btn" data-tab="ai-providers">
          <i class="fas fa-robot"></i> AI Providers
        </button>
        <button class="tab-btn" data-tab="ai-functions">
          <i class="fas fa-brain"></i> AI Functions
        </button>
        <button class="tab-btn" data-tab="ai-optimization">
          <i class="fas fa-chart-line"></i> AI Optimization
        </button>
        <button class="tab-btn" data-tab="caselaw">
          <i class="fas fa-scale-balanced"></i> Case Law
        </button>
        <button class="tab-btn" data-tab="display">
          <i class="fas fa-table"></i> Display
        </button>
        <button class="tab-btn" data-tab="status">
          <i class="fas fa-heartbeat"></i> Status
        </button>
      </div>

      <!-- General Settings Tab -->
      <div class="tab-content active" id="tab-general">
        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-file-pdf" style="color: var(--vericase-teal)"></i>
            Document Processing
          </div>
          <p class="section-description">
            Configure AWS Textract and Tika settings for document processing
          </p>

          <div class="setting-row">
            <div class="setting-label">
              Textract Page Threshold
              <small>PDFs with more pages will use Tika instead</small>
            </div>
            <input
              type="number"
              id="textract_page_threshold"
              class="setting-input"
              min="1"
              max="500"
              value="100"
            />
            <span style="color: var(--text-secondary)">pages</span>
            <button class="btn btn-primary" onclick="saveSetting('textract_page_threshold')">
              Save
            </button>
          </div>

          <div class="setting-row">
            <div class="setting-label">
              Textract Max Pages
              <small>AWS limit: 500 pages maximum</small>
            </div>
            <input
              type="number"
              id="textract_max_pages"
              class="setting-input"
              min="1"
              max="500"
              value="500"
            />
            <span style="color: var(--text-secondary)">pages</span>
            <button class="btn btn-primary" onclick="saveSetting('textract_max_pages')">
              Save
            </button>
          </div>
        </div>

        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-sliders-h" style="color: var(--vericase-blue)"></i>
            AI Behavior
          </div>
          <p class="section-description">
            Configure default AI behavior and fallback options
          </p>

          <div class="setting-row">
            <div class="setting-label">
              Default AI Provider
              <small>Used for quick searches and general queries</small>
            </div>
            <select id="ai_default_provider" class="setting-input">
              <option value="openai">OpenAI (GPT)</option>
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="gemini">Google (Gemini)</option>
              <option value="bedrock">Amazon Bedrock</option>
            </select>
            <button class="btn btn-primary" onclick="saveSetting('ai_default_provider')">
              Save
            </button>
          </div>

          <div class="setting-row">
            <div class="setting-label">
              Enable Web Search
              <small>Allow AI to search the web for information</small>
            </div>
            <select id="ai_web_search_enabled" class="setting-input">
              <option value="false">Disabled (Evidence Only)</option>
              <option value="true">Enabled</option>
            </select>
            <button class="btn btn-primary" onclick="saveSetting('ai_web_search_enabled')">
              Save
            </button>
          </div>

          <div class="setting-row">
            <div class="setting-label">
              Enable Fallback
              <small>Auto-retry with other providers on failure</small>
            </div>
            <select id="ai_fallback_enabled" class="setting-input">
              <option value="true">Enabled (Recommended)</option>
              <option value="false">Disabled</option>
            </select>
            <button class="btn btn-primary" onclick="saveSetting('ai_fallback_enabled')">
              Save
            </button>
            <span class="help-text">
              <i class="fas fa-info-circle"></i> Improves reliability
            </span>
          </div>

          <div class="setting-row">
            <div class="setting-label">
              Route Claude via Bedrock
              <small>Enterprise compliance (SOC2/HIPAA)</small>
            </div>
            <select id="bedrock_route_claude" class="setting-input">
              <option value="false">Disabled (Direct API)</option>
              <option value="true">Enabled (Via Bedrock)</option>
            </select>
            <button class="btn btn-primary" onclick="saveSetting('bedrock_route_claude')">
              Save
            </button>
            <span class="help-text">
              <i class="fas fa-shield-alt"></i> Recommended for compliance
            </span>
          </div>
        </div>
      </div>

      <!-- AI Providers Tab -->
      <div class="tab-content" id="tab-ai-providers">
        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-key" style="color: var(--vericase-teal)"></i>
            API Keys & Models
          </div>
          <p class="section-description">
            Configure API keys and select models for each AI provider
          </p>

          <!-- OpenAI -->
          <div class="provider-card">
            <div class="provider-header">
              <div>
                <div class="provider-title">
                  <i class="fas fa-brain" style="color: #10a37f"></i>
                  OpenAI (GPT)
                </div>
                <p class="provider-description">
                  Used for chronology analysis and deep research.
                  <a href="https://platform.openai.com/api-keys" target="_blank">Get API key</a>
                </p>
              </div>
              <span class="status-badge not-configured" id="status-badge-openai">
                <i class="fas fa-circle"></i> Not configured
              </span>
            </div>
            <div class="provider-body">
              <div class="provider-row">
                <label>API Key:</label>
                <input
                  type="password"
                  id="openai_api_key"
                  class="setting-input wide"
                  placeholder="sk-..."
                />
                <button class="btn btn-primary" onclick="saveSetting('openai_api_key')">
                  Save Key
                </button>
                <button class="btn btn-secondary" onclick="testProvider('openai')">
                  <i class="fas fa-vial"></i> Test Connection
                </button>
              </div>
              <div class="provider-row">
                <label>Model:</label>
                <select id="openai_model" class="setting-input" style="width: 250px;">
                  <!-- Populated dynamically -->
                </select>
                <input type="text" id="openai_model_custom" class="setting-input" style="width: 180px;" placeholder="Or enter custom model ID..." />
                <button class="btn btn-primary" onclick="saveModelSetting('openai')">
                  Save
                </button>
                <button class="btn btn-secondary" onclick="testSpecificModel('openai')">
                  <i class="fas fa-flask"></i> Test Model
                </button>
                <button class="btn btn-outline" onclick="fetchAvailableModels('openai')">
                  <i class="fas fa-sync"></i> Fetch My Models
                </button>
              </div>
              <div id="openai_model_status" class="model-status-message" style="display: none;"></div>
            </div>
          </div>

          <!-- Anthropic -->
          <div class="provider-card">
            <div class="provider-header">
              <div>
                <div class="provider-title">
                  <i class="fas fa-comment-dots" style="color: #d97706"></i>
                  Anthropic (Claude)
                </div>
                <p class="provider-description">
                  Used for narrative construction and legal reasoning.
                  <a href="https://console.anthropic.com/settings/keys" target="_blank">Get API key</a>
                </p>
              </div>
              <span class="status-badge not-configured" id="status-badge-anthropic">
                <i class="fas fa-circle"></i> Not configured
              </span>
            </div>
            <div class="provider-body">
              <div class="provider-row">
                <label>API Key:</label>
                <input
                  type="password"
                  id="anthropic_api_key"
                  class="setting-input wide"
                  placeholder="sk-ant-..."
                />
                <button class="btn btn-primary" onclick="saveSetting('anthropic_api_key')">
                  Save Key
                </button>
                <button class="btn btn-secondary" onclick="testProvider('anthropic')">
                  <i class="fas fa-vial"></i> Test Connection
                </button>
              </div>
              <div class="provider-row">
                <label>Model:</label>
                <select id="anthropic_model" class="setting-input" style="width: 250px;">
                  <!-- Populated dynamically -->
                </select>
                <input type="text" id="anthropic_model_custom" class="setting-input" style="width: 180px;" placeholder="Or enter custom model ID..." />
                <button class="btn btn-primary" onclick="saveModelSetting('anthropic')">
                  Save
                </button>
                <button class="btn btn-secondary" onclick="testSpecificModel('anthropic')">
                  <i class="fas fa-flask"></i> Test Model
                </button>
              </div>
              <div id="anthropic_model_status" class="model-status-message" style="display: none;"></div>
            </div>
          </div>

          <!-- Google Gemini -->
          <div class="provider-card">
            <div class="provider-header">
              <div>
                <div class="provider-title">
                  <i class="fas fa-gem" style="color: #4285f4"></i>
                  Google (Gemini)
                </div>
                <p class="provider-description">
                  Used for pattern recognition and quick searches.
                  <a href="https://aistudio.google.com/app/apikey" target="_blank">Get API key</a>
                </p>
              </div>
              <span class="status-badge not-configured" id="status-badge-gemini">
                <i class="fas fa-circle"></i> Not configured
              </span>
            </div>
            <div class="provider-body">
              <div class="provider-row">
                <label>API Key:</label>
                <input
                  type="password"
                  id="gemini_api_key"
                  class="setting-input wide"
                  placeholder="AIza..."
                />
                <button class="btn btn-primary" onclick="saveSetting('gemini_api_key')">
                  Save Key
                </button>
                <button class="btn btn-secondary" onclick="testProvider('gemini')">
                  <i class="fas fa-vial"></i> Test Connection
                </button>
              </div>
              <div class="provider-row">
                <label>Model:</label>
                <select id="gemini_model" class="setting-input" style="width: 250px;">
                  <!-- Populated dynamically -->
                </select>
                <input type="text" id="gemini_model_custom" class="setting-input" style="width: 180px;" placeholder="Or enter custom model ID..." />
                <button class="btn btn-primary" onclick="saveModelSetting('gemini')">
                  Save
                </button>
                <button class="btn btn-secondary" onclick="testSpecificModel('gemini')">
                  <i class="fas fa-flask"></i> Test Model
                </button>
                <button class="btn btn-outline" onclick="fetchAvailableModels('gemini')">
                  <i class="fas fa-sync"></i> Fetch My Models
                </button>
              </div>
              <div id="gemini_model_status" class="model-status-message" style="display: none;"></div>
            </div>
          </div>

          <!-- Amazon Bedrock -->
          <div class="provider-card">
            <div class="provider-header">
              <div>
                <div class="provider-title">
                  <i class="fab fa-aws" style="color: #ff9900"></i>
                  Amazon Bedrock
                </div>
                <p class="provider-description">
                  Enterprise AI via AWS. Uses IAM credentials (no API key needed).
                  <a href="https://aws.amazon.com/bedrock/" target="_blank">Learn more</a>
                </p>
              </div>
              <span class="status-badge not-configured" id="status-badge-bedrock">
                <i class="fas fa-circle"></i> Not enabled
              </span>
            </div>
            <div class="provider-body">
              <div class="provider-row">
                <label>Enable:</label>
                <select id="bedrock_enabled" class="setting-input">
                  <option value="false">Disabled</option>
                  <option value="true">Enabled</option>
                </select>
                <button class="btn btn-primary" onclick="saveSetting('bedrock_enabled')">
                  Save
                </button>
                <button class="btn btn-secondary" onclick="testProvider('bedrock')">
                  <i class="fas fa-vial"></i> Test
                </button>
              </div>
              <div class="provider-row">
                <label>Region:</label>
                <select id="bedrock_region" class="setting-input">
                  <option value="us-east-1">US East (N. Virginia)</option>
                  <option value="us-west-2">US West (Oregon)</option>
                  <option value="eu-west-1">Europe (Ireland)</option>
                  <option value="eu-west-2">Europe (London)</option>
                  <option value="eu-central-1">Europe (Frankfurt)</option>
                  <option value="ap-northeast-1">Asia Pacific (Tokyo)</option>
                  <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                  <option value="ap-southeast-2">Asia Pacific (Sydney)</option>
                </select>
                <button class="btn btn-primary" onclick="saveSetting('bedrock_region')">
                  Save
                </button>
              </div>
              <div class="provider-row">
                <label>Model:</label>
                <select id="bedrock_model" class="setting-input wide">
                  <!-- Populated dynamically -->
                </select>
                <button class="btn btn-primary" onclick="saveSetting('bedrock_model')">
                  Save
                </button>
              </div>
            </div>
            <div class="info-box">
              <i class="fas fa-info-circle"></i>
              <div>
                <strong>Bedrock Models:</strong> Includes Amazon Nova, Claude via Bedrock, Llama, Mistral, and Cohere models.
                Requires AWS IAM credentials configured on the server.
              </div>
            </div>
          </div>

          <!-- xAI (Grok) -->
          <div class="provider-card">
            <div class="provider-header">
              <div>
                <div class="provider-title">
                  <i class="fas fa-bolt" style="color: #1da1f2"></i>
                  xAI (Grok)
                </div>
                <p class="provider-description">
                  Real-time knowledge and reasoning with X/Twitter integration.
                  <a href="https://console.x.ai/" target="_blank">Get API key</a>
                </p>
              </div>
              <span class="status-badge not-configured" id="status-badge-xai">
                <i class="fas fa-circle"></i> Not configured
              </span>
            </div>
            <div class="provider-body">
              <div class="provider-row">
                <label>API Key:</label>
                <input
                  type="password"
                  id="xai_api_key"
                  class="setting-input wide"
                  placeholder="xai-..."
                />
                <button class="btn btn-primary" onclick="saveSetting('xai_api_key')">
                  Save Key
                </button>
                <button class="btn btn-secondary" onclick="testProvider('xai')">
                  <i class="fas fa-vial"></i> Test Connection
                </button>
              </div>
              <div class="provider-row">
                <label>Model:</label>
                <select id="xai_model" class="setting-input" style="width: 250px;">
                  <option value="grok-3">Grok 3 (Latest)</option>
                  <option value="grok-3-mini">Grok 3 Mini (Fast)</option>
                  <option value="grok-2">Grok 2</option>
                  <option value="grok-2-mini">Grok 2 Mini</option>
                  <option value="grok-beta">Grok Beta</option>
                </select>
                <input type="text" id="xai_model_custom" class="setting-input" style="width: 180px;" placeholder="Or enter custom model ID..." />
                <button class="btn btn-primary" onclick="saveModelSetting('xai')">
                  Save
                </button>
                <button class="btn btn-secondary" onclick="testSpecificModel('xai')">
                  <i class="fas fa-flask"></i> Test Model
                </button>
              </div>
              <div id="xai_model_status" class="model-status-message" style="display: none;"></div>
            </div>
          </div>

          <!-- Perplexity -->
          <div class="provider-card">
            <div class="provider-header">
              <div>
                <div class="provider-title">
                  <i class="fas fa-search-plus" style="color: #20b2aa"></i>
                  Perplexity
                </div>
                <p class="provider-description">
                  AI with built-in web search and citations.
                  <a href="https://www.perplexity.ai/settings/api" target="_blank">Get API key</a>
                </p>
              </div>
              <span class="status-badge not-configured" id="status-badge-perplexity">
                <i class="fas fa-circle"></i> Not configured
              </span>
            </div>
            <div class="provider-body">
              <div class="provider-row">
                <label>API Key:</label>
                <input
                  type="password"
                  id="perplexity_api_key"
                  class="setting-input wide"
                  placeholder="pplx-..."
                />
                <button class="btn btn-primary" onclick="saveSetting('perplexity_api_key')">
                  Save Key
                </button>
                <button class="btn btn-secondary" onclick="testProvider('perplexity')">
                  <i class="fas fa-vial"></i> Test Connection
                </button>
              </div>
              <div class="provider-row">
                <label>Model:</label>
                <select id="perplexity_model" class="setting-input" style="width: 250px;">
                  <option value="sonar-pro">Sonar Pro (Best)</option>
                  <option value="sonar">Sonar (Fast)</option>
                  <option value="sonar-reasoning-pro">Sonar Reasoning Pro</option>
                  <option value="sonar-reasoning">Sonar Reasoning</option>
                  <option value="sonar-deep-research">Sonar Deep Research</option>
                </select>
                <input type="text" id="perplexity_model_custom" class="setting-input" style="width: 180px;" placeholder="Or enter custom model ID..." />
                <button class="btn btn-primary" onclick="saveModelSetting('perplexity')">
                  Save
                </button>
                <button class="btn btn-secondary" onclick="testSpecificModel('perplexity')">
                  <i class="fas fa-flask"></i> Test Model
                </button>
              </div>
              <div id="perplexity_model_status" class="model-status-message" style="display: none;"></div>
            </div>
            <div class="info-box">
              <i class="fas fa-globe"></i>
              <div>
                <strong>Web Search:</strong> Perplexity automatically searches the web and provides citations.
                Ideal for research queries requiring up-to-date information.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Functions Tab -->
      <div class="tab-content" id="tab-ai-functions">
        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-cogs" style="color: var(--vericase-teal)"></i>
            AI Tool Registry
          </div>
          <p class="section-description">
            Configure AI models and parameters for all VeriCase AI tools
          </p>

          <!-- Dynamic tool cards container -->
          <div id="ai-tools-container">
            <div class="loading-indicator" style="text-align: center; padding: 2rem;">
              <i class="fas fa-spinner fa-spin"></i> Loading AI tools...
            </div>
          </div>
        </div>
      </div>

      <!-- AI Optimization Tab -->
      <div class="tab-content" id="tab-ai-optimization">
        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-chart-line" style="color: var(--vericase-orange)"></i>
            AI Optimization Analytics
          </div>
          <p class="section-description">
            Track AI API calls, costs, performance, and quality metrics to optimize your AI usage
          </p>

          <!-- Statistics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="stat-card" style="background: var(--card-bg); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Events</div>
              <div id="stat-total-events" style="font-size: 2rem; font-weight: 600; color: var(--vericase-teal);">0</div>
            </div>
            <div class="stat-card" style="background: var(--card-bg); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Cost</div>
              <div id="stat-total-cost" style="font-size: 2rem; font-weight: 600; color: var(--vericase-orange);">$0.00</div>
            </div>
            <div class="stat-card" style="background: var(--card-bg); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Success Rate</div>
              <div id="stat-success-rate" style="font-size: 2rem; font-weight: 600; color: var(--vericase-green);">0%</div>
            </div>
            <div class="stat-card" style="background: var(--card-bg); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Avg Response Time</div>
              <div id="stat-avg-response-time" style="font-size: 2rem; font-weight: 600; color: var(--vericase-blue);">0ms</div>
            </div>
          </div>

          <!-- Filters -->
          <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 150px;">
              <label style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Provider</label>
              <select id="filter-provider" class="setting-input" style="width: 100%;">
                <option value="">All Providers</option>
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic</option>
                <option value="gemini">Gemini</option>
                <option value="bedrock">AWS Bedrock</option>
                <option value="xai">xAI (Grok)</option>
                <option value="perplexity">Perplexity</option>
              </select>
            </div>
            <div style="flex: 1; min-width: 150px;">
              <label style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Model</label>
              <input id="filter-model" type="text" class="setting-input" placeholder="Filter by model ID" style="width: 100%;" />
            </div>
            <div style="flex: 1; min-width: 150px;">
              <label style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Function</label>
              <input id="filter-function" type="text" class="setting-input" placeholder="Filter by function" style="width: 100%;" />
            </div>
            <div style="flex: 0 0 auto; display: flex; align-items: flex-end; gap: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input id="filter-success-only" type="checkbox" />
                <span style="font-size: 0.875rem;">Success Only</span>
              </label>
            </div>
            <div style="flex: 0 0 auto; display: flex; align-items: flex-end;">
              <button class="btn btn-primary" onclick="loadAIOptimizationData()">
                <i class="fas fa-sync"></i> Refresh
              </button>
            </div>
          </div>

          <!-- Events Table -->
          <div style="overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Time</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Provider</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Model</th>
                  <th style="padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem;">Function</th>
                  <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.875rem;">Tokens</th>
                  <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.875rem;">Time (ms)</th>
                  <th style="padding: 0.75rem; text-align: right; font-weight: 600; font-size: 0.875rem;">Cost</th>
                  <th style="padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem;">Status</th>
                </tr>
              </thead>
              <tbody id="ai-events-tbody">
                <tr>
                  <td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin"></i> Loading events...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Cost by Provider Chart Section -->
          <div style="margin-top: 2rem;">
            <div class="section-title" style="font-size: 1.125rem; margin-bottom: 1rem;">
              <i class="fas fa-chart-pie" style="color: var(--vericase-orange)"></i>
              Cost by Provider
            </div>
            <div id="cost-by-provider-chart" style="background: var(--card-bg); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <!-- Chart will be populated by JavaScript -->
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div id="cost-breakdown" style="color: var(--text-secondary); font-size: 0.875rem;">
                  No data available
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Case Law Intelligence Tab -->
      <div class="tab-content" id="tab-caselaw">
        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-scale-balanced" style="color: var(--vericase-navy)"></i>
            Case Law Intelligence
          </div>
          <p class="section-description">
            Manage case-law mining outputs, trend signals, and auto-tag suggestions.
          </p>

          <div class="info-box" style="margin-bottom: 1rem;">
            <i class="fas fa-info-circle"></i>
            <div>
              <strong>Note:</strong> Trends and tag suggestions are available after cases finish the mining step
              (extraction_status = "extracted").
            </div>
          </div>

          <div class="settings-section" style="padding: 1.5rem; border: 1px solid var(--gray-100); border-radius: var(--radius-lg); background: var(--gray-50); margin-bottom: 1.5rem;">
            <div class="section-title" style="font-size: 1.1rem;">
              <i class="fas fa-sliders-h" style="color: var(--vericase-teal)"></i>
              Configuration
            </div>
            <p class="section-description">
              Control the mining model and tag taxonomy used by the case-law layer.
            </p>

            <div class="setting-row">
              <div class="setting-label">
                Mining Model ID
                <small>LLM used for the extraction/mapping pass (format: provider:model_id)</small>
              </div>
              <input
                type="text"
                id="caselaw_mining_model"
                class="setting-input wide"
                placeholder="e.g., openai:gpt-4o or anthropic:claude-sonnet-4-20250514 or bedrock:amazon.nova-pro-v1:0"
                value="openai:gpt-4o"
              />
              <button class="btn btn-primary" onclick="saveSetting('caselaw_mining_model')">
                Save
              </button>
            </div>

            <div class="setting-row" style="align-items: flex-start;">
              <div class="setting-label">
                Tag Taxonomy
                <small>One tag per line (e.g., JCT, NEC, payment notices, fire safety)</small>
              </div>
              <textarea
                id="caselaw_taxonomy"
                class="setting-input wide"
                rows="4"
                placeholder="Enter canonical tag names to normalize suggestions..."
                style="min-height: 120px;"
              ></textarea>
              <button class="btn btn-primary" onclick="saveSetting('caselaw_taxonomy')">
                Save
              </button>
            </div>
          </div>

            <div class="status-grid" style="margin-top: 1rem;">
              <div class="status-card" id="caselaw-total-card">
                <div class="provider-icon" style="background: #e0f2fe; color: #0284c7;">
                  <i class="fas fa-database"></i>
                </div>
                <div class="provider-info">
                  <div class="provider-name">Extracted</div>
                  <div class="provider-status" id="caselaw-total-cases">Loading…</div>
                </div>
              </div>
              <div class="status-card">
                <div class="provider-icon" style="background: #fef9c3; color: #d97706;">
                  <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="provider-info">
                  <div class="provider-name">Pending</div>
                  <div class="provider-status" id="caselaw-pending-cases">Loading…</div>
                </div>
              </div>
              <div class="status-card">
                <div class="provider-icon" style="background: #ecfeff; color: #0ea5e9;">
                  <i class="fas fa-spinner"></i>
                </div>
                <div class="provider-info">
                  <div class="provider-name">Processing</div>
                  <div class="provider-status" id="caselaw-processing-cases">Loading…</div>
                </div>
              </div>
              <div class="status-card">
                <div class="provider-icon" style="background: #fef2f2; color: #dc2626;">
                  <i class="fas fa-triangle-exclamation"></i>
                </div>
                <div class="provider-info">
                  <div class="provider-name">Failed</div>
                  <div class="provider-status" id="caselaw-failed-cases">Loading…</div>
                </div>
              </div>
              <div class="status-card">
                <div class="provider-icon" style="background: #ecfeff; color: #0ea5e9;">
                  <i class="fas fa-chart-bar"></i>
                </div>
              <div class="provider-info">
                <div class="provider-name">Trends Endpoint</div>
                <div class="provider-status">GET /api/caselaw/trends</div>
              </div>
            </div>
            <div class="status-card">
              <div class="provider-icon" style="background: #fef9c3; color: #d97706;">
                <i class="fas fa-tags"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">Tag Suggestions</div>
                <div class="provider-status">POST /api/caselaw/suggest-tags</div>
              </div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-hammer" style="color: #14b8a6"></i>
            Mining Runner
          </div>
          <p class="section-description">
            Mine pending cases in the background so trends and tag suggestions have data to work with.
          </p>

          <div class="function-grid">
            <div class="function-field">
              <label>Batch Size</label>
              <input type="number" id="caselaw-mine-limit" class="setting-input" min="1" max="500" value="50" />
            </div>
            <div class="function-field">
              <label>Concurrency</label>
              <input type="number" id="caselaw-mine-concurrency" class="setting-input" min="1" max="10" value="2" />
            </div>
            <div class="function-field" style="display: flex; flex-direction: column; justify-content: flex-end;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input id="caselaw-mine-include-failed" type="checkbox" />
                <span style="font-size: 0.875rem;">Include failed</span>
              </label>
            </div>
            <div class="function-field" style="display: flex; flex-direction: column; justify-content: flex-end;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input id="caselaw-mine-include-extracted" type="checkbox" />
                <span style="font-size: 0.875rem;">Re-mine extracted</span>
              </label>
            </div>
            <div class="function-field" style="display: flex; flex-direction: column; justify-content: flex-end;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input id="caselaw-mine-construction-only" type="checkbox" />
                <span style="font-size: 0.875rem;">Construction focus</span>
              </label>
            </div>
          </div>

          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; align-items: center;">
            <button class="btn btn-primary" onclick="runCaseLawMiningBatch()">
              <i class="fas fa-play"></i> Mine Next Batch
            </button>
            <button class="btn btn-secondary" onclick="loadCaseLawMiningStatus()">
              <i class="fas fa-sync-alt"></i> Refresh Status
            </button>
            <span id="caselaw-mine-status" class="help-text"></span>
          </div>
        </div>

        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-layer-group" style="color: var(--vericase-navy)"></i>
            Vectorization
          </div>
          <p class="section-description">
            Trigger knowledge base ingestion after mining so case law vectors are refreshed.
          </p>
          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; align-items: center;">
            <button class="btn btn-primary" onclick="runCaseLawKBIngest()">
              <i class="fas fa-database"></i> Trigger KB Ingest
            </button>
            <span id="caselaw-kb-status" class="help-text"></span>
          </div>
        </div>

        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-chart-pie" style="color: var(--vericase-teal)"></i>
            Trend Snapshot
          </div>
          <p class="section-description">
            Quickly inspect recurring themes, contentious issues, and tags from extracted cases.
          </p>
          <div style="display: flex; gap: 0.75rem; align-items: center; margin-bottom: 1rem;">
            <button class="btn btn-primary" onclick="loadCaseLawTrends()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <span id="caselaw-trends-status" class="help-text"></span>
          </div>

          <div class="function-grid" id="caselaw-trends-grid">
            <div class="function-field">
              <label>Top Themes</label>
              <ul id="caselaw-top-themes" class="section-description"></ul>
            </div>
            <div class="function-field">
              <label>Contentious Issues</label>
              <ul id="caselaw-top-issues" class="section-description"></ul>
            </div>
            <div class="function-field">
              <label>Tags</label>
              <ul id="caselaw-top-tags" class="section-description"></ul>
            </div>
            <div class="function-field">
              <label>Outcomes</label>
              <ul id="caselaw-top-outcomes" class="section-description"></ul>
            </div>
            <div class="function-field">
              <label>Construction Buckets</label>
              <ul id="caselaw-top-buckets" class="section-description"></ul>
            </div>
            <div class="function-field" style="grid-column: 1 / -1;">
              <label>Predictive Signals</label>
              <ul id="caselaw-predictive-signals" class="section-description"></ul>
              <div id="caselaw-predictive-meta" class="help-text"></div>
            </div>
            <div class="function-field" style="grid-column: 1 / -1;">
              <label>Proactive Trends</label>
              <ul id="caselaw-proactive-trends" class="section-description"></ul>
              <div id="caselaw-proactive-meta" class="help-text"></div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-folder-open" style="color: #14b8a6"></i>
            Context Documents
          </div>
          <p class="section-description">
            Upload claim submissions or key documents to steer case-law searches and tag suggestions.
          </p>

          <div class="function-grid">
            <div class="function-field">
              <label>Context Tag</label>
              <input type="text" id="caselaw-context-tag" class="setting-input" value="caselaw-context" />
            </div>
            <div class="function-field">
              <label>Max Docs Used</label>
              <input type="number" id="caselaw-context-max" class="setting-input" min="1" max="25" value="5" />
            </div>
            <div class="function-field" style="grid-column: 1 / -1;">
              <label>Upload Documents</label>
              <input type="file" id="caselaw-context-file" class="setting-input wide" multiple />
            </div>
          </div>

          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; align-items: center;">
            <button class="btn btn-primary" onclick="uploadCaseLawContext()">
              <i class="fas fa-upload"></i> Upload
            </button>
            <span id="caselaw-context-upload-status" class="help-text"></span>
          </div>

          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; align-items: center;">
            <button class="btn btn-primary" onclick="runContextSuggestion()">
              <i class="fas fa-magnifying-glass"></i> Generate Suggestions
            </button>
            <span id="caselaw-context-suggest-status" class="help-text"></span>
          </div>

          <div class="status-grid" style="margin-top: 1rem;">
            <div class="status-card">
              <div class="provider-icon" style="background: #ecfeff; color: #0ea5e9;">
                <i class="fas fa-tags"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">Suggested Tags</div>
                <div class="provider-status" id="caselaw-context-tags">-</div>
              </div>
            </div>
            <div class="status-card">
              <div class="provider-icon" style="background: #fef2f2; color: #dc2626;">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">Contentious Issues</div>
                <div class="provider-status" id="caselaw-context-issues">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-lightbulb" style="color: #f59e0b"></i>
            Suggest Tags & Issues
          </div>
          <p class="section-description">
            Paste narrative text to auto-suggest tags and contentious issues using the mined case-law vocabulary.
          </p>

          <div class="function-grid">
            <div class="function-field" style="grid-column: 1 / -1;">
              <label>Text to Analyze</label>
              <textarea id="caselaw-suggest-text" class="setting-input wide" rows="4"
                placeholder="Paste correspondence, pleadings, or summaries to suggest tags..."></textarea>
            </div>
            <div class="function-field">
              <label>Top N</label>
              <input type="number" id="caselaw-suggest-topn" class="setting-input" min="1" max="15" value="8" />
            </div>
          </div>

          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; align-items: center;">
            <button class="btn btn-primary" onclick="runTagSuggestion()">
              <i class="fas fa-magic"></i> Suggest
            </button>
            <span id="caselaw-suggest-status" class="help-text"></span>
          </div>

          <div class="status-grid" style="margin-top: 1rem;">
            <div class="status-card">
              <div class="provider-icon" style="background: #ecfeff; color: #0ea5e9;">
                <i class="fas fa-tags"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">Tags</div>
                <div class="provider-status" id="caselaw-suggest-tags">—</div>
              </div>
            </div>
            <div class="status-card">
              <div class="provider-icon" style="background: #fef2f2; color: #dc2626;">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">Contentious Issues</div>
                <div class="provider-status" id="caselaw-suggest-issues">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Display Settings Tab -->
      <div class="tab-content" id="tab-display">
        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-table" style="color: var(--vericase-blue)"></i>
            Grid & Table Configuration
          </div>
          <p class="section-description">
            Configure default settings for data grids (evidence, correspondence, contentious matters)
          </p>

          <div class="setting-row">
            <div class="setting-label">
              Default Row Height
              <small>Height of rows in data grids</small>
            </div>
            <input
              type="number"
              id="ag_grid_default_row_height"
              class="setting-input"
              min="30"
              max="500"
              step="10"
              value="220"
            />
            <span style="color: var(--text-secondary)">pixels</span>
            <button class="btn btn-primary" onclick="saveSetting('ag_grid_default_row_height')">
              Save
            </button>
          </div>

          <div class="setting-row">
            <div class="setting-label">
              Grid Theme
              <small>Visual style for all data grids</small>
            </div>
            <select id="ag_grid_theme" class="setting-input">
              <option value="quartz">Quartz (Modern)</option>
              <option value="alpine">Alpine (Clean)</option>
              <option value="balham">Balham (Professional)</option>
              <option value="material">Material (Google)</option>
            </select>
            <button class="btn btn-primary" onclick="saveSetting('ag_grid_theme')">
              Save
            </button>
          </div>

          <div class="setting-row">
            <div class="setting-label">
              Rows Per Page
              <small>Default pagination size</small>
            </div>
            <select id="ag_grid_pagination_page_size" class="setting-input">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
            <button class="btn btn-primary" onclick="saveSetting('ag_grid_pagination_page_size')">
              Save
            </button>
          </div>
        </div>

        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-file-export" style="color: var(--success)"></i>
            Export Options
          </div>
          <p class="section-description">
            Enable or disable data export functionality
          </p>

          <div class="setting-row">
            <div class="setting-label">
              Excel Export
              <small>Export data to .xlsx format</small>
            </div>
            <label class="checkbox-row">
              <input type="checkbox" id="ag_grid_enable_excel_export" />
              Enable Excel Export
            </label>
            <button class="btn btn-primary" onclick="saveCheckbox('ag_grid_enable_excel_export')">
              Save
            </button>
          </div>

          <div class="setting-row">
            <div class="setting-label">
              CSV Export
              <small>Export data to .csv format</small>
            </div>
            <label class="checkbox-row">
              <input type="checkbox" id="ag_grid_enable_csv_export" />
              Enable CSV Export
            </label>
            <button class="btn btn-primary" onclick="saveCheckbox('ag_grid_enable_csv_export')">
              Save
            </button>
          </div>
        </div>
      </div>

      <!-- Status Tab -->
      <div class="tab-content" id="tab-status">
        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-heartbeat" style="color: var(--success)"></i>
            AI Provider Status
            <button class="btn btn-secondary" onclick="refreshAllStatus()" style="margin-left: auto">
              <i class="fas fa-sync"></i> Refresh All
            </button>
          </div>
          <p class="section-description">
            Real-time status of configured AI providers
          </p>

          <div class="status-grid" id="status-grid">
            <div class="status-card not-configured" id="status-card-openai">
              <div class="provider-icon" style="background: rgba(16, 163, 127, 0.1)">
                <i class="fas fa-brain" style="color: #10a37f"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">OpenAI</div>
                <div class="provider-status" id="status-text-openai">Not configured</div>
              </div>
              <i class="fas fa-circle status-dot"></i>
            </div>

            <div class="status-card not-configured" id="status-card-anthropic">
              <div class="provider-icon" style="background: rgba(217, 119, 6, 0.1)">
                <i class="fas fa-comment-dots" style="color: #d97706"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">Anthropic</div>
                <div class="provider-status" id="status-text-anthropic">Not configured</div>
              </div>
              <i class="fas fa-circle status-dot"></i>
            </div>

            <div class="status-card not-configured" id="status-card-gemini">
              <div class="provider-icon" style="background: rgba(66, 133, 244, 0.1)">
                <i class="fas fa-gem" style="color: #4285f4"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">Gemini</div>
                <div class="provider-status" id="status-text-gemini">Not configured</div>
              </div>
              <i class="fas fa-circle status-dot"></i>
            </div>

            <div class="status-card not-configured" id="status-card-bedrock">
              <div class="provider-icon" style="background: rgba(255, 153, 0, 0.1)">
                <i class="fab fa-aws" style="color: #ff9900"></i>
              </div>
              <div class="provider-info">
                <div class="provider-name">Bedrock</div>
                <div class="provider-status" id="status-text-bedrock">Not enabled</div>
              </div>
              <i class="fas fa-circle status-dot"></i>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <div class="section-title">
            <i class="fas fa-info-circle" style="color: var(--vericase-blue)"></i>
            System Information
          </div>
          <p class="section-description">
            Current system configuration details
          </p>

          <div id="system-info" style="display: grid; gap: 0.5rem; font-size: 0.9rem">
            <div><strong>Default Provider:</strong> <span id="info-default-provider">Loading...</span></div>
            <div><strong>Fallback Enabled:</strong> <span id="info-fallback">Loading...</span></div>
            <div><strong>Web Search:</strong> <span id="info-web-search">Loading...</span></div>
            <div><strong>Bedrock Routing:</strong> <span id="info-bedrock-routing">Loading...</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
      <i class="fas fa-check-circle"></i>
      <span id="toast-message">Setting saved successfully!</span>
    </div>

    <script>
      // Inject navigation shell
      document.addEventListener("DOMContentLoaded", () => {
        VericaseShell.inject({
          title: '',
          breadcrumbs: [
            { label: "Home", url: "master-dashboard.html", icon: "fa-home" },
            { label: "Admin Settings", icon: "fa-cog" },
          ],
          headerActions: '',
        });

        // Remove preload class after shell is injected
        requestAnimationFrame(() => {
          document.body.classList.remove("preload");
        });
      });

      const API_BASE = window.location.origin;
      const token = localStorage.getItem("token");

      if (!token) {
        window.location.href = "login.html";
      }

      // All settings keys with descriptions
      const settingDescriptions = {
        textract_page_threshold: "PDFs with more pages than this threshold will use Tika instead of AWS Textract",
        textract_max_pages: "Maximum number of pages Textract can process",
        openai_api_key: "OpenAI API key for GPT models",
        openai_model: "OpenAI model to use for analysis",
        anthropic_api_key: "Anthropic API key for Claude models",
        anthropic_model: "Anthropic model to use for narrative construction",
        gemini_api_key: "Google AI API key for Gemini models",
        gemini_model: "Gemini model to use for pattern recognition",
        bedrock_enabled: "Enable Amazon Bedrock for enterprise AI",
        bedrock_region: "AWS region for Bedrock",
        bedrock_model: "Bedrock model to use for analysis",
        ai_default_provider: "Default AI provider for quick searches",
        ai_web_search_enabled: "Enable web search in AI queries",
        ai_fallback_enabled: "Enable automatic fallback to other providers on failure",
        bedrock_route_claude: "Route all Claude requests through AWS Bedrock (SOC2/HIPAA)",
        ag_grid_default_row_height: "Default row height for AG Grid tables (in pixels)",
        ag_grid_theme: "AG Grid theme for all tables",
        ag_grid_pagination_page_size: "Default number of rows per page",
        ag_grid_enable_excel_export: "Enable Excel export functionality",
        ag_grid_enable_csv_export: "Enable CSV export functionality",
      };

      // Cache for AI models
      let aiModels = {};

      // ====== Tab Navigation ======
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          // Remove active from all
          document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));

          // Add active to clicked
          btn.classList.add("active");
          const tabId = btn.dataset.tab;
          document.getElementById(`tab-${tabId}`).classList.add("active");
        });
      });

      // ====== Toast Notification ======
      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toast-message");
        const icon = toast.querySelector("i");

        toastMessage.textContent = message;
        toast.className = `toast ${type}`;

        if (type === "success") {
          icon.className = "fas fa-check-circle";
        } else if (type === "error") {
          icon.className = "fas fa-exclamation-circle";
        }

        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      // ====== Load Settings ======
      async function loadSettings() {
        try {
          const response = await fetch(`${API_BASE}/api/admin/settings`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.status === 401) {
            console.error("Token expired or invalid - redirecting to login");
            localStorage.removeItem("token");
            alert("Session expired. Please log in again.");
            window.location.href = "login.html";
            return;
          }

          if (response.status === 403) {
            alert("Admin access required");
            window.location.href = "dashboard.html";
            return;
          }

          if (!response.ok) {
            const errorText = await response.text();
            console.error("Error loading settings:", response.status, errorText);
            return;
          }

          const settings = await response.json();

          settings.forEach((setting) => {
            const input = document.getElementById(setting.key);
            if (input) {
              if (setting.key.includes("api_key") && setting.value) {
                input.placeholder = "••••••••" + setting.value.slice(-4);
              } else if (input.type === "checkbox") {
                input.checked = setting.value === "true";
              } else {
                input.value = setting.value;
              }
            }
          });

          // Update system info
          updateSystemInfo(settings);

          // Refresh status
          refreshAllStatus();
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      // ====== Save Setting ======
      async function saveSetting(key) {
        const input = document.getElementById(key);
        const rawValue = input.value;
        const trimmedValue = rawValue.trim();

        // Prevent accidental clearing of API keys.
        if (key.includes("api_key") && trimmedValue === "") {
          const confirmClear = window.confirm(
            "This will clear the stored API key. Continue?"
          );
          if (!confirmClear) {
            return;
          }
        }

        const valueToSend = key.includes("api_key") ? trimmedValue : rawValue;

        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/${key}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              value: valueToSend,
              description: settingDescriptions[key] || key,
            }),
          });

          if (response.status === 403) {
            showToast("Admin access required", "error");
            return;
          }

          if (!response.ok) {
            showToast("Failed to save setting", "error");
            return;
          }

          showToast("Setting saved successfully!");

          // For API keys, clear field and update placeholder
          if (key.includes("api_key")) {
            input.value = "";
            input.placeholder = valueToSend
              ? "••••••••" + valueToSend.slice(-4)
              : "Not configured";
          }

          // Refresh status if it's a provider setting
          if (key.includes("api_key") || key === "bedrock_enabled") {
            setTimeout(refreshAllStatus, 500);
          }
        } catch (error) {
          console.error("Error saving setting:", error);
          showToast("Failed to save setting", "error");
        }
      }

      // ====== Save Model Setting (with custom input support) ======
      async function saveModelSetting(provider) {
        const selectEl = document.getElementById(`${provider}_model`);
        const customEl = document.getElementById(`${provider}_model_custom`);
        
        // Use custom input if filled, otherwise use dropdown
        let modelId = customEl?.value?.trim() || selectEl?.value;
        
        if (!modelId) {
          showToast("Please select or enter a model ID", "error");
          return;
        }
        
        const key = `${provider}_model`;
        
        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/${key}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              value: modelId,
              description: `${provider} model to use`,
            }),
          });

          if (!response.ok) {
            showToast("Failed to save model setting", "error");
            return;
          }

          showToast(`${provider.toUpperCase()} model set to: ${modelId}`);
          
          // Clear custom input and update dropdown if needed
          if (customEl) customEl.value = "";
          
        } catch (error) {
          console.error("Error saving model:", error);
          showToast("Failed to save model", "error");
        }
      }

      // ====== Test Specific Model ======
      async function testSpecificModel(provider) {
        const selectEl = document.getElementById(`${provider}_model`);
        const customEl = document.getElementById(`${provider}_model_custom`);
        const statusEl = document.getElementById(`${provider}_model_status`);
        
        // Use custom input if filled, otherwise use dropdown
        let modelId = customEl?.value?.trim() || selectEl?.value;
        
        if (!modelId) {
          showToast("Please select or enter a model ID to test", "error");
          return;
        }
        
        // Show loading state
        if (statusEl) {
          statusEl.style.display = "block";
          statusEl.className = "model-status-message loading";
          statusEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Testing model "${modelId}"...`;
        }
        
        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/ai/test-model/${provider}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ model_id: modelId }),
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToast(`✓ Model "${modelId}" is accessible! (${result.response_time_ms}ms)`);
            if (statusEl) {
              statusEl.className = "model-status-message success";
              statusEl.innerHTML = `<i class="fas fa-check-circle"></i> Model "${modelId}" works! Response time: ${result.response_time_ms}ms`;
            }
          } else {
            showToast(`✗ Model "${modelId}" failed: ${result.error}`, "error");
            if (statusEl) {
              statusEl.className = "model-status-message error";
              statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${result.error}`;
            }
          }
          
        } catch (error) {
          showToast(`Failed to test model: ${error.message}`, "error");
          if (statusEl) {
            statusEl.className = "model-status-message error";
            statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message}`;
          }
        }
      }

      // ====== Fetch Available Models from Provider API ======
      async function fetchAvailableModels(provider) {
        const selectEl = document.getElementById(`${provider}_model`);
        const statusEl = document.getElementById(`${provider}_model_status`);
        
        if (statusEl) {
          statusEl.style.display = "block";
          statusEl.className = "model-status-message loading";
          statusEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Fetching available models from ${provider}...`;
        }
        
        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/ai/fetch-models/${provider}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          
          const result = await response.json();
          
          if (result.success && result.models?.length > 0) {
            // Update dropdown with fetched models
            selectEl.innerHTML = "";
            result.models.forEach((model) => {
              const option = document.createElement("option");
              option.value = model.id;
              option.textContent = model.name || model.id;
              selectEl.appendChild(option);
            });
            
            showToast(`Found ${result.models.length} models available for your API key`);
            if (statusEl) {
              statusEl.className = "model-status-message success";
              statusEl.innerHTML = `<i class="fas fa-check-circle"></i> Found ${result.models.length} models. Select one and click "Test Model" to verify.`;
            }
          } else if (result.note) {
            // Provider doesn't support model listing
            if (statusEl) {
              statusEl.className = "model-status-message warning";
              statusEl.innerHTML = `<i class="fas fa-info-circle"></i> ${result.note}`;
            }
          } else {
            showToast(`No models found: ${result.error || "Unknown error"}`, "error");
            if (statusEl) {
              statusEl.className = "model-status-message error";
              statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${result.error || "No models found"}`;
            }
          }
          
        } catch (error) {
          showToast(`Failed to fetch models: ${error.message}`, "error");
          if (statusEl) {
            statusEl.className = "model-status-message error";
            statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message}`;
          }
        }
      }

      // ====== Save Checkbox ======
      async function saveCheckbox(key) {
        const input = document.getElementById(key);
        const value = input.checked.toString();

        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/${key}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              value: value,
              description: settingDescriptions[key] || key,
            }),
          });

          if (!response.ok) {
            showToast("Failed to save setting", "error");
            return;
          }

          showToast("Setting saved successfully!");
        } catch (error) {
          console.error("Error saving setting:", error);
          showToast("Failed to save setting", "error");
        }
      }

      // ====== Test Provider ======
      async function testProvider(provider) {
        const btn = event.target.closest("button");
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        btn.disabled = true;

        try {
          const response = await fetch(`${API_BASE}/api/ai-chat/models/test/${provider}`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` },
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showToast(`${provider.toUpperCase()} connected! Model: ${result.model}`);
            updateProviderStatus(provider, true, "Connected");
          } else {
            showToast(`${provider.toUpperCase()} failed: ${result.error || "Unknown error"}`, "error");
            updateProviderStatus(provider, false, "Error");
          }
        } catch (error) {
          showToast(`Failed to test ${provider}: ${error.message}`, "error");
          updateProviderStatus(provider, false, "Error");
        } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      // ====== AI Optimization Functions ======
      async function loadAIOptimizationData() {
        const token = localStorage.getItem("vericase_token");
        if (!token) return;

        try {
          // Get filters
          const provider = document.getElementById("filter-provider")?.value || "";
          const model = document.getElementById("filter-model")?.value || "";
          const functionName = document.getElementById("filter-function")?.value || "";
          const successOnly = document.getElementById("filter-success-only")?.checked || false;

          // Build query string
          const params = new URLSearchParams();
          if (provider) params.append("provider", provider);
          if (model) params.append("model_id", model);
          if (functionName) params.append("function_name", functionName);
          if (successOnly) params.append("success_only", "true");
          params.append("limit", "50");

          // Fetch events
          const response = await fetch(`${API_BASE}/api/admin/ai-optimization/events?${params}`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            throw new Error(`Failed to load AI optimization data: ${response.status}`);
          }

          const data = await response.json();

          // Update statistics cards
          document.getElementById("stat-total-events").textContent = data.stats.total_events.toLocaleString();
          document.getElementById("stat-total-cost").textContent = "$" + data.stats.total_cost_usd.toFixed(2);
          document.getElementById("stat-success-rate").textContent = (data.stats.success_rate * 100).toFixed(1) + "%";
          document.getElementById("stat-avg-response-time").textContent = Math.round(data.stats.average_response_time_ms) + "ms";

          // Update events table
          const tbody = document.getElementById("ai-events-tbody");
          if (data.events.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="padding: 2rem; text-align: center; color: var(--text-secondary);">No events found</td></tr>`;
          } else {
            tbody.innerHTML = data.events.map(event => {
              const date = new Date(event.created_at);
              const statusBadge = event.success
                ? `<span style="background: var(--success-light); color: var(--success); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;"><i class="fas fa-check-circle"></i> Success</span>`
                : `<span style="background: var(--error-light); color: var(--error); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;"><i class="fas fa-times-circle"></i> Failed</span>`;
              return `
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem; font-size: 0.8rem;">${date.toLocaleString()}</td>
                  <td style="padding: 0.75rem; font-size: 0.8rem; text-transform: capitalize;">${event.provider}</td>
                  <td style="padding: 0.75rem; font-size: 0.8rem; font-family: monospace;">${event.model_id}</td>
                  <td style="padding: 0.75rem; font-size: 0.8rem;">${event.function_name || "-"}</td>
                  <td style="padding: 0.75rem; text-align: right; font-size: 0.8rem;">${event.total_tokens || "-"}</td>
                  <td style="padding: 0.75rem; text-align: right; font-size: 0.8rem;">${event.response_time_ms}</td>
                  <td style="padding: 0.75rem; text-align: right; font-size: 0.8rem;">${event.cost_usd ? "$" + event.cost_usd.toFixed(4) : "-"}</td>
                  <td style="padding: 0.75rem; text-align: center;">${statusBadge}</td>
                </tr>
              `;
            }).join("");
          }

          // Update cost breakdown chart
          const costBreakdown = document.getElementById("cost-breakdown");
          if (Object.keys(data.stats.cost_by_provider).length === 0) {
            costBreakdown.innerHTML = "No cost data available";
          } else {
            const bars = Object.entries(data.stats.cost_by_provider)
              .sort((a, b) => b[1] - a[1])
              .map(([provider, cost]) => {
                const percentage = (cost / data.stats.total_cost_usd) * 100;
                return `
                  <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.8rem;">
                      <span style="font-weight: 500; text-transform: capitalize;">${provider}</span>
                      <span style="color: var(--text-secondary);">$${cost.toFixed(2)} (${percentage.toFixed(1)}%)</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                      <div style="width: ${percentage}%; height: 100%; background: var(--vericase-orange);"></div>
                    </div>
                  </div>
                `;
              }).join("");
            costBreakdown.innerHTML = bars;
          }

        } catch (error) {
          console.error("Error loading AI optimization data:", error);
          showToast("Failed to load AI optimization data", "error");
        }
      }

      // ====== Refresh All Status ======
      async function refreshAllStatus() {
        try {
          const response = await fetch(`${API_BASE}/api/ai-chat/models/status`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) return;

          const status = await response.json();

          if (status.models) {
            updateProviderStatus(
              "openai",
              status.models.openai?.available,
              status.models.openai?.available ? "Configured" : "Not configured"
            );
            updateProviderStatus(
              "anthropic",
              status.models.anthropic?.available,
              status.models.anthropic?.available ? "Configured" : "Not configured"
            );
            updateProviderStatus(
              "gemini",
              status.models.gemini?.available,
              status.models.gemini?.available ? "Configured" : "Not configured"
            );
            updateProviderStatus(
              "bedrock",
              status.models.bedrock?.available,
              status.models.bedrock?.available ? "Enabled" : "Not enabled"
            );
            updateProviderStatus(
              "xai",
              status.models.xai?.available,
              status.models.xai?.available ? "Configured" : "Not configured"
            );
            updateProviderStatus(
              "perplexity",
              status.models.perplexity?.available,
              status.models.perplexity?.available ? "Configured" : "Not configured"
            );
          }
        } catch (error) {
          console.error("Error checking provider status:", error);
        }
      }

      // ====== Update Provider Status ======
      function updateProviderStatus(provider, isConfigured, statusText) {
        // Update status card
        const statusCard = document.getElementById(`status-card-${provider}`);
        const statusTextEl = document.getElementById(`status-text-${provider}`);

        if (statusCard) {
          statusCard.classList.remove("configured", "not-configured");
          statusCard.classList.add(isConfigured ? "configured" : "not-configured");
        }

        if (statusTextEl) {
          statusTextEl.textContent = statusText;
        }

        // Update badge in providers tab
        const badge = document.getElementById(`status-badge-${provider}`);
        if (badge) {
          badge.className = `status-badge ${isConfigured ? "configured" : "not-configured"}`;
          badge.innerHTML = `<i class="fas fa-circle"></i> ${statusText}`;
        }
      }

      // ====== Update System Info ======
      function updateSystemInfo(settings) {
        const getValue = (key) => {
          const s = settings.find((s) => s.key === key);
          return s ? s.value : null;
        };

        const defaultProvider = getValue("ai_default_provider") || "gemini";
        const fallback = getValue("ai_fallback_enabled") !== "false" ? "Yes" : "No";
        const webSearch = getValue("ai_web_search_enabled") === "true" ? "Yes" : "No";
        const bedrockRouting = getValue("bedrock_route_claude") === "true" ? "Yes" : "No";

        document.getElementById("info-default-provider").textContent =
          defaultProvider.charAt(0).toUpperCase() + defaultProvider.slice(1);
        document.getElementById("info-fallback").textContent = fallback;
        document.getElementById("info-web-search").textContent = webSearch;
        document.getElementById("info-bedrock-routing").textContent = bedrockRouting;
      }

      // ====== Load AI Models ======
      async function loadAIModels() {
        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/ai/models`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            console.error("Failed to load AI models");
            return;
          }

          const data = await response.json();
          aiModels = data.providers;

          // Populate provider model dropdowns
          populateModelDropdown("openai_model", aiModels.openai?.models || []);
          populateModelDropdown("anthropic_model", aiModels.anthropic?.models || []);
          populateModelDropdown("gemini_model", aiModels.gemini?.models || []);
          populateModelDropdown("bedrock_model", aiModels.bedrock?.models || []);
          populateModelDropdown("xai_model", aiModels.xai?.models || []);
          populateModelDropdown("perplexity_model", aiModels.perplexity?.models || []);

          // Setup function config model dropdowns (if the UI section exists)
          if (
            document.getElementById("fn_quick_search_provider") &&
            document.getElementById("fn_deep_analysis_provider")
          ) {
            setupFunctionModelDropdowns();
          }
        } catch (error) {
          console.error("Error loading AI models:", error);
        }
      }

      // ====== Populate Model Dropdown ======
      function populateModelDropdown(selectId, models) {
        const select = document.getElementById(selectId);
        if (!select || !models.length) return;

        const currentValue = select.value;
        select.innerHTML = "";

        models.forEach((model) => {
          const option = document.createElement("option");
          option.value = model.id;
          // Show the *actual API model ID* so admins can copy/paste it and so
          // we don't accidentally save a display label.
          option.textContent = model.name ? `${model.name} [${model.id}]` : model.id;
          if (model.type) {
            option.textContent += ` (${model.type})`;
          }
          select.appendChild(option);
        });

        // Restore value if exists
        if (currentValue) {
          const exists = Array.from(select.options).some((opt) => opt.value === currentValue);
          if (exists) {
            select.value = currentValue;
          }
        }
      }

      // ====== Setup Function Model Dropdowns ======
      function setupFunctionModelDropdowns() {
        const qsProviderEl = document.getElementById("fn_quick_search_provider");
        const daProviderEl = document.getElementById("fn_deep_analysis_provider");
        const qsModelEl = document.getElementById("fn_quick_search_model");
        const daModelEl = document.getElementById("fn_deep_analysis_model");
        
        if (!qsProviderEl || !daProviderEl || !qsModelEl || !daModelEl) {
          // This UI section is not present in the current Admin Settings page.
          console.debug("Function model dropdowns not found, skipping setup");
          return;
        }

        // Quick search provider change
        qsProviderEl.addEventListener("change", (e) => {
          const models = aiModels[e.target.value]?.models || [];
          populateModelDropdown("fn_quick_search_model", models);
        });

        // Deep analysis provider change
        daProviderEl.addEventListener("change", (e) => {
          const models = aiModels[e.target.value]?.models || [];
          populateModelDropdown("fn_deep_analysis_model", models);
        });

        // Initialize with current provider selections
        const qsProvider = qsProviderEl.value;
        const daProvider = daProviderEl.value;

        populateModelDropdown("fn_quick_search_model", aiModels[qsProvider]?.models || []);
        populateModelDropdown("fn_deep_analysis_model", aiModels[daProvider]?.models || []);
      }

      // ====== Load Function Configs ======
      async function loadFunctionConfigs() {
        try {
          // The function-config UI was removed/replaced by the AI Tool Registry.
          // Only attempt to load/apply function configs if the form controls exist.
          if (!document.getElementById("fn_quick_search_provider")) {
            return;
          }

          const response = await fetch(`${API_BASE}/api/admin/settings/ai/functions`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) return;

          const data = await response.json();

          // Populate quick_search
          if (data.functions?.quick_search) {
            const qs = data.functions.quick_search;
            document.getElementById("fn_quick_search_provider").value = qs.provider || "gemini";
            document.getElementById("fn_quick_search_duration").value = qs.max_duration_seconds || 30;
            document.getElementById("fn_quick_search_thinking").value = qs.thinking_enabled ? "true" : "false";

            // Trigger model dropdown update
            const qsModels = aiModels[qs.provider]?.models || [];
            populateModelDropdown("fn_quick_search_model", qsModels);
            if (qs.model) {
              document.getElementById("fn_quick_search_model").value = qs.model;
            }
          }

          // Populate deep_analysis
          if (data.functions?.deep_analysis) {
            const da = data.functions.deep_analysis;
            document.getElementById("fn_deep_analysis_provider").value = da.provider || "anthropic";
            document.getElementById("fn_deep_analysis_duration").value = da.max_duration_seconds || 300;
            document.getElementById("fn_deep_analysis_thinking").value = da.thinking_enabled ? "true" : "false";
            document.getElementById("fn_deep_analysis_thinking_budget").value = da.thinking_budget_tokens || 5000;

            // Trigger model dropdown update
            const daModels = aiModels[da.provider]?.models || [];
            populateModelDropdown("fn_deep_analysis_model", daModels);
            if (da.model) {
              document.getElementById("fn_deep_analysis_model").value = da.model;
            }
          }
        } catch (error) {
          console.error("Error loading function configs:", error);
        }
      }

      // ====== Save Function Config ======
      async function saveFunctionConfig(functionName) {
        const prefix = `fn_${functionName}_`;

        const config = {
          provider: document.getElementById(`${prefix}provider`).value,
          model: document.getElementById(`${prefix}model`).value,
          max_duration_seconds: parseInt(document.getElementById(`${prefix}duration`).value, 10),
          thinking_enabled: document.getElementById(`${prefix}thinking`).value === "true",
        };

        if (functionName === "deep_analysis") {
          config.thinking_budget_tokens = parseInt(
            document.getElementById(`${prefix}thinking_budget`).value,
            10
          );
        }

        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/ai/functions/${functionName}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(config),
          });

          if (!response.ok) {
            showToast(`Failed to save ${functionName} config`, "error");
            return;
          }

          showToast(`${functionName} configuration saved!`);
        } catch (error) {
          console.error("Error saving function config:", error);
          showToast("Failed to save configuration", "error");
        }
      }

      // ====== AI Tool Registry ======
      const TOOL_ICONS = {
        basic_chat: { icon: "fa-comments", color: "var(--vericase-blue)" },
        vericase_analysis: { icon: "fa-scale-balanced", color: "var(--vericase-teal)" },
        deep_research: { icon: "fa-microscope", color: "#8b5cf6" },
        ai_refinement: { icon: "fa-filter", color: "#f59e0b" },
        chronology_builder: { icon: "fa-timeline", color: "#10b981" },
        delay_analysis: { icon: "fa-clock", color: "#ef4444" },
        natural_language_query: { icon: "fa-search", color: "#3b82f6" },
        auto_classification: { icon: "fa-tags", color: "#6366f1" },
        dataset_insights: { icon: "fa-chart-bar", color: "#ec4899" },
        evidence_summary: { icon: "fa-file-alt", color: "#14b8a6" },
      };

      const TOOL_CATEGORIES = {
        flagship: ["vericase_analysis"],
        research: ["deep_research", "ai_refinement"],
        analysis: ["chronology_builder", "delay_analysis", "evidence_summary"],
        assistant: ["basic_chat", "natural_language_query"],
        automation: ["auto_classification", "dataset_insights"],
      };

      async function loadAIToolConfigs() {
        const container = document.getElementById("ai-tools-container");

        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/ai/tools`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) {
            container.innerHTML = `<div class="info-box" style="background: #fef2f2; border-color: #fecaca;">
              <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
              <div>Failed to load AI tools. Status: ${response.status}</div>
            </div>`;
            return;
          }

          const data = await response.json();
          const tools = data.tools || {};

          // Render tool cards
          container.innerHTML = "";

          for (const [toolName, config] of Object.entries(tools)) {
            const card = renderAIToolCard(toolName, config);
            container.appendChild(card);

            // Populate provider-specific model dropdowns (and preserve current selection)
            populateToolModelDropdown(toolName, config.provider, config.model);
          }

        } catch (error) {
          console.error("Error loading AI tools:", error);
          container.innerHTML = `<div class="info-box" style="background: #fef2f2; border-color: #fecaca;">
            <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
            <div>Error loading AI tools: ${error.message}</div>
          </div>`;
        }
      }

      function renderAIToolCard(toolName, config) {
        const card = document.createElement("div");
        card.className = "function-card";
        card.id = `tool-card-${toolName}`;

        const iconInfo = TOOL_ICONS[toolName] || { icon: "fa-cog", color: "#6b7280" };
        const displayName = config.display_name || toolName.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
        const description = config.description || "";
        const category = config.category || "general";
        const isEnabled = config.enabled !== false;

        card.innerHTML = `
          <div class="function-header">
            <div class="function-title">
              <i class="fas ${iconInfo.icon}" style="color: ${iconInfo.color}"></i>
              ${displayName}
              <span class="category-badge" style="background: ${isEnabled ? 'var(--vericase-teal)' : '#9ca3af'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">
                ${category}
              </span>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                <input type="checkbox" id="tool_${toolName}_enabled" ${isEnabled ? "checked" : ""}
                  onchange="toggleToolEnabled('${toolName}', this.checked)" />
                Enabled
              </label>
              <button class="btn btn-primary" onclick="saveToolConfig('${toolName}')">
                <i class="fas fa-save"></i> Save
              </button>
            </div>
          </div>
          <p class="section-description" style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
            ${description}
          </p>
          <div class="function-grid">
            <div class="function-field">
              <label>Provider</label>
              <select id="tool_${toolName}_provider" class="setting-input" onchange="updateToolModelOptions('${toolName}')">
                <option value="openai" ${config.provider === "openai" ? "selected" : ""}>OpenAI</option>
                <option value="anthropic" ${config.provider === "anthropic" ? "selected" : ""}>Anthropic</option>
                <option value="gemini" ${config.provider === "gemini" ? "selected" : ""}>Gemini</option>
                <option value="bedrock" ${config.provider === "bedrock" ? "selected" : ""}>Bedrock</option>
                <option value="xai" ${config.provider === "xai" ? "selected" : ""}>xAI (Grok)</option>
                <option value="perplexity" ${config.provider === "perplexity" ? "selected" : ""}>Perplexity</option>
              </select>
            </div>
            <div class="function-field">
              <label>Model</label>
              <select id="tool_${toolName}_model_select" class="setting-input"></select>
              <input type="text" id="tool_${toolName}_model_custom" class="setting-input" style="margin-top: 6px;"
                value="" placeholder="Or enter custom model ID..." />
            </div>
            <div class="function-field">
              <label>Max Tokens</label>
              <input type="number" id="tool_${toolName}_max_tokens" class="setting-input"
                value="${config.max_tokens || 4000}" min="100" max="100000" />
            </div>
            <div class="function-field">
              <label>Temperature</label>
              <input type="number" id="tool_${toolName}_temperature" class="setting-input"
                value="${config.temperature || 0.3}" min="0" max="2" step="0.1" />
            </div>
            <div class="function-field">
              <label>Max Duration (sec)</label>
              <input type="number" id="tool_${toolName}_duration" class="setting-input"
                value="${config.max_duration_seconds || 60}" min="5" max="600" />
            </div>
          </div>
          ${config.fallback_chain && config.fallback_chain.length > 0 ? `
            <div class="info-box" style="margin-top: 1rem;">
              <i class="fas fa-random"></i>
              <div>
                <strong>Fallback Chain:</strong>
                ${config.fallback_chain.map(f => `${f[0]}/${f[1]}`).join(" → ")}
              </div>
            </div>
          ` : ""}
        `;

        return card;
      }

      function toggleToolEnabled(toolName, enabled) {
        // Visual feedback - just update the badge for now
        const card = document.getElementById(`tool-card-${toolName}`);
        if (card) {
          const badge = card.querySelector(".category-badge");
          if (badge) {
            badge.style.background = enabled ? "var(--vericase-teal)" : "#9ca3af";
          }
        }
      }

      function updateToolModelOptions(toolName) {
        const provider = document.getElementById(`tool_${toolName}_provider`)?.value;
        populateToolModelDropdown(toolName, provider, null);
      }

      function populateToolModelDropdown(toolName, provider, currentModel) {
        const select = document.getElementById(`tool_${toolName}_model_select`);
        const custom = document.getElementById(`tool_${toolName}_model_custom`);

        if (!select) return;

        const models = (aiModels && provider && aiModels[provider] && aiModels[provider].models) ? aiModels[provider].models : [];

        const existing = currentModel || "";
        select.innerHTML = "";

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "-- Select model --";
        select.appendChild(placeholder);

        models.forEach((m) => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.name ? `${m.name} [${m.id}]` : m.id;
          select.appendChild(opt);
        });

        const hasModel = existing && Array.from(select.options).some((o) => o.value === existing);
        if (hasModel) {
          select.value = existing;
          if (custom) custom.value = "";
        } else {
          select.value = "";
          if (custom) custom.value = existing;
        }
      }

      async function saveToolConfig(toolName) {
        const enabled = document.getElementById(`tool_${toolName}_enabled`)?.checked;
        const provider = document.getElementById(`tool_${toolName}_provider`)?.value;
        const modelFromSelect = document.getElementById(`tool_${toolName}_model_select`)?.value;
        const modelFromCustom = document.getElementById(`tool_${toolName}_model_custom`)?.value;
        const model = (modelFromCustom && modelFromCustom.trim()) || modelFromSelect;
        const maxTokens = parseInt(document.getElementById(`tool_${toolName}_max_tokens`)?.value) || null;
        const temperature = parseFloat(document.getElementById(`tool_${toolName}_temperature`)?.value) || null;
        const duration = parseInt(document.getElementById(`tool_${toolName}_duration`)?.value) || null;

        const update = {};
        if (enabled !== undefined) update.enabled = enabled;
        if (provider) update.provider = provider;
        if (model) update.model = model;
        if (maxTokens) update.max_tokens = maxTokens;
        if (temperature !== null) update.temperature = temperature;
        if (duration) update.max_duration_seconds = duration;

        try {
          const response = await fetch(`${API_BASE}/api/admin/settings/ai/tools/${toolName}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(update),
          });

          if (!response.ok) {
            const errorData = await response.json();
            showToast(errorData.detail || `Failed to save ${toolName}`, "error");
            return;
          }

          showToast(`${toolName.replace(/_/g, " ")} configuration saved!`);
        } catch (error) {
          console.error("Error saving tool config:", error);
          showToast("Failed to save configuration", "error");
        }
      }

      // ====== Case Law Intelligence ======
      async function loadCaseLawMiningStatus() {
        const statusEl = document.getElementById("caselaw-mine-status");
        const extractedEl = document.getElementById("caselaw-total-cases");
        const pendingEl = document.getElementById("caselaw-pending-cases");
        const processingEl = document.getElementById("caselaw-processing-cases");
        const failedEl = document.getElementById("caselaw-failed-cases");

        try {
          if (statusEl) statusEl.textContent = "Loading…";
          const response = await fetch(`${API_BASE}/api/caselaw/mining/status`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) {
            if (statusEl) statusEl.textContent = `Failed (${response.status})`;
            return;
          }

          const data = await response.json();
          const counts = data.counts || {};
          const extracted = counts.extracted ?? 0;
          const pending = counts.pending ?? 0;
          const processing = counts.processing ?? 0;
          const failed = counts.failed ?? 0;

          if (extractedEl) extractedEl.textContent = extracted;
          if (pendingEl) pendingEl.textContent = pending;
          if (processingEl) processingEl.textContent = processing;
          if (failedEl) failedEl.textContent = failed;
          if (statusEl) statusEl.textContent = "Ready";
        } catch (error) {
          console.error("Error loading caselaw mining status:", error);
          if (statusEl) statusEl.textContent = "Error";
        }
      }

      async function runCaseLawMiningBatch() {
        const limit = parseInt(document.getElementById("caselaw-mine-limit")?.value || "50", 10);
        const concurrency = parseInt(document.getElementById("caselaw-mine-concurrency")?.value || "2", 10);
        const includeFailed = !!document.getElementById("caselaw-mine-include-failed")?.checked;
        const includeExtracted = !!document.getElementById("caselaw-mine-include-extracted")?.checked;
        const constructionOnly = !!document.getElementById("caselaw-mine-construction-only")?.checked;
        const statusEl = document.getElementById("caselaw-mine-status");

        if (statusEl) statusEl.textContent = "Queueing…";
        try {
          const response = await fetch(`${API_BASE}/api/caselaw/mining/run`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              limit,
              concurrency,
              include_failed: includeFailed,
              include_extracted: includeExtracted,
              construction_only: constructionOnly,
            }),
          });

          if (!response.ok) {
            let message = "Failed to start mining";
            try {
              const errorData = await response.json();
              message = errorData.detail || message;
            } catch (e) {}
            showToast(message, "error");
            if (statusEl) statusEl.textContent = "Failed";
            return;
          }

          const data = await response.json();
          showToast(`Queued ${data.queued || 0} case(s) for mining`, "success");
          if (statusEl) statusEl.textContent = `Queued ${data.queued || 0}`;
          await loadCaseLawMiningStatus();
          setTimeout(loadCaseLawTrends, 2000);
        } catch (error) {
          console.error("Error starting caselaw mining:", error);
          if (statusEl) statusEl.textContent = "Error";
          showToast("Failed to start mining", "error");
        }
      }

      async function runCaseLawKBIngest() {
        const statusEl = document.getElementById("caselaw-kb-status");
        if (statusEl) statusEl.textContent = "Starting.";
        try {
          const response = await fetch(`${API_BASE}/api/caselaw/kb/ingest`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          if (!response.ok) {
            let message = "Failed to start ingestion";
            try {
              const errorData = await response.json();
              message = errorData.detail || message;
            } catch (e) {}
            if (statusEl) statusEl.textContent = message;
            showToast(message, "error");
            return;
          }
          const data = await response.json();
          const status = data.status ? `Ingesting (${data.status})` : "Ingestion started";
          if (statusEl) statusEl.textContent = status;
          showToast("Knowledge base ingestion started", "success");
        } catch (error) {
          console.error("Error starting caselaw KB ingestion:", error);
          if (statusEl) statusEl.textContent = "Error";
          showToast("Failed to start KB ingestion", "error");
        }
      }

      async function loadCaseLawTrends() {
        const statusEl = document.getElementById("caselaw-trends-status");
        const totalEl = document.getElementById("caselaw-total-cases");
        const themesEl = document.getElementById("caselaw-top-themes");
        const issuesEl = document.getElementById("caselaw-top-issues");
        const tagsEl = document.getElementById("caselaw-top-tags");
        const outcomesEl = document.getElementById("caselaw-top-outcomes");
        const bucketsEl = document.getElementById("caselaw-top-buckets");
        const predictiveEl = document.getElementById("caselaw-predictive-signals");
        const predictiveMetaEl = document.getElementById("caselaw-predictive-meta");
        const proactiveEl = document.getElementById("caselaw-proactive-trends");
        const proactiveMetaEl = document.getElementById("caselaw-proactive-meta");

        const setList = (el, items) => {
          if (!el) return;
          el.innerHTML = items && items.length
            ? items.map((i) => `<li>${i.value} <span style="color: var(--text-secondary)">(${i.count})</span></li>`).join("")
            : "<li style='color: var(--text-secondary)'>No data</li>";
        };
        const formatPct = (value) => {
          if (typeof value !== "number") return "-";
          return `${Math.round(value * 100)}%`;
        };
        const formatLift = (value) => {
          if (typeof value !== "number") return "-";
          return `${value.toFixed(2)}x`;
        };
          const formatFeatureType = (value) => {
          const type = String(value || "").toLowerCase();
          const mapping = {
            theme: "Theme",
            contentious_issue: "Issue",
            tag: "Tag",
            issue: "Issue",
            delay_cause: "Delay Cause",
            defect_type: "Defect Type",
            key_clause: "Key Clause",
            contract_form: "Contract Form",
            procurement_route: "Procurement Route",
            construction_bucket: "Bucket",
            rfi_count: "RFI Count",
            change_order_count: "Change Orders",
            delay_days: "Delay Days",
            eot_days_granted: "EOT Days",
            claim_value_gbp: "Claim Value",
            award_amount_gbp: "Award Amount",
          };
          return mapping[type] || "Signal";
        };
        const setSignals = (el, items) => {
          if (!el) return;
          el.innerHTML = items && items.length
            ? items.map((signal) => {
              const featureType = formatFeatureType(signal.feature_type);
              const feature = signal.feature || "Unknown";
              const outcome = signal.outcome || "Unknown";
              const featureRate = formatPct(signal.feature_rate);
              const baseRate = formatPct(signal.base_rate);
              const lift = formatLift(signal.lift);
              const support = signal.support ?? 0;
              const featureCases = signal.feature_cases ?? 0;
              return `<li>${featureType}: ${feature} -> ${outcome} (${featureRate} vs ${baseRate}, lift ${lift}, n=${support}/${featureCases})</li>`;
            }).join("")
            : "<li style='color: var(--text-secondary)'>Not enough data yet</li>";
        };
        const setProactive = (el, items) => {
          if (!el) return;
          el.innerHTML = items && items.length
            ? items.map((signal) => {
              const featureType = formatFeatureType(signal.feature_type);
              const feature = signal.feature || "Unknown";
              const outcome = signal.outcome || "Unknown";
              const lift = formatLift(signal.lift);
              const support = signal.support ?? 0;
              const level = signal.level || "watch";
              return `<li>${featureType}: ${feature} -> ${outcome} (${level}, lift ${lift}, n=${support})</li>`;
            }).join("")
            : "<li style='color: var(--text-secondary)'>No proactive trends yet</li>";
        };

        try {
          if (statusEl) statusEl.textContent = "Loading…";
          await loadCaseLawMiningStatus();
          const response = await fetch(`${API_BASE}/api/caselaw/trends?top_n=8`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!response.ok) {
            if (statusEl) statusEl.textContent = `Failed (${response.status})`;
            return;
          }
          const data = await response.json();
          if (totalEl) totalEl.textContent = data.total_cases ?? "0";
          setList(themesEl, data.themes || []);
          setList(issuesEl, data.contentious_issues || []);
          setList(tagsEl, data.tags || []);
          setList(outcomesEl, data.outcomes || []);
          setList(bucketsEl, data.construction_buckets || []);
          setSignals(predictiveEl, data.predictive_signals || []);
          if (predictiveMetaEl) {
            const count = data.predictive_case_count ?? 0;
            predictiveMetaEl.textContent = `Signals based on ${count} case(s) with outcomes.`;
          }
          setProactive(proactiveEl, data.proactive_trends || []);
          if (proactiveMetaEl) {
            proactiveMetaEl.textContent = data.proactive_fallback
              ? "Watching signals (low volume)."
              : "Actionable signals.";
          }
          if (statusEl) statusEl.textContent = "Last updated just now";
        } catch (error) {
          console.error("Error loading caselaw trends:", error);
          if (statusEl) statusEl.textContent = "Error loading trends";
        }
      }

      async function runTagSuggestion() {
        const text = document.getElementById("caselaw-suggest-text")?.value || "";
        const topN = parseInt(document.getElementById("caselaw-suggest-topn")?.value || "8", 10);
        const statusEl = document.getElementById("caselaw-suggest-status");
        const tagsEl = document.getElementById("caselaw-suggest-tags");
        const issuesEl = document.getElementById("caselaw-suggest-issues");

        if (!text.trim()) {
          showToast("Please paste some text to analyze.", "error");
          return;
        }

        if (statusEl) statusEl.textContent = "Running…";
        try {
          const response = await fetch(`${API_BASE}/api/caselaw/suggest-tags`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ text, top_n: topN }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            showToast(errorData.detail || "Failed to suggest tags", "error");
            if (statusEl) statusEl.textContent = "Failed";
            return;
          }

          const data = await response.json();
          if (tagsEl) tagsEl.textContent = (data.tags || []).join(", ") || "—";
          if (issuesEl) issuesEl.textContent = (data.contentious_issues || []).join(", ") || "—";
          if (statusEl) statusEl.textContent = "Done";
        } catch (error) {
          console.error("Error running tag suggestion:", error);
          if (statusEl) statusEl.textContent = "Error";
          showToast("Failed to suggest tags", "error");
        }
      }

      async function uploadCaseLawContext() {
        const fileInput = document.getElementById("caselaw-context-file");
        const tagInput = document.getElementById("caselaw-context-tag");
        const statusEl = document.getElementById("caselaw-context-upload-status");
        const tagValue = tagInput?.value?.trim() || "caselaw-context";
        const files = Array.from(fileInput?.files || []);

        if (!files.length) {
          showToast("Select at least one file to upload.", "error");
          return;
        }

        if (statusEl) statusEl.textContent = "Uploading.";
        let successCount = 0;
        let failCount = 0;
        for (const file of files) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("tags", tagValue);
          try {
            const response = await fetch(`${API_BASE}/api/caselaw/context/upload`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: formData,
            });
            if (!response.ok) {
              let message = "Upload failed";
              try {
                const errorData = await response.json();
                message = errorData.detail || message;
              } catch (e) {
                try {
                  const text = await response.text();
                  message = text || message;
                } catch (_) {}
              }
              showToast(message, "error");
              failCount += 1;
              continue;
            }
            successCount += 1;
          } catch (error) {
            console.error("Context upload failed:", error);
            failCount += 1;
          }
        }

        if (statusEl) statusEl.textContent = `Uploaded ${successCount}/${files.length}`;
        if (successCount > 0) {
          const suffix = failCount ? ` (${failCount} failed)` : "";
          showToast(`Uploaded ${successCount} context file(s)${suffix}`, "success");
        } else {
          showToast("No files uploaded. Check the console/network tab for details.", "error");
        }
        if (fileInput) fileInput.value = "";
      }

      async function runContextSuggestion() {
        const tagValue = document.getElementById("caselaw-context-tag")?.value?.trim() || "caselaw-context";
        const maxItems = parseInt(document.getElementById("caselaw-context-max")?.value || "5", 10);
        const statusEl = document.getElementById("caselaw-context-suggest-status");
        const tagsEl = document.getElementById("caselaw-context-tags");
        const issuesEl = document.getElementById("caselaw-context-issues");

        if (statusEl) statusEl.textContent = "Analyzing.";
        try {
          const response = await fetch(`${API_BASE}/api/caselaw/context/suggest`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              tag: tagValue,
              max_items: maxItems,
              top_n: 10,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            showToast(errorData.detail || "Failed to generate suggestions", "error");
            if (statusEl) statusEl.textContent = "Failed";
            return;
          }

          const data = await response.json();
          const suggestions = data.suggestions || {};
          if (tagsEl) tagsEl.textContent = (suggestions.tags || []).join(", ") || "-";
          if (issuesEl) issuesEl.textContent = (suggestions.contentious_issues || []).join(", ") || "-";
          if (statusEl) statusEl.textContent = `Done (${data.evidence_count || 0} docs)`;
        } catch (error) {
          console.error("Error generating context suggestions:", error);
          if (statusEl) statusEl.textContent = "Error";
          showToast("Failed to generate suggestions", "error");
        }
      }

      // ====== Initialize ======
      async function init() {
        await loadAIModels();
        await loadSettings();
        await loadFunctionConfigs();
        await loadAIToolConfigs();
        await loadCaseLawTrends();
      }

      init();
    </script>
  </body>
</html>

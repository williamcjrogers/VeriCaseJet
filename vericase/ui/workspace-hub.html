<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VeriCase - Workspaces</title>
  <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="brand-styles.css?v=9" />
  <link rel="stylesheet" href="design-system.css?v=9" />
  <script src="vericase-ui.js"></script>
  <script src="nav-shell.js"></script>
  <style>
    /* Workspace hub provides its own in-page header; avoid duplicated breadcrumb bars when wrapped in the shell */
    .app-shell .hub-breadcrumb {
      display: none;
    }

    /* Fallback (if the shell doesn’t inject for any reason) */
    body.workspace-hub-page {
      background-color: var(--vericase-cream);
      background-image: radial-gradient(var(--gray-200) 1px, transparent 1px);
      background-size: 24px 24px;
    }

    body.workspace-hub-page > .workspace-hub-container {
      padding: 32px 48px;
      min-height: 100vh;
    }
    /* === WORKSPACES - DIRECTORY + WORKSPACE VIEW === */

    /* === BREADCRUMB BAR === */
    .hub-breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .hub-breadcrumb a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.15s ease;
    }

    .hub-breadcrumb a:hover {
      color: var(--vericase-teal);
    }

    .hub-breadcrumb .separator {
      color: var(--gray-300);
      font-size: 0.75rem;
    }

    .hub-breadcrumb .current {
      color: var(--text-primary);
      font-weight: 500;
    }

    .hub-subtext {
      color: var(--text-muted);
      font-size: 0.9375rem;
      line-height: 1.5;
      margin: -8px 0 14px;
      max-width: 85ch;
    }

    .hub-subtext.hub-subtext-roomy {
      margin: -8px 0 20px;
      max-width: 70ch;
    }

    /* The navigation shell injects the REAL `.app-content` container.
       This page should style that container (not create a nested `.app-content`). */
    .app-content {
      background-color: var(--vericase-cream);
      background-image: radial-gradient(var(--gray-200) 1px, transparent 1px);
      background-size: 24px 24px;
      border: none;
      border-radius: 0;
      box-shadow: none;
      margin: 0;
      padding: 32px 48px;
      min-height: 100vh;
      position: relative;
    }

    /* Page width container (prevents ultra-wide “stretched” layouts) */
    .workspace-hub-container {
      max-width: 1440px;
      margin: 0 auto;
      width: 100%;
    }

    /* === WORKSPACES DIRECTORY (LIST) === */
    .directory-hero {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: var(--space-6);
      flex-wrap: wrap;
      margin-bottom: var(--space-5);
      position: relative;
      z-index: 1;
    }

    .directory-title-row {
      display: flex;
      align-items: flex-start;
      gap: var(--space-4);
    }

    .directory-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(var(--vericase-teal-rgb), 0.10);
      color: var(--vericase-teal);
      border: 1px solid rgba(var(--vericase-teal-rgb), 0.18);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .directory-title {
      font-family: var(--font-serif);
      font-size: 1.75rem;
      font-weight: 650;
      color: var(--text-primary);
      line-height: 1.15;
      margin: 0;
      display: inline-flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .directory-count-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      font-weight: 600;
      background: rgba(var(--vericase-teal-rgb), 0.10);
      border: 1px solid rgba(var(--vericase-teal-rgb), 0.20);
      color: var(--vericase-teal);
      min-width: 42px;
    }

    .directory-count-pill:empty {
      visibility: hidden;
    }

    .directory-subtitle {
      margin-top: 6px;
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 76ch;
      line-height: 1.45;
    }

    .directory-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .directory-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      flex-wrap: wrap;
      margin-bottom: var(--space-6);
      padding: var(--space-4);
      background: rgba(255, 255, 255, 0.82);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      position: relative;
      z-index: 1;
    }

    .directory-search {
      position: relative;
      flex: 1;
      min-width: min(560px, 100%);
    }

    .directory-search i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 0.9rem;
      pointer-events: none;
    }

    .directory-search input.form-input {
      width: 100%;
      padding-left: 38px;
      padding-right: 44px;
      background: #ffffff;
    }

    .directory-search-clear {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--gray-200);
      background: var(--gray-50);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .directory-search-clear:hover {
      background: var(--gray-100);
      color: var(--text-primary);
      border-color: var(--gray-300);
    }

    .directory-toolbar-right {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .directory-filters {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    .directory-filters .form-select {
      min-width: 170px;
    }

    .directory-meta {
      font-size: 0.85rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Workspace cards (directory) */
    .workspace-card {
      background: rgba(255, 255, 255, 0.92);
      border-color: var(--border-default);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .workspace-card::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: rgba(var(--vericase-teal-rgb), 0.45);
      opacity: 0.6;
    }

    .workspace-card:hover::before {
      opacity: 1;
    }

    .workspace-card:focus-within {
      border-color: rgba(var(--vericase-teal-rgb), 0.65);
      box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.18), var(--shadow-lg);
    }

    .workspace-card .item-title {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .workspace-card .item-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      align-items: start;
    }

    .workspace-card .workspace-preview {
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .workspace-card--skeleton {
      cursor: default;
    }

    .workspace-card--skeleton:hover {
      transform: none;
      box-shadow: var(--shadow-sm);
      border-color: var(--border-default);
    }

    .workspace-card-skel-top {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
    }

    .sk-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      flex-shrink: 0;
    }

    .workspace-card-skel-lines {
      flex: 1;
      display: grid;
      gap: 8px;
      min-width: 0;
    }

    .sk-line {
      height: 12px;
      border-radius: 10px;
    }

    .sk-line--title {
      width: 70%;
      height: 14px;
    }

    .sk-line--meta {
      width: 48%;
      height: 11px;
    }

    .sk-pill {
      width: 78px;
      height: 18px;
      border-radius: 999px;
      flex-shrink: 0;
    }

    .workspace-card-skel-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      border-top: 1px solid var(--gray-100);
      padding-top: 12px;
    }

    .sk-stat {
      height: 12px;
      border-radius: 10px;
    }

    /* === WORKSPACE HEADER === */
    .workspace-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 24px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .workspace-identity {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .workspace-icon-large {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      background: linear-gradient(135deg, rgba(31, 111, 120, 0.15) 0%, rgba(47, 134, 200, 0.1) 100%);
      color: var(--vericase-teal);
      flex-shrink: 0;
    }

    .workspace-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .workspace-name {
      font-family: var(--font-serif);
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .workspace-code-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .workspace-code-badge .code {
      background: var(--gray-100);
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 500;
    }

    .workspace-code-badge .contract-type {
      color: var(--vericase-teal);
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* === STATS BAR === */
    .stats-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .stat-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #FFFFFF;
      border: 1px solid var(--border-default);
      border-left: 3px solid var(--gray-300);
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      color: var(--text-secondary);
      box-shadow: var(--shadow-card);
      transition: all 0.15s ease;
    }

    .stat-pill:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    /* Accent borders for each stat */
    .stat-pill.projects { border-left-color: var(--vericase-navy); }
    .stat-pill.cases { border-left-color: var(--vericase-gold); }
    .stat-pill.deadlines { border-left-color: var(--status-warning); }
    .stat-pill.documents { border-left-color: var(--vericase-teal); }
    .stat-pill.members { border-left-color: #78716C; }

    .stat-pill i {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .stat-pill strong {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--text-primary);
    }

    /* === TAB NAVIGATION === */
    .hub-tabs {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid var(--gray-200);
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .hub-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: transparent;
      border: none;
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .hub-tab:hover {
      color: var(--text-primary);
      background: var(--gray-50);
    }

    .hub-tab.active {
      color: var(--vericase-teal);
      border-bottom-color: var(--vericase-teal);
      font-weight: 600;
    }

    .hub-tab i {
      font-size: 0.875rem;
    }

    .hub-tab .tab-count {
      background: var(--gray-100);
      padding: 2px 8px;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .hub-tab.active .tab-count {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      color: var(--vericase-teal);
    }

    /* === TAB PANELS === */
    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* === SECTIONS === */
    .hub-section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-title i {
      color: var(--vericase-teal);
      font-size: 1rem;
    }

    .section-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      padding: 0 8px;
      background: var(--gray-100);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .section-actions {
      display: flex;
      gap: 8px;
    }

    /* === ITEM CARDS === */
    .items-grid {
      display: grid;
      /* Prevent horizontal overflow at high zoom / narrow viewports */
      grid-template-columns: repeat(auto-fill, minmax(min(340px, 100%), 1fr));
      gap: 20px;
    }

    .item-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--gray-200);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .item-card:hover {
      border-color: var(--vericase-teal);
      box-shadow: 0 8px 24px rgba(15, 23, 32, 0.1);
      transform: translateY(-2px);
    }

    .item-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .item-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      flex-shrink: 0;
    }

    .item-icon.project {
      background: rgba(47, 134, 200, 0.1);
      color: #2f86c8;
    }

    .item-icon.case {
      background: rgba(181, 155, 106, 0.15);
      color: var(--vericase-gold);
    }

    .item-icon.workspace {
      background: rgba(var(--vericase-teal-rgb), 0.12);
      color: var(--vericase-teal);
    }

    .item-status {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 4px 10px;
      border-radius: var(--radius-md);
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    .item-status.pending {
      background: rgba(234, 179, 8, 0.1);
      color: #ca8a04;
    }

    .item-status.closed {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
    }

    .item-content {
      margin-bottom: 12px;
    }

    .item-title {
      font-size: 1.0625rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .item-code {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .item-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .item-stats {
      display: flex;
      gap: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--gray-100);
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .item-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .item-stat i {
      font-size: 0.75rem;
      opacity: 0.7;
      flex-shrink: 0;
    }

    .item-stat strong {
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Card Action Buttons */
    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--gray-100);
    }

    .card-action-btn {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
      overflow-wrap: anywhere;
    }

    .card-action-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-300);
      color: var(--text-primary);
    }

    .card-action-btn.primary {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      border-color: rgba(var(--vericase-teal-rgb), 0.3);
      color: var(--vericase-teal);
    }

    .card-action-btn.primary:hover {
      background: rgba(var(--vericase-teal-rgb), 0.15);
      border-color: var(--vericase-teal);
    }

    .card-action-btn i {
      font-size: 0.75rem;
    }

    /* === EMPTY STATE === */
    .empty-state {
      background: var(--gray-50);
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-lg);
      padding: 48px 24px;
      text-align: center;
    }

    .empty-icon {
      font-size: 2.5rem;
      color: var(--gray-400);
      margin-bottom: 16px;
    }

    .empty-title {
      font-size: 1.0625rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-desc {
      font-size: 0.9375rem;
      color: var(--text-muted);
      margin-bottom: 20px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .workspace-preview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--gray-200);
    }

    .workspace-preview-title {
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .workspace-preview-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .workspace-preview-item {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .workspace-preview-empty {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    /* === MANAGEMENT TABLE === */
    .mgmt-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--gray-200);
    }

    .mgmt-table th {
      text-align: left;
      padding: 14px 16px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
    }

    .mgmt-table td {
      padding: 14px 16px;
      font-size: 0.9375rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
    }

    .mgmt-table tbody tr:last-child td {
      border-bottom: none;
    }

    .mgmt-table tbody tr:hover {
      background: var(--gray-50);
    }

    .mgmt-table .actions-col {
      width: 100px;
      text-align: right;
    }

    .mgmt-table .date-col {
      width: 120px;
    }

    .mgmt-table .status-col {
      width: 140px;
    }

    .table-action-btn {
      background: transparent;
      border: none;
      padding: 6px 8px;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: 4px;
      transition: all 0.15s;
    }

    .table-action-btn:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .table-action-btn.danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    /* Date badges */
    .date-badge {
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--gray-100);
      color: var(--text-secondary);
    }

    .date-badge.overdue {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      font-weight: 600;
    }

    .date-badge.soon {
      background: rgba(234, 179, 8, 0.1);
      color: #ca8a04;
      font-weight: 600;
    }

    .date-badge.upcoming {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      padding: 4px 10px;
      border-radius: var(--radius-md);
      font-weight: 500;
    }

    .status-badge.active {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    .status-badge.pending {
      background: rgba(234, 179, 8, 0.1);
      color: #ca8a04;
    }

    .status-badge.complete {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
    }

    /* === INLINE ADD FORM === */
    .inline-add-row {
      background: rgba(var(--vericase-teal-rgb), 0.03);
      border: 2px dashed rgba(var(--vericase-teal-rgb), 0.3);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-top: 16px;
    }

    .inline-add-row .form-row {
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
    }

    .inline-add-row .form-group {
      margin: 0;
    }

    .inline-add-row .form-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .inline-add-row .form-input,
    .inline-add-row .form-select {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--gray-300);
      font-size: 0.9375rem;
      width: 100%;
    }

    .inline-add-row .form-input:focus,
    .inline-add-row .form-select:focus {
      outline: none;
      border-color: var(--vericase-teal);
      box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.1);
    }

    /* === DOCUMENTS GRID === */
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(min(200px, 100%), 1fr));
      gap: 16px;
    }

    .document-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .document-card:hover {
      border-color: var(--vericase-teal);
      box-shadow: 0 4px 12px rgba(15, 23, 32, 0.08);
    }

    .document-card .doc-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .document-card:hover .doc-actions {
      opacity: 1;
    }

    .document-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 12px;
      background: var(--gray-50);
      color: var(--text-muted);
    }

    .document-icon.pdf { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
    .document-icon.doc { background: rgba(37, 99, 235, 0.1); color: #2563eb; }
    .document-icon.xls { background: rgba(22, 163, 74, 0.1); color: #16a34a; }
    .document-icon.img { background: rgba(168, 85, 247, 0.1); color: #9333ea; }

    .document-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .document-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-lg);
      padding: 40px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--gray-50);
      margin-bottom: 24px;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--vericase-teal);
      background: rgba(var(--vericase-teal-rgb), 0.05);
    }

    .upload-zone i {
      font-size: 2.5rem;
      color: var(--gray-400);
      margin-bottom: 12px;
    }

    .upload-zone:hover i {
      color: var(--vericase-teal);
    }

    .upload-zone .upload-text {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .upload-zone .upload-hint {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    /* === TEAM LIST === */
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr));
      gap: 16px;
    }

    .team-member {
      display: flex;
      align-items: center;
      gap: 16px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 16px;
      position: relative;
    }

    .team-member:hover {
      border-color: var(--gray-300);
    }

    .team-member .member-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .team-member:hover .member-actions {
      opacity: 1;
    }

    .team-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--vericase-teal), #2f86c8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .team-info {
      flex: 1;
      min-width: 0;
    }

    .team-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .team-email {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .team-role {
      display: inline-flex;
      align-items: center;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: var(--radius-md);
      background: var(--gray-100);
      color: var(--text-secondary);
    }

    .team-role.admin {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      color: var(--vericase-teal);
    }

    /* === COLLABORATION === */
    .collab-section {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
    }

    .collab-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-100);
    }

    .collab-section-header h4 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .collab-section-header h4 i {
      color: var(--vericase-teal);
    }

    .collab-section-body {
      padding: 20px;
    }

    /* Notes */
    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .note-item {
      background: var(--gray-50);
      border-radius: var(--radius-md);
      padding: 16px;
      position: relative;
    }

    .note-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .note-author {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    .note-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .note-content {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .note-input-wrapper {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .note-input-wrapper textarea {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      resize: none;
      font-size: 0.9375rem;
      min-height: 80px;
    }

    .note-input-wrapper textarea:focus {
      outline: none;
      border-color: var(--vericase-teal);
    }

    /* Activity Feed */
    .activity-feed {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .activity-item {
      display: flex;
      gap: 12px;
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .activity-icon.add { background: rgba(34, 197, 94, 0.1); color: #16a34a; }
    .activity-icon.edit { background: rgba(37, 99, 235, 0.1); color: #2563eb; }
    .activity-icon.delete { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
    .activity-icon.comment { background: rgba(168, 85, 247, 0.1); color: #9333ea; }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-size: 0.875rem;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .activity-text strong {
      font-weight: 600;
    }

    .activity-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* === BACK LINK === */
    .back-section {
      padding-top: 24px;
      border-top: 1px solid var(--gray-200);
      margin-top: 32px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 0.9375rem;
      text-decoration: none;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: var(--vericase-teal);
    }

    /* === MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 32, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: 0 20px 60px rgba(15, 23, 32, 0.2);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-100);
    }

    .modal-header h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-body .form-group {
      margin-bottom: 16px;
    }

    .modal-body .form-label {
      display: block;
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .modal-body .form-input,
    .modal-body .form-select,
    .modal-body .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.9375rem;
    }

    .modal-body .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .modal-body .form-input:focus,
    .modal-body .form-select:focus,
    .modal-body .form-textarea:focus {
      outline: none;
      border-color: var(--vericase-teal);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--gray-100);
    }

    /* === SKELETON === */
    .skeleton {
      background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 6px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .app-content {
        padding: 24px 16px;
      }

      body.workspace-hub-page > .workspace-hub-container {
        padding: 24px 16px;
      }

      .directory-toolbar {
        padding: var(--space-3);
      }

      .directory-search {
        min-width: 100%;
      }

      .directory-filters .form-select {
        min-width: 160px;
      }

      .workspace-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .items-grid {
        grid-template-columns: 1fr;
      }

      .workspace-card .workspace-preview {
        grid-template-columns: 1fr;
      }

      .inline-add-row .form-row {
        grid-template-columns: 1fr;
      }

      .team-grid {
        grid-template-columns: 1fr;
      }

      .hub-tab {
        padding: 10px 14px;
        font-size: 0.875rem;
      }
    }

    /* === ABOUT TAB (AI CONTEXT + Q&A) === */
    .about-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .about-card {
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      background: var(--bg-white);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      overflow: hidden;
    }

    .about-span-2 {
      grid-column: 1 / -1;
    }

    .about-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      font-weight: 700;
      border-bottom: 1px solid var(--gray-200);
      background: linear-gradient(180deg, rgba(47, 134, 200, 0.06), rgba(47, 134, 200, 0.02));
    }

    .about-card-body {
      padding: 14px 16px;
      color: var(--text-primary);
      font-size: 0.9375rem;
      line-height: 1.55;
    }

    .about-pre {
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 0.95rem;
    }

    .about-notes-textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      font-size: 0.9375rem;
      line-height: 1.55;
    }

    .about-actions-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .about-contract-grid {
      display: grid;
      grid-template-columns: 1.25fr 1fr;
      gap: 14px;
    }

    .about-subtitle {
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .about-contract-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .about-contract-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      background: var(--bg-white);
    }

    .about-contract-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .about-contract-meta {
      color: var(--text-muted);
      font-size: 0.8125rem;
      margin-top: 4px;
      line-height: 1.35;
    }

    .about-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .about-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      font-size: 0.75rem;
      font-family: var(--font-mono);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .about-contract-actions {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      flex-shrink: 0;
    }

    @media (max-width: 900px) {
      .about-contract-grid {
        grid-template-columns: 1fr;
      }
    }

    .about-list {
      margin: 0;
      padding-left: 18px;
      color: var(--text-secondary);
    }

    .about-qa-row {
      display: flex;
      gap: 10px;
      align-items: stretch;
      margin-bottom: 12px;
    }

    .about-qa-row input {
      flex: 1;
    }

    .about-chat {
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 12px;
      background: var(--gray-50);
      min-height: 120px;
      white-space: pre-wrap;
    }

    .about-chat .msg {
      padding: 10px 10px;
      border-radius: 12px;
      margin-bottom: 10px;
      border: 1px solid var(--gray-200);
      background: var(--bg-white);
    }

    .about-chat .msg.user {
      border-left: 4px solid var(--vericase-teal);
    }

    .about-chat .msg.ai {
      border-left: 4px solid var(--vericase-gold);
    }

    .about-hint {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .about-grid {
        grid-template-columns: 1fr;
      }
      .about-span-2 {
        grid-column: auto;
      }
    }
  </style>
</head>

<body class="workspace-hub-page">
  <div class="workspace-hub-container">
    <!-- Breadcrumb Navigation -->
    <nav class="hub-breadcrumb" aria-label="Breadcrumb">
      <a href="control-centre.html"><i class="fas fa-compass"></i> Control Centre</a>
      <span class="separator"><i class="fas fa-chevron-right"></i></span>
      <a href="workspace-hub.html">Workspaces</a>
      <span class="separator"><i class="fas fa-chevron-right"></i></span>
      <span class="current" id="breadcrumbWorkspaceName">Loading...</span>
    </nav>

    <!-- Workspaces Directory (no workspaceId) -->
    <section class="hub-section hidden" id="directoryView">
      <header class="directory-hero" aria-label="Workspaces Directory">
        <div class="directory-title-row">
          <div class="directory-icon" aria-hidden="true">
            <i class="fas fa-layer-group"></i>
          </div>
          <div>
            <h1 class="directory-title">
              Workspaces
              <span class="directory-count-pill" id="workspacesCountPill" title="Total workspaces"></span>
            </h1>
            <div class="directory-subtitle">
              Workspaces group projects, cases, documents, and your team.
            </div>
          </div>
        </div>
        <div class="directory-actions">
          <a href="workspace-setup.html" class="btn btn-vericase">
            <i class="fas fa-plus" aria-hidden="true"></i> Create Workspace
          </a>
          <a href="master-dashboard.html" class="btn btn-outline">
            <i class="fas fa-bolt" aria-hidden="true"></i> Quick Access
          </a>
        </div>
      </header>

      <div class="directory-toolbar" role="region" aria-label="Workspace filters">
        <div class="directory-search">
          <i class="fas fa-search" aria-hidden="true"></i>
          <input
            type="search"
            id="workspaceSearch"
            class="form-input"
            placeholder="Search workspaces by name, code, or contract type…"
            autocomplete="off"
          />
          <button
            type="button"
            id="workspaceSearchClear"
            class="directory-search-clear"
            aria-label="Clear search"
            hidden
          >
            <i class="fas fa-xmark" aria-hidden="true"></i>
          </button>
        </div>
        <div class="directory-toolbar-right">
          <div class="directory-filters">
            <select class="form-select" id="workspaceStatusFilter" aria-label="Status filter">
              <option value="all">All statuses</option>
              <option value="active">Active</option>
              <option value="archived">Archived</option>
              <option value="inactive">Inactive</option>
            </select>
            <select class="form-select" id="workspaceSort" aria-label="Sort workspaces">
              <option value="recent">Sort: Recent</option>
              <option value="name-asc">Sort: Name A–Z</option>
              <option value="name-desc">Sort: Name Z–A</option>
            </select>
          </div>
          <div class="directory-meta" id="workspaceDirectoryMeta">Loading…</div>
        </div>
      </div>
      <div class="items-grid" id="workspacesGrid"></div>
    </section>

    <!-- Workspace Header -->
    <header class="workspace-header" id="workspaceHeader">
      <div class="workspace-identity">
        <div class="workspace-icon-large">
          <i class="fas fa-building" aria-hidden="true"></i>
        </div>
        <div class="workspace-info">
          <h1 class="workspace-name" id="workspaceName">Loading...</h1>
          <div class="workspace-code-badge">
            <span class="code" id="workspaceCode">---</span>
            <span class="contract-type" id="workspaceContractType"></span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <a href="#" id="configureBtn" class="btn btn-outline">
          <i class="fas fa-cog" aria-hidden="true"></i> Configure
        </a>
        <button class="btn btn-vericase" onclick="showAddModal()">
          <i class="fas fa-plus" aria-hidden="true"></i> Add
        </button>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-pill skeleton"></div>
    </div>

    <!-- Tab Navigation -->
    <nav class="hub-tabs" id="hubTabs">
      <button class="hub-tab active" data-tab="projects-cases" onclick="switchTab('projects-cases')">
        <i class="fas fa-th-large"></i>
        Projects & Cases
        <span class="tab-count" id="projectsCasesCount">0</span>
      </button>
      <button class="hub-tab" data-tab="deadlines" onclick="switchTab('deadlines')">
        <i class="fas fa-calendar-alt"></i>
        Deadlines
        <span class="tab-count" id="deadlinesCount">0</span>
      </button>
      <button class="hub-tab" data-tab="documents" onclick="switchTab('documents')">
        <i class="fas fa-folder-open"></i>
        Documents
        <span class="tab-count" id="documentsCount">0</span>
      </button>
      <button class="hub-tab" data-tab="about" onclick="switchTab('about')">
        <i class="fas fa-circle-info"></i>
        About
        <span class="tab-count" id="aboutCount">0</span>
      </button>
      <button class="hub-tab" data-tab="team" onclick="switchTab('team')">
        <i class="fas fa-id-badge"></i>
        Team
        <span class="tab-count" id="teamCount">0</span>
      </button>
      <button class="hub-tab" data-tab="collaboration" onclick="switchTab('collaboration')">
        <i class="fas fa-comments"></i>
        Collaboration
      </button>
    </nav>

    <!-- Tab Panels -->
    <div class="tab-panels">
      <!-- Projects & Cases Panel -->
      <div class="tab-panel active" id="panel-projects-cases">
    <!-- Projects Section -->
    <section class="hub-section" id="projectsSection">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-project-diagram" aria-hidden="true"></i>
          Projects
          <span class="section-count" id="projectCount">0</span>
        </div>
        <div class="section-actions">
          <a href="#" id="addProjectBtn" class="btn btn-sm btn-outline">
            <i class="fas fa-plus" aria-hidden="true"></i> Add Project
          </a>
        </div>
      </div>
          <div class="items-grid" id="projectsGrid"></div>
    </section>

    <!-- Cases Section -->
    <section class="hub-section" id="casesSection">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-briefcase" aria-hidden="true"></i>
          Cases
          <span class="section-count" id="caseCount">0</span>
        </div>
        <div class="section-actions">
          <a href="#" id="addCaseBtn" class="btn btn-sm btn-outline">
            <i class="fas fa-plus" aria-hidden="true"></i> Add Case
          </a>
        </div>
      </div>
          <div class="items-grid" id="casesGrid"></div>
        </section>
      </div>

      <!-- Deadlines Panel -->
      <div class="tab-panel" id="panel-deadlines">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-calendar-alt" aria-hidden="true"></i>
              Workspace Deadlines & Deliverables
            </div>
            <div class="section-actions">
              <button class="btn btn-sm btn-outline" onclick="exportDeadlines()">
                <i class="fas fa-download"></i> Export
              </button>
            </div>
          </div>
          
          <div id="deadlinesTableContainer"></div>
          
          <!-- Inline Add Deadline -->
          <div class="inline-add-row" id="addDeadlineRow">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Task / Deadline</label>
                <input type="text" class="form-input" id="newDeadlineTask" placeholder="e.g., Position statement due">
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="newDeadlineDesc" placeholder="Notes...">
              </div>
              <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="newDeadlineDate">
              </div>
              <div class="form-group">
                <label class="form-label">Reminder</label>
                <select class="form-select" id="newDeadlineReminder">
                  <option value="none">None</option>
                  <option value="7d">7 days</option>
                  <option value="3d">3 days</option>
                  <option value="24h">24 hours</option>
                </select>
              </div>
              <div class="form-group">
                <button class="btn btn-sm btn-vericase" onclick="addDeadline()">
                  <i class="fas fa-plus"></i> Add
                </button>
              </div>
            </div>
      </div>
    </section>
      </div>

      <!-- Documents Panel -->
      <div class="tab-panel" id="panel-documents">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              Dispute Context Documents
            </div>
          </div>
          <div class="hub-subtext">
            Upload key documents (contract, notices, expert reports, pleadings, key letters) to build an AI read-in and Q&A in the <strong>About</strong> tab.
          </div>
          
          <!-- Upload Zone -->
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-cloud-upload-alt"></i>
            <div class="upload-text">Drop files here or click to upload</div>
            <div class="upload-hint">PDF, DOC, XLS, images up to 50MB</div>
            <input type="file" id="fileInput" multiple hidden onchange="handleFileSelect(event)">
          </div>
          
          <div id="documentsGrid" class="documents-grid"></div>
        </section>
      </div>

      <!-- About Panel -->
      <div class="tab-panel" id="panel-about">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-circle-info" aria-hidden="true"></i>
              About
            </div>
            <div class="section-actions">
              <button class="btn btn-sm btn-outline" onclick="refreshWorkspaceAbout(false)" title="Quick refresh (uses latest processed excerpts)">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
              <button class="btn btn-sm btn-vericase" onclick="refreshWorkspaceAbout(true)" title="Supercharged read-in (deep, multi-agent + contract intelligence)">
                <i class="fas fa-wand-magic-sparkles"></i> Supercharge
              </button>
            </div>
          </div>

          <div class="about-grid">
            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-bolt" aria-hidden="true"></i>
                AI Brief (auto-updates as documents arrive)
              </div>
              <div class="about-card-body about-pre" id="aboutSummary">Upload a document in this workspace to start building the dispute context.</div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-file-signature" aria-hidden="true"></i>
                Contracts & key terms (from uploaded contract documents)
              </div>
              <div class="about-card-body">
                <div class="about-contract-grid">
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-folder-open" aria-hidden="true"></i>
                      Uploaded contract documents
                    </div>
                    <div class="about-contract-list" id="aboutContractDocs"></div>
                  </div>
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-balance-scale" aria-hidden="true"></i>
                      Key terms (extracted)
                    </div>
                    <div class="about-pre" id="aboutContractTerms"></div>
                  </div>
                </div>
                <div class="about-hint" id="aboutContractsHint"></div>
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-diagram-project" aria-hidden="true"></i>
                Structured dispute intelligence (auto-built)
              </div>
              <div class="about-card-body">
                <div class="about-contract-grid">
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-gauge-high" aria-hidden="true"></i>
                      At a glance
                    </div>
                    <div class="about-pre" id="aboutAtAGlance"></div>
                  </div>
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-users" aria-hidden="true"></i>
                      Parties & roles
                    </div>
                    <div class="about-pre" id="aboutPartiesRoles"></div>
                  </div>
                </div>
                <div class="about-hint"></div>
                <div class="about-contract-grid">
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
                      Issues (what matters)
                    </div>
                    <div class="about-pre" id="aboutIssues"></div>
                  </div>
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-list-check" aria-hidden="true"></i>
                      Next actions
                    </div>
                    <div class="about-pre" id="aboutNextActions"></div>
                  </div>
                </div>
                <div class="about-hint" id="aboutStructuredHint"></div>
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-sitemap" aria-hidden="true"></i>
                Evidence map (what we have, and why it matters)
              </div>
              <div class="about-card-body">
                <div id="aboutEvidenceMap"></div>
                <div class="about-hint" id="aboutEvidenceMapHint"></div>
              </div>
            </div>

            <div class="about-card">
              <div class="about-card-title">
                <i class="fas fa-question-circle" aria-hidden="true"></i>
                Open questions (gaps to close)
              </div>
              <div class="about-card-body">
                <ul class="about-list" id="aboutOpenQuestions"></ul>
                <div class="about-hint" id="aboutOpenQuestionsHint"></div>
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-comments" aria-hidden="true"></i>
                Ask the Workspace (Q&A across workspace + related projects/cases)
              </div>
              <div class="about-card-body">
                <div class="about-qa-row">
                  <input class="form-input" id="aboutQuestionInput" placeholder="Ask: what is the dispute about? what are the key issues? what evidence do we have?">
                  <button class="btn btn-vericase" id="aboutAskBtn" onclick="askWorkspaceAbout()">
                    <i class="fas fa-paper-plane"></i> Ask
                  </button>
                </div>
                <div class="about-chat" id="aboutChat"></div>
                <div class="about-hint" id="aboutChatHint"></div>
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-chalkboard-teacher" aria-hidden="true"></i>
                Teach the system (facts & framing)
              </div>
              <div class="about-card-body">
                <textarea class="form-input about-notes-textarea" id="aboutUserNotes" placeholder="Add authoritative facts, agreed issues, parties/roles, or dispute framing. This guides AI outputs and reduces read-in for counsel."></textarea>
                <div class="about-actions-row">
                  <button class="btn btn-outline" onclick="loadWorkspaceAbout()">Reset</button>
                  <button class="btn btn-vericase" onclick="saveWorkspaceAboutNotes()">
                    <i class="fas fa-save"></i> Save notes
                  </button>
                </div>
                <div class="about-hint" id="aboutNotesHint"></div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Team Panel -->
      <div class="tab-panel" id="panel-team">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-id-badge" aria-hidden="true"></i>
              Team Members
            </div>
            <div class="section-actions">
              <button class="btn btn-sm btn-vericase" onclick="showAddMemberModal()">
                <i class="fas fa-user-plus"></i> Add Member
              </button>
            </div>
          </div>
          
          <div id="teamGrid" class="team-grid"></div>
        </section>
      </div>

      <!-- Collaboration Panel -->
      <div class="tab-panel" id="panel-collaboration">
        <!-- Workspace Notes -->
        <div class="collab-section">
          <div class="collab-section-header">
            <h4><i class="fas fa-sticky-note"></i> Workspace Notes</h4>
          </div>
          <div class="collab-section-body">
            <div id="notesList" class="notes-list"></div>
            <div class="note-input-wrapper">
              <textarea id="newNoteInput" placeholder="Add a note for your team..."></textarea>
              <button class="btn btn-vericase" onclick="addNote()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Activity Feed -->
        <div class="collab-section">
          <div class="collab-section-header">
            <h4><i class="fas fa-stream"></i> Recent Activity</h4>
          </div>
          <div class="collab-section-body">
            <div id="activityFeed" class="activity-feed"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Navigation -->
    <div class="back-section">
      <a href="workspace-hub.html" class="back-link">
        <i class="fas fa-arrow-left" aria-hidden="true"></i>
        Back to Workspaces
      </a>
    </div>
  </div>

  <!-- Add Modal -->
  <div class="modal-overlay" id="addModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add to Workspace</h3>
        <button class="modal-close" onclick="hideAddModal()">&times;</button>
      </div>
      <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px;">
        <a href="#" id="addProjectLink" class="btn btn-lg btn-outline" style="justify-content: flex-start; gap: 16px; padding: 20px;">
          <i class="fas fa-project-diagram" style="font-size: 1.25rem; color: #2f86c8;"></i>
          <div style="text-align: left;">
            <div style="font-weight: 600;">Add Project</div>
            <div style="font-size: 0.8125rem; color: var(--text-muted); font-weight: 400;">A construction or engineering project</div>
          </div>
        </a>
        <a href="#" id="addCaseLink" class="btn btn-lg btn-outline" style="justify-content: flex-start; gap: 16px; padding: 20px;">
          <i class="fas fa-briefcase" style="font-size: 1.25rem; color: var(--vericase-gold);"></i>
          <div style="text-align: left;">
            <div style="font-weight: 600;">Add Case</div>
            <div style="font-size: 0.8125rem; color: var(--text-muted); font-weight: 400;">A dispute or legal matter</div>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Add Member Modal -->
  <div class="modal-overlay" id="addMemberModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Team Member</h3>
        <button class="modal-close" onclick="hideAddMemberModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Existing User Email</label>
          <input type="email" class="form-input" id="memberEmail" placeholder="colleague@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select class="form-select" id="memberRole">
            <option value="member">Member</option>
            <option value="editor">Editor</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="hideAddMemberModal()">Cancel</button>
        <button class="btn btn-vericase" onclick="addMember()">
          <i class="fas fa-user-plus"></i> Add Member
        </button>
      </div>
    </div>
  </div>

  <script>
    // Get workspace ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const workspaceId = urlParams.get("workspaceId");
    const isDirectoryMode = !workspaceId;

    // Workspace directory state (directory mode only)
    let directoryWorkspaces = [];
    const directoryUi = {
      query: "",
      status: "all",
      sort: "recent",
    };
    const _countFmt = new Intl.NumberFormat(undefined);
    function formatCount(value) {
      const n = Number(value);
      return Number.isFinite(n) ? _countFmt.format(n) : "0";
    }

    // Workspace data
    let workspaceData = null;
    let workspaceDeadlines = [];
    let workspaceDocuments = [];
    let workspaceTeam = [];
    let workspaceNotes = [];
    let workspaceActivity = [];

    // About (AI workspace context + Q&A)
    let workspaceAbout = null;
    let aboutPollHandle = null;

    // Auth helpers
    function getAuthHeaders() {
      const token =
        localStorage.getItem("vericase_token") ||
        localStorage.getItem("token") ||
        localStorage.getItem("jwt") ||
        localStorage.getItem("auth_token");
      return token ? { Authorization: `Bearer ${token}`, "Content-Type": "application/json" } : { "Content-Type": "application/json" };
    }

    // Tab switching
    function switchTab(tabId) {
      document.querySelectorAll('.hub-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
      });
      
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `panel-${tabId}`);
      });
    }

    function setDirectoryMode(enabled) {
      const directory = document.getElementById("directoryView");
      if (directory) directory.classList.toggle("hidden", !enabled);

      const workspaceOnlySelectors = [
        ".hub-breadcrumb",
        "#workspaceHeader",
        "#statsBar",
        "#hubTabs",
        ".tab-panels",
        ".back-section",
      ];

      workspaceOnlySelectors.forEach((selector) => {
        const el = document.querySelector(selector);
        if (el) el.classList.toggle("hidden", enabled);
      });
    }

    // Initialize page
	    document.addEventListener("DOMContentLoaded", async () => {
	      if (window.VericaseShell?.inject) {
	        let cachedWorkspaceName = "Workspace";
	        try {
	          const storedId = (localStorage.getItem("currentWorkspaceId") || "").trim();
	          const storedName = (localStorage.getItem("currentWorkspaceName") || "").trim();
	          if (storedId && storedId === String(workspaceId || "").trim() && storedName) {
	            cachedWorkspaceName = storedName;
	          }
	        } catch { /* ignore */ }
	        VericaseShell.inject(
	          isDirectoryMode
	            ? {
	                title: "",
	                breadcrumbs: [
	                  { label: "Control Centre", url: "control-centre.html", icon: "fa-compass" },
	                  { label: "Workspaces", icon: "fa-layer-group" },
	                ],
	                headerActions: "",
	              }
	            : {
	                title: "",
	                breadcrumbs: [
	                  { label: "Control Centre", url: "control-centre.html", icon: "fa-compass" },
	                  { label: "Workspaces", url: "workspace-hub.html", icon: "fa-layer-group" },
	                  { label: cachedWorkspaceName, icon: "fa-building" },
	                ],
	                headerActions: "",
	              },
	        );
	      }

      if (isDirectoryMode) {
        setDirectoryMode(true);
        initWorkspacesDirectoryUi();
        await loadWorkspacesDirectory();
        return;
      }

      setDirectoryMode(false);

      // Set up links
      document.getElementById("configureBtn").href = `workspace-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
      document.getElementById("addProjectBtn").href = `project-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
      document.getElementById("addCaseBtn").href = `case-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
      document.getElementById("addProjectLink").href = `project-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
      document.getElementById("addCaseLink").href = `case-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;

      // Setup drag and drop for documents
      setupDragAndDrop();

      // Load workspace data
      await loadWorkspace();
    });

    function setDirectoryMeta({ total, shown, loading = false }) {
      const meta = document.getElementById("workspaceDirectoryMeta");
      const pill = document.getElementById("workspacesCountPill");

      if (loading) {
        if (meta) meta.textContent = "Loading workspaces…";
        if (pill) pill.textContent = "";
        return;
      }

      const totalText = formatCount(total);
      const shownText = formatCount(shown);

      if (meta) {
        meta.textContent =
          total === shown
            ? `${totalText} workspaces`
            : `Showing ${shownText} of ${totalText} workspaces`;
      }
      if (pill) pill.textContent = totalText;
    }

    function initWorkspacesDirectoryUi() {
      const search = document.getElementById("workspaceSearch");
      const clearBtn = document.getElementById("workspaceSearchClear");
      const status = document.getElementById("workspaceStatusFilter");
      const sort = document.getElementById("workspaceSort");

      if (!search || !status || !sort) return;

      function syncClear() {
        if (!clearBtn) return;
        clearBtn.hidden = !search.value.trim();
      }

      function updateAndRender() {
        directoryUi.query = (search.value || "").trim().toLowerCase();
        directoryUi.status = (status.value || "all").toLowerCase();
        directoryUi.sort = (sort.value || "recent").toLowerCase();
        syncClear();
        applyDirectoryFiltersAndRender();
      }

      search.addEventListener("input", updateAndRender);
      status.addEventListener("change", updateAndRender);
      sort.addEventListener("change", updateAndRender);

      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          search.value = "";
          updateAndRender();
          search.focus();
        });
      }

      syncClear();
      setDirectoryMeta({ total: 0, shown: 0, loading: true });
    }

    function renderWorkspacesDirectoryLoading() {
      const grid = document.getElementById("workspacesGrid");
      if (!grid) return;
      setDirectoryMeta({ total: 0, shown: 0, loading: true });

      const card = `
        <div class="item-card workspace-card workspace-card--skeleton" aria-hidden="true">
          <div class="workspace-card-skel-top">
            <div class="skeleton sk-icon"></div>
            <div class="workspace-card-skel-lines">
              <div class="skeleton sk-line sk-line--title"></div>
              <div class="skeleton sk-line sk-line--meta"></div>
            </div>
            <div class="skeleton sk-pill"></div>
          </div>
          <div class="workspace-card-skel-stats">
            <div class="skeleton sk-stat"></div>
            <div class="skeleton sk-stat"></div>
            <div class="skeleton sk-stat"></div>
            <div class="skeleton sk-stat"></div>
          </div>
        </div>
      `;

      grid.innerHTML = Array.from({ length: 8 }).map(() => card).join("");
    }

    function normalizeWorkspaceStatus(ws) {
      const raw = (ws?.status || "active").toString().toLowerCase();
      if (raw === "archived" || raw === "closed") return "archived";
      if (raw === "inactive") return "inactive";
      return "active";
    }

    function workspaceSearchHaystack(ws) {
      return [
        ws?.name,
        ws?.code,
        ws?.contract_type,
        ws?.id,
      ]
        .filter(Boolean)
        .join(" ")
        .toLowerCase();
    }

    function getWorkspaceSortTime(ws) {
      const raw =
        ws?.updated_at ||
        ws?.last_activity_at ||
        ws?.lastActivityAt ||
        ws?.created_at ||
        ws?.createdAt ||
        ws?.updatedAt;
      const d = raw ? new Date(raw) : null;
      const t = d && !Number.isNaN(d.getTime()) ? d.getTime() : 0;
      return t;
    }

    function sortWorkspaces(list) {
      const sort = directoryUi.sort;
      const arr = [...list];

      if (sort === "name-asc") {
        arr.sort((a, b) =>
          (a?.name || "").localeCompare(b?.name || "", undefined, { sensitivity: "base" })
        );
        return arr;
      }
      if (sort === "name-desc") {
        arr.sort((a, b) =>
          (b?.name || "").localeCompare(a?.name || "", undefined, { sensitivity: "base" })
        );
        return arr;
      }

      // default: recent
      arr.sort((a, b) => getWorkspaceSortTime(b) - getWorkspaceSortTime(a));
      return arr;
    }

    function applyDirectoryFiltersAndRender() {
      const all = Array.isArray(directoryWorkspaces) ? directoryWorkspaces : [];
      let filtered = all;

      if (directoryUi.status && directoryUi.status !== "all") {
        filtered = filtered.filter((ws) => normalizeWorkspaceStatus(ws) === directoryUi.status);
      }

      if (directoryUi.query) {
        const q = directoryUi.query;
        filtered = filtered.filter((ws) => workspaceSearchHaystack(ws).includes(q));
      }

      filtered = sortWorkspaces(filtered);
      setDirectoryMeta({ total: all.length, shown: filtered.length, loading: false });

      const grid = document.getElementById("workspacesGrid");
      if (grid && all.length > 0 && filtered.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-search empty-icon"></i>
            <div class="empty-title">No matching workspaces</div>
            <div class="empty-desc">Try a different search term or clear filters.</div>
            <button type="button" class="btn btn-outline" id="clearDirectoryFiltersBtn">
              <i class="fas fa-xmark"></i> Clear filters
            </button>
          </div>
        `;

        const btn = document.getElementById("clearDirectoryFiltersBtn");
        btn?.addEventListener("click", () => {
          const search = document.getElementById("workspaceSearch");
          const status = document.getElementById("workspaceStatusFilter");
          const sort = document.getElementById("workspaceSort");
          const clearBtn = document.getElementById("workspaceSearchClear");

          if (search) search.value = "";
          if (status) status.value = "all";
          if (sort) sort.value = "recent";
          if (clearBtn) clearBtn.hidden = true;

          directoryUi.query = "";
          directoryUi.status = "all";
          directoryUi.sort = "recent";
          applyDirectoryFiltersAndRender();
          search?.focus();
        });
        return;
      }

      renderWorkspacesDirectory(filtered);
    }

    async function loadWorkspacesDirectory() {
      try {
        renderWorkspacesDirectoryLoading();
        const response = await fetch("/api/workspaces", { headers: getAuthHeaders() });
        if (!response.ok) throw new Error("Failed to load workspaces");
        const workspaces = await response.json();
        directoryWorkspaces = Array.isArray(workspaces) ? workspaces : [];
        applyDirectoryFiltersAndRender();
      } catch (err) {
        console.error("Failed to load workspaces directory:", err);
        VericaseUI.Toast.error("Failed to load workspaces");
        setDirectoryMeta({ total: 0, shown: 0, loading: false });
        const grid = document.getElementById("workspacesGrid");
        if (grid) {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
              <i class="fas fa-triangle-exclamation empty-icon"></i>
              <div class="empty-title">Unable to load workspaces</div>
              <div class="empty-desc">Please refresh the page or try again in a moment.</div>
              <button type="button" class="btn btn-outline" onclick="loadWorkspacesDirectory()">
                <i class="fas fa-rotate-right"></i> Retry
              </button>
            </div>
          `;
        }
      }
    }

    function renderWorkspacesDirectory(workspaces) {
      const grid = document.getElementById("workspacesGrid");
      if (!grid) return;

      const list = Array.isArray(workspaces) ? workspaces : [];
      if (list.length === 0) {
        setDirectoryMeta({ total: 0, shown: 0, loading: false });
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-layer-group empty-icon"></i>
            <div class="empty-title">No Workspaces Yet</div>
            <div class="empty-desc">Create a workspace to group projects, cases, documents, and your team.</div>
            <a href="workspace-setup.html" class="btn btn-vericase">
              <i class="fas fa-plus"></i> Create Workspace
            </a>
          </div>
        `;
        return;
      }

      grid.innerHTML = list
        .map((ws) => {
          const projects = Array.isArray(ws.projects) ? ws.projects : [];
          const cases = Array.isArray(ws.cases) ? ws.cases : [];

          const projectPreview = projects.length
            ? projects
                .slice(0, 2)
                .map(
                  (p) =>
                    `<div class="workspace-preview-item" title="${escapeHtml(p.name || "")}">${escapeHtml(p.name || "Untitled project")}</div>`,
                )
                .join("")
            : `<div class="workspace-preview-empty">No projects yet</div>`;

          const casePreview = cases.length
            ? cases
                .slice(0, 2)
                .map(
                  (c) =>
                    `<div class="workspace-preview-item" title="${escapeHtml(c.name || "")}">${escapeHtml(c.name || "Untitled case")}</div>`,
                )
                .join("")
            : `<div class="workspace-preview-empty">No cases yet</div>`;

          const status = normalizeWorkspaceStatus(ws);
          const statusClass = status === "archived" ? "closed" : status === "inactive" ? "pending" : "";
          const displayStatus = status === "archived" ? "Archived" : status === "inactive" ? "Inactive" : "Active";

          const codeLine = [
            ws.code ? escapeHtml(ws.code) : "",
            ws.contract_type ? escapeHtml(ws.contract_type) : "",
          ]
            .filter(Boolean)
            .join(" • ");

          return `
            <div class="item-card workspace-card" data-workspace-id="${escapeHtml(ws.id)}" tabindex="0" role="button" aria-label="Open workspace ${escapeHtml(ws.name || "Workspace")}">
              <div class="item-card-header">
                <div class="item-icon workspace"><i class="fas fa-building"></i></div>
                <span class="item-status ${statusClass}">${displayStatus}</span>
              </div>
              <div class="item-content">
                <div class="item-title">${escapeHtml(ws.name || "Untitled workspace")}</div>
                <div class="item-code" title="${codeLine}">${codeLine}</div>
              </div>
              <div class="item-stats">
                <div class="item-stat"><i class="fas fa-project-diagram"></i> <strong>${formatCount(ws.project_count || 0)}</strong> projects</div>
                <div class="item-stat"><i class="fas fa-briefcase"></i> <strong>${formatCount(ws.case_count || 0)}</strong> cases</div>
                <div class="item-stat"><i class="fas fa-envelope"></i> <strong>${formatCount(ws.email_count || 0)}</strong> emails</div>
                <div class="item-stat"><i class="fas fa-file-alt"></i> <strong>${formatCount(ws.evidence_count || 0)}</strong> files</div>
              </div>
              <div class="workspace-preview">
                <div>
                  <div class="workspace-preview-title">Projects</div>
                  <div class="workspace-preview-list">${projectPreview}</div>
                </div>
                <div>
                  <div class="workspace-preview-title">Cases</div>
                  <div class="workspace-preview-list">${casePreview}</div>
                </div>
              </div>
              <div class="card-actions">
                <button type="button" class="card-action-btn primary" data-action="open"><i class="fas fa-arrow-right"></i> Open</button>
                <button type="button" class="card-action-btn" data-action="configure"><i class="fas fa-cog"></i> Configure</button>
              </div>
            </div>
          `;
        })
        .join("");

      grid.onclick = handleWorkspaceDirectoryClick;
      grid.onkeydown = handleWorkspaceDirectoryKeydown;
    }

    function handleWorkspaceDirectoryKeydown(e) {
      if (e.key !== "Enter" && e.key !== " ") return;
      const card = e.target.closest("[data-workspace-id]");
      if (!card) return;
      // If focus is already on an inner action button, let that button handle the key press.
      if (e.target.closest("[data-action]")) return;
      e.preventDefault();
      const id = card.dataset.workspaceId;
      window.location.href = `workspace-hub.html?workspaceId=${encodeURIComponent(id)}`;
    }

    function handleWorkspaceDirectoryClick(e) {
      const card = e.target.closest("[data-workspace-id]");
      if (!card) return;
      const id = card.dataset.workspaceId;
      const action = e.target.closest("[data-action]")?.dataset.action;

      if (action === "configure") {
        window.location.href = `workspace-setup.html?workspaceId=${encodeURIComponent(id)}`;
        return;
      }

      window.location.href = `workspace-hub.html?workspaceId=${encodeURIComponent(id)}`;
    }

    async function loadWorkspace() {
      try {
        const response = await fetch(`/api/workspaces/${workspaceId}`, { headers: getAuthHeaders() });
        if (!response.ok) throw new Error("Failed to load workspace");

        workspaceData = await response.json();

        try {
          localStorage.setItem("currentWorkspaceId", workspaceId);
          localStorage.setItem("currentWorkspaceName", workspaceData.name || "Workspace");
        } catch { /* ignore */ }

        // Extract data
        workspaceDeadlines = workspaceData.deadlines || [];
        workspaceDocuments = workspaceData.documents || [];
        workspaceTeam = workspaceData.team_members || workspaceData.users || workspaceData.team || [];
        workspaceNotes = workspaceData.notes || [];
        workspaceActivity = workspaceData.activity || [];

        // Aggregate deadlines from cases too
        const cases = workspaceData.cases || [];
        cases.forEach(c => {
          if (Array.isArray(c.deadlines)) {
            c.deadlines.forEach(d => {
              workspaceDeadlines.push({
                ...d,
                source: c.name || c.case_name || 'Case',
                source_type: 'case',
                source_id: c.id
              });
            });
          }
        });

        renderAll();

        if (window.VericaseShell?.inject) {
          VericaseShell.inject({
            title: workspaceData.name,
            breadcrumbs: [
              { label: "Control Centre", url: "control-centre.html" },
              { label: "Workspaces", url: "workspace-hub.html" },
              { label: workspaceData.name || "Workspace" }
            ],
            headerActions: ""
          });
        }

        // Load AI context ("About" tab) in the background
        loadWorkspaceAbout().catch(() => {});
        // Load full workspace documents list (best-effort; workspace payload is capped)
        loadWorkspaceDocuments().catch(() => {});

      } catch (err) {
        console.error("Failed to load workspace:", err);
        VericaseUI.Toast.error("Failed to load workspace");
      }
    }

    function renderAll() {
      renderHeader();
      renderStats();
      renderProjects();
      renderCases();
      renderDeadlines();
      renderDocuments();
      renderTeam();
      renderNotes();
      renderActivity();
      updateTabCounts();
    }

    function renderHeader() {
      const workspaceName = workspaceData?.name || "Unnamed Workspace";
      document.getElementById("workspaceName").textContent = workspaceName;
      document.getElementById("workspaceCode").textContent = workspaceData?.code || "---";
      if (workspaceData?.contract_type) {
        document.getElementById("workspaceContractType").textContent = `• ${workspaceData.contract_type}`;
      }
      // Update breadcrumb
      const breadcrumbEl = document.getElementById("breadcrumbWorkspaceName");
      if (breadcrumbEl) {
        breadcrumbEl.textContent = workspaceName;
      }
    }

    function renderStats() {
      const statsBar = document.getElementById("statsBar");
      const projects = workspaceData?.projects?.length || 0;
      const cases = workspaceData?.cases?.length || 0;
      const deadlines = workspaceDeadlines.length;
      const docs = workspaceDocuments.length;
      const team = workspaceTeam.length;

      statsBar.innerHTML = `
        <div class="stat-pill projects"><i class="fas fa-project-diagram"></i> <strong>${projects}</strong> Projects</div>
        <div class="stat-pill cases"><i class="fas fa-briefcase"></i> <strong>${cases}</strong> Cases</div>
        <div class="stat-pill deadlines"><i class="fas fa-calendar-alt"></i> <strong>${deadlines}</strong> Deadlines</div>
        <div class="stat-pill documents"><i class="fas fa-folder-open"></i> <strong>${docs}</strong> Documents</div>
        <div class="stat-pill members"><i class="fas fa-id-badge"></i> <strong>${team}</strong> Members</div>
      `;
    }

    function updateTabCounts() {
      const projects = workspaceData?.projects?.length || 0;
      const cases = workspaceData?.cases?.length || 0;
      document.getElementById("projectsCasesCount").textContent = projects + cases;
      document.getElementById("projectCount").textContent = projects;
      document.getElementById("caseCount").textContent = cases;
      document.getElementById("deadlinesCount").textContent = workspaceDeadlines.length;
      document.getElementById("documentsCount").textContent = workspaceDocuments.length;
      document.getElementById("teamCount").textContent = workspaceTeam.length;

      // About status: show AI readiness indicator
      const aboutEl = document.getElementById("aboutCount");
      if (aboutEl) {
        const status = (workspaceAbout?.status || "").toLowerCase();
        aboutEl.textContent =
          status === "ready"
            ? "AI"
            : status === "building" || status === "processing"
              ? "…"
              : workspaceDocuments.length > 0
                ? "AI"
                : "0";
      }
    }

    function renderProjects() {
      const grid = document.getElementById("projectsGrid");
      const projects = workspaceData?.projects || [];

      if (projects.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-project-diagram empty-icon"></i>
            <div class="empty-title">No Projects Yet</div>
            <div class="empty-desc">Create your first project to manage timelines, emails, and evidence.</div>
            <a href="project-setup.html?workspaceId=${encodeURIComponent(workspaceId)}" class="btn btn-vericase">
              <i class="fas fa-plus"></i> Add Project
            </a>
          </div>
        `;
        return;
      }

      grid.innerHTML = projects.map(p => `
        <div class="item-card" data-project-id="${p.id}">
          <div class="item-card-header">
            <div class="item-icon project"><i class="fas fa-project-diagram"></i></div>
            <span class="item-status">${p.status || 'Active'}</span>
          </div>
          <div class="item-content">
            <div class="item-title">${escapeHtml(p.name || p.project_name || 'Untitled')}</div>
            <div class="item-code">${escapeHtml(p.code || p.project_code || '')}</div>
          </div>
          <div class="item-stats">
            <div class="item-stat"><i class="fas fa-envelope"></i> <strong>${p.email_count || 0}</strong> emails</div>
            <div class="item-stat"><i class="fas fa-file-alt"></i> <strong>${p.evidence_count || 0}</strong> files</div>
            </div>
          <div class="card-actions">
            <button class="card-action-btn" data-action="configure"><i class="fas fa-cog"></i> Configure</button>
            <button class="card-action-btn primary" data-action="develop-case"><i class="fas fa-gavel"></i> Develop Case</button>
            <button class="card-action-btn" data-action="open"><i class="fas fa-arrow-right"></i> Open</button>
            </div>
        </div>
      `).join('');

      grid.onclick = handleProjectClick;
    }

    function renderCases() {
      const grid = document.getElementById("casesGrid");
      const cases = workspaceData?.cases || [];

      if (cases.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-briefcase empty-icon"></i>
            <div class="empty-title">No Cases Yet</div>
            <div class="empty-desc">Create a case to track disputes and legal matters.</div>
            <a href="case-setup.html?workspaceId=${encodeURIComponent(workspaceId)}" class="btn btn-vericase">
              <i class="fas fa-plus"></i> Add Case
            </a>
          </div>
        `;
        return;
      }

      grid.innerHTML = cases.map(c => `
        <div class="item-card" data-case-id="${c.id}">
          <div class="item-card-header">
            <div class="item-icon case"><i class="fas fa-briefcase"></i></div>
            <span class="item-status">${c.status || 'Active'}</span>
          </div>
          <div class="item-content">
            <div class="item-title">${escapeHtml(c.name || c.case_name || 'Untitled')}</div>
            <div class="item-code">${escapeHtml(c.case_number || '')}</div>
          </div>
          <div class="item-stats">
            <div class="item-stat"><i class="fas fa-envelope"></i> <strong>${c.email_count || 0}</strong> emails</div>
            <div class="item-stat"><i class="fas fa-file-alt"></i> <strong>${c.evidence_count || 0}</strong> files</div>
            </div>
          <div class="card-actions">
            <button class="card-action-btn" data-action="configure"><i class="fas fa-cog"></i> Configure</button>
            <button class="card-action-btn primary" data-action="open"><i class="fas fa-arrow-right"></i> Open</button>
            </div>
        </div>
      `).join('');

      grid.onclick = handleCaseClick;
    }

    function handleProjectClick(e) {
      const card = e.target.closest('[data-project-id]');
      if (!card) return;
      const id = card.dataset.projectId;
      const action = e.target.closest('[data-action]')?.dataset.action;
      
      if (action === 'configure') {
        window.location.href = `project-setup.html?workspaceId=${workspaceId}&projectId=${id}`;
      } else if (action === 'develop-case') {
        window.location.href = `case-setup.html?workspaceId=${workspaceId}&projectId=${id}`;
      } else if (action === 'open') {
        openProject(id);
      } else if (!e.target.closest('button')) {
        selectProjectContext(id);
      }
    }

    function handleCaseClick(e) {
      const card = e.target.closest('[data-case-id]');
      if (!card) return;
      const id = card.dataset.caseId;
      const action = e.target.closest('[data-action]')?.dataset.action;
      
      if (action === 'configure') {
        window.location.href = `case-setup.html?workspaceId=${workspaceId}&caseId=${id}`;
      } else if (action === 'open') {
        openCase(id);
      } else if (!e.target.closest('button')) {
        selectCaseContext(id);
      }
    }

    function selectProjectContext(id) {
      const p = (workspaceData?.projects || []).find(x => String(x.id) === String(id));
      const name = p?.name || p?.project_name || "Project";
      try {
        window.VericaseShell?.setProjectContext?.({ projectId: id, projectName: name });
      } catch {}
    }

    function selectCaseContext(id) {
      const c = (workspaceData?.cases || []).find(x => String(x.id) === String(id));
      const name = c?.name || c?.case_name || "Case";
      try {
        window.VericaseShell?.setCaseContext?.({ caseId: id, caseName: name });
      } catch {}
    }

    function openProject(id) {
      const p = (workspaceData?.projects || []).find(x => String(x.id) === String(id));
      try {
        localStorage.setItem("profileType", "project");
        localStorage.setItem("currentProjectId", id);
        localStorage.setItem("projectId", id);
        if (p?.name || p?.project_name) localStorage.setItem("currentProjectName", p.name || p.project_name);
      } catch {}
      window.location.href = `projectdashboard.html?projectId=${id}`;
    }

    function openCase(id) {
      const c = (workspaceData?.cases || []).find(x => String(x.id) === String(id));
      try {
        localStorage.setItem("profileType", "case");
        localStorage.setItem("currentCaseId", id);
        localStorage.setItem("caseId", id);
        if (c?.name || c?.case_name) localStorage.setItem("currentCaseName", c.name || c.case_name);
      } catch {}
      window.location.href = `projectdashboard.html?caseId=${id}`;
    }

    // ========================================
    // DEADLINES MANAGEMENT
    // ========================================
    function renderDeadlines() {
      const container = document.getElementById("deadlinesTableContainer");
      
      // Sort by date
      const sorted = [...workspaceDeadlines].sort((a, b) => {
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(a.date) - new Date(b.date);
      });

      if (sorted.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="margin-bottom: 0;">
            <i class="fas fa-calendar-check empty-icon"></i>
            <div class="empty-title">No Deadlines Yet</div>
            <div class="empty-desc">Add deadlines to track important dates and deliverables for this workspace.</div>
          </div>
        `;
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      container.innerHTML = `
        <table class="mgmt-table">
          <thead>
            <tr>
              <th>Task / Deadline</th>
              <th>Description</th>
              <th class="date-col">Date</th>
              <th>Source</th>
              <th>Reminder</th>
              <th class="actions-col"></th>
            </tr>
          </thead>
          <tbody>
            ${sorted.map((d, i) => {
              const dDate = d.date ? new Date(d.date) : null;
              let dateClass = '';
              if (dDate) {
                dDate.setHours(0, 0, 0, 0);
                if (dDate < today) dateClass = 'overdue';
                else if (dDate - today <= 7 * 24 * 60 * 60 * 1000) dateClass = 'soon';
                else dateClass = 'upcoming';
              }
              const source = d.source ? `<span style="font-size: 0.75rem; color: var(--text-muted);">${escapeHtml(d.source)}</span>` : '<span style="color: var(--vericase-teal); font-size: 0.75rem;">Workspace</span>';
              return `
                <tr data-deadline-idx="${i}">
                  <td><strong>${escapeHtml(d.task || '')}</strong></td>
                  <td>${escapeHtml(d.description || '')}</td>
                  <td><span class="date-badge ${dateClass}">${formatDate(d.date)}</span></td>
                  <td>${source}</td>
                  <td>${d.reminder === 'none' || !d.reminder ? '—' : d.reminder}</td>
                  <td class="actions-col">
                    ${!d.source_type ? `
                      <button class="table-action-btn" onclick="editDeadline(${i})" title="Edit"><i class="fas fa-edit"></i></button>
                      <button class="table-action-btn danger" onclick="deleteDeadline(${i})" title="Delete"><i class="fas fa-trash"></i></button>
                    ` : ''}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    async function addDeadline() {
      const task = document.getElementById("newDeadlineTask").value.trim();
      const desc = document.getElementById("newDeadlineDesc").value.trim();
      const date = document.getElementById("newDeadlineDate").value;
      const reminder = document.getElementById("newDeadlineReminder").value;

      if (!task) {
        VericaseUI.Toast.error("Please enter a task name");
        return;
      }

      const newDeadline = { task, description: desc, date, reminder, source: null, source_type: null };
      
      // Save to backend
      try {
        const res = await fetch(`/api/workspaces/${workspaceId}/deadlines`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify(newDeadline)
        });
        if (res.ok) {
          const saved = await res.json();
          workspaceDeadlines.push(saved);
        } else {
          // Fallback to local storage
          workspaceDeadlines.push({ ...newDeadline, id: Date.now() });
        }
      } catch {
        workspaceDeadlines.push({ ...newDeadline, id: Date.now() });
      }

      // Clear form
      document.getElementById("newDeadlineTask").value = '';
      document.getElementById("newDeadlineDesc").value = '';
      document.getElementById("newDeadlineDate").value = '';
      document.getElementById("newDeadlineReminder").value = 'none';

      renderDeadlines();
      updateTabCounts();
      VericaseUI.Toast.success("Deadline added");
    }

    function deleteDeadline(idx) {
      const d = workspaceDeadlines[idx];
      if (!d || d.source_type) return;
      
      if (!confirm(`Delete "${d.task}"?`)) return;
      
      // Remove from array
      workspaceDeadlines.splice(idx, 1);
      
      // Try to delete from backend
      if (d.id) {
        fetch(`/api/workspaces/${workspaceId}/deadlines/${d.id}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        }).catch(() => {});
      }
      
      renderDeadlines();
      updateTabCounts();
      VericaseUI.Toast.success("Deadline deleted");
    }

    function editDeadline(idx) {
      VericaseUI.Toast.info("Edit feature coming soon - delete and re-add for now");
    }

    function exportDeadlines() {
      const sorted = [...workspaceDeadlines].sort((a, b) => new Date(a.date) - new Date(b.date));
      let csv = "Task,Description,Date,Source,Reminder\n";
      sorted.forEach(d => {
        csv += `"${d.task || ''}","${d.description || ''}","${d.date || ''}","${d.source || 'Workspace'}","${d.reminder || 'none'}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `deadlines-${workspaceData?.code || 'workspace'}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      VericaseUI.Toast.success("Deadlines exported");
    }

    // ========================================
    // DOCUMENTS MANAGEMENT
    // ========================================
    async function loadWorkspaceDocuments() {
      if (!workspaceId) return;
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/documents`, {
          headers: getAuthHeaders(),
        });
        if (!res.ok) return;
        const docs = await res.json().catch(() => []);
        if (!Array.isArray(docs)) return;

        // Preserve any in-flight uploads already shown in the UI.
        const inFlight = (workspaceDocuments || []).filter((d) => d && d.uploading);
        workspaceDocuments = docs;
        if (inFlight.length) {
          workspaceDocuments = [...inFlight, ...workspaceDocuments];
        }
        renderDocuments();
        updateTabCounts();
      } catch {
        // best-effort
      }
    }

    function setupDragAndDrop() {
      const zone = document.getElementById("uploadZone");
      if (!zone) return;

      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        zone.classList.add("dragover");
      });

      zone.addEventListener("dragleave", () => {
        zone.classList.remove("dragover");
      });

      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      });
    }

    function handleFileSelect(e) {
      handleFiles(e.target.files);
    }

    async function handleFiles(files) {
      for (const file of files) {
        if (file.size > 50 * 1024 * 1024) {
          VericaseUI.Toast.error(`${file.name} is too large (max 50MB)`);
          continue;
        }

        // Add to local list immediately for UI feedback
        const doc = {
          id: Date.now() + Math.random(),
          filename: file.name,
          size: file.size,
          created_at: new Date().toISOString(),
          uploading: true
        };
        workspaceDocuments.push(doc);
        renderDocuments();

        // Upload to backend
        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('workspace_id', workspaceId);

          const res = await fetch(`/api/workspaces/${workspaceId}/documents`, {
            method: 'POST',
            headers: { Authorization: getAuthHeaders().Authorization },
            body: formData
          });

          if (res.ok) {
            const saved = await res.json();
            // Replace temp with saved
            const idx = workspaceDocuments.findIndex(d => d.id === doc.id);
            if (idx >= 0) workspaceDocuments[idx] = saved;

            // Kick off workspace intelligence refresh (AI ingestion + About tab update)
            refreshWorkspaceAbout(false).catch(() => {});
          }
          doc.uploading = false;
        } catch {
          doc.uploading = false;
        }

        renderDocuments();
        updateTabCounts();
      }
      VericaseUI.Toast.success("Files uploaded");
    }

    // ========================================
    // ABOUT (AI CONTEXT + Q&A)
    // ========================================
    function _clearAboutPoll() {
      if (aboutPollHandle) {
        clearTimeout(aboutPollHandle);
        aboutPollHandle = null;
      }
    }

    function _appendChatMessage(role, text) {
      const chat = document.getElementById("aboutChat");
      if (!chat) return;
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.textContent = text || "";
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function _renderAbout(about) {
      const summaryEl = document.getElementById("aboutSummary");
      const openQEl = document.getElementById("aboutOpenQuestions");
      const openQHint = document.getElementById("aboutOpenQuestionsHint");
      const notesEl = document.getElementById("aboutUserNotes");
      const chatHint = document.getElementById("aboutChatHint");
      const contractDocsEl = document.getElementById("aboutContractDocs");
      const contractTermsEl = document.getElementById("aboutContractTerms");
      const contractHintEl = document.getElementById("aboutContractsHint");
      const atAGlanceEl = document.getElementById("aboutAtAGlance");
      const partiesEl = document.getElementById("aboutPartiesRoles");
      const issuesEl = document.getElementById("aboutIssues");
      const nextActionsEl = document.getElementById("aboutNextActions");
      const structuredHintEl = document.getElementById("aboutStructuredHint");
      const evidenceMapEl = document.getElementById("aboutEvidenceMap");
      const evidenceMapHintEl = document.getElementById("aboutEvidenceMapHint");

      const status = (about?.status || "").toLowerCase();
      const updatedAt = about?.updated_at || about?.last_updated || null;
      const updatedText = updatedAt ? `Last updated: ${formatRelativeTime(updatedAt)}` : "";

      if (summaryEl) {
        const summary = about?.summary || about?.summary_md || "";
        summaryEl.textContent =
          summary ||
          (workspaceDocuments.length > 0
            ? "Building workspace context… (upload ingestion running)"
            : "Upload a document in this workspace to start building the dispute context.");
      }

      // Contracts & key terms (pivotal section)
      try {
        const contracts =
          about?.contracts ||
          about?.data?.contracts ||
          {};

        const docs =
          Array.isArray(contracts?.documents) ? contracts.documents :
            (Array.isArray(contracts?.docs) ? contracts.docs : []);

        const keyTerms =
          Array.isArray(contracts?.key_terms_overview)
            ? contracts.key_terms_overview
            : [];

        if (contractDocsEl) {
          if (!docs.length) {
            contractDocsEl.innerHTML = `
              <div class="about-contract-item">
                <div>
                  <div class="about-contract-title">No contract document detected yet</div>
                  <div class="about-contract-meta">Upload the signed contract / standard form (JCT/NEC) plus schedules/appendices to unlock contract intelligence.</div>
                </div>
              </div>
            `;
          } else {
            contractDocsEl.innerHTML = docs.slice(0, 8).map((d) => {
              const id = (d?.evidence_id || d?.id || "").toString();
              const filename = (d?.filename || "Untitled").toString();
              const form = (d?.contract_form || d?.form || d?.type || "").toString();
              const date = (d?.contract_date || d?.date || d?.document_date || "").toString();
              const value = (d?.contract_value || d?.value || "").toString();
              const parties = (d?.parties || "").toString();
              const labels = Array.isArray(d?.source_labels) ? d.source_labels : (Array.isArray(d?.source_labels) ? d.source_labels : []);
              const chips = [];
              if (form) chips.push(form);
              if (value) chips.push(value);
              if (date) chips.push(date);
              if (Array.isArray(labels) && labels.length) chips.push(labels.filter(Boolean).join(", "));

              const metaParts = [];
              if (parties) metaParts.push(parties);
              const keyTermsObj = (d && typeof d === "object" && d.key_terms && typeof d.key_terms === "object") ? d.key_terms : null;
              if (keyTermsObj) {
                try {
                  const entries = Object.entries(keyTermsObj)
                    .filter(([k, v]) => String(v || "").trim())
                    .slice(0, 3)
                    .map(([k, v]) => `${k}: ${String(v).trim().slice(0, 90)}`);
                  if (entries.length) metaParts.push(entries.join(" • "));
                } catch {}
              }
              const risks = Array.isArray(d?.risks) ? d.risks.slice(0, 2).join(" • ") : "";
              if (risks) metaParts.push(`Risks: ${risks}`);

              return `
                <div class="about-contract-item">
                  <div>
                    <div class="about-contract-title">${escapeHtml(filename)}</div>
                    <div class="about-contract-meta">${escapeHtml(metaParts.join(" | "))}</div>
                    ${chips.length ? `<div class="about-chips">${chips.map(c => `<span class="about-chip">${escapeHtml(String(c))}</span>`).join("")}</div>` : ""}
                  </div>
                  <div class="about-contract-actions">
                    ${id ? `<button class="btn btn-sm btn-outline" onclick="downloadDocument('${id}')" title="Download"><i class="fas fa-download"></i></button>` : ""}
                  </div>
                </div>
              `;
            }).join("");
          }
        }

        if (contractTermsEl) {
          const textSummary = (contracts?.summary || contracts?.read_in || "").toString();
          if (textSummary.trim()) {
            contractTermsEl.textContent = textSummary;
          } else if (keyTerms.length) {
            contractTermsEl.textContent = keyTerms.slice(0, 18).map(t => `• ${String(t || "")}`).join("\n");
          } else {
            contractTermsEl.textContent = docs.length ? "Extracting key terms… run Refresh for a deeper contract read." : "Upload the contract pack to extract key terms (payment, retention, LDs, EOT, dispute resolution).";
          }
        }

        if (contractHintEl) {
          contractHintEl.textContent =
            docs.length
              ? `Built from ${docs.length} contract document(s). Click Refresh for a deeper clause/term extraction.`
              : "Tip: include the executed contract, amendments, schedules, and any key appointments (architect/QS/engineer).";
        }
      } catch {
        // best-effort
      }

      // Structured dispute intelligence (highly structured, deep mode fills this out)
      try {
        const structured = about?.structured || about?.data?.structured || {};
        const at = structured?.at_a_glance || {};
        const parties = Array.isArray(structured?.parties_roles) ? structured.parties_roles : [];
        const issues = Array.isArray(structured?.issues) ? structured.issues : [];
        const nextActions = Array.isArray(structured?.next_actions) ? structured.next_actions : [];
        const evidenceMap = (structured && typeof structured === "object" && structured.evidence_map && typeof structured.evidence_map === "object")
          ? structured.evidence_map
          : {};

        if (atAGlanceEl) {
          const lines = [];
          const push = (k, v) => { if (v && String(v).trim()) lines.push(`${k}: ${String(v).trim()}`); };
          push("Headline", at.headline);
          push("Dispute type", at.dispute_type);
          push("Location", at.location);
          push("Contract form", at.contract_form);
          push("Contract value", at.contract_value);
          if (Array.isArray(at.key_dates) && at.key_dates.length) {
            lines.push(`Key dates: ${at.key_dates.slice(0,6).join(" • ")}`);
          } else {
            push("Key dates", at.key_dates);
          }
          push("Current position", at.current_position);
          push("Quantum", at.quantum);
          atAGlanceEl.textContent = lines.length ? lines.join("\n") : "Run Supercharge to generate structured intelligence (at-a-glance, parties, issues, next steps).";
        }

        if (partiesEl) {
          if (!parties.length) {
            partiesEl.textContent = "Supercharge will extract parties/roles from contracts, pleadings, and key correspondence.";
          } else {
            partiesEl.textContent = parties.slice(0, 14).map(p => {
              const name = (p?.name || "").toString().trim();
              const role = (p?.role || "").toString().trim();
              const org = (p?.organisation || "").toString().trim();
              const notes = (p?.notes || "").toString().trim();
              const bits = [];
              if (name) bits.push(name);
              if (role) bits.push(`(${role})`);
              if (org) bits.push(`— ${org}`);
              if (notes) bits.push(`: ${notes}`);
              return `• ${bits.join(" ")}`.replace(/\s+/g, " ").trim();
            }).join("\n");
          }
        }

        if (issuesEl) {
          if (!issues.length) {
            issuesEl.textContent = "Supercharge will extract the core issues (defects, delay, payment, design responsibility, insurance) with citations.";
          } else {
            issuesEl.textContent = issues.slice(0, 10).map(it => {
              const title = (it?.issue || "").toString().trim();
              const what = (it?.what_happened || "").toString().trim();
              const why = (it?.why_it_matters || "").toString().trim();
              const lines = [];
              if (title) lines.push(`• ${title}`);
              if (what) lines.push(`  - What: ${what}`);
              if (why) lines.push(`  - Why: ${why}`);
              return lines.join("\n");
            }).join("\n");
          }
        }

        if (nextActionsEl) {
          if (!nextActions.length) {
            nextActionsEl.textContent = "Supercharge will propose next actions with document requests and owner hints.";
          } else {
            nextActionsEl.textContent = nextActions.slice(0, 12).map(a => {
              const action = (a?.action || "").toString().trim();
              const why = (a?.why || "").toString().trim();
              const owner = (a?.owner_hint || "").toString().trim();
              const lines = [];
              if (action) lines.push(`• ${action}`);
              if (why) lines.push(`  - Why: ${why}`);
              if (owner) lines.push(`  - Owner: ${owner}`);
              return lines.join("\n");
            }).join("\n");
          }
        }

        if (structuredHintEl) {
          structuredHintEl.textContent =
            (structured && Object.keys(structured).length)
              ? "Structured intelligence is generated from extracted text + AWS entity extraction + contract queries."
              : "Tip: Supercharge runs deep processing and produces structured intelligence for counsel.";
        }

        if (evidenceMapEl) {
          const categories = [
            ["Contracts", "contracts"],
            ["Pleadings", "pleadings"],
            ["Expert reports", "expert_reports"],
            ["Correspondence", "correspondence"],
            ["Programmes", "programmes"],
            ["Photos", "photos"],
          ];

          function renderCategory(label, key) {
            const items = Array.isArray(evidenceMap?.[key]) ? evidenceMap[key] : [];
            if (!items.length) return "";
            const rows = items.slice(0, 6).map((it) => {
              const filename = (it?.filename || "").toString();
              const why = (it?.why_relevant || "").toString();
              const id = (it?.evidence_id || it?.id || "").toString();
              return `
                <div class="about-contract-item">
                  <div>
                    <div class="about-contract-title">${escapeHtml(filename || "Untitled")}</div>
                    <div class="about-contract-meta">${escapeHtml(why)}</div>
                  </div>
                  <div class="about-contract-actions">
                    ${id ? `<button class="btn btn-sm btn-outline" onclick="downloadDocument('${id}')" title="Download"><i class="fas fa-download"></i></button>` : ""}
                  </div>
                </div>
              `;
            }).join("");
            return `
              <div style="margin-top: 10px;">
                <div class="about-subtitle">${escapeHtml(label)}</div>
                <div class="about-contract-list">${rows}</div>
              </div>
            `;
          }

          const html = categories.map(([label, key]) => renderCategory(label, key)).filter(Boolean).join("");
          evidenceMapEl.innerHTML = html || `<div class="about-pre">Supercharge will build an evidence map (contracts/pleadings/reports/correspondence/programmes/photos) and explain why each item matters.</div>`;
        }

        if (evidenceMapHintEl) {
          evidenceMapHintEl.textContent =
            (evidenceMap && Object.keys(evidenceMap).length)
              ? "Evidence map is auto-generated; click any item to download and verify."
              : "";
        }
      } catch {
        // best-effort
      }

      if (notesEl) {
        notesEl.value = (about?.user_notes || "").toString();
      }

      if (openQEl) {
        openQEl.innerHTML = "";
        const qs = Array.isArray(about?.open_questions) ? about.open_questions : [];
        if (qs.length === 0) {
          if (openQHint) openQHint.textContent = status === "ready" ? "No gaps detected yet." : "AI will propose gaps once it has documents.";
        } else {
          if (openQHint) openQHint.textContent = "";
          qs.slice(0, 12).forEach((q) => {
            const li = document.createElement("li");
            li.textContent = String(q || "");
            openQEl.appendChild(li);
          });
        }
      }

      if (chatHint) {
        chatHint.textContent =
          status === "building"
            ? `Processing documents. ${updatedText}`
            : updatedText;
      }

      updateTabCounts();
    }

    async function loadWorkspaceAbout() {
      if (!workspaceId) return;
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/about`, {
          headers: getAuthHeaders(),
        });
        if (!res.ok) throw new Error("Failed to load About");
        workspaceAbout = await res.json();
        _renderAbout(workspaceAbout);

        const status = (workspaceAbout?.status || "").toLowerCase();
        if (status === "building" || status === "processing") {
          _clearAboutPoll();
          aboutPollHandle = setTimeout(() => loadWorkspaceAbout().catch(() => {}), 1800);
        } else {
          _clearAboutPoll();
        }
      } catch (e) {
        // Don't toast-spam; About is best-effort
        console.debug("About load failed:", e);
      }
    }

    async function refreshWorkspaceAbout(force) {
      if (!workspaceId) return;
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/about/refresh`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ force: !!force }),
        });
        if (!res.ok) throw new Error("Failed to refresh About");
        workspaceAbout = await res.json().catch(() => workspaceAbout);
        _renderAbout(workspaceAbout);
        _clearAboutPoll();
        aboutPollHandle = setTimeout(() => loadWorkspaceAbout().catch(() => {}), 1200);
      } catch (e) {
        console.debug("About refresh failed:", e);
      }
    }

    async function askWorkspaceAbout() {
      const input = document.getElementById("aboutQuestionInput");
      const btn = document.getElementById("aboutAskBtn");
      const question = (input?.value || "").trim();
      if (!question) return;

      _appendChatMessage("user", question);
      if (input) input.value = "";
      if (btn) btn.disabled = true;

      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/about/ask`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ question }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = typeof data?.detail === "string" ? data.detail : "Failed to answer question";
          _appendChatMessage("ai", msg);
          return;
        }
        _appendChatMessage("ai", String(data?.answer || "No answer returned."));
        if (Array.isArray(data?.sources) && data.sources.length > 0) {
          const top = data.sources.slice(0, 6).map(s => `• ${s.filename || s.label || s.id || "source"}`).join("\n");
          _appendChatMessage("ai", `Sources:\n${top}`);
        }
      } catch (e) {
        _appendChatMessage("ai", "Failed to answer question (network or server error).");
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function saveWorkspaceAboutNotes() {
      const notesEl = document.getElementById("aboutUserNotes");
      const hintEl = document.getElementById("aboutNotesHint");
      const notes = (notesEl?.value || "").trim();
      if (!workspaceId) return;

      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/about/notes`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ notes }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(typeof data?.detail === "string" ? data.detail : "Failed to save notes");
        if (hintEl) hintEl.textContent = "Saved. The next refresh will incorporate these facts.";
        // Trigger rebuild (best effort)
        refreshWorkspaceAbout(true).catch(() => {});
      } catch (e) {
        if (hintEl) hintEl.textContent = "Failed to save notes.";
      }
    }

    function renderDocuments() {
      const grid = document.getElementById("documentsGrid");

      if (workspaceDocuments.length === 0) {
        grid.innerHTML = '';
        return;
      }

      grid.innerHTML = workspaceDocuments.map(doc => {
        const ext = (doc.filename || '').split('.').pop().toLowerCase();
        let iconClass = '';
        let iconName = 'fa-file';
        if (['pdf'].includes(ext)) { iconClass = 'pdf'; iconName = 'fa-file-pdf'; }
        else if (['doc', 'docx'].includes(ext)) { iconClass = 'doc'; iconName = 'fa-file-word'; }
        else if (['xls', 'xlsx', 'csv'].includes(ext)) { iconClass = 'xls'; iconName = 'fa-file-excel'; }
        else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) { iconClass = 'img'; iconName = 'fa-file-image'; }

        return `
          <div class="document-card" data-doc-id="${doc.id}" ${doc.uploading ? 'style="opacity: 0.6;"' : ''}>
            <div class="doc-actions">
              <button class="table-action-btn" onclick="downloadDocument('${doc.id}')" title="Download"><i class="fas fa-download"></i></button>
              <button class="table-action-btn danger" onclick="deleteDocument('${doc.id}')" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
            <div class="document-icon ${iconClass}">
              <i class="fas ${iconName}"></i>
            </div>
            <div class="document-name">${escapeHtml(doc.filename || 'Untitled')}</div>
            <div class="document-meta">${formatFileSize(doc.size)} • ${formatDate(doc.created_at)}</div>
          </div>
        `;
      }).join('');
    }

    function downloadDocument(id) {
      const ws = encodeURIComponent(workspaceId || "");
      const docId = encodeURIComponent(id || "");
      window.open(`/api/workspaces/${ws}/documents/${docId}/download`, '_blank');
    }

    function deleteDocument(id) {
      const doc = workspaceDocuments.find(d => String(d.id) === String(id));
      if (!doc) return;
      
      if (!confirm(`Delete "${doc.filename}"?`)) return;

      workspaceDocuments = workspaceDocuments.filter(d => String(d.id) !== String(id));
      
      fetch(`/api/workspaces/${workspaceId}/documents/${id}`, {
        method: 'DELETE',
        headers: getAuthHeaders()
      }).catch(() => {});

      renderDocuments();
      updateTabCounts();
      VericaseUI.Toast.success("Document deleted");
    }

    // ========================================
    // TEAM MANAGEMENT
    // ========================================
    function renderTeam() {
      const grid = document.getElementById("teamGrid");

      if (workspaceTeam.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-id-badge empty-icon"></i>
            <div class="empty-title">No Team Members</div>
            <div class="empty-desc">Add existing users to collaborate on this workspace.</div>
            <button class="btn btn-vericase" onclick="showAddMemberModal()">
              <i class="fas fa-user-plus"></i> Add Member
            </button>
          </div>
        `;
        return;
      }

      grid.innerHTML = workspaceTeam.map(user => {
        const initials = getInitials(user.name || user.email);
        const roleClass = String(user.role || '').toLowerCase() === 'admin' ? 'admin' : '';
        return `
          <div class="team-member" data-user-id="${user.id || user.email}">
            <div class="member-actions">
              <button class="table-action-btn danger" onclick="removeMember('${user.id || user.email}')" title="Remove"><i class="fas fa-times"></i></button>
            </div>
            <div class="team-avatar">${initials}</div>
            <div class="team-info">
              <div class="team-name">${escapeHtml(user.name || 'Unknown')}</div>
              <div class="team-email">${escapeHtml(user.email || '')}</div>
              <span class="team-role ${roleClass}">${escapeHtml(user.role || 'Member')}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function showAddMemberModal() {
      document.getElementById("addMemberModal").style.display = "flex";
    }

    function hideAddMemberModal() {
      document.getElementById("addMemberModal").style.display = "none";
    }

    async function addMember() {
      const email = document.getElementById("memberEmail").value.trim();
      const role = document.getElementById("memberRole").value;

      if (!email) {
        VericaseUI.Toast.error("Please enter an email address");
        return;
      }

      try {
        const res = await fetch(`/api/workspaces/${workspaceId}/team`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ email, role })
        });

        if (!res.ok) {
          const detail = await res.json().catch(() => ({}));
          const message =
            typeof detail?.detail === "string"
              ? detail.detail
              : "Failed to add member";
          VericaseUI.Toast.error(message);
          return;
        }

        const created = await res.json().catch(() => null);
        if (created) {
          // Avoid duplicates
          const createdId = String(created.id || "");
          const createdEmail = String(created.email || email).toLowerCase();
          const already = workspaceTeam.some(
            (u) =>
              (createdId && String(u.id) === createdId) ||
              (u.email && String(u.email).toLowerCase() === createdEmail)
          );
          if (!already) workspaceTeam.push(created);
        }

        renderTeam();
        updateTabCounts();
        VericaseUI.Toast.success(`Added ${email}`);
      } catch (e) {
        console.error("Failed to add member:", e);
        VericaseUI.Toast.error("Failed to add member");
        return;
      }

      hideAddMemberModal();
      document.getElementById("memberEmail").value = '';
    }

    function removeMember(id) {
      const user = workspaceTeam.find(u => String(u.id) === String(id) || u.email === id);
      if (!user) return;
      
      if (!confirm(`Remove ${user.name || user.email} from this workspace?`)) return;

      workspaceTeam = workspaceTeam.filter(u => String(u.id) !== String(id) && u.email !== id);
      
      fetch(`/api/workspaces/${workspaceId}/team/${id}`, {
        method: 'DELETE',
        headers: getAuthHeaders()
      }).catch(() => {});

      renderTeam();
      updateTabCounts();
      VericaseUI.Toast.success("Team member removed");
    }

    // ========================================
    // COLLABORATION (Notes & Activity)
    // ========================================
    function renderNotes() {
      const container = document.getElementById("notesList");

      if (workspaceNotes.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No notes yet. Start the conversation!</p>';
        return;
      }

      container.innerHTML = workspaceNotes.map(note => `
        <div class="note-item">
          <div class="note-header">
            <span class="note-author">${escapeHtml(note.author || 'Unknown')}</span>
            <span class="note-time">${formatRelativeTime(note.created_at)}</span>
          </div>
          <div class="note-content">${escapeHtml(note.content)}</div>
        </div>
      `).join('');
    }

    async function addNote() {
      const input = document.getElementById("newNoteInput");
      const content = input.value.trim();

      if (!content) return;

      const note = {
        id: Date.now(),
        content,
        author: 'You',
        created_at: new Date().toISOString()
      };

      // Try to save to backend
      try {
        const res = await fetch(`/api/workspaces/${workspaceId}/notes`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ content })
        });
        if (res.ok) {
          const saved = await res.json();
          workspaceNotes.unshift(saved);
        } else {
          workspaceNotes.unshift(note);
        }
      } catch {
        workspaceNotes.unshift(note);
      }

      input.value = '';
      renderNotes();
      VericaseUI.Toast.success("Note added");
    }

    function renderActivity() {
      const container = document.getElementById("activityFeed");

      // Generate some mock activity if empty
      if (workspaceActivity.length === 0) {
        workspaceActivity = [
          { type: 'add', text: 'Workspace created', time: workspaceData?.created_at || new Date().toISOString() }
        ];
      }

      container.innerHTML = workspaceActivity.slice(0, 10).map(a => {
        let iconClass = '';
        let iconName = 'fa-circle';
        if (a.type === 'add') { iconClass = 'add'; iconName = 'fa-plus'; }
        else if (a.type === 'edit') { iconClass = 'edit'; iconName = 'fa-edit'; }
        else if (a.type === 'delete') { iconClass = 'delete'; iconName = 'fa-trash'; }
        else if (a.type === 'comment') { iconClass = 'comment'; iconName = 'fa-comment'; }

        return `
          <div class="activity-item">
            <div class="activity-icon ${iconClass}"><i class="fas ${iconName}"></i></div>
            <div class="activity-content">
              <div class="activity-text">${a.text}</div>
              <div class="activity-time">${formatRelativeTime(a.time)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========================================
    // MODALS
    // ========================================
    function showAddModal() {
      document.getElementById("addModal").style.display = "flex";
    }

    function hideAddModal() {
      document.getElementById("addModal").style.display = "none";
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
      }
    });

    // ========================================
    // HELPERS
    // ========================================
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return dateStr;
      return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatRelativeTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
      return formatDate(dateStr);
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      let i = 0;
      while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
      }
      return `${bytes.toFixed(1)} ${units[i]}`;
    }

    function getInitials(name) {
      if (!name) return '?';
      return name.split(/[\s@]+/).map(w => w[0]).join('').toUpperCase().slice(0, 2);
    }
  </script>
</body>

</html>

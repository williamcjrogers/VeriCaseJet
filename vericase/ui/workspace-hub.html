<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VeriCase - Workspaces</title>
  <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="brand-styles.css?v=9" />
  <link rel="stylesheet" href="design-system.css?v=9" />
  <script src="vericase-ui.js"></script>
  <script src="nav-shell.js"></script>
  <style>
    /* Workspace hub provides its own in-page header; avoid duplicated breadcrumb bars when wrapped in the shell */
    .app-shell .hub-breadcrumb {
      display: none;
    }

    /* Fallback (if the shell doesn’t inject for any reason) */
    body.workspace-hub-page {
      background-color: var(--vericase-cream);
      background-image: radial-gradient(var(--gray-200) 1px, transparent 1px);
      background-size: 24px 24px;
    }

    body.workspace-hub-page > .workspace-hub-container {
      padding: 32px 48px;
      min-height: 100vh;
    }
    /* === WORKSPACES - DIRECTORY + WORKSPACE VIEW === */

    /* === BREADCRUMB BAR === */
    .hub-breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .hub-breadcrumb a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.15s ease;
    }

    .hub-breadcrumb a:hover {
      color: var(--vericase-teal);
    }

    .hub-breadcrumb .separator {
      color: var(--gray-300);
      font-size: 0.75rem;
    }

    .hub-breadcrumb .current {
      color: var(--text-primary);
      font-weight: 500;
    }

    .hub-subtext {
      color: var(--text-muted);
      font-size: 0.9375rem;
      line-height: 1.5;
      margin: -8px 0 14px;
      max-width: 85ch;
    }

    .hub-subtext.hub-subtext-roomy {
      margin: -8px 0 20px;
      max-width: 70ch;
    }

    /* The navigation shell injects the REAL `.app-content` container.
       This page should style that container (not create a nested `.app-content`). */
    .app-content {
      background-color: var(--vericase-cream);
      background-image: radial-gradient(var(--gray-200) 1px, transparent 1px);
      background-size: 24px 24px;
      border: none;
      border-radius: 0;
      box-shadow: none;
      margin: 0;
      padding: 32px 48px;
      min-height: 100vh;
      position: relative;
    }

    /* Page width container (prevents ultra-wide “stretched” layouts) */
    .workspace-hub-container {
      max-width: 1440px;
      margin: 0 auto;
      width: 100%;
    }

    /* === WORKSPACES DIRECTORY (LIST) === */
    .directory-hero {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: var(--space-6);
      flex-wrap: wrap;
      margin-bottom: var(--space-5);
      position: relative;
      z-index: 1;
    }

    .directory-title-row {
      display: flex;
      align-items: flex-start;
      gap: var(--space-4);
    }

    .directory-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(var(--vericase-teal-rgb), 0.10);
      color: var(--vericase-teal);
      border: 1px solid rgba(var(--vericase-teal-rgb), 0.18);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .directory-title {
      font-family: var(--font-serif);
      font-size: 1.75rem;
      font-weight: 650;
      color: var(--text-primary);
      line-height: 1.15;
      margin: 0;
      display: inline-flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .directory-count-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      font-weight: 600;
      background: rgba(var(--vericase-teal-rgb), 0.10);
      border: 1px solid rgba(var(--vericase-teal-rgb), 0.20);
      color: var(--vericase-teal);
      min-width: 42px;
    }

    .directory-count-pill:empty {
      visibility: hidden;
    }

    .directory-subtitle {
      margin-top: 6px;
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 76ch;
      line-height: 1.45;
    }

    .directory-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .directory-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      flex-wrap: wrap;
      margin-bottom: var(--space-6);
      padding: var(--space-4);
      background: rgba(255, 255, 255, 0.82);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      position: relative;
      z-index: 1;
    }

    .directory-search {
      position: relative;
      flex: 1;
      min-width: min(560px, 100%);
    }

    .directory-search i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 0.9rem;
      pointer-events: none;
    }

    .directory-search input.form-input {
      width: 100%;
      padding-left: 38px;
      padding-right: 44px;
      background: #ffffff;
    }

    .directory-search-clear {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--gray-200);
      background: var(--gray-50);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .directory-search-clear:hover {
      background: var(--gray-100);
      color: var(--text-primary);
      border-color: var(--gray-300);
    }

    .directory-toolbar-right {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .directory-filters {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    .directory-filters .form-select {
      min-width: 170px;
    }

    .directory-meta {
      font-size: 0.85rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Workspace cards (directory) */
    .workspace-card {
      background: rgba(255, 255, 255, 0.92);
      border-color: var(--border-default);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .workspace-card::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: rgba(var(--vericase-teal-rgb), 0.45);
      opacity: 0.6;
    }

    .workspace-card:hover::before {
      opacity: 1;
    }

    .workspace-card:focus-within {
      border-color: rgba(var(--vericase-teal-rgb), 0.65);
      box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.18), var(--shadow-lg);
    }

    .workspace-card .item-title {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .workspace-card .item-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      align-items: start;
    }

    .workspace-card .workspace-preview {
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .workspace-card--skeleton {
      cursor: default;
    }

    .workspace-card--skeleton:hover {
      transform: none;
      box-shadow: var(--shadow-sm);
      border-color: var(--border-default);
    }

    .workspace-card-skel-top {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
    }

    .sk-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      flex-shrink: 0;
    }

    .workspace-card-skel-lines {
      flex: 1;
      display: grid;
      gap: 8px;
      min-width: 0;
    }

    .sk-line {
      height: 12px;
      border-radius: 10px;
    }

    .sk-line--title {
      width: 70%;
      height: 14px;
    }

    .sk-line--meta {
      width: 48%;
      height: 11px;
    }

    .sk-pill {
      width: 78px;
      height: 18px;
      border-radius: 999px;
      flex-shrink: 0;
    }

    .workspace-card-skel-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      border-top: 1px solid var(--gray-100);
      padding-top: 12px;
    }

    .sk-stat {
      height: 12px;
      border-radius: 10px;
    }

    /* === WORKSPACE HEADER === */
    .workspace-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 24px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .workspace-identity {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .workspace-icon-large {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      background: linear-gradient(135deg, rgba(31, 111, 120, 0.15) 0%, rgba(47, 134, 200, 0.1) 100%);
      color: var(--vericase-teal);
      flex-shrink: 0;
    }

    .workspace-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .workspace-name {
      font-family: var(--font-serif);
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .workspace-code-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .workspace-code-badge .code {
      background: var(--gray-100);
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 500;
    }

    .workspace-code-badge .contract-type {
      color: var(--vericase-teal);
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* === STATS BAR === */
    .stats-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .stat-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #FFFFFF;
      border: 1px solid var(--border-default);
      border-left: 3px solid var(--gray-300);
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      color: var(--text-secondary);
      box-shadow: var(--shadow-card);
      transition: all 0.15s ease;
    }

    .stat-pill:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    /* Accent borders for each stat */
    .stat-pill.projects { border-left-color: var(--vericase-navy); }
    .stat-pill.cases { border-left-color: var(--vericase-gold); }
    .stat-pill.deadlines { border-left-color: var(--status-warning); }
    .stat-pill.documents { border-left-color: var(--vericase-teal); }
    .stat-pill.members { border-left-color: #78716C; }

    .stat-pill i {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .stat-pill strong {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--text-primary);
    }

    /* === TAB NAVIGATION === */
    .hub-tabs {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid var(--gray-200);
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .hub-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: transparent;
      border: none;
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .hub-tab:hover {
      color: var(--text-primary);
      background: var(--gray-50);
    }

    .hub-tab.active {
      color: var(--vericase-teal);
      border-bottom-color: var(--vericase-teal);
      font-weight: 600;
    }

    .hub-tab i {
      font-size: 0.875rem;
    }

    .hub-tab .tab-count {
      background: var(--gray-100);
      padding: 2px 8px;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .hub-tab.active .tab-count {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      color: var(--vericase-teal);
    }

    /* === TAB PANELS === */
    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* === SECTIONS === */
    .hub-section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-title i {
      color: var(--vericase-teal);
      font-size: 1rem;
    }

    .section-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      padding: 0 8px;
      background: var(--gray-100);
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .section-actions {
      display: flex;
      gap: 8px;
    }

    /* === ITEM CARDS === */
    .items-grid {
      display: grid;
      /* Prevent horizontal overflow at high zoom / narrow viewports */
      grid-template-columns: repeat(auto-fill, minmax(min(340px, 100%), 1fr));
      gap: 20px;
    }

    .item-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--gray-200);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .item-card:hover {
      border-color: var(--vericase-teal);
      box-shadow: 0 8px 24px rgba(15, 23, 32, 0.1);
      transform: translateY(-2px);
    }

    .item-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .item-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      flex-shrink: 0;
    }

    .item-icon.project {
      background: rgba(47, 134, 200, 0.1);
      color: #2f86c8;
    }

    .item-icon.case {
      background: rgba(181, 155, 106, 0.15);
      color: var(--vericase-gold);
    }

    .item-icon.workspace {
      background: rgba(var(--vericase-teal-rgb), 0.12);
      color: var(--vericase-teal);
    }

    .item-status {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 4px 10px;
      border-radius: var(--radius-md);
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    .item-status.pending {
      background: rgba(234, 179, 8, 0.1);
      color: #ca8a04;
    }

    .item-status.closed {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
    }

    .item-content {
      margin-bottom: 12px;
    }

    .item-title {
      font-size: 1.0625rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .item-code {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .item-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .item-stats {
      display: flex;
      gap: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--gray-100);
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .item-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .item-stat i {
      font-size: 0.75rem;
      opacity: 0.7;
      flex-shrink: 0;
    }

    .item-stat strong {
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Card Action Buttons */
    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--gray-100);
    }

    .card-action-btn {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
      overflow-wrap: anywhere;
    }

    .card-action-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-300);
      color: var(--text-primary);
    }

    .card-action-btn.primary {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      border-color: rgba(var(--vericase-teal-rgb), 0.3);
      color: var(--vericase-teal);
    }

    .card-action-btn.primary:hover {
      background: rgba(var(--vericase-teal-rgb), 0.15);
      border-color: var(--vericase-teal);
    }

    .card-action-btn i {
      font-size: 0.75rem;
    }

    /* === EMPTY STATE === */
    .empty-state {
      background: var(--gray-50);
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-lg);
      padding: 48px 24px;
      text-align: center;
    }

    .empty-icon {
      font-size: 2.5rem;
      color: var(--gray-400);
      margin-bottom: 16px;
    }

    .empty-title {
      font-size: 1.0625rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-desc {
      font-size: 0.9375rem;
      color: var(--text-muted);
      margin-bottom: 20px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .workspace-preview {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--gray-200);
    }

    .workspace-preview-title {
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .workspace-preview-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .workspace-preview-item {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .workspace-preview-empty {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    /* === MANAGEMENT TABLE === */
    .mgmt-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--gray-200);
    }

    .mgmt-table th {
      text-align: left;
      padding: 14px 16px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
    }

    .mgmt-table td {
      padding: 14px 16px;
      font-size: 0.9375rem;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
    }

    .mgmt-table tbody tr:last-child td {
      border-bottom: none;
    }

    .mgmt-table tbody tr:hover {
      background: var(--gray-50);
    }

    .mgmt-table .actions-col {
      width: 100px;
      text-align: right;
    }

    .mgmt-table .date-col {
      width: 120px;
    }

    .mgmt-table .status-col {
      width: 140px;
    }

    .table-action-btn {
      background: transparent;
      border: none;
      padding: 6px 8px;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: 4px;
      transition: all 0.15s;
    }

    .table-action-btn:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .table-action-btn.danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    /* Date badges */
    .date-badge {
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--gray-100);
      color: var(--text-secondary);
    }

    .date-badge.overdue {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      font-weight: 600;
    }

    .date-badge.soon {
      background: rgba(234, 179, 8, 0.1);
      color: #ca8a04;
      font-weight: 600;
    }

    .date-badge.upcoming {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      padding: 4px 10px;
      border-radius: var(--radius-md);
      font-weight: 500;
    }

    .status-badge.active {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }

    .status-badge.pending {
      background: rgba(234, 179, 8, 0.1);
      color: #ca8a04;
    }

    .status-badge.complete {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
    }

    /* === INLINE ADD FORM === */
    .inline-add-row {
      background: rgba(var(--vericase-teal-rgb), 0.03);
      border: 2px dashed rgba(var(--vericase-teal-rgb), 0.3);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-top: 16px;
    }

    .inline-add-row .form-row {
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
    }

    .inline-add-row .form-group {
      margin: 0;
    }

    .inline-add-row .form-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .inline-add-row .form-input,
    .inline-add-row .form-select {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--gray-300);
      font-size: 0.9375rem;
      width: 100%;
    }

    .inline-add-row .form-input:focus,
    .inline-add-row .form-select:focus {
      outline: none;
      border-color: var(--vericase-teal);
      box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.1);
    }

    /* === WORKSPACE DOCS (FOLDERS + PREVIEW + CHAT) === */
    .docs-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 12px 0 16px;
      flex-wrap: wrap;
    }

    .docs-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 900px) {
      .docs-layout {
        grid-template-columns: 1fr;
      }
      .docs-sidebar {
        order: 2;
      }
      .docs-main {
        order: 1;
      }
    }

    .docs-sidebar {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 12px;
    }

    .docs-sidebar-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 10px;
    }

    .docs-folder-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .docs-folder-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--text-secondary);
      border: 1px solid transparent;
    }

    .docs-folder-item:hover {
      background: var(--gray-50);
    }

    .docs-folder-item.active {
      background: rgba(var(--vericase-teal-rgb), 0.10);
      color: var(--text-primary);
      border-color: rgba(var(--vericase-teal-rgb), 0.25);
    }

    .docs-folder-item .folder-count {
      margin-left: auto;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .docs-breadcrumb {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin: 0 0 8px;
    }

    .docs-breadcrumb a {
      color: var(--vericase-teal);
      text-decoration: none;
    }

    .docs-breadcrumb a:hover {
      text-decoration: underline;
    }

    .docs-main {
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }

    .doc-detail {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .doc-detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--gray-200);
    }

    .doc-detail-title {
      font-weight: 600;
      color: var(--text-primary);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .doc-detail-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .doc-preview {
      padding: 12px 14px;
      background: #fcfcfd;
    }

    .doc-preview-frame {
      width: 100%;
      height: 520px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      background: white;
    }

    .doc-preview-img {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      background: white;
      display: block;
    }

    .doc-preview-pre {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 0.85rem;
      color: var(--text-secondary);
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 12px;
      max-height: 520px;
      overflow: auto;
    }

    .doc-chat {
      border-top: 1px solid var(--gray-200);
      background: white;
    }

    .doc-chat-messages {
      padding: 12px 14px;
      max-height: 220px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .doc-chat-messages .msg {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      background: var(--gray-50);
      color: var(--text-secondary);
      white-space: pre-wrap;
    }

    .doc-chat-messages .msg.user {
      align-self: flex-end;
      background: rgba(var(--vericase-teal-rgb), 0.08);
      border-color: rgba(var(--vericase-teal-rgb), 0.25);
      color: var(--text-primary);
    }

    .doc-chat-messages .msg.assistant {
      align-self: flex-start;
    }

    .doc-chat-input {
      display: flex;
      gap: 8px;
      padding: 12px 14px;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .doc-chat-input input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font-size: 0.9375rem;
    }

    .doc-chat-input input:focus {
      outline: none;
      border-color: var(--vericase-teal);
      box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.1);
    }

    /* === DOCUMENTS GRID === */
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(min(200px, 100%), 1fr));
      gap: 16px;
    }

    .document-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .document-card:hover {
      border-color: var(--vericase-teal);
      box-shadow: 0 4px 12px rgba(15, 23, 32, 0.08);
    }

    .document-card .doc-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .document-card:hover .doc-actions {
      opacity: 1;
    }

    .document-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 12px;
      background: var(--gray-50);
      color: var(--text-muted);
    }

    .document-icon.pdf { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
    .document-icon.doc { background: rgba(37, 99, 235, 0.1); color: #2563eb; }
    .document-icon.xls { background: rgba(22, 163, 74, 0.1); color: #16a34a; }
    .document-icon.img { background: rgba(168, 85, 247, 0.1); color: #9333ea; }

    .document-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .document-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-lg);
      padding: 40px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--gray-50);
      margin-bottom: 24px;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
      border-color: var(--vericase-teal);
      background: rgba(var(--vericase-teal-rgb), 0.05);
    }

    .upload-zone i {
      font-size: 2.5rem;
      color: var(--gray-400);
      margin-bottom: 12px;
    }

    .upload-zone:hover i {
      color: var(--vericase-teal);
    }

    .upload-zone .upload-text {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .upload-zone .upload-hint {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    /* === TEAM LIST === */
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr));
      gap: 16px;
    }

    .team-member {
      display: flex;
      align-items: center;
      gap: 16px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 16px;
      position: relative;
    }

    .team-member:hover {
      border-color: var(--gray-300);
    }

    .team-member .member-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .team-member:hover .member-actions {
      opacity: 1;
    }

    .team-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--vericase-teal), #2f86c8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .team-info {
      flex: 1;
      min-width: 0;
    }

    .team-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .team-email {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .team-role {
      display: inline-flex;
      align-items: center;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: var(--radius-md);
      background: var(--gray-100);
      color: var(--text-secondary);
    }

    .team-role.admin {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      color: var(--vericase-teal);
    }

    /* === COLLABORATION === */
    .collab-section {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
    }

    .collab-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-100);
    }

    .collab-section-header h4 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .collab-section-header h4 i {
      color: var(--vericase-teal);
    }

    .collab-section-body {
      padding: 20px;
    }

    /* Notes */
    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .note-item {
      background: var(--gray-50);
      border-radius: var(--radius-md);
      padding: 16px;
      position: relative;
    }

    .note-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .note-author {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    .note-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .note-content {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .note-input-wrapper {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .note-input-wrapper textarea {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      resize: none;
      font-size: 0.9375rem;
      min-height: 80px;
    }

    .note-input-wrapper textarea:focus {
      outline: none;
      border-color: var(--vericase-teal);
    }

    /* Activity Feed */
    .activity-feed {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .activity-item {
      display: flex;
      gap: 12px;
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .activity-icon.add { background: rgba(34, 197, 94, 0.1); color: #16a34a; }
    .activity-icon.edit { background: rgba(37, 99, 235, 0.1); color: #2563eb; }
    .activity-icon.delete { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
    .activity-icon.comment { background: rgba(168, 85, 247, 0.1); color: #9333ea; }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-size: 0.875rem;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .activity-text strong {
      font-weight: 600;
    }

    .activity-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* === BACK LINK === */
    .back-section {
      padding-top: 24px;
      border-top: 1px solid var(--gray-200);
      margin-top: 32px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 0.9375rem;
      text-decoration: none;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: var(--vericase-teal);
    }

    /* === MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 32, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: 0 20px 60px rgba(15, 23, 32, 0.2);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-100);
    }

    .modal-header h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-body .form-group {
      margin-bottom: 16px;
    }

    .modal-body .form-label {
      display: block;
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .modal-body .form-input,
    .modal-body .form-select,
    .modal-body .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.9375rem;
    }

    .modal-body .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .modal-body .form-input:focus,
    .modal-body .form-select:focus,
    .modal-body .form-textarea:focus {
      outline: none;
      border-color: var(--vericase-teal);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--gray-100);
    }

    /* === SKELETON === */
    .skeleton {
      background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 6px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .app-content {
        padding: 24px 16px;
      }

      body.workspace-hub-page > .workspace-hub-container {
        padding: 24px 16px;
      }

      .directory-toolbar {
        padding: var(--space-3);
      }

      .directory-search {
        min-width: 100%;
      }

      .directory-filters .form-select {
        min-width: 160px;
      }

      .workspace-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .items-grid {
        grid-template-columns: 1fr;
      }

      .workspace-card .workspace-preview {
        grid-template-columns: 1fr;
      }

      .inline-add-row .form-row {
        grid-template-columns: 1fr;
      }

      .team-grid {
        grid-template-columns: 1fr;
      }

      .hub-tab {
        padding: 10px 14px;
        font-size: 0.875rem;
      }
    }

    /* === ABOUT TAB (AI CONTEXT + Q&A) === */
    .about-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    .about-card {
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      background: var(--bg-white);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      overflow: hidden;
    }

    .about-span-2 {
      grid-column: 1 / -1;
    }

    .about-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      font-weight: 700;
      border-bottom: 1px solid var(--gray-200);
      background: linear-gradient(180deg, rgba(47, 134, 200, 0.06), rgba(47, 134, 200, 0.02));
    }

    .about-card-body {
      padding: 14px 16px;
      color: var(--text-primary);
      font-size: 0.9375rem;
      line-height: 1.55;
    }

    .about-pre {
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 0.95rem;
    }

    .about-markdown {
      white-space: normal;
      line-height: 1.55;
      font-size: 0.95rem;
    }

    .about-markdown h1,
    .about-markdown h2,
    .about-markdown h3,
    .about-markdown h4 {
      margin: 0 0 8px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .about-markdown h1 { font-size: 1.15rem; }
    .about-markdown h2 { font-size: 1.05rem; }
    .about-markdown h3,
    .about-markdown h4 { font-size: 0.98rem; }

    .about-markdown p {
      margin: 0 0 8px;
    }

    .about-markdown p:last-child {
      margin-bottom: 0;
    }

    .about-markdown ul,
    .about-markdown ol {
      margin: 6px 0 8px 18px;
      padding: 0;
    }

    .about-markdown li {
      margin: 2px 0;
    }

    .about-markdown hr {
      border: none;
      border-top: 1px solid var(--gray-200);
      margin: 10px 0;
    }

    .about-markdown blockquote {
      margin: 8px 0;
      padding-left: 12px;
      border-left: 3px solid var(--gray-200);
      color: var(--text-muted);
    }

    .about-markdown code {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.9em;
      background: var(--gray-100);
      padding: 1px 4px;
      border-radius: 6px;
    }

    .about-markdown pre {
      background: var(--gray-100);
      padding: 10px 12px;
      border-radius: 10px;
      overflow-x: auto;
    }

    .about-notes-textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      font-size: 0.9375rem;
      line-height: 1.55;
    }

    .about-actions-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .about-contract-grid {
      display: grid;
      grid-template-columns: 1.25fr 1fr;
      gap: 14px;
    }

    .about-subtitle {
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .about-contract-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .about-contract-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      background: var(--bg-white);
    }

    .about-contract-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .about-contract-meta {
      color: var(--text-muted);
      font-size: 0.8125rem;
      margin-top: 4px;
      line-height: 1.35;
    }

    .about-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .about-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      font-size: 0.75rem;
      font-family: var(--font-mono);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .about-contract-actions {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      flex-shrink: 0;
    }

    @media (max-width: 900px) {
      .about-contract-grid {
        grid-template-columns: 1fr;
      }
    }

    .about-list {
      margin: 0;
      padding-left: 18px;
      color: var(--text-secondary);
    }

    .about-qa-row {
      display: flex;
      gap: 10px;
      align-items: stretch;
      margin-bottom: 12px;
    }

    .about-qa-row input {
      flex: 1;
    }

    .about-chat {
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 12px;
      background: var(--gray-50);
      min-height: 120px;
      white-space: pre-wrap;
    }

    .about-chat .msg {
      padding: 10px 10px;
      border-radius: 12px;
      margin-bottom: 10px;
      border: 1px solid var(--gray-200);
      background: var(--bg-white);
    }

    .about-chat .msg.user {
      border-left: 4px solid var(--vericase-teal);
    }

    .about-chat .msg.ai {
      border-left: 4px solid var(--vericase-gold);
    }

    .about-hint {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .about-grid {
        grid-template-columns: 1fr;
      }
      .about-span-2 {
        grid-column: auto;
      }
    }
  </style>
</head>

<body class="workspace-hub-page">
  <div class="workspace-hub-container">
    <!-- Breadcrumb Navigation -->
    <nav class="hub-breadcrumb" aria-label="Breadcrumb">
      <a href="control-centre.html"><i class="fas fa-compass"></i> Control Centre</a>
      <span class="separator"><i class="fas fa-chevron-right"></i></span>
      <a href="workspace-hub.html">Workspaces</a>
      <span class="separator"><i class="fas fa-chevron-right"></i></span>
      <span class="current" id="breadcrumbWorkspaceName">Loading...</span>
    </nav>

    <!-- Workspaces Directory (no workspaceId) -->
    <section class="hub-section hidden" id="directoryView">
      <header class="directory-hero" aria-label="Workspaces Directory">
        <div class="directory-title-row">
          <div class="directory-icon" aria-hidden="true">
            <i class="fas fa-layer-group"></i>
          </div>
          <div>
            <h1 class="directory-title">
              Workspaces
              <span class="directory-count-pill" id="workspacesCountPill" title="Total workspaces"></span>
            </h1>
            <div class="directory-subtitle">
              Workspaces group projects, cases, documents, and your team.
            </div>
          </div>
        </div>
        <div class="directory-actions">
          <a href="workspace-setup.html" class="btn btn-vericase">
            <i class="fas fa-plus" aria-hidden="true"></i> Create Workspace
          </a>
          <a href="master-dashboard.html" class="btn btn-outline">
            <i class="fas fa-bolt" aria-hidden="true"></i> Quick Access
          </a>
        </div>
      </header>

      <div class="directory-toolbar" role="region" aria-label="Workspace filters">
        <div class="directory-search">
          <i class="fas fa-search" aria-hidden="true"></i>
          <input
            type="search"
            id="workspaceSearch"
            class="form-input"
            placeholder="Search workspaces by name, code, or contract type…"
            autocomplete="off"
          />
          <button
            type="button"
            id="workspaceSearchClear"
            class="directory-search-clear"
            aria-label="Clear search"
            hidden
          >
            <i class="fas fa-xmark" aria-hidden="true"></i>
          </button>
        </div>
        <div class="directory-toolbar-right">
          <div class="directory-filters">
            <select class="form-select" id="workspaceStatusFilter" aria-label="Status filter">
              <option value="all">All statuses</option>
              <option value="active">Active</option>
              <option value="archived">Archived</option>
              <option value="inactive">Inactive</option>
            </select>
            <select class="form-select" id="workspaceSort" aria-label="Sort workspaces">
              <option value="recent">Sort: Recent</option>
              <option value="name-asc">Sort: Name A–Z</option>
              <option value="name-desc">Sort: Name Z–A</option>
            </select>
          </div>
          <div class="directory-meta" id="workspaceDirectoryMeta">Loading…</div>
        </div>
      </div>
      <div class="items-grid" id="workspacesGrid"></div>
    </section>

    <!-- Workspace Header -->
    <header class="workspace-header" id="workspaceHeader">
      <div class="workspace-identity">
        <div class="workspace-icon-large">
          <i class="fas fa-building" aria-hidden="true"></i>
        </div>
        <div class="workspace-info">
          <h1 class="workspace-name" id="workspaceName">Loading...</h1>
          <div class="workspace-code-badge">
            <span class="code" id="workspaceCode">---</span>
            <span class="contract-type" id="workspaceContractType"></span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <a href="#" id="configureBtn" class="btn btn-outline">
          <i class="fas fa-cog" aria-hidden="true"></i> Configure
        </a>
        <button class="btn btn-vericase" onclick="showAddModal()">
          <i class="fas fa-plus" aria-hidden="true"></i> Add
        </button>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-pill skeleton"></div>
    </div>

    <!-- Tab Navigation -->
    <nav class="hub-tabs" id="hubTabs">
      <button class="hub-tab active" data-tab="projects-cases" onclick="switchTab('projects-cases')">
        <i class="fas fa-th-large"></i>
        Projects & Cases
        <span class="tab-count" id="projectsCasesCount">0</span>
      </button>
      <button class="hub-tab" data-tab="deadlines" onclick="switchTab('deadlines')">
        <i class="fas fa-calendar-alt"></i>
        Deadlines
        <span class="tab-count" id="deadlinesCount">0</span>
      </button>
      <button class="hub-tab" data-tab="documents" onclick="switchTab('documents')">
        <i class="fas fa-folder-open"></i>
        Documents
        <span class="tab-count" id="documentsCount">0</span>
      </button>
      <button class="hub-tab" data-tab="about" onclick="switchTab('about')">
        <i class="fas fa-circle-info"></i>
        About
        <span class="tab-count" id="aboutCount">0</span>
      </button>
      <button class="hub-tab" data-tab="purpose" onclick="switchTab('purpose')">
        <i class="fas fa-bullseye"></i>
        Purpose
        <span class="tab-count" id="purposeCount">0</span>
      </button>
      <button class="hub-tab" data-tab="team" onclick="switchTab('team')">
        <i class="fas fa-id-badge"></i>
        Team
        <span class="tab-count" id="teamCount">0</span>
      </button>
      <button class="hub-tab" data-tab="collaboration" onclick="switchTab('collaboration')">
        <i class="fas fa-comments"></i>
        Collaboration
      </button>
    </nav>

    <!-- Tab Panels -->
    <div class="tab-panels">
      <!-- Projects & Cases Panel -->
      <div class="tab-panel active" id="panel-projects-cases">
    <!-- Projects Section -->
    <section class="hub-section" id="projectsSection">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-project-diagram" aria-hidden="true"></i>
          Projects
          <span class="section-count" id="projectCount">0</span>
        </div>
        <div class="section-actions">
          <a href="#" id="addProjectBtn" class="btn btn-sm btn-outline">
            <i class="fas fa-plus" aria-hidden="true"></i> Add Project
          </a>
        </div>
      </div>
          <div class="items-grid" id="projectsGrid"></div>
    </section>

    <!-- Cases Section -->
    <section class="hub-section" id="casesSection">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-briefcase" aria-hidden="true"></i>
          Cases
          <span class="section-count" id="caseCount">0</span>
        </div>
        <div class="section-actions">
          <a href="#" id="addCaseBtn" class="btn btn-sm btn-outline">
            <i class="fas fa-plus" aria-hidden="true"></i> Add Case
          </a>
        </div>
      </div>
          <div class="items-grid" id="casesGrid"></div>
        </section>
      </div>

      <!-- Deadlines Panel -->
      <div class="tab-panel" id="panel-deadlines">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-calendar-alt" aria-hidden="true"></i>
              Workspace Deadlines & Deliverables
            </div>
            <div class="section-actions">
              <button class="btn btn-sm btn-outline" onclick="exportDeadlines()">
                <i class="fas fa-download"></i> Export
              </button>
            </div>
          </div>
          
          <div id="deadlinesTableContainer"></div>
          
          <!-- Inline Add Deadline -->
          <div class="inline-add-row" id="addDeadlineRow">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Task / Deadline</label>
                <input type="text" class="form-input" id="newDeadlineTask" placeholder="e.g., Position statement due">
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="newDeadlineDesc" placeholder="Notes...">
              </div>
              <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="newDeadlineDate">
              </div>
              <div class="form-group">
                <label class="form-label">Reminder</label>
                <select class="form-select" id="newDeadlineReminder">
                  <option value="none">None</option>
                  <option value="7d">7 days</option>
                  <option value="3d">3 days</option>
                  <option value="24h">24 hours</option>
                </select>
              </div>
              <div class="form-group">
                <button class="btn btn-sm btn-vericase" onclick="addDeadline()">
                  <i class="fas fa-plus"></i> Add
                </button>
              </div>
            </div>
      </div>
    </section>
      </div>

      <!-- Documents Panel -->
      <div class="tab-panel" id="panel-documents">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              Dispute Context Documents
            </div>
          </div>
          <div class="hub-subtext">
            Upload key documents (contract, notices, expert reports, pleadings, key letters) to build an AI read-in and Q&A in the <strong>About</strong> tab.
          </div>

          <div class="docs-toolbar">
            <div class="docs-toolbar-left">
              <button class="btn btn-sm btn-outline" type="button" onclick="createWorkspaceDocumentFolder()">
                <i class="fas fa-folder-plus"></i> New Folder
              </button>
              <button class="btn btn-sm btn-outline" type="button" onclick="triggerFolderUpload()">
                <i class="fas fa-folder-tree"></i> Upload Folder
              </button>
            </div>
            <div class="docs-toolbar-right">
              <button class="btn btn-sm btn-vericase" type="button" onclick="triggerFileUpload()">
                <i class="fas fa-upload"></i> Upload Files
              </button>
            </div>
          </div>

          <input type="file" id="fileInput" multiple hidden onchange="handleFileSelect(event)">
          <input type="file" id="folderInput" multiple webkitdirectory directory hidden onchange="handleFolderSelect(event)">

          <div class="docs-layout">
            <aside class="docs-sidebar" aria-label="Document folders">
              <div class="docs-sidebar-title">Folders</div>
              <div id="docsFoldersList" class="docs-folder-list"></div>
            </aside>

            <div class="docs-main">
              <div id="docsBreadcrumb" class="docs-breadcrumb"></div>

              <!-- Upload Zone -->
              <div class="upload-zone" id="uploadZone" onclick="triggerFileUpload()">
                <i class="fas fa-cloud-upload-alt"></i>
                <div class="upload-text">Drop files here or click to upload</div>
                <div class="upload-hint">PDF, DOC, XLS, images up to 50MB • Uploads into the selected folder</div>
              </div>

              <div id="documentsGrid" class="documents-grid"></div>

              <!-- Document Detail (preview + AI chat) -->
              <div class="doc-detail" id="docDetail" style="display:none">
                <div class="doc-detail-header">
                  <div class="doc-detail-title" id="docDetailTitle">Document</div>
                  <div class="doc-detail-actions">
                    <button class="btn btn-sm btn-outline" type="button" onclick="downloadSelectedDocument()" title="Download">
                      <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline" type="button" onclick="moveSelectedDocument()" title="Move">
                      <i class="fas fa-folder-open"></i>
                    </button>
                    <button class="btn btn-sm btn-outline" type="button" onclick="deleteSelectedDocument()" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline" type="button" onclick="closeDocumentDetail()" title="Close">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <div class="doc-preview" id="docPreview"></div>
                <div class="doc-chat">
                  <div class="doc-chat-messages" id="docChatMessages"></div>
                  <div class="doc-chat-input">
                    <input id="docChatInput" class="form-input" placeholder="Ask about this document (summarise, key terms, dates, issues)…" onkeydown="if(event.key==='Enter'){askSelectedDocument();}">
                    <button class="btn btn-vericase" type="button" onclick="askSelectedDocument()">
                      <i class="fas fa-paper-plane"></i> Send
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- About Panel -->
      <div class="tab-panel" id="panel-about">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-circle-info" aria-hidden="true"></i>
              About
            </div>
            <div class="section-actions">
              <button class="btn btn-sm btn-outline" onclick="refreshWorkspaceAbout(true)" title="Refresh (deep read-in by default)">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>

          <div class="about-grid">
            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-bolt" aria-hidden="true"></i>
                AI Brief (auto-updates as documents arrive)
              </div>
              <div class="about-card-body about-markdown" id="aboutSummary">Upload a document in this workspace to start building the dispute context.</div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-file-signature" aria-hidden="true"></i>
                Contracts & key terms (from uploaded contract documents)
              </div>
              <div class="about-card-body">
                <div class="about-contract-grid">
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-folder-open" aria-hidden="true"></i>
                      Uploaded contract documents
                    </div>
                    <div class="about-contract-list" id="aboutContractDocs"></div>
                  </div>
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-balance-scale" aria-hidden="true"></i>
                      Key terms (extracted)
                    </div>
                    <div class="about-pre" id="aboutContractTerms"></div>
                  </div>
                </div>
                <div class="about-hint" id="aboutContractsHint"></div>
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-diagram-project" aria-hidden="true"></i>
                Structured dispute intelligence (auto-built)
              </div>
              <div class="about-card-body">
                <div class="about-contract-grid">
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-gauge-high" aria-hidden="true"></i>
                      At a glance
                    </div>
                    <div class="about-pre" id="aboutAtAGlance"></div>
                  </div>
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-users" aria-hidden="true"></i>
                      Parties & roles
                    </div>
                    <div class="about-pre" id="aboutPartiesRoles"></div>
                  </div>
                </div>
                <div class="about-hint"></div>
                <div class="about-contract-grid">
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
                      Issues (what matters)
                    </div>
                    <div class="about-pre" id="aboutIssues"></div>
                  </div>
                  <div>
                    <div class="about-subtitle">
                      <i class="fas fa-list-check" aria-hidden="true"></i>
                      Next actions
                    </div>
                    <div class="about-pre" id="aboutNextActions"></div>
                  </div>
                </div>
                <div class="about-hint" id="aboutStructuredHint"></div>
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-sitemap" aria-hidden="true"></i>
                Evidence map (what we have, and why it matters)
              </div>
              <div class="about-card-body">
                <div id="aboutEvidenceMap"></div>
                <div class="about-hint" id="aboutEvidenceMapHint"></div>
              </div>
            </div>

            <div class="about-card">
              <div class="about-card-title">
                <i class="fas fa-question-circle" aria-hidden="true"></i>
                Open questions (gaps to close)
              </div>
              <div class="about-card-body">
                <ul class="about-list" id="aboutOpenQuestions"></ul>
                <div class="about-hint" id="aboutOpenQuestionsHint"></div>
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-comments" aria-hidden="true"></i>
                Ask the Workspace (Q&A across workspace + related projects/cases)
              </div>
              <div class="about-card-body">
                <div class="about-qa-row">
                  <input class="form-input" id="aboutQuestionInput" placeholder="Ask: what is the dispute about? what are the key issues? what evidence do we have?">
                  <button class="btn btn-vericase" id="aboutAskBtn" onclick="askWorkspaceAbout()">
                    <i class="fas fa-paper-plane"></i> Ask
                  </button>
                </div>
                <div class="about-chat" id="aboutChat"></div>
                <div class="about-hint" id="aboutChatHint"></div>
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-chalkboard-teacher" aria-hidden="true"></i>
                Teach the system (facts & framing)
              </div>
              <div class="about-card-body">
                <textarea class="form-input about-notes-textarea" id="aboutUserNotes" placeholder="Add authoritative facts, agreed issues, parties/roles, or dispute framing. This guides AI outputs and reduces read-in for counsel."></textarea>
                <div class="about-actions-row">
                  <button class="btn btn-outline" onclick="loadWorkspaceAbout()">Reset</button>
                  <button class="btn btn-vericase" onclick="saveWorkspaceAboutNotes()">
                    <i class="fas fa-save"></i> Save notes
                  </button>
                </div>
                <div class="about-hint" id="aboutNotesHint"></div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Purpose Panel -->
      <div class="tab-panel" id="panel-purpose">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-bullseye" aria-hidden="true"></i>
              Purpose
            </div>
            <div class="section-actions">
              <button class="btn btn-sm btn-outline" onclick="refreshWorkspacePurpose(true)" title="Refresh (deep purpose analysis by default)">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>

          <div class="about-grid">
            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-flag" aria-hidden="true"></i>
                Purpose baseline
              </div>
              <div class="about-card-body">
                <textarea class="form-input about-notes-textarea" id="purposeTextInput" placeholder="Define the workspace goal or instruction baseline (e.g., identify/design responsibility, chronology, contradictions, issue groupings)."></textarea>
                <div class="about-actions-row">
                  <button class="btn btn-outline" onclick="loadWorkspacePurpose()">Reset</button>
                  <button class="btn btn-vericase" onclick="saveWorkspacePurposeConfig()">
                    <i class="fas fa-save"></i> Save baseline
                  </button>
                </div>
              </div>
            </div>

            <div class="about-card">
              <div class="about-card-title">
                <i class="fas fa-file-signature" aria-hidden="true"></i>
                Instruction document
              </div>
              <div class="about-card-body">
                <select class="form-select" id="purposeInstructionSelect" onchange="saveWorkspacePurposeConfig(false)"></select>
                <div class="about-actions-row">
                  <button class="btn btn-sm btn-outline" type="button" onclick="triggerPurposeInstructionUpload()">
                    <i class="fas fa-upload"></i> Upload instruction
                  </button>
                </div>
                <div class="hub-subtext" id="purposeInstructionHint">Select or upload the instruction narrative PDF that defines what the workspace must achieve.</div>
                <input type="file" id="purposeInstructionInput" hidden onchange="handlePurposeInstructionSelect(event)">
              </div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-bolt" aria-hidden="true"></i>
                Purpose brief (auto-updates against baseline + evidence)
              </div>
              <div class="about-card-body about-pre" id="purposeSummary">Define a purpose baseline to generate a tracked deliverables plan.</div>
            </div>

            <div class="about-card">
              <div class="about-card-title">
                <i class="fas fa-tasks" aria-hidden="true"></i>
                Deliverables & progress
              </div>
              <div class="about-card-body about-pre" id="purposeDeliverables"></div>
            </div>

            <div class="about-card">
              <div class="about-card-title">
                <i class="fas fa-clock" aria-hidden="true"></i>
                Chronology
              </div>
              <div class="about-card-body about-pre" id="purposeChronology"></div>
            </div>

            <div class="about-card">
              <div class="about-card-title">
                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                Contradictions & inconsistencies
              </div>
              <div class="about-card-body about-pre" id="purposeContradictions"></div>
            </div>

            <div class="about-card about-span-2">
              <div class="about-card-title">
                <i class="fas fa-sitemap" aria-hidden="true"></i>
                Evidence organisation (issue groupings & keywords)
              </div>
              <div class="about-card-body about-pre" id="purposeEvidenceOrganisation"></div>
            </div>
          </div>

          <div class="about-qa">
            <div class="about-qa-title">
              <i class="fas fa-message" aria-hidden="true"></i>
              Ask about the purpose baseline
            </div>
            <div class="about-chat" id="purposeChat">
              <div class="msg ai">Ask about progress, deliverables, missing evidence, or contradictions.</div>
            </div>
            <div class="about-qa-row">
              <input class="form-input" id="purposeQuestionInput" placeholder="Ask: which deliverables are still missing evidence? what contradictions exist?">
              <button class="btn btn-vericase" id="purposeAskBtn" onclick="askWorkspacePurpose()">
                <i class="fas fa-paper-plane"></i> Ask
              </button>
            </div>
            <div class="about-qa-hint" id="purposeChatHint"></div>
          </div>
        </section>
      </div>

      <!-- Team Panel -->
      <div class="tab-panel" id="panel-team">
        <section class="hub-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-id-badge" aria-hidden="true"></i>
              Team Members
            </div>
            <div class="section-actions">
              <button class="btn btn-sm btn-vericase" onclick="showAddMemberModal()">
                <i class="fas fa-user-plus"></i> Add Member
              </button>
            </div>
          </div>
          
          <div id="teamGrid" class="team-grid"></div>
        </section>
      </div>

      <!-- Collaboration Panel -->
      <div class="tab-panel" id="panel-collaboration">
        <!-- Workspace Notes -->
        <div class="collab-section">
          <div class="collab-section-header">
            <h4><i class="fas fa-sticky-note"></i> Workspace Notes</h4>
          </div>
          <div class="collab-section-body">
            <div id="notesList" class="notes-list"></div>
            <div class="note-input-wrapper">
              <textarea id="newNoteInput" placeholder="Add a note for your team..."></textarea>
              <button class="btn btn-vericase" onclick="addNote()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Activity Feed -->
        <div class="collab-section">
          <div class="collab-section-header">
            <h4><i class="fas fa-stream"></i> Recent Activity</h4>
          </div>
          <div class="collab-section-body">
            <div id="activityFeed" class="activity-feed"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Navigation -->
    <div class="back-section">
      <a href="workspace-hub.html" class="back-link">
        <i class="fas fa-arrow-left" aria-hidden="true"></i>
        Back to Workspaces
      </a>
    </div>
  </div>

  <!-- Add Modal -->
  <div class="modal-overlay" id="addModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add to Workspace</h3>
        <button class="modal-close" onclick="hideAddModal()">&times;</button>
      </div>
      <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px;">
        <a href="#" id="addProjectLink" class="btn btn-lg btn-outline" style="justify-content: flex-start; gap: 16px; padding: 20px;">
          <i class="fas fa-project-diagram" style="font-size: 1.25rem; color: #2f86c8;"></i>
          <div style="text-align: left;">
            <div style="font-weight: 600;">Add Project</div>
            <div style="font-size: 0.8125rem; color: var(--text-muted); font-weight: 400;">A construction or engineering project</div>
          </div>
        </a>
        <a href="#" id="addCaseLink" class="btn btn-lg btn-outline" style="justify-content: flex-start; gap: 16px; padding: 20px;">
          <i class="fas fa-briefcase" style="font-size: 1.25rem; color: var(--vericase-gold);"></i>
          <div style="text-align: left;">
            <div style="font-weight: 600;">Add Case</div>
            <div style="font-size: 0.8125rem; color: var(--text-muted); font-weight: 400;">A dispute or legal matter</div>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Add Member Modal -->
  <div class="modal-overlay" id="addMemberModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add Team Member</h3>
        <button class="modal-close" onclick="hideAddMemberModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Existing User Email</label>
          <input type="email" class="form-input" id="memberEmail" placeholder="colleague@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Role</label>
          <select class="form-select" id="memberRole">
            <option value="member">Member</option>
            <option value="editor">Editor</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="hideAddMemberModal()">Cancel</button>
        <button class="btn btn-vericase" onclick="addMember()">
          <i class="fas fa-user-plus"></i> Add Member
        </button>
      </div>
    </div>
  </div>

  <!-- Move Document Modal -->
  <div class="modal-overlay" id="moveDocModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-folder-open"></i> Move Document</h3>
        <button class="modal-close" onclick="hideMoveDocumentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Document</label>
          <div class="form-input" id="moveDocName" style="background: var(--gray-50); border-color: var(--gray-200);"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Move to existing folder</label>
          <select class="form-select" id="moveDocFolderSelect"></select>
          <div class="about-hint" style="margin-top:6px;">Choose an existing folder (or Unfiled).</div>
        </div>

        <div class="form-group">
          <label class="form-label">Or create a new folder</label>
          <div style="display:flex; gap:8px;">
            <input class="form-input" id="moveDocNewFolder" placeholder="e.g. Contracts/JCT or Expert Reports/Quantum" />
            <button class="btn btn-outline" type="button" onclick="createFolderFromMoveModal()">
              <i class="fas fa-folder-plus"></i>
            </button>
          </div>
          <div class="about-hint" id="moveDocCreateHint" style="margin-top:6px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" type="button" onclick="hideMoveDocumentModal()">Cancel</button>
        <button class="btn btn-vericase" type="button" onclick="confirmMoveDocument()">
          <i class="fas fa-arrow-right"></i> Move
        </button>
      </div>
    </div>
  </div>

  <script>
    // Get workspace ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const workspaceId = urlParams.get("workspaceId");
    const isDirectoryMode = !workspaceId;

    // Workspace directory state (directory mode only)
    let directoryWorkspaces = [];
    const directoryUi = {
      query: "",
      status: "all",
      sort: "recent",
    };
    const _countFmt = new Intl.NumberFormat(undefined);
    function formatCount(value) {
      const n = Number(value);
      return Number.isFinite(n) ? _countFmt.format(n) : "0";
    }

    // Workspace data
    let workspaceData = null;
    let workspaceDeadlines = [];
    let workspaceDocuments = [];
    let workspaceDocumentFolders = [];
    let currentDocumentsFolder = ""; // "" = all documents, "__unfiled__" = unfiled
    let selectedWorkspaceDocId = null;
    let moveDocModalId = null;
    let workspaceTeam = [];
    let workspaceNotes = [];
    let workspaceActivity = [];

    // About (AI workspace context + Q&A)
    let workspaceAbout = null;
    let aboutPollHandle = null;

    // Purpose (baseline instructions + tracking)
    let workspacePurpose = null;
    let purposePollHandle = null;
    let purposeAuthRedirected = false;

    // Auth helpers
    function getAuthHeaders() {
      const token =
        localStorage.getItem("vericase_token") ||
        localStorage.getItem("token") ||
        localStorage.getItem("jwt") ||
        localStorage.getItem("auth_token");
      return token ? { Authorization: `Bearer ${token}`, "Content-Type": "application/json" } : { "Content-Type": "application/json" };
    }

    function handleAuthFailure(res) {
      if (res && (res.status === 401 || res.status === 403)) {
        if (!purposeAuthRedirected) {
          purposeAuthRedirected = true;
          VericaseUI.Toast.error("Session expired. Please sign in again.");
          setTimeout(() => {
            window.location.href = "login.html";
          }, 800);
        }
        return true;
      }
      return false;
    }

    async function parseApiError(res) {
      let detail = "";
      let payload = null;
      const contentType = res?.headers?.get("content-type") || "";
      if (contentType.includes("application/json")) {
        payload = await res.json().catch(() => null);
        if (payload) {
          if (typeof payload.detail === "string") {
            detail = payload.detail;
          } else if (typeof payload.message === "string") {
            detail = payload.message;
          } else {
            try {
              detail = JSON.stringify(payload);
            } catch {
              detail = "";
            }
          }
        }
      } else {
        detail = await res.text().catch(() => "");
      }
      return { detail, payload };
    }

    // Tab switching
    function switchTab(tabId) {
      document.querySelectorAll('.hub-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
      });
      
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `panel-${tabId}`);
      });
    }

    function setDirectoryMode(enabled) {
      const directory = document.getElementById("directoryView");
      if (directory) directory.classList.toggle("hidden", !enabled);

      const workspaceOnlySelectors = [
        ".hub-breadcrumb",
        "#workspaceHeader",
        "#statsBar",
        "#hubTabs",
        ".tab-panels",
        ".back-section",
      ];

      workspaceOnlySelectors.forEach((selector) => {
        const el = document.querySelector(selector);
        if (el) el.classList.toggle("hidden", enabled);
      });
    }

    // Initialize page
	    document.addEventListener("DOMContentLoaded", async () => {
	      if (window.VericaseShell?.inject) {
	        let cachedWorkspaceName = "Workspace";
	        try {
	          const storedId = (localStorage.getItem("currentWorkspaceId") || "").trim();
	          const storedName = (localStorage.getItem("currentWorkspaceName") || "").trim();
	          if (storedId && storedId === String(workspaceId || "").trim() && storedName) {
	            cachedWorkspaceName = storedName;
	          }
	        } catch { /* ignore */ }
	        VericaseShell.inject(
	          isDirectoryMode
	            ? {
	                title: "",
	                breadcrumbs: [
	                  { label: "Control Centre", url: "control-centre.html", icon: "fa-compass" },
	                  { label: "Workspaces", icon: "fa-layer-group" },
	                ],
	                headerActions: "",
	              }
	            : {
	                title: "",
	                breadcrumbs: [
	                  { label: "Control Centre", url: "control-centre.html", icon: "fa-compass" },
	                  { label: "Workspaces", url: "workspace-hub.html", icon: "fa-layer-group" },
	                  { label: cachedWorkspaceName, icon: "fa-building" },
	                ],
	                headerActions: "",
	              },
	        );
	      }

      if (isDirectoryMode) {
        setDirectoryMode(true);
        initWorkspacesDirectoryUi();
        await loadWorkspacesDirectory();
        return;
      }

      setDirectoryMode(false);

      // Set up links
      document.getElementById("configureBtn").href = `workspace-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
      document.getElementById("addProjectBtn").href = `project-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
      document.getElementById("addCaseBtn").href = `case-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
      document.getElementById("addProjectLink").href = `project-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;
      document.getElementById("addCaseLink").href = `case-setup.html?workspaceId=${encodeURIComponent(workspaceId)}`;

      // Setup drag and drop for documents
      setupDragAndDrop();

      // Load workspace data
      await loadWorkspace();
    });

    function setDirectoryMeta({ total, shown, loading = false }) {
      const meta = document.getElementById("workspaceDirectoryMeta");
      const pill = document.getElementById("workspacesCountPill");

      if (loading) {
        if (meta) meta.textContent = "Loading workspaces…";
        if (pill) pill.textContent = "";
        return;
      }

      const totalText = formatCount(total);
      const shownText = formatCount(shown);

      if (meta) {
        meta.textContent =
          total === shown
            ? `${totalText} workspaces`
            : `Showing ${shownText} of ${totalText} workspaces`;
      }
      if (pill) pill.textContent = totalText;
    }

    function initWorkspacesDirectoryUi() {
      const search = document.getElementById("workspaceSearch");
      const clearBtn = document.getElementById("workspaceSearchClear");
      const status = document.getElementById("workspaceStatusFilter");
      const sort = document.getElementById("workspaceSort");

      if (!search || !status || !sort) return;

      function syncClear() {
        if (!clearBtn) return;
        clearBtn.hidden = !search.value.trim();
      }

      function updateAndRender() {
        directoryUi.query = (search.value || "").trim().toLowerCase();
        directoryUi.status = (status.value || "all").toLowerCase();
        directoryUi.sort = (sort.value || "recent").toLowerCase();
        syncClear();
        applyDirectoryFiltersAndRender();
      }

      search.addEventListener("input", updateAndRender);
      status.addEventListener("change", updateAndRender);
      sort.addEventListener("change", updateAndRender);

      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          search.value = "";
          updateAndRender();
          search.focus();
        });
      }

      syncClear();
      setDirectoryMeta({ total: 0, shown: 0, loading: true });
    }

    function renderWorkspacesDirectoryLoading() {
      const grid = document.getElementById("workspacesGrid");
      if (!grid) return;
      setDirectoryMeta({ total: 0, shown: 0, loading: true });

      const card = `
        <div class="item-card workspace-card workspace-card--skeleton" aria-hidden="true">
          <div class="workspace-card-skel-top">
            <div class="skeleton sk-icon"></div>
            <div class="workspace-card-skel-lines">
              <div class="skeleton sk-line sk-line--title"></div>
              <div class="skeleton sk-line sk-line--meta"></div>
            </div>
            <div class="skeleton sk-pill"></div>
          </div>
          <div class="workspace-card-skel-stats">
            <div class="skeleton sk-stat"></div>
            <div class="skeleton sk-stat"></div>
            <div class="skeleton sk-stat"></div>
            <div class="skeleton sk-stat"></div>
          </div>
        </div>
      `;

      grid.innerHTML = Array.from({ length: 8 }).map(() => card).join("");
    }

    function normalizeWorkspaceStatus(ws) {
      const raw = (ws?.status || "active").toString().toLowerCase();
      if (raw === "archived" || raw === "closed") return "archived";
      if (raw === "inactive") return "inactive";
      return "active";
    }

    function workspaceSearchHaystack(ws) {
      return [
        ws?.name,
        ws?.code,
        ws?.contract_type,
        ws?.id,
      ]
        .filter(Boolean)
        .join(" ")
        .toLowerCase();
    }

    function getWorkspaceSortTime(ws) {
      const raw =
        ws?.updated_at ||
        ws?.last_activity_at ||
        ws?.lastActivityAt ||
        ws?.created_at ||
        ws?.createdAt ||
        ws?.updatedAt;
      const d = raw ? new Date(raw) : null;
      const t = d && !Number.isNaN(d.getTime()) ? d.getTime() : 0;
      return t;
    }

    function sortWorkspaces(list) {
      const sort = directoryUi.sort;
      const arr = [...list];

      if (sort === "name-asc") {
        arr.sort((a, b) =>
          (a?.name || "").localeCompare(b?.name || "", undefined, { sensitivity: "base" })
        );
        return arr;
      }
      if (sort === "name-desc") {
        arr.sort((a, b) =>
          (b?.name || "").localeCompare(a?.name || "", undefined, { sensitivity: "base" })
        );
        return arr;
      }

      // default: recent
      arr.sort((a, b) => getWorkspaceSortTime(b) - getWorkspaceSortTime(a));
      return arr;
    }

    function applyDirectoryFiltersAndRender() {
      const all = Array.isArray(directoryWorkspaces) ? directoryWorkspaces : [];
      let filtered = all;

      if (directoryUi.status && directoryUi.status !== "all") {
        filtered = filtered.filter((ws) => normalizeWorkspaceStatus(ws) === directoryUi.status);
      }

      if (directoryUi.query) {
        const q = directoryUi.query;
        filtered = filtered.filter((ws) => workspaceSearchHaystack(ws).includes(q));
      }

      filtered = sortWorkspaces(filtered);
      setDirectoryMeta({ total: all.length, shown: filtered.length, loading: false });

      const grid = document.getElementById("workspacesGrid");
      if (grid && all.length > 0 && filtered.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-search empty-icon"></i>
            <div class="empty-title">No matching workspaces</div>
            <div class="empty-desc">Try a different search term or clear filters.</div>
            <button type="button" class="btn btn-outline" id="clearDirectoryFiltersBtn">
              <i class="fas fa-xmark"></i> Clear filters
            </button>
          </div>
        `;

        const btn = document.getElementById("clearDirectoryFiltersBtn");
        btn?.addEventListener("click", () => {
          const search = document.getElementById("workspaceSearch");
          const status = document.getElementById("workspaceStatusFilter");
          const sort = document.getElementById("workspaceSort");
          const clearBtn = document.getElementById("workspaceSearchClear");

          if (search) search.value = "";
          if (status) status.value = "all";
          if (sort) sort.value = "recent";
          if (clearBtn) clearBtn.hidden = true;

          directoryUi.query = "";
          directoryUi.status = "all";
          directoryUi.sort = "recent";
          applyDirectoryFiltersAndRender();
          search?.focus();
        });
        return;
      }

      renderWorkspacesDirectory(filtered);
    }

    async function loadWorkspacesDirectory() {
      try {
        renderWorkspacesDirectoryLoading();
        const response = await fetch("/api/workspaces", { headers: getAuthHeaders() });
        if (!response.ok) throw new Error("Failed to load workspaces");
        const workspaces = await response.json();
        directoryWorkspaces = Array.isArray(workspaces) ? workspaces : [];
        applyDirectoryFiltersAndRender();
      } catch (err) {
        console.error("Failed to load workspaces directory:", err);
        VericaseUI.Toast.error("Failed to load workspaces");
        setDirectoryMeta({ total: 0, shown: 0, loading: false });
        const grid = document.getElementById("workspacesGrid");
        if (grid) {
          grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
              <i class="fas fa-triangle-exclamation empty-icon"></i>
              <div class="empty-title">Unable to load workspaces</div>
              <div class="empty-desc">Please refresh the page or try again in a moment.</div>
              <button type="button" class="btn btn-outline" onclick="loadWorkspacesDirectory()">
                <i class="fas fa-rotate-right"></i> Retry
              </button>
            </div>
          `;
        }
      }
    }

    function renderWorkspacesDirectory(workspaces) {
      const grid = document.getElementById("workspacesGrid");
      if (!grid) return;

      const list = Array.isArray(workspaces) ? workspaces : [];
      if (list.length === 0) {
        setDirectoryMeta({ total: 0, shown: 0, loading: false });
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-layer-group empty-icon"></i>
            <div class="empty-title">No Workspaces Yet</div>
            <div class="empty-desc">Create a workspace to group projects, cases, documents, and your team.</div>
            <a href="workspace-setup.html" class="btn btn-vericase">
              <i class="fas fa-plus"></i> Create Workspace
            </a>
          </div>
        `;
        return;
      }

      grid.innerHTML = list
        .map((ws) => {
          const projects = Array.isArray(ws.projects) ? ws.projects : [];
          const cases = Array.isArray(ws.cases) ? ws.cases : [];

          const projectPreview = projects.length
            ? projects
                .slice(0, 2)
                .map(
                  (p) =>
                    `<div class="workspace-preview-item" title="${escapeHtml(p.name || "")}">${escapeHtml(p.name || "Untitled project")}</div>`,
                )
                .join("")
            : `<div class="workspace-preview-empty">No projects yet</div>`;

          const casePreview = cases.length
            ? cases
                .slice(0, 2)
                .map(
                  (c) =>
                    `<div class="workspace-preview-item" title="${escapeHtml(c.name || "")}">${escapeHtml(c.name || "Untitled case")}</div>`,
                )
                .join("")
            : `<div class="workspace-preview-empty">No cases yet</div>`;

          const status = normalizeWorkspaceStatus(ws);
          const statusClass = status === "archived" ? "closed" : status === "inactive" ? "pending" : "";
          const displayStatus = status === "archived" ? "Archived" : status === "inactive" ? "Inactive" : "Active";

          const codeLine = [
            ws.code ? escapeHtml(ws.code) : "",
            ws.contract_type ? escapeHtml(ws.contract_type) : "",
          ]
            .filter(Boolean)
            .join(" • ");

          return `
            <div class="item-card workspace-card" data-workspace-id="${escapeHtml(ws.id)}" tabindex="0" role="button" aria-label="Open workspace ${escapeHtml(ws.name || "Workspace")}">
              <div class="item-card-header">
                <div class="item-icon workspace"><i class="fas fa-building"></i></div>
                <span class="item-status ${statusClass}">${displayStatus}</span>
              </div>
              <div class="item-content">
                <div class="item-title">${escapeHtml(ws.name || "Untitled workspace")}</div>
                <div class="item-code" title="${codeLine}">${codeLine}</div>
              </div>
              <div class="item-stats">
                <div class="item-stat"><i class="fas fa-project-diagram"></i> <strong>${formatCount(ws.project_count || 0)}</strong> projects</div>
                <div class="item-stat"><i class="fas fa-briefcase"></i> <strong>${formatCount(ws.case_count || 0)}</strong> cases</div>
                <div class="item-stat"><i class="fas fa-envelope"></i> <strong>${formatCount(ws.email_count || 0)}</strong> emails</div>
                <div class="item-stat"><i class="fas fa-file-alt"></i> <strong>${formatCount(ws.evidence_count || 0)}</strong> files</div>
              </div>
              <div class="workspace-preview">
                <div>
                  <div class="workspace-preview-title">Projects</div>
                  <div class="workspace-preview-list">${projectPreview}</div>
                </div>
                <div>
                  <div class="workspace-preview-title">Cases</div>
                  <div class="workspace-preview-list">${casePreview}</div>
                </div>
              </div>
              <div class="card-actions">
                <button type="button" class="card-action-btn primary" data-action="open"><i class="fas fa-arrow-right"></i> Open</button>
                <button type="button" class="card-action-btn" data-action="configure"><i class="fas fa-cog"></i> Configure</button>
              </div>
            </div>
          `;
        })
        .join("");

      grid.onclick = handleWorkspaceDirectoryClick;
      grid.onkeydown = handleWorkspaceDirectoryKeydown;
    }

    function handleWorkspaceDirectoryKeydown(e) {
      if (e.key !== "Enter" && e.key !== " ") return;
      const card = e.target.closest("[data-workspace-id]");
      if (!card) return;
      // If focus is already on an inner action button, let that button handle the key press.
      if (e.target.closest("[data-action]")) return;
      e.preventDefault();
      const id = card.dataset.workspaceId;
      window.location.href = `workspace-hub.html?workspaceId=${encodeURIComponent(id)}`;
    }

    function handleWorkspaceDirectoryClick(e) {
      const card = e.target.closest("[data-workspace-id]");
      if (!card) return;
      const id = card.dataset.workspaceId;
      const action = e.target.closest("[data-action]")?.dataset.action;

      if (action === "configure") {
        window.location.href = `workspace-setup.html?workspaceId=${encodeURIComponent(id)}`;
        return;
      }

      window.location.href = `workspace-hub.html?workspaceId=${encodeURIComponent(id)}`;
    }

    async function loadWorkspace() {
      try {
        const response = await fetch(`/api/workspaces/${workspaceId}`, { headers: getAuthHeaders() });
        if (!response.ok) throw new Error("Failed to load workspace");

        workspaceData = await response.json();

        try {
          localStorage.setItem("currentWorkspaceId", workspaceId);
          localStorage.setItem("currentWorkspaceName", workspaceData.name || "Workspace");
        } catch { /* ignore */ }

        // Extract data
        workspaceDeadlines = workspaceData.deadlines || [];
        workspaceDocuments = workspaceData.documents || [];
        workspaceDocumentFolders = [];
        currentDocumentsFolder = "";
        selectedWorkspaceDocId = null;
        workspaceTeam = workspaceData.team_members || workspaceData.users || workspaceData.team || [];
        workspaceNotes = workspaceData.notes || [];
        workspaceActivity = workspaceData.activity || [];

        // Aggregate deadlines from cases too
        const cases = workspaceData.cases || [];
        cases.forEach(c => {
          if (Array.isArray(c.deadlines)) {
            c.deadlines.forEach(d => {
              workspaceDeadlines.push({
                ...d,
                source: c.name || c.case_name || 'Case',
                source_type: 'case',
                source_id: c.id
              });
            });
          }
        });

        renderAll();

        if (window.VericaseShell?.inject) {
          VericaseShell.inject({
            title: workspaceData.name,
            breadcrumbs: [
              { label: "Control Centre", url: "control-centre.html" },
              { label: "Workspaces", url: "workspace-hub.html" },
              { label: workspaceData.name || "Workspace" }
            ],
            headerActions: ""
          });
        }

        // Load AI context ("About" tab) in the background (deep by default)
        refreshWorkspaceAbout(true).catch(() => {});
        // Load Purpose baseline + tracking (deep by default)
        refreshWorkspacePurpose(true).catch(() => {});
        // Load full workspace documents list (best-effort; workspace payload is capped)
        loadWorkspaceDocuments().catch(() => {});
        // Load folder tree (best-effort)
        loadWorkspaceDocumentFolders().catch(() => {});

      } catch (err) {
        console.error("Failed to load workspace:", err);
        VericaseUI.Toast.error("Failed to load workspace");
      }
    }

    function renderAll() {
      renderHeader();
      renderStats();
      renderProjects();
      renderCases();
      renderDeadlines();
      renderDocuments();
      renderTeam();
      renderNotes();
      renderActivity();
      updateTabCounts();
    }

    function renderHeader() {
      const workspaceName = workspaceData?.name || "Unnamed Workspace";
      document.getElementById("workspaceName").textContent = workspaceName;
      document.getElementById("workspaceCode").textContent = workspaceData?.code || "---";
      if (workspaceData?.contract_type) {
        document.getElementById("workspaceContractType").textContent = `• ${workspaceData.contract_type}`;
      }
      // Update breadcrumb
      const breadcrumbEl = document.getElementById("breadcrumbWorkspaceName");
      if (breadcrumbEl) {
        breadcrumbEl.textContent = workspaceName;
      }
    }

    function renderStats() {
      const statsBar = document.getElementById("statsBar");
      const projects = workspaceData?.projects?.length || 0;
      const cases = workspaceData?.cases?.length || 0;
      const deadlines = workspaceDeadlines.length;
      const docs = workspaceDocuments.length;
      const team = workspaceTeam.length;

      statsBar.innerHTML = `
        <div class="stat-pill projects"><i class="fas fa-project-diagram"></i> <strong>${projects}</strong> Projects</div>
        <div class="stat-pill cases"><i class="fas fa-briefcase"></i> <strong>${cases}</strong> Cases</div>
        <div class="stat-pill deadlines"><i class="fas fa-calendar-alt"></i> <strong>${deadlines}</strong> Deadlines</div>
        <div class="stat-pill documents"><i class="fas fa-folder-open"></i> <strong>${docs}</strong> Documents</div>
        <div class="stat-pill members"><i class="fas fa-id-badge"></i> <strong>${team}</strong> Members</div>
      `;
    }

    function updateTabCounts() {
      const projects = workspaceData?.projects?.length || 0;
      const cases = workspaceData?.cases?.length || 0;
      document.getElementById("projectsCasesCount").textContent = projects + cases;
      document.getElementById("projectCount").textContent = projects;
      document.getElementById("caseCount").textContent = cases;
      document.getElementById("deadlinesCount").textContent = workspaceDeadlines.length;
      document.getElementById("documentsCount").textContent = workspaceDocuments.length;
      document.getElementById("teamCount").textContent = workspaceTeam.length;

      // About status: show open questions count
      const aboutEl = document.getElementById("aboutCount");
      if (aboutEl) {
        const openQuestions = Array.isArray(workspaceAbout?.open_questions)
          ? workspaceAbout.open_questions.length
          : 0;
        aboutEl.textContent = String(openQuestions);
      }

      // Purpose status: show deliverables count
      const purposeEl = document.getElementById("purposeCount");
      if (purposeEl) {
        const deliverables = Array.isArray(workspacePurpose?.data?.baseline?.deliverables)
          ? workspacePurpose.data.baseline.deliverables.length
          : 0;
        purposeEl.textContent = String(deliverables);
      }
    }

    function renderProjects() {
      const grid = document.getElementById("projectsGrid");
      const projects = workspaceData?.projects || [];

      if (projects.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-project-diagram empty-icon"></i>
            <div class="empty-title">No Projects Yet</div>
            <div class="empty-desc">Create your first project to manage timelines, emails, and evidence.</div>
            <a href="project-setup.html?workspaceId=${encodeURIComponent(workspaceId)}" class="btn btn-vericase">
              <i class="fas fa-plus"></i> Add Project
            </a>
          </div>
        `;
        return;
      }

      grid.innerHTML = projects.map(p => `
        <div class="item-card" data-project-id="${p.id}">
          <div class="item-card-header">
            <div class="item-icon project"><i class="fas fa-project-diagram"></i></div>
            <span class="item-status">${p.status || 'Active'}</span>
          </div>
          <div class="item-content">
            <div class="item-title">${escapeHtml(p.name || p.project_name || 'Untitled')}</div>
            <div class="item-code">${escapeHtml(p.code || p.project_code || '')}</div>
          </div>
          <div class="item-stats">
            <div class="item-stat"><i class="fas fa-envelope"></i> <strong>${p.email_count || 0}</strong> emails</div>
            <div class="item-stat"><i class="fas fa-file-alt"></i> <strong>${p.evidence_count || 0}</strong> files</div>
            </div>
          <div class="card-actions">
            <button class="card-action-btn" data-action="configure"><i class="fas fa-cog"></i> Configure</button>
            <button class="card-action-btn primary" data-action="develop-case"><i class="fas fa-gavel"></i> Develop Case</button>
            <button class="card-action-btn" data-action="open"><i class="fas fa-arrow-right"></i> Open</button>
            </div>
        </div>
      `).join('');

      grid.onclick = handleProjectClick;
    }

    function renderCases() {
      const grid = document.getElementById("casesGrid");
      const cases = workspaceData?.cases || [];

      if (cases.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-briefcase empty-icon"></i>
            <div class="empty-title">No Cases Yet</div>
            <div class="empty-desc">Create a case to track disputes and legal matters.</div>
            <a href="case-setup.html?workspaceId=${encodeURIComponent(workspaceId)}" class="btn btn-vericase">
              <i class="fas fa-plus"></i> Add Case
            </a>
          </div>
        `;
        return;
      }

      grid.innerHTML = cases.map(c => `
        <div class="item-card" data-case-id="${c.id}">
          <div class="item-card-header">
            <div class="item-icon case"><i class="fas fa-briefcase"></i></div>
            <span class="item-status">${c.status || 'Active'}</span>
          </div>
          <div class="item-content">
            <div class="item-title">${escapeHtml(c.name || c.case_name || 'Untitled')}</div>
            <div class="item-code">${escapeHtml(c.case_number || '')}</div>
          </div>
          <div class="item-stats">
            <div class="item-stat"><i class="fas fa-envelope"></i> <strong>${c.email_count || 0}</strong> emails</div>
            <div class="item-stat"><i class="fas fa-file-alt"></i> <strong>${c.evidence_count || 0}</strong> files</div>
            </div>
          <div class="card-actions">
            <button class="card-action-btn" data-action="configure"><i class="fas fa-cog"></i> Configure</button>
            <button class="card-action-btn primary" data-action="open"><i class="fas fa-arrow-right"></i> Open</button>
            </div>
        </div>
      `).join('');

      grid.onclick = handleCaseClick;
    }

    function handleProjectClick(e) {
      const card = e.target.closest('[data-project-id]');
      if (!card) return;
      const id = card.dataset.projectId;
      const action = e.target.closest('[data-action]')?.dataset.action;
      
      if (action === 'configure') {
        window.location.href = `project-setup.html?workspaceId=${workspaceId}&projectId=${id}`;
      } else if (action === 'develop-case') {
        window.location.href = `case-setup.html?workspaceId=${workspaceId}&projectId=${id}`;
      } else if (action === 'open') {
        openProject(id);
      } else if (!e.target.closest('button')) {
        selectProjectContext(id);
      }
    }

    function handleCaseClick(e) {
      const card = e.target.closest('[data-case-id]');
      if (!card) return;
      const id = card.dataset.caseId;
      const action = e.target.closest('[data-action]')?.dataset.action;
      
      if (action === 'configure') {
        window.location.href = `case-setup.html?workspaceId=${workspaceId}&caseId=${id}`;
      } else if (action === 'open') {
        openCase(id);
      } else if (!e.target.closest('button')) {
        selectCaseContext(id);
      }
    }

    function selectProjectContext(id) {
      const p = (workspaceData?.projects || []).find(x => String(x.id) === String(id));
      const name = p?.name || p?.project_name || "Project";
      try {
        window.VericaseShell?.setProjectContext?.({ projectId: id, projectName: name });
      } catch {}
    }

    function selectCaseContext(id) {
      const c = (workspaceData?.cases || []).find(x => String(x.id) === String(id));
      const name = c?.name || c?.case_name || "Case";
      try {
        window.VericaseShell?.setCaseContext?.({ caseId: id, caseName: name });
      } catch {}
    }

    function openProject(id) {
      const p = (workspaceData?.projects || []).find(x => String(x.id) === String(id));
      try {
        localStorage.setItem("profileType", "project");
        localStorage.setItem("currentProjectId", id);
        localStorage.setItem("projectId", id);
        if (p?.name || p?.project_name) localStorage.setItem("currentProjectName", p.name || p.project_name);
      } catch {}
      window.location.href = `projectdashboard.html?projectId=${id}`;
    }

    function openCase(id) {
      const c = (workspaceData?.cases || []).find(x => String(x.id) === String(id));
      try {
        localStorage.setItem("profileType", "case");
        localStorage.setItem("currentCaseId", id);
        localStorage.setItem("caseId", id);
        if (c?.name || c?.case_name) localStorage.setItem("currentCaseName", c.name || c.case_name);
      } catch {}
      window.location.href = `projectdashboard.html?caseId=${id}`;
    }

    // ========================================
    // DEADLINES MANAGEMENT
    // ========================================
    function renderDeadlines() {
      const container = document.getElementById("deadlinesTableContainer");
      
      // Sort by date
      const sorted = [...workspaceDeadlines].sort((a, b) => {
        if (!a.date) return 1;
        if (!b.date) return -1;
        return new Date(a.date) - new Date(b.date);
      });

      if (sorted.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="margin-bottom: 0;">
            <i class="fas fa-calendar-check empty-icon"></i>
            <div class="empty-title">No Deadlines Yet</div>
            <div class="empty-desc">Add deadlines to track important dates and deliverables for this workspace.</div>
          </div>
        `;
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      container.innerHTML = `
        <table class="mgmt-table">
          <thead>
            <tr>
              <th>Task / Deadline</th>
              <th>Description</th>
              <th class="date-col">Date</th>
              <th>Source</th>
              <th>Reminder</th>
              <th class="actions-col"></th>
            </tr>
          </thead>
          <tbody>
            ${sorted.map((d, i) => {
              const dDate = d.date ? new Date(d.date) : null;
              let dateClass = '';
              if (dDate) {
                dDate.setHours(0, 0, 0, 0);
                if (dDate < today) dateClass = 'overdue';
                else if (dDate - today <= 7 * 24 * 60 * 60 * 1000) dateClass = 'soon';
                else dateClass = 'upcoming';
              }
              const source = d.source ? `<span style="font-size: 0.75rem; color: var(--text-muted);">${escapeHtml(d.source)}</span>` : '<span style="color: var(--vericase-teal); font-size: 0.75rem;">Workspace</span>';
              return `
                <tr data-deadline-idx="${i}">
                  <td><strong>${escapeHtml(d.task || '')}</strong></td>
                  <td>${escapeHtml(d.description || '')}</td>
                  <td><span class="date-badge ${dateClass}">${formatDate(d.date)}</span></td>
                  <td>${source}</td>
                  <td>${d.reminder === 'none' || !d.reminder ? '—' : d.reminder}</td>
                  <td class="actions-col">
                    ${!d.source_type ? `
                      <button class="table-action-btn" onclick="editDeadline(${i})" title="Edit"><i class="fas fa-edit"></i></button>
                      <button class="table-action-btn danger" onclick="deleteDeadline(${i})" title="Delete"><i class="fas fa-trash"></i></button>
                    ` : ''}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    async function addDeadline() {
      const task = document.getElementById("newDeadlineTask").value.trim();
      const desc = document.getElementById("newDeadlineDesc").value.trim();
      const date = document.getElementById("newDeadlineDate").value;
      const reminder = document.getElementById("newDeadlineReminder").value;

      if (!task) {
        VericaseUI.Toast.error("Please enter a task name");
        return;
      }

      const newDeadline = { task, description: desc, date, reminder, source: null, source_type: null };
      
      // Save to backend
      try {
        const res = await fetch(`/api/workspaces/${workspaceId}/deadlines`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify(newDeadline)
        });
        if (res.ok) {
          const saved = await res.json();
          workspaceDeadlines.push(saved);
        } else {
          // Fallback to local storage
          workspaceDeadlines.push({ ...newDeadline, id: Date.now() });
        }
      } catch {
        workspaceDeadlines.push({ ...newDeadline, id: Date.now() });
      }

      // Clear form
      document.getElementById("newDeadlineTask").value = '';
      document.getElementById("newDeadlineDesc").value = '';
      document.getElementById("newDeadlineDate").value = '';
      document.getElementById("newDeadlineReminder").value = 'none';

      renderDeadlines();
      updateTabCounts();
      VericaseUI.Toast.success("Deadline added");
    }

    function deleteDeadline(idx) {
      const d = workspaceDeadlines[idx];
      if (!d || d.source_type) return;
      
      if (!confirm(`Delete "${d.task}"?`)) return;
      
      // Remove from array
      workspaceDeadlines.splice(idx, 1);
      
      // Try to delete from backend
      if (d.id) {
        fetch(`/api/workspaces/${workspaceId}/deadlines/${d.id}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        }).catch(() => {});
      }
      
      renderDeadlines();
      updateTabCounts();
      VericaseUI.Toast.success("Deadline deleted");
    }

    function editDeadline(idx) {
      VericaseUI.Toast.info("Edit feature coming soon - delete and re-add for now");
    }

    function exportDeadlines() {
      const sorted = [...workspaceDeadlines].sort((a, b) => new Date(a.date) - new Date(b.date));
      let csv = "Task,Description,Date,Source,Reminder\n";
      sorted.forEach(d => {
        csv += `"${d.task || ''}","${d.description || ''}","${d.date || ''}","${d.source || 'Workspace'}","${d.reminder || 'none'}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `deadlines-${workspaceData?.code || 'workspace'}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      VericaseUI.Toast.success("Deadlines exported");
    }

    // ========================================
    // DOCUMENTS MANAGEMENT (folders + preview + AI)
    // ========================================

    function triggerFileUpload() {
      const input = document.getElementById("fileInput");
      if (input) input.click();
    }

    function triggerFolderUpload() {
      const input = document.getElementById("folderInput");
      if (input) input.click();
    }

    function _isUnfiledFolderSelected() {
      return String(currentDocumentsFolder || "") === "__unfiled__";
    }

    function _activeFolderForUpload() {
      // If the user is browsing a real folder, uploads should land there.
      // Otherwise (All Documents or Unfiled), upload as unfiled.
      const fp = String(currentDocumentsFolder || "").trim();
      if (!fp || fp === "__unfiled__") return "";
      return fp;
    }

    function _docInCurrentFolder(doc) {
      const folder = String(currentDocumentsFolder || "");
      const fp = (doc && doc.folder_path) ? String(doc.folder_path) : "";

      if (!folder) return true; // All Documents
      if (folder === "__unfiled__") return !fp;
      return fp === folder || fp.startsWith(folder + "/");
    }

    function _renderDocsBreadcrumb() {
      const el = document.getElementById("docsBreadcrumb");
      if (!el) return;

      const folder = String(currentDocumentsFolder || "");
      if (!folder) {
        el.innerHTML = `<span>All Documents</span>`;
        return;
      }
      if (folder === "__unfiled__") {
        el.innerHTML = `<span>Unfiled</span>`;
        return;
      }

      const parts = folder.split("/").filter(Boolean);
      const crumbs = [{ label: "All Documents", path: "" }];
      let acc = "";
      for (const p of parts) {
        acc = acc ? `${acc}/${p}` : p;
        crumbs.push({ label: p, path: acc });
      }

      el.innerHTML = crumbs
        .map((c, idx) => {
          const isLast = idx === crumbs.length - 1;
          const label = escapeHtml(c.label);
          if (isLast) return `<span>${label}</span>`;
          const enc = encodeURIComponent(String(c.path || ""));
          return `<a href="#" onclick="selectDocumentsFolder(decodeURIComponent('${enc}')); return false;">${label}</a> <span class="separator">/</span> `;
        })
        .join("");
    }

    function renderDocumentFolders() {
      const host = document.getElementById("docsFoldersList");
      if (!host) return;

      const folderList = Array.isArray(workspaceDocumentFolders)
        ? workspaceDocumentFolders
        : [];

      const totalDocs = Array.isArray(workspaceDocuments) ? workspaceDocuments.length : 0;
      const unfiled = (Array.isArray(workspaceDocuments) ? workspaceDocuments : []).filter((d) => !d?.folder_path).length;

      const rows = [];

      function row({ path, label, icon, depth = 0, count = null }) {
        const active = String(currentDocumentsFolder || "") === String(path || "");
        const pad = 10 + depth * 14;
        const enc = encodeURIComponent(String(path || ""));
        rows.push(`
          <div class="docs-folder-item ${active ? "active" : ""}" style="padding-left:${pad}px" onclick="selectDocumentsFolder(decodeURIComponent('${enc}'))">
            <i class="fas ${icon}"></i>
            <span>${escapeHtml(label)}</span>
            ${count !== null ? `<span class="folder-count">${formatCount(count)}</span>` : ""}
          </div>
        `);
      }

      row({ path: "", label: "All Documents", icon: "fa-folder-open", depth: 0, count: totalDocs });
      row({ path: "__unfiled__", label: "Unfiled", icon: "fa-inbox", depth: 0, count: unfiled });

      folderList.forEach((f) => {
        const p = String(f?.path || "").trim();
        if (!p) return;
        const depth = p.split("/").length - 1;
        row({
          path: p,
          label: f?.name || p.split("/").pop() || p,
          icon: "fa-folder",
          depth,
          count: Number(f?.doc_count_recursive || 0),
        });
      });

      host.innerHTML = rows.join("");
    }

    function selectDocumentsFolder(path) {
      currentDocumentsFolder = String(path || "");
      _renderDocsBreadcrumb();
      closeDocumentDetail();
      renderDocuments();
    }

    async function loadWorkspaceDocumentFolders() {
      if (!workspaceId) return;
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/documents/folders`, {
          headers: getAuthHeaders(),
        });
        if (!res.ok) return;
        const data = await res.json().catch(() => ({}));
        const folders = Array.isArray(data?.folders) ? data.folders : [];
        workspaceDocumentFolders = folders;
        renderDocumentFolders();
      } catch {
        // best-effort
      }
    }

    async function createWorkspaceDocumentFolder() {
      if (!workspaceId) return;
      const base = _activeFolderForUpload();
      const raw = prompt(
        base ? `New folder name/path (inside "${base}"):` : "New folder name/path:",
        ""
      );
      if (raw === null) return;
      const entered = String(raw || "").trim().replace(/^\/+|\/+$/g, "");
      if (!entered) return;
      const full = base ? `${base}/${entered}` : entered;

      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/documents/folders`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ path: full }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(typeof data?.detail === "string" ? data.detail : "Failed to create folder");
        await loadWorkspaceDocumentFolders();
        selectDocumentsFolder(full);
        VericaseUI.Toast.success("Folder created");
      } catch (e) {
        VericaseUI.Toast.error("Failed to create folder");
      }
    }

    async function loadWorkspaceDocuments() {
      if (!workspaceId) return;
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/documents`, {
          headers: getAuthHeaders(),
        });
        if (!res.ok) return;
        const docs = await res.json().catch(() => []);
        if (!Array.isArray(docs)) return;

        // Preserve any in-flight uploads already shown in the UI.
        const inFlight = (workspaceDocuments || []).filter((d) => d && d.uploading);
        workspaceDocuments = docs;
        if (inFlight.length) {
          workspaceDocuments = [...inFlight, ...workspaceDocuments];
        }
        renderDocuments();
        updateTabCounts();
        loadWorkspaceDocumentFolders().catch(() => {});
        try { _renderPurposeInstructionOptions(); } catch {}
      } catch {
        // best-effort
      }
    }

    function setupDragAndDrop() {
      const zone = document.getElementById("uploadZone");
      if (!zone) return;

      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        zone.classList.add("dragover");
      });

      zone.addEventListener("dragleave", () => {
        zone.classList.remove("dragover");
      });

      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      });
    }

    function handleFileSelect(e) {
      handleFiles(e.target.files);
      try { e.target.value = ""; } catch {}
    }

    async function handleFiles(files) {
      const targetFolder = _activeFolderForUpload();
      for (const file of files) {
        if (file.size > 50 * 1024 * 1024) {
          VericaseUI.Toast.error(`${file.name} is too large (max 50MB)`);
          continue;
        }

        // Add to local list immediately for UI feedback
        const doc = {
          id: Date.now() + Math.random(),
          filename: file.name,
          size: file.size,
          created_at: new Date().toISOString(),
          uploading: true,
          folder_path: targetFolder || null
        };
        workspaceDocuments.push(doc);
        renderDocuments();

        // Upload to backend
        try {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('workspace_id', workspaceId);
          if (targetFolder) formData.append('folder_path', targetFolder);

          const res = await fetch(`/api/workspaces/${workspaceId}/documents`, {
            method: 'POST',
            headers: (getAuthHeaders().Authorization ? { Authorization: getAuthHeaders().Authorization } : {}),
            body: formData
          });

          if (res.ok) {
            const saved = await res.json();
            // Replace temp with saved
            const idx = workspaceDocuments.findIndex(d => d.id === doc.id);
            if (idx >= 0) workspaceDocuments[idx] = saved;

            // Kick off workspace intelligence refresh (AI ingestion + About tab update)
            refreshWorkspaceAbout(true).catch(() => {});
            refreshWorkspacePurpose(true).catch(() => {});
          }
          doc.uploading = false;
        } catch {
          doc.uploading = false;
        }

        renderDocuments();
        updateTabCounts();
      }
      VericaseUI.Toast.success("Files uploaded");
    }

    function handleFolderSelect(e) {
      handleFolderFiles(e.target.files);
      try { e.target.value = ""; } catch {}
    }

    async function handleFolderFiles(files) {
      const base = _activeFolderForUpload();
      const list = Array.from(files || []);
      if (!list.length) return;

      for (const file of list) {
        if (file.size > 50 * 1024 * 1024) {
          VericaseUI.Toast.error(`${file.name} is too large (max 50MB)`);
          continue;
        }

        const rel = String(file.webkitRelativePath || file.name || "").replace(/^\/+/, "");
        const parts = rel.split("/").filter(Boolean);
        const fileName = parts.pop() || file.name;
        const relFolder = parts.join("/");
        const targetFolder = [base, relFolder].filter(Boolean).join("/");

        const doc = {
          id: Date.now() + Math.random(),
          filename: fileName,
          size: file.size,
          created_at: new Date().toISOString(),
          uploading: true,
          folder_path: targetFolder || null
        };
        workspaceDocuments.push(doc);
        renderDocuments();

        try {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("workspace_id", workspaceId);
          if (targetFolder) formData.append("folder_path", targetFolder);
          if (rel) formData.append("relative_path", rel);

          const res = await fetch(`/api/workspaces/${workspaceId}/documents`, {
            method: "POST",
            headers: (getAuthHeaders().Authorization ? { Authorization: getAuthHeaders().Authorization } : {}),
            body: formData,
          });

          if (res.ok) {
            const saved = await res.json();
            const idx = workspaceDocuments.findIndex((d) => d.id === doc.id);
            if (idx >= 0) workspaceDocuments[idx] = saved;
            refreshWorkspaceAbout(true).catch(() => {});
            refreshWorkspacePurpose(true).catch(() => {});
          }
          doc.uploading = false;
        } catch {
          doc.uploading = false;
        }

        renderDocuments();
        updateTabCounts();
      }

      VericaseUI.Toast.success("Folder uploaded");
      loadWorkspaceDocumentFolders().catch(() => {});
    }

    // ========================================
    // ABOUT (AI CONTEXT + Q&A)
    // ========================================
    function _clearAboutPoll() {
      if (aboutPollHandle) {
        clearTimeout(aboutPollHandle);
        aboutPollHandle = null;
      }
    }

    function _appendChatMessage(role, text) {
      const chat = document.getElementById("aboutChat");
      if (!chat) return;
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.textContent = text || "";
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function _renderAbout(about) {
      const summaryEl = document.getElementById("aboutSummary");
      const openQEl = document.getElementById("aboutOpenQuestions");
      const openQHint = document.getElementById("aboutOpenQuestionsHint");
      const notesEl = document.getElementById("aboutUserNotes");
      const chatHint = document.getElementById("aboutChatHint");
      const contractDocsEl = document.getElementById("aboutContractDocs");
      const contractTermsEl = document.getElementById("aboutContractTerms");
      const contractHintEl = document.getElementById("aboutContractsHint");
      const atAGlanceEl = document.getElementById("aboutAtAGlance");
      const partiesEl = document.getElementById("aboutPartiesRoles");
      const issuesEl = document.getElementById("aboutIssues");
      const nextActionsEl = document.getElementById("aboutNextActions");
      const structuredHintEl = document.getElementById("aboutStructuredHint");
      const evidenceMapEl = document.getElementById("aboutEvidenceMap");
      const evidenceMapHintEl = document.getElementById("aboutEvidenceMapHint");

      const status = (about?.status || "").toLowerCase();
      const updatedAt = about?.updated_at || about?.last_updated || null;
      const updatedText = updatedAt ? `Last updated: ${formatRelativeTime(updatedAt)}` : "";

      if (summaryEl) {
        const summary = about?.summary_md || about?.summary || "";
        const fallback =
          workspaceDocuments.length > 0
            ? "Building workspace context… (upload ingestion running)"
            : "Upload a document in this workspace to start building the dispute context.";
        summaryEl.innerHTML = renderMarkdown(summary || fallback);
      }

      // Contracts & key terms (pivotal section)
      try {
        const contracts =
          about?.contracts ||
          about?.data?.contracts ||
          {};

        const docs =
          Array.isArray(contracts?.documents) ? contracts.documents :
            (Array.isArray(contracts?.docs) ? contracts.docs : []);

        const keyTerms =
          Array.isArray(contracts?.key_terms_overview)
            ? contracts.key_terms_overview
            : [];

        if (contractDocsEl) {
          if (!docs.length) {
            contractDocsEl.innerHTML = `
              <div class="about-contract-item">
                <div>
                  <div class="about-contract-title">No contract document detected yet</div>
                  <div class="about-contract-meta">Upload the signed contract / standard form (JCT/NEC) plus schedules/appendices to unlock contract intelligence.</div>
                </div>
              </div>
            `;
          } else {
            contractDocsEl.innerHTML = docs.slice(0, 8).map((d) => {
              const id = (d?.evidence_id || d?.id || "").toString();
              const filename = (d?.filename || "Untitled").toString();
              const form = (d?.contract_form || d?.form || d?.type || "").toString();
              const date = (d?.contract_date || d?.date || d?.document_date || "").toString();
              const value = (d?.contract_value || d?.value || "").toString();
              const parties = (d?.parties || "").toString();
              const labels = Array.isArray(d?.source_labels) ? d.source_labels : (Array.isArray(d?.source_labels) ? d.source_labels : []);
              const chips = [];
              if (form) chips.push(form);
              if (value) chips.push(value);
              if (date) chips.push(date);
              if (Array.isArray(labels) && labels.length) chips.push(labels.filter(Boolean).join(", "));

              const metaParts = [];
              if (parties) metaParts.push(parties);
              const keyTermsObj = (d && typeof d === "object" && d.key_terms && typeof d.key_terms === "object") ? d.key_terms : null;
              if (keyTermsObj) {
                try {
                  const entries = Object.entries(keyTermsObj)
                    .filter(([k, v]) => String(v || "").trim())
                    .slice(0, 3)
                    .map(([k, v]) => `${k}: ${String(v).trim().slice(0, 90)}`);
                  if (entries.length) metaParts.push(entries.join(" • "));
                } catch {}
              }
              const risks = Array.isArray(d?.risks) ? d.risks.slice(0, 2).join(" • ") : "";
              if (risks) metaParts.push(`Risks: ${risks}`);

              return `
                <div class="about-contract-item">
                  <div>
                    <div class="about-contract-title">${escapeHtml(filename)}</div>
                    <div class="about-contract-meta">${escapeHtml(metaParts.join(" | "))}</div>
                    ${chips.length ? `<div class="about-chips">${chips.map(c => `<span class="about-chip">${escapeHtml(String(c))}</span>`).join("")}</div>` : ""}
                  </div>
                  <div class="about-contract-actions">
                    ${id ? `<button class="btn btn-sm btn-outline" onclick="downloadDocument('${id}')" title="Download"><i class="fas fa-download"></i></button>` : ""}
                  </div>
                </div>
              `;
            }).join("");
          }
        }

        if (contractTermsEl) {
          const textSummary = (contracts?.summary || contracts?.read_in || "").toString();
          if (textSummary.trim()) {
            contractTermsEl.textContent = textSummary;
          } else if (keyTerms.length) {
            contractTermsEl.textContent = keyTerms.slice(0, 18).map(t => `• ${String(t || "")}`).join("\n");
          } else {
            contractTermsEl.textContent = docs.length ? "Extracting key terms… run Refresh for a deeper contract read." : "Upload the contract pack to extract key terms (payment, retention, LDs, EOT, dispute resolution).";
          }
        }

        if (contractHintEl) {
          contractHintEl.textContent =
            docs.length
              ? `Built from ${docs.length} contract document(s). Click Refresh for a deeper clause/term extraction.`
              : "Tip: include the executed contract, amendments, schedules, and any key appointments (architect/QS/engineer).";
        }
      } catch {
        // best-effort
      }

      // Structured dispute intelligence (highly structured, deep mode fills this out)
      try {
        const structured = about?.structured || about?.data?.structured || {};
        const at = structured?.at_a_glance || {};
        const parties = Array.isArray(structured?.parties_roles) ? structured.parties_roles : [];
        const issues = Array.isArray(structured?.issues) ? structured.issues : [];
        const nextActions = Array.isArray(structured?.next_actions) ? structured.next_actions : [];
        const evidenceMap = (structured && typeof structured === "object" && structured.evidence_map && typeof structured.evidence_map === "object")
          ? structured.evidence_map
          : {};

        if (atAGlanceEl) {
          const lines = [];
          const push = (k, v) => { if (v && String(v).trim()) lines.push(`${k}: ${String(v).trim()}`); };
          push("Headline", at.headline);
          push("Dispute type", at.dispute_type);
          push("Location", at.location);
          push("Contract form", at.contract_form);
          push("Contract value", at.contract_value);
          if (Array.isArray(at.key_dates) && at.key_dates.length) {
            lines.push(`Key dates: ${at.key_dates.slice(0,6).join(" • ")}`);
          } else {
            push("Key dates", at.key_dates);
          }
          push("Current position", at.current_position);
          push("Quantum", at.quantum);
          atAGlanceEl.textContent = lines.length ? lines.join("\n") : "Refresh will generate structured intelligence (at-a-glance, parties, issues, next steps).";
        }

        if (partiesEl) {
          if (!parties.length) {
            partiesEl.textContent = "Refresh will extract parties/roles from contracts, pleadings, and key correspondence.";
          } else {
            partiesEl.textContent = parties.slice(0, 14).map(p => {
              const name = (p?.name || "").toString().trim();
              const role = (p?.role || "").toString().trim();
              const org = (p?.organisation || "").toString().trim();
              const notes = (p?.notes || "").toString().trim();
              const bits = [];
              if (name) bits.push(name);
              if (role) bits.push(`(${role})`);
              if (org) bits.push(`— ${org}`);
              if (notes) bits.push(`: ${notes}`);
              return `• ${bits.join(" ")}`.replace(/\s+/g, " ").trim();
            }).join("\n");
          }
        }

        if (issuesEl) {
          if (!issues.length) {
            issuesEl.textContent = "Refresh will extract the core issues (defects, delay, payment, design responsibility, insurance) with citations.";
          } else {
            issuesEl.textContent = issues.slice(0, 10).map(it => {
              const title = (it?.issue || "").toString().trim();
              const what = (it?.what_happened || "").toString().trim();
              const why = (it?.why_it_matters || "").toString().trim();
              const lines = [];
              if (title) lines.push(`• ${title}`);
              if (what) lines.push(`  - What: ${what}`);
              if (why) lines.push(`  - Why: ${why}`);
              return lines.join("\n");
            }).join("\n");
          }
        }

        if (nextActionsEl) {
          if (!nextActions.length) {
            nextActionsEl.textContent = "Refresh will propose next actions with document requests and owner hints.";
          } else {
            nextActionsEl.textContent = nextActions.slice(0, 12).map(a => {
              const action = (a?.action || "").toString().trim();
              const why = (a?.why || "").toString().trim();
              const owner = (a?.owner_hint || "").toString().trim();
              const lines = [];
              if (action) lines.push(`• ${action}`);
              if (why) lines.push(`  - Why: ${why}`);
              if (owner) lines.push(`  - Owner: ${owner}`);
              return lines.join("\n");
            }).join("\n");
          }
        }

        if (structuredHintEl) {
          structuredHintEl.textContent =
            (structured && Object.keys(structured).length)
              ? "Structured intelligence is generated from extracted text + AWS entity extraction + contract queries."
              : "Tip: Refresh runs deep processing and produces structured intelligence for counsel.";
        }

        if (evidenceMapEl) {
          const categories = [
            ["Contracts", "contracts"],
            ["Pleadings", "pleadings"],
            ["Expert reports", "expert_reports"],
            ["Correspondence", "correspondence"],
            ["Programmes", "programmes"],
            ["Photos", "photos"],
          ];

          function renderCategory(label, key) {
            const items = Array.isArray(evidenceMap?.[key]) ? evidenceMap[key] : [];
            if (!items.length) return "";
            const rows = items.slice(0, 6).map((it) => {
              const filename = (it?.filename || "").toString();
              const why = (it?.why_relevant || "").toString();
              const id = (it?.evidence_id || it?.id || "").toString();
              return `
                <div class="about-contract-item">
                  <div>
                    <div class="about-contract-title">${escapeHtml(filename || "Untitled")}</div>
                    <div class="about-contract-meta">${escapeHtml(why)}</div>
                  </div>
                  <div class="about-contract-actions">
                    ${id ? `<button class="btn btn-sm btn-outline" onclick="downloadDocument('${id}')" title="Download"><i class="fas fa-download"></i></button>` : ""}
                  </div>
                </div>
              `;
            }).join("");
            return `
              <div style="margin-top: 10px;">
                <div class="about-subtitle">${escapeHtml(label)}</div>
                <div class="about-contract-list">${rows}</div>
              </div>
            `;
          }

          const html = categories.map(([label, key]) => renderCategory(label, key)).filter(Boolean).join("");
          evidenceMapEl.innerHTML = html || `<div class="about-pre">Refresh will build an evidence map (contracts/pleadings/reports/correspondence/programmes/photos) and explain why each item matters.</div>`;
        }

        if (evidenceMapHintEl) {
          evidenceMapHintEl.textContent =
            (evidenceMap && Object.keys(evidenceMap).length)
              ? "Evidence map is auto-generated; click any item to download and verify."
              : "";
        }
      } catch {
        // best-effort
      }

      if (notesEl) {
        notesEl.value = (about?.user_notes || "").toString();
      }

      if (openQEl) {
        openQEl.innerHTML = "";
        const qs = Array.isArray(about?.open_questions) ? about.open_questions : [];
        if (qs.length === 0) {
          if (openQHint) openQHint.textContent = status === "ready" ? "No gaps detected yet." : "AI will propose gaps once it has documents.";
        } else {
          if (openQHint) openQHint.textContent = "";
          qs.slice(0, 12).forEach((q) => {
            const li = document.createElement("li");
            li.textContent = String(q || "");
            openQEl.appendChild(li);
          });
        }
      }

      if (chatHint) {
        chatHint.textContent =
          status === "building"
            ? `Processing documents. ${updatedText}`
            : updatedText;
      }

      updateTabCounts();
    }

    async function loadWorkspaceAbout() {
      if (!workspaceId) return;
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/about`, {
          headers: getAuthHeaders(),
        });
        if (!res.ok) throw new Error("Failed to load About");
        workspaceAbout = await res.json();
        _renderAbout(workspaceAbout);

        const status = (workspaceAbout?.status || "").toLowerCase();
        if (status === "building" || status === "processing") {
          _clearAboutPoll();
          aboutPollHandle = setTimeout(() => loadWorkspaceAbout().catch(() => {}), 1800);
        } else {
          _clearAboutPoll();
        }
      } catch (e) {
        // Don't toast-spam; About is best-effort
        console.debug("About load failed:", e);
      }
    }

    async function refreshWorkspaceAbout(force) {
      if (!workspaceId) return;
      const useForce = true; // Always run the deepest read-in by default
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/about/refresh`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ force: useForce }),
        });
        if (!res.ok) throw new Error("Failed to refresh About");
        workspaceAbout = await res.json().catch(() => workspaceAbout);
        _renderAbout(workspaceAbout);
        _clearAboutPoll();
        aboutPollHandle = setTimeout(() => loadWorkspaceAbout().catch(() => {}), 1200);
      } catch (e) {
        console.debug("About refresh failed:", e);
      }
    }

    async function askWorkspaceAbout() {
      const input = document.getElementById("aboutQuestionInput");
      const btn = document.getElementById("aboutAskBtn");
      const question = (input?.value || "").trim();
      if (!question) return;

      _appendChatMessage("user", question);
      if (input) input.value = "";
      if (btn) btn.disabled = true;

      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/about/ask`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ question }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = typeof data?.detail === "string" ? data.detail : "Failed to answer question";
          _appendChatMessage("ai", msg);
          return;
        }
        _appendChatMessage("ai", String(data?.answer || "No answer returned."));
        if (Array.isArray(data?.sources) && data.sources.length > 0) {
          const top = data.sources.slice(0, 6).map(s => `• ${s.filename || s.label || s.id || "source"}`).join("\n");
          _appendChatMessage("ai", `Sources:\n${top}`);
        }
      } catch (e) {
        _appendChatMessage("ai", "Failed to answer question (network or server error).");
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function saveWorkspaceAboutNotes() {
      const notesEl = document.getElementById("aboutUserNotes");
      const hintEl = document.getElementById("aboutNotesHint");
      const notes = (notesEl?.value || "").trim();
      if (!workspaceId) return;

      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/about/notes`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ notes }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(typeof data?.detail === "string" ? data.detail : "Failed to save notes");
        if (hintEl) hintEl.textContent = "Saved. The next refresh will incorporate these facts.";
        // Trigger rebuild (best effort)
        refreshWorkspaceAbout(true).catch(() => {});
      } catch (e) {
        if (hintEl) hintEl.textContent = "Failed to save notes.";
      }
    }

    // ========================================
    // PURPOSE (BASELINE + TRACKING)
    // ========================================
    function _clearPurposePoll() {
      if (purposePollHandle) {
        clearTimeout(purposePollHandle);
        purposePollHandle = null;
      }
    }

    function _appendPurposeChatMessage(role, text) {
      const chat = document.getElementById("purposeChat");
      if (!chat) return;
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.textContent = text || "";
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function _renderPurposeInstructionOptions() {
      const select = document.getElementById("purposeInstructionSelect");
      if (!select) return;
      const currentId = (workspacePurpose?.instructions_evidence_id || "").toString();
      select.innerHTML = "";
      const noneOpt = document.createElement("option");
      noneOpt.value = "";
      noneOpt.textContent = "No instruction document selected";
      select.appendChild(noneOpt);

      const docs = Array.isArray(workspaceDocuments) ? workspaceDocuments : [];
      docs
        .slice()
        .sort((a, b) => (a.filename || "").localeCompare(b.filename || ""))
        .forEach((doc) => {
          const opt = document.createElement("option");
          opt.value = doc.id;
          opt.textContent = doc.filename || "Untitled";
          if (String(doc.id) === currentId) opt.selected = true;
          select.appendChild(opt);
        });
    }

    function _isPurposeEmpty(purpose) {
      const summary = (purpose?.summary || purpose?.summary_md || "").toString().trim();
      const baseline = (purpose?.purpose_text || "").toString().trim();
      const instructionId = (purpose?.instructions_evidence_id || "").toString().trim();
      const data = purpose?.data && typeof purpose.data === "object" ? purpose.data : {};
      const hasData = Object.keys(data || {}).length > 0;
      return !summary && !baseline && !instructionId && !hasData;
    }

    function _renderPurpose(purpose) {
      const summaryEl = document.getElementById("purposeSummary");
      const textEl = document.getElementById("purposeTextInput");
      const deliverablesEl = document.getElementById("purposeDeliverables");
      const chronologyEl = document.getElementById("purposeChronology");
      const contradictionsEl = document.getElementById("purposeContradictions");
      const evidenceOrgEl = document.getElementById("purposeEvidenceOrganisation");
      const hintEl = document.getElementById("purposeChatHint");

      const status = (purpose?.status || "").toLowerCase();
      const updatedAt = purpose?.updated_at || null;
      const updatedText = updatedAt ? `Last updated: ${formatRelativeTime(updatedAt)}` : "";
      const isEmpty = _isPurposeEmpty(purpose);

      if (summaryEl) {
        const summary = purpose?.summary || purpose?.summary_md || "";
        summaryEl.textContent =
          summary ||
          (isEmpty
            ? "No purpose baseline yet. Add a goal statement and/or upload the instruction narrative."
            : "Building purpose baseline…");
      }

      if (textEl) {
        textEl.value = (purpose?.purpose_text || "").toString();
      }

      _renderPurposeInstructionOptions();

      try {
        const data = purpose?.data || {};
        const baseline = data?.baseline || {};
        const tracking = Array.isArray(data?.tracking) ? data.tracking : [];
        const chronology = Array.isArray(data?.chronology) ? data.chronology : [];
        const contradictions = Array.isArray(data?.contradictions) ? data.contradictions : [];
        const evidenceOrg = data?.evidence_organisation || {};

        if (deliverablesEl) {
          if (tracking.length) {
            deliverablesEl.textContent = tracking.slice(0, 16).map((d) => {
              const name = (d?.deliverable || "").toString().trim();
              const statusVal = (d?.status || "").toString().trim();
              const gaps = (d?.gaps || "").toString().trim();
              const evidence = (d?.evidence || "").toString().trim();
              const bits = [];
              if (name) bits.push(`• ${name}`);
              if (statusVal) bits.push(`  - Status: ${statusVal}`);
              if (evidence) bits.push(`  - Evidence: ${evidence}`);
              if (gaps) bits.push(`  - Gaps: ${gaps}`);
              return bits.join("\n");
            }).join("\n");
          } else if (Array.isArray(baseline?.deliverables) && baseline.deliverables.length) {
            deliverablesEl.textContent = baseline.deliverables.slice(0, 14).map(d => `• ${String(d || "")}`).join("\n");
          } else {
            deliverablesEl.textContent = isEmpty
              ? "Define a baseline or upload the instruction narrative to generate deliverables."
              : "Define deliverables in the purpose baseline or upload the instruction narrative.";
          }
        }

        if (chronologyEl) {
          if (chronology.length) {
            chronologyEl.textContent = chronology.slice(0, 12).map((c) => {
              const date = (c?.date || "").toString().trim();
              const party = (c?.party || "").toString().trim();
              const quote = (c?.quote || "").toString().trim();
              const tags = Array.isArray(c?.issue_tags) ? c.issue_tags.join(", ") : "";
              const line = `• ${date || "Unknown date"} — ${party || "Unknown party"}${tags ? ` (${tags})` : ""}`;
              return quote ? `${line}\n  - ${quote}` : line;
            }).join("\n");
          } else {
            chronologyEl.textContent = isEmpty
              ? "Add baseline instructions to start building the chronology."
              : "Chronology will be generated from dated evidence and correspondence.";
          }
        }

        if (contradictionsEl) {
          if (contradictions.length) {
            contradictionsEl.textContent = contradictions.slice(0, 10).map((c) => {
              const a = (c?.statement_a || "").toString().trim();
              const b = (c?.statement_b || "").toString().trim();
              const exp = (c?.explanation || "").toString().trim();
              const lines = [];
              if (a) lines.push(`• A: ${a}`);
              if (b) lines.push(`  - B: ${b}`);
              if (exp) lines.push(`  - Why: ${exp}`);
              return lines.join("\n");
            }).join("\n");
          } else {
            contradictionsEl.textContent = isEmpty
              ? "Upload instruction narrative and key documents to surface contradictions."
              : "Contradictions will surface once key emails, inspections, and drawings are ingested.";
          }
        }

        if (evidenceOrgEl) {
          const issueGroups = Array.isArray(evidenceOrg?.issue_groupings) ? evidenceOrg.issue_groupings : [];
          const keywordMap = evidenceOrg?.keyword_map || {};
          const lines = [];
          if (issueGroups.length) {
            lines.push("Issue groupings:");
            issueGroups.slice(0, 8).forEach((g) => lines.push(`• ${String(g || "")}`));
          }
          if (keywordMap && typeof keywordMap === "object" && Object.keys(keywordMap).length) {
            lines.push("");
            lines.push("Keyword map:");
            Object.entries(keywordMap).slice(0, 8).forEach(([k, v]) => {
              lines.push(`• ${k}: ${String(v || "")}`);
            });
          }
          evidenceOrgEl.textContent = lines.length
            ? lines.join("\n")
            : (isEmpty
              ? "Define issue groupings in the instruction narrative to map evidence."
              : "Evidence organisation will align to instruction keywords and issue groupings.");
        }
      } catch {
        // best-effort
      }

      if (hintEl) {
        hintEl.textContent =
          status === "building"
            ? `Processing baseline. ${updatedText}`
            : (isEmpty ? "No baseline yet. Add purpose text or upload instructions." : updatedText);
      }

      updateTabCounts();
    }

    async function loadWorkspacePurpose() {
      if (!workspaceId) return;
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/purpose`, {
          headers: getAuthHeaders(),
        });
        if (!res.ok) {
          const { detail } = await parseApiError(res);
          console.debug("Purpose load failed:", { status: res.status, detail });
          if (handleAuthFailure(res)) return;
          throw new Error(detail || "Failed to load Purpose");
        }
        workspacePurpose = await res.json();
        _renderPurpose(workspacePurpose);

        const status = (workspacePurpose?.status || "").toLowerCase();
        if (status === "building" || status === "processing") {
          _clearPurposePoll();
          purposePollHandle = setTimeout(() => loadWorkspacePurpose().catch(() => {}), 1800);
        } else {
          _clearPurposePoll();
        }
      } catch (e) {
        console.debug("Purpose load failed:", e);
        workspacePurpose = {
          status: "empty",
          purpose_text: "",
          instructions_evidence_id: null,
          summary: "",
          data: {},
          updated_at: null,
        };
        _renderPurpose(workspacePurpose);
      }
    }

    async function saveWorkspacePurposeConfig(showToast = true) {
      if (!workspaceId) return;
      const textEl = document.getElementById("purposeTextInput");
      const selectEl = document.getElementById("purposeInstructionSelect");
      const purpose_text = (textEl?.value || "").trim();
      const instructions_evidence_id = selectEl?.value || null;

      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/purpose/config`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({
            purpose_text,
            instructions_evidence_id: instructions_evidence_id || null,
          }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          if (handleAuthFailure(res)) return;
          throw new Error(typeof data?.detail === "string" ? data.detail : "Failed to save purpose");
        }
        workspacePurpose = { ...(workspacePurpose || {}), ...data, purpose_text };
        _renderPurpose(workspacePurpose);
        if (showToast) VericaseUI.Toast.success("Purpose baseline saved");
        refreshWorkspacePurpose(true).catch(() => {});
      } catch (e) {
        const msg = typeof e?.message === "string" ? e.message : "Failed to save purpose baseline";
        if (showToast) VericaseUI.Toast.error(msg);
      }
    }

    async function refreshWorkspacePurpose(force) {
      if (!workspaceId) return;
      const useForce = true; // Always run the deepest purpose analysis by default
      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/purpose/refresh`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ force: useForce, deep: useForce }),
        });
        if (!res.ok) {
          const { detail } = await parseApiError(res);
          console.debug("Purpose refresh failed:", { status: res.status, detail });
          if (handleAuthFailure(res)) return;
          throw new Error(detail || "Failed to refresh Purpose");
        }
        workspacePurpose = await res.json().catch(() => workspacePurpose);
        _renderPurpose(workspacePurpose);
        _clearPurposePoll();
        purposePollHandle = setTimeout(() => loadWorkspacePurpose().catch(() => {}), 1200);
      } catch (e) {
        const msg = typeof e?.message === "string" ? e.message : "Failed to refresh Purpose";
        console.debug("Purpose refresh failed:", e);
        VericaseUI.Toast.error(msg);
      }
    }

    async function askWorkspacePurpose() {
      const input = document.getElementById("purposeQuestionInput");
      const btn = document.getElementById("purposeAskBtn");
      const question = (input?.value || "").trim();
      if (!question) return;

      _appendPurposeChatMessage("user", question);
      if (input) input.value = "";
      if (btn) btn.disabled = true;

      try {
        const res = await fetch(`/api/workspaces/${encodeURIComponent(workspaceId)}/purpose/ask`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ question }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = typeof data?.detail === "string" ? data.detail : "Failed to answer question";
          _appendPurposeChatMessage("ai", msg);
          return;
        }
        _appendPurposeChatMessage("ai", String(data?.answer || "No answer returned."));
        if (Array.isArray(data?.sources) && data.sources.length > 0) {
          const top = data.sources.slice(0, 6).map(s => `• ${s.filename || s.label || s.id || "source"}`).join("\n");
          _appendPurposeChatMessage("ai", `Sources:\n${top}`);
        }
      } catch (e) {
        _appendPurposeChatMessage("ai", "Failed to answer question (network or server error).");
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function triggerPurposeInstructionUpload() {
      const input = document.getElementById("purposeInstructionInput");
      if (input) input.click();
    }

    async function handlePurposeInstructionSelect(e) {
      const files = e.target.files || [];
      if (!files.length) return;
      const file = files[0];
      try { e.target.value = ""; } catch {}
      if (!workspaceId) return;

      if (file.size > 50 * 1024 * 1024) {
        VericaseUI.Toast.error(`${file.name} is too large (max 50MB)`);
        return;
      }

      try {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("workspace_id", workspaceId);
        formData.append("folder_path", "Purpose/Instructions");

        const res = await fetch(`/api/workspaces/${workspaceId}/documents`, {
          method: "POST",
          headers: (getAuthHeaders().Authorization ? { Authorization: getAuthHeaders().Authorization } : {}),
          body: formData,
        });
        if (!res.ok) throw new Error("Upload failed");
        const saved = await res.json();
        workspaceDocuments = Array.isArray(workspaceDocuments) ? workspaceDocuments : [];
        workspaceDocuments.unshift(saved);
        renderDocuments();
        loadWorkspaceDocumentFolders().catch(() => {});
        _renderPurposeInstructionOptions();

        const select = document.getElementById("purposeInstructionSelect");
        if (select) {
          select.value = saved.id;
        }
        await saveWorkspacePurposeConfig(false);
        VericaseUI.Toast.success("Instruction uploaded");
      } catch (e) {
        VericaseUI.Toast.error("Failed to upload instruction");
      }
    }

    function renderDocuments() {
      // Keep folders + breadcrumb in sync with document renders.
      try { renderDocumentFolders(); } catch {}
      try { _renderDocsBreadcrumb(); } catch {}

      const grid = document.getElementById("documentsGrid");
      if (!grid) return;

      const docs = (Array.isArray(workspaceDocuments) ? workspaceDocuments : []).filter(_docInCurrentFolder);

      if (docs.length === 0) {
        const hint =
          String(currentDocumentsFolder || "") === "__unfiled__"
            ? "No unfiled documents. Upload files here or move items back to Unfiled."
            : String(currentDocumentsFolder || "")
              ? "No documents in this folder yet. Upload files here or upload a folder."
              : "No documents yet. Upload files to start building workspace context.";

        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-folder-open empty-icon"></i>
            <div class="empty-title">No documents</div>
            <div class="empty-desc">${escapeHtml(hint)}</div>
            <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px;">
              <button class="btn btn-vericase" type="button" onclick="triggerFileUpload()">
                <i class="fas fa-upload"></i> Upload Files
              </button>
              <button class="btn btn-outline" type="button" onclick="triggerFolderUpload()">
                <i class="fas fa-folder-tree"></i> Upload Folder
              </button>
            </div>
          </div>
        `;
        return;
      }

      grid.innerHTML = docs.map(doc => {
        const ext = (doc.filename || '').split('.').pop().toLowerCase();
        let iconClass = '';
        let iconName = 'fa-file';
        if (['pdf'].includes(ext)) { iconClass = 'pdf'; iconName = 'fa-file-pdf'; }
        else if (['doc', 'docx'].includes(ext)) { iconClass = 'doc'; iconName = 'fa-file-word'; }
        else if (['xls', 'xlsx', 'csv'].includes(ext)) { iconClass = 'xls'; iconName = 'fa-file-excel'; }
        else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) { iconClass = 'img'; iconName = 'fa-file-image'; }

        const isSelected = String(doc.id) === String(selectedWorkspaceDocId || "");
        const cardStyle = [
          doc.uploading ? "opacity:0.6" : "",
          isSelected ? "border-color: var(--vericase-teal); box-shadow: 0 6px 16px rgba(15, 23, 32, 0.10);" : ""
        ].filter(Boolean).join(";");

        const fp = doc.folder_path ? String(doc.folder_path) : "";
        const folderLabel = fp ? ` • ${escapeHtml(fp)}` : "";

        return `
          <div class="document-card" data-doc-id="${doc.id}" onclick="selectWorkspaceDocument('${doc.id}')" style="${cardStyle}">
            <div class="doc-actions">
              <button class="table-action-btn" onclick="event.stopPropagation(); showMoveDocumentModal('${doc.id}')" title="Move"><i class="fas fa-folder-open"></i></button>
              <button class="table-action-btn" onclick="event.stopPropagation(); downloadDocument('${doc.id}')" title="Download"><i class="fas fa-download"></i></button>
              <button class="table-action-btn danger" onclick="event.stopPropagation(); deleteDocument('${doc.id}')" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
            <div class="document-icon ${iconClass}">
              <i class="fas ${iconName}"></i>
            </div>
            <div class="document-name">${escapeHtml(doc.filename || 'Untitled')}</div>
            <div class="document-meta">${formatFileSize(doc.size)} • ${formatDate(doc.created_at)}${folderLabel}</div>
          </div>
        `;
      }).join('');
    }

    function downloadDocument(id) {
      const ws = encodeURIComponent(workspaceId || "");
      const docId = encodeURIComponent(id || "");
      window.open(`/api/workspaces/${ws}/documents/${docId}/download`, '_blank');
    }

    function hideMoveDocumentModal() {
      moveDocModalId = null;
      const modal = document.getElementById("moveDocModal");
      if (modal) modal.style.display = "none";
      const hint = document.getElementById("moveDocCreateHint");
      if (hint) hint.textContent = "";
      const input = document.getElementById("moveDocNewFolder");
      if (input) input.value = "";
    }

    function _populateMoveDocFolderSelect(currentFolderPath) {
      const select = document.getElementById("moveDocFolderSelect");
      if (!select) return;

      // Build options safely (DOM API) to avoid encoding pitfalls.
      select.innerHTML = "";

      function addOption(value, label) {
        const opt = document.createElement("option");
        opt.value = String(value || "");
        opt.textContent = String(label || "");
        select.appendChild(opt);
      }

      addOption("", "Unfiled (no folder)");

      const folders = Array.isArray(workspaceDocumentFolders)
        ? workspaceDocumentFolders
        : [];

      folders.forEach((f) => {
        const path = String(f?.path || "").trim();
        if (!path) return;
        const depth = path.split("/").length - 1;
        const indent = "\u00A0\u00A0".repeat(depth);
        addOption(path, `${indent}${path}`);
      });

      const desired = String(currentFolderPath || "");
      const has = Array.from(select.options).some((o) => o.value === desired);
      select.value = has ? desired : "";
    }

    async function showMoveDocumentModal(id) {
      if (!workspaceId) return;
      const doc = (Array.isArray(workspaceDocuments) ? workspaceDocuments : []).find(
        (d) => String(d?.id) === String(id)
      );
      if (!doc) return;

      moveDocModalId = String(id);

      const nameEl = document.getElementById("moveDocName");
      if (nameEl) nameEl.textContent = doc?.filename || "Document";

      const hint = document.getElementById("moveDocCreateHint");
      if (hint) hint.textContent = "";
      const input = document.getElementById("moveDocNewFolder");
      if (input) input.value = "";

      // Ensure folder list is current.
      await loadWorkspaceDocumentFolders();
      _populateMoveDocFolderSelect(doc?.folder_path || "");

      const modal = document.getElementById("moveDocModal");
      if (modal) modal.style.display = "flex";
      const select = document.getElementById("moveDocFolderSelect");
      if (select) select.focus();
    }

    async function createFolderFromMoveModal() {
      if (!workspaceId) return;
      const input = document.getElementById("moveDocNewFolder");
      const hint = document.getElementById("moveDocCreateHint");
      const select = document.getElementById("moveDocFolderSelect");

      const raw = String(input?.value || "")
        .trim()
        .replace(/^\/+|\/+$/g, "");

      if (!raw) {
        if (hint) hint.textContent = "Enter a folder name/path to create.";
        return;
      }

      const selectedParent = String(select?.value || "");
      // If the user typed a simple name and a folder is selected, create as a child folder.
      const isSimpleName = !raw.includes("/");
      const path = selectedParent && isSimpleName ? `${selectedParent}/${raw}` : raw;

      try {
        if (hint) hint.textContent = "Creating…";
        const res = await fetch(
          `/api/workspaces/${encodeURIComponent(workspaceId)}/documents/folders`,
          {
            method: "POST",
            headers: getAuthHeaders(),
            body: JSON.stringify({ path }),
          }
        );
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(
            typeof data?.detail === "string" ? data.detail : "Failed to create folder"
          );
        }

        // Refresh folders and select the newly created path.
        await loadWorkspaceDocumentFolders();
        _populateMoveDocFolderSelect(path);
        if (select) select.value = path;

        if (input) input.value = "";
        if (hint) hint.textContent = `Created "${path}". Select it and click Move.`;
      } catch (e) {
        if (hint) hint.textContent = "Failed to create folder.";
      }
    }

    async function confirmMoveDocument() {
      if (!workspaceId || !moveDocModalId) return;
      const select = document.getElementById("moveDocFolderSelect");
      const folder_path = String(select?.value || "").trim();

      try {
        const ws = encodeURIComponent(workspaceId || "");
        const docId = encodeURIComponent(moveDocModalId || "");
        const res = await fetch(`/api/workspaces/${ws}/documents/${docId}/move`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ folder_path: folder_path || null }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(typeof data?.detail === "string" ? data.detail : "Failed to move");
        }

        const idx = workspaceDocuments.findIndex(
          (d) => String(d?.id) === String(moveDocModalId)
        );
        if (idx >= 0) {
          workspaceDocuments[idx] = { ...workspaceDocuments[idx], ...data };
        }

        // If the moved doc no longer matches the current folder filter, close the detail panel.
        const updatedDoc = (Array.isArray(workspaceDocuments) ? workspaceDocuments : []).find(
          (d) => String(d?.id) === String(moveDocModalId)
        );
        if (String(selectedWorkspaceDocId || "") === String(moveDocModalId)) {
          try {
            if (updatedDoc && !_docInCurrentFolder(updatedDoc)) {
              closeDocumentDetail();
            }
          } catch {}
        }

        hideMoveDocumentModal();
        loadWorkspaceDocumentFolders().catch(() => {});
        renderDocuments();
        refreshWorkspaceAbout(true).catch(() => {});
        refreshWorkspacePurpose(true).catch(() => {});
        VericaseUI.Toast.success("Document moved");
      } catch (e) {
        VericaseUI.Toast.error("Failed to move document");
      }
    }

    // Backwards-compatible alias (older buttons used this name)
    function moveDocumentPrompt(id) {
      showMoveDocumentModal(id);
    }

    function selectWorkspaceDocument(id) {
      selectedWorkspaceDocId = id;
      renderDocuments();

      const doc = (Array.isArray(workspaceDocuments) ? workspaceDocuments : []).find(d => String(d?.id) === String(id));
      const detail = document.getElementById("docDetail");
      const titleEl = document.getElementById("docDetailTitle");
      const previewEl = document.getElementById("docPreview");
      const chatEl = document.getElementById("docChatMessages");
      const inputEl = document.getElementById("docChatInput");

      if (detail) detail.style.display = "";
      if (titleEl) titleEl.textContent = doc?.filename || "Document";
      if (previewEl) previewEl.innerHTML = `<div class="about-hint">Loading preview…</div>`;
      if (chatEl) chatEl.innerHTML = "";
      if (inputEl) inputEl.value = "";

      _appendDocChatMessage("assistant", "Ask me anything about this document (summary, key dates, key terms, issues).");
      loadSelectedDocumentPreview(id).catch(() => {});
    }

    function closeDocumentDetail() {
      selectedWorkspaceDocId = null;
      const detail = document.getElementById("docDetail");
      const previewEl = document.getElementById("docPreview");
      const chatEl = document.getElementById("docChatMessages");
      if (detail) detail.style.display = "none";
      if (previewEl) previewEl.innerHTML = "";
      if (chatEl) chatEl.innerHTML = "";
    }

    function downloadSelectedDocument() {
      if (!selectedWorkspaceDocId) return;
      downloadDocument(selectedWorkspaceDocId);
    }

    function moveSelectedDocument() {
      if (!selectedWorkspaceDocId) return;
      showMoveDocumentModal(selectedWorkspaceDocId);
    }

    function deleteSelectedDocument() {
      if (!selectedWorkspaceDocId) return;
      deleteDocument(selectedWorkspaceDocId);
    }

    function _appendDocChatMessage(role, text) {
      const chat = document.getElementById("docChatMessages");
      if (!chat) return;
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.textContent = text || "";
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function askSelectedDocument() {
      if (!workspaceId || !selectedWorkspaceDocId) return;
      const input = document.getElementById("docChatInput");
      const q = (input?.value || "").trim();
      if (!q) return;
      if (input) input.value = "";

      _appendDocChatMessage("user", q);
      _appendDocChatMessage("assistant", "Thinking…");

      const ws = encodeURIComponent(workspaceId || "");
      const docId = encodeURIComponent(selectedWorkspaceDocId || "");

      try {
        const res = await fetch(`/api/workspaces/${ws}/documents/${docId}/ask`, {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ question: q }),
        });
        const data = await res.json().catch(() => ({}));
        const answer = data?.answer || (res.ok ? "" : (data?.detail || "Failed to ask"));

        // Remove the "Thinking…" message (last assistant message) and replace.
        const chat = document.getElementById("docChatMessages");
        if (chat && chat.lastElementChild && chat.lastElementChild.classList.contains("assistant")) {
          chat.removeChild(chat.lastElementChild);
        }
        _appendDocChatMessage("assistant", String(answer || "No response").trim());
      } catch (e) {
        const chat = document.getElementById("docChatMessages");
        if (chat && chat.lastElementChild && chat.lastElementChild.classList.contains("assistant")) {
          chat.removeChild(chat.lastElementChild);
        }
        _appendDocChatMessage("assistant", "Failed to reach AI service.");
      }
    }

    async function loadSelectedDocumentPreview(id) {
      if (!workspaceId || !id) return;
      const current = String(id);
      const previewEl = document.getElementById("docPreview");
      if (!previewEl) return;

      previewEl.innerHTML = `<div class="about-hint">Loading preview…</div>`;
      const ws = encodeURIComponent(workspaceId || "");
      const docId = encodeURIComponent(id || "");

      try {
        const res = await fetch(`/api/workspaces/${ws}/documents/${docId}/preview`, {
          headers: getAuthHeaders(),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(typeof data?.detail === "string" ? data.detail : "Failed to preview");
        if (String(selectedWorkspaceDocId || "") !== current) return;
        await renderSelectedDocumentPreview(data);
      } catch (e) {
        if (String(selectedWorkspaceDocId || "") !== current) return;
        previewEl.innerHTML = `<div class="about-hint">Preview unavailable.</div>`;
      }
    }

    async function renderSelectedDocumentPreview(preview) {
      const previewEl = document.getElementById("docPreview");
      if (!previewEl) return;

      const type = String(preview?.preview_type || "unsupported");
      const url = preview?.preview_url || preview?.download_url || null;
      const mime = preview?.mime_type || "";

      if (type === "pdf" && url) {
        previewEl.innerHTML = `<iframe class="doc-preview-frame" src="${url}"></iframe>`;
        return;
      }
      if (type === "image" && url) {
        previewEl.innerHTML = `<img class="doc-preview-img" src="${url}" alt="Preview" />`;
        return;
      }
      if (type === "audio" && url) {
        previewEl.innerHTML = `<audio class="doc-preview-frame" controls src="${url}"></audio>`;
        return;
      }
      if (type === "video" && url) {
        previewEl.innerHTML = `<video class="doc-preview-frame" controls src="${url}"></video>`;
        return;
      }
      if (type === "email") {
        const c = preview?.preview_content || {};
        previewEl.innerHTML = `
          <div class="doc-preview-pre">
From: ${escapeHtml(c?.from || "")}
To: ${escapeHtml(c?.to || "")}
CC: ${escapeHtml(c?.cc || "")}
Subject: ${escapeHtml(c?.subject || "")}
Date: ${escapeHtml(c?.date || "")}

${escapeHtml(c?.body_preview || "")}
          </div>
        `;
        return;
      }

      // Text-ish types: fetch extracted text content for display
      if (type === "text" || type === "office" || mime.startsWith("text/")) {
        previewEl.innerHTML = `<div class="about-hint">Extracting text preview…</div>`;
        try {
          const ws = encodeURIComponent(workspaceId || "");
          const evidenceId = encodeURIComponent(String(preview?.evidence_id || selectedWorkspaceDocId || ""));
          const res = await fetch(`/api/workspaces/${ws}/documents/${evidenceId}/text-content?max_length=50000`, {
            headers: getAuthHeaders(),
          });
          const data = await res.json().catch(() => ({}));
          const text = String(data?.text || "");
          previewEl.innerHTML = `<pre class="doc-preview-pre">${escapeHtml(text || "[No text extracted yet]")}</pre>`;
          return;
        } catch {
          // fall through
        }
      }

      const safeName = escapeHtml(String(preview?.filename || "Document"));
      previewEl.innerHTML = `
        <div class="about-hint">
          Preview not available for ${safeName}. ${url ? "You can still download it." : ""}
        </div>
      `;
    }

    function deleteDocument(id) {
      const doc = (Array.isArray(workspaceDocuments) ? workspaceDocuments : []).find(d => String(d?.id) === String(id));
      if (!doc) return;
      if (!confirm(`Delete "${doc.filename}"?`)) return;

      workspaceDocuments = workspaceDocuments.filter(d => String(d?.id) !== String(id));
      if (String(selectedWorkspaceDocId || "") === String(id)) {
        closeDocumentDetail();
      }

      fetch(`/api/workspaces/${workspaceId}/documents/${id}`, {
        method: 'DELETE',
        headers: getAuthHeaders()
      }).catch(() => {});

      renderDocuments();
      updateTabCounts();
      loadWorkspaceDocumentFolders().catch(() => {});
      refreshWorkspaceAbout(true).catch(() => {});
      refreshWorkspacePurpose(true).catch(() => {});
      VericaseUI.Toast.success("Document deleted");
    }

    // ========================================
    // TEAM MANAGEMENT
    // ========================================
    function renderTeam() {
      const grid = document.getElementById("teamGrid");

      if (workspaceTeam.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i class="fas fa-id-badge empty-icon"></i>
            <div class="empty-title">No Team Members</div>
            <div class="empty-desc">Add existing users to collaborate on this workspace.</div>
            <button class="btn btn-vericase" onclick="showAddMemberModal()">
              <i class="fas fa-user-plus"></i> Add Member
            </button>
          </div>
        `;
        return;
      }

      grid.innerHTML = workspaceTeam.map(user => {
        const initials = getInitials(user.name || user.email);
        const roleClass = String(user.role || '').toLowerCase() === 'admin' ? 'admin' : '';
        return `
          <div class="team-member" data-user-id="${user.id || user.email}">
            <div class="member-actions">
              <button class="table-action-btn danger" onclick="removeMember('${user.id || user.email}')" title="Remove"><i class="fas fa-times"></i></button>
            </div>
            <div class="team-avatar">${initials}</div>
            <div class="team-info">
              <div class="team-name">${escapeHtml(user.name || 'Unknown')}</div>
              <div class="team-email">${escapeHtml(user.email || '')}</div>
              <span class="team-role ${roleClass}">${escapeHtml(user.role || 'Member')}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function showAddMemberModal() {
      document.getElementById("addMemberModal").style.display = "flex";
    }

    function hideAddMemberModal() {
      document.getElementById("addMemberModal").style.display = "none";
    }

    async function addMember() {
      const email = document.getElementById("memberEmail").value.trim();
      const role = document.getElementById("memberRole").value;

      if (!email) {
        VericaseUI.Toast.error("Please enter an email address");
        return;
      }

      try {
        const res = await fetch(`/api/workspaces/${workspaceId}/team`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ email, role })
        });

        if (!res.ok) {
          const detail = await res.json().catch(() => ({}));
          const message =
            typeof detail?.detail === "string"
              ? detail.detail
              : "Failed to add member";
          VericaseUI.Toast.error(message);
          return;
        }

        const created = await res.json().catch(() => null);
        if (created) {
          // Avoid duplicates
          const createdId = String(created.id || "");
          const createdEmail = String(created.email || email).toLowerCase();
          const already = workspaceTeam.some(
            (u) =>
              (createdId && String(u.id) === createdId) ||
              (u.email && String(u.email).toLowerCase() === createdEmail)
          );
          if (!already) workspaceTeam.push(created);
        }

        renderTeam();
        updateTabCounts();
        VericaseUI.Toast.success(`Added ${email}`);
      } catch (e) {
        console.error("Failed to add member:", e);
        VericaseUI.Toast.error("Failed to add member");
        return;
      }

      hideAddMemberModal();
      document.getElementById("memberEmail").value = '';
    }

    function removeMember(id) {
      const user = workspaceTeam.find(u => String(u.id) === String(id) || u.email === id);
      if (!user) return;
      
      if (!confirm(`Remove ${user.name || user.email} from this workspace?`)) return;

      workspaceTeam = workspaceTeam.filter(u => String(u.id) !== String(id) && u.email !== id);
      
      fetch(`/api/workspaces/${workspaceId}/team/${id}`, {
        method: 'DELETE',
        headers: getAuthHeaders()
      }).catch(() => {});

      renderTeam();
      updateTabCounts();
      VericaseUI.Toast.success("Team member removed");
    }

    // ========================================
    // COLLABORATION (Notes & Activity)
    // ========================================
    function renderNotes() {
      const container = document.getElementById("notesList");

      if (workspaceNotes.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No notes yet. Start the conversation!</p>';
        return;
      }

      container.innerHTML = workspaceNotes.map(note => `
        <div class="note-item">
          <div class="note-header">
            <span class="note-author">${escapeHtml(note.author || 'Unknown')}</span>
            <span class="note-time">${formatRelativeTime(note.created_at)}</span>
          </div>
          <div class="note-content">${escapeHtml(note.content)}</div>
        </div>
      `).join('');
    }

    async function addNote() {
      const input = document.getElementById("newNoteInput");
      const content = input.value.trim();

      if (!content) return;

      const note = {
        id: Date.now(),
        content,
        author: 'You',
        created_at: new Date().toISOString()
      };

      // Try to save to backend
      try {
        const res = await fetch(`/api/workspaces/${workspaceId}/notes`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ content })
        });
        if (res.ok) {
          const saved = await res.json();
          workspaceNotes.unshift(saved);
        } else {
          workspaceNotes.unshift(note);
        }
      } catch {
        workspaceNotes.unshift(note);
      }

      input.value = '';
      renderNotes();
      VericaseUI.Toast.success("Note added");
    }

    function renderActivity() {
      const container = document.getElementById("activityFeed");

      // Generate some mock activity if empty
      if (workspaceActivity.length === 0) {
        workspaceActivity = [
          { type: 'add', text: 'Workspace created', time: workspaceData?.created_at || new Date().toISOString() }
        ];
      }

      container.innerHTML = workspaceActivity.slice(0, 10).map(a => {
        let iconClass = '';
        let iconName = 'fa-circle';
        if (a.type === 'add') { iconClass = 'add'; iconName = 'fa-plus'; }
        else if (a.type === 'edit') { iconClass = 'edit'; iconName = 'fa-edit'; }
        else if (a.type === 'delete') { iconClass = 'delete'; iconName = 'fa-trash'; }
        else if (a.type === 'comment') { iconClass = 'comment'; iconName = 'fa-comment'; }

        return `
          <div class="activity-item">
            <div class="activity-icon ${iconClass}"><i class="fas ${iconName}"></i></div>
            <div class="activity-content">
              <div class="activity-text">${a.text}</div>
              <div class="activity-time">${formatRelativeTime(a.time)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========================================
    // MODALS
    // ========================================
    function showAddModal() {
      document.getElementById("addModal").style.display = "flex";
    }

    function hideAddModal() {
      document.getElementById("addModal").style.display = "none";
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
      }
    });

    // ========================================
    // HELPERS
    // ========================================
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function sanitizeUrl(url) {
      try {
        const u = String(url || "").trim();
        if (!u) return null;
        if (/^(https?:\/\/|mailto:)/i.test(u)) return u;
        return null;
      } catch {
        return null;
      }
    }

    function renderInline(rawText) {
      let t = escapeHtml(rawText);

      // Inline code
      t = t.replace(/`([^`]+)`/g, "<code>$1</code>");

      // Links: [text](url)
      t = t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (m, label, url) => {
        const safe = sanitizeUrl(url);
        if (!safe) return label;
        return `<a href="${escapeHtml(safe)}" target="_blank" rel="noopener noreferrer">${label}</a>`;
      });

      // Bold - improved pattern to handle text like **Word:** correctly
      t = t.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

      // Italic
      t = t.replace(/(^|[^*])\*([^*]+?)\*(?!\*)/g, "$1<em>$2</em>");

      return t;
    }

    function renderMarkdown(markdown) {
      const src = String(markdown || "").replace(/\r\n/g, "\n");
      const lines = src.split("\n");

      const out = [];
      let inCodeBlock = false;
      let codeLang = "";
      let codeLines = [];
      let listType = null; // 'ul' | 'ol' | null
      let paragraphLines = [];

      function flushParagraph() {
        const text = paragraphLines.join(" ").trim();
        if (text) out.push(`<p>${renderInline(text)}</p>`);
        paragraphLines = [];
      }

      function closeList() {
        if (listType) {
          out.push(`</${listType}>`);
          listType = null;
        }
      }

      function openList(type) {
        if (listType !== type) {
          closeList();
          out.push(`<${type}>`);
          listType = type;
        }
      }

      for (const rawLine of lines) {
        const line = String(rawLine ?? "");
        const trimmed = line.trim();

        if (inCodeBlock) {
          if (trimmed.startsWith("```")) {
            const code = escapeHtml(codeLines.join("\n"));
            const langClass = codeLang ? ` language-${escapeHtml(codeLang)}` : "";
            out.push(`<pre><code class="${langClass.trim()}">${code}</code></pre>`);
            inCodeBlock = false;
            codeLang = "";
            codeLines = [];
          } else {
            codeLines.push(line);
          }
          continue;
        }

        if (trimmed.startsWith("```")) {
          flushParagraph();
          closeList();
          inCodeBlock = true;
          codeLang = trimmed.slice(3).trim();
          codeLines = [];
          continue;
        }

        if (!trimmed) {
          flushParagraph();
          closeList();
          continue;
        }

        if (trimmed === "---" || trimmed === "***") {
          flushParagraph();
          closeList();
          out.push("<hr>");
          continue;
        }

        // Support h1-h6 headers (map h4-h6 to h4 for styling consistency)
        const headingMatch = trimmed.match(/^(#{1,6})\s+(.+)$/);
        if (headingMatch) {
          flushParagraph();
          closeList();
          const rawLevel = headingMatch[1].length;
          const level = Math.min(rawLevel, 4); // Cap at h4 for styling
          const text = headingMatch[2];
          out.push(`<h${level}>${renderInline(text)}</h${level}>`);
          continue;
        }

        const bqMatch = trimmed.match(/^>\s?(.*)$/);
        if (bqMatch) {
          flushParagraph();
          closeList();
          out.push(`<blockquote><p>${renderInline(bqMatch[1])}</p></blockquote>`);
          continue;
        }

        const olMatch = trimmed.match(/^(\d+)\.\s+(.+)$/);
        if (olMatch) {
          flushParagraph();
          openList("ol");
          out.push(`<li>${renderInline(olMatch[2])}</li>`);
          continue;
        }

        const ulMatch = trimmed.match(/^[-*]\s+(.+)$/);
        if (ulMatch) {
          flushParagraph();
          openList("ul");
          out.push(`<li>${renderInline(ulMatch[1])}</li>`);
          continue;
        }

        closeList();
        paragraphLines.push(trimmed);
      }

      if (inCodeBlock) {
        const code = escapeHtml(codeLines.join("\n"));
        const langClass = codeLang ? ` language-${escapeHtml(codeLang)}` : "";
        out.push(`<pre><code class="${langClass.trim()}">${code}</code></pre>`);
      }
      flushParagraph();
      closeList();

      return out.join("\n");
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return dateStr;
      return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatRelativeTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
      return formatDate(dateStr);
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      let i = 0;
      while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
      }
      return `${bytes.toFixed(1)} ${units[i]}`;
    }

    function getInitials(name) {
      if (!name) return '?';
      return name.split(/[\s@]+/).map(w => w[0]).join('').toUpperCase().slice(0, 2);
    }
  </script>
</body>

</html>

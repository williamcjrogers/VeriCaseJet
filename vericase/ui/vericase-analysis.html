<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeriCase Analysis</title>
    <link
      rel="stylesheet"
      href="./assets/fontawesome/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <!-- VeriCase Design System -->
    <link rel="stylesheet" href="brand-styles.css?v=6" />
    <link rel="stylesheet" href="design-system.css?v=6" />
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>
    <script src="config.js"></script>
    <script src="app-state.js"></script>
    <style>
      :root {
        /* Aliases used by this page (mapped to the global design tokens) */
        --vc-teal: var(--vericase-teal);
        --vc-teal-dark: var(--vericase-teal-dark);
        --vc-teal-light: var(--vericase-teal-light);
        --vc-navy: var(--vericase-navy);
        --vc-navy-dark: var(--vericase-navy-light);
        --vc-gold: var(--vericase-gold);
        --vc-gold-light: var(--vericase-gold-light);

        /* Page-local helpers */
        --bg-card: var(--bg-white);
        --text-inverse: var(--text-inverted);
        --accent-primary: var(--vericase-teal);
        --accent-secondary: var(--vericase-gold);
        --accent-success: var(--success);
        --accent-warning: var(--warning);
        --accent-danger: var(--error);
        --border-color: var(--border-default);
        --border-subtle: rgba(15, 23, 42, 0.08);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-sans);
        background: var(--bg-primary);
        color: var(--text-secondary);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Subtle background pattern */
      .bg-pattern {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background:
          linear-gradient(135deg, rgba(var(--vericase-teal-rgb), 0.03) 0%, transparent 50%),
          linear-gradient(225deg, rgba(139, 115, 85, 0.03) 0%, transparent 50%);
        pointer-events: none;
      }

      /* Header */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 2rem;
        background: var(--bg-header);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      /* Hide custom header when app-shell is active */
      .app-shell .header {
        display: none;
      }

      /* Adjust hero padding when shell is active */
      .app-shell .hero {
        padding-top: 1rem;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: "DM Sans", sans-serif;
        font-weight: 700;
        font-size: 1.5rem;
        text-decoration: none;
      }

      .logo img {
        height: 36px;
        width: auto;
      }

      .logo-veri {
        color: var(--vc-teal-light);
      }

      .logo-case {
        color: var(--text-inverse);
      }

      .tagline {
        font-family: "Cormorant Garamond", Georgia, serif;
        font-style: italic;
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.7);
        letter-spacing: 0.02em;
      }

      .nav-links {
        display: flex;
        gap: 2rem;
        align-items: center;
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
        letter-spacing: 0.01em;
      }

      .nav-link:hover {
        color: var(--text-inverse);
      }

      .nav-cta {
        padding: 0.5rem 1.25rem;
        background: var(--vc-teal);
        border-radius: 6px;
        color: white;
        font-weight: 600;
      }

      .nav-cta:hover {
        background: var(--vc-teal-light);
      }

      /* Main container */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2.5rem;
      }

      /* Hero section */
      .hero {
        text-align: center;
        padding: 2.5rem 0 1.5rem;
        max-width: 720px;
      }

      .hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(var(--vericase-teal-rgb), 0.08);
        border: 1px solid rgba(var(--vericase-teal-rgb), 0.2);
        border-radius: 100px;
        font-size: 0.6875rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--vc-teal-dark);
        margin-bottom: 1.5rem;
      }

      .hero-badge i {
        font-size: 0.75rem;
      }

      .hero-title {
        font-family: "DM Sans", sans-serif;
        font-size: 2.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--vc-navy);
        letter-spacing: -0.02em;
      }

      .hero-title-accent {
        font-family: "Cormorant Garamond", Georgia, serif;
        font-style: italic;
        font-weight: 500;
        color: var(--vc-gold);
      }

      .hero-subtitle {
        font-size: 1.125rem;
        color: var(--text-secondary);
        max-width: 680px;
        margin: 1rem auto 0;
        line-height: 1.7;
      }

      /* Research form */
      .research-form {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-card);
        max-width: 720px;
        margin-left: auto;
        margin-right: auto;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
      }

      .form-input {
        width: 100%;
        padding: 0.875rem 1rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 0.9375rem;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .form-input::placeholder {
        color: var(--text-muted);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.12);
      }

      .form-textarea {
        min-height: 140px;
        resize: vertical;
        line-height: 1.6;
      }

      .form-hint {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
      }

      .focus-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .focus-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 0.875rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 100px;
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }

      .focus-tag:hover {
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        background: rgba(var(--vericase-teal-rgb), 0.04);
      }

      .focus-tag.active {
        background: rgba(var(--vericase-teal-rgb), 0.1);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
      }

      .focus-tag i {
        font-size: 0.75rem;
        opacity: 0.8;
      }

      .btn-start {
        width: 100%;
        padding: 1rem 2rem;
        background: var(--vc-teal);
        border: none;
        border-radius: 8px;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        letter-spacing: 0.01em;
      }

      .btn-start:hover {
        background: var(--vc-teal-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(var(--vericase-teal-rgb), 0.25);
      }

      .btn-start:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Research session panel */
      .session-panel {
        display: none;
      }

      .session-panel.active {
        display: block;
      }

      /* Status card */
      .status-card {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-card);
        max-width: 720px;
        margin-left: auto;
        margin-right: auto;
      }

      .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .status-title {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-primary);
      }

      .status-title i {
        color: var(--vc-teal);
      }

      .status-badge {
        padding: 0.25rem 0.875rem;
        border-radius: 100px;
        font-size: 0.6875rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .status-badge.pending {
        background: rgba(107, 114, 128, 0.1);
        color: var(--text-muted);
      }

      .status-badge.planning {
        background: rgba(var(--vericase-teal-rgb), 0.1);
        color: var(--vc-teal);
      }

      .status-badge.awaiting_approval {
        background: rgba(217, 119, 6, 0.1);
        color: var(--accent-warning);
      }

      .status-badge.researching {
        background: rgba(139, 115, 85, 0.1);
        color: var(--vc-gold);
      }

      .status-badge.synthesizing {
        background: rgba(5, 150, 105, 0.1);
        color: var(--accent-success);
      }

      .status-badge.completed {
        background: rgba(5, 150, 105, 0.1);
        color: var(--accent-success);
      }

      .status-badge.failed {
        background: rgba(220, 38, 38, 0.1);
        color: var(--accent-danger);
      }

      /* Progress bar */
      .progress-container {
        margin-top: 1rem;
      }

      .progress-bar {
        height: 6px;
        background: var(--bg-tertiary);
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--vc-teal),
          var(--vc-teal-light)
        );
        border-radius: 3px;
        transition: width 0.5s ease;
      }

      .progress-text {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      /* Plan review */
      .plan-review {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-card);
        max-width: 720px;
        margin-left: auto;
        margin-right: auto;
      }

      .plan-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
      }

      .plan-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
      }

      .plan-problem {
        color: var(--text-secondary);
        font-size: 0.9375rem;
        line-height: 1.6;
      }

      .plan-angles {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
      }

      .angle-tag {
        padding: 0.375rem 0.875rem;
        background: rgba(139, 115, 85, 0.08);
        border: 1px solid rgba(139, 115, 85, 0.2);
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--vc-gold);
      }

      /* Question DAG visualization */
      .questions-dag {
        margin-top: 1.5rem;
      }

      .dag-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .dag-title i {
        color: var(--vc-teal);
      }

      .question-node {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        position: relative;
      }

      .question-node::before {
        content: "";
        position: absolute;
        left: 28px;
        top: 100%;
        width: 2px;
        height: 12px;
        background: var(--border-color);
      }

      .question-node:last-child::before {
        display: none;
      }

      /* New icon-based question styling */
      .question-icon-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.35rem;
        flex-shrink: 0;
      }

      .question-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1.5px solid;
        transition: all 0.2s ease;
      }

      .question-icon i {
        font-size: 1rem;
      }

      .question-node:hover .question-icon {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .question-number {
        font-size: 0.65rem;
        font-weight: 700;
        color: var(--text-muted);
        font-family: "JetBrains Mono", monospace;
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }

      /* Legacy status styles - kept for compatibility */
      .question-status {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.875rem;
      }

      .question-status.pending {
        background: var(--bg-tertiary);
        border: 2px solid var(--border-color);
        color: var(--text-muted);
      }

      .question-status.in-progress {
        background: rgba(var(--vericase-teal-rgb), 0.1);
        border: 2px solid var(--vc-teal);
        color: var(--vc-teal);
        animation: pulse 2s infinite;
      }

      .question-status.completed {
        background: rgba(5, 150, 105, 0.1);
        border: 2px solid var(--accent-success);
        color: var(--accent-success);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.5;
        }
      }

      .question-content {
        flex: 1;
        min-width: 0;
      }

      .question-text {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.35rem;
        line-height: 1.4;
      }

      .question-rationale {
        font-size: 0.8125rem;
        color: var(--text-muted);
        line-height: 1.55;
      }

      .question-footer {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 0.65rem;
        flex-wrap: wrap;
      }

      .question-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.65rem;
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      .question-status-badge.pending {
        background: rgba(107, 114, 128, 0.1);
        color: var(--text-muted);
      }

      .question-status-badge.in-progress {
        background: rgba(var(--vericase-teal-rgb), 0.12);
        color: var(--vc-teal);
      }

      .question-status-badge.completed {
        background: rgba(5, 150, 105, 0.12);
        color: var(--accent-success);
      }

      .question-status-badge i {
        font-size: 0.65rem;
      }

      .question-deps {
        display: flex;
        gap: 0.375rem;
        align-items: center;
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .question-deps i {
        font-size: 0.7rem;
        opacity: 0.7;
      }

      .dep-badge {
        padding: 0.15rem 0.5rem;
        background: var(--bg-tertiary);
        border-radius: 4px;
        font-size: 0.6875rem;
        color: var(--text-muted);
        font-family: "JetBrains Mono", monospace;
        font-weight: 500;
      }

      /* Angle tags with icons */
      .angle-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.9rem;
        background: rgba(139, 115, 85, 0.08);
        border: 1px solid rgba(139, 115, 85, 0.2);
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--vc-gold);
      }

      .angle-tag i {
        font-size: 0.7rem;
        opacity: 0.85;
      }

      /* Plan actions */
      .plan-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
      }

      .btn-approve {
        flex: 1;
        padding: 0.875rem 1.5rem;
        background: var(--vc-teal);
        border: none;
        border-radius: 8px;
        color: white;
        font-family: inherit;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
      }

      .btn-approve:hover {
        background: var(--vc-teal-dark);
        transform: translateY(-1px);
      }

      .btn-modify {
        flex: 1;
        padding: 0.875rem 1.5rem;
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        font-family: inherit;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
      }

      .btn-modify:hover {
        border-color: var(--accent-warning);
        color: var(--accent-warning);
        background: rgba(217, 119, 6, 0.04);
      }

      /* Modification modal */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(26, 43, 60, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: var(--shadow-lg);
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      /* Report display */
      .report-container {
        background: var(--bg-card);
        border-radius: 16px;
        border: 2px solid var(--vc-teal);
        padding: 0;
        box-shadow: 0 8px 32px rgba(var(--vericase-teal-rgb), 0.12);
        max-width: 780px;
        margin-left: auto;
        margin-right: auto;
        overflow: hidden;
      }

      .report-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, rgba(var(--vericase-teal-rgb), 0.06) 0%, rgba(139, 115, 85, 0.04) 100%);
        border-bottom: 1px solid var(--border-color);
      }

      .report-header-content {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
      }

      .report-header-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--vc-teal) 0%, #0d7377 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .report-header-icon i {
        color: white;
        font-size: 1.25rem;
      }

      .report-title {
        font-family: "DM Sans", sans-serif;
        font-size: 1.375rem;
        font-weight: 700;
        margin-bottom: 0.35rem;
        color: var(--text-primary);
        line-height: 1.3;
      }

      .report-meta {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .report-meta-item {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .report-meta-item i {
        font-size: 0.7rem;
        opacity: 0.7;
      }

      .report-actions {
        display: flex;
        gap: 0.5rem;
      }

      .btn-icon {
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-icon:hover {
        border-color: var(--vc-teal);
        color: var(--vc-teal);
        background: rgba(var(--vericase-teal-rgb), 0.04);
        transform: translateY(-1px);
      }

      .report-body {
        padding: 2rem;
      }

      .report-themes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }

      .theme-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.9rem;
        background: rgba(var(--vericase-teal-rgb), 0.08);
        border: 1px solid rgba(var(--vericase-teal-rgb), 0.2);
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--vc-teal);
      }

      .theme-tag::before {
        content: "#";
        opacity: 0.6;
      }

      .report-content {
        font-size: 0.9375rem;
        line-height: 1.85;
        color: var(--text-secondary);
      }

      .report-content h1 {
        font-family: "DM Sans", sans-serif;
        font-size: 1.5rem;
        color: var(--text-primary);
        margin: 2rem 0 1rem;
        font-weight: 700;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(var(--vericase-teal-rgb), 0.15);
      }

      .report-content h2 {
        font-family: "DM Sans", sans-serif;
        font-size: 1.25rem;
        color: var(--text-primary);
        margin: 1.75rem 0 0.75rem;
        font-weight: 700;
      }

      .report-content h3 {
        font-size: 1.0625rem;
        color: var(--text-primary);
        margin: 1.25rem 0 0.5rem;
        font-weight: 600;
      }

      .report-content h4 {
        font-size: 0.95rem;
        color: var(--vc-gold);
        margin: 1rem 0 0.4rem;
        font-weight: 600;
      }

      .report-content p {
        margin-bottom: 1rem;
      }

      .report-content ul,
      .report-content ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
      }

      .report-content li {
        margin-bottom: 0.5rem;
        position: relative;
      }

      .report-content strong {
        color: var(--text-primary);
        font-weight: 600;
      }

      .report-content blockquote {
        margin: 1.25rem 0;
        padding: 1rem 1.25rem;
        background: rgba(var(--vericase-teal-rgb), 0.04);
        border-left: 4px solid var(--vc-teal);
        border-radius: 0 10px 10px 0;
        font-style: italic;
      }

      .report-content hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 2rem 0;
      }

      .report-content code {
        background: var(--bg-tertiary);
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.85em;
        color: var(--vc-teal-dark);
      }

      /* History sidebar */
      .history-panel {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-card);
      }

      .history-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-primary);
      }

      .history-title i {
        color: var(--vc-teal);
      }

      .history-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--bg-primary);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
      }

      .history-item:hover {
        background: var(--bg-tertiary);
        border-color: var(--border-color);
      }

      .history-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(var(--vericase-teal-rgb), 0.08);
        color: var(--vc-teal);
        flex-shrink: 0;
      }

      .history-content {
        flex: 1;
        min-width: 0;
      }

      .history-topic {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .history-date {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.125rem;
      }

      /* Loading spinner */
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Layout grid */
      .layout-grid {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 2.5rem;
        align-items: start;
      }

      .main-content {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .main-content > * {
        width: 100%;
      }

      @media (max-width: 1024px) {
        .layout-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Markdown rendering */
      .markdown-body {
        font-size: 0.9375rem;
        line-height: 1.8;
      }

      .markdown-body h1 {
        font-size: 1.75rem;
        margin: 2rem 0 1rem;
        color: var(--text-primary);
        font-weight: 600;
      }

      .markdown-body h2 {
        font-size: 1.375rem;
        margin: 1.5rem 0 0.75rem;
        color: var(--text-primary);
        font-weight: 600;
      }

      .markdown-body h3 {
        font-size: 1.125rem;
        margin: 1rem 0 0.5rem;
        color: var(--text-primary);
        font-weight: 600;
      }

      .markdown-body p {
        margin-bottom: 1rem;
      }

      .markdown-body ul,
      .markdown-body ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
      }

      .markdown-body li {
        margin-bottom: 0.5rem;
      }

      .markdown-body strong {
        color: var(--text-primary);
        font-weight: 600;
      }

      .markdown-body em {
        font-family: "Cormorant Garamond", Georgia, serif;
        font-style: italic;
        color: var(--vc-gold);
      }

      .markdown-body code {
        background: var(--bg-tertiary);
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8125rem;
        color: var(--vc-teal-dark);
      }

      .markdown-body pre {
        background: var(--bg-tertiary);
        padding: 1rem;
        border-radius: 10px;
        overflow-x: auto;
        border: 1px solid rgba(255, 255, 255, 0.08);
        margin: 1rem 0;
      }

      .markdown-body pre code {
        background: transparent;
        padding: 0;
        border-radius: 0;
        display: block;
        color: var(--text-primary);
        font-size: 0.8125rem;
        line-height: 1.6;
      }

      .markdown-body a {
        color: var(--vc-teal-dark);
        text-decoration: underline;
        text-underline-offset: 2px;
      }

      .markdown-body blockquote {
        border-left: 3px solid var(--vc-teal);
        padding-left: 1rem;
        margin: 1rem 0;
        color: var(--text-secondary);
        font-style: italic;
      }

      .markdown-body hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 2rem 0;
      }

      /* Focus tag icons adjustments */
      .focus-tag i {
        width: 14px;
        text-align: center;
      }

      /* Footer */
      .footer-tagline {
        text-align: center;
        padding: 2rem;
        font-family: "Cormorant Garamond", Georgia, serif;
        font-style: italic;
        font-size: 1rem;
        color: var(--text-muted);
        border-top: 1px solid var(--border-color);
        margin-top: 3rem;
      }
    </style>
  </head>

  <body>
    <div class="bg-pattern"></div>

    <header class="header">
      <div style="display: flex; align-items: center; gap: 2rem">
        <a href="dashboard.html" class="logo">
          <img src="assets/LOGOTOBEUSED.png" alt="VeriCase" style="height: 36px;" />
        </a>
        <span class="tagline">"Records, Records, VeriCase"</span>
      </div>
      <nav class="nav-links">
        <a href="dashboard.html" class="nav-link">Platform</a>
        <a href="correspondence-enterprise.html" class="nav-link">Correspondence</a>
        <a href="evidence.html" class="nav-link">Evidence</a>
      </nav>
    </header>

    <main class="container">
      <div class="layout-grid">
        <div class="main-content">
          <section class="hero">
            <div class="hero-badge">
              <i class="fas fa-microscope"></i>
              Evidence Intelligence Platform
            </div>
            <h1 class="hero-title">
              Deep <span class="hero-title-accent">Analysis</span>
            </h1>
            <p class="hero-subtitle">
              Go beyond simple search. Create strategic research plans,
              investigate in parallel, and synthesize comprehensive reports
              from your evidence.
            </p>
          </section>
          <!-- Research Form -->
          <section id="researchForm" class="research-form">
            <div class="form-group">
              <label class="form-label" for="topicInput">Research Topic</label>
              <textarea
                id="topicInput"
                class="form-input form-textarea"
                placeholder="Describe what you want to investigate. Be specific about the scope, time period, and key questions you need answered.

Example: Investigate the delay claims on the Northern Rail Extension project between March 2022 and September 2023. Focus on contractor communications, variation orders, and programme impacts."
              ></textarea>
              <p class="form-hint">
                The more context you provide, the better the research plan will
                be.
              </p>
            </div>

            <div class="form-group">
              <label class="form-label">Focus Areas (optional)</label>
              <div class="focus-tags" id="focusTags">
                <span class="focus-tag" data-focus="chronology">
                  <i class="fas fa-clock"></i> Chronology
                </span>
                <span class="focus-tag" data-focus="causation">
                  <i class="fas fa-link"></i> Causation
                </span>
                <span class="focus-tag" data-focus="liability">
                  <i class="fas fa-gavel"></i> Liability
                </span>
                <span class="focus-tag" data-focus="quantum">
                  <i class="fas fa-calculator"></i> Quantum
                </span>
                <span class="focus-tag" data-focus="communications">
                  <i class="fas fa-envelope"></i> Communications
                </span>
                <span class="focus-tag" data-focus="variations">
                  <i class="fas fa-exchange-alt"></i> Variations
                </span>
                <span class="focus-tag" data-focus="programme">
                  <i class="fas fa-calendar-alt"></i> Programme
                </span>
                <span class="focus-tag" data-focus="witnesses">
                  <i class="fas fa-id-badge"></i> Key Witnesses
                </span>
              </div>
            </div>

            <button id="btnStartResearch" class="btn-start">
              <i class="fas fa-rocket"></i>
              Start Analysis
            </button>
          </section>

          <!-- Session Panel -->
          <section id="sessionPanel" class="session-panel">
            <!-- Status Card -->
            <div class="status-card">
              <div class="status-header">
                <span class="status-title">
                  <i class="fas fa-flask"></i>
                  Research Session
                </span>
                <span id="statusBadge" class="status-badge pending"
                  >Pending</span
                >
              </div>
              <p
                id="statusMessage"
                style="font-size: 0.9375rem; color: var(--text-secondary)"
              >
                Initializing research session...
              </p>
              <div class="progress-container">
                <div class="progress-bar">
                  <div
                    id="progressFill"
                    class="progress-fill"
                    style="width: 0"
                  ></div>
                </div>
                <div class="progress-text">
                  <span id="progressText">0 / 0 questions</span>
                  <span id="timeElapsed">0s elapsed</span>
                </div>
              </div>
            </div>

            <!-- Plan Review -->
            <div id="planReview" class="plan-review" style="display: none">
              <div class="plan-header">
                <div>
                  <h3 class="plan-title">Research Plan</h3>
                  <p id="planProblem" class="plan-problem"></p>
                </div>
              </div>

              <div id="planAngles" class="plan-angles"></div>

              <div class="questions-dag">
                <h4 class="dag-title">
                  <i class="fas fa-project-diagram"></i>
                  Research Questions (DAG)
                </h4>
                <div id="questionsContainer"></div>
              </div>

              <div class="plan-actions">
                <button id="btnApprove" class="btn-approve">
                  <i class="fas fa-check"></i>
                  Approve & Start Research
                </button>
                <button id="btnModify" class="btn-modify">
                  <i class="fas fa-edit"></i>
                  Request Changes
                </button>
              </div>
            </div>

            <!-- Report Container -->
            <div
              id="reportContainer"
              class="report-container"
              style="display: none"
            >
              <div class="report-header">
                <div class="report-header-content">
                  <div class="report-header-icon">
                    <i class="fas fa-file-alt"></i>
                  </div>
                  <div>
                    <h2 class="report-title">Deep Analysis Report</h2>
                    <div class="report-meta" id="reportMeta"></div>
                  </div>
                </div>
                <div class="report-actions">
                  <button
                    class="btn-icon"
                    onclick="copyReport()"
                    title="Copy to clipboard"
                  >
                    <i class="fas fa-copy"></i>
                  </button>
                  <button
                    class="btn-icon"
                    onclick="downloadReport()"
                    title="Download as text"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                  <button
                    class="btn-icon"
                    onclick="startNewResearch()"
                    title="New Research"
                  >
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>

              <div class="report-body">
                <div id="reportThemes" class="report-themes"></div>
                <div
                  id="reportContent"
                  class="report-content markdown-body"
                ></div>
              </div>
            </div>
          </section>
        </div>

        <!-- History Sidebar -->
        <aside>
          <div class="history-panel">
            <h3 class="history-title">
              <i class="fas fa-history"></i>
              Recent Research
            </h3>
            <div id="historyList">
              <p style="font-size: 0.875rem; color: var(--text-muted)">
                No previous research sessions.
              </p>
            </div>
          </div>
        </aside>
      </div>

      <footer class="footer-tagline">
        "Transform Complex Evidence Into Compelling Legal Arguments"
      </footer>
    </main>

    <!-- Modification Modal -->
    <div id="modifyModal" class="modal-overlay">
      <div class="modal">
        <h3 class="modal-title">Request Plan Changes</h3>
        <label
          for="modifyInput"
          style="
            font-size: 0.9375rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: block;
          "
        >
          Describe what changes you'd like to the research plan. The system will
          regenerate the plan based on your feedback.
        </label>
        <textarea
          id="modifyInput"
          class="form-input form-textarea"
          placeholder="E.g., Focus more on the contractual obligations. Include more questions about the delay notification process."
        ></textarea>
        <div class="modal-actions">
          <button class="btn-modify" onclick="closeModifyModal()">
            Cancel
          </button>
          <button class="btn-approve" onclick="submitModification()">
            <i class="fas fa-sync"></i>
            Regenerate Plan
          </button>
        </div>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="security.js"></script>
    <script>
      // State
      let currentSessionId = null;
      let selectedFocusAreas = [];
      let pollInterval = null;
      let startTime = null;
      let currentProjectId = null;
      let currentCaseId = null;

      // Get project/case ID from URL params
      const urlParams = new URLSearchParams(window.location.search);
      currentProjectId =
        urlParams.get("projectId") || urlParams.get("project_id");
      currentCaseId =
        urlParams.get("caseId") || urlParams.get("case_id");

      // DOM Elements
      const topicInput = document.getElementById("topicInput");
      const btnStartResearch = document.getElementById("btnStartResearch");
      const researchForm = document.getElementById("researchForm");
      const sessionPanel = document.getElementById("sessionPanel");
      const statusBadge = document.getElementById("statusBadge");
      const statusMessage = document.getElementById("statusMessage");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      const timeElapsed = document.getElementById("timeElapsed");
      const planReview = document.getElementById("planReview");
      const reportContainer = document.getElementById("reportContainer");

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        // Inject navigation shell
        if (window.VericaseShell) {
          const ctx =
            typeof window.VericaseShell.getContext === "function"
              ? window.VericaseShell.getContext()
              : { type: "project", id: window.VericaseShell.getProjectId() };
          const ctxType = ctx?.type === "case" ? "case" : "project";
          const ctxLabel =
            ctxType === "case" ? "Case Overview" : "Project Overview";
          const ctxIcon = ctxType === "case" ? "fa-briefcase" : "fa-diagram-project";
          const ctxId = ctx?.id ? String(ctx.id) : "";
          const ctxUrl = ctxId
            ? `projectdashboard.html?${ctxType === "case" ? "caseId" : "projectId"}=${encodeURIComponent(ctxId)}`
            : "projectdashboard.html";

          window.VericaseShell.inject({
            title: '',
            breadcrumbs: [
              { label: "Control Centre", url: "control-centre.html", icon: "fa-compass" },
              { label: "Workspaces", url: "workspace-hub.html", icon: "fa-layer-group" },
              { label: ctxLabel, url: ctxUrl, icon: ctxIcon },
              { label: "Deep Analysis", icon: "fa-microscope" }
            ]
          });
        }

        loadHistory();
        setupFocusTags();
        
        // If we have a caseId, first fetch the case to get its linked project
        if (currentCaseId && !currentProjectId) {
          await loadCaseLinkedProject();
        }
        
        await loadProjectSelector();

        // If project ID in URL or from case, pre-select it
        if (currentProjectId) {
          const projectSelect = document.getElementById("projectSelect");
          if (projectSelect) {
            projectSelect.value = currentProjectId;
          }
        }
      });
      
      // Fetch case and extract linked project_id
      async function loadCaseLinkedProject() {
        if (!currentCaseId) return;
        
        try {
          const response = await secureApiFetch(`/api/cases/${currentCaseId}`);
          if (!response.ok) {
            console.warn("Could not fetch case:", response.status);
            return;
          }
          
          const caseData = await response.json();
          if (caseData.project_id) {
            currentProjectId = caseData.project_id;
            console.log("Loaded project from case:", currentProjectId);
          }
        } catch (error) {
          console.error("Error loading case:", error);
        }
      }

      // Load projects for selector
      async function loadProjectSelector() {
        try {
          // If we have a caseId, load projects for that case
          // Otherwise, load all projects (legacy behavior)
          let apiUrl = "/api/projects";
          if (currentCaseId) {
            apiUrl = `/api/cases/${currentCaseId}/projects`;
          }
          
          const response = await secureApiFetch(apiUrl);
          if (!response.ok) {
            console.error("Failed to load projects:", response.status);
            return;
          }

          const data = await response.json();
          const projects = data.projects || data || [];

          // If currentProjectId is set (from URL/context) and valid, skip showing the selector
          // This respects the "no need for a dropdown" when in project context
          if (currentProjectId && projects.some(p => String(p.id) === String(currentProjectId))) {
            return;
          }

          // Create project selector if it doesn't exist
          let projectSelect = document.getElementById("projectSelect");
          if (!projectSelect) {
            // Insert project selector before the topic input
            const formGroup = document.createElement("div");
            formGroup.className = "form-group";
            formGroup.style.marginBottom = "1.5rem";
            formGroup.innerHTML = `
                        <label class="form-label">Select Project</label>
                        <select id="projectSelect" class="form-input" style="cursor: pointer;">
                            <option value="">-- Select a project --</option>
                            ${projects.map((p) => `<option value="${p.id}">${p.project_name || p.name || "Unnamed Project"}</option>`).join("")}
                        </select>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Deep research will analyze emails and documents from this project.
                        </p>
                    `;

            const topicGroup = topicInput ? topicInput.closest(".form-group") : null;
            if (topicGroup && topicGroup.parentNode) {
              topicGroup.parentNode.insertBefore(formGroup, topicGroup);
            } else {
              // Fallback: append to main form
              const mainForm = document.querySelector('.research-form') || document.querySelector('form');
              if (mainForm) mainForm.prepend(formGroup);
            }

            projectSelect = document.getElementById("projectSelect");
          } else {
            // Update existing select with new options
            projectSelect.innerHTML = `
              <option value="">-- Select a project --</option>
              ${projects.map((p) => `<option value="${p.id}">${p.project_name || p.name || "Unnamed Project"}</option>`).join("")}
            `;
          }

          // Update on change - with null check
          if (projectSelect) {
            projectSelect.addEventListener("change", (e) => {
              currentProjectId = e.target.value || null;
            });
          }

          // If only one project, auto-select it
          if (projects.length === 1) {
            currentProjectId = projects[0].id;
            if (projectSelect) {
              projectSelect.value = currentProjectId;
            }
          }
        } catch (error) {
          console.error("Error loading projects:", error);
        }
      }

      // Focus tag selection
      function setupFocusTags() {
        document.querySelectorAll(".focus-tag").forEach((tag) => {
          tag.addEventListener("click", () => {
            tag.classList.toggle("active");
            const focus = tag.dataset.focus;
            if (tag.classList.contains("active")) {
              selectedFocusAreas.push(focus);
            } else {
              selectedFocusAreas = selectedFocusAreas.filter(
                (f) => f !== focus,
              );
            }
          });
        });
      }

      // Start research
      btnStartResearch.addEventListener("click", async () => {
        const topic = topicInput.value.trim();
        if (!topic) {
          alert("Please enter a research topic");
          return;
        }

        btnStartResearch.disabled = true;
        btnStartResearch.innerHTML =
          '<span class="spinner"></span> Starting...';

        // Validate project selection
        if (!currentProjectId) {
          alert("Please select a project first");
          btnStartResearch.disabled = false;
          btnStartResearch.innerHTML =
            '<i class="fas fa-rocket"></i> Start Analysis';
          return;
        }

        try {
          const payload = {
            topic: topic,
            project_id: currentProjectId,
            case_id: currentCaseId,
            focus_areas: selectedFocusAreas,
          };

          const response = await secureApiFetch(`/api/vericase-analysis/start`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || "Failed to start research");
          }

          const data = await response.json();
          currentSessionId = data.session_id;
          startTime = Date.now();

          // Switch to session view
          researchForm.style.display = "none";
          sessionPanel.classList.add("active");

          // Start polling
          startPolling();
        } catch (error) {
          console.error("Error starting research:", error);
          alert("Failed to start research: " + error.message);
        } finally {
          btnStartResearch.disabled = false;
          btnStartResearch.innerHTML =
            '<i class="fas fa-rocket"></i> Start Analysis';
        }
      });

      // Poll for status with exponential backoff
      let pollDelay = 2000; // Start at 2 seconds
      const MAX_POLL_DELAY = 10000; // Max 10 seconds between polls

      function startPolling() {
        pollDelay = 2000; // Reset delay on new poll session
        scheduleNextPoll();
      }

      function scheduleNextPoll() {
        pollInterval = setTimeout(async () => {
          const wasActive = await updateStatus();
          // If still actively processing, increase delay with exponential backoff
          if (wasActive) {
            pollDelay = Math.min(pollDelay * 1.5, MAX_POLL_DELAY);
            scheduleNextPoll();
          }
        }, pollDelay);
      }

      function stopPolling() {
        if (pollInterval) {
          clearTimeout(pollInterval);
          pollInterval = null;
        }
      }

      async function updateStatus() {
        if (!currentSessionId) return false;

        try {
          const response = await secureApiFetch(
            `/api/vericase-analysis/status/${currentSessionId}`,
          );
          if (!response.ok) throw new Error("Failed to get status");

          const data = await response.json();
          updateUI(data);

          // Return false (stop polling) if completed, failed, or cancelled
          if (["completed", "failed", "cancelled"].includes(data.status)) {
            stopPolling();
            return false;
          }
          return true; // Still active, continue polling
        } catch (error) {
          console.error("Error polling status:", error);
          return true; // Keep trying on error
        }
      }

      function updateUI(data) {
        // Update status badge
        statusBadge.textContent = data.status.replace("_", " ");
        statusBadge.className = `status-badge ${data.status}`;

        // Update time elapsed
        if (startTime) {
          const elapsed = Math.round((Date.now() - startTime) / 1000);
          timeElapsed.textContent = `${elapsed}s elapsed`;
        }

        // Update based on status
        switch (data.status) {
          case "pending":
            statusMessage.textContent = "Initializing research session...";
            break;

          case "planning":
            statusMessage.textContent =
              "Analyzing your topic and creating a research strategy...";
            progressFill.style.width = "15%";
            break;

          case "awaiting_approval":
            statusMessage.textContent = "Research plan ready for your review.";
            progressFill.style.width = "25%";
            showPlanReview(data.plan);
            break;

          case "researching":
            const completed = data.progress.completed_questions || 0;
            const total = data.progress.total_questions || 1;
            const pct = 25 + (completed / total) * 50;
            progressFill.style.width = `${pct}%`;
            progressText.textContent = `${completed} / ${total} questions`;
            statusMessage.textContent = `Investigating research questions in parallel...`;
            updateQuestionProgress(data.plan);
            break;

          case "synthesizing":
            statusMessage.textContent =
              "Synthesizing findings into comprehensive report...";
            progressFill.style.width = "85%";
            break;

          case "completed":
            statusMessage.textContent = "Research complete!";
            progressFill.style.width = "100%";
            showReport(data);
            loadHistory();
            break;

          case "failed":
            statusMessage.textContent = `Error: ${data.error_message || "Unknown error"}`;
            statusMessage.style.color = "var(--accent-danger)";
            break;
        }
      }

      // Get an icon for a research question based on its content
      function getQuestionIcon(question, rationale) {
        const text = (question + " " + rationale).toLowerCase();
        
        // Check for specific keywords and return appropriate icons
        if (text.includes("timeline") || text.includes("chronolog") || text.includes("when") || text.includes("date") || text.includes("sequence")) {
          return { icon: "fa-clock", color: "#6366f1" }; // Indigo - time-related
        }
        if (text.includes("cause") || text.includes("reason") || text.includes("why") || text.includes("result")) {
          return { icon: "fa-link", color: "#8b5cf6" }; // Purple - causation
        }
        if (text.includes("who") || text.includes("witness") || text.includes("person") || text.includes("party") || text.includes("parties")) {
          return { icon: "fa-id-badge", color: "#ec4899" }; // Pink - people
        }
        if (text.includes("contract") || text.includes("clause") || text.includes("obligation") || text.includes("liability")) {
          return { icon: "fa-file-contract", color: "#f59e0b" }; // Amber - contracts
        }
        if (text.includes("delay") || text.includes("extension") || text.includes("programme") || text.includes("schedule")) {
          return { icon: "fa-calendar-alt", color: "#10b981" }; // Emerald - schedule
        }
        if (text.includes("cost") || text.includes("quantum") || text.includes("payment") || text.includes("price") || text.includes("money") || text.includes("")) {
          return { icon: "fa-calculator", color: "#14b8a6" }; // Teal - money
        }
        if (text.includes("communication") || text.includes("email") || text.includes("letter") || text.includes("notice") || text.includes("notify")) {
          return { icon: "fa-envelope", color: "#3b82f6" }; // Blue - communications
        }
        if (text.includes("variation") || text.includes("change") || text.includes("instruction") || text.includes("order")) {
          return { icon: "fa-exchange-alt", color: "#f97316" }; // Orange - variations
        }
        if (text.includes("defect") || text.includes("quality") || text.includes("damage") || text.includes("issue")) {
          return { icon: "fa-exclamation-triangle", color: "#ef4444" }; // Red - defects
        }
        if (text.includes("document") || text.includes("evidence") || text.includes("record") || text.includes("prove")) {
          return { icon: "fa-file-alt", color: "#0ea5e9" }; // Sky - documents
        }
        if (text.includes("design") || text.includes("drawing") || text.includes("specification")) {
          return { icon: "fa-drafting-compass", color: "#a855f7" }; // Violet - design
        }
        if (text.includes("impact") || text.includes("effect") || text.includes("consequence")) {
          return { icon: "fa-bolt", color: "#eab308" }; // Yellow - impact
        }
        
        // Default icon
        return { icon: "fa-search", color: "var(--vc-teal)" };
      }

      function showPlanReview(plan) {
        if (!plan) return;

        planReview.style.display = "block";
        reportContainer.style.display = "none";

        document.getElementById("planProblem").textContent =
          plan.problem_statement;

        // Show angles with icons
        const anglesContainer = document.getElementById("planAngles");
        const angleIcons = {
          'chronology': 'fa-clock',
          'causation': 'fa-link',
          'liability': 'fa-gavel',
          'quantum': 'fa-calculator',
          'communications': 'fa-envelope',
          'variations': 'fa-exchange-alt',
          'programme': 'fa-calendar-alt',
          'witnesses': 'fa-id-badge',
          'defects': 'fa-exclamation-triangle',
          'delay': 'fa-hourglass-half',
          'contract': 'fa-file-contract',
          'design': 'fa-drafting-compass'
        };
        
        anglesContainer.innerHTML = plan.key_angles
          .map((angle) => {
            const lowerAngle = angle.toLowerCase();
            const icon = Object.entries(angleIcons).find(([key]) => lowerAngle.includes(key))?.[1] || 'fa-tag';
            return `<span class="angle-tag"><i class="fas ${icon}"></i> ${angle}</span>`;
          })
          .join("");

        // Show questions with smart icons
        const questionsContainer =
          document.getElementById("questionsContainer");
        questionsContainer.innerHTML = plan.questions
          .map(
            (q, index) => {
              const iconData = getQuestionIcon(q.question, q.rationale || "");
              const questionNum = index + 1;
              
              return `
                <div class="question-node" data-question-id="${q.id}">
                    <div class="question-icon-wrapper">
                        <div class="question-icon" style="background: ${iconData.color}15; border-color: ${iconData.color}40;">
                            <i class="fas ${iconData.icon}" style="color: ${iconData.color};"></i>
                        </div>
                        <div class="question-number">Q${questionNum}</div>
                    </div>
                    <div class="question-content">
                        <div class="question-text">${q.question}</div>
                        <div class="question-rationale">${q.rationale || ""}</div>
                        <div class="question-footer">
                            <div class="question-status-badge ${q.status}">
                                ${
                                  q.status === "completed"
                                    ? '<i class="fas fa-check"></i> Completed'
                                    : q.status === "in-progress"
                                      ? '<i class="fas fa-spinner fa-spin"></i> Researching...'
                                      : '<i class="fas fa-clock"></i> Pending'
                                }
                            </div>
                            ${
                              q.dependencies && q.dependencies.length > 0
                                ? `
                                <div class="question-deps">
                                    <i class="fas fa-project-diagram"></i>
                                    ${q.dependencies.map((d) => `<span class="dep-badge">${d}</span>`).join("")}
                                </div>
                            `
                                : ""
                            }
                        </div>
                    </div>
                </div>
              `;
            }
          )
          .join("");
      }

      function updateQuestionProgress(plan) {
        if (!plan) return;
        // Update question status indicators
        plan.questions.forEach((q) => {
          const node = document.querySelector(`[data-question-id="${q.id}"]`);
          if (node) {
            const statusEl = node.querySelector(".question-status");
            statusEl.className = `question-status ${q.status}`;
          }
        });
      }

      function showReport(data) {
        planReview.style.display = "none";
        reportContainer.style.display = "block";

        // Build meta items
        const metaItems = [];
        if (typeof data.processing_time_seconds === "number") {
          metaItems.push(`<span class="report-meta-item"><i class="fas fa-clock"></i> ${data.processing_time_seconds.toFixed(1)}s</span>`);
        }
        if (Array.isArray(data.models_used) && data.models_used.length) {
          metaItems.push(`<span class="report-meta-item"><i class="fas fa-microchip"></i> ${data.models_used.join(", ")}</span>`);
        }
        const questionsCount = data.plan?.questions?.length || 0;
        if (questionsCount > 0) {
          metaItems.push(`<span class="report-meta-item"><i class="fas fa-search"></i> ${questionsCount} questions analyzed</span>`);
        }
        document.getElementById("reportMeta").innerHTML = metaItems.join("");

        // Themes with icons
        const themesContainer = document.getElementById("reportThemes");
        const themes = data.key_themes || [];
        themesContainer.innerHTML = themes
          .map((theme) => `<span class="theme-tag">${theme}</span>`)
          .join("");

        // Content (markdown rendering)
        const content = data.final_report || "No report generated.";
        document.getElementById("reportContent").innerHTML =
          renderMarkdown(content);
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function sanitizeUrl(url) {
        const u = String(url || "").trim();
        if (!u) return null;
        // Only allow safe protocols.
        if (/^(https?:\/\/|mailto:)/i.test(u)) return u;
        return null;
      }

      function renderInline(rawText) {
        // Escape first (prevents HTML injection), then apply a small subset of markdown.
        let t = escapeHtml(rawText);

        // Inline code
        t = t.replace(/`([^`]+)`/g, "<code>$1</code>");

        // Links: [text](url)
        t = t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (m, label, url) => {
          const safe = sanitizeUrl(url);
          if (!safe) return label;
          return `<a href="${escapeHtml(safe)}" target="_blank" rel="noopener noreferrer">${label}</a>`;
        });

        // Bold - improved pattern to handle text like **Word:** correctly
        t = t.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

        // Italic (non-greedy, avoid matching **bold**)
        t = t.replace(/(^|[^*])\*([^*]+?)\*(?!\*)/g, "$1<em>$2</em>");

        return t;
      }

      function renderMarkdown(markdown) {
        const src = String(markdown || "").replace(/\r\n/g, "\n");
        const lines = src.split("\n");

        const out = [];
        let inCodeBlock = false;
        let codeLang = "";
        let codeLines = [];
        let listType = null; // 'ul' | 'ol' | null
        let paragraphLines = [];

        function flushParagraph() {
          const text = paragraphLines.join(" ").trim();
          if (text) out.push(`<p>${renderInline(text)}</p>`);
          paragraphLines = [];
        }

        function closeList() {
          if (listType) {
            out.push(`</${listType}>`);
            listType = null;
          }
        }

        function openList(type) {
          if (listType !== type) {
            closeList();
            out.push(`<${type}>`);
            listType = type;
          }
        }

        for (const rawLine of lines) {
          const line = String(rawLine ?? "");
          const trimmed = line.trim();

          // Fenced code blocks
          if (inCodeBlock) {
            if (trimmed.startsWith("```")) {
              const code = escapeHtml(codeLines.join("\n"));
              const langClass = codeLang ? ` language-${escapeHtml(codeLang)}` : "";
              out.push(`<pre><code class="${langClass.trim()}">${code}</code></pre>`);
              inCodeBlock = false;
              codeLang = "";
              codeLines = [];
            } else {
              codeLines.push(line);
            }
            continue;
          }

          if (trimmed.startsWith("```")) {
            flushParagraph();
            closeList();
            inCodeBlock = true;
            codeLang = trimmed.slice(3).trim();
            codeLines = [];
            continue;
          }

          // Blank line => paragraph/list boundary
          if (!trimmed) {
            flushParagraph();
            closeList();
            continue;
          }

          // Horizontal rule
          if (trimmed === "---" || trimmed === "***") {
            flushParagraph();
            closeList();
            out.push("<hr>");
            continue;
          }

          // Headings - support h1-h6 (map h4-h6 to h4 for styling consistency)
          const headingMatch = trimmed.match(/^(#{1,6})\s+(.+)$/);
          if (headingMatch) {
            flushParagraph();
            closeList();
            const rawLevel = headingMatch[1].length;
            const level = Math.min(rawLevel, 4); // Cap at h4 for styling
            const text = headingMatch[2];
            out.push(`<h${level}>${renderInline(text)}</h${level}>`);
            continue;
          }

          // Blockquote (single-line)
          const bqMatch = trimmed.match(/^>\s?(.*)$/);
          if (bqMatch) {
            flushParagraph();
            closeList();
            out.push(`<blockquote><p>${renderInline(bqMatch[1])}</p></blockquote>`);
            continue;
          }

          // Ordered list
          const olMatch = trimmed.match(/^(\d+)\.\s+(.+)$/);
          if (olMatch) {
            flushParagraph();
            openList("ol");
            out.push(`<li>${renderInline(olMatch[2])}</li>`);
            continue;
          }

          // Unordered list
          const ulMatch = trimmed.match(/^[-*]\s+(.+)$/);
          if (ulMatch) {
            flushParagraph();
            openList("ul");
            out.push(`<li>${renderInline(ulMatch[1])}</li>`);
            continue;
          }

          // Default paragraph text
          closeList();
          paragraphLines.push(trimmed);
        }

        // Flush trailing content
        if (inCodeBlock) {
          const code = escapeHtml(codeLines.join("\n"));
          const langClass = codeLang ? ` language-${escapeHtml(codeLang)}` : "";
          out.push(`<pre><code class="${langClass.trim()}">${code}</code></pre>`);
        }
        flushParagraph();
        closeList();

        return out.join("\n");
      }

      // Plan actions
      document
        .getElementById("btnApprove")
        .addEventListener("click", async (e) => {
          const button = e.target;
          if (button.disabled) return; // Prevent double-click
          button.disabled = true;

          try {
            const response = await secureApiFetch(
              `/api/vericase-analysis/approve-plan`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  session_id: currentSessionId,
                  approved: true,
                }),
              },
            );

            if (!response.ok) {
              const detail = await response.text();
              throw new Error(
                `Failed to approve plan (${response.status}): ${detail || "unknown error"}`,
              );
            }

            // Hide plan review, keep status visible
            planReview.style.display = "none";
          } catch (error) {
            console.error("Error approving plan:", error);
            alert("Failed to approve plan: " + error.message);
            button.disabled = false; // Re-enable button on error
          }
        });

      document.getElementById("btnModify").addEventListener("click", () => {
        document.getElementById("modifyModal").classList.add("active");
      });

      function closeModifyModal() {
        document.getElementById("modifyModal").classList.remove("active");
      }

      async function submitModification() {
        const modifications = document
          .getElementById("modifyInput")
          .value.trim();
        if (!modifications) {
          alert("Please describe the changes you want");
          return;
        }

        try {
          const response = await secureApiFetch(
            `/api/vericase-analysis/approve-plan`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                session_id: currentSessionId,
                approved: false,
                modifications: modifications,
              }),
            },
          );

          if (!response.ok) {
            const detail = await response.text();
            throw new Error(
              `Failed to submit modifications (${response.status}): ${detail || "unknown error"}`,
            );
          }

          closeModifyModal();
          planReview.style.display = "none";
        } catch (error) {
          console.error("Error submitting modifications:", error);
          alert("Failed to submit modifications: " + error.message);
        }
      }

      // Report actions
      function copyReport() {
        const content = document.getElementById("reportContent").innerText;
        navigator.clipboard.writeText(content);
        alert("Report copied to clipboard");
      }

      function downloadReport() {
        const content = document.getElementById("reportContent").innerText;
        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `research-report-${currentSessionId}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function startNewResearch() {
        stopPolling();
        currentSessionId = null;
        startTime = null;
        selectedFocusAreas = [];

        // Reset UI
        researchForm.style.display = "block";
        sessionPanel.classList.remove("active");
        planReview.style.display = "none";
        reportContainer.style.display = "none";
        topicInput.value = "";
        progressFill.style.width = "0%";
        progressText.textContent = "0 / 0 questions";

        document
          .querySelectorAll(".focus-tag")
          .forEach((tag) => tag.classList.remove("active"));
      }

      // History
      async function loadHistory() {
        try {
          const response = await secureApiFetch(`/api/vericase-analysis/sessions`);
          if (!response.ok) return;

          const data = await response.json();
          const historyList = document.getElementById("historyList");

          if (data.sessions.length === 0) {
            historyList.innerHTML =
              '<p style="font-size: 0.875rem; color: var(--text-muted);">No previous research sessions.</p>';
            return;
          }

          historyList.innerHTML = data.sessions
            .map(
              (session) => `
                    <div class="history-item" onclick="loadSession('${session.id}')">
                        <div class="history-icon">
                            <i class="fas fa-${session.has_report ? "file-alt" : "flask"}"></i>
                        </div>
                        <div class="history-content">
                            <div class="history-topic">${session.topic}</div>
                            <div class="history-date">${new Date(session.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                `,
            )
            .join("");
        } catch (error) {
          console.error("Error loading history:", error);
        }
      }

      async function loadSession(sessionId) {
        currentSessionId = sessionId;
        startTime = Date.now();

        researchForm.style.display = "none";
        sessionPanel.classList.add("active");

        await updateStatus();

        // Only poll if not completed
        const response = await secureApiFetch(
          `/api/vericase-analysis/status/${sessionId}`,
        );
        const data = await response.json();
        if (!["completed", "failed", "cancelled"].includes(data.status)) {
          startPolling();
        }
      }
    </script>
  </body>
</html>

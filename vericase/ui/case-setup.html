<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Case Setup | VeriCase</title>
    <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="brand-styles.css?v=7" />
    <link rel="stylesheet" href="design-system.css?v=7" />
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>
    <style>
      body {
        background: #f6f4f0;
        color: var(--text-primary);
      }

      .container {
        max-width: 960px;
        margin: 2.5rem auto;
        padding: 0 2rem 3rem;
      }

      .page-header {
        margin-bottom: 1.5rem;
      }

      .page-title {
        font-size: 2rem;
        margin: 0 0 0.35rem;
        color: var(--vericase-navy);
      }

      .page-subtitle {
        color: var(--text-secondary);
        margin: 0;
      }

      .card {
        background: white;
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        padding: 2rem;
        border: 1px solid var(--gray-100);
      }

      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-label {
        display: block;
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 0.7rem 0.9rem;
        border-radius: 10px;
        border: 1px solid var(--border-default);
        font-size: 0.95rem;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--vericase-teal);
        box-shadow: 0 0 0 3px rgba(15, 157, 154, 0.1);
      }

      .form-input--disabled {
        background: #f3f4f6;
        color: var(--text-muted);
      }

      .form-textarea {
        min-height: 120px;
        resize: vertical;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }

      .helper-text {
        margin-top: 0.35rem;
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .action-row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
      }
    </style>
  </head>
  <body>
    <main id="main-content">
      <div class="container">
        <div class="page-header">
          <h1 class="page-title">Case Setup</h1>
          <p class="page-subtitle">Capture the dispute details and link the case to a project if needed.</p>
        </div>
        <div class="card">
          <form id="caseForm">
            <div class="form-group">
              <label class="form-label" for="caseName">Case name *</label>
              <input class="form-input" id="caseName" type="text" required />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="caseNumber">Case number (optional)</label>
                <input class="form-input" id="caseNumber" type="text" />
                <div class="helper-text">Auto-generated if left blank.</div>
              </div>
              <div class="form-group">
                <label class="form-label" for="contractType">Contract type</label>
                <select class="form-select" id="contractType">
                  <option value="">Select...</option>
                  <option value="JCT">JCT</option>
                  <option value="NEC">NEC</option>
                  <option value="FIDIC">FIDIC</option>
                  <option value="Custom">Custom</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="projectSelect">Link to a project (optional)</label>
              <select class="form-select" id="projectSelect">
                <option value="">Not linked</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="caseDescription">Description</label>
              <textarea class="form-textarea" id="caseDescription"></textarea>
            </div>
            <div class="action-row">
              <button class="btn btn-vericase" type="submit" id="createCaseBtn">
                <i class="fas fa-plus"></i> Create case
              </button>
              <button class="btn btn-secondary" type="button" id="backToDashboardBtn">
                Back to dashboard
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <script>
      let numberManuallyEdited = false;
      let lastAutoNumber = "";
      let isEditMode = false;
      let currentCaseId = null;
      let pendingProjectId = null;
      let currentWorkspaceId = null;

      function getAuthHeaders() {
        const token =
          localStorage.getItem("vericase_token") ||
          localStorage.getItem("token") ||
          localStorage.getItem("jwt");
        return token ? { Authorization: `Bearer ${token}`, "Content-Type": "application/json" } : { "Content-Type": "application/json" };
      }

      function buildCaseNumber(name) {
        const cleaned = String(name || "")
          .replace(/[^a-zA-Z0-9]+/g, " ")
          .trim();
        const parts = cleaned ? cleaned.split(/\s+/) : [];
        const abbrev = parts
          .map((part) => part.slice(0, 3))
          .join("")
          .slice(0, 6)
          .toUpperCase();
        const suffix = Math.random().toString(36).slice(2, 6).toUpperCase();
        return `${abbrev || "CASE"}-${suffix}`;
      }

      function syncAutoNumber() {
        const nameInput = document.getElementById("caseName");
        const numberInput = document.getElementById("caseNumber");
        if (!nameInput || !numberInput || numberManuallyEdited || isEditMode) return;
        const nextNumber = buildCaseNumber(nameInput.value);
        if (!numberInput.value || numberInput.value === lastAutoNumber) {
          numberInput.value = nextNumber;
          lastAutoNumber = nextNumber;
        }
      }

      function syncProjectSelection() {
        const select = document.getElementById("projectSelect");
        if (!select || !pendingProjectId) return;
        for (const option of select.options) {
          if (String(option.value) === String(pendingProjectId)) {
            select.value = pendingProjectId;
            break;
          }
        }
      }

      async function loadProjects() {
        try {
          let data = [];
          if (!isEditMode && currentWorkspaceId) {
            const wsResponse = await fetch(`/api/workspaces/${encodeURIComponent(currentWorkspaceId)}`, { headers: getAuthHeaders() });
            if (wsResponse.ok) {
              const wsData = await wsResponse.json();
              data = Array.isArray(wsData.projects) ? wsData.projects : [];
            }
          } else {
            const response = await fetch("/api/projects", { headers: getAuthHeaders() });
            if (!response.ok) return;
            data = await response.json();
          }

          const select = document.getElementById("projectSelect");
          const currentProjectId =
            localStorage.getItem("vericase_current_project") ||
            localStorage.getItem("currentProjectId");

          data.forEach((project) => {
            const option = document.createElement("option");
            option.value = project.id;
            const name = project.project_name || project.name || "Unnamed Project";
            const code = project.project_code || project.code || "";
            option.textContent = `${name}${code ? ` (${code})` : ""}`;
            const selectedId = pendingProjectId || currentProjectId;
            if (selectedId && String(project.id) === String(selectedId)) {
              option.selected = true;
            }
            select.appendChild(option);
          });
          syncProjectSelection();
        } catch (error) {
          console.warn("Failed to load projects", error);
        }
      }

      async function loadCase(caseId) {
        const response = await fetch(`/api/cases/${encodeURIComponent(caseId)}`, {
          headers: getAuthHeaders()
        });
        if (!response.ok) {
          throw new Error("Failed to load case details");
        }
        const data = await response.json();
        document.getElementById("caseName").value = data.name || "";
        document.getElementById("caseNumber").value = data.case_number || "";
        document.getElementById("contractType").value = data.contract_type || "";
        document.getElementById("caseDescription").value = data.description || "";
        pendingProjectId = data.project_id || null;
        lastAutoNumber = data.case_number || "";
        numberManuallyEdited = true;
        syncProjectSelection();
      }

      async function submitCase(event) {
        event.preventDefault();
        const nameValue = document.getElementById("caseName").value.trim();
        if (!nameValue) {
          VericaseUI.Toast.error("Please enter a case name");
          return;
        }

        if (!isEditMode && !currentWorkspaceId) {
          VericaseUI.Toast.error("Select a workspace first");
          window.location.href = "master-dashboard.html";
          return;
        }

        let payload = null;
        const projectSelection = document.getElementById("projectSelect").value;
        if (isEditMode) {
          payload = {
            name: nameValue,
            description: document.getElementById("caseDescription").value || null,
            contract_type: document.getElementById("contractType").value || null,
            project_id: projectSelection === "" ? "" : projectSelection
          };
        } else {
          const numberValue = document.getElementById("caseNumber").value.trim();
          const resolvedNumber = numberValue || buildCaseNumber(nameValue);
          if (!numberValue) {
            document.getElementById("caseNumber").value = resolvedNumber;
            lastAutoNumber = resolvedNumber;
          }

          payload = {
            case_name: nameValue,
            case_number: resolvedNumber,
            workspace_id: currentWorkspaceId,
            description: document.getElementById("caseDescription").value || null,
            contract_type: document.getElementById("contractType").value || null,
            project_id: projectSelection === "" ? null : projectSelection
          };
        }

        const btn = document.getElementById("createCaseBtn");
        btn.disabled = true;
        btn.innerHTML = isEditMode
          ? '<i class="fas fa-spinner fa-spin"></i> Saving...'
          : '<i class="fas fa-spinner fa-spin"></i> Creating...';

        try {
          const endpoint = isEditMode ? `/api/cases/${encodeURIComponent(currentCaseId)}` : "/api/cases";
          const response = await fetch(endpoint, {
            method: isEditMode ? "PUT" : "POST",
            headers: getAuthHeaders(),
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Failed to save case");
          }
          const data = await response.json();
          const caseId = data.id || currentCaseId;
          const caseName = data.case_name || data.name || nameValue;
          localStorage.setItem("profileType", "case");
          localStorage.setItem("currentCaseId", caseId);
          localStorage.setItem("caseId", caseId);
          localStorage.setItem("currentCaseName", caseName);
          localStorage.setItem("vericase_current_case_name", caseName);
          VericaseUI.Toast.success(isEditMode ? "Case updated" : "Case created");
          window.location.href = `projectdashboard.html?caseId=${encodeURIComponent(caseId)}`;
        } catch (error) {
          VericaseUI.Toast.error(error.message || "Failed to save case");
        } finally {
          btn.disabled = false;
          btn.innerHTML = isEditMode ? '<i class="fas fa-save"></i> Save changes' : '<i class="fas fa-plus"></i> Create case';
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        currentWorkspaceId = params.get("workspaceId") || localStorage.getItem("currentWorkspaceId");
        if (currentWorkspaceId) {
          try {
            localStorage.setItem("currentWorkspaceId", currentWorkspaceId);
          } catch {
            // ignore storage failures
          }
        }
        currentCaseId = params.get("caseId");
        isEditMode = Boolean(currentCaseId);
        const pageTitle = document.querySelector(".page-title");
        const pageSubtitle = document.querySelector(".page-subtitle");
        const submitBtn = document.getElementById("createCaseBtn");
        const backBtn = document.getElementById("backToDashboardBtn");
        const caseNumberInput = document.getElementById("caseNumber");
        const caseNumberHelper = caseNumberInput?.nextElementSibling;
        if (isEditMode) {
          pageTitle.textContent = "Case Details";
          pageSubtitle.textContent = "Update the core details for this case.";
          submitBtn.innerHTML = '<i class="fas fa-save"></i> Save changes';
          if (caseNumberInput) {
            caseNumberInput.disabled = true;
            caseNumberInput.classList.add("form-input--disabled");
          }
          if (caseNumberHelper) {
            caseNumberHelper.textContent = "Case numbers are fixed after creation.";
          }
          backBtn.addEventListener("click", () => {
            window.location.href = `projectdashboard.html?caseId=${encodeURIComponent(currentCaseId)}`;
          });
          loadCase(currentCaseId).catch((error) => {
            VericaseUI.Toast.error(error.message || "Failed to load case");
          });
        } else {
          if (!currentWorkspaceId) {
            VericaseUI.Toast.info("Select a workspace first");
            window.location.href = "master-dashboard.html";
            return;
          }
          backBtn.addEventListener("click", () => {
            window.location.href = `workspace-setup.html?workspaceId=${encodeURIComponent(currentWorkspaceId)}`;
          });
        }
        if (window.VericaseShell?.inject) {
          VericaseShell.inject({ title: isEditMode ? "Case Details" : "Case Setup", breadcrumbs: null, headerActions: "" });
        }
        document.getElementById("caseName").addEventListener("input", syncAutoNumber);
        document.getElementById("caseNumber").addEventListener("input", (event) => {
          numberManuallyEdited = event.target.value.trim().length > 0 && event.target.value !== lastAutoNumber;
        });
        document.getElementById("caseForm").addEventListener("submit", submitCase);
        loadProjects();
      });
    </script>
  </body>
</html>

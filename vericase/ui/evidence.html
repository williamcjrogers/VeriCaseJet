<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="build-version" content="2.0.4-<?php echo time(); ?>" />
  <title>VeriCase - Evidence Repository</title>

  <!-- AG-Grid Enterprise CSS (v31.0.0) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/styles/ag-grid.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/styles/ag-theme-alpine.css" />
  <!-- Custom VeriCase theme extends Alpine -->
  <link rel="stylesheet" href="ag-theme-vericase.css?v=3" />

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />

  <!-- VeriCase Design System -->
  <link rel="stylesheet" href="brand-styles.css?v=6" />
  <link rel="stylesheet" href="design-system.css?v=6" />
  <script src="config.js"></script>
  <script src="vericase-ui.js"></script>
  <script src="nav-shell.js"></script>

  <style>
    body {
      background: var(--bg-primary);
      /* Let the shell/content manage scrolling; hiding body overflow can clip the grid entirely. */
      overflow: auto;
    }

    /* When wrapped by nav-shell, make the injected content a proper flex column so the grid can size correctly. */
    .app-content.evidence-page {
      display: flex;
      flex-direction: column;
      min-height: 0;
      padding: 0; /* use full width; page has its own spacing */
    }

    .evidence-layout {
      display: flex;
      /* Fill remaining height under the tabs/toolbar/stats within the shell's content area. */
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* Toolbar */
    .toolbar {
      padding: 16px 24px;
      background: white;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .search-container {
      position: relative;
      flex: 1;
      max-width: 400px;
    }

    .search-container input {
      width: 100%;
      padding: 10px 16px 10px 42px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      transition: all var(--duration-fast);
      background: var(--gray-50);
    }

    .search-container input:focus {
      outline: none;
      border-color: var(--vericase-teal);
      background: white;
      box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.1);
    }

    .search-container i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      transition: color var(--duration-fast);
    }

    .search-container:focus-within i {
      color: var(--vericase-teal);
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-select {
      padding: 10px 32px 10px 14px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      font-size: 0.8125rem;
      background: white;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M3 4.5L6 7.5L9 4.5'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      transition: all var(--duration-fast);
    }

    .filter-select:hover {
      border-color: var(--gray-300);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--vericase-teal);
    }

    .checkbox-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-full);
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all var(--duration-fast);
      user-select: none;
      background: white;
    }

    .checkbox-pill:hover {
      border-color: var(--gray-300);
    }

    .checkbox-pill.active {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      border-color: var(--vericase-teal);
      color: var(--vericase-teal-dark);
    }

    .checkbox-pill input {
      display: none;
    }

    .toolbar-spacer {
      flex: 1;
    }

    .toolbar-actions {
      display: flex;
      gap: 8px;
    }

    /* Stats Bar - VeriCase Branding */
    .stats-bar {
      padding: 12px 24px;
      background: linear-gradient(135deg,
          var(--vericase-teal) 0%,
          var(--vericase-navy) 100%);
      color: white;
      display: flex;
      gap: 32px;
      font-size: 0.8125rem;
      box-shadow: 0 4px 12px rgba(var(--vericase-teal-rgb), 0.2);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: rgba(255, 255, 255, 0.85);
    }

    .stat-value {
      font-weight: 700;
      color: white;
      font-size: 0.9375rem;
    }

    /* Category Tabs */
    .category-tabs {
      display: flex;
      gap: 0;
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 0 24px;
    }

    .category-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 20px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      position: relative;
      transition: all var(--duration-fast);
    }

    .category-tab::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--vericase-teal);
      transform: scaleX(0);
      transition: transform var(--duration-normal) var(--ease-out-expo);
    }

    .category-tab:hover {
      color: var(--text-primary);
    }

    .category-tab.active {
      color: var(--vericase-teal);
    }

    .category-tab.active::after {
      transform: scaleX(1);
    }

    .tab-count {
      background: var(--gray-200);
      color: var(--text-secondary);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
      transition: all var(--duration-fast);
    }

    .category-tab.active .tab-count {
      background: rgba(var(--vericase-teal-rgb), 0.15);
      color: var(--vericase-teal-dark);
    }

    /* Collections Sidebar */
    .collections-sidebar {
      width: 240px;
      background: white;
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-section-title {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .sidebar-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
    }

    .auto-categorize-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      color: var(--text-secondary);
      user-select: none;
    }

    .auto-categorize-toggle input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--vericase-teal);
    }

    .auto-categorize-toggle .toggle-label {
      font-size: 0.75rem;
    }

    .collection-item.nested {
      padding-left: 32px;
    }

    .collection-item.nested-2 {
      padding-left: 48px;
    }

    .collection-item.nested-3 {
      padding-left: 64px;
    }

    .collection-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px 16px;
    }

    .collection-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-secondary);
      transition: all var(--duration-fast);
    }

    .collection-item:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .collection-item.active {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      color: var(--vericase-teal-dark);
    }

    .collection-item.default-category {
      border-left: 3px solid var(--vericase-teal);
      margin-left: 4px;
    }

    .collection-item.default-category i {
      color: var(--vericase-teal);
    }

    .collection-item i {
      font-size: 1rem;
      width: 20px;
      text-align: center;
      opacity: 0.7;
    }

    .collection-item.active i {
      opacity: 1;
      color: var(--vericase-teal);
    }

    .collection-count {
      margin-left: auto;
      background: var(--gray-200);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 0.6875rem;
      font-weight: 600;
    }

    .collection-item.active .collection-count {
      background: rgba(var(--vericase-teal-rgb), 0.2);
      color: var(--vericase-teal-dark);
    }

    /* Grid Container */
    .grid-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      background: var(--gray-50);
      position: relative;
    }

    .grid-wrapper {
      flex: 1;
      padding: 16px;
      overflow: hidden;
      min-height: 0;
    }

    #evidenceGrid {
      width: 100%;
      height: 100%;
    }

    #evidenceGrid.ag-theme-alpine .ag-root-wrapper {
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
    }

    #evidenceGrid.ag-theme-alpine .ag-header {
      border-bottom: 2px solid var(--gray-200);
    }

    #evidenceGrid.ag-theme-alpine .ag-header-cell {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.6875rem;
      letter-spacing: 0.05em;
    }

    #evidenceGrid.ag-theme-alpine .ag-row {
      transition: background-color var(--duration-fast);
    }

    #evidenceGrid.ag-theme-alpine .ag-row:hover {
      background-color: rgba(var(--vericase-teal-rgb), 0.04) !important;
    }

    #evidenceGrid.ag-theme-alpine .ag-row-selected {
      background-color: rgba(var(--vericase-teal-rgb), 0.08) !important;
    }

    /* Grid Cell Renderers */
    .grid-thumbnail {
      width: 36px;
      height: 36px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      background: var(--gray-100);
    }

    .grid-file-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-100);
      border-radius: var(--radius-sm);
      font-size: 1rem;
    }

    .grid-file-icon.pdf {
      background: #fee2e2;
      color: #dc2626;
    }

    .grid-file-icon.word {
      background: #dbeafe;
      color: #2563eb;
    }

    .grid-file-icon.excel {
      background: #d1fae5;
      color: #059669;
    }

    .grid-file-icon.image {
      background: #ede9fe;
      color: #7c3aed;
    }

    .grid-file-icon.email {
      background: #fef3c7;
      color: #d97706;
    }

    .file-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .file-name {
      font-weight: 500;
      color: var(--text-primary);
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
    }

    .file-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .status-processed {
      background: #d1fae5;
      color: #065f46;
    }

    .status-processing {
      background: #fef3c7;
      color: #92400e;
    }

    .status-pending {
      background: #e0e7ff;
      color: #3730a3;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .star-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--gray-300);
      font-size: 1rem;
      padding: 4px;
      transition: all var(--duration-fast);
    }

    .star-btn:hover {
      color: var(--warning);
      transform: scale(1.15);
    }

    .star-btn.starred {
      color: var(--warning);
    }

    /* Detail Panel */
    .detail-panel {
      width: 420px;
      background: white;
      border-left: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transform: translateX(100%);
      opacity: 0;
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: 50;
      box-shadow: -8px 0 30px rgba(0, 0, 0, 0.1);
      transition:
        transform var(--duration-slow) var(--ease-out-expo),
        opacity var(--duration-normal);
    }

    .detail-panel.open {
      transform: translateX(0);
      opacity: 1;
    }

    .detail-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--gray-50);
    }

    .detail-header h3 {
      font-size: 0.9375rem;
      font-weight: 600;
    }

    .detail-header-actions {
      display: flex;
      gap: 8px;
    }

    .close-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-muted);
      transition: all var(--duration-fast);
    }

    .close-btn:hover {
      background: var(--gray-200);
      color: var(--text-primary);
    }

    .detail-body {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .vericase-suggestions-panel {
      border-top: 1px solid var(--gray-200);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--gray-50);
    }

    .suggestions-panel-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .suggestions-panel-header h4 {
      margin: 0;
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }

    .suggestions-panel-header i {
      color: var(--vericase-teal);
    }

    .suggestions-panel-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .suggestions-empty-state,
    .suggestions-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
      text-align: center;
      color: var(--text-muted);
      gap: 8px;
    }

    .suggestions-empty-state i,
    .suggestions-loading i {
      font-size: 1.5rem;
      opacity: 0.5;
    }

    .suggestions-empty-state p,
    .suggestions-loading span {
      font-size: 0.8125rem;
    }

    .suggestion-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .suggestion-group-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .suggestion-group-header i {
      color: var(--vericase-teal);
      font-size: 0.6875rem;
    }

    .suggestion-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .suggestion-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      transition: all var(--duration-fast);
    }

    .suggestion-item:hover {
      border-color: var(--vericase-teal);
      box-shadow: 0 2px 8px rgba(31, 111, 120, 0.1);
    }

    .suggestion-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .suggestion-item-title {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .suggestion-item-title i {
      color: var(--vericase-teal);
      font-size: 0.75rem;
    }

    .suggestion-item-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .suggestion-item-meta i {
      font-size: 0.6875rem;
    }

    .suggestion-item-context {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
      font-style: italic;
    }

    .collab-panel {
      border-top: 1px solid var(--gray-200);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .collab-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .collab-panel-header h4 {
      margin: 0;
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .collab-panel-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .lane-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .lane-tab {
      padding: 6px 12px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      background: white;
      color: var(--text-muted);
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .lane-tab.active {
      background: var(--vericase-teal);
      border-color: var(--vericase-teal);
      color: white;
    }

    .collab-thread {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 220px;
      overflow-y: auto;
    }

    .collab-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin: 6px 0;
    }

    .collab-comment {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      font-size: 0.8125rem;
    }

    .collab-comment.reply {
      margin-left: 18px;
      border-left: 3px solid var(--vericase-teal);
    }

    .collab-comment-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .collab-input {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .collab-input textarea {
      flex: 1;
      min-height: 70px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 8px 10px;
      font-size: 0.8125rem;
      resize: vertical;
    }

    .collab-input textarea:focus {
      outline: none;
      border-color: var(--vericase-teal);
      box-shadow: 0 0 0 2px rgba(var(--vericase-teal-rgb), 0.15);
    }

    .collab-empty {
      border: 1px dashed var(--gray-200);
      border-radius: var(--radius-md);
      padding: 12px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8125rem;
    }

    .lane-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: var(--radius-md);
      font-size: 0.625rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      background: var(--gray-100);
      color: var(--text-muted);
    }

    .lane-badge.core {
      background: rgba(var(--vericase-teal-rgb), 0.12);
      color: #0f766e;
    }

    .lane-badge.counsel {
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
    }

    .lane-badge.expert {
      background: rgba(245, 158, 11, 0.16);
      color: #b45309;
    }

    .collab-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .collab-toggle input {
      width: 14px;
      height: 14px;
    }

    /* Preview Section */
    .preview-section {
      background: var(--gray-900);
      min-height: 200px;
      max-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .preview-section img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .preview-section iframe {
      width: 100%;
      height: 280px;
      border: none;
    }

    .preview-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: var(--gray-500);
    }

    .preview-placeholder i {
      font-size: 2.5rem;
    }

    .preview-expand-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all var(--duration-fast);
    }

    .preview-expand-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    /* Metadata Content */
    .metadata-content {
      padding: 16px 20px;
    }

    .detail-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--gray-100);
    }

    .detail-section:last-child {
      border-bottom: none;
    }

    .detail-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .detail-section-header i {
      color: var(--vericase-teal);
      font-size: 0.875rem;
    }

    .detail-section-header h4 {
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-label {
      font-size: 0.6875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .detail-value {
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--gray-100);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .tag-blue {
      background: #dbeafe;
      color: #1e40af;
    }

    .tag-teal {
      background: rgba(var(--vericase-teal-rgb), 0.15);
      color: var(--vericase-teal-dark);
    }

    .tag-purple {
      background: #ede9fe;
      color: #5b21b6;
    }

    .tag-yellow {
      background: #fef3c7;
      color: #92400e;
    }

    /* Detail Actions */
    .detail-actions {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 12px;
      background: var(--gray-50);
    }

    .detail-actions .btn {
      flex: 1;
    }

    /* Full-Screen Preview Modal */
    .preview-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: var(--z-modal);
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition:
        opacity var(--duration-normal),
        visibility var(--duration-normal);
    }

    .preview-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .preview-modal-header {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
    }

    .preview-modal-title {
      font-weight: 500;
      max-width: 70%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .preview-modal-actions {
      display: flex;
      gap: 8px;
    }

    .preview-modal-actions .btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .preview-modal-actions .btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .preview-modal-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow: auto;
    }

    .preview-modal-content {
      max-width: 100%;
      max-height: 100%;
    }

    .preview-modal-content img {
      max-width: 100%;
      max-height: calc(100vh - 150px);
      object-fit: contain;
    }

    .preview-modal-content iframe {
      width: 90vw;
      height: calc(100vh - 150px);
      border: none;
      background: white;
      border-radius: var(--radius-lg);
    }

    .preview-modal-content pre {
      background: var(--gray-900);
      color: var(--gray-300);
      padding: 24px;
      border-radius: var(--radius-lg);
      max-width: 90vw;
      max-height: calc(100vh - 150px);
      overflow: auto;
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Settings Modal */
    .settings-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: var(--z-modal);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .settings-modal {
      background: white;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    }

    .settings-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .settings-modal-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--vericase-navy);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .settings-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .settings-section-header h4 {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .settings-section-header h4 i {
      color: var(--vericase-teal);
    }

    .settings-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .settings-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.875rem;
      margin-bottom: 8px;
    }

    .settings-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--vericase-teal);
    }

    .patterns-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .pattern-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
    }

    .pattern-item.readonly {
      background: var(--gray-100);
      color: var(--text-muted);
    }

    .pattern-text {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .pattern-category {
      padding: 2px 8px;
      background: rgba(var(--vericase-teal-rgb), 0.1);
      color: var(--vericase-teal-dark);
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .pattern-count {
      padding: 2px 6px;
      background: var(--gray-200);
      color: var(--text-muted);
      border-radius: 999px;
      font-size: 0.65rem;
      font-weight: 600;
    }

    .pattern-item .btn-delete {
      padding: 4px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
    }

    .pattern-item .btn-delete:hover {
      background: rgba(220, 38, 38, 0.1);
      color: #dc2626;
    }

    .patterns-empty {
      text-align: center;
      padding: 16px;
      color: var(--text-muted);
      font-size: 0.8125rem;
    }

    .category-settings-btn {
      padding: 4px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .category-settings-btn:hover {
      color: var(--vericase-teal);
      background: rgba(var(--vericase-teal-rgb), 0.1);
    }

    .settings-modal-overlay.hidden {
      display: none !important;
    }

    /* Link Cards */
    .link-card {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-bottom: 8px;
      transition: all var(--duration-fast);
    }

    .link-card:hover {
      border-color: var(--vericase-teal);
      background: white;
    }

    .link-card-title {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .link-card-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* GPS Link */
    .gps-map-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--vericase-blue);
      text-decoration: none;
      font-size: 0.8125rem;
    }

    .gps-map-link:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .collections-sidebar {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-container {
        max-width: 100%;
      }

      .filter-group {
        flex-wrap: wrap;
      }

      .detail-panel {
        width: 100%;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-enterprise@31.0.0/dist/ag-grid-enterprise.min.js"></script>
</head>

<body class="preload">
  <!-- Category Tabs -->
  <div class="category-tabs">
    <button class="category-tab active" data-category="documents" id="tabDocuments">
      <i class="fas fa-file-alt"></i> Documents
      <span class="tab-count" id="docCount">0</span>
    </button>
    <button class="category-tab" data-category="images" id="tabImages">
      <i class="fas fa-image"></i> Images & Media
      <span class="tab-count" id="imgCount">0</span>
    </button>
    <button class="category-tab" data-category="all" id="tabAll">
      <i class="fas fa-layer-group"></i> All Files
      <span class="tab-count" id="allCount">0</span>
    </button>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-container">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Search evidence by name, content, or tags..." />
    </div>

    <div class="filter-group">
      <select class="filter-select" id="fileTypeFilter">
        <option value="">All File Types</option>
        <option value="pdf">PDF Documents</option>
        <option value="word">Word Documents</option>
        <option value="excel">Spreadsheets</option>
        <option value="powerpoint">Presentations</option>
        <option value="text">Text Files</option>
        <option value="image">Images</option>
        <option value="other">Other</option>
      </select>

      <select class="filter-select" id="statusFilter">
        <option value="">All Status</option>
        <option value="processed">Processed</option>
        <option value="processing">Processing</option>
        <option value="pending">Pending</option>
        <option value="error">Error</option>
      </select>

      <label class="checkbox-pill" id="unassignedPill">
        <input type="checkbox" id="unassignedFilter" />
        <i class="fas fa-inbox"></i>
        Unassigned
      </label>

      <label class="checkbox-pill" id="starredPill">
        <input type="checkbox" id="starredFilter" />
        <i class="fas fa-star"></i>
        Starred
      </label>
    </div>

    <div class="toolbar-spacer"></div>

    <div class="toolbar-actions">
      <button class="btn btn-ghost" id="columnsBtn" title="Columns">
        <i class="fas fa-columns"></i>
      </button>
      <button class="btn btn-ghost" id="saveGridBtn" title="Save layout">
        <i class="fas fa-save"></i>
      </button>
      <button class="btn btn-ghost" id="resetGridBtn" title="Reset layout">
        <i class="fas fa-undo"></i>
      </button>
      <button class="btn btn-ghost" id="autofitBtn" title="Auto-fit columns">
        <i class="fas fa-arrows-alt-h"></i>
      </button>
    </div>

    <input type="file" id="fileInput" multiple style="display: none" />
    <button class="btn btn-vericase" id="uploadBtn">
      <i class="fas fa-upload"></i>
      <span class="btn-text">Upload Evidence</span>
    </button>

    <button class="btn btn-ghost" id="refreshBtn" title="Refresh">
      <i class="fas fa-sync-alt"></i>
    </button>
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar">
    <div class="stat-item">
      <i class="fas fa-archive"></i>
      <span class="stat-value" id="totalCount">—</span>
      <span>Total Items</span>
    </div>
    <div class="stat-item">
      <i class="fas fa-inbox"></i>
      <span class="stat-value" id="unassignedCount">—</span>
      <span>Unassigned</span>
    </div>
    <div class="stat-item">
      <i class="fas fa-link"></i>
      <span class="stat-value" id="linkedCount">—</span>
      <span>With Links</span>
    </div>
    <div class="stat-item">
      <i class="fas fa-clock"></i>
      <span class="stat-value" id="recentCount">—</span>
      <span>Recent (7d)</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="evidence-layout">
    <!-- Collections Sidebar -->
    <div class="collections-sidebar">
      <div class="sidebar-header">
      <div class="sidebar-section-title">Collections</div>
        <div class="sidebar-header-actions">
          <label class="auto-categorize-toggle" title="Enable intelligent auto-categorization">
            <input type="checkbox" id="autoCategorizeToggle" />
            <span class="toggle-label">Auto-categorize</span>
          </label>
          <button type="button" class="category-settings-btn" onclick="openCategorySettings()" title="Auto-categorization settings">
            <i class="fas fa-cog"></i>
          </button>
          <button type="button" class="btn btn-sm btn-ghost" id="createSubfolderBtn" title="Create Subfolder">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
      <div class="collection-list" id="collectionList">
        <div class="collection-item active" data-id="">
          <i class="fas fa-folder"></i>
          All Evidence
        </div>
      </div>
    </div>

    <!-- Grid Container -->
    <div class="grid-container">
      <div class="grid-wrapper">
        <div id="evidenceGrid" class="ag-theme-alpine ag-theme-vericase"></div>
      </div>

      <!-- Detail Panel -->
      <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
          <h3>Evidence Details</h3>
          <div class="detail-header-actions">
            <button class="btn btn-ghost btn-icon btn-sm" id="extractMetadataBtn" title="Extract Metadata">
              <i class="fas fa-magnifying-glass"></i>
            </button>
            <button class="close-btn" id="closeDetailBtn" title="Close" type="button" onclick="hideDetail()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="detail-body" id="detailBody">
          <div class="preview-section" id="previewSection">
            <div class="preview-placeholder">
              <i class="fas fa-file"></i>
              <span>Select an item to preview</span>
            </div>
          </div>
          <div class="metadata-content" id="metadataContent">
            <!-- Populated dynamically -->
          </div>
          <div class="vericase-suggestions-panel" id="vericaseSuggestionsPanel">
            <div class="suggestions-panel-header">
              <h4><i class="fas fa-lightbulb"></i> VeriCase Suggestions</h4>
            </div>
            <div class="suggestions-panel-body" id="vericaseSuggestionsBody">
              <div class="suggestions-empty-state">
                <i class="fas fa-lightbulb"></i>
                <p>Select an evidence item to see AI-powered suggestions</p>
              </div>
            </div>
          </div>
          <div class="collab-panel" id="evidenceCollabPanel">
            <div class="collab-panel-header">
              <h4><i class="fas fa-comments"></i> Evidence Notes</h4>
              <div class="collab-panel-controls">
                <label class="collab-toggle">
                  <input type="checkbox" id="includeLinkedNotes" onchange="toggleLinkedNotes()">
                  Include claim-linked notes
                </label>
                <div class="lane-tabs" id="evidenceLaneTabs">
                  <button class="lane-tab active" data-lane="core" onclick="setEvidenceLane('core')">Core</button>
                  <button class="lane-tab" data-lane="counsel" onclick="setEvidenceLane('counsel')">Counsel</button>
                  <button class="lane-tab" data-lane="expert" onclick="setEvidenceLane('expert')">Expert</button>
                </div>
              </div>
            </div>
            <div class="collab-thread" id="evidenceCommentThread">
              <div class="collab-empty">Select an item to view notes.</div>
            </div>
            <div class="collab-input">
              <textarea id="evidenceCommentInput" placeholder="Add a note for this evidence item..."></textarea>
              <button class="btn btn-vericase btn-sm" id="evidenceCommentSend" onclick="postEvidenceNote()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="detail-actions">
          <button class="btn btn-ghost" id="viewItemBtn">
            <i class="fas fa-eye"></i> View
          </button>
          <button class="btn btn-vericase" id="downloadBtn">
            <i class="fas fa-download"></i> Download
          </button>
          <button class="btn btn-ghost" id="previewFullBtn">
            <i class="fas fa-expand"></i> Full Preview
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Full-Screen Preview Modal -->
  <div class="preview-modal" id="previewModal">
    <div class="preview-modal-header">
      <div class="preview-modal-title" id="previewModalTitle">
        File Preview
      </div>
      <div class="preview-modal-actions">
        <button class="btn btn-sm" id="modalDownloadBtn">
          <i class="fas fa-download"></i> Download
        </button>
        <button class="btn btn-sm" id="closePreviewModal">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
    <div class="preview-modal-body">
      <div class="preview-modal-content" id="previewModalContent">
        <!-- Populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Auto-Categorization Settings Modal -->
  <div class="settings-modal-overlay hidden" id="categorySettingsModal">
    <div class="settings-modal">
      <div class="settings-modal-header">
        <h3><i class="fas fa-cog"></i> Auto-Categorization Settings</h3>
        <button type="button" class="btn btn-ghost btn-sm" onclick="closeCategorySettings()" title="Close settings">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="settings-modal-body">
        <!-- Learning Toggle -->
        <div class="settings-section">
          <div class="settings-section-header">
            <h4><i class="fas fa-brain"></i> Learning</h4>
          </div>
          <label class="settings-toggle">
            <input type="checkbox" id="learningEnabledToggle" checked />
            <span>Learn from my categorizations</span>
          </label>
          <p class="settings-hint">When enabled, the system learns patterns from files you categorize to improve future suggestions.</p>
        </div>

        <!-- Custom Patterns -->
        <div class="settings-section">
          <div class="settings-section-header">
            <h4><i class="fas fa-filter"></i> Custom Patterns</h4>
            <button type="button" class="btn btn-sm btn-vericase" onclick="addCustomPattern()" title="Add custom pattern">
              <i class="fas fa-plus"></i> Add
            </button>
          </div>
          <p class="settings-hint">Define your own patterns to match filenames. Use regex syntax (e.g., "report.*2024" matches "report_jan_2024").</p>
          <div class="patterns-list" id="customPatternsList">
            <!-- Populated dynamically -->
          </div>
        </div>

        <!-- Learned Patterns -->
        <div class="settings-section">
          <div class="settings-section-header">
            <h4><i class="fas fa-graduation-cap"></i> Learned Patterns</h4>
            <button type="button" class="btn btn-sm btn-ghost" onclick="clearLearnedPatterns()" title="Clear all learned patterns">
              <i class="fas fa-trash"></i> Clear
            </button>
          </div>
          <p class="settings-hint">Patterns learned from your categorizations. Patterns used 2+ times will be applied automatically.</p>
          <div class="patterns-list" id="learnedPatternsList">
            <!-- Populated dynamically -->
          </div>
        </div>

        <!-- Built-in Patterns (read-only) -->
        <div class="settings-section">
          <div class="settings-section-header">
            <h4><i class="fas fa-list"></i> Built-in Patterns</h4>
          </div>
          <p class="settings-hint">Default patterns that are always available. Custom and learned patterns take priority.</p>
          <div class="patterns-list builtin-patterns">
            <div class="pattern-item readonly">
              <span class="pattern-text">meeting, minutes, mom</span>
              <span class="pattern-category">Meeting Minutes</span>
            </div>
            <div class="pattern-item readonly">
              <span class="pattern-text">progress report, monthly report</span>
              <span class="pattern-category">Progress Reports</span>
            </div>
            <div class="pattern-item readonly">
              <span class="pattern-text">valuation, interim cert</span>
              <span class="pattern-category">Client Valuations</span>
            </div>
            <div class="pattern-item readonly">
              <span class="pattern-text">change, variation, vo</span>
              <span class="pattern-category">Change</span>
            </div>
            <div class="pattern-item readonly">
              <span class="pattern-text">drawing, dwg, plan</span>
              <span class="pattern-category">Drawings</span>
            </div>
            <div class="pattern-item readonly">
              <span class="pattern-text">spec, specification</span>
              <span class="pattern-category">Specifications</span>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button type="button" class="btn btn-ghost" onclick="closeCategorySettings()">Close</button>
        <button type="button" class="btn btn-vericase" onclick="saveCategorySettings()">
          <i class="fas fa-save"></i> Save Settings
        </button>
      </div>
    </div>
  </div>

  <script>
    console.log("Evidence UI Version: 2.0.5 - CACHE BUSTED - " + Date.now());

    // ============================================
    // CONFIGURATION v1.0.1 - Cache bust
    // ============================================

    // Set AG Grid License Key (centralized)
    try {
      const agKey = window.VeriCaseConfig
        ? window.VeriCaseConfig.agGridLicenseKey
        : window.VERICASE_AG_GRID_LICENSE_KEY;
      if (agKey && window.agGrid && agGrid.LicenseManager) {
        agGrid.LicenseManager.setLicenseKey(agKey);
      }
    } catch (e) {
      console.warn("AG Grid license key init failed:", e);
    }

    const apiUrl = window.VeriCaseConfig
      ? window.VeriCaseConfig.apiUrl
      : window.location.origin;

    // Load AG Grid configuration from admin settings
    async function loadGridConfig() {
      try {
        const token = localStorage.getItem("token");
        if (!token) return {}; // Return empty config if not logged in

        const response = await fetch(`${apiUrl}/api/admin/settings`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return {}; // Return empty config if fetch fails

        const settings = await response.json();
        const config = {};

        settings.forEach(s => {
          if (s.key.startsWith('ag_grid_')) {
            const settingKey = s.key.replace('ag_grid_', '');
            config[settingKey] = s.value;
          }
        });

        console.log('[Grid Config] Loaded admin settings:', config);
        return config;
      } catch (error) {
        console.error('[Grid Config] Error loading settings:', error);
        return {}; // Return empty config on error
      }
    }

    // Store admin config globally for grid initialization
    let adminGridConfig = {};

    let gridApi = null;
    let columnApi = null;
    let selectedEvidence = null;
    let currentPreviewData = null;
    let evidenceLane = "core";
    let includeLinkedNotes = false;
    let projectId = null;
    let caseId = null;
    let currentCategory = "documents";
    let loadAllDataPromise = null; // Prevent infinite loops
    let serverSideFilterModel = {};
    let gridStateApplied = false;
    let gridStateKey = "";
    let columnsPanelOpen = false;
    let collectionsCache = [];

    function updateEvidenceLaneButtons() {
      const buttons = document.querySelectorAll("#evidenceLaneTabs .lane-tab");
      buttons.forEach(btn => {
        if (btn.dataset.lane === evidenceLane) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    function setEvidenceLane(lane) {
      evidenceLane = lane;
      updateEvidenceLaneButtons();
      updateEvidenceNotePlaceholder();
      loadEvidenceNotes();
    }

    function toggleLinkedNotes() {
      const checkbox = document.getElementById("includeLinkedNotes");
      includeLinkedNotes = checkbox ? checkbox.checked : false;
      loadEvidenceNotes();
    }

    function updateEvidenceNotePlaceholder() {
      const input = document.getElementById("evidenceCommentInput");
      if (!input) return;
      const placeholders = {
        core: "Record working position. (facts, evidence points, next steps)",
        counsel: "Record submissions. (legal test, pleadings framing, authorities)",
        expert: "Record expert analysis. (methodology, assumptions, conclusions)",
      };
      input.placeholder = placeholders[evidenceLane] || "Add a note for this evidence item...";
    }

    function renderEvidenceNote(comment, isReply = false) {
      const author = comment.created_by_name || "User";
      const time = comment.created_at ? formatTimeAgo(new Date(comment.created_at)) : "";
      const laneValue = (comment.lane || evidenceLane || "core").toLowerCase();
      const laneBadge = `<span class="lane-badge ${laneValue}">${laneValue}</span>`;
      const linkBadge = comment.item_claim_link_id ? `<span class="lane-badge">linked</span>` : "";
      const replies = comment.replies || [];

      return `
        <div class="collab-comment ${isReply ? "reply" : ""}">
          <div class="collab-comment-meta">${escapeHtml(author)}${time ? ` • ${time}` : ""} ${laneBadge} ${linkBadge}</div>
          <div>${escapeHtml(comment.content)}</div>
          ${replies.length > 0 ? replies.map(r => renderEvidenceNote(r, true)).join("") : ""}
        </div>
      `;
    }

    async function loadEvidenceNotes() {
      const thread = document.getElementById("evidenceCommentThread");
      if (!thread) return;

      if (!selectedEvidence) {
        thread.innerHTML = `<div class="collab-empty">Select an item to view notes.</div>`;
        return;
      }

      thread.innerHTML = `<div class="collab-empty">Loading notes...</div>`;

      try {
        const response = await VeriCaseConfig.apiCall(
          `/api/claims/comments/evidence/${selectedEvidence.id}?lane=${encodeURIComponent(evidenceLane)}`
        );
        const items = Array.isArray(response) ? response : (response.items || []);
        const directComments = items.filter(c => !c.item_claim_link_id);
        const linkedComments = items.filter(c => c.item_claim_link_id);

        if (!includeLinkedNotes && directComments.length === 0) {
          thread.innerHTML = `<div class="collab-empty">No notes in this lane yet.</div>`;
          return;
        }

        let html = "";
        if (directComments.length > 0) {
          html += directComments.map(c => renderEvidenceNote(c)).join("");
        } else {
          html += `<div class="collab-empty">No direct notes in this lane yet.</div>`;
        }

        if (includeLinkedNotes) {
          if (linkedComments.length > 0) {
            html += `<div class="collab-section-title">Claim-linked notes</div>`;
            html += linkedComments.map(c => renderEvidenceNote(c)).join("");
          } else {
            html += `<div class="collab-empty">No claim-linked notes in this lane yet.</div>`;
          }
        }

        thread.innerHTML = html;
      } catch (error) {
        console.error("[Evidence] Failed to load notes:", error);
        thread.innerHTML = `<div class="collab-empty">Failed to load notes.</div>`;
      }
    }

    async function postEvidenceNote() {
      if (!selectedEvidence) {
        VericaseUI.Toast.warning("Select an evidence item first.");
        return;
      }

      const input = document.getElementById("evidenceCommentInput");
      if (!input) return;

      const content = input.value.trim();
      if (!content) {
        VericaseUI.Toast.warning("Enter a note before posting.");
        return;
      }

      try {
        await VeriCaseConfig.apiCall(`/api/claims/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            content,
            item_type: "evidence",
            item_id: selectedEvidence.id,
            lane: evidenceLane,
          }),
        });

        input.value = "";
        VericaseUI.Toast.success("Note added");
        loadEvidenceNotes();
      } catch (error) {
        console.error("[Evidence] Failed to post note:", error);
        VericaseUI.Toast.error("Failed to add note");
      }
    }

    // Evidence type configuration
    const typeConfig = {
      contract: {
        label: "Contract",
        icon: "fa-file-contract",
        color: "#1e40af",
      },
      variation: {
        label: "Variation",
        icon: "fa-exchange-alt",
        color: "#92400e",
      },
      drawing: {
        label: "Drawing",
        icon: "fa-drafting-compass",
        color: "#3730a3",
      },
      specification: {
        label: "Specification",
        icon: "fa-clipboard-list",
        color: "#166534",
      },
      programme: {
        label: "Programme",
        icon: "fa-calendar-alt",
        color: "#0f766e",
      },
      invoice: {
        label: "Invoice",
        icon: "fa-file-invoice-dollar",
        color: "#166534",
      },
      payment_certificate: {
        label: "Payment Certificate",
        icon: "fa-certificate",
        color: "#0f766e",
      },
      meeting_minutes: {
        label: "Meeting Minutes",
        icon: "fa-id-badge",
        color: "#1e40af",
      },
      site_instruction: {
        label: "Site Instruction",
        icon: "fa-hard-hat",
        color: "#92400e",
      },
      rfi: { label: "RFI", icon: "fa-question-circle", color: "#6b21a8" },
      notice: {
        label: "Notice",
        icon: "fa-exclamation-triangle",
        color: "#991b1b",
      },
      letter: { label: "Letter", icon: "fa-envelope", color: "#475569" },
      email_attachment: {
        label: "Email Attachment",
        icon: "fa-paperclip",
        color: "#0369a1",
      },
      photo: { label: "Photo", icon: "fa-camera", color: "#6b21a8" },
      expert_report: {
        label: "Expert Report",
        icon: "fa-user-tie",
        color: "#1e40af",
      },
      pdf: { label: "PDF", icon: "fa-file-pdf", color: "#dc2626" },
      word_document: {
        label: "Word Doc",
        icon: "fa-file-word",
        color: "#2563eb",
      },
      spreadsheet: {
        label: "Spreadsheet",
        icon: "fa-file-excel",
        color: "#16a34a",
      },
      image: { label: "Image", icon: "fa-image", color: "#8b5cf6" },
      other: { label: "Other", icon: "fa-file", color: "#64748b" },
    };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    function getFileIcon(mimeType, evidenceType) {
      if (evidenceType && typeConfig[evidenceType]) {
        return typeConfig[evidenceType].icon;
      }
      if (mimeType) {
        if (mimeType.startsWith("image/")) return "fa-image";
        if (mimeType === "application/pdf") return "fa-file-pdf";
        if (mimeType.includes("word")) return "fa-file-word";
        if (mimeType.includes("excel") || mimeType.includes("spreadsheet"))
          return "fa-file-excel";
        if (
          mimeType.includes("powerpoint") ||
          mimeType.includes("presentation")
        )
          return "fa-file-powerpoint";
        if (mimeType.startsWith("text/")) return "fa-file-alt";
        if (mimeType.startsWith("audio/")) return "fa-file-audio";
        if (mimeType.startsWith("video/")) return "fa-file-video";
      }
      return "fa-file";
    }

    function getFileIconClass(mimeType) {
      if (!mimeType) return "";
      if (mimeType === "application/pdf") return "pdf";
      if (mimeType.includes("word")) return "word";
      if (mimeType.includes("excel") || mimeType.includes("spreadsheet"))
        return "excel";
      if (mimeType.startsWith("image/")) return "image";
      if (mimeType.includes("outlook") || mimeType === "message/rfc822")
        return "email";
      return "";
    }

    function formatFileSize(bytes) {
      if (!bytes) return "—";
      const k = 1024;
      const sizes = ["B", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
    }

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      try {
        const d = new Date(dateStr);
        return d.toLocaleDateString("en-GB", {
          day: "numeric",
          month: "short",
          year: "numeric",
        });
      } catch {
        return dateStr;
      }
    }

    function formatTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return "just now";
      if (minutes < 60) return `${minutes} min ago`;
      if (hours < 24) return `${hours} hour${hours > 1 ? "s" : ""} ago`;
      if (days < 7) return `${days} day${days > 1 ? "s" : ""} ago`;
      return date.toLocaleDateString();
    }

    function isImageFile(mimeType, filename) {
      if (mimeType?.startsWith("image/")) return true;
      const imageExts = [
        ".jpg",
        ".jpeg",
        ".png",
        ".gif",
        ".webp",
        ".svg",
        ".bmp",
        ".tiff",
        ".tif",
      ];
      return imageExts.some((ext) => filename?.toLowerCase().endsWith(ext));
    }

    function getFileTypeInfo(mimeType, filename) {
      const ext = filename?.split(".").pop()?.toLowerCase() || "";
      if (mimeType === "application/pdf" || ext === "pdf")
        return { label: "PDF", class: "pdf" };
      if (mimeType?.includes("word") || ["doc", "docx"].includes(ext))
        return { label: "Word", class: "word" };
      if (
        mimeType?.includes("excel") ||
        mimeType?.includes("spreadsheet") ||
        ["xls", "xlsx", "csv"].includes(ext)
      )
        return { label: "Excel", class: "excel" };
      if (
        mimeType?.includes("powerpoint") ||
        mimeType?.includes("presentation") ||
        ["ppt", "pptx"].includes(ext)
      )
        return { label: "PPT", class: "ppt" };
      if (mimeType?.startsWith("text/") || ["txt", "log", "md"].includes(ext))
        return { label: "Text", class: "text" };
      if (mimeType?.startsWith("image/"))
        return { label: "Image", class: "image" };
      return { label: ext.toUpperCase() || "File", class: "" };
    }

    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Infer category from evidence item based on filename patterns and metadata
    function inferCategory(item) {
      if (!item) return null;

      const filename = (item.filename || item.title || "").toLowerCase();
      const evidenceType = (item.evidence_type || "").toLowerCase();
      const mimeType = (item.mime_type || "").toLowerCase();

      // Load config to get custom and learned patterns
      const config = loadEvidenceConfig();

      // 1. First check custom patterns (highest priority - user defined)
      if (config.customPatterns && config.customPatterns.length > 0) {
        for (const {pattern, category} of config.customPatterns) {
          try {
            const regex = new RegExp(pattern, "i");
            if (regex.test(filename)) {
              return category;
            }
          } catch (e) {
            console.warn(`Invalid custom pattern: ${pattern}`, e);
          }
        }
      }

      // 2. Check learned patterns (high count patterns first - learned from user)
      if (config.learnedPatterns && config.learnedPatterns.length > 0) {
        // Only use patterns that have been used at least twice
        const reliablePatterns = config.learnedPatterns.filter(p => (p.count || 1) >= 2);
        for (const {pattern, category} of reliablePatterns) {
          try {
            const regex = new RegExp(pattern, "i");
            if (regex.test(filename)) {
              return category;
            }
          } catch (e) {
            console.warn(`Invalid learned pattern: ${pattern}`, e);
          }
        }
      }

      // 3. Built-in patterns (default fallback)
      const builtInPatterns = [
        { pattern: /meeting|minutes|mom/i, category: "Meeting Minutes" },
        { pattern: /progress.*report|monthly.*report|weekly.*report/i, category: "Progress Reports" },
        { pattern: /client.*valuation|valuation.*cert|interim.*cert/i, category: "Client Valuations" },
        { pattern: /client.*payment|payment.*cert/i, category: "Client Payment Certificates" },
        { pattern: /change|variation|vo|instruction/i, category: "Change" },
        { pattern: /subcontractor.*valuation|sub.*valuation|subc.*val/i, category: "Subcontractor Valuations" },
        { pattern: /subcontractor.*payment|sub.*payment|subc.*pay/i, category: "Subcontractor Payment Certificates" },
        { pattern: /site.*instruction|si\d|architect.*instruction|ai\d/i, category: "Site Instructions" },
        { pattern: /drawing|dwg|plan|elevation|section|detail/i, category: "Drawings" },
        { pattern: /spec|specification/i, category: "Specifications" },
      ];

      for (const {pattern, category} of builtInPatterns) {
        if (pattern.test(filename)) {
          return category;
        }
      }

      // 4. Evidence type mapping (lowest priority)
      if (evidenceType === "meeting_minutes") return "Meeting Minutes";
      if (evidenceType === "drawing") return "Drawings";
      if (evidenceType === "specification") return "Specifications";
      if (evidenceType === "payment_certificate") return "Client Payment Certificates";
      if (evidenceType === "valuation") return "Client Valuations";

      return null;
    }

    // Auto-categorize all uncategorized evidence items
    async function runAutoCategorization() {
      const toggle = document.getElementById("autoCategorizeToggle");
      if (!toggle.checked) return;

      VericaseUI.Toast.info("Starting auto-categorization...");

      try {
        // Fetch uncategorized items
        const query = new URLSearchParams();
        if (projectId) query.append("project_id", projectId);
        if (caseId) query.append("case_id", caseId);

        const response = await fetch(
          `${apiUrl}/api/evidence/items/server-side?${query.toString()}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              startRow: 0,
              endRow: 500,
              filterModel: { category: { filter: "", type: "blank" } }
            }),
          }
        );

        if (!response.ok) {
          throw new Error("Failed to fetch evidence items");
        }

        const data = await response.json();
        const items = data.rows || [];
        let categorized = 0;

        // Process items and suggest categories
        for (const item of items) {
          if (item.category) continue;

          const suggestedCategory = inferCategory(item);
          if (suggestedCategory) {
            try {
              const updateResponse = await fetch(`${apiUrl}/api/evidence/${item.id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ category: suggestedCategory }),
              });
              if (updateResponse.ok) {
                categorized++;
              }
            } catch (e) {
              console.warn(`Failed to categorize ${item.id}:`, e);
            }
          }
        }

        if (categorized > 0) {
          VericaseUI.Toast.success(`Auto-categorized ${categorized} items`);
          refreshGridData();
          loadCollections();
        } else {
          VericaseUI.Toast.info("No items could be auto-categorized");
        }
      } catch (error) {
        console.error("Auto-categorization failed:", error);
        VericaseUI.Toast.error("Auto-categorization failed");
      }
    }

    function getFilingCollections() {
      const skip = new Set([
        "all evidence",
        "unassigned",
        "recent uploads",
        "starred",
      ]);
      return (collectionsCache || []).filter((c) => {
        const name = (c?.name || "").trim().toLowerCase();
        return name && !skip.has(name);
      });
    }

    function findCollectionByNames(names) {
      const lookup = new Set(names.map((n) => n.toLowerCase()));
      return getFilingCollections().find((c) =>
        lookup.has((c.name || "").toLowerCase()),
      );
    }

    function inferAutofileCollection(detail) {
      if (!detail) return null;
      const mimeType = detail.mime_type || "";
      const evidenceType = detail.evidence_type || "";
      const fileType = (detail.file_type || "").toLowerCase();

      if (mimeType.startsWith("image/")) {
        return (
          findCollectionByNames(["Photos", "Images", "Images & Media"]) || null
        );
      }
      if (evidenceType === "drawing") {
        return findCollectionByNames(["Drawings"]) || null;
      }
      if (evidenceType === "contract") {
        return findCollectionByNames(["Contracts"]) || null;
      }
      if (evidenceType === "invoice" || evidenceType === "payment_certificate") {
        return findCollectionByNames(["Invoices & Payments", "Invoices"]) || null;
      }
      if (evidenceType === "meeting_minutes") {
        return findCollectionByNames(["Meeting Minutes"]) || null;
      }
      if (
        evidenceType === "correspondence" ||
        evidenceType === "email_attachment" ||
        detail.source_type === "pst_extraction"
      ) {
        return findCollectionByNames(["Correspondence"]) || null;
      }
      if (fileType === "xls" || fileType === "xlsx") {
        return findCollectionByNames(["Programme"]) || null;
      }
      return null;
    }

    async function assignEvidenceToCollection(collectionId) {
      if (!selectedEvidence || !collectionId) return;
      try {
        const response = await fetch(
          `${apiUrl}/api/evidence/collections/${collectionId}/items/${selectedEvidence.id}`,
          { method: "POST" },
        );
        if (response.ok) {
          VericaseUI.Toast.success("Filed to collection");
          refreshGridData();
          loadCollections();
        } else {
          VericaseUI.Toast.error("Failed to file to collection");
        }
      } catch (e) {
        console.error("Collection assignment failed:", e);
        VericaseUI.Toast.error("Failed to file to collection");
      }
    }

    function setupCollectionActions() {
      const select = document.getElementById("collectionSelect");
      const assignBtn = document.getElementById("assignCollectionBtn");
      const autoBtn = document.getElementById("autoFileBtn");
      if (assignBtn && select) {
        assignBtn.addEventListener("click", () => {
          const collectionId = select.value;
          if (!collectionId) {
            VericaseUI.Toast.error("Select a collection first");
            return;
          }
          assignEvidenceToCollection(collectionId);
        });
      }
      if (autoBtn) {
        autoBtn.addEventListener("click", () => {
          const target = inferAutofileCollection(selectedEvidence);
          if (!target) {
            VericaseUI.Toast.error("No matching collection found");
            return;
          }
          assignEvidenceToCollection(target.id);
        });
      }
    }

    function getGridStateKey() {
      const ctxType = caseId ? "case" : "project";
      const ctxId = caseId || projectId || "default";
      return `vc_evidence_grid_state:${ctxType}:${ctxId}`;
    }

    function getEvidenceConfigKey() {
      const ctxType = caseId ? "case" : "project";
      const ctxId = caseId || projectId || "default";
      return `vc_evidence_config:${ctxType}:${ctxId}`;
    }

    function loadEvidenceConfig() {
      const key = getEvidenceConfigKey();
      const saved = localStorage.getItem(key);
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          console.warn("Failed to parse evidence config:", e);
        }
      }
      return {
        autoCategorize: false,
        customPatterns: [], // User-defined patterns: [{pattern: "string", category: "Category Name"}]
        learnedPatterns: [], // Learned from user categorizations: [{pattern: "string", category: "Category Name", count: 1}]
        learningEnabled: true, // Whether to learn from user categorizations
      };
    }

    function saveEvidenceConfig(config) {
      const key = getEvidenceConfigKey();
      localStorage.setItem(key, JSON.stringify(config));
    }

    // Extract potential patterns from a filename for learning
    function extractPatternsFromFilename(filename) {
      if (!filename) return [];
      const patterns = [];
      const name = filename.toLowerCase().replace(/\.[^/.]+$/, ""); // Remove extension

      // Extract meaningful words (3+ chars, not common words)
      const stopWords = new Set(["the", "and", "for", "from", "with", "this", "that", "are", "was", "were", "been", "have", "has", "had", "will", "would", "could", "should", "may", "might", "must", "shall", "can", "need", "pdf", "doc", "docx", "xls", "xlsx"]);
      const words = name.split(/[^a-z0-9]+/).filter(w => w.length >= 3 && !stopWords.has(w));

      // Add individual significant words as patterns
      words.forEach(word => {
        if (word.length >= 4) {
          patterns.push(word);
        }
      });

      // Add two-word combinations for more specificity
      for (let i = 0; i < words.length - 1; i++) {
        patterns.push(`${words[i]}.*${words[i + 1]}`);
      }

      return patterns.slice(0, 5); // Limit to top 5 patterns
    }

    // Learn from user categorization
    function learnFromCategorization(filename, category) {
      if (!filename || !category) return;

      const config = loadEvidenceConfig();
      if (!config.learningEnabled) return;

      const patterns = extractPatternsFromFilename(filename);
      if (patterns.length === 0) return;

      // Initialize learned patterns if not exists
      if (!config.learnedPatterns) config.learnedPatterns = [];

      // Add or update learned patterns
      patterns.forEach(pattern => {
        const existing = config.learnedPatterns.find(
          p => p.pattern === pattern && p.category === category
        );
        if (existing) {
          existing.count = (existing.count || 1) + 1;
        } else {
          config.learnedPatterns.push({ pattern, category, count: 1 });
        }
      });

      // Keep only top patterns (limit to 100 to prevent storage bloat)
      config.learnedPatterns.sort((a, b) => (b.count || 1) - (a.count || 1));
      config.learnedPatterns = config.learnedPatterns.slice(0, 100);

      saveEvidenceConfig(config);
      console.log(`[Auto-categorize] Learned patterns from "${filename}" → ${category}`);
    }

    // ============================================
    // CATEGORY SETTINGS MODAL
    // ============================================

    const defaultCategories = [
      "Meeting Minutes",
      "Progress Reports",
      "Client Valuations",
      "Client Payment Certificates",
      "Change",
      "Subcontractor Valuations",
      "Subcontractor Payment Certificates",
      "Site Instructions",
      "Drawings",
      "Specifications"
    ];

    function openCategorySettings() {
      const modal = document.getElementById("categorySettingsModal");
      modal.classList.remove("hidden");
      populateSettingsModal();
    }

    function closeCategorySettings() {
      const modal = document.getElementById("categorySettingsModal");
      modal.classList.add("hidden");
    }

    function populateSettingsModal() {
      const config = loadEvidenceConfig();

      // Set learning toggle
      const learningToggle = document.getElementById("learningEnabledToggle");
      learningToggle.checked = config.learningEnabled !== false;

      // Render custom patterns
      renderCustomPatterns(config.customPatterns || []);

      // Render learned patterns
      renderLearnedPatterns(config.learnedPatterns || []);
    }

    function renderCustomPatterns(patterns) {
      const container = document.getElementById("customPatternsList");
      if (!patterns || patterns.length === 0) {
        container.innerHTML = '<div class="patterns-empty">No custom patterns defined. Click "Add" to create one.</div>';
        return;
      }

      container.innerHTML = patterns.map((p, idx) => `
        <div class="pattern-item">
          <span class="pattern-text">${escapeHtml(p.pattern)}</span>
          <span class="pattern-category">${escapeHtml(p.category)}</span>
          <button type="button" class="btn-delete" onclick="deleteCustomPattern(${idx})" title="Delete pattern">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join("");
    }

    function renderLearnedPatterns(patterns) {
      const container = document.getElementById("learnedPatternsList");
      if (!patterns || patterns.length === 0) {
        container.innerHTML = '<div class="patterns-empty">No patterns learned yet. Categorize some files to start learning.</div>';
        return;
      }

      // Show top 20 learned patterns
      const topPatterns = patterns.slice(0, 20);
      container.innerHTML = topPatterns.map((p, idx) => `
        <div class="pattern-item">
          <span class="pattern-text">${escapeHtml(p.pattern)}</span>
          <span class="pattern-category">${escapeHtml(p.category)}</span>
          <span class="pattern-count">×${p.count || 1}</span>
          <button type="button" class="btn-delete" onclick="deleteLearnedPattern(${idx})" title="Delete pattern">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join("");
    }

    function addCustomPattern() {
      const pattern = prompt("Enter pattern (regex syntax, e.g., 'report.*2024'):");
      if (!pattern || !pattern.trim()) return;

      // Validate regex
      try {
        new RegExp(pattern.trim());
      } catch (e) {
        VericaseUI.Toast.error("Invalid regex pattern: " + e.message);
        return;
      }

      // Select category
      const category = prompt(
        "Select category:\n" +
        defaultCategories.map((c, i) => `${i + 1}. ${c}`).join("\n") +
        "\n\nEnter number or custom category name:"
      );
      if (!category || !category.trim()) return;

      let finalCategory = category.trim();
      const num = parseInt(finalCategory);
      if (num >= 1 && num <= defaultCategories.length) {
        finalCategory = defaultCategories[num - 1];
      }

      const config = loadEvidenceConfig();
      if (!config.customPatterns) config.customPatterns = [];
      config.customPatterns.push({ pattern: pattern.trim(), category: finalCategory });
      saveEvidenceConfig(config);

      renderCustomPatterns(config.customPatterns);
      VericaseUI.Toast.success(`Pattern added: "${pattern.trim()}" → ${finalCategory}`);
    }

    function deleteCustomPattern(index) {
      const config = loadEvidenceConfig();
      if (config.customPatterns && config.customPatterns[index]) {
        config.customPatterns.splice(index, 1);
        saveEvidenceConfig(config);
        renderCustomPatterns(config.customPatterns);
        VericaseUI.Toast.success("Pattern deleted");
      }
    }

    function deleteLearnedPattern(index) {
      const config = loadEvidenceConfig();
      if (config.learnedPatterns && config.learnedPatterns[index]) {
        config.learnedPatterns.splice(index, 1);
        saveEvidenceConfig(config);
        renderLearnedPatterns(config.learnedPatterns);
        VericaseUI.Toast.success("Pattern deleted");
      }
    }

    function clearLearnedPatterns() {
      if (!confirm("Are you sure you want to clear all learned patterns? This cannot be undone.")) {
        return;
      }
      const config = loadEvidenceConfig();
      config.learnedPatterns = [];
      saveEvidenceConfig(config);
      renderLearnedPatterns([]);
      VericaseUI.Toast.success("All learned patterns cleared");
    }

    function saveCategorySettings() {
      const config = loadEvidenceConfig();
      const learningToggle = document.getElementById("learningEnabledToggle");
      config.learningEnabled = learningToggle.checked;
      saveEvidenceConfig(config);
      VericaseUI.Toast.success("Settings saved");
      closeCategorySettings();
    }

    function applySavedGridState() {
      if (!gridApi || !gridStateKey) return false;
      const raw = localStorage.getItem(gridStateKey);
      if (!raw) return false;
      try {
        const saved = JSON.parse(raw);
        if (!saved || !Array.isArray(saved.columnState)) return false;
        gridApi.applyColumnState({ state: saved.columnState, applyOrder: true });
        gridStateApplied = true;
        return true;
      } catch (e) {
        console.warn("Failed to apply saved grid state:", e);
        return false;
      }
    }

    function saveGridState() {
      if (!gridApi || !gridStateKey) return;
      const state = {
        version: 1,
        columnState: gridApi.getColumnState(),
      };
      localStorage.setItem(gridStateKey, JSON.stringify(state));
      if (window.VericaseUI && VericaseUI.Toast) {
        VericaseUI.Toast.success("Layout saved");
      }
    }

    function resetGridState() {
      if (!gridApi || !gridStateKey) return;
      localStorage.removeItem(gridStateKey);
      gridApi.resetColumnState();
      gridStateApplied = false;
      autoFitGrid(true);
      if (window.VericaseUI && VericaseUI.Toast) {
        VericaseUI.Toast.info("Layout reset");
      }
    }

    function autoFitGrid(force = false) {
      if (!gridApi) return;
      if (!force && gridStateApplied) return;
      requestAnimationFrame(() => {
        try {
          gridApi.sizeColumnsToFit();
        } catch (e) {
          console.warn("Auto-fit failed:", e);
        }
      });
    }

    function toggleColumnsPanel() {
      if (!gridApi) return;
      columnsPanelOpen = !columnsPanelOpen;
      if (columnsPanelOpen) {
        gridApi.setSideBarVisible(true);
        gridApi.openToolPanel("columns");
      } else {
        gridApi.closeToolPanel();
        gridApi.setSideBarVisible(false);
      }
    }

    // ============================================
    // GRID SETUP
    // ============================================

    async function initGrid() {
      // Load admin grid configuration
      adminGridConfig = await loadGridConfig();

      // Safe data accessor - prevents errors when data is missing
      const safeGet = (data, key, fallback = "") => {
        if (!data) return fallback;
        const val = data[key];
        if (val === null || val === undefined) return fallback;
        return val;
      };

      const gridOptions = {
        rowModelType: "serverSide",
        cacheBlockSize: 100,
        getRowId: (params) => {
          const id = params.data?.id;
          return id ? String(id) : undefined;
        },
        paginationPageSize: 100,
        columnDefs: [
          {
            field: "thumbnail",
            headerName: "",
            width: 60,
            sortable: false,
            filter: false,
            cellRenderer: (params) => {
              if (!params.data)
                return '<div class="grid-file-icon"><i class="fas fa-file"></i></div>';
              const mimeType = safeGet(params.data, "mime_type", "");
              const evidenceType = safeGet(params.data, "evidence_type", "");
              const downloadUrl = safeGet(params.data, "download_url", "");
              const icon = getFileIcon(mimeType, evidenceType);
              const iconClass = getFileIconClass(mimeType);
              if (mimeType.startsWith("image/") && downloadUrl) {
                return `<img src="${downloadUrl}" class="grid-thumbnail" alt="" loading="lazy">`;
              }
              return `<div class="grid-file-icon ${iconClass}"><i class="fas ${icon}"></i></div>`;
            },
          },
          {
            field: "filename",
            headerName: "Name",
            width: 280,
            minWidth: 180,
            maxWidth: 400,
            cellRenderer: (params) => {
              if (!params.data) return "-";
              const mimeType = safeGet(params.data, "mime_type", "");
              const filename = safeGet(params.data, "filename", "Unknown");
              const title = safeGet(params.data, "title", "");
              const fileSize = safeGet(params.data, "file_size", 0);
              const author = safeGet(params.data, "author", "");
              const pageCount = safeGet(params.data, "page_count", null);
              const docDate = safeGet(params.data, "document_date", null);
              const typeInfo = getFileTypeInfo(mimeType, filename);
              const metaParts = [
                typeInfo.label,
                formatFileSize(fileSize),
                pageCount ? `${pageCount} pages` : null,
                author ? author : null,
                docDate ? formatDate(docDate) : null,
              ].filter(Boolean);
              return `
                                <div class="file-info">
                                    <span class="file-name">${escapeHtml(title || filename)}</span>
                                    <span class="file-meta">${metaParts.join(" • ")}</span>
                                </div>
                            `;
            },
          },
          {
            field: "document_date",
            headerName: "Date",
            width: 120,
            valueGetter: (params) =>
              params.data?.document_date ||
              params.data?.source_email_date ||
              null,
            valueFormatter: (params) => formatDate(params.value),
          },
          {
            field: "processing_status",
            headerName: "Status",
            width: 120,
            cellRenderer: (params) => {
              const status = params.value || "pending";
              return `<span class="status-badge status-${status}">${status}</span>`;
            },
          },
          {
            field: "origin",
            headerName: "Origin",
            width: 160,
            valueGetter: (params) => {
              if (!params.data) return null;
              // Check if it's from an email attachment
              if (params.data.source_email_id) {
                return "Email Attachment";
              }
              // Check for uploader name
              if (params.data.uploader_name || params.data.uploader_display_name) {
                return params.data.uploader_name || params.data.uploader_display_name;
              }
              // Check for uploaded_by user ID (fallback)
              if (params.data.uploaded_by) {
                return "Manual Upload";
              }
              return "Manual Upload";
            },
            cellRenderer: (params) => {
              const origin = params.value;
              if (!origin) {
                return '<span style="color: var(--text-muted);">—</span>';
              }
              const isEmail = origin === "Email Attachment";
              const icon = isEmail ? "fa-envelope" : "fa-user";
              const color = isEmail ? "var(--vericase-teal)" : "var(--text-secondary)";
              return `<span style="color: ${color}; font-weight: 500;"><i class="fas ${icon}" style="margin-right: 6px;"></i>${escapeHtml(origin)}</span>`;
            },
          },
          {
            field: "file_type",
            headerName: "Format",
            width: 100,
            cellRenderer: (params) => {
              const ext = params.value;
              if (!ext)
                return '<span style="color: var(--text-muted);">—</span>';
              
              const mimeType = safeGet(params.data, "mime_type", "");
              const evidenceType = safeGet(params.data, "evidence_type", "");
              const icon = getFileIcon(mimeType, evidenceType);
              const iconClass = getFileIconClass(mimeType);
              
              return `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="grid-file-icon ${iconClass}" style="width: 24px; height: 24px; font-size: 0.75rem;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <span style="text-transform: uppercase; font-weight: 500; font-size: 0.75rem;">${ext}</span>
                </div>
              `;
            },
          },
          {
            field: "extracted_parties",
            headerName: "Stakeholders",
            width: 160,
            cellRenderer: (params) => {
              const parties = params.value;
              if (!parties || !Array.isArray(parties) || parties.length === 0)
                return '<span style="color: var(--text-muted);">—</span>';
              const display = parties.slice(0, 2).join(", ");
              const extra =
                parties.length > 2 ? ` +${parties.length - 2}` : "";
              return `<span style="color: var(--vericase-teal); font-size: 0.75rem;">${display}${extra}</span>`;
            },
          },
          {
            field: "category",
            headerName: "Category",
            width: 150,
            editable: true,
            cellEditor: "agSelectCellEditor",
            cellEditorParams: {
              values: [
                "",
                "Meeting Minutes",
                "Progress Reports",
                "Client Valuations",
                "Client Payment Certificates",
                "Change",
                "Subcontractor Valuations",
                "Subcontractor Payment Certificates",
                "Site Instructions",
                "Drawings",
                "Specifications"
              ]
            },
            valueGetter: (params) => {
              // Try to get category from various possible fields
              return params.data?.category || params.data?.collection_name || "";
            },
            cellRenderer: (params) => {
              const category = params.value;
              if (!category)
                return '<span style="color: var(--text-muted);">—</span>';
              return `<span style="color: var(--vericase-teal); font-weight: 500; font-size: 0.75rem;"><i class="fas fa-folder" style="margin-right: 4px;"></i>${escapeHtml(category)}</span>`;
            },
          },
          {
            field: "correspondence_count",
            headerName: "Links",
            width: 80,
            cellRenderer: (params) => {
              const count = params.value || 0;
              if (count > 0) {
                return `<span style="color: var(--vericase-teal);"><i class="fas fa-link"></i> ${count}</span>`;
              }
              return `<span style="color: var(--text-muted);">—</span>`;
            },
          },
          {
            field: "source_email_subject",
            headerName: "Source Email",
            width: 200,
            wrapText: true,
            autoHeight: true,
            cellStyle: { 
              whiteSpace: 'normal',
              wordWrap: 'break-word',
              lineHeight: '1.4',
              padding: '8px'
            },
            cellRenderer: (params) => {
              const subject = params.value;
              const emailId = safeGet(params.data, "source_email_id", "");
              const senderName = safeGet(params.data, "source_email_sender", "");
              const preview = safeGet(params.data, "source_email_preview", "");
              const messageId = safeGet(params.data, "source_email_message_id", "");
              const evidenceId = safeGet(params.data, "id", "");
              
              if (!subject && !emailId) {
                return '<span style="color: var(--text-muted);">-</span>';
              }
              
              const displayText = subject || "Email";
              const senderInfo = senderName ? `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">From: ${escapeHtml(senderName)}</div>` : "";
              const previewInfo = preview ? `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; line-height: 1.3;">${escapeHtml(preview.substring(0, 100))}${preview.length > 100 ? '...' : ''}</div>` : "";
              const ref = messageId || emailId;
              const refInfo = ref ? `\nRef: ${ref}` : "";
              
              if (emailId) {
                return `
                  <div style="display: flex; align-items: flex-start; gap: 8px; width: 100%;">
                    <div style="flex: 1; min-width: 0; word-wrap: break-word; overflow-wrap: break-word;">
                      <div style="color: var(--vericase-teal); font-weight: 500; word-wrap: break-word; overflow-wrap: break-word;">
                        <i class="fas fa-envelope-open-text" style="margin-right: 4px; font-size: 0.75rem;"></i>
                        <span style="word-wrap: break-word; overflow-wrap: break-word;">${escapeHtml(displayText)}</span>
                      </div>
                      ${senderInfo}
                      ${previewInfo}
                    </div>
                    <button 
                      class="btn-icon-small" 
                      onclick="event.stopPropagation(); openSourceEmail('${emailId}')" 
                      title="View source email${escapeHtml(refInfo)}"
                      style="flex-shrink: 0; padding: 4px 6px; border: none; background: transparent; color: var(--vericase-teal); cursor: pointer; border-radius: 4px; transition: background 0.2s;"
                      onmouseover="this.style.background='rgba(31, 111, 120, 0.1)'"
                      onmouseout="this.style.background='transparent'"
                    >
                      <i class="fas fa-external-link-alt" style="font-size: 0.75rem;"></i>
                    </button>
                  </div>
                `;
              }
              return `
                <div style="word-wrap: break-word; overflow-wrap: break-word;">
                  <span style="color: var(--text-secondary);">
                    <i class="fas fa-envelope" style="margin-right: 4px;"></i>
                    <span style="word-wrap: break-word; overflow-wrap: break-word;">${escapeHtml(displayText)}</span>
                  </span>
                  ${previewInfo}
                </div>
              `;
            },
          },
          {
            field: "is_starred",
            headerName: "",
            width: 50,
            sortable: false,
            filter: false,
            cellRenderer: (params) => {
              if (!params.data) return "";
              const starred = params.value;
              const id = safeGet(params.data, "id", "");
              return `<button class="star-btn ${starred ? "starred" : ""}" onclick="event.stopPropagation(); toggleStar('${id}')">
                                <i class="fas fa-star"></i>
                            </button>`;
            },
          },
        ],
        defaultColDef: {
          sortable: true,
          filter: true,
          resizable: true,
          // Flexible cell rendering - handle any data type gracefully
          valueFormatter: (params) => {
            if (params.value === null || params.value === undefined)
              return "-";
            if (Array.isArray(params.value))
              return params.value.join(", ") || "-";
            if (typeof params.value === "object") {
              try {
                return JSON.stringify(params.value);
              } catch {
                return String(params.value);
              }
            }
            return String(params.value);
          },
          // Handle long text gracefully
          wrapText: true,
          autoHeight: true,
          cellStyle: { "white-space": "normal", "line-height": "1.35" },
        },
        // Suppress errors for missing row data
        suppressRowClickSelection: false,
        rowSelection: "single",
        animateRows: true,
        suppressRowTransform: true,
        sideBar: {
          toolPanels: [
            {
              id: "columns",
              labelDefault: "Columns",
              labelKey: "columns",
              iconKey: "columns",
              toolPanel: "agColumnsToolPanel",
              toolPanelParams: {
                suppressRowGroups: true,
                suppressValues: true,
                suppressPivots: true,
                suppressPivotMode: true,
              },
            },
          ],
        },
        onGridReady: (params) => {
          gridApi = params.api;
          // columnApi is deprecated in v31, use gridApi for column operations
          columnApi = params.columnApi || null;
          gridStateKey = getGridStateKey();
          applySavedGridState();
          gridApi.setSideBarVisible(false);
        },
        onFirstDataRendered: () => {
          autoFitGrid();
        },
        // Apply row height from admin settings (default 56 for evidence grid)
        rowHeight: adminGridConfig.default_row_height ? parseInt(adminGridConfig.default_row_height) : 56,
        headerHeight: 44,
        // Safe row click handler
        onRowClicked: (params) => {
          if (!params.data) return;
          const panel = document.getElementById("detailPanel");
          if (
            panel.classList.contains("open") &&
            selectedEvidence?.id === params.data.id
          ) {
            hideDetail();
            return;
          }
          showDetail(params.data);
        },
        // Handle grid errors gracefully
        onGridSizeChanged: (params) => {
          try {
            const gridEl = document.getElementById("evidenceGrid");
            if (!gridEl || gridEl.offsetWidth === 0) return;
            autoFitGrid();
          } catch (e) {
            console.warn("Grid size adjustment failed:", e);
          }
        },
        // Handle category changes when user edits the category cell
        onCellValueChanged: async (params) => {
          if (params.colDef.field === "category" && params.data?.id) {
            const evidenceId = params.data.id;
            const newCategory = params.newValue || "";
            const filename = params.data.filename || params.data.title || "";
            try {
              const response = await fetch(`${apiUrl}/api/evidence/${evidenceId}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ category: newCategory }),
              });
              if (response.ok) {
                VericaseUI.Toast.success(`Category updated to "${newCategory || 'None'}"`);
                // Learn from this categorization for future auto-categorization
                if (newCategory && filename) {
                  learnFromCategorization(filename, newCategory);
                }
                // Refresh collections to update counts
                loadCollections();
              } else {
                const error = await response.json();
                VericaseUI.Toast.error(error.detail || "Failed to update category");
                // Revert the cell value on error
                params.node.setDataValue("category", params.oldValue);
              }
            } catch (error) {
              console.error("Error updating category:", error);
              VericaseUI.Toast.error("Failed to update category");
              params.node.setDataValue("category", params.oldValue);
            }
          }
        },
      };

      const gridDiv = document.getElementById("evidenceGrid");

      // Apply theme from admin settings
      const requestedTheme = String(adminGridConfig.theme || "quartz").toLowerCase();
      const supportedThemes = new Set(["quartz", "alpine"]);
      const theme = supportedThemes.has(requestedTheme) ? requestedTheme : "quartz";
      // Keep our custom theme class alongside the base theme.
      gridDiv.className = `ag-theme-${theme} ag-theme-vericase`;
      console.log("[Grid Config] Applied theme:", theme);

      // Use createGrid API (v31+) instead of deprecated new Grid()
      gridApi = agGrid.createGrid(gridDiv, gridOptions);
      gridApi.setGridOption("serverSideDatasource", createServerSideDatasource());
      gridApi.showLoadingOverlay(); // Show overlay immediately so user sees a loading state

      console.log("[Evidence] Grid initialized with admin config:", adminGridConfig);
    }

    // ============================================
    // DATA LOADING (with prefetch support)
    // ============================================

    // Check for prefetched data from master dashboard
    function getPrefetchedData() {
      try {
        const cached = sessionStorage.getItem("vericase_evidence_prefetch");
        if (cached) {
          const data = JSON.parse(cached);
          // Only use if cached within last 5 minutes
          const MAX_AGE = 5 * 60 * 1000;
          if (Date.now() - data.timestamp < MAX_AGE) {
            console.log("[Evidence] Using prefetched data from dashboard");
            return data;
          }
          // Clear stale cache
          sessionStorage.removeItem("vericase_evidence_prefetch");
        }
      } catch (e) {
        console.warn("[Evidence] Prefetch cache read failed:", e);
      }
      return null;
    }

    function refreshGridData() {
      if (!gridApi) return;
      gridApi.showLoadingOverlay();
      gridApi.refreshServerSideStore({ purge: true });
    }

    async function loadAllData() {
      // Prevent multiple simultaneous loads (fixes infinite loop)
      if (loadAllDataPromise) {
        console.log("[Evidence] loadAllData already running, skipping duplicate call");
        return loadAllDataPromise;
      }

      loadAllDataPromise = (async () => {
        try {
          const prefetched = getPrefetchedData();

          // Use prefetched collections/stats if available (for faster sidebar render)
          // Note: Dashboard only prefetches collections and stats, NOT items
          if (prefetched) {
            console.log(
              "[Evidence] Using prefetched collections/stats from dashboard",
            );

            // Render collections and stats immediately from cache
            if (prefetched.collections) {
              renderCollections(prefetched.collections);
            }
            if (prefetched.stats) {
              renderStats(prefetched.stats);
            }

            // Clear used cache
            sessionStorage.removeItem("vericase_evidence_prefetch");

            refreshGridData();
          } else {
            // Normal loading - fetch everything
            await Promise.all([loadCollections(), loadStats()]);
            refreshGridData();
          }
        } finally {
          loadAllDataPromise = null;
        }
      })();

      return loadAllDataPromise;
    }

    function applyFilters() {
      if (!gridApi) return;

      const filterModel = {};

      // Category filter -> MIME type based filtering
      if (currentCategory === "images") {
        // Filter for images, videos, and audio files
        filterModel["mime_type"] = {
          filterType: "text",
          type: "startsWith",
          filter: "image/",
        };
      } else if (currentCategory === "documents") {
        // Filter for documents (exclude images, videos, audio)
        // Use a combination filter: application/* or text/* but not image/*, video/*, audio/*
        filterModel["mime_type"] = {
          filterType: "text",
          type: "startsWith",
          filter: "application/",
        };
      }
      // "all" category doesn't add any filter - show everything

      // Search filter -> filename contains
      const search = document
        .getElementById("searchInput")
        .value.toLowerCase()
        .trim();
      if (search) {
        filterModel["filename"] = {
          filterType: "text",
          type: "contains",
          filter: search,
        };
      }

      // File type filter
      const fileType = document.getElementById("fileTypeFilter").value;
      if (fileType) {
        const setValues = [];
        switch (fileType) {
          case "pdf":
            setValues.push("pdf");
            break;
          case "word":
            setValues.push("doc", "docx", "word");
            break;
          case "excel":
            setValues.push("xls", "xlsx", "csv", "spreadsheet");
            break;
          case "powerpoint":
            setValues.push("ppt", "pptx", "presentation");
            break;
          case "text":
            setValues.push("txt", "log", "md", "text");
            break;
          case "image":
            filterModel["is_image"] = true;
            break;
          case "other":
            // handled by server as no-op; rely on backend defaults
            break;
        }
        if (setValues.length > 0) {
          filterModel["file_type"] = {
            filterType: "set",
            values: setValues,
          };
        }
      }

      // Status filter
      const status = document.getElementById("statusFilter").value;
      if (status) {
        filterModel["processing_status"] = {
          filterType: "set",
          values: [status],
        };
      }

      // Unassigned filter
      if (document.getElementById("unassignedFilter").checked) {
        filterModel["unassigned"] = true;
      }

      // Starred filter
      if (document.getElementById("starredFilter").checked) {
        filterModel["is_starred"] = true;
      }

      serverSideFilterModel = filterModel;
      refreshGridData();
    }

    function createServerSideDatasource() {
      return {
        getRows: async (params) => {
          try {
            const activeCollection = document.querySelector(".collection-item.active");
            const collectionId = activeCollection?.dataset.id;
            const categoryFilter = activeCollection?.dataset.category;

            const query = new URLSearchParams();
            if (projectId) query.append("project_id", projectId);
            if (caseId) query.append("case_id", caseId);
            if (collectionId) query.append("collection_id", collectionId);
            if (categoryFilter) query.append("category", categoryFilter);
            query.append("include_email_info", "false");

            const body = {
              startRow: params.request.startRow ?? 0,
              endRow:
                params.request.endRow ??
                (params.request.startRow ?? 0) + (adminGridConfig.cacheBlockSize || 100),
              sortModel: params.request.sortModel || [],
              filterModel: {
                ...serverSideFilterModel,
                ...(params.request.filterModel || {}),
              },
            };

            const response = await fetch(
              `${apiUrl}/api/evidence/items/server-side?${query.toString()}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body),
              },
            );

            if (response.ok) {
              const data = await response.json();
              params.success({
                rowData: data.rows || [],
                rowCount: data.lastRow ?? (data.rows ? data.rows.length : 0),
              });
              if (data.stats) {
                renderStats(data.stats);
                if (data.stats.total !== undefined) {
                  document.getElementById("docCount").textContent =
                    data.stats.total.toLocaleString();
                  document.getElementById("allCount").textContent =
                    data.stats.total.toLocaleString();
                  document.getElementById("imgCount").textContent =
                    (data.stats.by_type?.image || 0).toLocaleString?.() ||
                    (data.stats.by_type?.image || 0);
                }
              }
              if (gridApi) gridApi.hideOverlay();
            } else {
              const text = await response.text();
              console.error("[Evidence] Server-side load failed:", text);
              params.fail();
              VericaseUI.Toast.error("Failed to load evidence");
              if (gridApi) gridApi.showNoRowsOverlay();
            }
          } catch (error) {
            console.error("[Evidence] Server-side load error:", error);
            params.fail();
            VericaseUI.Toast.error("Failed to load evidence");
          }
        },
      };
    }

    // Render collections data (can be called with fetched or prefetched data)
    function renderCollections(collections) {
      const list = document.getElementById("collectionList");
      const collectionArray = Array.isArray(collections)
        ? collections
        : collections.collections || [];
      const seenNames = new Set(["all evidence"]);
      const filtered = [];
      collectionArray.forEach((c) => {
        const name = (c?.name || "").trim();
        if (!name) return;
        const key = name.toLowerCase();
        if (seenNames.has(key)) return;
        seenNames.add(key);
        filtered.push(c);
      });
      collectionsCache = filtered;

      // Default category folders that should always be shown
      const defaultCategories = [
        "Meeting Minutes",
        "Progress Reports",
        "Client Valuations",
        "Client Payment Certificates",
        "Change",
        "Subcontractor Valuations",
        "Subcontractor Payment Certificates",
        "Site Instructions",
        "Drawings",
        "Specifications"
      ];

      let html = `
                <div class="collection-item active" data-id="">
                    <i class="fas fa-folder"></i>
                    All Evidence
                </div>
            `;

      // Add default categories (create collection objects for any that don't exist yet)
      defaultCategories.forEach((catName) => {
        const existing = filtered.find(c => c.name?.toLowerCase() === catName.toLowerCase());
        if (!existing) {
          html += `
                    <div class="collection-item default-category" data-id="" data-category="${escapeHtml(catName)}">
                        <i class="fas fa-folder"></i>
                        ${escapeHtml(catName)}
                        <span class="collection-count">0</span>
                    </div>
                `;
        }
      });

      // Check if auto-categorize is enabled (load from saved config per project/case)
      const evidenceConfig = loadEvidenceConfig();
      const autoCategorize = evidenceConfig.autoCategorize || false;
      
      if (autoCategorize) {
        // Build hierarchy from parent_id relationships
        const collectionMap = new Map();
        const rootCollections = [];
        
        filtered.forEach((c) => {
          collectionMap.set(c.id, { ...c, children: [] });
        });
        
        filtered.forEach((c) => {
          if (c.parent_id && collectionMap.has(c.parent_id)) {
            collectionMap.get(c.parent_id).children.push(collectionMap.get(c.id));
          } else {
            rootCollections.push(collectionMap.get(c.id));
          }
        });
        
        // Render hierarchical structure
        function renderCollectionItem(collection, level = 0) {
          const icon = collection.is_system ? "fa-folder-open" : "fa-folder";
          const nestedClass = level > 0 ? ` nested${level > 3 ? "-3" : level > 2 ? "-2" : ""}` : "";
          let itemHtml = `
            <div class="collection-item${nestedClass}" data-id="${collection.id}">
                <i class="fas ${icon}"></i>
                ${escapeHtml(collection.name)}
                <span class="collection-count">${collection.item_count || 0}</span>
            </div>
          `;
          
          if (collection.children && collection.children.length > 0) {
            collection.children.forEach(child => {
              itemHtml += renderCollectionItem(child, level + 1);
            });
          }
          
          return itemHtml;
        }
        
        rootCollections.forEach(c => {
          html += renderCollectionItem(c);
        });
      } else {
        // Flat list (original behavior)
      filtered.forEach((c) => {
        const icon = c.is_system ? "fa-folder-open" : "fa-folder";
        html += `
                    <div class="collection-item" data-id="${c.id}">
                        <i class="fas ${icon}"></i>
                        ${escapeHtml(c.name)}
                        <span class="collection-count">${c.item_count || 0}</span>
                    </div>
                `;
      });
      }

      list.innerHTML = html;
      // Note: Click handler is attached via event delegation in DOMContentLoaded
    }

    async function loadCollections() {
      try {
        const response = await fetch(
          `${apiUrl}/api/evidence/collections?include_system=true`,
        );
        if (response.ok) {
          const collections = await response.json();
          renderCollections(collections);
        }
      } catch (error) {
        console.error("Error loading collections:", error);
      }
    }

    async function createSubfolder() {
      const name = prompt("Enter subfolder name:");
      if (!name || !name.trim()) return;

      const activeCollection = document.querySelector(".collection-item.active");
      const parentId = activeCollection?.dataset.id || null;

      try {
        const response = await fetch(`${apiUrl}/api/evidence/collections`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name.trim(),
            parent_id: parentId || null,
            is_system: false,
          }),
        });

        if (response.ok) {
          VericaseUI.Toast.success("Subfolder created successfully");
          await loadCollections();
        } else {
          const error = await response.json();
          VericaseUI.Toast.error(error.detail || "Failed to create subfolder");
        }
      } catch (error) {
        console.error("Error creating subfolder:", error);
        VericaseUI.Toast.error("Failed to create subfolder");
      }
    }

    // Render stats data (can be called with fetched or prefetched data)
    function renderStats(stats) {
      document.getElementById("totalCount").textContent = (
        stats.total || 0
      ).toLocaleString();
      document.getElementById("unassignedCount").textContent = (
        stats.unassigned || 0
      ).toLocaleString();
      document.getElementById("linkedCount").textContent = (
        stats.with_correspondence || 0
      ).toLocaleString();
      document.getElementById("recentCount").textContent = (
        stats.recent_uploads || 0
      ).toLocaleString();
      // Update category counters using stats if available
      const totalVal = stats.total || 0;
      document.getElementById("docCount").textContent = totalVal.toLocaleString();
      document.getElementById("allCount").textContent = totalVal.toLocaleString();
      const imgVal =
        stats.image_count ||
        (stats.by_type && (stats.by_type.image || stats.by_type.photo || 0)) ||
        0;
      document.getElementById("imgCount").textContent = imgVal.toLocaleString();
    }

    async function loadStats() {
      try {
        const response = await fetch(`${apiUrl}/api/evidence/stats`);
        if (response.ok) {
          const stats = await response.json();
          renderStats(stats);
        }
      } catch (error) {
        console.error("Error loading stats:", error);
      }
    }

    // ============================================
    // DETAIL PANEL
    // ============================================

    async function showDetail(evidence) {
      if (!evidence) return;

      const panel = document.getElementById("detailPanel");
      panel.classList.add("open");

      // Show loading state
      document.getElementById("previewSection").innerHTML = `
                <div class="preview-placeholder">
                    <div class="loading" style="width: 32px; height: 32px; border-width: 3px;"></div>
                    <span>Loading preview...</span>
                </div>
            `;

      try {
        const fullRes = await fetch(`${apiUrl}/api/evidence/items/${evidence.id}/full`);
        if (!fullRes.ok) {
          throw new Error(`Failed to load evidence full detail: ${fullRes.status}`);
        }
        const full = await fullRes.json();
        const detail = full.detail || {};
        const preview = full.preview || null;
        const metadata = full.metadata || null;

        selectedEvidence = detail;
        currentPreviewData = preview;

        renderPreview(preview, detail);
        renderMetadata(detail, metadata);
        updateEvidenceLaneButtons();
        updateEvidenceNotePlaceholder();
        loadEvidenceNotes();
        await loadVeriCaseSuggestions(evidence.id, detail);
      } catch (error) {
        console.error("Error loading detail:", error);
        VericaseUI.Toast.error("Failed to load evidence details");
      }
    }

    function renderPreview(preview, detail) {
      const section = document.getElementById("previewSection");

      if (!preview) {
        section.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas ${getFileIcon(detail.mime_type, detail.evidence_type)}"></i>
                        <span>Preview not available</span>
                    </div>
                `;
        return;
      }

      let html = "";

      switch (preview.preview_type) {
        case "image":
          html = `
                        <img src="${preview.preview_url}" alt="${detail.filename}">
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Expand
                        </button>
                    `;
          break;

        case "pdf":
          html = `
                        <iframe src="${preview.preview_url}#toolbar=0"></iframe>
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Expand
                        </button>
                    `;
          break;

        case "text":
        case "office":
          const content = preview.preview_content || "No content available";
          const contentStr =
            typeof content === "string"
              ? content
              : JSON.stringify(content, null, 2);
          const truncated =
            contentStr.length > 1000
              ? contentStr.substring(0, 1000) + "\n..."
              : contentStr;
          html = `
                        <pre style="color: var(--gray-400); font-size: 0.75rem; padding: 16px; margin: 0; overflow: auto; max-height: 100%;">${escapeHtml(truncated)}</pre>
                        <button class="preview-expand-btn" onclick="openFullPreview()">
                            <i class="fas fa-expand"></i> Full Text
                        </button>
                    `;
          break;

        default:
          html = `
                        <div class="preview-placeholder">
                            <i class="fas ${getFileIcon(detail.mime_type, detail.evidence_type)}"></i>
                            <span>${detail.filename}</span>
                        </div>
                    `;
      }

      section.innerHTML = html;
    }

    function renderMetadata(detail, extractedMeta) {
      const content = document.getElementById("metadataContent");
      const meta = extractedMeta || detail.extracted_metadata || {};

      let html = "";

      // Basic Info
      html += `
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-info-circle"></i>
                        <h4>Basic Information</h4>
                    </div>
                    <div class="detail-item" style="margin-bottom: 12px;">
                        <div class="detail-label">Filename</div>
                        <div class="detail-value" style="word-break: break-all;">${escapeHtml(detail.filename)}</div>
                    </div>
                    ${detail.title && detail.title !== detail.filename
          ? `
                        <div class="detail-item" style="margin-bottom: 12px;">
                            <div class="detail-label">Title</div>
                            <div class="detail-value">${escapeHtml(detail.title)}</div>
                        </div>
                    `
          : ""
        }
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Type</div>
                            <div class="detail-value">${typeConfig[detail.evidence_type]?.label || detail.evidence_type || "Unknown"}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Size</div>
                            <div class="detail-value">${formatFileSize(detail.file_size)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge status-${detail.processing_status || "pending"}">${detail.processing_status || "pending"}</span>
                            </div>
                        </div>
                        ${detail.document_date
          ? `
                            <div class="detail-item">
                                <div class="detail-label">Document Date</div>
                                <div class="detail-value">${formatDate(detail.document_date)}</div>
                            </div>
                        `
          : ""
        }
                    </div>
                </div>
            `;

      // Document Properties
      if (meta.author || meta.created_date || meta.page_count) {
        html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-file-alt"></i>
                            <h4>Document Properties</h4>
                        </div>
                        <div class="detail-grid">
                            ${meta.author || detail.author
            ? `
                                <div class="detail-item">
                                    <div class="detail-label">Author</div>
                                    <div class="detail-value">${escapeHtml(meta.author || detail.author)}</div>
                                </div>
                            `
            : ""
          }
                            ${meta.page_count || detail.page_count
            ? `
                                <div class="detail-item">
                                    <div class="detail-label">Pages</div>
                                    <div class="detail-value">${meta.page_count || detail.page_count}</div>
                                </div>
                            `
            : ""
          }
                            ${meta.created_date
            ? `
                                <div class="detail-item">
                                    <div class="detail-label">Created</div>
                                    <div class="detail-value">${formatDate(meta.created_date)}</div>
                                </div>
                            `
            : ""
          }
                            ${meta.modified_date
            ? `
                                <div class="detail-item">
                                    <div class="detail-label">Modified</div>
                                    <div class="detail-value">${formatDate(meta.modified_date)}</div>
                                </div>
                            `
            : ""
          }
                        </div>
                    </div>
                `;
      }

      if (
        detail.source_email_subject ||
        detail.source_email_sender ||
        detail.source_email_date ||
        detail.source_email_preview ||
        detail.source_email_message_id ||
        detail.source_email_id
      ) {
        const toList = Array.isArray(detail.source_email_to)
          ? detail.source_email_to.join(", ")
          : detail.source_email_to || "";
        const ccList = Array.isArray(detail.source_email_cc)
          ? detail.source_email_cc.join(", ")
          : detail.source_email_cc || "";
        html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-envelope-open-text"></i>
                            <h4>Source Email</h4>
                        </div>
                        <div class="detail-grid">
                            ${detail.source_email_subject
                              ? `
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Subject</div>
                                    <div class="detail-value">${escapeHtml(detail.source_email_subject)}</div>
                                </div>
                            `
                              : ""
                            }
                            ${detail.source_email_sender
                              ? `
                                <div class="detail-item">
                                    <div class="detail-label">From</div>
                                    <div class="detail-value">${escapeHtml(detail.source_email_sender)}</div>
                                </div>
                            `
                              : ""
                            }
                            ${detail.source_email_date
                              ? `
                                <div class="detail-item">
                                    <div class="detail-label">Date</div>
                                    <div class="detail-value">${formatDate(detail.source_email_date)}</div>
                                </div>
                            `
                              : ""
                            }
                            ${toList
                              ? `
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">To</div>
                                    <div class="detail-value">${escapeHtml(toList)}</div>
                                </div>
                            `
                              : ""
                            }
                            ${ccList
                              ? `
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Cc</div>
                                    <div class="detail-value">${escapeHtml(ccList)}</div>
                                </div>
                            `
                              : ""
                            }
                            ${detail.source_email_message_id
                              ? `
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Message ID</div>
                                    <div class="detail-value" style="word-break: break-all;">${escapeHtml(detail.source_email_message_id)}</div>
                                </div>
                            `
                              : ""
                            }
                            ${detail.source_email_id &&
                            detail.source_email_id !== detail.source_email_message_id
                              ? `
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Email ID</div>
                                    <div class="detail-value" style="word-break: break-all;">${escapeHtml(detail.source_email_id)}</div>
                                </div>
                            `
                              : ""
                            }
                        </div>
                        ${detail.source_email_preview
                          ? `
                            <div class="detail-item" style="margin-top: 12px;">
                                <div class="detail-label">Preview</div>
                                <div class="detail-value">${escapeHtml(detail.source_email_preview)}</div>
                            </div>
                        `
                          : ""
                        }
                    </div>
                `;
      }

      // Image EXIF
      if (meta.width || meta.camera_make || meta.date_taken) {
        html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-camera"></i>
                            <h4>Image Information</h4>
                        </div>
                        <div class="detail-grid">
                            ${meta.width && meta.height
            ? `
                                <div class="detail-item">
                                    <div class="detail-label">Dimensions</div>
                                    <div class="detail-value">${meta.width} × ${meta.height} px</div>
                                </div>
                            `
            : ""
          }
                            ${meta.camera_make
            ? `
                                <div class="detail-item">
                                    <div class="detail-label">Camera</div>
                                    <div class="detail-value">${escapeHtml(meta.camera_make)} ${escapeHtml(meta.camera_model || "")}</div>
                                </div>
                            `
            : ""
          }
                            ${meta.date_taken
            ? `
                                <div class="detail-item">
                                    <div class="detail-label">Date Taken</div>
                                    <div class="detail-value">${formatDate(meta.date_taken)}</div>
                                </div>
                            `
            : ""
          }
                        </div>
                        ${meta.gps_latitude && meta.gps_longitude
            ? `
                            <div class="detail-item" style="margin-top: 12px;">
                                <div class="detail-label">Location</div>
                                <a href="https://www.google.com/maps?q=${meta.gps_latitude},${meta.gps_longitude}" target="_blank" class="gps-map-link">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${meta.gps_latitude.toFixed(6)}, ${meta.gps_longitude.toFixed(6)}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.6rem;"></i>
                                </a>
                            </div>
                        `
            : ""
          }
                    </div>
                `;
      }

      // Tags
      if (detail.auto_tags?.length > 0 || detail.manual_tags?.length > 0) {
        html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-tags"></i>
                            <h4>Tags</h4>
                        </div>
                        <div class="tag-list">
                            ${(detail.manual_tags || []).map((t) => `<span class="tag tag-teal">${escapeHtml(t)}</span>`).join("")}
                            ${(detail.auto_tags || []).map((t) => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
                        </div>
                    </div>
                `;
      }

      // Filing
      const filingCollections = getFilingCollections();
      if (filingCollections.length) {
        html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-folder-open"></i>
                            <h4>File Document</h4>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Collection</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="collectionSelect" class="filter-select" style="flex: 1; min-width: 0;">
                                    <option value="">Select collection...</option>
                                    ${filingCollections
                                      .map((c) => `<option value="${c.id}">${escapeHtml(c.name)}</option>`)
                                      .join("")}
                                </select>
                                <button class="btn btn-vericase btn-sm" id="assignCollectionBtn">File</button>
                                <button class="btn btn-ghost btn-sm" id="autoFileBtn">Auto-file</button>
                            </div>
                        </div>
                    </div>
                `;
      }

      // Linked Correspondence
      if (detail.correspondence_links?.length > 0) {
        html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-envelope"></i>
                            <h4>Linked Correspondence (${detail.correspondence_links.length})</h4>
                        </div>
                        ${detail.correspondence_links
            .map(
              (link) => `
                            <div class="link-card">
                                ${link.email
                  ? `
                                    <div class="link-card-title">${escapeHtml(link.email.subject || "No subject")}</div>
                                    <div class="link-card-meta">${escapeHtml(link.email.sender || "")} • ${formatDate(link.email.date)}</div>
                                `
                  : ""
                }
                                <div class="link-card-meta">${link.link_type} • ${link.link_confidence ? link.link_confidence + "% confidence" : "Manual link"}</div>
                            </div>
                        `,
            )
            .join("")}
                    </div>
                `;
      }

      // Forensic Data
      if (detail.file_hash) {
        html += `
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <i class="fas fa-fingerprint"></i>
                            <h4>Forensic Data</h4>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">SHA-256 Hash</div>
                            <div class="detail-value" style="font-family: var(--font-mono); font-size: 0.625rem; word-break: break-all;">${detail.file_hash}</div>
                        </div>
                        <div class="detail-item" style="margin-top: 8px;">
                            <div class="detail-label">Uploaded</div>
                            <div class="detail-value">${formatDate(detail.created_at)}</div>
                        </div>
                    </div>
                `;
      }

      content.innerHTML = html;
      setupCollectionActions();
    }

    function hideDetail() {
      document.getElementById("detailPanel").classList.remove("open");
      selectedEvidence = null;
      currentPreviewData = null;
      const thread = document.getElementById("evidenceCommentThread");
      if (thread) {
        thread.innerHTML = `<div class="collab-empty">Select an item to view notes.</div>`;
      }
      const input = document.getElementById("evidenceCommentInput");
      if (input) {
        input.value = "";
      }
      // Clear suggestions
      const suggestionsBody = document.getElementById("vericaseSuggestionsBody");
      if (suggestionsBody) {
        suggestionsBody.innerHTML = `
          <div class="suggestions-empty-state">
            <i class="fas fa-lightbulb"></i>
            <p>Select an evidence item to see AI-powered suggestions</p>
          </div>
        `;
      }
    }

    // ============================================
    // VERICASE SUGGESTIONS
    // ============================================

    async function loadVeriCaseSuggestions(evidenceId, detail) {
      const suggestionsBody = document.getElementById("vericaseSuggestionsBody");
      if (!suggestionsBody) return;

      // Show loading state
      suggestionsBody.innerHTML = `
        <div class="suggestions-loading">
          <div class="loading" style="width: 24px; height: 24px; border-width: 2px;"></div>
          <span>Loading suggestions...</span>
        </div>
      `;

      try {
        // Fetch suggestions from API
        const response = await fetch(`${apiUrl}/api/evidence/items/${evidenceId}/suggestions`);
        let suggestions = null;
        
        if (response.ok) {
          suggestions = await response.json();
        } else {
          // If API doesn't exist yet, generate suggestions from available data
          suggestions = generateSuggestionsFromDetail(detail);
        }

        renderVeriCaseSuggestions(suggestions, detail);
      } catch (error) {
        console.error("Error loading suggestions:", error);
        // Fallback to generating from detail data
        const suggestions = generateSuggestionsFromDetail(detail);
        renderVeriCaseSuggestions(suggestions, detail);
      }
    }

    function generateSuggestionsFromDetail(detail) {
      const suggestions = {
        link_suggestions: [],
        classification: null,
        extraction_status: {
          dates: detail.extracted_dates || [],
          parties: detail.extracted_parties || [],
          amounts: detail.extracted_amounts || [],
        },
        similar_items: [],
      };

      // Check if there's a source email - that's a link suggestion
      if (detail.source_email_id && detail.source_email_subject) {
        suggestions.link_suggestions.push({
          email_id: detail.source_email_id,
          email_subject: detail.source_email_subject,
          email_sender: detail.source_email_sender,
          email_date: detail.source_email_date,
          link_type: "Email Attachment",
          confidence: 100,
          method: "Direct attachment",
        });
      }

      // Suggest collection based on evidence type
      if (detail.evidence_type) {
        const typeToCollection = {
          drawing: "Drawings",
          photo: "Photos",
          document: "Documents",
        };
        const suggestedCollection = typeToCollection[detail.evidence_type];
        if (suggestedCollection) {
          suggestions.classification = {
            collection_name: suggestedCollection,
            confidence: 75,
            reason: `Based on evidence type: ${detail.evidence_type}`,
          };
        }
      }

      return suggestions;
    }

    function renderVeriCaseSuggestions(suggestions, detail) {
      const suggestionsBody = document.getElementById("vericaseSuggestionsBody");
      if (!suggestionsBody) return;

      let html = "";

      // Link Suggestions
      if (suggestions.link_suggestions && suggestions.link_suggestions.length > 0) {
        html += `
          <div class="suggestion-group">
            <div class="suggestion-group-header">
              <i class="fas fa-link"></i>
              <span>Link Suggestions</span>
            </div>
            <div class="suggestion-list">
              ${suggestions.link_suggestions.map(link => `
                <div class="suggestion-item suggestion-link">
                  <div class="suggestion-item-content">
                    <div class="suggestion-item-title">
                      <i class="fas fa-envelope"></i>
                      ${escapeHtml(link.email_subject || "Email")}
                    </div>
                    <div class="suggestion-item-meta">
                      ${link.email_sender ? escapeHtml(link.email_sender) : ""}
                      ${link.email_date ? ` • ${formatDate(link.email_date)}` : ""}
                      ${link.confidence ? ` • ${link.confidence}% confidence` : ""}
                    </div>
                    ${link.context ? `<div class="suggestion-item-context">${escapeHtml(link.context)}</div>` : ""}
                  </div>
                  ${link.email_id ? `
                    <button class="btn btn-sm btn-ghost" onclick="openSourceEmail('${link.email_id}')" title="View email">
                      <i class="fas fa-external-link-alt"></i>
                    </button>
                  ` : ""}
                </div>
              `).join("")}
            </div>
          </div>
        `;
      }

      // Classification Suggestion
      if (suggestions.classification) {
        html += `
          <div class="suggestion-group">
            <div class="suggestion-group-header">
              <i class="fas fa-folder"></i>
              <span>Suggested Collection</span>
            </div>
            <div class="suggestion-item suggestion-classification">
              <div class="suggestion-item-content">
                <div class="suggestion-item-title">
                  <i class="fas fa-folder-open"></i>
                  ${escapeHtml(suggestions.classification.collection_name)}
                </div>
                ${suggestions.classification.reason ? `
                  <div class="suggestion-item-context">${escapeHtml(suggestions.classification.reason)}</div>
                ` : ""}
                ${suggestions.classification.confidence ? `
                  <div class="suggestion-item-meta">${suggestions.classification.confidence}% confidence</div>
                ` : ""}
              </div>
            </div>
          </div>
        `;
      }

      // Extraction Status
      const extraction = suggestions.extraction_status || {};
      const hasExtractions = (extraction.dates && extraction.dates.length > 0) ||
                            (extraction.parties && extraction.parties.length > 0) ||
                            (extraction.amounts && extraction.amounts.length > 0);
      
      if (hasExtractions) {
        html += `
          <div class="suggestion-group">
            <div class="suggestion-group-header">
              <i class="fas fa-check-circle"></i>
              <span>Extracted Metadata</span>
            </div>
            <div class="suggestion-item suggestion-extraction">
              <div class="suggestion-item-content">
                ${extraction.dates && extraction.dates.length > 0 ? `
                  <div class="suggestion-item-meta">
                    <i class="fas fa-calendar"></i>
                    <strong>Dates:</strong> ${extraction.dates.slice(0, 3).map(d => escapeHtml(String(d))).join(", ")}
                    ${extraction.dates.length > 3 ? ` +${extraction.dates.length - 3} more` : ""}
                  </div>
                ` : ""}
                ${extraction.parties && extraction.parties.length > 0 ? `
                  <div class="suggestion-item-meta">
                    <i class="fas fa-id-badge"></i>
                    <strong>Stakeholders:</strong> ${extraction.parties.slice(0, 3).map(p => escapeHtml(String(p))).join(", ")}
                    ${extraction.parties.length > 3 ? ` +${extraction.parties.length - 3} more` : ""}
                  </div>
                ` : ""}
                ${extraction.amounts && extraction.amounts.length > 0 ? `
                  <div class="suggestion-item-meta">
                    <i class="fas fa-pound-sign"></i>
                    <strong>Amounts:</strong> ${extraction.amounts.slice(0, 3).map(a => escapeHtml(String(a))).join(", ")}
                    ${extraction.amounts.length > 3 ? ` +${extraction.amounts.length - 3} more` : ""}
                  </div>
                ` : ""}
              </div>
            </div>
          </div>
        `;
      }

      // Similar Items
      if (suggestions.similar_items && suggestions.similar_items.length > 0) {
        html += `
          <div class="suggestion-group">
            <div class="suggestion-group-header">
              <i class="fas fa-copy"></i>
              <span>Similar Items</span>
            </div>
            <div class="suggestion-list">
              ${suggestions.similar_items.map(item => `
                <div class="suggestion-item suggestion-similar">
                  <div class="suggestion-item-content">
                    <div class="suggestion-item-title">${escapeHtml(item.filename || "Unknown")}</div>
                    <div class="suggestion-item-meta">${item.similarity ? `${item.similarity}% similar` : ""}</div>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        `;
      }

      if (!html) {
        html = `
          <div class="suggestions-empty-state">
            <i class="fas fa-lightbulb"></i>
            <p>No suggestions available for this item</p>
          </div>
        `;
      }

      suggestionsBody.innerHTML = html;
    }

    // ============================================
    // ACTIONS
    // ============================================

    function openSourceEmail(emailId) {
      // Navigate to correspondence page with the specific email highlighted
      if (emailId && projectId) {
        window.location.href = `correspondence-enterprise.html?projectId=${projectId}&emailId=${emailId}`;
      } else if (emailId && caseId) {
        window.location.href = `correspondence-enterprise.html?caseId=${caseId}&emailId=${emailId}`;
      } else if (emailId) {
        VericaseUI.Toast.info('Opening email viewer...');
        // Could also open in a modal or panel
        window.open(`/api/correspondence/${emailId}`, "_blank");
      }
    }

    async function toggleStar(evidenceId) {
      try {
        const response = await fetch(
          `${apiUrl}/api/evidence/items/${evidenceId}/star`,
          {
            method: "POST",
          },
        );

        if (response.ok) {
          const result = await response.json();
          refreshGridData();
          VericaseUI.Toast.success(
            result.is_starred ? "Added to starred" : "Removed from starred",
          );
        }
      } catch (error) {
        console.error("Error toggling star:", error);
        VericaseUI.Toast.error("Failed to update star status");
      }
    }

    function downloadCurrentFile() {
      if (currentPreviewData?.download_url) {
        window.open(currentPreviewData.download_url, "_blank");
      } else if (selectedEvidence?.download_url) {
        window.open(selectedEvidence.download_url, "_blank");
      }
    }

    async function openFullPreview() {
      if (!selectedEvidence || !currentPreviewData) return;

      const modal = document.getElementById("previewModal");
      const content = document.getElementById("previewModalContent");
      const title = document.getElementById("previewModalTitle");

      title.textContent = selectedEvidence.filename;

      let html = "";

      switch (currentPreviewData.preview_type) {
        case "image":
          html = `<img src="${currentPreviewData.preview_url}" alt="${selectedEvidence.filename}">`;
          break;

        case "pdf":
          html = `<iframe src="${currentPreviewData.preview_url}"></iframe>`;
          break;

        case "text":
        case "office":
          try {
            const response = await fetch(
              `${apiUrl}/api/evidence/items/${selectedEvidence.id}/text-content?max_length=100000`,
            );
            if (response.ok) {
              const data = await response.json();
              html = `<pre>${escapeHtml(data.text)}</pre>`;
            } else {
              html = `<pre>${escapeHtml(currentPreviewData.preview_content || "Could not load text content")}</pre>`;
            }
          } catch {
            html = `<pre>${escapeHtml(currentPreviewData.preview_content || "Could not load text content")}</pre>`;
          }
          break;

        default:
          html = `
                        <div style="text-align: center; color: var(--gray-400);">
                            <i class="fas ${getFileIcon(selectedEvidence.mime_type, selectedEvidence.evidence_type)}" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                            <p>Preview not available for this file type</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">${escapeHtml(selectedEvidence.filename)}</p>
                            <button class="btn btn-vericase" style="margin-top: 1rem;" onclick="downloadCurrentFile()">
                                <i class="fas fa-download"></i> Download File
                            </button>
                        </div>
                    `;
      }

      content.innerHTML = html;
      modal.classList.add("active");
    }

    function closePreviewModal() {
      document.getElementById("previewModal").classList.remove("active");
    }

    async function extractMetadata() {
      if (!selectedEvidence) return;

      const btn = document.getElementById("extractMetadataBtn");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

      try {
        const response = await fetch(
          `${apiUrl}/api/evidence/items/${selectedEvidence.id}/extract-metadata`,
          {
            method: "POST",
          },
        );

        if (response.ok) {
          await showDetail(selectedEvidence);
          VericaseUI.Toast.success("Metadata extracted successfully");
        } else {
          VericaseUI.Toast.error("Failed to extract metadata");
        }
      } catch (error) {
        console.error("Error extracting metadata:", error);
        VericaseUI.Toast.error("Failed to extract metadata");
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magnifying-glass"></i>';
      }
    }

    async function handleFileUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;

      const uploadBtn = document.getElementById("uploadBtn");
      uploadBtn.disabled = true;
      uploadBtn.classList.add("loading");

      const toast = VericaseUI.Toast.info(
        `Uploading ${files.length} file(s)...`,
        { duration: 0 },
      );

      try {
        let successCount = 0;
        for (const file of files) {
          const formData = new FormData();
          formData.append("file", file);
          if (projectId) formData.append("project_id", projectId);
          if (caseId) formData.append("case_id", caseId);

          const response = await fetch(
            `${apiUrl}/api/evidence/upload/direct`,
            {
              method: "POST",
              body: formData,
            },
          );

          if (response.ok) successCount++;
        }

        VericaseUI.Toast.dismiss(toast);
        VericaseUI.Toast.success(
          `Successfully uploaded ${successCount} file(s)`,
        );

        refreshGridData();
        loadStats();
      } catch (error) {
        console.error("Upload error:", error);
        VericaseUI.Toast.dismiss(toast);
        VericaseUI.Toast.error("Upload failed. Please try again.");
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.classList.remove("loading");
        document.getElementById("fileInput").value = "";
      }
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    document.addEventListener("DOMContentLoaded", async () => {
      // Get context (project or case)
      const ctx =
        typeof VericaseShell.getContext === "function"
          ? VericaseShell.getContext()
          : { type: "project", id: VericaseShell.getProjectId() };
      const ctxType = ctx?.type === "case" ? "case" : "project";
      const ctxLabel =
        ctxType === "case" ? "Case Dashboard" : "Project Dashboard";
      const ctxIcon = ctxType === "case" ? "fa-briefcase" : "fa-diagram-project";
      const ctxId = ctx?.id ? String(ctx.id) : "";
      const ctxUrl = ctxId
        ? `dashboard.html?${ctxType === "case" ? "caseId" : "projectId"}=${encodeURIComponent(ctxId)}`
        : "dashboard.html";

      // Inject navigation shell
      VericaseShell.inject({
        title: '',
        breadcrumbs: [
          { label: "Home", url: "master-dashboard.html", icon: "fa-th-large" },
          { label: ctxLabel, url: ctxUrl, icon: ctxIcon },
          { label: "Evidence Repository", icon: "fa-folder-tree" },
        ],
        headerActions: "",
        contentClass: "app-content--flush evidence-page",
      });

      if (ctx.type === "case") {
        caseId = ctx.id;
        projectId = "";
      } else {
        projectId = ctx.id;
        caseId = "";
      }

      // Initialize grid with admin config
      await initGrid();

      // Apply initial filters for default category
      applyFilters();

      // Load data after grid is ready
      loadAllData();

      // Category tabs
      document.querySelectorAll(".category-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".category-tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentCategory = tab.dataset.category;
          applyFilters();
        });
      });

      // Load and apply saved evidence configuration
      const evidenceConfig = loadEvidenceConfig();
      const autoCategorizeToggle = document.getElementById("autoCategorizeToggle");
      if (autoCategorizeToggle) {
        autoCategorizeToggle.checked = evidenceConfig.autoCategorize || false;
      }

      // Auto-categorize toggle - save per project/case and run categorization
      document.getElementById("autoCategorizeToggle").addEventListener("change", (e) => {
        const config = loadEvidenceConfig();
        config.autoCategorize = e.target.checked;
        saveEvidenceConfig(config);

        // Re-render collections with hierarchy if enabled
        if (collectionsCache.length > 0) {
          renderCollections(collectionsCache);
        }

        // Run auto-categorization when enabled
        if (e.target.checked) {
          const confirmed = confirm(
            "Auto-categorize will analyze uncategorized evidence items and assign categories based on filename patterns.\n\nDo you want to run auto-categorization now?"
          );
          if (confirmed) {
            runAutoCategorization();
          }
        }
      });

      // Create subfolder button
      document.getElementById("createSubfolderBtn").addEventListener("click", () => {
        createSubfolder();
      });

      // Collection list - use event delegation to avoid listener accumulation
      document.getElementById("collectionList").addEventListener("click", (e) => {
        const item = e.target.closest(".collection-item");
        if (item) {
          const list = document.getElementById("collectionList");
          list.querySelectorAll(".collection-item")
            .forEach((i) => i.classList.remove("active"));
          item.classList.add("active");
          refreshGridData();
        }
      });

      // Search with debounce
      let searchTimeout;
      document.getElementById("searchInput").addEventListener("input", () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
      });

      // Filters
      document
        .getElementById("fileTypeFilter")
        .addEventListener("change", applyFilters);
      document
        .getElementById("statusFilter")
        .addEventListener("change", applyFilters);

      // Checkbox pills
      document
        .getElementById("unassignedFilter")
        .addEventListener("change", (e) => {
          document
            .getElementById("unassignedPill")
            .classList.toggle("active", e.target.checked);
          applyFilters();
        });

      document
        .getElementById("starredFilter")
        .addEventListener("change", (e) => {
          document
            .getElementById("starredPill")
            .classList.toggle("active", e.target.checked);
          applyFilters();
        });

      // Upload
      document.getElementById("uploadBtn").addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });
      document
        .getElementById("fileInput")
        .addEventListener("change", handleFileUpload);

      // Refresh
      document.getElementById("refreshBtn").addEventListener("click", () => {
        VericaseUI.Toast.info("Refreshing...");
        loadAllData();
      });

      document.getElementById("columnsBtn").addEventListener("click", () => {
        toggleColumnsPanel();
      });

      document.getElementById("saveGridBtn").addEventListener("click", () => {
        saveGridState();
      });

      document.getElementById("resetGridBtn").addEventListener("click", () => {
        resetGridState();
      });

      document.getElementById("autofitBtn").addEventListener("click", () => {
        autoFitGrid(true);
      });
      // Detail panel
      document
        .getElementById("closeDetailBtn")
        .addEventListener("click", hideDetail);
      document
        .getElementById("viewItemBtn")
        .addEventListener("click", openFullPreview);
      document
        .getElementById("downloadBtn")
        .addEventListener("click", downloadCurrentFile);
      document
        .getElementById("previewFullBtn")
        .addEventListener("click", openFullPreview);
      document
        .getElementById("extractMetadataBtn")
        .addEventListener("click", extractMetadata);

      // Preview modal
      document
        .getElementById("closePreviewModal")
        .addEventListener("click", closePreviewModal);
      document
        .getElementById("modalDownloadBtn")
        .addEventListener("click", downloadCurrentFile);
      document
        .getElementById("previewModal")
        .addEventListener("click", (e) => {
          if (e.target === document.getElementById("previewModal")) {
            closePreviewModal();
          }
        });

      // Escape key to close panels
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          hideDetail();
          closePreviewModal();
        }
      });
      // Remove preload class after initial render
      requestAnimationFrame(() => {
        document.body.classList.remove("preload");
      });
    });
  </script>
</body>

</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Setup | VeriCase</title>
    <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="brand-styles.css?v=7" />
    <link rel="stylesheet" href="design-system.css?v=7" />
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>
    <style>
      body {
        background: #f6f4f0;
        color: var(--text-primary);
      }

      .container {
        max-width: 1000px;
        margin: 2.5rem auto;
        padding: 0 2rem 3rem;
      }

      .page-header {
        margin-bottom: 1.5rem;
      }

      .page-title {
        font-size: 2rem;
        margin: 0 0 0.35rem;
        color: var(--vericase-navy);
      }

      .page-subtitle {
        color: var(--text-secondary);
        margin: 0;
      }

      /* Config Sections */
      .config-section {
        background: white;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        padding: 1.75rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--gray-100);
      }

      .config-section h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--vericase-navy);
        margin: 0 0 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .config-section h3 i {
        color: var(--vericase-teal);
        font-size: 1rem;
      }

      .guidance-note {
        font-size: 0.85rem;
        color: var(--text-secondary);
        background: var(--gray-50);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 3px solid var(--vericase-teal);
      }

      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
      }

      .form-label .required {
        color: var(--red-600);
      }

      .tooltip-trigger {
        color: var(--text-muted);
        cursor: help;
        position: relative;
      }

      .tooltip-trigger:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--vericase-navy);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 400;
        white-space: nowrap;
        z-index: 100;
        max-width: 280px;
        white-space: normal;
        text-align: center;
      }

      .form-input,
      .form-select {
        width: 100%;
        padding: 0.7rem 0.9rem;
        border-radius: 10px;
        border: 1px solid var(--border-default);
        font-size: 0.95rem;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: var(--vericase-teal);
        box-shadow: 0 0 0 3px rgba(var(--vericase-teal-rgb), 0.1);
      }

      .form-input.error,
      .form-select.error {
        border-color: var(--red-500);
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }

      .helper-text {
        margin-top: 0.35rem;
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .helper-text.error {
        color: var(--red-600);
      }

      /* Dynamic Tables */
      .dynamic-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0.75rem;
      }

      .dynamic-table th {
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0.5rem 0.75rem;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
      }

      .dynamic-table td {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--gray-100);
        vertical-align: middle;
      }

      .dynamic-table tbody tr:hover {
        background: var(--gray-50);
      }

      .dynamic-table .form-input,
      .dynamic-table .form-select {
        padding: 0.5rem 0.7rem;
        font-size: 0.875rem;
      }

      .dynamic-table .action-col {
        width: 40px;
        text-align: center;
      }

      .btn-delete-row {
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: color 0.2s, background 0.2s;
      }

      .btn-delete-row:hover {
        color: var(--red-600);
        background: var(--red-50);
      }

      .btn-delete-row:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .btn-add-row {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: var(--gray-100);
        border: 1px dashed var(--gray-300);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s, border-color 0.2s;
      }

      .btn-add-row:hover {
        background: var(--gray-200);
        border-color: var(--gray-400);
        color: var(--text-primary);
      }

      /* Contract Type Cascading */
      .contract-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .custom-input-wrapper {
        margin-top: 0.5rem;
      }

      .custom-input-wrapper.hidden {
        display: none;
      }

      /* Action Row */
      .action-row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--gray-200);
      }

      .action-row .btn {
        padding: 0.75rem 1.5rem;
      }

      /* Responsive */
      @media (max-width: 640px) {
        .container {
          padding: 0 1rem 2rem;
        }
        .config-section {
          padding: 1.25rem;
        }
        .contract-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main id="main-content">
      <div class="container">
        <div class="page-header">
          <nav class="breadcrumb" id="breadcrumbNav" style="margin-bottom: 0.75rem; font-size: 0.875rem;">
	            <a href="workspace-hub.html" style="color: var(--vericase-teal); text-decoration: none;">
	              <i class="fas fa-layer-group"></i> Workspaces
	            </a>
            <span style="color: var(--text-muted); margin: 0 0.5rem;">›</span>
            <a href="#" id="workspaceLink" style="color: var(--vericase-teal); text-decoration: none;">Workspace</a>
            <span style="color: var(--text-muted); margin: 0 0.5rem;">›</span>
            <span style="color: var(--text-secondary);" id="breadcrumbCurrent">New Project</span>
          </nav>
          <h1 class="page-title">Project Setup</h1>
          <p class="page-subtitle">Configure project identification, stakeholders, keywords, and contract details.</p>
        </div>

        <form id="projectForm">
          <!-- Section 2.1: Project Identification -->
          <section class="config-section">
            <h3><i class="fas fa-id-card"></i> Project Identification</h3>
            
            <div class="form-group">
              <label class="form-label" for="projectName">
                Project Name <span class="required">*</span>
              </label>
              <input 
                class="form-input" 
                id="projectName" 
                type="text" 
                required 
                minlength="2" 
                maxlength="200"
                placeholder="Enter project name (2-200 characters)"
              />
              <div class="helper-text" id="projectNameHelper">2-200 characters required</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="projectCode">
                Project Code <span class="required">*</span>
              </label>
              <input 
                class="form-input" 
                id="projectCode" 
                type="text" 
                required
                pattern="[A-Za-z0-9\-_\/]+"
                placeholder="e.g., PROJ-001 or UL/HAR/2024"
              />
              <div class="helper-text">Unique within tenant. Letters, numbers, -, _, / allowed. Auto-generated if left blank.</div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="startDate">
                  Start Date
                  <span class="tooltip-trigger" data-tooltip="Ensure all pre-commencement and relevant tendering period is accounted for.">
                    <i class="fas fa-info-circle"></i>
                  </span>
                </label>
                <input 
                  class="form-input" 
                  id="startDate" 
                  type="text" 
                  placeholder="dd/mm/yyyy"
                  maxlength="10"
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="completionDate">Completion Date</label>
                <input 
                  class="form-input" 
                  id="completionDate" 
                  type="text" 
                  placeholder="dd/mm/yyyy"
                  maxlength="10"
                />
                <div class="helper-text" id="completionDateHelper">Must be on or after Start Date if both provided</div>
              </div>
            </div>
          </section>

          <!-- Section 2.2: Key Stakeholders & Parties -->
          <section class="config-section">
            <h3><i class="fas fa-id-badge"></i> Key Stakeholders & Parties</h3>
            <p class="guidance-note">
              Examples include United Living and names of: Employer's Agent, Client, Council, NHBC, Subcontractors, etc.
            </p>

            <table class="dynamic-table" id="stakeholdersTable">
              <thead>
                <tr>
                  <th style="width: 40%;">Role</th>
                  <th style="width: 50%;">Name / Organisation</th>
                  <th class="action-col"></th>
                </tr>
              </thead>
              <tbody id="stakeholdersBody">
                <!-- Default row inserted by JS -->
              </tbody>
            </table>
            <button type="button" class="btn-add-row" onclick="addStakeholderRow()">
              <i class="fas fa-plus"></i> Add Stakeholder
            </button>

            <datalist id="org-suggestions">
              <!-- Populated dynamically from previous entries -->
            </datalist>
          </section>

          <!-- Section 2.3: Keywords (Heads of Claim / Relevant Words) -->
          <section class="config-section">
            <h3><i class="fas fa-tags"></i> Keywords (Heads of Claim / Relevant Words)</h3>
            <p class="guidance-note">
              Populate with keywords relevant to your potential matters / heads of claim. 
              <strong>Quick tip:</strong> include common variations, i.e., Section 278 / S278
            </p>

            <table class="dynamic-table" id="keywordsTable">
              <thead>
                <tr>
                  <th style="width: 35%;">Keyword</th>
                  <th style="width: 55%;">Variations / Synonyms (comma-separated)</th>
                  <th class="action-col"></th>
                </tr>
              </thead>
              <tbody id="keywordsBody">
                <!-- Rows inserted by JS -->
              </tbody>
            </table>
            <button type="button" class="btn-add-row" onclick="addKeywordRow()">
              <i class="fas fa-plus"></i> Add Keyword
            </button>
            <button type="button" class="btn-add-row" id="rescanKeywordsBtn" onclick="rescanKeywordsForProject()" title="Rescan existing correspondence and evidence for the keywords above">
              <i class="fas fa-sync-alt"></i> Rescan existing items
            </button>
            <div class="helper-text" id="rescanKeywordsHint" style="margin-top: 8px;"></div>
          </section>

          <!-- Section 2.4: Contract Type -->
          <section class="config-section">
            <h3><i class="fas fa-file-contract"></i> Contract Type</h3>

            <div class="contract-row">
              <div class="form-group">
                <label class="form-label" for="contractFamily">Contract Family</label>
                <select class="form-select" id="contractFamily" onchange="updateContractForms()">
                  <option value="">Select...</option>
                  <option value="JCT">JCT</option>
                  <option value="NEC">NEC</option>
                  <option value="FIDIC">FIDIC</option>
                  <option value="ICE">ICE</option>
                  <option value="Custom">Custom</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="contractForm">Contract Form</label>
                <select class="form-select" id="contractForm" disabled>
                  <option value="">Select family first...</option>
                </select>
                <div class="custom-input-wrapper hidden" id="customContractWrapper">
                  <input 
                    class="form-input" 
                    id="contractFormCustom" 
                    type="text" 
                    placeholder="Enter custom contract type"
                  />
                </div>
              </div>
            </div>
          </section>

          <!-- Action Buttons -->
          <div class="action-row">
            <button class="btn btn-vericase" type="submit" id="createProjectBtn">
              <i class="fas fa-plus"></i> Create Project
            </button>
            <button class="btn btn-secondary" type="button" id="backBtn">
              <i class="fas fa-arrow-left"></i> Back
            </button>
          </div>
        </form>
      </div>
    </main>

    <script>
      // ========================================
      // State
      // ========================================
      let codeManuallyEdited = false;
      let lastAutoCode = "";
      let isEditMode = false;
      let currentProjectId = null;
      let currentWorkspaceId = null;
      let orgSuggestions = new Set();

      // ========================================
      // Contract Forms Data
      // ========================================
      const contractForms = {
        JCT: [
          "JCT Standard Building Contract 2016 (SBC 2016)",
          "JCT Design and Build Contract 2016 (DB 2016)",
          "JCT Design and Build Contract 2024 (DB 2024)",
          "JCT Intermediate Building Contract 2016 (IC 2016)",
          "JCT Minor Works Contract 2016 (MW 2016)",
          "JCT Major Project Construction Contract 2016 (MP 2016)",
          "JCT Management Building Contract 2016 (MC 2016)",
          "JCT Construction Management Contract 2016 (CM 2016)",
          "JCT Measured Term Contract 2016 (MTC 2016)",
          "JCT Framework Agreement 2016 (FA 2016)"
        ],
        NEC: [
          "NEC4 Engineering and Construction Contract (ECC)",
          "NEC4 Engineering and Construction Short Contract (ECSC)",
          "NEC4 Professional Service Contract (PSC)",
          "NEC4 Term Service Contract (TSC)",
          "NEC4 Supply Contract (SC)",
          "NEC3 Engineering and Construction Contract (ECC)"
        ],
        FIDIC: [
          "FIDIC Red Book 2017 (Construction)",
          "FIDIC Yellow Book 2017 (Plant and Design-Build)",
          "FIDIC Silver Book 2017 (EPC/Turnkey)",
          "FIDIC Green Book 2021 (Short Form)",
          "FIDIC White Book 2017 (Client/Consultant)"
        ],
        ICE: [
          "ICE Conditions of Contract 7th Edition",
          "ICE Design and Construct 2nd Edition",
          "ICE Minor Works 3rd Edition",
          "ICE Term Version"
        ]
      };

      // ========================================
      // Utility Functions
      // ========================================
      function getAuthHeaders() {
        const token =
          localStorage.getItem("vericase_token") ||
          localStorage.getItem("token") ||
          localStorage.getItem("jwt");
        return token 
          ? { Authorization: `Bearer ${token}`, "Content-Type": "application/json" } 
          : { "Content-Type": "application/json" };
      }

      function buildProjectCode(name) {
        const cleaned = String(name || "")
          .replace(/[^a-zA-Z0-9]+/g, " ")
          .trim();
        const parts = cleaned ? cleaned.split(/\s+/) : [];
        const abbrev = parts
          .map((part) => part.slice(0, 3))
          .join("")
          .slice(0, 6)
          .toUpperCase();
        const suffix = Math.random().toString(36).slice(2, 6).toUpperCase();
        return `${abbrev || "PROJ"}-${suffix}`;
      }

      function syncAutoCode() {
        const nameInput = document.getElementById("projectName");
        const codeInput = document.getElementById("projectCode");
        if (!nameInput || !codeInput || codeManuallyEdited || isEditMode) return;
        const nextCode = buildProjectCode(nameInput.value);
        if (!codeInput.value || codeInput.value === lastAutoCode) {
          codeInput.value = nextCode;
          lastAutoCode = nextCode;
        }
      }

      // UK Date Formatting (dd/mm/yyyy)
      function formatUKDate(input) {
        let value = input.value.replace(/[^\d]/g, '');
        if (value.length >= 2) {
          value = value.slice(0, 2) + '/' + value.slice(2);
        }
        if (value.length >= 5) {
          value = value.slice(0, 5) + '/' + value.slice(5, 9);
        }
        input.value = value.slice(0, 10);
      }

      function parseUKDate(str) {
        if (!str) return null;
        const parts = str.split('/');
        if (parts.length !== 3) return null;
        const [day, month, year] = parts.map(Number);
        if (!day || !month || !year) return null;
        return new Date(year, month - 1, day);
      }

      function toISODate(ukDateStr) {
        const date = parseUKDate(ukDateStr);
        if (!date || isNaN(date.getTime())) return null;
        return date.toISOString().split('T')[0];
      }

      function toUKDate(isoDateStr) {
        if (!isoDateStr) return '';
        const date = new Date(isoDateStr);
        if (isNaN(date.getTime())) return '';
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }

      function validateDates() {
        const startInput = document.getElementById("startDate");
        const completionInput = document.getElementById("completionDate");
        const helper = document.getElementById("completionDateHelper");
        
        const startDate = parseUKDate(startInput.value);
        const completionDate = parseUKDate(completionInput.value);
        
        if (startDate && completionDate && completionDate < startDate) {
          completionInput.classList.add("error");
          helper.classList.add("error");
          helper.textContent = "Completion Date must be on or after Start Date";
          return false;
        } else {
          completionInput.classList.remove("error");
          helper.classList.remove("error");
          helper.textContent = "Must be on or after Start Date if both provided";
          return true;
        }
      }

      // ========================================
      // Stakeholders Table
      // ========================================
      const stakeholderRoles = [
        "Main Contractor",
        "Council",
        "Employers Agent",
        "Project Manager",
        "Client",
        "Building Control",
        "Subcontractor",
        "Client Management Team",
        "Custom"
      ];

      function createStakeholderRow(role = "", name = "", isDefault = false) {
        const tr = document.createElement("tr");
        if (isDefault) tr.dataset.default = "true";
        
        const roleOptions = stakeholderRoles
          .map(r => `<option value="${r}" ${r === role ? 'selected' : ''}>${r === 'Custom' ? 'Custom...' : r}</option>`)
          .join('');
        
        tr.innerHTML = `
          <td>
            <select class="form-select stakeholder-role" onchange="handleRoleChange(this)">
              <option value="">Select role...</option>
              ${roleOptions}
            </select>
            <input type="text" class="form-input custom-role hidden" placeholder="Enter custom role" style="margin-top: 0.5rem;" />
          </td>
          <td>
            <input type="text" class="form-input stakeholder-name" value="${name}" list="org-suggestions" autocomplete="off" placeholder="Name or organisation" />
          </td>
          <td class="action-col">
            <button type="button" class="btn-delete-row" onclick="deleteRow(this)" ${isDefault ? 'disabled title="Default row cannot be deleted"' : ''}>
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        // Add to suggestions
        const nameInput = tr.querySelector('.stakeholder-name');
        nameInput.addEventListener('blur', () => {
          if (nameInput.value.trim()) {
            orgSuggestions.add(nameInput.value.trim());
            updateOrgSuggestions();
          }
        });
        
        return tr;
      }

      function handleRoleChange(select) {
        const customInput = select.parentElement.querySelector('.custom-role');
        if (select.value === 'Custom') {
          customInput.classList.remove('hidden');
          customInput.focus();
        } else {
          customInput.classList.add('hidden');
          customInput.value = '';
        }
      }

      function addStakeholderRow(role = "", name = "") {
        const tbody = document.getElementById("stakeholdersBody");
        tbody.appendChild(createStakeholderRow(role, name, false));
      }

      function updateOrgSuggestions() {
        const datalist = document.getElementById("org-suggestions");
        datalist.innerHTML = Array.from(orgSuggestions)
          .map(name => `<option value="${name}">`)
          .join('');
      }

      function getStakeholders() {
        const rows = document.querySelectorAll("#stakeholdersBody tr");
        const stakeholders = [];
        rows.forEach(row => {
          const roleSelect = row.querySelector('.stakeholder-role');
          const customRole = row.querySelector('.custom-role');
          const nameInput = row.querySelector('.stakeholder-name');
          
          let role = roleSelect.value;
          if (role === 'Custom' && customRole.value.trim()) {
            role = customRole.value.trim();
          }
          const name = nameInput.value.trim();
          
          if (role && name) {
            stakeholders.push({ role, name });
          }
        });
        return stakeholders;
      }

      // ========================================
      // Keywords Table
      // ========================================
      function createKeywordRow(keyword = "", variations = "") {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <input type="text" class="form-input keyword-name" value="${keyword}" placeholder="e.g., Section 278" />
          </td>
          <td>
            <input type="text" class="form-input keyword-variations" value="${variations}" placeholder="e.g., Section 278, Highways Agreement, S278" />
          </td>
          <td class="action-col">
            <button type="button" class="btn-delete-row" onclick="deleteRow(this)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        return tr;
      }

      function addKeywordRow(keyword = "", variations = "") {
        const tbody = document.getElementById("keywordsBody");
        tbody.appendChild(createKeywordRow(keyword, variations));
      }

      function getKeywords() {
        const rows = document.querySelectorAll("#keywordsBody tr");
        const keywords = [];
        rows.forEach(row => {
          const keyword = row.querySelector('.keyword-name').value.trim();
          const variations = row.querySelector('.keyword-variations').value.trim();
          if (keyword) {
            keywords.push({ name: keyword, variations });
          }
        });
        return keywords;
      }

      // ========================================
      // Contract Type Cascading
      // ========================================
      function updateContractForms() {
        const familySelect = document.getElementById("contractFamily");
        const formSelect = document.getElementById("contractForm");
        const customWrapper = document.getElementById("customContractWrapper");
        const customInput = document.getElementById("contractFormCustom");
        
        const family = familySelect.value;
        
        if (family === "Custom") {
          formSelect.disabled = true;
          formSelect.innerHTML = '<option value="">N/A for custom</option>';
          customWrapper.classList.remove("hidden");
          customInput.focus();
        } else if (family && contractForms[family]) {
          formSelect.disabled = false;
          formSelect.innerHTML = '<option value="">Select form...</option>' +
            contractForms[family].map(form => `<option value="${form}">${form}</option>`).join('');
          customWrapper.classList.add("hidden");
          customInput.value = "";
        } else {
          formSelect.disabled = true;
          formSelect.innerHTML = '<option value="">Select family first...</option>';
          customWrapper.classList.add("hidden");
          customInput.value = "";
        }
      }

      // ========================================
      // Generic Row Delete
      // ========================================
      function deleteRow(btn) {
        const row = btn.closest("tr");
        if (row.dataset.default === "true") return;
        row.remove();
      }

      // ========================================
      // Load Project (Edit Mode)
      // ========================================
      async function loadProject(projectId) {
        const response = await fetch(`/api/projects/${encodeURIComponent(projectId)}`, {
          headers: getAuthHeaders()
        });
        if (!response.ok) {
          throw new Error("Failed to load project details");
        }
        const data = await response.json();
        
        // Basic fields
        document.getElementById("projectName").value = data.project_name || "";
        document.getElementById("projectCode").value = data.project_code || "";
        document.getElementById("startDate").value = toUKDate(data.start_date);
        document.getElementById("completionDate").value = toUKDate(data.completion_date);
        
        lastAutoCode = data.project_code || "";
        codeManuallyEdited = true;
        
        // Contract type
        if (data.contract_family) {
          document.getElementById("contractFamily").value = data.contract_family;
          updateContractForms();
          if (data.contract_form) {
            document.getElementById("contractForm").value = data.contract_form;
          }
          if (data.contract_family === "Custom" && data.contract_form_custom) {
            document.getElementById("contractFormCustom").value = data.contract_form_custom;
          }
        } else if (data.contract_type) {
          // Legacy: try to match family
          document.getElementById("contractFamily").value = data.contract_type;
          updateContractForms();
        }
        
        // Stakeholders
        const stakeholdersBody = document.getElementById("stakeholdersBody");
        stakeholdersBody.innerHTML = "";
        if (Array.isArray(data.stakeholders) && data.stakeholders.length > 0) {
          data.stakeholders.forEach((s, i) => {
            stakeholdersBody.appendChild(createStakeholderRow(s.role, s.name, i === 0));
          });
        } else {
          // Add default row
          stakeholdersBody.appendChild(createStakeholderRow("Main Contractor", "United Living", true));
        }
        
        // Keywords
        const keywordsBody = document.getElementById("keywordsBody");
        keywordsBody.innerHTML = "";
        if (Array.isArray(data.keywords) && data.keywords.length > 0) {
          data.keywords.forEach(k => {
            // Handle both backend formats: keyword_name (from API) and name (from CaseCreate schema)
            const kw = k.keyword_name || k.name || k.keyword || "";
            keywordsBody.appendChild(createKeywordRow(kw, k.variations || ""));
          });
        } else {
          // Add one empty row
          addKeywordRow();
        }
      }

      // ========================================
      // Submit Form
      // ========================================
      async function submitProject(event) {
        event.preventDefault();
        
        const nameValue = document.getElementById("projectName").value.trim();
        if (!nameValue) {
          VericaseUI.Toast.error("Please enter a project name");
          return;
        }
        
        if (nameValue.length < 2 || nameValue.length > 200) {
          VericaseUI.Toast.error("Project name must be 2-200 characters");
          return;
        }

	        if (!isEditMode && !currentWorkspaceId) {
	          VericaseUI.Toast.error("Select a workspace first");
	          window.location.href = "workspace-hub.html";
	          return;
	        }
        
        // Validate dates
        if (!validateDates()) {
          VericaseUI.Toast.error("Completion Date must be on or after Start Date");
          return;
        }

        // Project code
        const codeValue = document.getElementById("projectCode").value.trim();
        let resolvedCode = codeValue;
        if (!resolvedCode && !isEditMode) {
          resolvedCode = buildProjectCode(nameValue);
          document.getElementById("projectCode").value = resolvedCode;
          lastAutoCode = resolvedCode;
        }
        
        // Contract type
        const contractFamily = document.getElementById("contractFamily").value;
        const contractForm = document.getElementById("contractForm").value;
        const contractFormCustom = document.getElementById("contractFormCustom").value.trim();

        const payload = {
          project_name: nameValue,
          project_code: resolvedCode || null,
          start_date: toISODate(document.getElementById("startDate").value) || null,
          completion_date: toISODate(document.getElementById("completionDate").value) || null,
          contract_family: contractFamily || null,
          contract_form: contractFamily === "Custom" ? null : contractForm || null,
          contract_form_custom: contractFamily === "Custom" ? contractFormCustom : null,
          contract_type: contractFamily || null, // Legacy field
          stakeholders: getStakeholders(),
          keywords: getKeywords()
        };
        
        if (!isEditMode) {
          payload.workspace_id = currentWorkspaceId;
        }

        const btn = document.getElementById("createProjectBtn");
        btn.disabled = true;
        btn.innerHTML = isEditMode
          ? '<i class="fas fa-spinner fa-spin"></i> Saving...'
          : '<i class="fas fa-spinner fa-spin"></i> Creating...';

        try {
          const endpoint = isEditMode 
            ? `/api/projects/${encodeURIComponent(currentProjectId)}` 
            : "/api/projects";
          const response = await fetch(endpoint, {
            method: isEditMode ? "PUT" : "POST",
            headers: getAuthHeaders(),
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Failed to save project");
          }
          
          const data = await response.json();
          const projectId = data.id || currentProjectId;
          
          // Store in localStorage
          localStorage.setItem("profileType", "project");
          localStorage.setItem("vericase_current_project", projectId);
          localStorage.setItem("currentProjectId", projectId);
          localStorage.setItem("projectId", projectId);
          localStorage.setItem("currentProjectName", data.project_name || nameValue);
          localStorage.setItem("vericase_current_project_name", data.project_name || nameValue);
          
          VericaseUI.Toast.success(isEditMode ? "Project updated" : "Project created");
          window.location.href = `projectdashboard.html?projectId=${encodeURIComponent(projectId)}`;
        } catch (error) {
          VericaseUI.Toast.error(error.message || "Failed to save project");
        } finally {
          btn.disabled = false;
          btn.innerHTML = isEditMode 
            ? '<i class="fas fa-save"></i> Save Changes' 
            : '<i class="fas fa-plus"></i> Create Project';
        }
      }

      async function rescanKeywordsForProject() {
        if (!currentProjectId) {
          VericaseUI.Toast.info("Save the project first, then rescan keywords.");
          return;
        }

        const btn = document.getElementById("rescanKeywordsBtn");
        const hint = document.getElementById("rescanKeywordsHint");
        const original = btn ? btn.innerHTML : "";
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rescanning...';
        }
        if (hint) hint.textContent = "";

        const toast = VericaseUI.Toast.info("Rescanning keywords across correspondence + evidence…", { duration: 0 });
        try {
          const resp = await fetch(`/api/projects/${encodeURIComponent(currentProjectId)}/keywords/rescan`, {
            method: "POST",
            headers: getAuthHeaders(),
            body: JSON.stringify({
              include_emails: true,
              include_evidence: true,
              max_emails: 20000,
              max_evidence: 20000,
              mode: "merge",
            }),
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok) throw new Error(data.detail || "Keyword rescan failed");

          VericaseUI.Toast.dismiss(toast);
          VericaseUI.Toast.success(
            `Rescan complete: ${Number(data.emails_updated || 0)} emails updated, ${Number(data.evidence_updated || 0)} evidence items updated.`,
          );
          if (hint) {
            hint.textContent = `Updated ${Number(data.emails_updated || 0)} emails and ${Number(data.evidence_updated || 0)} evidence items.`;
          }
        } catch (e) {
          console.error("Keyword rescan failed:", e);
          VericaseUI.Toast.dismiss(toast);
          VericaseUI.Toast.error("Keyword rescan failed. Please try again.");
          if (hint) hint.textContent = "Rescan failed.";
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = original;
          }
        }
      }

      // ========================================
      // Initialization
      // ========================================
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        currentProjectId = params.get("projectId");
        currentWorkspaceId = params.get("workspaceId") || localStorage.getItem("currentWorkspaceId");
        
        if (currentWorkspaceId) {
          try {
            localStorage.setItem("currentWorkspaceId", currentWorkspaceId);
          } catch { /* ignore */ }
        }
        
        isEditMode = Boolean(currentProjectId);
        
        const pageTitle = document.querySelector(".page-title");
        const pageSubtitle = document.querySelector(".page-subtitle");
        const submitBtn = document.getElementById("createProjectBtn");
        const backBtn = document.getElementById("backBtn");
        const workspaceLink = document.getElementById("workspaceLink");
        const breadcrumbCurrent = document.getElementById("breadcrumbCurrent");

        if (isEditMode) {
          pageTitle.textContent = "Project Configuration";
          pageSubtitle.textContent = "Update project identification, stakeholders, keywords, and contract details.";
          submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
          breadcrumbCurrent.textContent = "Edit Project";
          
          backBtn.addEventListener("click", () => {
            window.location.href = `projectdashboard.html?projectId=${encodeURIComponent(currentProjectId)}`;
          });
          
          loadProject(currentProjectId).catch((error) => {
            VericaseUI.Toast.error(error.message || "Failed to load project");
          });
          
          if (workspaceLink) workspaceLink.style.display = "none";
          if (workspaceLink?.previousElementSibling) workspaceLink.previousElementSibling.style.display = "none";
        } else {
	          if (!currentWorkspaceId) {
	            VericaseUI.Toast.info("Please select a workspace first to create a project.");
	            window.location.href = "workspace-hub.html";
	            return;
	          }
          
          if (workspaceLink) {
            workspaceLink.href = `workspace-hub.html?workspaceId=${encodeURIComponent(currentWorkspaceId)}`;
            const wsName = localStorage.getItem("currentWorkspaceName");
            if (wsName) workspaceLink.textContent = wsName;
          }
          
          backBtn.addEventListener("click", () => {
            window.location.href = `workspace-hub.html?workspaceId=${encodeURIComponent(currentWorkspaceId)}`;
          });
          
          // Add default stakeholder row
          document.getElementById("stakeholdersBody").appendChild(
            createStakeholderRow("Main Contractor", "United Living", true)
          );
          
          // Add one empty keyword row
          addKeywordRow();
        }

        const rescanBtn = document.getElementById("rescanKeywordsBtn");
        if (rescanBtn) {
          // Only makes sense once the project exists.
          rescanBtn.disabled = !isEditMode;
          if (!isEditMode) rescanBtn.style.display = "none";
        }
        
        // Shell
        if (window.VericaseShell?.inject) {
          VericaseShell.inject({ 
            title: isEditMode ? "Project Configuration" : "Project Setup", 
            breadcrumbs: null, 
            headerActions: "" 
          });
        }
        
        // Event listeners
        document.getElementById("projectName").addEventListener("input", syncAutoCode);
        document.getElementById("projectCode").addEventListener("input", (e) => {
          codeManuallyEdited = e.target.value.trim().length > 0 && e.target.value !== lastAutoCode;
        });
        
        // UK date formatting
        document.getElementById("startDate").addEventListener("input", function() {
          formatUKDate(this);
        });
        document.getElementById("completionDate").addEventListener("input", function() {
          formatUKDate(this);
        });
        document.getElementById("completionDate").addEventListener("blur", validateDates);
        
        document.getElementById("projectForm").addEventListener("submit", submitProject);
      });
    </script>
  </body>
</html>

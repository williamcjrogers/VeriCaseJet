<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeriCase - Profile</title>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="./assets/fontawesome/css/all.min.css"
    />
    <!-- VeriCase Design System -->
    <link rel="stylesheet" href="brand-styles.css?v=6" />
    <link rel="stylesheet" href="design-system.css?v=6" />
    <script src="vericase-ui.js"></script>
    <script src="nav-shell.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: var(--font-sans, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif);
        background: var(--bg-primary);
        min-height: 100vh;
        color: var(--text-primary);
      }

      /* Main Content - adjusted for nav shell */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      /* Profile Grid */
      .profile-grid {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 24px;
      }

      /* Profile Sidebar */
      .profile-sidebar {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(23, 181, 163, 0.1);
        border: 1px solid var(--gray-200);
        height: fit-content;
      }
      .profile-avatar {
        width: 120px;
        height: 120px;
        background: linear-gradient(
          135deg,
          var(--vericase-teal),
          var(--vericase-navy)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: white;
        margin: 0 auto 20px;
        font-weight: 600;
        box-shadow: 0 8px 24px rgba(15, 157, 154, 0.3);
      }
      .profile-info {
        text-align: center;
        margin-bottom: 24px;
      }
      .profile-info h2 {
        font-size: 20px;
        color: var(--text-primary);
        margin-bottom: 4px;
      }
      .profile-info .email {
        color: var(--text-secondary);
        font-size: 14px;
      }
      .profile-stats {
        display: flex;
        justify-content: space-around;
        padding: 16px 0;
        border-top: 1px solid var(--gray-200);
      }
      .stat {
        text-align: center;
      }
      .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: var(--vericase-teal);
      }
      .stat-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
      }

      /* Main Content Area */
      .profile-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      /* Section Card */
      .section-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(23, 181, 163, 0.1);
        border: 1px solid var(--gray-200);
      }
      .section-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--gray-200);
      }
      .section-header h3 {
        font-size: 18px;
        color: var(--text-primary);
      }
      .section-content {
        padding: 24px;
      }

      /* Forms */
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-primary);
        font-weight: 500;
        font-size: 14px;
      }
      .form-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        font-size: 14px;
        transition:
          border-color 0.3s,
          box-shadow 0.3s;
      }
      .form-group input:focus {
        outline: none;
        border-color: var(--vericase-teal);
        box-shadow: 0 0 0 3px rgba(15, 157, 154, 0.15);
      }
      .form-group input:disabled {
        background: var(--gray-100);
        cursor: not-allowed;
      }

      /* Buttons */
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }
      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--vericase-teal),
          var(--vericase-teal-dark)
        );
        color: white;
        box-shadow: 0 4px 12px rgba(15, 157, 154, 0.3);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(15, 157, 154, 0.4);
      }
      .btn-secondary {
        background: white;
        color: var(--text-secondary);
        border: 1px solid var(--gray-200);
      }
      .btn-secondary:hover {
        background: var(--gray-100);
        border-color: var(--vericase-teal);
        color: var(--vericase-teal);
      }
      .btn-danger {
        background: #ef4444;
        color: white;
      }
      .btn-danger:hover {
        background: #dc2626;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Sessions Table */
      .sessions-table {
        width: 100%;
        border-collapse: collapse;
      }
      .sessions-table th {
        text-align: left;
        padding: 12px;
        background: var(--gray-100);
        font-weight: 500;
        font-size: 12px;
        text-transform: uppercase;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--gray-200);
      }
      .sessions-table td {
        padding: 16px 12px;
        border-bottom: 1px solid var(--gray-100);
        font-size: 14px;
      }
      .sessions-table tr:hover {
        background: var(--gray-100);
      }
      .session-current {
        color: var(--vericase-teal);
        font-weight: 500;
      }
      .session-device {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      /* Alert Messages */
      .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }
      .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }

      /* Email Verification Banner */
      .verify-banner {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        color: #92400e;
        padding: 16px 24px;
        border-radius: 6px;
        margin-bottom: 24px;
        display: none;
        align-items: center;
        justify-content: space-between;
      }
      .verify-banner-text {
        font-size: 14px;
      }
      .verify-banner .btn {
        font-size: 12px;
        padding: 6px 16px;
      }

      /* Loading Spinner */
      .spinner {
        border: 2px solid var(--gray-200);
        border-top: 2px solid var(--vericase-teal);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .profile-grid {
          grid-template-columns: 1fr;
        }
        .profile-sidebar {
          order: 2;
        }
        .profile-content {
          order: 1;
        }
      }
    </style>
  </head>
  <body class="preload">
    <!-- Nav shell injected by JavaScript -->
    <div class="container">
      <!-- Email Verification Banner -->
      <div id="verifyBanner" class="verify-banner">
        <span class="verify-banner-text">
          ⚠️ Your email address is not verified. Some features may be limited.
        </span>
        <button class="btn btn-primary" onclick="resendVerification()">
          Resend Verification Email
        </button>
      </div>

      <div class="profile-grid">
        <!-- Sidebar -->
        <aside class="profile-sidebar">
          <div class="profile-avatar" id="avatar"></div>
          <div class="profile-info">
            <h2 id="displayName">Loading...</h2>
            <p class="email" id="email">...</p>
          </div>
          <div class="profile-stats">
            <div class="stat">
              <div class="stat-value" id="sessionCount">0</div>
              <div class="stat-label">Sessions</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="role">User</div>
              <div class="stat-label">Role</div>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="profile-content">
          <!-- Profile Information -->
          <div class="section-card">
            <div class="section-header">
              <h3>Profile Information</h3>
            </div>
            <div class="section-content">
              <div id="profileAlert" class="alert"></div>
              <form id="profileForm">
                <div class="form-group">
                  <label for="profileEmail">Email Address</label>
                  <input type="email" id="profileEmail" disabled />
                </div>
                <div class="form-group">
                  <label for="profileDisplayName">Display Name</label>
                  <input
                    type="text"
                    id="profileDisplayName"
                    placeholder="Enter your display name"
                  />
                </div>
                <button type="submit" class="btn btn-primary">
                  Update Profile
                </button>
              </form>
            </div>
          </div>

          <!-- Change Password -->
          <div class="section-card">
            <div class="section-header">
              <h3>Change Password</h3>
            </div>
            <div class="section-content">
              <div id="passwordAlert" class="alert"></div>
              <form id="passwordForm">
                <div class="form-group">
                  <label for="currentPassword">Current Password</label>
                  <input type="password" id="currentPassword" required />
                </div>
                <div class="form-group">
                  <label for="newPassword">New Password</label>
                  <input type="password" id="newPassword" required />
                </div>
                <div class="form-group">
                  <label for="confirmPassword">Confirm New Password</label>
                  <input type="password" id="confirmPassword" required />
                </div>
                <button type="submit" class="btn btn-primary">
                  Change Password
                </button>
              </form>
            </div>
          </div>

          <!-- Active Sessions -->
          <div class="section-card">
            <div class="section-header">
              <h3>Active Sessions</h3>
            </div>
            <div class="section-content">
              <div id="sessionsAlert" class="alert"></div>
              <table class="sessions-table">
                <thead>
                  <tr>
                    <th>Device</th>
                    <th>IP Address</th>
                    <th>Last Active</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="sessionsTable">
                  <tr>
                    <td colspan="4" style="text-align: center; padding: 40px">
                      <div class="spinner"></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      // Inject navigation shell
      document.addEventListener("DOMContentLoaded", () => {
        VericaseShell.inject({
          title: '',
          breadcrumbs: [
            { label: "Home", url: "master-dashboard.html", icon: "fa-home" },
            { label: "User Profile", icon: "fa-user" },
          ],
          headerActions: '<a href="#" id="logoutLink" style="color: var(--vericase-teal); text-decoration: none; font-size: 14px; font-weight: 500;"><i class="fas fa-sign-out-alt"></i> Logout</a>',
        });

        // Remove preload class
        requestAnimationFrame(() => {
          document.body.classList.remove("preload");
        });

        // Setup logout handler after shell is injected
        const logoutLink = document.getElementById("logoutLink");
        if (logoutLink) {
          logoutLink.addEventListener("click", handleLogout);
        }

        // Initialize page
        loadProfile();
        loadSessions();
      });

      const apiUrl = window.location.origin;
      const token = localStorage.getItem("token");
      let currentUser = null;

      // Check authentication
      if (!token) {
        window.location.href = "login.html";
      }

      // API Helper
      async function apiCall(endpoint, method = "GET", body = null) {
        const options = {
          method,
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        };

        if (body) {
          options.body = JSON.stringify(body);
        }

        const response = await fetch(`${apiUrl}${endpoint}`, options);

        if (response.status === 401) {
          // Token expired
          localStorage.removeItem("token");
          localStorage.removeItem("user");
          window.location.href = "login.html";
          return;
        }

        return response;
      }

      // Load user profile
      async function loadProfile() {
        try {
          const response = await apiCall("/api/users/me");
          if (response.ok) {
            currentUser = await response.json();
            updateProfileUI();
          }
        } catch (error) {
          console.error("Failed to load profile:", error);
        }
      }

      // Update profile UI
      function updateProfileUI() {
        // Avatar
        document.getElementById("avatar").textContent = currentUser.display_name
          ? currentUser.display_name
              .split(" ")
              .map((n) => n[0])
              .join("")
              .toUpperCase()
          : currentUser.email[0].toUpperCase();

        // Info
        document.getElementById("displayName").textContent =
          currentUser.display_name || "No name set";
        document.getElementById("email").textContent = currentUser.email;
        document.getElementById("role").textContent =
          currentUser.role || "USER";

        // Form
        document.getElementById("profileEmail").value = currentUser.email;
        document.getElementById("profileDisplayName").value =
          currentUser.display_name || "";

        // Email verification banner
        if (!currentUser.email_verified) {
          document.getElementById("verifyBanner").style.display = "flex";
        }
      }

      // Load active sessions
      async function loadSessions() {
        try {
          const response = await apiCall("/api/auth/sessions");
          if (response.ok) {
            const data = await response.json();
            updateSessionsTable(data.sessions);
            document.getElementById("sessionCount").textContent =
              data.sessions.length;
          }
        } catch (error) {
          console.error("Failed to load sessions:", error);
        }
      }

      // Update sessions table
      function updateSessionsTable(sessions) {
        const tbody = document.getElementById("sessionsTable");

        if (sessions.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" style="text-align: center;">No active sessions</td></tr>';
          return;
        }

        tbody.innerHTML = sessions
          .map((session) => {
            const device = parseUserAgent(session.user_agent);
            const lastActive = new Date(session.last_activity).toLocaleString();
            const isCurrentSession = session.is_current
              ? '<span class="session-current">(Current)</span>'
              : "";

            return `
                    <tr>
                        <td>
                            ${device.browser} on ${device.os}
                            <div class="session-device">${session.user_agent.substring(0, 50)}...</div>
                        </td>
                        <td>${session.ip_address || "Unknown"}</td>
                        <td>${lastActive} ${isCurrentSession}</td>
                        <td>
                            ${!session.is_current ? `<button class="btn btn-danger btn-sm" onclick="revokeSession('${session.id}')">Revoke</button>` : ""}
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      // Parse user agent
      function parseUserAgent(ua) {
        // Simple parser
        let browser = "Unknown Browser";
        let os = "Unknown OS";

        if (ua.includes("Chrome")) browser = "Chrome";
        else if (ua.includes("Firefox")) browser = "Firefox";
        else if (ua.includes("Safari")) browser = "Safari";
        else if (ua.includes("Edge")) browser = "Edge";

        if (ua.includes("Windows")) os = "Windows";
        else if (ua.includes("Mac")) os = "macOS";
        else if (ua.includes("Linux")) os = "Linux";
        else if (ua.includes("Android")) os = "Android";
        else if (ua.includes("iOS")) os = "iOS";

        return { browser, os };
      }

      // Profile form handler
      document
        .getElementById("profileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const displayName = document
            .getElementById("profileDisplayName")
            .value.trim();
          const alert = document.getElementById("profileAlert");

          try {
            const response = await apiCall("/api/users/me", "PATCH", {
              display_name: displayName,
            });

            if (response.ok) {
              currentUser = await response.json();
              updateProfileUI();

              alert.className = "alert alert-success";
              alert.textContent = "Profile updated successfully!";
              alert.style.display = "block";

              // Update stored user
              localStorage.setItem("user", JSON.stringify(currentUser));
            } else {
              alert.className = "alert alert-error";
              alert.textContent = "Failed to update profile. Please try again.";
              alert.style.display = "block";
            }
          } catch (error) {
            alert.className = "alert alert-error";
            alert.textContent = "Failed to update profile. Please try again.";
            alert.style.display = "block";
          }
        });

      // Password form handler
      document
        .getElementById("passwordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const currentPassword =
            document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;
          const alert = document.getElementById("passwordAlert");

          if (newPassword !== confirmPassword) {
            alert.className = "alert alert-error";
            alert.textContent = "New passwords do not match!";
            alert.style.display = "block";
            return;
          }

          try {
            const response = await apiCall(
              "/api/auth/change-password",
              "POST",
              {
                current_password: currentPassword,
                new_password: newPassword,
              },
            );

            if (response.ok) {
              alert.className = "alert alert-success";
              alert.textContent = "Password changed successfully!";
              alert.style.display = "block";

              // Clear form
              document.getElementById("passwordForm").reset();
            } else {
              const error = await response.json();
              const errorMsg = error.detail || "Failed to change password";
              alert.className = "alert alert-error";
              alert.textContent = errorMsg;
              alert.style.display = "block";
            }
          } catch (error) {
            alert.className = "alert alert-error";
            alert.textContent = error.message;
            alert.style.display = "block";
          }
        });

      // Revoke session
      async function revokeSession(sessionId) {
        if (!confirm("Are you sure you want to revoke this session?")) {
          return;
        }

        try {
          const response = await apiCall(
            `/api/auth/sessions/${sessionId}`,
            "DELETE",
          );
          if (response.ok) {
            loadSessions();

            const alert = document.getElementById("sessionsAlert");
            alert.className = "alert alert-success";
            alert.textContent = "Session revoked successfully!";
            alert.style.display = "block";
          }
        } catch (error) {
          console.error("Failed to revoke session:", error);
        }
      }

      // Resend verification email
      async function resendVerification() {
        // TODO: Implement resend verification endpoint
        alert("Verification email sent!");
      }

      // Logout handler
      async function handleLogout(e) {
        e.preventDefault();

        try {
          await apiCall("/api/auth/logout", "POST");
        } catch (error) {
          // Logout anyway
        }

        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>

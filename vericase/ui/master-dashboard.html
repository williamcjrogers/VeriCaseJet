<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VeriCase - Master Dashboard</title>
  <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="brand-styles.css?v=9" />
  <link rel="stylesheet" href="design-system.css?v=9" />
  <script src="vericase-ui.js"></script>
  <script src="nav-shell.js"></script>
  <style>
    /* === MASTER DASHBOARD - REFINED LAYOUT === */

    .app-content {
      /* Match Control Centre styling */
      background-color: var(--vericase-cream);
      background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
      background-size: 24px 24px;
      border: none;
      border-radius: 0;
      box-shadow: none;
      margin: 0;
      padding: 32px 48px;
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }

    /* === WATERMARKS - Match Control Centre === */
    .watermark {
      position: absolute;
      font-size: 280px;
      color: var(--vericase-navy);
      opacity: 0.025;
      pointer-events: none;
      z-index: 0;
    }

    .watermark-scales {
      right: -40px;
      top: 80px;
      transform: rotate(-12deg);
    }

    .watermark-gavel {
      left: -60px;
      bottom: -20px;
      transform: rotate(15deg);
    }

    /* === Ensure content is above watermarks === */
    .dashboard-header,
    .search-section,
    .dashboard-layout,
    .workspaces-section,
    .dashboard-sidebar {
      position: relative;
      z-index: 1;
    }

    /* === COMPACT HEADER === */
    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px; /* Tighter: was 20px */
      margin-bottom: 16px; /* Tighter: was 28px */
      flex-wrap: wrap;
    }

    .dashboard-greeting {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .greeting-kicker {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--vericase-gold-muted);
    }

    .greeting-title {
      font-family: var(--font-serif);
      font-size: 1.625rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* === STATS BAR - COMPACT === */
    .stats-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .stat-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #FFFFFF;
      border: 1px solid var(--border-default);
      border-left: 3px solid var(--gray-300);
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      color: var(--text-secondary);
      box-shadow: var(--shadow-card);
      transition: all 0.15s ease;
    }

    .stat-pill:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    /* Accent borders for each stat */
    .stat-pill.projects { border-left-color: var(--vericase-navy); }
    .stat-pill.cases { border-left-color: var(--vericase-gold); }
    .stat-pill.emails { border-left-color: var(--vericase-teal); }
    .stat-pill.evidence { border-left-color: #78716C; }

    .stat-pill i {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .stat-pill strong {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--text-primary);
    }

    /* === SEARCH BAR === */
    .search-section {
      margin-bottom: 32px;
    }

    .search-wrapper {
      position: relative;
      max-width: 720px;
    }

    .search-input {
      width: 100%;
      padding: 14px 20px 14px 48px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-xl);
      font-size: 0.9375rem;
      background: white;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--vericase-teal);
      box-shadow: 0 0 0 3px rgba(31, 111, 120, 0.1), var(--shadow-md);
    }

    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 0.9375rem;
    }

    .search-hint {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .search-hint-text {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .search-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(181, 155, 106, 0.25);
      border-radius: var(--radius-md); /* Professional 6px, not pills */
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .search-chip:hover {
      background: white;
      border-color: var(--vericase-teal);
      color: var(--vericase-teal-dark);
    }

    .search-chip i {
      color: var(--vericase-teal);
      font-size: 0.625rem;
    }

    /* === QUICK ACTIONS === */
    .quick-actions-section {
      margin-bottom: 32px;
      position: relative;
      z-index: 1;
    }

    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    @media (max-width: 1200px) {
      .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .quick-actions-grid {
        grid-template-columns: 1fr;
      }
    }

    .quick-action-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      background: white;
      border: 1px solid var(--border-default);
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.2s;
      box-shadow: 2px 2px 0px rgba(15, 23, 42, 0.03);
    }

    .quick-action-card:hover {
      border-color: var(--vericase-teal);
      box-shadow: 4px 4px 0px rgba(15, 23, 42, 0.06);
      transform: translateY(-2px);
    }

    .quick-action-icon {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .quick-action-content {
      flex: 1;
      min-width: 0;
    }

    .quick-action-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--vericase-navy);
      margin-bottom: 2px;
    }

    .quick-action-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* === MAIN CONTENT LAYOUT === */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 32px;
      align-items: start;
    }

    @media (max-width: 1100px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
      }

      .dashboard-sidebar {
        order: -1;
      }
    }

    /* === WORKSPACES SECTION === */
    .workspaces-section {
      min-width: 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: var(--font-sans);
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, var(--vericase-teal), var(--vericase-navy));
      border-radius: 2px;
    }

    .section-count {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--gray-100);
      padding: 2px 8px;
      border-radius: var(--radius-md); /* Professional 6px, not pills */
    }

    /* === WORKSPACE LIST (Master-Detail Layout) === */
    .workspace-master-detail {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 20px;
      min-height: 400px;
    }

    .workspace-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .workspace-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 18px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-bottom: 1px solid var(--gray-100);
      background: white;
    }

    .workspace-row:nth-child(even) {
      background: var(--gray-50);
    }

    .workspace-row:last-child {
      border-bottom: none;
    }

    .workspace-row:hover {
      background: rgba(var(--vericase-teal-rgb), 0.06);
    }

    .workspace-row.selected {
      background: rgba(var(--vericase-teal-rgb), 0.1);
      border-left: 3px solid var(--vericase-teal);
      padding-left: 15px;
    }

    .workspace-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .workspace-icon.project {
      background: rgba(47, 134, 200, 0.1);
      color: var(--vericase-blue);
    }

    .workspace-icon.case {
      background: rgba(181, 155, 106, 0.15);
      color: var(--vericase-gold);
    }

    .workspace-info {
      flex: 1;
      min-width: 0;
    }

    .workspace-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .workspace-code {
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .workspace-stats {
      display: flex;
      gap: 16px;
      flex-shrink: 0;
    }

    .workspace-stat {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .workspace-stat i {
      color: var(--vericase-teal);
      font-size: 0.6875rem;
    }

    .workspace-status {
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 3px 8px;
      border-radius: var(--radius-md);
      background: rgba(5, 150, 105, 0.1);
      color: var(--success);
      flex-shrink: 0;
    }

    .workspace-menu-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      opacity: 0;
      flex-shrink: 0;
    }

    .workspace-row:hover .workspace-menu-btn {
      opacity: 1;
    }

    .workspace-menu-btn:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    /* === WORKSPACE DETAIL PANEL (Right Side) === */
    .workspace-detail-panel {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
    }

    .detail-panel-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    .detail-panel-empty i {
      font-size: 2rem;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .detail-panel-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .detail-panel-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .detail-panel-actions {
      display: flex;
      gap: 8px;
    }

    .detail-panel-btn {
      padding: 6px 12px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid var(--gray-200);
      background: white;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .detail-panel-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    .detail-panel-btn.primary {
      background: var(--vericase-teal);
      color: white;
      border-color: var(--vericase-teal);
    }

    .detail-panel-btn.primary:hover {
      background: var(--vericase-teal-dark);
    }

    .detail-panel-body {
      flex: 1;
      overflow-y: auto;
    }

    .detail-section {
      padding: 14px 18px;
      border-bottom: 1px solid var(--gray-100);
    }

    .detail-section:last-child {
      border-bottom: none;
    }

    .detail-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .detail-section-title {
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .detail-section-count {
      font-size: 0.625rem;
      font-weight: 600;
      padding: 2px 6px;
      background: var(--gray-100);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
    }

    /* Project items in detail panel */
    .detail-project-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .detail-project-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--gray-50);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .detail-project-item:hover {
      background: rgba(var(--vericase-blue-rgb, 47, 134, 200), 0.08);
      border-color: rgba(47, 134, 200, 0.2);
    }

    .detail-project-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: rgba(47, 134, 200, 0.1);
      color: var(--vericase-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .detail-project-info {
      flex: 1;
      min-width: 0;
    }

    .detail-project-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .detail-project-code {
      font-family: var(--font-mono);
      font-size: 0.625rem;
      color: var(--text-muted);
    }

    .detail-project-stats {
      display: flex;
      gap: 10px;
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .detail-project-stats i {
      color: var(--vericase-blue);
      margin-right: 3px;
    }

    /* User items in detail panel */
    .detail-user-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .detail-user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: var(--gray-50);
      border-radius: var(--radius-md);
    }

    .detail-user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--vericase-navy);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6875rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .detail-user-info {
      flex: 1;
      min-width: 0;
    }

    .detail-user-name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .detail-user-role {
      font-size: 0.625rem;
      color: var(--text-muted);
    }

    /* Description in detail panel */
    .detail-description {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Legacy stack support (hide in new layout) */
    .workspace-stack {
      display: none;
    }

    .case-count-badge {
      font-size: 0.5625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 2px 6px;
      border-radius: var(--radius-md); /* Professional 6px, not pills */
      background: rgba(var(--vericase-teal-rgb), 0.12);
      color: var(--vericase-teal);
      border: 1px solid rgba(var(--vericase-teal-rgb), 0.2);
    }

    .case-stems {
      margin-left: 16px;
      padding-left: 16px;
      border-left: 2px dashed rgba(var(--vericase-teal-rgb), 0.25);
      display: grid;
      gap: 10px;
    }

    .project-stems {
      margin-left: 16px;
      padding-left: 16px;
      border-left: 2px dashed rgba(47, 134, 200, 0.25);
      display: grid;
      gap: 10px;
    }

    .project-stem {
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .project-stem::before {
      content: "";
      position: absolute;
      left: -16px;
      top: 50%;
      width: 12px;
      height: 2px;
      background: rgba(47, 134, 200, 0.35);
    }

    .project-card {
      flex: 1;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      appearance: none;
    }

    .project-card:hover {
      border-color: var(--vericase-blue);
      box-shadow: 0 6px 16px rgba(15, 23, 32, 0.08);
      transform: translateY(-1px);
    }

    .project-card-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .project-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .project-code {
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .project-meta {
      margin-left: auto;
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .project-meta i {
      color: var(--vericase-blue);
      font-size: 0.7rem;
    }

    .case-stem {
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .case-stem::before {
      content: "";
      position: absolute;
      left: -16px;
      top: 50%;
      width: 12px;
      height: 2px;
      background: rgba(var(--vericase-teal-rgb), 0.35);
    }

    .case-card {
      flex: 1;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      appearance: none;
    }

    .case-card:hover {
      border-color: var(--vericase-teal);
      box-shadow: 0 6px 16px rgba(15, 23, 32, 0.08);
      transform: translateY(-1px);
    }

    .case-card-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .case-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .case-code {
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .case-project-tag {
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .case-meta {
      margin-left: auto;
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .case-meta i {
      color: var(--vericase-teal);
      font-size: 0.7rem;
    }

    .case-menu-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      opacity: 0;
    }

    .case-stem:hover .case-menu-btn {
      opacity: 1;
    }

    .case-menu-btn:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .case-orphans {
      grid-column: 1 / -1;
      padding: 16px;
      border-radius: var(--radius-lg);
      border: 1px dashed rgba(181, 155, 106, 0.35);
      background: rgba(255, 255, 255, 0.7);
    }

    .case-orphans-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--vericase-gold-muted);
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .case-orphans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
    }

    .case-orphans .case-stem::before {
      display: none;
    }

    /* === EMPTY STATE === */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 24px 20px; /* Tighter: was 48px 24px */
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-lg); /* Professional: was xl */
      border: 1px dashed rgba(181, 155, 106, 0.3);
    }

    .empty-state.onboarding-state {
      /* === BONDED PAPER STRATEGY === */
      padding: 64px 40px;
      background-color: var(--vericase-cream); /* Stone White */
      background-image: radial-gradient(var(--gray-200) 1px, transparent 1px);
      background-size: 24px 24px; /* Ledger paper dot grid texture */

      /* Gold letterhead top border */
      border-top: 3px solid var(--vericase-gold);
      border-left: 1px solid var(--gray-200);
      border-right: 1px solid var(--gray-200);
      border-bottom: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);

      position: relative;
      overflow: hidden; /* Clips the watermark */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      max-width: 800px;
      margin: 0 auto;
    }

    /* Watermark - massive faint icon */
    .empty-state.onboarding-state::before {
      content: '\f66f'; /* Font Awesome fa-landmark */
      font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free';
      font-weight: 900;
      position: absolute;
      right: -40px;
      bottom: -40px;
      font-size: 300px;
      color: var(--vericase-navy);
      opacity: 0.03; /* Barely visible, adds expensive feel */
      transform: rotate(-15deg);
      pointer-events: none;
      z-index: 1;
    }

    .onboarding-icon {
      /* Engraved/stamped into paper effect */
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0 auto 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: #FFFFFF;
      /* Inset shadow makes it look stamped into the paper */
      box-shadow:
        0 0 0 1px var(--gray-200),
        0 10px 15px -3px rgba(0, 0, 0, 0.05),
        inset 0 2px 4px rgba(0, 0, 0, 0.05);
      z-index: 10;
    }

    .onboarding-icon i {
      font-size: 36px;
      color: var(--vericase-navy);
    }

    .onboarding-title {
      font-family: var(--font-serif);
      font-weight: 600;
      font-size: 28px;
      color: var(--vericase-navy);
      margin-bottom: 16px;
      letter-spacing: -0.5px;
      position: relative;
      z-index: 10;
    }

    .onboarding-description {
      font-family: var(--font-sans);
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.6;
      max-width: 460px;
      margin: 0 auto 40px auto;
      position: relative;
      z-index: 10;
    }

    .onboarding-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 420px;
      margin: 0 auto 40px;
      text-align: left;
      position: relative;
      z-index: 10;
    }

    .onboarding-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-md);
      border: 1px solid var(--gray-200);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .step-number {
      width: 28px;
      height: 28px;
      background: var(--vericase-navy);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .step-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .step-text strong {
      color: var(--text-primary);
    }

    .btn-lg {
      padding: 16px 32px;
      font-size: 1rem;
    }

    .empty-icon {
      font-size: 2.5rem;
      color: var(--gray-300);
      margin-bottom: 16px;
    }

    .empty-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .empty-text {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    /* === SIDEBAR === */
    .dashboard-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* === QUICK START CARD === */
    .quick-start-card {
      background: white;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-default);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .quick-start-header {
      padding: 16px 20px;
      background: linear-gradient(
        135deg,
        rgba(var(--vericase-sage-mist-rgb), 0.9) 0%,
        rgba(255, 255, 255, 0) 100%
      );
      border-bottom: 1px solid var(--border-default);
    }

    .quick-start-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quick-start-title i {
      color: var(--vericase-teal);
    }

    .quick-start-actions {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .quick-action {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      text-decoration: none;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.15s;
      border: none;
      background: transparent;
      cursor: pointer;
      text-align: left;
      width: 100%;
    }

    .quick-action:hover {
      background: var(--gray-50);
    }

    .quick-action-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      background: rgba(31, 111, 120, 0.08);
      color: var(--vericase-teal);
      flex-shrink: 0;
      transition: all 0.15s;
    }

    .quick-action:hover .quick-action-icon {
      background: var(--vericase-teal);
      color: white;
    }

    .quick-action-text {
      flex: 1;
      min-width: 0;
    }

    .quick-action-label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .quick-action-desc {
      font-size: 0.6875rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .quick-action.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .quick-action.locked:hover {
      background: transparent;
    }

    .quick-action.locked:hover .quick-action-icon {
      background: rgba(31, 111, 120, 0.08);
      color: var(--vericase-teal);
    }

    .quick-action-badge {
      font-size: 0.5625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--vericase-gold-muted);
      background: rgba(181, 155, 106, 0.15);
      padding: 2px 6px;
      border-radius: var(--radius-md); /* Professional 6px, not pills */
    }

    /* === CONTEXT INDICATOR === */
    .context-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(31, 111, 120, 0.06);
      border: 1px solid rgba(31, 111, 120, 0.15);
      border-radius: var(--radius-md);
      margin: 12px 12px 0;
    }

    .context-indicator.no-context {
      background: var(--gray-50);
      border-color: var(--gray-200);
    }

    .context-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--vericase-teal);
      flex-shrink: 0;
    }

    .context-indicator.no-context .context-dot {
      background: var(--gray-400);
    }

    .context-text {
      font-size: 0.75rem;
      color: var(--text-secondary);
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .context-text strong {
      font-weight: 600;
      color: var(--vericase-teal-dark);
    }

    .context-indicator.no-context .context-text strong {
      color: var(--text-muted);
    }

    /* === AI ASSISTANT CARD === */
    .ai-card {
      background: white;
      border-radius: var(--radius-xl);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .ai-card-header {
      padding: 14px 16px;
      background: linear-gradient(135deg, rgba(31, 111, 120, 0.05) 0%, rgba(26, 43, 60, 0.03) 100%);
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .ai-card-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-card-title i {
      color: var(--vericase-teal);
    }

    .ai-toggle-btn {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--vericase-teal);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.15s;
    }

    .ai-toggle-btn:hover {
      background: rgba(31, 111, 120, 0.08);
    }

    .ai-card-body {
      padding: 16px;
    }

    .ai-prompt-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      resize: none;
      font-family: inherit;
      transition: all 0.15s;
    }

    .ai-prompt-input:focus {
      outline: none;
      border-color: var(--vericase-teal);
      box-shadow: 0 0 0 3px rgba(31, 111, 120, 0.08);
    }

    .ai-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .ai-suggestion {
      font-size: 0.6875rem;
      padding: 5px 10px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md); /* Professional 6px, not pills */
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .ai-suggestion:hover {
      background: white;
      border-color: var(--vericase-teal);
      color: var(--vericase-teal-dark);
    }

    /* === AI CHAT PANEL (EXPANDED) === */
    .ai-chat-panel {
      display: none;
    }

    .ai-chat-panel.active {
      display: block;
    }

    .ai-chat-messages {
      max-height: 250px;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ai-message {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .ai-message.user {
      flex-direction: row-reverse;
    }

    .ai-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      flex-shrink: 0;
      background: rgba(31, 111, 120, 0.1);
      color: var(--vericase-teal);
    }

    .ai-message.user .ai-avatar {
      background: rgba(26, 43, 60, 0.1);
      color: var(--vericase-navy);
    }

    .ai-bubble {
      background: var(--gray-100);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 0.8125rem;
      line-height: 1.5;
      max-width: 85%;
    }

    .ai-message.user .ai-bubble {
      background: var(--vericase-teal);
      color: white;
    }

    .ai-input-row {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--gray-100);
      background: var(--gray-50);
    }

    .ai-input-row input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
    }

    .ai-input-row input:focus {
      outline: none;
      border-color: var(--vericase-teal);
    }

    .ai-send-btn {
      padding: 10px 14px;
    }

    /* === PREDICTIVE SIGNALS CARD === */
    .predictive-card {
      background: white;
      border-radius: var(--radius-xl);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .predictive-card-header {
      padding: 14px 16px;
      background: linear-gradient(135deg, rgba(181, 155, 106, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .predictive-card-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .predictive-card-title i {
      color: var(--vericase-gold);
    }

    .predictive-refresh {
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .predictive-refresh:hover {
      background: rgba(181, 155, 106, 0.12);
      color: var(--vericase-gold);
    }

    .predictive-card-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .predictive-filters {
      display: grid;
      gap: 8px;
    }

    .predictive-select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-family: inherit;
      color: var(--text-primary);
      background: white;
    }

    .predictive-actions {
      display: flex;
      gap: 8px;
    }

    .predictive-btn {
      flex: 1;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--gray-200);
      background: white;
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .predictive-btn.primary {
      background: var(--vericase-teal);
      border-color: var(--vericase-teal);
      color: white;
    }

    .predictive-btn:hover {
      border-color: var(--vericase-teal);
      color: var(--vericase-teal-dark);
    }

    .predictive-btn.primary:hover {
      background: var(--vericase-teal-dark);
      color: white;
    }

    .predictive-meta {
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .predictive-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .predictive-section-meta {
      font-size: 0.6875rem;
      text-transform: none;
      color: var(--text-muted);
    }

    .predictive-proactive-list {
      list-style: none;
      display: grid;
      gap: 10px;
      padding: 0;
      margin: 0;
    }

    .predictive-item.proactive {
      border-color: rgba(var(--vericase-teal-rgb), 0.2);
      background: rgba(236, 254, 255, 0.6);
    }

    .predictive-level {
      padding: 2px 6px;
      border-radius: var(--radius-md); /* Professional 6px, not pills */
      font-size: 0.55rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .predictive-level.high {
      background: rgba(220, 38, 38, 0.12);
      color: #dc2626;
    }

    .predictive-level.medium {
      background: rgba(217, 119, 6, 0.12);
      color: #b45309;
    }

    .predictive-level.watch {
      background: rgba(var(--vericase-teal-rgb), 0.12);
      color: var(--vericase-teal);
    }

    .predictive-list {
      list-style: none;
      display: grid;
      gap: 10px;
      padding: 0;
      margin: 0;
    }

    .predictive-item {
      border: 1px solid rgba(181, 155, 106, 0.2);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255, 250, 240, 0.8);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .predictive-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.625rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .predictive-item-lift {
      font-family: var(--font-mono);
      color: var(--vericase-teal);
      font-weight: 600;
    }

    .predictive-item-main {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      color: var(--text-primary);
    }

    .predictive-item-feature {
      font-weight: 600;
    }

    .predictive-item-outcome {
      color: var(--vericase-navy);
      font-weight: 600;
    }

    .predictive-item-meta {
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .predictive-empty {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* === CARD MENU === */
    .card-menu-wrapper {
      position: relative;
    }

    .card-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      min-width: 150px;
      z-index: 100;
      display: none;
    }

    .card-menu.active {
      display: block;
    }

    .card-menu button {
      width: 100%;
      padding: 10px 14px;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8125rem;
      color: var(--text-primary);
      transition: background 0.1s;
    }

    .card-menu button:hover {
      background: var(--gray-50);
    }

    .card-menu button.danger {
      color: #dc2626;
    }

    .card-menu button.danger:hover {
      background: #fef2f2;
    }

    /* === MODALS === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(26, 43, 60, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow-2xl);
      transform: translateY(20px);
      opacity: 1;
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.125rem;
      margin: 0;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.15s;
    }

    .modal-close:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-100);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: var(--gray-50);
      border-radius: 0 0 16px 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .type-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .type-option {
      padding: 14px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
    }

    .type-option:hover {
      border-color: var(--vericase-teal-light);
    }

    .type-option.selected {
      border-color: var(--vericase-teal);
      background: rgba(31, 111, 120, 0.04);
    }

    .type-option i {
      font-size: 1.25rem;
      margin-bottom: 6px;
      display: block;
      color: var(--vericase-navy);
    }

    .type-option.selected i {
      color: var(--vericase-teal);
    }

    .type-option span {
      font-size: 0.875rem;
      font-weight: 600;
    }

    /* Delete Modal */
    .delete-warning {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 14px;
      color: #991b1b;
      font-size: 0.875rem;
    }

    .delete-warning i {
      margin-right: 8px;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
      border: none;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .modal-text-muted {
      color: var(--text-muted);
      font-size: 0.8125rem;
      margin-top: 8px;
    }

    /* Copy Options */
    .copy-options {
      display: grid;
      gap: 8px;
      margin-top: 8px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--vericase-teal);
      cursor: pointer;
    }

    /* === RESPONSIVE === */
    @media (max-width: 720px) {
      .app-content {
        margin: var(--space-3);
        padding: var(--space-4);
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-actions {
        width: 100%;
        justify-content: space-between;
      }

      .workspace-grid {
        grid-template-columns: 1fr;
      }

      .case-stems {
        margin-left: 8px;
        padding-left: 12px;
      }

      .case-card {
        flex-direction: column;
        align-items: flex-start;
      }

      .case-meta {
        margin-left: 0;
      }

      .search-hint {
        display: none;
      }
    }

    /* === CONTROL CENTRE TABS === */
    .control-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--gray-200);
      padding-bottom: 0;
    }

    .control-tab {
      padding: 12px 24px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: -1px;
    }

    .control-tab:hover {
      color: var(--text-primary);
      background: var(--gray-50);
    }

    .control-tab.active {
      color: var(--vericase-teal);
      border-bottom-color: var(--vericase-teal);
      font-weight: 600;
    }

    .control-tab i {
      font-size: 0.8125rem;
    }

    .control-tab .tab-badge {
      background: var(--gray-100);
      color: var(--text-secondary);
      font-size: 0.6875rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: var(--radius-full);
    }

    .control-tab.active .tab-badge {
      background: rgba(31, 111, 120, 0.1);
      color: var(--vericase-teal);
    }

    .tab-badge.urgent {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* === DEADLINES PANEL === */
    .deadlines-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .deadlines-filters {
      display: flex;
      gap: 8px;
    }

    .deadline-filter {
      padding: 6px 12px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid var(--gray-200);
      background: white;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.15s;
    }

    .deadline-filter:hover {
      border-color: var(--gray-300);
    }

    .deadline-filter.active {
      background: var(--vericase-teal);
      color: white;
      border-color: var(--vericase-teal);
    }

    .deadlines-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .deadline-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      transition: all 0.15s;
    }

    .deadline-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--gray-300);
    }

    .deadline-item.overdue {
      border-left: 3px solid var(--error);
    }

    .deadline-item.urgent {
      border-left: 3px solid var(--warning);
    }

    .deadline-item.upcoming {
      border-left: 3px solid var(--vericase-teal);
    }

    .deadline-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 60px;
      padding: 8px 12px;
      background: var(--gray-50);
      border-radius: var(--radius-md);
    }

    .deadline-date .day {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }

    .deadline-date .month {
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .deadline-info {
      flex: 1;
      min-width: 0;
    }

    .deadline-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .deadline-meta {
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .deadline-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .deadline-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .deadline-days {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: var(--radius-full);
    }

    .deadline-days.overdue {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .deadline-days.urgent {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .deadline-days.normal {
      background: var(--gray-100);
      color: var(--text-secondary);
    }

    .deadline-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .deadline-item:hover .deadline-actions {
      opacity: 1;
    }

    .deadline-action-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .deadline-action-btn:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    /* === USERS PANEL === */
    .users-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .users-search {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .users-search-input {
      padding: 8px 14px 8px 36px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      width: 240px;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239CA3AF' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 12px center;
    }

    .users-table {
      width: 100%;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .users-table thead {
      background: var(--gray-50);
    }

    .users-table th {
      padding: 12px 16px;
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    .users-table td {
      padding: 14px 16px;
      font-size: 0.875rem;
      color: var(--text-primary);
      border-bottom: 1px solid var(--gray-100);
    }

    .users-table tr:last-child td {
      border-bottom: none;
    }

    .users-table tr:hover td {
      background: var(--gray-50);
    }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--vericase-navy);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8125rem;
      font-weight: 600;
    }

    .user-details {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .user-email {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: var(--radius-full);
    }

    .role-badge.admin {
      background: rgba(15, 23, 42, 0.1);
      color: var(--vericase-navy);
    }

    .role-badge.power-user {
      background: rgba(31, 111, 120, 0.1);
      color: var(--vericase-teal);
    }

    .role-badge.management {
      background: rgba(181, 155, 106, 0.15);
      color: var(--vericase-gold);
    }

    .role-badge.user {
      background: var(--gray-100);
      color: var(--text-secondary);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: 0.6875rem;
      font-weight: 600;
      border-radius: var(--radius-full);
    }

    .status-badge.active {
      background: rgba(5, 150, 105, 0.1);
      color: var(--success);
    }

    .status-badge.inactive {
      background: var(--gray-100);
      color: var(--text-muted);
    }

    .user-actions-cell {
      display: flex;
      gap: 4px;
    }

    /* === ADD DEADLINE MODAL === */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .modal-close:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      transition: all 0.15s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--vericase-teal);
      box-shadow: 0 0 0 3px rgba(31, 111, 120, 0.1);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }
  </style>
</head>

<body>
  <main id="main-content">
    <!-- Watermarks - Match Control Centre styling -->
    <i class="fas fa-balance-scale watermark watermark-scales"></i>
    <i class="fas fa-gavel watermark watermark-gavel"></i>

    <!-- Compact Dashboard Header -->
    <header class="dashboard-header">
      <div class="dashboard-greeting">
        <div class="greeting-kicker">
          <i class="fas fa-check vericase-tick" aria-hidden="true"></i>
          VeriCase
        </div>
        <h1 class="greeting-title" id="greetingTitle">Master Dashboard</h1>
      </div>
      <div class="stats-bar" id="statsBar">
        <div class="stat-pill projects">
          <i class="fas fa-project-diagram" aria-hidden="true"></i>
          <strong id="statProjects">-</strong> Projects
        </div>
        <div class="stat-pill cases">
          <i class="fas fa-briefcase" aria-hidden="true"></i>
          <strong id="statCases">-</strong> Cases
        </div>
        <div class="stat-pill emails">
          <i class="fas fa-envelope" aria-hidden="true"></i>
          <strong id="statEmails">-</strong> Emails
        </div>
        <div class="stat-pill evidence">
          <i class="fas fa-file-alt" aria-hidden="true"></i>
          <strong id="statEvidence">-</strong> Evidence
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline btn-sm" onclick="loadDashboard()">
          <i class="fas fa-sync-alt" aria-hidden="true"></i> Refresh
        </button>
        <button class="btn btn-vericase" id="createNewBtn">
          <i class="fas fa-plus" aria-hidden="true"></i> New Workspace
        </button>
      </div>
    </header>

    <!-- Control Centre Tabs -->
    <nav class="control-tabs" role="tablist">
      <button class="control-tab active" data-tab="overview" role="tab" aria-selected="true">
        <i class="fas fa-th-large"></i>
        Overview
      </button>
      <button class="control-tab" data-tab="deadlines" role="tab" aria-selected="false">
        <i class="fas fa-calendar-check"></i>
        Deadlines
        <span class="tab-badge" id="deadlinesBadge">0</span>
      </button>
      <button class="control-tab" data-tab="users" role="tab" aria-selected="false" id="usersTab">
        <i class="fas fa-users"></i>
        Users
      </button>
    </nav>

    <!-- Overview Tab Panel -->
    <div class="tab-panel active" id="overviewPanel" role="tabpanel">

    <!-- Search Section -->
    <section class="search-section">
      <div class="search-wrapper">
        <i class="fas fa-search search-icon" aria-hidden="true"></i>
        <input type="text" id="searchInput" class="search-input"
          placeholder="Search workspaces or ask VeriCase Assistant..." />
      </div>
      <div class="search-hint">
        <span class="search-hint-text">Try:</span>
        <button class="search-chip" data-query="NEC4 contracts">
          <i class="fas fa-search" aria-hidden="true"></i> NEC4 contracts
        </button>
        <button class="search-chip" data-query="Delay notices 2024">
          <i class="fas fa-calendar" aria-hidden="true"></i> Delay notices
        </button>
        <button class="search-chip" data-query="Active disputes">
          <i class="fas fa-balance-scale" aria-hidden="true"></i> Active disputes
        </button>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions-section">
      <div class="quick-actions-grid">
        <a href="workspace-setup.html" class="quick-action-card">
          <div class="quick-action-icon" style="background: rgba(31, 111, 120, 0.1); color: var(--vericase-teal);">
            <i class="fas fa-plus"></i>
          </div>
          <div class="quick-action-content">
            <div class="quick-action-title">New Workspace</div>
            <div class="quick-action-desc">Create a workspace for a new matter</div>
          </div>
        </a>
        <a href="#" class="quick-action-card" id="quickUploadBtn">
          <div class="quick-action-icon" style="background: rgba(197, 160, 101, 0.15); color: var(--vericase-gold);">
            <i class="fas fa-upload"></i>
          </div>
          <div class="quick-action-content">
            <div class="quick-action-title">Upload Documents</div>
            <div class="quick-action-desc">Add PST files or evidence</div>
          </div>
        </a>
        <a href="ai-copilot.html" class="quick-action-card">
          <div class="quick-action-icon" style="background: rgba(15, 23, 42, 0.08); color: var(--vericase-navy);">
            <i class="fas fa-robot"></i>
          </div>
          <div class="quick-action-content">
            <div class="quick-action-title">AI Copilot</div>
            <div class="quick-action-desc">Ask questions across all cases</div>
          </div>
        </a>
        <a href="admin-users.html" class="quick-action-card">
          <div class="quick-action-icon" style="background: rgba(120, 113, 108, 0.1); color: #78716C;">
            <i class="fas fa-users-cog"></i>
          </div>
          <div class="quick-action-content">
            <div class="quick-action-title">Manage Team</div>
            <div class="quick-action-desc">Add users and set permissions</div>
          </div>
        </a>
        <a href="admin-approvals.html" class="quick-action-card" id="pendingApprovalsCard" style="display: none;">
          <div class="quick-action-icon" style="background: rgba(245, 158, 11, 0.15); color: #D97706;">
            <i class="fas fa-user-clock"></i>
          </div>
          <div class="quick-action-content">
            <div class="quick-action-title">User Approvals <span id="pendingBadge" class="badge badge-warning" style="margin-left: 6px;">0</span></div>
            <div class="quick-action-desc">Review pending registrations</div>
          </div>
        </a>
      </div>
    </section>

    <!-- Main Layout -->
    <div class="dashboard-layout">
      <!-- Workspaces (Primary Content) - Master-Detail Layout -->
      <section class="workspaces-section">
        <div class="section-header">
          <h2 class="section-title">
            Your Workspaces
            <span class="section-count" id="workspaceCount">0</span>
          </h2>
        </div>
        <div class="workspace-master-detail">
          <!-- Workspace List (Left) -->
          <div class="workspace-list" id="workspaceList">
            <!-- Loading skeleton -->
            <div class="workspace-row" style="pointer-events: none;">
              <div class="skeleton" style="width: 36px; height: 36px; border-radius: 8px;"></div>
              <div style="flex: 1;">
                <div class="skeleton" style="width: 60%; height: 16px; margin-bottom: 6px;"></div>
                <div class="skeleton" style="width: 30%; height: 12px;"></div>
              </div>
              <div class="skeleton" style="width: 60px; height: 20px;"></div>
            </div>
          </div>

          <!-- Workspace Detail Panel (Right) -->
          <div class="workspace-detail-panel" id="workspaceDetailPanel">
            <div class="detail-panel-empty">
              <i class="fas fa-hand-pointer" aria-hidden="true"></i>
              <div>Select a workspace to view details</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Recent Activity Section -->
      <section class="activity-section" id="activitySection">
        <h2 class="section-title">
          <i class="fas fa-clock-rotate-left" aria-hidden="true"></i>
          Recent Activity
        </h2>
        <div class="activity-content" id="activityContent">
          <div class="empty-state">
            <i class="fas fa-history empty-icon"></i>
            <div class="empty-title">No recent activity</div>
          </div>
        </div>
      </section>

      <!-- KPIs and Urgent Items Section -->
      <section class="kpis-section" id="kpisSection">
        <div class="section-row">
          <div class="kpis-column">
            <h2 class="section-title">
              <i class="fas fa-chart-line" aria-hidden="true"></i>
              KPIs
            </h2>
            <div class="kpis-content" id="kpisContent">
              <div class="empty-state">
                <div class="empty-title">No KPIs available</div>
              </div>
            </div>
          </div>
          <div class="urgent-column">
            <h2 class="section-title">
              <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
              Upcoming & Urgent
            </h2>
            <div class="urgent-content" id="urgentContent">
              <div class="empty-state">
                <div class="empty-title">No urgent items</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Sidebar -->
      <aside class="dashboard-sidebar">
        <!-- VeriCase Assistant -->
        <div class="ai-card">
          <div class="ai-card-header">
            <div class="ai-card-title">
              <i class="fas fa-check vericase-tick" aria-hidden="true"></i>
              VeriCase Assistant
            </div>
            <button class="ai-toggle-btn" onclick="toggleAIChat()">Expand</button>
          </div>
          <div class="ai-card-body" id="aiQuickPrompt">
            <textarea class="ai-prompt-input" id="aiQuickInput" rows="2"
              placeholder="Ask anything about your cases..."></textarea>
            <div class="ai-suggestions">
              <button class="ai-suggestion" data-prompt="Find delay notices">Find delay notices</button>
              <button class="ai-suggestion" data-prompt="Summarize active cases">Summarize cases</button>
              <button class="ai-suggestion" data-prompt="Show NEC4 contracts">NEC4 contracts</button>
            </div>
          </div>
          <div class="ai-chat-panel" id="aiChatPanel">
            <div class="ai-chat-messages" id="aiChatMessages">
              <div class="ai-message">
                <div class="ai-avatar"><i class="fas fa-robot" aria-hidden="true"></i></div>
                <div class="ai-bubble">
                  Hi! I can help you search across projects, find evidence, and answer questions about your cases.
                </div>
              </div>
            </div>
            <div class="ai-input-row">
              <input type="text" id="aiChatInput" placeholder="Ask VeriCase..." />
              <button class="btn btn-vericase btn-sm ai-send-btn" onclick="sendAIMessage()">
                <i class="fas fa-paper-plane" aria-hidden="true"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Predictive Signals -->
        <div class="predictive-card">
          <div class="predictive-card-header">
            <div class="predictive-card-title">
              <i class="fas fa-chart-line" aria-hidden="true"></i>
              Predictive Signals
            </div>
            <button class="predictive-refresh" id="predictiveRefresh" title="Refresh">
              <i class="fas fa-sync-alt" aria-hidden="true"></i>
            </button>
          </div>
          <div class="predictive-card-body">
            <div class="predictive-section-header">
              <span>Proactive trends</span>
              <span class="predictive-section-meta" id="proactiveMeta">Loading...</span>
            </div>
            <ul class="predictive-proactive-list" id="proactiveList"></ul>
            <div class="predictive-filters">
              <select id="predictiveThemeFilter" class="predictive-select">
                <option value="">All themes</option>
              </select>
              <select id="predictiveOutcomeFilter" class="predictive-select">
                <option value="">All outcomes</option>
              </select>
              <div class="predictive-actions">
                <button class="predictive-btn primary" id="predictiveApply">
                  Apply
                </button>
                <button class="predictive-btn" id="predictiveClear">
                  Clear
                </button>
              </div>
            </div>
            <div class="predictive-meta" id="predictiveMeta">Loading signals...</div>
            <ul class="predictive-list" id="predictiveList"></ul>
            <div class="predictive-section-header" style="margin-top: 18px;">
              <span>Risk signals</span>
              <span class="predictive-section-meta" id="riskMeta">Loading...</span>
            </div>
            <ul class="predictive-list" id="riskList"></ul>
          </div>
        </div>
      </aside>
    </div>
    </div><!-- End Overview Tab Panel -->

    <!-- Deadlines Tab Panel -->
    <div class="tab-panel" id="deadlinesPanel" role="tabpanel">
      <div class="deadlines-header">
        <div class="deadlines-filters">
          <button class="deadline-filter active" data-filter="all">All</button>
          <button class="deadline-filter" data-filter="overdue">Overdue</button>
          <button class="deadline-filter" data-filter="upcoming">This Week</button>
          <button class="deadline-filter" data-filter="custom">Custom</button>
        </div>
        <button class="btn btn-vericase" id="addDeadlineBtn">
          <i class="fas fa-plus"></i> Add Deadline
        </button>
      </div>
      <div class="deadlines-list" id="deadlinesList">
        <div class="empty-state">
          <i class="fas fa-calendar-check empty-icon"></i>
          <div class="empty-title">No deadlines</div>
          <div class="empty-text">Create your first deadline to start tracking important dates</div>
        </div>
      </div>
    </div><!-- End Deadlines Tab Panel -->

    <!-- Users Tab Panel -->
    <div class="tab-panel" id="usersPanel" role="tabpanel">
      <div class="users-header">
        <div class="users-search">
          <input type="text" class="users-search-input" id="usersSearchInput" placeholder="Search users...">
        </div>
        <button class="btn btn-vericase" id="inviteUserBtn" style="display: none;">
          <i class="fas fa-user-plus"></i> Invite User
        </button>
      </div>
      <table class="users-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Status</th>
            <th>Last Active</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr>
            <td colspan="5" class="empty-state" style="text-align: center; padding: 40px;">
              <i class="fas fa-users empty-icon"></i>
              <div class="empty-title">Loading users...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div><!-- End Users Tab Panel -->

  </main>

  <!-- Add Deadline Modal -->
  <div class="modal-overlay" id="deadlineModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add Deadline</h3>
        <button class="modal-close" id="deadlineModalClose">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="deadlineForm">
          <div class="form-group">
            <label class="form-label">Title *</label>
            <input type="text" class="form-input" id="deadlineTitle" required placeholder="e.g., Submit response to claim">
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="deadlineDescription" placeholder="Optional details..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Due Date *</label>
              <input type="datetime-local" class="form-input" id="deadlineDueDate" required>
            </div>
            <div class="form-group">
              <label class="form-label">Priority</label>
              <select class="form-select" id="deadlinePriority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Type</label>
              <select class="form-select" id="deadlineType">
                <option value="task">Task</option>
                <option value="reminder">Reminder</option>
                <option value="milestone">Milestone</option>
                <option value="court_date">Court Date</option>
                <option value="filing">Filing Deadline</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Workspace</label>
              <select class="form-select" id="deadlineWorkspace">
                <option value="">None</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" id="cancelDeadlineBtn">Cancel</button>
        <button type="submit" class="btn btn-vericase" id="saveDeadlineBtn">Save Deadline</button>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="modal-overlay" id="createModal" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <h2>Create New Workspace</h2>
        <button class="modal-close" id="modalClose"><i class="fas fa-times" aria-hidden="true"></i></button>
      </div>
      <div class="modal-body">
        <!-- Workspace creation - no type selector needed -->
        <form id="createForm">
          <div class="form-group">
            <label for="itemName" class="form-label">Name *</label>
            <input type="text" id="itemName" class="input" required placeholder="Enter name..." />
          </div>
          <div class="form-group" id="codeGroup">
            <label for="itemCode" class="form-label">Workspace Code *</label>
            <input type="text" id="itemCode" class="input" placeholder="e.g., WEL-2024-001" />
          </div>
          <div class="form-group">
            <label for="itemDescription" class="form-label">Description</label>
            <textarea id="itemDescription" class="input" rows="2" placeholder="Brief description..."></textarea>
          </div>
          <div class="form-group">
            <label for="contractType" class="form-label">Contract Type</label>
            <select id="contractType" class="input">
              <option value="">Select contract type...</option>
              <option value="JCT">JCT</option>
              <option value="NEC">NEC</option>
              <option value="FIDIC">FIDIC</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelCreate">Cancel</button>
        <button class="btn btn-vericase" id="confirmCreate">
          <i class="fas fa-plus" aria-hidden="true"></i> Create
        </button>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div class="modal-overlay" id="renameModal" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <h2>Rename Workspace</h2>
        <button class="modal-close" onclick="closeRenameModal()"><i class="fas fa-times" aria-hidden="true"></i></button>
      </div>
      <div class="modal-body">
        <form id="renameForm">
          <input type="hidden" id="renameItemId" />
          <input type="hidden" id="renameItemType" />
          <div class="form-group">
            <label for="renameItemName" class="form-label">Name *</label>
            <input type="text" id="renameItemName" class="input" required placeholder="Enter new name..." />
          </div>
          <div class="form-group">
            <label for="renameItemCode" class="form-label">Code</label>
            <input type="text" id="renameItemCode" class="input" placeholder="Code..." />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeRenameModal()">Cancel</button>
        <button class="btn btn-vericase" id="confirmRename">
          <i class="fas fa-save" aria-hidden="true"></i> Save
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" id="deleteModal" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <h2>Delete Workspace</h2>
        <button class="modal-close" onclick="closeDeleteModal()"><i class="fas fa-times" aria-hidden="true"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="deleteItemId" />
        <input type="hidden" id="deleteItemType" />
        <div class="delete-warning">
          <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
          <strong>Warning:</strong> This cannot be undone!
        </div>
        <p>Delete <strong id="deleteItemName"></strong>?</p>
        <p class="modal-text-muted">All emails, attachments, and evidence will be permanently deleted.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" id="confirmDelete">
          <i class="fas fa-trash" aria-hidden="true"></i> Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Develop Case Modal -->
  <div class="modal-overlay" id="developCaseModal" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <h2>Develop Case from Project</h2>
        <button class="modal-close" onclick="closeDevelopCaseModal()"><i class="fas fa-times" aria-hidden="true"></i></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="developCaseProjectId" />
        <p class="modal-text-muted" id="developCaseProjectLabel"></p>
        <div class="form-group">
          <label for="developCaseName" class="form-label">Case Name *</label>
          <input type="text" id="developCaseName" class="input" required placeholder="Enter case name..." />
        </div>
        <div class="form-group">
          <label for="developCaseNumber" class="form-label">Case Number</label>
          <input type="text" id="developCaseNumber" class="input" placeholder="Leave blank to auto-generate" />
        </div>
        <div class="form-group">
          <label for="developCaseDescription" class="form-label">Description</label>
          <textarea id="developCaseDescription" class="input" rows="2" placeholder="Brief description..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Include from project</label>
          <div class="copy-options">
            <label class="checkbox-row">
              <input type="checkbox" id="developIncludeStakeholders" checked /> Stakeholders
            </label>
            <label class="checkbox-row">
              <input type="checkbox" id="developIncludeKeywords" checked /> Keywords
            </label>
            <label class="checkbox-row">
              <input type="checkbox" id="developIncludeClaims" checked /> Heads of claim
            </label>
            <label class="checkbox-row">
              <input type="checkbox" id="developIncludeMatters" checked /> Contentious matters
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeDevelopCaseModal()">Cancel</button>
        <button class="btn btn-vericase" id="confirmDevelopCase">
          <i class="fas fa-briefcase" aria-hidden="true"></i> Develop Case
        </button>
      </div>
    </div>
  </div>

  <script>
    // Initialize Shell
    document.addEventListener("DOMContentLoaded", () => {
      VericaseShell.inject({
        title: "Master Dashboard",
        breadcrumbs: [
          { label: "Control Centre", url: "control-centre.html" }
        ],
        headerActions: ""
      });

      updateQuickActions();
      loadDashboard();
      setupEventListeners();
      setupPredictiveControls();
      loadPredictiveSignals({ populateOptions: true });
      checkPendingApprovals();
    });

    let dashboardData = null;
    let searchQuery = "";
    let selectedType = "project";
    let predictiveOptions = { themes: [], outcomes: [] };
    let predictiveFilters = { theme: "", outcome: "" };
    let currentUserRole = "USER";
    let currentUserPermissions = {};

    // ===========================================
    // CONTROL CENTRE - Tab Management
    // ===========================================

    function initControlCentreTabs() {
      const tabs = document.querySelectorAll('.control-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });

      // Load deadlines count for badge
      loadDeadlinesBadge();
    }

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.control-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
        tab.setAttribute('aria-selected', tab.dataset.tab === tabName);
      });

      // Update tab panels
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `${tabName}Panel`);
      });

      // Load data for the selected tab
      if (tabName === 'deadlines') {
        loadDeadlines();
      } else if (tabName === 'users') {
        loadUsers();
      }
    }

    async function loadDeadlinesBadge() {
      try {
        const headers = getAuthHeaders();
        const response = await fetch('/api/dashboard/deadlines?include_completed=false', { headers });
        if (response.ok) {
          const data = await response.json();
          const badge = document.getElementById('deadlinesBadge');
          if (badge) {
            badge.textContent = data.total_count;
            if (data.overdue_count > 0) {
              badge.classList.add('urgent');
              badge.textContent = data.overdue_count;
            }
          }
        }
      } catch (e) {
        console.warn('Failed to load deadlines badge', e);
      }
    }

    // ===========================================
    // CONTROL CENTRE - Deadlines Management
    // ===========================================

    let deadlinesData = [];
    let deadlineFilter = 'all';

    async function loadDeadlines() {
      const container = document.getElementById('deadlinesList');
      container.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin empty-icon"></i><div class="empty-title">Loading deadlines...</div></div>';

      try {
        const headers = getAuthHeaders();
        const response = await fetch('/api/dashboard/deadlines?include_completed=false', { headers });
        if (!response.ok) throw new Error('Failed to load deadlines');

        const data = await response.json();
        deadlinesData = data.deadlines;
        renderDeadlines();
      } catch (e) {
        console.error('Error loading deadlines:', e);
        container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle empty-icon"></i><div class="empty-title">Failed to load deadlines</div></div>';
      }
    }

    function renderDeadlines() {
      const container = document.getElementById('deadlinesList');
      let filtered = deadlinesData;

      // Apply filter
      if (deadlineFilter === 'overdue') {
        filtered = deadlinesData.filter(d => d.days_remaining < 0);
      } else if (deadlineFilter === 'upcoming') {
        filtered = deadlinesData.filter(d => d.days_remaining >= 0 && d.days_remaining <= 7);
      } else if (deadlineFilter === 'custom') {
        filtered = deadlinesData.filter(d => d.source_type === 'custom');
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-check empty-icon"></i><div class="empty-title">No deadlines</div><div class="empty-text">No deadlines match your current filter</div></div>';
        return;
      }

      container.innerHTML = filtered.map(d => {
        const dueDate = new Date(d.due_date);
        const day = dueDate.getDate();
        const month = dueDate.toLocaleString('default', { month: 'short' });
        const urgencyClass = d.days_remaining < 0 ? 'overdue' : d.days_remaining <= 7 ? 'urgent' : 'upcoming';
        const daysText = d.days_remaining < 0
          ? `${Math.abs(d.days_remaining)} days overdue`
          : d.days_remaining === 0
            ? 'Due today'
            : `${d.days_remaining} days`;

        return `
          <div class="deadline-item ${urgencyClass}">
            <div class="deadline-date">
              <span class="day">${day}</span>
              <span class="month">${month}</span>
            </div>
            <div class="deadline-info">
              <div class="deadline-title">${escapeHtml(d.title)}</div>
              <div class="deadline-meta">
                <span><i class="fas fa-tag"></i> ${d.source_type}</span>
                <span><i class="fas fa-folder"></i> ${escapeHtml(d.source_name)}</span>
                ${d.priority !== 'medium' ? `<span><i class="fas fa-flag"></i> ${d.priority}</span>` : ''}
              </div>
            </div>
            <div class="deadline-status">
              <span class="deadline-days ${urgencyClass}">${daysText}</span>
            </div>
            ${d.can_edit ? `
              <div class="deadline-actions">
                <button class="deadline-action-btn" onclick="editDeadline('${d.id}')" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="deadline-action-btn" onclick="completeDeadline('${d.id}')" title="Mark Complete">
                  <i class="fas fa-check"></i>
                </button>
                <button class="deadline-action-btn" onclick="deleteDeadline('${d.id}')" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function setupDeadlineFilters() {
      document.querySelectorAll('.deadline-filter').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.deadline-filter').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          deadlineFilter = btn.dataset.filter;
          renderDeadlines();
        });
      });
    }

    function setupDeadlineModal() {
      const modal = document.getElementById('deadlineModal');
      const addBtn = document.getElementById('addDeadlineBtn');
      const closeBtn = document.getElementById('deadlineModalClose');
      const cancelBtn = document.getElementById('cancelDeadlineBtn');
      const saveBtn = document.getElementById('saveDeadlineBtn');

      addBtn?.addEventListener('click', () => {
        document.getElementById('deadlineForm').reset();
        modal.classList.add('active');
        populateWorkspaceSelect();
      });

      closeBtn?.addEventListener('click', () => modal.classList.remove('active'));
      cancelBtn?.addEventListener('click', () => modal.classList.remove('active'));

      saveBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        await saveDeadline();
      });

      modal?.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('active');
      });
    }

    async function populateWorkspaceSelect() {
      try {
        const headers = getAuthHeaders();
        const response = await fetch('/api/workspaces', { headers });
        if (response.ok) {
          const workspaces = await response.json();
          const select = document.getElementById('deadlineWorkspace');
          select.innerHTML = '<option value="">None</option>' +
            workspaces.map(w => `<option value="${w.id}">${escapeHtml(w.name)}</option>`).join('');
        }
      } catch (e) {
        console.warn('Failed to load workspaces for select', e);
      }
    }

    async function saveDeadline() {
      const title = document.getElementById('deadlineTitle').value.trim();
      const description = document.getElementById('deadlineDescription').value.trim();
      const dueDate = document.getElementById('deadlineDueDate').value;
      const priority = document.getElementById('deadlinePriority').value;
      const deadlineType = document.getElementById('deadlineType').value;
      const workspaceId = document.getElementById('deadlineWorkspace').value || null;

      if (!title || !dueDate) {
        alert('Please fill in required fields');
        return;
      }

      try {
        const headers = { ...getAuthHeaders(), 'Content-Type': 'application/json' };
        const response = await fetch('/api/dashboard/deadlines', {
          method: 'POST',
          headers,
          body: JSON.stringify({
            title,
            description: description || null,
            due_date: new Date(dueDate).toISOString(),
            priority,
            deadline_type: deadlineType,
            workspace_id: workspaceId
          })
        });

        if (!response.ok) throw new Error('Failed to create deadline');

        document.getElementById('deadlineModal').classList.remove('active');
        loadDeadlines();
        loadDeadlinesBadge();
      } catch (e) {
        console.error('Error creating deadline:', e);
        alert('Failed to create deadline');
      }
    }

    async function completeDeadline(id) {
      if (!confirm('Mark this deadline as completed?')) return;

      try {
        const headers = { ...getAuthHeaders(), 'Content-Type': 'application/json' };
        await fetch(`/api/dashboard/deadlines/${id}`, {
          method: 'PATCH',
          headers,
          body: JSON.stringify({ status: 'completed' })
        });
        loadDeadlines();
        loadDeadlinesBadge();
      } catch (e) {
        console.error('Error completing deadline:', e);
      }
    }

    async function deleteDeadline(id) {
      if (!confirm('Delete this deadline?')) return;

      try {
        const headers = getAuthHeaders();
        await fetch(`/api/dashboard/deadlines/${id}`, {
          method: 'DELETE',
          headers
        });
        loadDeadlines();
        loadDeadlinesBadge();
      } catch (e) {
        console.error('Error deleting deadline:', e);
      }
    }

    function editDeadline(id) {
      // For now, just open the modal - full edit would require storing deadline data
      alert('Edit functionality coming soon. For now, delete and recreate.');
    }

    // ===========================================
    // CONTROL CENTRE - Users Management
    // ===========================================

    let usersData = [];

    async function loadUsers() {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin empty-icon"></i><div class="empty-title">Loading users...</div></td></tr>';

      try {
        const headers = getAuthHeaders();
        const response = await fetch('/api/users', { headers });

        if (response.status === 403) {
          // Non-admin - show limited view
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="text-align: center; padding: 40px;"><i class="fas fa-lock empty-icon"></i><div class="empty-title">User management requires admin access</div></td></tr>';
          return;
        }

        if (!response.ok) throw new Error('Failed to load users');

        usersData = await response.json();
        renderUsers();

        // Show invite button for admins
        if (currentUserPermissions.can_manage_users) {
          document.getElementById('inviteUserBtn').style.display = 'block';
        }
      } catch (e) {
        console.error('Error loading users:', e);
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="text-align: center; padding: 40px;"><i class="fas fa-exclamation-triangle empty-icon"></i><div class="empty-title">Failed to load users</div></td></tr>';
      }
    }

    function renderUsers() {
      const tbody = document.getElementById('usersTableBody');
      const searchTerm = document.getElementById('usersSearchInput')?.value.toLowerCase() || '';

      let filtered = usersData;
      if (searchTerm) {
        filtered = usersData.filter(u =>
          u.email.toLowerCase().includes(searchTerm) ||
          (u.display_name && u.display_name.toLowerCase().includes(searchTerm))
        );
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="text-align: center; padding: 40px;"><i class="fas fa-users empty-icon"></i><div class="empty-title">No users found</div></td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(u => {
        const initials = (u.display_name || u.email).split(/[@\s]/).map(p => p[0]?.toUpperCase()).join('').slice(0, 2);
        const roleClass = u.role === 'ADMIN' ? 'admin' : u.role === 'POWER_USER' ? 'power-user' : u.role === 'MANAGEMENT_USER' ? 'management' : 'user';
        const roleLabel = u.role === 'ADMIN' ? 'Admin' : u.role === 'POWER_USER' ? 'Power User' : u.role === 'MANAGEMENT_USER' ? 'Management' : 'User';
        const lastActive = u.last_login_at ? new Date(u.last_login_at).toLocaleDateString() : 'Never';

        return `
          <tr>
            <td>
              <div class="user-cell">
                <div class="user-avatar">${initials}</div>
                <div class="user-details">
                  <span class="user-name">${escapeHtml(u.display_name || u.email.split('@')[0])}</span>
                  <span class="user-email">${escapeHtml(u.email)}</span>
                </div>
              </div>
            </td>
            <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
            <td><span class="status-badge ${u.is_active ? 'active' : 'inactive'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
            <td>${lastActive}</td>
            <td class="user-actions-cell">
              ${currentUserPermissions.can_access_admin ? `
                <button class="deadline-action-btn" onclick="toggleUserStatus('${u.id}', ${!u.is_active})" title="${u.is_active ? 'Deactivate' : 'Activate'}">
                  <i class="fas fa-${u.is_active ? 'user-slash' : 'user-check'}"></i>
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    function setupUsersSearch() {
      document.getElementById('usersSearchInput')?.addEventListener('input', renderUsers);
    }

    async function toggleUserStatus(userId, activate) {
      try {
        const headers = { ...getAuthHeaders(), 'Content-Type': 'application/json' };
        await fetch(`/api/users/${userId}`, {
          method: 'PATCH',
          headers,
          body: JSON.stringify({ is_active: activate })
        });
        loadUsers();
      } catch (e) {
        console.error('Error updating user:', e);
        alert('Failed to update user');
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Initialize Control Centre features
    document.addEventListener('DOMContentLoaded', () => {
      initControlCentreTabs();
      setupDeadlineFilters();
      setupDeadlineModal();
      setupUsersSearch();
    });

    function getAuthHeaders() {
      const token = localStorage.getItem("vericase_token") || localStorage.getItem("token") || localStorage.getItem("jwt");
      return token ? { Authorization: `Bearer ${token}` } : {};
    }

    function getContextSummary() {
      const projectId = localStorage.getItem("vericase_current_project") || localStorage.getItem("currentProjectId");
      const caseId = localStorage.getItem("currentCaseId") || localStorage.getItem("caseId");
      const profileType = localStorage.getItem("profileType");

      if (profileType === "case" && caseId) {
        const name = localStorage.getItem("currentCaseName") || localStorage.getItem("vericase_current_case_name");
        return { hasContext: true, type: "case", name: name || "Selected case", id: caseId };
      }

      if (projectId) {
        const name = localStorage.getItem("currentProjectName") || localStorage.getItem("vericase_current_project_name");
        return { hasContext: true, type: "project", name: name || "Selected project", id: projectId };
      }

      return { hasContext: false, type: "", name: "", id: "" };
    }

    function updateQuickActions() {
      // Quick Start panel removed - function kept for compatibility
    }

    async function checkPendingApprovals() {
      // Only check for admins
      try {
        const headers = getAuthHeaders();
        const response = await fetch("/api/admin/users/pending", { headers });
        if (response.ok) {
          const pendingUsers = await response.json();
          const card = document.getElementById("pendingApprovalsCard");
          const badge = document.getElementById("pendingBadge");
          if (pendingUsers.length > 0 && card) {
            card.style.display = "flex";
            if (badge) badge.textContent = pendingUsers.length;
          }
        }
      } catch (e) {
        // Silently fail - user likely not admin
        console.debug("Pending approvals check skipped (likely not admin)");
      }
    }

    async function loadDashboard() {
      try {
        const headers = getAuthHeaders();
        let workspacesData = [];
        let statsData = null;

        // Fetch current user info for permissions
        try {
          const userResponse = await fetch("/api/users/me", { headers });
          if (userResponse.ok) {
            const userData = await userResponse.json();
            currentUserRole = userData.role;
            // Set permissions based on role
            currentUserPermissions = {
              can_create_workspace: ['ADMIN', 'POWER_USER'].includes(userData.role),
              can_create_project: ['ADMIN', 'POWER_USER'].includes(userData.role),
              can_create_case: ['ADMIN', 'POWER_USER'].includes(userData.role),
              can_manage_users: ['ADMIN', 'MANAGEMENT_USER'].includes(userData.role),
              can_manage_deadlines: ['ADMIN', 'POWER_USER', 'MANAGEMENT_USER'].includes(userData.role),
              can_access_admin: userData.role === 'ADMIN',
            };
            // Update UI based on permissions
            if (!currentUserPermissions.can_manage_deadlines) {
              document.getElementById('addDeadlineBtn')?.style.setProperty('display', 'none');
            }
            // Update greeting
            if (userData.display_name) {
              document.getElementById("greetingTitle").textContent = `Welcome back, ${userData.display_name}`;
            }
          }
        } catch (e) {
          console.warn("Failed to load user info", e);
        }

        // Try to get workspaces
        try {
          const workspacesResponse = await fetch("/api/workspaces", { headers });
          if (workspacesResponse.ok) {
            workspacesData = await workspacesResponse.json();
            // Calculate stats from workspaces
            statsData = {
              total_projects: workspacesData.reduce((sum, ws) => sum + (ws.project_count || 0), 0),
              total_cases: workspacesData.reduce((sum, ws) => sum + (ws.case_count || 0), 0),
              total_emails: workspacesData.reduce((sum, ws) => sum + (ws.email_count || 0), 0),
              total_evidence: workspacesData.reduce((sum, ws) => sum + (ws.evidence_count || 0), 0),
            };
          }
        } catch (e) {
          console.warn("Failed to load workspaces, trying fallback", e);
        }
        
        // Fallback: try dashboard overview for backward compatibility
        if (workspacesData.length === 0) {
          let response = await fetch("/api/dashboard/overview", { headers });
          if (!response.ok) {
            response = await fetch("/api/dashboard/overview/public");
          }
          if (response.ok) {
            dashboardData = await response.json();
            statsData = dashboardData.stats;
            
            if (dashboardData.user?.display_name) {
              document.getElementById("greetingTitle").textContent = `Welcome back, ${dashboardData.user.display_name}`;
            }
            
            // Convert old format to workspace format
            const projects = (dashboardData.work_items || []).filter(w => w.type === "project");
            const cases = (dashboardData.work_items || []).filter(w => w.type === "case");
            
            // Group by workspace (create default workspaces for existing projects)
            const workspaceMap = new Map();
            projects.forEach(p => {
              const wsId = p.id; // Use project ID as temp workspace ID
              if (!workspaceMap.has(wsId)) {
                workspaceMap.set(wsId, {
                  id: wsId,
                  name: p.name,
                  code: p.project_code || p.id.substring(0, 8).toUpperCase(),
                  description: p.description,
                  contract_type: p.contract_type,
                  status: p.status || "active",
                  project_count: 1,
                  case_count: 0,
                  email_count: p.email_count || 0,
                  evidence_count: p.evidence_count || 0,
                  projects: [p],
                  cases: []
                });
              } else {
                workspaceMap.get(wsId).projects.push(p);
                workspaceMap.get(wsId).project_count++;
              }
            });
            
            cases.forEach(c => {
              if (c.project_id && workspaceMap.has(c.project_id)) {
                workspaceMap.get(c.project_id).cases.push(c);
                workspaceMap.get(c.project_id).case_count++;
              } else {
                // Orphan case - create temporary workspace
                const wsId = `case-${c.id}`;
                workspaceMap.set(wsId, {
                  id: wsId,
                  name: c.name + " (Case)",
                  code: c.case_number || c.id.substring(0, 8).toUpperCase(),
                  description: c.description,
                  contract_type: c.contract_type,
                  status: c.status || "active",
                  project_count: 0,
                  case_count: 1,
                  email_count: c.email_count || 0,
                  evidence_count: c.evidence_count || 0,
                  projects: [],
                  cases: [c]
                });
              }
            });
            
            workspacesData = Array.from(workspaceMap.values());
          }
        }
        
        // Store workspaces data globally
        window.workspacesData = workspacesData;
        
        // Render stats
        if (statsData) {
          renderStats(statsData);
        } else {
          // Calculate from workspaces
          renderStats({
            total_projects: workspacesData.reduce((sum, ws) => sum + (ws.project_count || 0), 0),
            total_cases: workspacesData.reduce((sum, ws) => sum + (ws.case_count || 0), 0),
            total_emails: workspacesData.reduce((sum, ws) => sum + (ws.email_count || 0), 0),
            total_evidence: workspacesData.reduce((sum, ws) => sum + (ws.evidence_count || 0), 0),
          });
        }
        
        renderWorkspaces(workspacesData);
        console.log("[FLOW] MasterDashboard loaded:", workspacesData.length, "workspaces, context:", getContextSummary());
        
        // Activity and KPIs sections are always visible
        // Data will be populated when backend APIs are ready
      } catch (error) {
        console.error("Dashboard load failed", error);
        document.getElementById("workspaceGrid").innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle empty-icon"></i>
            <div class="empty-title">Unable to load dashboard</div>
            <button class="btn btn-vericase" onclick="loadDashboard()">Retry</button>
          </div>
        `;
      }
    }

    function renderStats(stats) {
      // Calculate totals from workspaces
      const totals = (window.workspacesData || []).reduce((acc, ws) => {
        acc.projects += ws.project_count || 0;
        acc.cases += ws.case_count || 0;
        acc.emails += ws.email_count || 0;
        acc.evidence += ws.evidence_count || 0;
        return acc;
      }, { projects: 0, cases: 0, emails: 0, evidence: 0 });

      document.getElementById("statProjects").textContent = totals.projects || stats?.total_projects || 0;
      document.getElementById("statCases").textContent = totals.cases || stats?.total_cases || 0;
      document.getElementById("statEmails").textContent = formatCount(totals.emails || stats?.total_emails || 0);
      document.getElementById("statEvidence").textContent = formatCount(totals.evidence || stats?.total_evidence || 0);
    }

    function getItemTimestamp(item) {
      const raw = item.updated_at || item.created_at || "";
      const ts = Date.parse(raw);
      return Number.isFinite(ts) ? ts : 0;
    }

    function matchesWorkspace(item, query) {
      if (!query) return true;
      const haystack = [
        item.name,
        item.description,
        item.project_code,
        item.case_number,
        item.contract_type,
        item.project_name,
      ]
        .filter(Boolean)
        .join(" ")
        .toLowerCase();
      return haystack.includes(query);
    }

    function renderCaseRow(item, options = {}) {
      const showProjectTag = options.showProjectTag === true;
      let projectTag = "";
      if (showProjectTag) {
        const label = item.project_name
          ? `Linked to ${escapeHtml(item.project_name)}`
          : item.project_id
            ? "Linked project unavailable"
            : "No linked project";
        projectTag = `<div class="case-project-tag">${label}</div>`;
      }

      return `
        <div class="case-stem">
          <button class="case-card" type="button" onclick="openWorkspace('${item.id}', 'case')">
            <div class="case-card-content">
              <div class="case-title">${escapeHtml(item.name)}</div>
              ${item.case_number ? `<div class="case-code">${escapeHtml(item.case_number)}</div>` : ""}
              ${projectTag}
            </div>
            <div class="case-meta">
              <span><i class="fas fa-envelope" aria-hidden="true"></i> ${formatCount(item.email_count || 0)}</span>
              <span><i class="fas fa-file-alt" aria-hidden="true"></i> ${formatCount(item.evidence_count || 0)}</span>
            </div>
          </button>
          <div class="card-menu-wrapper">
            <button class="case-menu-btn" onclick="event.stopPropagation(); toggleMenu('${item.id}')" title="More actions">
              <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
            </button>
            <div class="card-menu" id="menu-${item.id}">
              <button onclick="event.stopPropagation(); openRenameModal('${item.id}', '${escapeHtml(item.name)}', '${escapeHtml(item.case_number || '')}', 'case')">
                <i class="fas fa-edit" aria-hidden="true"></i> Rename
              </button>
              <button class="danger" onclick="event.stopPropagation(); openDeleteModal('${item.id}', '${escapeHtml(item.name)}', 'case')">
                <i class="fas fa-trash" aria-hidden="true"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Track selected workspace for detail panel
    let selectedWorkspaceId = null;

    function renderWorkspaceRow(workspace) {
      const isSelected = selectedWorkspaceId === workspace.id;
      const projectCount = (workspace.projects || []).length || workspace.project_count || 0;
      const caseCount = (workspace.cases || []).length || workspace.case_count || 0;

      return `
        <div class="workspace-row ${isSelected ? 'selected' : ''}"
             data-id="${workspace.id}"
             onclick="selectWorkspace('${workspace.id}')"
             ondblclick="enterWorkspace('${workspace.id}')">
          <div class="workspace-icon project">
            <i class="fas fa-building" aria-hidden="true"></i>
          </div>
          <div class="workspace-info">
            <div class="workspace-title">${escapeHtml(workspace.name)}</div>
            <div class="workspace-code">${escapeHtml(workspace.code || '')}</div>
          </div>
          <div class="workspace-stats">
            <div class="workspace-stat"><i class="fas fa-folder" aria-hidden="true"></i> ${projectCount}</div>
            <div class="workspace-stat"><i class="fas fa-briefcase" aria-hidden="true"></i> ${caseCount}</div>
            <div class="workspace-stat"><i class="fas fa-envelope" aria-hidden="true"></i> ${formatCount(workspace.email_count || 0)}</div>
          </div>
          <span class="workspace-status">${workspace.status || 'Active'}</span>
          <div class="card-menu-wrapper">
            <button class="workspace-menu-btn" onclick="event.stopPropagation(); toggleMenu('${workspace.id}')" title="More actions">
              <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
            </button>
            <div class="card-menu" id="menu-${workspace.id}">
              <button onclick="event.stopPropagation(); enterWorkspace('${workspace.id}')">
                <i class="fas fa-arrow-right" aria-hidden="true"></i> Enter Workspace
              </button>
              <button onclick="event.stopPropagation(); openWorkspaceHub('${workspace.id}')">
                <i class="fas fa-th-large" aria-hidden="true"></i> Open Hub
              </button>
              <button onclick="event.stopPropagation(); openWorkspaceConfig('${workspace.id}')">
                <i class="fas fa-cog" aria-hidden="true"></i> Configure
              </button>
              <button onclick="event.stopPropagation(); openRenameWorkspaceModal('${workspace.id}', '${escapeHtml(workspace.name)}', '${escapeHtml(workspace.code || '')}')">
                <i class="fas fa-edit" aria-hidden="true"></i> Rename
              </button>
              <button class="danger" onclick="event.stopPropagation(); openDeleteWorkspaceModal('${workspace.id}', '${escapeHtml(workspace.name)}')">
                <i class="fas fa-trash" aria-hidden="true"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function selectWorkspace(workspaceId) {
      selectedWorkspaceId = workspaceId;
      const workspace = (window.workspacesData || []).find(ws => ws.id === workspaceId);

      // Update row selection UI
      document.querySelectorAll('.workspace-row').forEach(row => {
        row.classList.toggle('selected', row.dataset.id === workspaceId);
      });

      // Set context for sidebar quick actions
      if (workspace) {
        // Store workspace context - use "project" type so actions unlock
        localStorage.setItem("currentProjectId", workspaceId);
        localStorage.setItem("currentProjectName", workspace.name);
        localStorage.setItem("vericase_current_project_id", workspaceId);
        localStorage.setItem("vericase_current_project_name", workspace.name);
      }

      // Update sidebar quick actions
      if (typeof updateQuickActions === 'function') {
        updateQuickActions();
      }

      // Render detail panel
      renderWorkspaceDetail(workspaceId);
    }

    function renderWorkspaceDetail(workspaceId) {
      const panel = document.getElementById('workspaceDetailPanel');
      const workspace = (window.workspacesData || []).find(ws => ws.id === workspaceId);

      if (!workspace) {
        panel.innerHTML = `
          <div class="detail-panel-empty">
            <i class="fas fa-hand-pointer" aria-hidden="true"></i>
            <div>Select a workspace to view details</div>
          </div>
        `;
        return;
      }

      const projects = workspace.projects || [];
      const cases = workspace.cases || [];
      const users = workspace.users || [];

      panel.innerHTML = `
        <div class="detail-panel-header">
          <div class="detail-panel-title">${escapeHtml(workspace.name)}</div>
          <div class="detail-panel-actions">
            <button class="detail-panel-btn primary" onclick="enterWorkspace('${workspace.id}')">
              <i class="fas fa-arrow-right"></i> Enter
            </button>
            <button class="detail-panel-btn" onclick="openWorkspaceConfig('${workspace.id}')">
              <i class="fas fa-cog"></i>
            </button>
          </div>
        </div>
        <div class="detail-panel-body">
          <!-- Description -->
          ${workspace.description ? `
            <div class="detail-section">
              <div class="detail-section-header">
                <span class="detail-section-title">Description</span>
              </div>
              <p class="detail-description">${escapeHtml(workspace.description)}</p>
            </div>
          ` : ''}

          <!-- Projects -->
          <div class="detail-section">
            <div class="detail-section-header">
              <span class="detail-section-title">Projects</span>
              <span class="detail-section-count">${projects.length}</span>
            </div>
            ${projects.length > 0 ? `
              <div class="detail-project-list">
                ${projects.map(p => {
                  const projectId = p.id || p.project_id;
                  const projectName = p.name || p.project_name;
                  const projectCode = p.code || p.project_code;
                  return `
                    <div class="detail-project-item" onclick="openWorkspace('${projectId}', 'project')">
                      <div class="detail-project-icon">
                        <i class="fas fa-folder"></i>
                      </div>
                      <div class="detail-project-info">
                        <div class="detail-project-name">${escapeHtml(projectName)}</div>
                        ${projectCode ? `<div class="detail-project-code">${escapeHtml(projectCode)}</div>` : ''}
                      </div>
                      <div class="detail-project-stats">
                        <span><i class="fas fa-envelope"></i>${formatCount(p.email_count || 0)}</span>
                        <span><i class="fas fa-file-alt"></i>${formatCount(p.evidence_count || 0)}</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `<div style="color: var(--text-muted); font-size: 0.8125rem;">No projects yet</div>`}
          </div>

          <!-- Cases -->
          <div class="detail-section">
            <div class="detail-section-header">
              <span class="detail-section-title">Cases</span>
              <span class="detail-section-count">${cases.length}</span>
            </div>
            ${cases.length > 0 ? `
              <div class="detail-project-list">
                ${cases.map(c => {
                  const caseId = c.id || c.case_id;
                  const caseName = c.name || c.case_name;
                  const caseCode = c.code || c.case_number;
                  return `
                    <div class="detail-project-item" onclick="openWorkspace('${caseId}', 'case')">
                      <div class="detail-project-icon" style="background: rgba(181, 155, 106, 0.15); color: var(--vericase-gold);">
                        <i class="fas fa-briefcase"></i>
                      </div>
                      <div class="detail-project-info">
                        <div class="detail-project-name">${escapeHtml(caseName)}</div>
                        ${caseCode ? `<div class="detail-project-code">${escapeHtml(caseCode)}</div>` : ''}
                      </div>
                      <div class="detail-project-stats">
                        <span><i class="fas fa-envelope"></i>${formatCount(c.email_count || 0)}</span>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `<div style="color: var(--text-muted); font-size: 0.8125rem;">No cases yet</div>`}
          </div>

          <!-- Users -->
          <div class="detail-section">
            <div class="detail-section-header">
              <span class="detail-section-title">Team Members</span>
              <span class="detail-section-count">${users.length}</span>
            </div>
            ${users.length > 0 ? `
              <div class="detail-user-list">
                ${users.map(u => {
                  const initials = (u.name || u.email || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                  return `
                    <div class="detail-user-item">
                      <div class="detail-user-avatar">${initials}</div>
                      <div class="detail-user-info">
                        <div class="detail-user-name">${escapeHtml(u.name || u.email)}</div>
                        <div class="detail-user-role">${escapeHtml(u.role || 'Member')}</div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `<div style="color: var(--text-muted); font-size: 0.8125rem;">No team members assigned</div>`}
          </div>
        </div>
      `;
    }

    function renderWorkspaces(workspaces) {
      const listEl = document.getElementById("workspaceList");
      const detailPanel = document.getElementById("workspaceDetailPanel");
      const query = searchQuery.trim().toLowerCase();
      const hasQuery = query.length > 0;
      const list = Array.isArray(workspaces) ? workspaces : [];

      // Filter workspaces by search query
      const filtered = hasQuery
        ? list.filter(ws => {
            const haystack = [
              ws.name,
              ws.code,
              ws.description,
              ...(ws.projects || []).map(p => p.name || p.code),
              ...(ws.cases || []).map(c => c.name || c.code),
            ].filter(Boolean).join(" ").toLowerCase();
            return haystack.includes(query);
          })
        : list;

      if (filtered.length === 0) {
        const isSearch = hasQuery;
        document.getElementById("workspaceCount").textContent = 0;
        listEl.innerHTML = isSearch ? `
          <div class="empty-state" style="padding: 40px;">
            <i class="fas fa-search empty-icon"></i>
            <div class="empty-title">No matches found</div>
            <p class="empty-text">Try a different search term</p>
          </div>
        ` : `
          <div class="empty-state onboarding-state">
            <div class="onboarding-icon">
              <i class="fas fa-landmark"></i>
            </div>
            <h2 class="onboarding-title">Initialize Workspace</h2>
            <p class="onboarding-description">Begin by establishing a secure environment. This workspace will serve as the container for your dispute cases, evidence repository, and analysis timelines.</p>
            <div class="onboarding-steps">
              <div class="onboarding-step">
                <span class="step-number">1</span>
                <span class="step-text">Create a <strong>Workspace</strong> to group related matters</span>
              </div>
              <div class="onboarding-step">
                <span class="step-number">2</span>
                <span class="step-text">Add <strong>Projects</strong> or <strong>Cases</strong> to organize your evidence</span>
              </div>
              <div class="onboarding-step">
                <span class="step-number">3</span>
                <span class="step-text">Upload documents and begin analysis</span>
              </div>
            </div>
            <button class="btn btn-navy btn-lg" onclick="window.location.href='workspace-setup.html'">
              <i class="fas fa-plus-circle"></i> Create New Workspace
            </button>
          </div>
        `;
        // Reset detail panel
        detailPanel.innerHTML = `
          <div class="detail-panel-empty">
            <i class="fas fa-hand-pointer" aria-hidden="true"></i>
            <div>Select a workspace to view details</div>
          </div>
        `;
        return;
      }

      const sortByRecent = (a, b) => {
        const aTime = Date.parse(a.updated_at || a.created_at || "");
        const bTime = Date.parse(b.updated_at || b.created_at || "");
        return (bTime || 0) - (aTime || 0);
      };

      const sorted = filtered.sort(sortByRecent);
      document.getElementById("workspaceCount").textContent = sorted.length;

      listEl.innerHTML = sorted.map(ws => renderWorkspaceRow(ws)).join("");

      // Auto-select first workspace if none selected
      if (!selectedWorkspaceId && sorted.length > 0) {
        selectWorkspace(sorted[0].id);
      } else if (selectedWorkspaceId) {
        // Re-render detail for current selection
        renderWorkspaceDetail(selectedWorkspaceId);
      }
    }

    function setupEventListeners() {
      // Search
      let timeout;
      document.getElementById("searchInput").addEventListener("input", (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          searchQuery = e.target.value.toLowerCase();
          loadDashboard(); // Reload to re-filter
        }, 300);
      });

      // Search chips
      document.querySelectorAll(".search-chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const query = chip.dataset.query;
          document.getElementById("searchInput").value = query;
          searchQuery = query.toLowerCase();
          loadDashboard(); // Reload to re-filter
        });
      });

      // Quick action buttons
      document.querySelectorAll('[data-action="create-workspace"]').forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          window.location.href = "workspace-setup.html";
        });
      });

      document.querySelectorAll(".quick-action.locked").forEach(a => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          VericaseUI.Toast.info("Select a workspace first");
        });
      });

      // AI suggestions
      document.querySelectorAll(".ai-suggestion").forEach(btn => {
        btn.addEventListener("click", () => {
          const prompt = btn.dataset.prompt;
          document.getElementById("aiQuickInput").value = prompt;
          toggleAIChat();
          setTimeout(() => {
            document.getElementById("aiChatInput").value = prompt;
            sendAIMessage();
          }, 100);
        });
      });

      // AI quick input enter
      document.getElementById("aiQuickInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          const prompt = e.target.value.trim();
          if (prompt) {
            toggleAIChat();
            setTimeout(() => {
              document.getElementById("aiChatInput").value = prompt;
              sendAIMessage();
            }, 100);
          }
        }
      });

      // AI chat input enter
      document.getElementById("aiChatInput")?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendAIMessage();
      });

      // Create modal
      document.getElementById("createNewBtn").addEventListener("click", () => {
        window.location.href = "workspace-setup.html";
      });

      document.getElementById("modalClose").addEventListener("click", closeModal);
      document.getElementById("cancelCreate").addEventListener("click", closeModal);

      // Type selector - hide for workspaces (always creating workspace)
      const typeSelector = document.querySelector(".type-selector");
      if (typeSelector) {
        typeSelector.style.display = "none";
      }
      document.querySelector('label[for="itemCode"]').textContent = "Workspace Code *";

      // Create handler
      document.getElementById("confirmCreate").addEventListener("click", handleCreate);
      document.getElementById("confirmRename").addEventListener("click", handleRename);
      document.getElementById("confirmDelete").addEventListener("click", handleDelete);
      document.getElementById("confirmDevelopCase").addEventListener("click", handleDevelopCase);
    }

    function setupPredictiveControls() {
      const refreshBtn = document.getElementById("predictiveRefresh");
      const applyBtn = document.getElementById("predictiveApply");
      const clearBtn = document.getElementById("predictiveClear");
      const themeSelect = document.getElementById("predictiveThemeFilter");
      const outcomeSelect = document.getElementById("predictiveOutcomeFilter");

      if (refreshBtn) {
        refreshBtn.addEventListener("click", () => loadPredictiveSignals());
      }

      if (applyBtn) {
        applyBtn.addEventListener("click", () => {
          predictiveFilters.theme = themeSelect?.value || "";
          predictiveFilters.outcome = outcomeSelect?.value || "";
          loadPredictiveSignals();
        });
      }

      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          predictiveFilters = { theme: "", outcome: "" };
          if (themeSelect) themeSelect.value = "";
          if (outcomeSelect) outcomeSelect.value = "";
          loadPredictiveSignals();
        });
      }
    }

    function formatPredictivePct(value) {
      if (typeof value !== "number") return "-";
      return `${Math.round(value * 100)}%`;
    }

    function formatPredictiveLift(value) {
      if (typeof value !== "number") return "-";
      return `${value.toFixed(2)}x`;
    }

      function formatPredictiveType(value) {
      const type = String(value || "").toLowerCase();
      const mapping = {
        theme: "Theme",
        contentious_issue: "Issue",
        tag: "Tag",
        issue: "Issue",
        delay_cause: "Delay Cause",
        defect_type: "Defect Type",
        key_clause: "Key Clause",
        contract_form: "Contract Form",
        procurement_route: "Procurement Route",
        construction_bucket: "Bucket",
        rfi_count: "RFI Count",
        change_order_count: "Change Orders",
        delay_days: "Delay Days",
        eot_days_granted: "EOT Days",
        claim_value_gbp: "Claim Value",
        award_amount_gbp: "Award Amount",
      };
      return mapping[type] || "Signal";
    }

    function setPredictiveOptions(selectEl, options, placeholder) {
      if (!selectEl) return;
      const safeOptions = (options || [])
        .filter(Boolean)
        .map((value) => `<option value="${escapeHtml(value)}">${escapeHtml(value)}</option>`)
        .join("");
      selectEl.innerHTML = `<option value="">${escapeHtml(placeholder)}</option>${safeOptions}`;
    }

    function renderPredictiveFilters() {
      setPredictiveOptions(
        document.getElementById("predictiveThemeFilter"),
        predictiveOptions.themes,
        "All themes",
      );
      setPredictiveOptions(
        document.getElementById("predictiveOutcomeFilter"),
        predictiveOptions.outcomes,
        "All outcomes",
      );

      const themeSelect = document.getElementById("predictiveThemeFilter");
      const outcomeSelect = document.getElementById("predictiveOutcomeFilter");
      if (themeSelect) themeSelect.value = predictiveFilters.theme;
      if (outcomeSelect) outcomeSelect.value = predictiveFilters.outcome;
    }

    function renderPredictiveSignals(data) {
      const listEl = document.getElementById("predictiveList");
      const metaEl = document.getElementById("predictiveMeta");
      if (!listEl || !metaEl) return;

      const signals = data?.predictive_signals || [];
      const caseCount = data?.predictive_case_count ?? 0;
      metaEl.textContent = `Signals based on ${caseCount} case(s) with outcomes.`;

      if (!signals.length) {
        listEl.innerHTML = "<li class='predictive-empty'>Not enough data yet.</li>";
        return;
      }

      listEl.innerHTML = signals
        .map((signal) => {
          const featureType = formatPredictiveType(signal.feature_type);
          const feature = escapeHtml(signal.feature || "Unknown");
          const outcome = escapeHtml(signal.outcome || "Unknown");
          const lift = formatPredictiveLift(signal.lift);
          const featureRate = formatPredictivePct(signal.feature_rate);
          const baseRate = formatPredictivePct(signal.base_rate);
          const support = signal.support ?? 0;
          const featureCases = signal.feature_cases ?? 0;

          return `
            <li class="predictive-item">
              <div class="predictive-item-header">
                <span>${escapeHtml(featureType)}</span>
                <span class="predictive-item-lift">${lift}</span>
              </div>
              <div class="predictive-item-main">
                <span class="predictive-item-feature">${feature}</span>
                <span>-></span>
                <span class="predictive-item-outcome">${outcome}</span>
              </div>
              <div class="predictive-item-meta">${featureRate} vs ${baseRate} | n=${support}/${featureCases}</div>
            </li>
          `;
        })
        .join("");
    }

    function renderRiskSignals(data) {
      const listEl = document.getElementById("riskList");
      const metaEl = document.getElementById("riskMeta");
      if (!listEl || !metaEl) return;

      const signals = data?.risk_signals || [];
      const caseCount = data?.risk_case_count ?? 0;
      metaEl.textContent = `Signals based on ${caseCount} case(s).`;

      if (!signals.length) {
        listEl.innerHTML = "<li class='predictive-empty'>No risk signals yet.</li>";
        return;
      }

      listEl.innerHTML = signals
        .map((signal) => {
          const featureType = formatPredictiveType(signal.feature_type);
          const feature = escapeHtml(signal.feature || "Unknown");
          const target = escapeHtml(signal.target || "Unknown");
          const lift = formatPredictiveLift(signal.lift);
          const featureRate = formatPredictivePct(signal.feature_rate);
          const baseRate = formatPredictivePct(signal.base_rate);
          const support = signal.support ?? 0;
          const featureCases = signal.feature_cases ?? 0;

          return `
            <li class="predictive-item">
              <div class="predictive-item-header">
                <span>${escapeHtml(featureType)}</span>
                <span class="predictive-item-lift">${lift}</span>
              </div>
              <div class="predictive-item-main">
                <span class="predictive-item-feature">${feature}</span>
                <span>-></span>
                <span class="predictive-item-outcome">${target}</span>
              </div>
              <div class="predictive-item-meta">${featureRate} vs ${baseRate} | n=${support}/${featureCases}</div>
            </li>
          `;
        })
        .join("");
    }

    function renderProactiveTrends(data) {
      const listEl = document.getElementById("proactiveList");
      const metaEl = document.getElementById("proactiveMeta");
      if (!listEl || !metaEl) return;

      const trends = data?.proactive_trends || [];
      const fallback = !!data?.proactive_fallback;
      metaEl.textContent = fallback
        ? "Watching signals (low volume)"
        : "Actionable signals";

      if (!trends.length) {
        listEl.innerHTML = "<li class='predictive-empty'>No proactive trends yet.</li>";
        return;
      }

      listEl.innerHTML = trends
        .map((trend) => {
          const featureType = formatPredictiveType(trend.feature_type);
          const feature = escapeHtml(trend.feature || "Unknown");
          const outcome = escapeHtml(trend.outcome || "Unknown");
          const lift = formatPredictiveLift(trend.lift);
          const featureRate = formatPredictivePct(trend.feature_rate);
          const baseRate = formatPredictivePct(trend.base_rate);
          const support = trend.support ?? 0;
          const featureCases = trend.feature_cases ?? 0;
          const level = escapeHtml(trend.level || "watch");

          return `
            <li class="predictive-item proactive">
              <div class="predictive-item-header">
                <span>${escapeHtml(featureType)}</span>
                <span class="predictive-level ${level}">${level}</span>
              </div>
              <div class="predictive-item-main">
                <span class="predictive-item-feature">${feature}</span>
                <span>-></span>
                <span class="predictive-item-outcome">${outcome}</span>
              </div>
              <div class="predictive-item-meta">${featureRate} vs ${baseRate} | lift ${lift} | n=${support}/${featureCases}</div>
            </li>
          `;
        })
        .join("");
    }

    async function loadPredictiveSignals({ populateOptions = false } = {}) {
      const listEl = document.getElementById("predictiveList");
      const metaEl = document.getElementById("predictiveMeta");
      if (!listEl || !metaEl) return;

      const params = new URLSearchParams({ top_n: "6" });
      if (predictiveFilters.theme) params.set("theme", predictiveFilters.theme);
      if (predictiveFilters.outcome) params.set("outcome", predictiveFilters.outcome);

      metaEl.textContent = "Loading signals...";
      listEl.innerHTML = "";

      try {
        const response = await fetch(`/api/caselaw/trends?${params.toString()}`, {
          headers: getAuthHeaders(),
        });

        if (response.status === 401 || response.status === 403) {
          metaEl.textContent = "Sign in to view predictive signals.";
          listEl.innerHTML = "<li class='predictive-empty'>Authentication required.</li>";
          const proactiveMeta = document.getElementById("proactiveMeta");
          const proactiveList = document.getElementById("proactiveList");
          if (proactiveMeta) proactiveMeta.textContent = "Sign in to view proactive trends.";
          if (proactiveList) proactiveList.innerHTML = "<li class='predictive-empty'>Authentication required.</li>";
          const riskMeta = document.getElementById("riskMeta");
          const riskList = document.getElementById("riskList");
          if (riskMeta) riskMeta.textContent = "Sign in to view risk signals.";
          if (riskList) riskList.innerHTML = "<li class='predictive-empty'>Authentication required.</li>";
          return;
        }

        if (!response.ok) {
          metaEl.textContent = `Unable to load signals (${response.status}).`;
          listEl.innerHTML = "<li class='predictive-empty'>No data available.</li>";
          const proactiveMeta = document.getElementById("proactiveMeta");
          const proactiveList = document.getElementById("proactiveList");
          if (proactiveMeta) proactiveMeta.textContent = "Unable to load proactive trends.";
          if (proactiveList) proactiveList.innerHTML = "<li class='predictive-empty'>No data available.</li>";
          const riskMeta = document.getElementById("riskMeta");
          const riskList = document.getElementById("riskList");
          if (riskMeta) riskMeta.textContent = "Unable to load risk signals.";
          if (riskList) riskList.innerHTML = "<li class='predictive-empty'>No data available.</li>";
          return;
        }

        const data = await response.json();
        if (populateOptions) {
          predictiveOptions = {
            themes: (data.themes || []).map((item) => item.value),
            outcomes: (data.outcomes || []).map((item) => item.value),
          };
          renderPredictiveFilters();
        }
        renderProactiveTrends(data);
        renderPredictiveSignals(data);
        renderRiskSignals(data);
      } catch (error) {
        console.error("Predictive signals load failed", error);
        metaEl.textContent = "Unable to load predictive signals.";
        listEl.innerHTML = "<li class='predictive-empty'>No data available.</li>";
        const proactiveMeta = document.getElementById("proactiveMeta");
        const proactiveList = document.getElementById("proactiveList");
        if (proactiveMeta) proactiveMeta.textContent = "Unable to load proactive trends.";
        if (proactiveList) proactiveList.innerHTML = "<li class='predictive-empty'>No data available.</li>";
        const riskMeta = document.getElementById("riskMeta");
        const riskList = document.getElementById("riskList");
        if (riskMeta) riskMeta.textContent = "Unable to load risk signals.";
        if (riskList) riskList.innerHTML = "<li class='predictive-empty'>No data available.</li>";
      }
    }

    // Modal handlers
    function closeModal() { document.getElementById("createModal").classList.remove("active"); }
    function closeRenameModal() { document.getElementById("renameModal").classList.remove("active"); }
    function closeDeleteModal() { document.getElementById("deleteModal").classList.remove("active"); }
    function closeDevelopCaseModal() { document.getElementById("developCaseModal").classList.remove("active"); }

    let activeMenu = null;
    function toggleMenu(id) {
      const menu = document.getElementById(`menu-${id}`);
      if (activeMenu && activeMenu !== menu) activeMenu.classList.remove("active");
      menu.classList.toggle("active");
      activeMenu = menu.classList.contains("active") ? menu : null;
    }

    document.addEventListener("click", () => {
      if (activeMenu) { activeMenu.classList.remove("active"); activeMenu = null; }
    });

    function openRenameModal(id, name, code, type) {
      document.getElementById("renameItemId").value = id;
      document.getElementById("renameItemType").value = type;
      document.getElementById("renameItemName").value = name;
      document.getElementById("renameItemCode").value = code;
      document.getElementById("renameModal").classList.add("active");
      if (activeMenu) { activeMenu.classList.remove("active"); activeMenu = null; }
    }

    function openDeleteModal(id, name, type) {
      document.getElementById("deleteItemId").value = id;
      document.getElementById("deleteItemType").value = type;
      document.getElementById("deleteItemName").textContent = name;
      document.getElementById("deleteModal").classList.add("active");
      if (activeMenu) { activeMenu.classList.remove("active"); activeMenu = null; }
    }

    function openDevelopCaseModal(projectId, projectName, description) {
      document.getElementById("developCaseProjectId").value = projectId;
      document.getElementById("developCaseName").value = projectName ? `${projectName} Case` : "";
      document.getElementById("developCaseDescription").value = description || "";
      document.getElementById("developCaseProjectLabel").textContent = projectName ? `From project: ${projectName}` : "";
      document.getElementById("developCaseModal").classList.add("active");
      if (activeMenu) { activeMenu.classList.remove("active"); activeMenu = null; }
    }

    function resolveWorkspaceContext(id, type) {
      const list = window.workspacesData || [];
      const targetId = String(id);
      const isCase = type === "case";

      for (const ws of list) {
        const items = isCase ? (ws.cases || []) : (ws.projects || []);
        const match = items.find((item) => {
          const itemId = item?.id || item?.case_id || item?.project_id;
          return String(itemId) === targetId;
        });
        if (match) {
          return { workspace: ws, item: match };
        }
      }

      return null;
    }

    function openWorkspace(id, type) {
      const resolved = resolveWorkspaceContext(id, type);
      const param = type === "case" ? "caseId" : "projectId";

      if (resolved?.workspace?.id) {
        try {
          localStorage.setItem("currentWorkspaceId", resolved.workspace.id);
          if (resolved.workspace.name) {
            localStorage.setItem("currentWorkspaceName", resolved.workspace.name);
          }
        } catch { /* ignore */ }
      }

      setActiveContext(id, type);

      if (resolved?.item) {
        const name =
          type === "case"
            ? resolved.item.name || resolved.item.case_name
            : resolved.item.name || resolved.item.project_name;
        if (name) {
          try {
            if (type === "case") {
              localStorage.setItem("currentCaseName", name);
              localStorage.setItem("vericase_current_case_name", name);
            } else {
              localStorage.setItem("currentProjectName", name);
              localStorage.setItem("vericase_current_project_name", name);
            }
          } catch { /* ignore */ }
        }
      }

      window.location.href = `projectdashboard.html?${param}=${encodeURIComponent(id)}`;
    }

    function openWorkspaceConfig(workspaceId) {
      window.location.href = `workspace-setup.html?workspaceId=${workspaceId}`;
    }

    // Explicit "open the hub" action (always goes to the Workspace Hub, even if only 1 project/case exists)
    function openWorkspaceHub(workspaceId) {
      // Best-effort: store workspace context so other pages can show breadcrumbs, etc.
      try {
        const workspace = (window.workspacesData || []).find(ws => String(ws.id) === String(workspaceId));
        if (workspace) {
          localStorage.setItem("currentWorkspaceId", workspaceId);
          localStorage.setItem("currentWorkspaceName", workspace.name || "Workspace");
        }
      } catch { /* ignore */ }
      window.location.href = `workspace-hub.html?workspaceId=${encodeURIComponent(workspaceId)}`;
    }

    // Smart workspace click: enter the first project/case if available, otherwise open setup
    function enterWorkspace(workspaceId) {
      // Use window.workspacesData which is populated by loadDashboard
      const workspace = (window.workspacesData || []).find(ws => String(ws.id) === String(workspaceId));
      
      // Save workspace context for breadcrumbs
      try {
        localStorage.setItem("currentWorkspaceId", workspaceId);
        if (workspace?.name) {
          localStorage.setItem("currentWorkspaceName", workspace.name);
        }
      } catch { /* ignore */ }

      // ALWAYS navigate to Workspace Hub - it is the central command center
      // for all projects, cases, deadlines, documents, team, and collaboration
      window.location.href = `workspace-hub.html?workspaceId=${encodeURIComponent(workspaceId)}`;
    }

    function openRenameWorkspaceModal(id, name, code) {
      // For now, reuse the existing rename modal but adapt it for workspaces
      document.getElementById("renameItemId").value = id;
      document.getElementById("renameItemType").value = "workspace";
      document.getElementById("renameItemName").value = name;
      document.getElementById("renameItemCode").value = code;
      document.getElementById("renameModal").classList.add("active");
      if (activeMenu) { activeMenu.classList.remove("active"); activeMenu = null; }
    }

    function openDeleteWorkspaceModal(id, name) {
      document.getElementById("deleteItemId").value = id;
      document.getElementById("deleteItemType").value = "workspace";
      document.getElementById("deleteItemName").textContent = name;
      document.getElementById("deleteModal").classList.add("active");
      if (activeMenu) { activeMenu.classList.remove("active"); activeMenu = null; }
    }

    function setActiveContext(id, type) {
      const item = (dashboardData?.work_items || []).find(i => String(i.id) === String(id));
      try {
        if (type === "case") {
          localStorage.setItem("profileType", "case");
          localStorage.setItem("currentCaseId", id);
          localStorage.setItem("caseId", id);
          if (item?.name) {
            localStorage.setItem("currentCaseName", item.name);
            localStorage.setItem("vericase_current_case_name", item.name);
          }
        } else {
          localStorage.setItem("profileType", "project");
          localStorage.setItem("vericase_current_project", id);
          localStorage.setItem("currentProjectId", id);
          localStorage.setItem("projectId", id);
          if (item?.name) {
            localStorage.setItem("currentProjectName", item.name);
            localStorage.setItem("vericase_current_project_name", item.name);
          }
          localStorage.removeItem("currentCaseId");
          localStorage.removeItem("caseId");
        }
      } catch (e) { }
    }

    // API Handlers
    async function handleCreate(e) {
      e.preventDefault();
      const name = document.getElementById("itemName").value;
      const code = document.getElementById("itemCode").value;
      const description = document.getElementById("itemDescription").value;
      const contractType = document.getElementById("contractType").value;

      if (!name || !code) { alert("Please fill in Name and Code"); return; }

      const btn = document.getElementById("confirmCreate");
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
      btn.disabled = true;

      try {
        // Create workspace
        const payload = { name, code, description, contract_type: contractType };
        const headers = { "Content-Type": "application/json", ...getAuthHeaders() };

        let response = await fetch("/api/workspaces", {
          method: "POST",
          headers,
          body: JSON.stringify(payload)
        });

        if (response.status === 404 || response.status === 405) {
          const fallbackPayload = {
            project_name: name,
            project_code: code,
            contract_type: contractType || null
          };
          response = await fetch("/api/projects", {
            method: "POST",
            headers,
            body: JSON.stringify(fallbackPayload)
          });
        }

        if (response.ok) {
          VericaseUI.Toast.success('Workspace created');
          closeModal();
          document.getElementById("createForm").reset();
          loadDashboard();
        } else {
          const errorData = await response.json();
          throw new Error(errorData.detail || "Creation failed");
        }
      } catch (error) {
        alert("Error: " + error.message);
      } finally {
        btn.innerHTML = '<i class="fas fa-plus"></i> Create';
        btn.disabled = false;
      }
    }

    async function handleRename() {
      const id = document.getElementById("renameItemId").value;
      const type = document.getElementById("renameItemType").value;
      const name = document.getElementById("renameItemName").value;
      const code = document.getElementById("renameItemCode").value;

      if (!name) { alert("Please enter a name"); return; }

      const btn = document.getElementById("confirmRename");
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;

      try {
        let endpoint = type === "project" ? `/api/projects/${id}` : `/api/cases/${id}`;
        let payload = type === "project" ? { project_name: name, project_code: code } : { name, case_number: code };

        if (type === "workspace") {
          endpoint = `/api/workspaces/${id}`;
          payload = { name, code };
        }

        let response = await fetch(endpoint, {
          method: "PUT",
          headers: { "Content-Type": "application/json", ...getAuthHeaders() },
          body: JSON.stringify(payload)
        });

        if ((response.status === 404 || response.status === 405) && type === "workspace") {
          endpoint = `/api/projects/${id}`;
          payload = { project_name: name, project_code: code };
          response = await fetch(endpoint, {
            method: "PUT",
            headers: { "Content-Type": "application/json", ...getAuthHeaders() },
            body: JSON.stringify(payload)
          });
        }

        if (response.ok) {
          VericaseUI.Toast.success("Renamed successfully");
          closeRenameModal();
          loadDashboard();
        } else {
          throw new Error("Rename failed");
        }
      } catch (error) {
        alert("Error: " + error.message);
      } finally {
        btn.innerHTML = '<i class="fas fa-save"></i> Save';
        btn.disabled = false;
      }
    }

    async function handleDelete() {
      const id = document.getElementById("deleteItemId").value;
      const type = document.getElementById("deleteItemType").value;

      const btn = document.getElementById("confirmDelete");
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;

      try {
        let endpoint;
        if (type === "workspace") {
          endpoint = `/api/workspaces/${id}`;
        } else {
          endpoint = type === "project" ? `/api/projects/${id}` : `/api/cases/${id}`;
        }
        let response = await fetch(endpoint, { method: "DELETE", headers: getAuthHeaders() });

        if ((response.status === 404 || response.status === 405) && type === "workspace") {
          endpoint = `/api/projects/${id}`;
          response = await fetch(endpoint, { method: "DELETE", headers: getAuthHeaders() });
        }

        if (response.ok) {
          VericaseUI.Toast.success("Deleted successfully");
          closeDeleteModal();
          loadDashboard();
        } else {
          const errorData = await response.json();
          throw new Error(errorData.detail || "Delete failed");
        }
      } catch (error) {
        alert("Error: " + error.message);
      } finally {
        btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        btn.disabled = false;
      }
    }

    async function handleDevelopCase() {
      const projectId = document.getElementById("developCaseProjectId").value;
      const name = document.getElementById("developCaseName").value.trim();
      const caseNumber = document.getElementById("developCaseNumber").value.trim();
      const description = document.getElementById("developCaseDescription").value.trim();

      if (!name) { alert("Please enter a case name"); return; }

      const payload = {
        case_name: name,
        include_stakeholders: document.getElementById("developIncludeStakeholders").checked,
        include_keywords: document.getElementById("developIncludeKeywords").checked,
        include_heads_of_claim: document.getElementById("developIncludeClaims").checked,
        include_contentious_matters: document.getElementById("developIncludeMatters").checked,
      };
      if (caseNumber) payload.case_number = caseNumber;
      if (description) payload.description = description;

      const btn = document.getElementById("confirmDevelopCase");
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;

      try {
        const response = await fetch(`/api/projects/${projectId}/cases`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...getAuthHeaders() },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const data = await response.json();
          VericaseUI.Toast.success("Case developed successfully");
          closeDevelopCaseModal();
          if (data?.id) {
            setActiveContext(data.id, "case");
            window.location.href = `projectdashboard.html?caseId=${data.id}`;
          } else {
            loadDashboard();
          }
        } else {
          throw new Error("Develop case failed");
        }
      } catch (error) {
        alert("Error: " + error.message);
      } finally {
        btn.innerHTML = '<i class="fas fa-briefcase"></i> Develop Case';
        btn.disabled = false;
      }
    }

    // VeriCase Assistant
    function toggleAIChat() {
      const panel = document.getElementById("aiChatPanel");
      const quickPrompt = document.getElementById("aiQuickPrompt");
      const toggleBtn = document.querySelector(".ai-toggle-btn");

      if (panel.classList.contains("active")) {
        panel.classList.remove("active");
        quickPrompt.style.display = "block";
        toggleBtn.textContent = "Expand";
      } else {
        panel.classList.add("active");
        quickPrompt.style.display = "none";
        toggleBtn.textContent = "Collapse";
        document.getElementById("aiChatInput")?.focus();
      }
    }

    async function sendAIMessage() {
      const input = document.getElementById("aiChatInput");
      const message = input.value.trim();
      if (!message) return;

      const container = document.getElementById("aiChatMessages");

      container.innerHTML += `
        <div class="ai-message user">
          <div class="ai-avatar"><i class="fas fa-user"></i></div>
          <div class="ai-bubble">${escapeHtml(message)}</div>
        </div>
      `;
      input.value = "";
      container.scrollTop = container.scrollHeight;

      const typingId = "typing-" + Date.now();
      container.innerHTML += `
        <div class="ai-message" id="${typingId}">
          <div class="ai-avatar"><i class="fas fa-robot"></i></div>
          <div class="ai-bubble"><i class="fas fa-spinner fa-spin"></i> Thinking...</div>
        </div>
      `;
      container.scrollTop = container.scrollHeight;

      try {
        const response = await fetch("/api/ai-chat/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...getAuthHeaders() },
          body: JSON.stringify({ message, context: "command_center", include_projects: true })
        });

        document.getElementById(typingId)?.remove();

        if (response.ok) {
          const data = await response.json();
          const reply = data.response || data.message || "I processed your request.";
          container.innerHTML += `
            <div class="ai-message">
              <div class="ai-avatar"><i class="fas fa-robot"></i></div>
              <div class="ai-bubble">${escapeHtml(reply)}</div>
            </div>
          `;
        } else {
          container.innerHTML += `
            <div class="ai-message">
              <div class="ai-avatar"><i class="fas fa-robot"></i></div>
              <div class="ai-bubble">I'll search for: "${escapeHtml(message)}"</div>
            </div>
          `;
          searchQuery = message.toLowerCase();
          document.getElementById("searchInput").value = message;
          if (window.workspacesData) renderWorkspaces(window.workspacesData);
        }
        container.scrollTop = container.scrollHeight;
      } catch (error) {
        document.getElementById(typingId)?.remove();
        container.innerHTML += `
          <div class="ai-message">
            <div class="ai-avatar"><i class="fas fa-robot"></i></div>
            <div class="ai-bubble">Sorry, I encountered an error. Please try again.</div>
          </div>
        `;
        container.scrollTop = container.scrollHeight;
      }
    }

    // Utils
    function escapeHtml(str) {
      if (!str) return "";
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function formatCount(n) {
      if (n >= 1000) return (n / 1000).toFixed(1) + "k";
      return n;
    }
  </script>
</body>

</html>

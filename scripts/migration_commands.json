{
  "Parameters": {
    "commands": [
    "DB_PASSWORD=$(aws secretsmanager get-secret-value --secret-id rds!db-5818fc76-6f0c-4d02-8aa4-df3d01776ed3 --region eu-west-2 --query SecretString --output text | jq -r .password)",
    "export PGPASSWORD=$DB_PASSWORD",
    "echo 'Counting IPM items...'",
    "COUNT=$(psql -h database-1.cv8uwu0uqr7f.eu-west-2.rds.amazonaws.com -U vericase -d vericase -t -A -c \"SELECT COUNT(*) FROM email_messages WHERE (subject LIKE 'IPM.%') AND (metadata IS NULL OR metadata->>'is_hidden' IS NULL OR metadata->>'is_hidden' = 'false');\")",
    "echo \"Found $COUNT items\"",
    "if [ \"$COUNT\" -gt \"0\" ]; then psql -h database-1.cv8uwu0uqr7f.eu-west-2.rds.amazonaws.com -U vericase -d vericase -c \"SELECT id, LEFT(subject, 60) FROM email_messages WHERE (subject LIKE 'IPM.%') AND (metadata IS NULL OR metadata->>'is_hidden' IS NULL OR metadata->>'is_hidden' = 'false') LIMIT 5;\"; fi",
    "if [ \"$COUNT\" -gt \"0\" ]; then psql -h database-1.cv8uwu0uqr7f.eu-west-2.rds.amazonaws.com -U vericase -d vericase -c \"UPDATE email_messages SET metadata = COALESCE(metadata, '{}'::jsonb) || '{\\\"is_hidden\\\": true, \\\"is_spam\\\": true, \\\"spam_category\\\": \\\"non_email\\\", \\\"spam_score\\\": 100}'::jsonb WHERE (subject LIKE 'IPM.%') AND (metadata IS NULL OR metadata->>'is_hidden' IS NULL OR metadata->>'is_hidden' = 'false');\"; fi",
    "echo 'Verifying...'",
    "psql -h database-1.cv8uwu0uqr7f.eu-west-2.rds.amazonaws.com -U vericase -d vericase -t -A -c \"SELECT COUNT(*) FROM email_messages WHERE metadata->>'is_hidden' = 'true' AND subject LIKE 'IPM.%';\""
    ]
  }
}

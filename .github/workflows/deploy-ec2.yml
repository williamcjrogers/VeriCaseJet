name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production EC2
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem
          
          ssh -i key.pem -o StrictHostKeyChecking=no ec2-user@18.130.216.34 << 'EOF'
            cd /opt/vericase
            
            # Force sync with repository to discard any local changes preventing pull
            git fetch --all
            git reset --hard origin/main
            
            cd pst-analysis-engine
            
            # Pull latest images
            docker-compose -f docker-compose-s3.yml pull
            
            # Force recreate containers to ensure volume mounts are applied
            docker-compose -f docker-compose-s3.yml up -d --force-recreate --remove-orphans
            
            echo ""
            echo "Checking if fix is present on server disk:"
            grep "allEvidenceItems is invalid" ui/evidence.html && echo "âœ… Fix confirmed on disk" || echo "âŒ Fix NOT found on disk"
            
            echo ""
            echo "Containers running:"
            docker ps --format "table {{.Names}}\t{{.Status}}"
          EOF
          
          rm -f key.pem
          
          echo ""
          echo "âœ… Deployment complete!"
          echo "ðŸŒ VeriCase: http://18.130.216.34:8010"
          echo "ðŸ“§ Login: admin@vericase.com / ChangeMe123"

name: Build and Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and Push Docker Image
        run: |
          cd pst-analysis-engine
          docker build -t wcjrogers/vericase-api:latest -f Dockerfile .
          docker push wcjrogers/vericase-api:latest
      
      - name: Deploy to Production EC2
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem
          
          ssh -i key.pem -o StrictHostKeyChecking=no ec2-user@3.8.162.169 << 'EOF'
            cd /opt/vericase
            git fetch --all
            git reset --hard origin/main
            cd pst-analysis-engine
            docker-compose -f docker-compose-s3.yml pull
            docker-compose -f docker-compose-s3.yml up -d --force-recreate
            docker ps
          EOF
          
          rm -f key.pem
          echo "âœ… Deployed: http://3.8.162.169:8010"
